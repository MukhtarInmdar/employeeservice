package com.sumadhura.employeeservice.serviceImpl;

import static com.sumadhura.employeeservice.util.Util.isEmptyObject;
import static com.sumadhura.employeeservice.util.Util.isNotEmptyObject;
import java.util.regex.Matcher; 
import java.util.regex.Pattern;
import java.io.File;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Properties;
import java.util.Set;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;

import org.apache.commons.io.FileUtils;
import org.apache.log4j.Logger;
import org.dozer.MappingException;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.client.RestTemplate;

import com.sumadhura.employeeservice.dto.Customer;
import com.sumadhura.employeeservice.dto.Email;
import com.sumadhura.employeeservice.dto.EmployeeFinTranPaymentSetOffRequest;
import com.sumadhura.employeeservice.dto.EmployeeFinancialPushNotificationInfo;
import com.sumadhura.employeeservice.dto.EmployeeFinancialRequest;
import com.sumadhura.employeeservice.dto.EmployeeFinancialResponse;
import com.sumadhura.employeeservice.dto.EmployeeFinancialTransactionRequest;
import com.sumadhura.employeeservice.dto.EmployeeFinancialTransactionResponse;
import com.sumadhura.employeeservice.dto.FileInfo;
import com.sumadhura.employeeservice.dto.FinAnnyApproveStatResponse;
import com.sumadhura.employeeservice.dto.FinAnnyEntryCommentsResponse;
import com.sumadhura.employeeservice.dto.FinAnnyEntryDocResponse;
import com.sumadhura.employeeservice.dto.FinAnonymousEntryResponse;
import com.sumadhura.employeeservice.dto.FinBankResponse;
import com.sumadhura.employeeservice.dto.FinBookingFormDemandNoteResponse;
import com.sumadhura.employeeservice.dto.FinBookingFormExcessAmountResponse;
import com.sumadhura.employeeservice.dto.FinBookingFormLegalCostPdfResponse;
import com.sumadhura.employeeservice.dto.FinBookingFormLegalCostResponse;
import com.sumadhura.employeeservice.dto.FinBookingFormLglCostDtlsResponse;
import com.sumadhura.employeeservice.dto.FinBookingFormModiCostDtlsResponse;
import com.sumadhura.employeeservice.dto.FinBookingFormModiCostResponse;
import com.sumadhura.employeeservice.dto.FinCustomerLedgerResponse;
import com.sumadhura.employeeservice.dto.FinPenaltyTaxResponse;
import com.sumadhura.employeeservice.dto.FinProjectAccountResponse;
import com.sumadhura.employeeservice.dto.FinTransactionApprStatResponse;
import com.sumadhura.employeeservice.dto.FinTransactionChangedDtlsResponse;
import com.sumadhura.employeeservice.dto.FinTransactionCommentsResponse;
import com.sumadhura.employeeservice.dto.FinTransactionEntryDetailsResponse;
import com.sumadhura.employeeservice.dto.FinTransactionEntryDocResponse;
import com.sumadhura.employeeservice.dto.FinTransactionEntryResponse;
import com.sumadhura.employeeservice.dto.FinTransactionForResponse;
import com.sumadhura.employeeservice.dto.FinTransactionModeResponse;
import com.sumadhura.employeeservice.dto.FinTransactionSetOffResponse;
import com.sumadhura.employeeservice.dto.FinTransactionTypeResponse;
import com.sumadhura.employeeservice.dto.FinTransferModeResponse;
import com.sumadhura.employeeservice.dto.Financial;
import com.sumadhura.employeeservice.dto.FinancialProjectMileStoneRequest;
import com.sumadhura.employeeservice.dto.FinancialProjectMileStoneResponse;
import com.sumadhura.employeeservice.dto.OfficeDtlsResponse;
import com.sumadhura.employeeservice.dto.Site;
import com.sumadhura.employeeservice.enums.FinEnum;
import com.sumadhura.employeeservice.enums.FinTransactionFor;
import com.sumadhura.employeeservice.enums.FinTransactionMode;
import com.sumadhura.employeeservice.enums.FinTransactionType;
import com.sumadhura.employeeservice.enums.HttpStatus;
import com.sumadhura.employeeservice.enums.MetadataId;
import com.sumadhura.employeeservice.enums.Status;
import com.sumadhura.employeeservice.enums.SubModule;
import com.sumadhura.employeeservice.exception.EmployeeFinancialServiceException;
import com.sumadhura.employeeservice.exception.InSufficeientInputException;
import com.sumadhura.employeeservice.exception.InformationNotFoundException;
import com.sumadhura.employeeservice.exception.InvalidStatusException;
import com.sumadhura.employeeservice.exception.RefundAmountException;
import com.sumadhura.employeeservice.persistence.dao.BookingFormServiceDao;
import com.sumadhura.employeeservice.persistence.dao.EmployeeFinancialServiceDao;
import com.sumadhura.employeeservice.persistence.daoImpl.EmployeeFinancialServiceDaoImpl;
import com.sumadhura.employeeservice.persistence.dto.AddressMappingPojo;
import com.sumadhura.employeeservice.persistence.dto.AddressPojo;
import com.sumadhura.employeeservice.persistence.dto.CoApplicantPojo;
import com.sumadhura.employeeservice.persistence.dto.CustBookInfoPojo;
import com.sumadhura.employeeservice.persistence.dto.CustomerPropertyDetailsPojo;
import com.sumadhura.employeeservice.persistence.dto.DropDownPojo;
import com.sumadhura.employeeservice.persistence.dto.FinAnnyApproveStatPojo;
import com.sumadhura.employeeservice.persistence.dto.FinAnnyEntryCommentsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinAnnyEntryDocPojo;
import com.sumadhura.employeeservice.persistence.dto.FinAnonymousEntryMapPojo;
import com.sumadhura.employeeservice.persistence.dto.FinAnonymousEntryPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBankPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBokFrmDemNteSchTaxMapPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBokFrmFlatKhataTaxPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBokFrmLglCostTaxPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBokFrmMaintenanceTaxPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormAccountPaymentDetailsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormAccountPaymentPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormAccountSummaryPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormAccountsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormAccountsResponse;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormAccountsStatementPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormCorpusFundPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormDemandNoteDocPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormDemandNotePojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormExcessAmountPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormExcessAmountUsagePojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormFlatKhataDtlsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormFlatKhataPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormLegalCostPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormLglCostDtlsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormMaintenanceDtlsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormMaintenancePojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormMilestoneTaxPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormMilestonesPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormModiCostDtlsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormModiCostPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormModiCostTaxPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormReceiptsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormRefundableAdvancePojo;
import com.sumadhura.employeeservice.persistence.dto.FinBookingFormTdsDetailsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinClearedUncleareTXPojo;
import com.sumadhura.employeeservice.persistence.dto.FinClosingBalanceReportPojo;
import com.sumadhura.employeeservice.persistence.dto.FinInterestRatesPojo;
import com.sumadhura.employeeservice.persistence.dto.FinMSChangedDtlsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinMilDemNoteMappingPojo;
import com.sumadhura.employeeservice.persistence.dto.FinModificationInvoicePojo;
import com.sumadhura.employeeservice.persistence.dto.FinPenaltyPojo;
import com.sumadhura.employeeservice.persistence.dto.FinPenaltyStatisticsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinPenaltyTaxMappingPojo;
import com.sumadhura.employeeservice.persistence.dto.FinPenaltyTaxPojo;
import com.sumadhura.employeeservice.persistence.dto.FinProjDemNoteStatisticsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinProjectAccountPojo;
import com.sumadhura.employeeservice.persistence.dto.FinSchemePojo;
import com.sumadhura.employeeservice.persistence.dto.FinSchemeTaxMappingPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTaxPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionApprRejectStatPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionApprStatPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionApprovalDetailsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionChangedDtlsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionChequePojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionCommentsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionEntryDetailsPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionEntryDocPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionEntryPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionForPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionModePojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionOnlinePojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionPmtSetOffAccMapPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionSetOffAccMapPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionSetOffApprovalPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionSetOffEntryPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionSetOffPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionTypePojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransactionWaivedOffPojo;
import com.sumadhura.employeeservice.persistence.dto.FinTransferModePojo;
import com.sumadhura.employeeservice.persistence.dto.FinancialDemandNoteMS_TRN_Pojo;
import com.sumadhura.employeeservice.persistence.dto.FinancialMileStoneClassifideMappingBlocksPojo;
import com.sumadhura.employeeservice.persistence.dto.FinancialMileStoneClassifidesPojo;
import com.sumadhura.employeeservice.persistence.dto.FinancialProjectDemandNotePojo;
import com.sumadhura.employeeservice.persistence.dto.FinancialProjectMileStonePojo;
import com.sumadhura.employeeservice.persistence.dto.FlatBookingPojo;
import com.sumadhura.employeeservice.persistence.dto.FlatBookingSchemeMappingPojo;
import com.sumadhura.employeeservice.persistence.dto.FlatCancellationCostPojo;
import com.sumadhura.employeeservice.persistence.dto.FlatCostPojo;
import com.sumadhura.employeeservice.persistence.dto.FlatDetailsPojo;
import com.sumadhura.employeeservice.persistence.dto.FlatSaleOwnersByAccount;
import com.sumadhura.employeeservice.persistence.dto.InvoiceDocumentLocationPojo;
import com.sumadhura.employeeservice.persistence.dto.ModicationInvoiceAppRej;
import com.sumadhura.employeeservice.persistence.dto.OfficeDtlsPojo;
import com.sumadhura.employeeservice.persistence.dto.PercentagesPojo;
import com.sumadhura.employeeservice.persistence.dto.SiteDetailsPojo;
import com.sumadhura.employeeservice.persistence.dto.SiteOtherChargesDetailsPojo;
import com.sumadhura.employeeservice.persistence.dto.SitePojo;
import com.sumadhura.employeeservice.persistence.dto.StatePojo;
import com.sumadhura.employeeservice.persistence.dto.StatusPojo;
import com.sumadhura.employeeservice.schedulers.GenerateExcelTransactionScheduler;
import com.sumadhura.employeeservice.service.BookingFormService;
import com.sumadhura.employeeservice.service.EmployeeFinancialService;
import com.sumadhura.employeeservice.service.MailService;
import com.sumadhura.employeeservice.service.dto.AddressInfo;
import com.sumadhura.employeeservice.service.dto.AddressMappingInfo;
import com.sumadhura.employeeservice.service.dto.BookingFormRequest;
import com.sumadhura.employeeservice.service.dto.CustomerBookingInfo;
import com.sumadhura.employeeservice.service.dto.CustomerPropertyDetailsInfo;
import com.sumadhura.employeeservice.service.dto.EmployeeFinBokFrmModiCostTaxInfo;
import com.sumadhura.employeeservice.service.dto.EmployeeFinModiCostInfo;
import com.sumadhura.employeeservice.service.dto.EmployeeFinTranPaymentSetOffInfo;
import com.sumadhura.employeeservice.service.dto.EmployeeFinancialServiceInfo;
import com.sumadhura.employeeservice.service.dto.EmployeeFinancialTransactionServiceInfo;
import com.sumadhura.employeeservice.service.dto.FinAnonymousEntryInfo;
import com.sumadhura.employeeservice.service.dto.FinBookingFormAccountsInfo;
import com.sumadhura.employeeservice.service.dto.FinBookingFormLegalCostInfo;
import com.sumadhura.employeeservice.service.dto.FinBookingFormLglCostDtlsInfo;
import com.sumadhura.employeeservice.service.dto.FinBookingFormMstSchTaxMapInfo;
import com.sumadhura.employeeservice.service.dto.FinConsolidatedReceiptInfo;
import com.sumadhura.employeeservice.service.dto.FinCustomerLedgerInfo;
import com.sumadhura.employeeservice.service.dto.FinPenalityInfo;
import com.sumadhura.employeeservice.service.dto.FinTransactionClearedInfo;
import com.sumadhura.employeeservice.service.dto.FinTransactionEntryDetailsInfo;
import com.sumadhura.employeeservice.service.dto.FinancialConsolidatedReceiptInfo;
import com.sumadhura.employeeservice.service.dto.FinancialDemandNoteMS_TRN_Info;
import com.sumadhura.employeeservice.service.dto.FinancialGstDetailsInfo;
import com.sumadhura.employeeservice.service.dto.FinancialProjectMileStoneInfo;
import com.sumadhura.employeeservice.service.dto.FinancialSchemeInfo;
import com.sumadhura.employeeservice.service.dto.FinancialUploadDataInfo;
import com.sumadhura.employeeservice.service.dto.FlatBookingInfo;
import com.sumadhura.employeeservice.service.dto.MileStoneInfo;
import com.sumadhura.employeeservice.service.dto.SiteDetailsInfo;
import com.sumadhura.employeeservice.service.helpers.EmployeeFinancialHelper;
import com.sumadhura.employeeservice.service.helpers.EmployeeFinancialPushNotificationHelper;
import com.sumadhura.employeeservice.service.mappers.BookingFormMapper;
import com.sumadhura.employeeservice.service.mappers.EmployeeFinancialMapper;
import com.sumadhura.employeeservice.util.Base64FileUtil;
import com.sumadhura.employeeservice.util.CurrencyUtil;
import com.sumadhura.employeeservice.util.ResponceCodesUtil;
import com.sumadhura.employeeservice.util.TimeUtil;
import com.sumadhura.employeeservice.util.Util;
import com.sun.istack.NotNull;

/**
 * @author @NIKET CH@V@N
 * @description performing all financial services
 * @since 13-01-2020
 * @time 10:40 AM
 */
@Service("EmployeeFinancialService")
public class EmployeeFinancialServiceImpl implements EmployeeFinancialService {

    private final Logger log = Logger.getLogger(EmployeeFinancialServiceImpl.class);
	
	private RoundingMode roundingMode = RoundingMode.HALF_UP;
	private int roundingModeSize = 2;
	private long cgstDividedBy = 2;
	private long sgstDividedBy = 2;
    
	private static final List<Long> ALL_TYPES_OF_PAYMENTS = EmployeeFinancialServiceDaoImpl.ALL_TYPES_OF_PAYMENTS;
	
	@Autowired
	@Qualifier("EmployeeFinancialServiceDao")
	private EmployeeFinancialServiceDao employeeFinancialServiceDao;
	
	@Autowired(required = true)
	@Qualifier("BookingFormServiceDaoImpl")
	private BookingFormServiceDao bookingFormServiceDaoImpl;
	
	@Autowired(required = true)
	@Qualifier("BookingFormServiceImpl")
	private BookingFormService bookingFormServiceImpl;
	
	@Autowired(required = true)
	@Qualifier("employeeFinancialMapper")
	private EmployeeFinancialMapper financialMapper;
	
	@Autowired(required = true)
	@Qualifier("EmployeeFinancialPushNotificationHelper")
	private EmployeeFinancialPushNotificationHelper pushNotificationHelper;

	@Autowired
	private CurrencyUtil currencyUtil;

	@Autowired(required = true)
	@Qualifier("mailService")
	private MailService mailServiceImpl;
	
	/*@Autowired
	private FinancialScheduler financialScheduler;*/
	
	@Autowired
	private GenerateExcelTransactionScheduler excelTransactionScheduler;
	
	private BookingFormMapper bookingFormMapper = new BookingFormMapper();
	
	@Autowired(required=true)
	@Qualifier("employeeFinancialHelper")
	private EmployeeFinancialHelper employeeFinancialHelper;
	
	@Autowired(required=true)
	private ResponceCodesUtil responceCodesUtil;
	
	@Override
	public List<EmployeeFinancialResponse> getAllMileStoneAliasNameAssociatedWithSite(EmployeeFinancialServiceInfo employeeFinancialInfo) {
		//log.info(" ***** Control inside EmployeeFinancialServiceImpl.getAllMileStoneAliasNameAssociatedWithSite() ***** ");
		String condition = FinEnum.LOAD_ALL_DATA.getName();
		List<FinancialMileStoneClassifidesPojo> employeeFinancialPojo = employeeFinancialServiceDao.getAllMileStoneAliasNameAssociatedWithSite(employeeFinancialInfo, Status.ACTIVE,condition);
		return financialMapper.setEmployeeFinancialPojoListTosetEmployeeFinancialResponseList(employeeFinancialPojo);
 	}
	
	@Override
	public List<FinancialProjectMileStonePojo> getMileStoneNameAssociatedWithMilestoneClassifidesIdForDemandNote(EmployeeFinancialServiceInfo employeeFinancialInfo){
		List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList = employeeFinancialServiceDao.getMileStoneNameAssociatedWithMilestoneClassifidesIdForDemandNote(employeeFinancialInfo, Status.ACTIVE,"");
		return financialProjectMileStonePojoList;
	}
	
	@Override
	public List<EmployeeFinancialResponse> getMileStoneNameAssociatedWithMilestoneClassifidesId(EmployeeFinancialServiceInfo employeeFinancialInfo) {
		//log.info(" ***** EmployeeFinancialServiceImpl.getMileStoneNameAssociatedWithMilestoneClassifidesId() ***** ");
		List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList = null;
		if(Util.isNotEmptyObject(employeeFinancialInfo.getCondition()) && ( employeeFinancialInfo.getCondition().equalsIgnoreCase("VIEW_DEMAND_NOTES")  || employeeFinancialInfo.getCondition().equalsIgnoreCase("loadAllMileStone"))){
			financialProjectMileStonePojoList = employeeFinancialServiceDao.getMileStoneNameAssociatedWithMilestoneClassifidesIdForDemandNote(employeeFinancialInfo, Status.ACTIVE,"");
			return financialMapper.empFinancialMileStoneAliasNamePojo$empFinancialMileStoneDtlsPojo(financialProjectMileStonePojoList,new FinancialMileStoneClassifidesPojo(),employeeFinancialInfo);
		} else {
			String condition = FinEnum.LOAD_BY_ID.getName();
			List<FinancialMileStoneClassifidesPojo> employeeFinancialPojo = employeeFinancialServiceDao.getAllMileStoneAliasNameAssociatedWithSite(employeeFinancialInfo, Status.ACTIVE,condition);
			//if(employeeFinancialPojo.isEmpty()) { throw new RuntimeException("Alias name details found empty"); }
			financialProjectMileStonePojoList = employeeFinancialServiceDao.getMileStoneNameAssociatedWithMilestoneClassifidesIdForDemandNote(employeeFinancialInfo, Status.ACTIVE,"");
			
			List<EmployeeFinancialResponse> financialMileStoneDemandNoteRespList = financialMapper.empFinancialMileStoneAliasNamePojo$empFinancialMileStoneDtlsPojo(financialProjectMileStonePojoList,employeeFinancialPojo.get(0),employeeFinancialInfo);
			return financialMileStoneDemandNoteRespList;
		}
	}

	@Override
	public List<EmployeeFinancialResponse> getMileStoneDetailsForTDS( EmployeeFinancialServiceInfo employeeFinancialInfo) throws Exception {
		log.info(" ***** EmployeeFinancialServiceImpl.getMileStoneDetailsForTDS() ***** ");
		List<EmployeeFinancialResponse> employeeFinancialResponseList = new ArrayList<>();
		
		EmployeeFinancialResponse employeeFinancialResponse = new EmployeeFinancialResponse();
		//List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList = null;
		List<FinancialProjectMileStoneResponse> financialProjectMileStoneResponseList = new ArrayList<>();
		FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		
		finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.INPROGRESS.getStatus(),Status.PENDING.getStatus(), Status.PAID.getStatus()}));
		finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()}));
		customerPropertyDetailsInfo.setFlatBookingId(employeeFinancialInfo.getBookingFormId());
		customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
		List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);

		for (FinancialProjectMileStonePojo financialProjectMileStonePojo : listOfPendingMileStoneAmount) {
			List<FinBookingFormTdsDetailsPojo> tdsDetailsPojo = employeeFinancialServiceDao.getMileStoneTDSDetails(financialProjectMileStonePojo);
			if(!tdsDetailsPojo.isEmpty()) {
				FinBookingFormTdsDetailsPojo  tdsDetails = tdsDetailsPojo.get(0);
				financialProjectMileStonePojo.setSubmitedById(tdsDetails.getSubmitedBy());
				financialProjectMileStonePojo.setSubmitedByName(tdsDetails.getSubmitedByName());
				financialProjectMileStonePojo.setStatusId(tdsDetails.getStatusId());
				financialProjectMileStonePojo.setStatusName(tdsDetails.getStatusName());
				financialProjectMileStonePojo.setTdsStatusId(tdsDetails.getTdsStatusId());
				financialProjectMileStonePojo.setTdsStatusName(tdsDetails.getTdsStatusName());
				financialProjectMileStonePojo.setFinBookingFormTdsDtlsId(tdsDetails.getFinBookingFormTdsDtlsId());
				double mileStoneTdsAmount = (financialProjectMileStonePojo.getMileStoneBasicAmount() / 100d) * 1d;
				financialProjectMileStonePojo.setBokFrmDemNteSchTaxMapInfos(null);
				financialProjectMileStonePojo.setMileStoneTdsAmount(mileStoneTdsAmount);
			} else {
				
			}
		}
		
		List<FinancialProjectMileStoneResponse> previouseFinancialProjectMileStoneResponseList = financialMapper.financialProjectMileStonePojoListToFinancialProjectMileStoneResponseList(listOfPendingMileStoneAmount);
		if(!previouseFinancialProjectMileStoneResponseList.isEmpty()) {
			financialProjectMileStoneResponseList.addAll(previouseFinancialProjectMileStoneResponseList);
		}
		//employeeFinancialServiceDao.getMileStoneDetailsForTDS(employeeFinancialInfo, Status.ACTIVE);
		employeeFinancialResponse.setFinancialProjectMileStoneResponse(financialProjectMileStoneResponseList);
		employeeFinancialResponseList.add(employeeFinancialResponse);
		return employeeFinancialResponseList;
	}
	
	@Override
	public  EmployeeFinancialResponse  updateMileStoneTDSDetails(EmployeeFinancialServiceInfo employeeFinancialInfo) throws InstantiationException, IllegalAccessException {
	log.info(" ***** EmployeeFinancialServiceImpl.updateMileStoneTDSDetails() ***** ");
		EmployeeFinancialResponse employeeFinancialResponse=new EmployeeFinancialResponse();
		for (FinancialProjectMileStoneInfo tdsInfo : employeeFinancialInfo.getFinancialProjectMileStoneRequests()) {
			tdsInfo.setSubmitedById(MetadataId.valueOf(tdsInfo.getSubmitedByName().toUpperCase()).getId());
			//tdsInfo.setStatusId(Util.isEmptyObject(tdsInfo.getStatusName())?6l:Status.valueOf(tdsInfo.getStatusName().toUpperCase()).getStatus());
			//tdsInfo.setTdsStatusId(Status.valueOf(tdsInfo.getStatusName().toUpperCase()).getStatus());
			tdsInfo.setTdsStatusId(Util.isEmptyObject(tdsInfo.getTdsStatusName())?Status.valueOf(tdsInfo.getStatusName().toUpperCase()).getStatus():Status.valueOf(tdsInfo.getTdsStatusName().toUpperCase()).getStatus());
			//tdsInfo.setModifiedBy(tdsInfo.getCreatedBy());
 			employeeFinancialServiceDao.updateMileStoneTDSDetails((FinBookingFormTdsDetailsPojo)financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(tdsInfo, FinBookingFormTdsDetailsPojo.class));
		}	
		return employeeFinancialResponse;
	}
	
	@Override
	public List<EmployeeFinancialResponse> getDemandNoteBlockDetails(EmployeeFinancialServiceInfo employeeFinancialDemandNoteInfo) {
		log.info(" ***** EmployeeFinancialServiceImpl.getDemandNoteBlockSelectionDetails() ***** ");
		String condition = FinEnum.LOAD_BY_ID.getName();
		List<FinancialMileStoneClassifidesPojo> employeeFinancialPojo = employeeFinancialServiceDao.getAllMileStoneAliasNameAssociatedWithSite(employeeFinancialDemandNoteInfo, Status.ACTIVE,condition);
		List<FinancialMileStoneClassifideMappingBlocksPojo> mileStoneMappingBlocksPojos = employeeFinancialServiceDao.getDemandNoteBlockDetails(employeeFinancialDemandNoteInfo, Status.ACTIVE);
		//for (FinancialMileStoneClassifideMappingBlocksPojo mappingBlocksPojo : mileStoneMappingBlocksPojos) {
			List<CustomerPropertyDetailsPojo> listOfFlats = employeeFinancialServiceDao.getFlatDetailsByBlockId(employeeFinancialDemandNoteInfo,"",new HashSet<Long>());
			BookingFormRequest bookingFormRequest = new BookingFormRequest();
			bookingFormRequest.setStatusId(Status.ACTIVE.getStatus());
			bookingFormRequest.setRequestUrl("getDemandNoteBlockSelectionDetails");
			//List<FlatBookingPojo> flatBookPojo = bookingFormServiceDaoImpl.getFlatbookingDetails(bookingFormRequest);
		//}
		EmployeeFinancialMapper mapper = new EmployeeFinancialMapper();
		List<EmployeeFinancialResponse> list = mapper.empFinancialMileStoneClassifidesPojo$financialProjectMileStonePojo$customerPropertyDetailsPojo(employeeFinancialPojo.get(0),mileStoneMappingBlocksPojos,listOfFlats);	
		return list;
	}
	
	/**
	 * Used this service used for Generate Demand Note,Re-Generate Demand Note,save new booking, upload data
	 */
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialResponse generateDemandNoteService(EmployeeFinancialServiceInfo employeeFinancialDemandNoteInfo) 
			throws Exception {
		Properties classLevelProp = responceCodesUtil.getApplicationProperties();
		//String requestUrl = employeeFinancialDemandNoteInfo.getRequestUrl()==null?"":employeeFinancialDemandNoteInfo.getRequestUrl();
		EmployeeFinancialResponse employeeFinancialResponse = new EmployeeFinancialResponse();
		List<CustomerPropertyDetailsInfo> nonGeneratedDemandNoteForFlats = new ArrayList<CustomerPropertyDetailsInfo>();
		Map<Long, List<FinancialProjectMileStonePojo>> customerGeneratedMilestone = new HashMap<Long, List<FinancialProjectMileStonePojo>>();
		final Map<Long, List<FinancialProjectMileStonePojo>> flatPreviousMilestoneNonPaidData = new HashMap<Long, List<FinancialProjectMileStonePojo>>();
		employeeFinancialResponse.setNonSavedDemandNoteDetails(nonGeneratedDemandNoteForFlats);
		final List<Long> projectMileStoneIds = new ArrayList<Long>();//milestone id
		boolean isDemandNoteDataInserted=false;
		List<String> errorMsgs = null;
		List<Long> blockIdForPdf = new ArrayList<>();
		HashMap<Long, Long>  generatedMileStones=new HashMap<Long, Long>();
		Set<Long> flatIdForPdf = new HashSet<>();
		List<Long> bookingFormIdForPdf= new ArrayList<>();
		boolean isAnyDemandNoteIsGenerated = false;
		List<Long> bookingFormDemandNoteId = new ArrayList<>();
		@SuppressWarnings("unused")
		Long finProjectDemandNoteId, demandNoteMappingId, demandNoteStatisticsId1, finBookingFormMilestonesId,
				finBookingFormDemandNoteId, finBookingFormDemandNoteTaxMapId;
		HashMap<Long, Long> bookingFormIds=new HashMap<Long, Long>();
		final Long empId = Util.isEmptyObject(employeeFinancialDemandNoteInfo.getEmpId())?0l:employeeFinancialDemandNoteInfo.getEmpId();
		int milestoneSize = 0;
		final boolean isReGenerateDemandNote =  Util.isEmptyObject(employeeFinancialDemandNoteInfo.isReGenerateDemandNote())?false:employeeFinancialDemandNoteInfo.isReGenerateDemandNote();
		final boolean isThisUploadedData = employeeFinancialDemandNoteInfo.isThisUplaodedData();
		String enable_demand_note_logic_for_excel = classLevelProp.getProperty("ENABLE_DEMAND_NOTE_LOGIC_FOR_EXCEL");
		enable_demand_note_logic_for_excel = enable_demand_note_logic_for_excel==null?"":enable_demand_note_logic_for_excel;
		//if this is upload data action, and enable demand note logic from properties is true, then demand note logic will apply
		final boolean isEnableUploadDemandNoteDatesLogic = (isThisUploadedData && (enable_demand_note_logic_for_excel.equalsIgnoreCase("true")));
		final boolean isThisFlatWiseDnGenerate = employeeFinancialDemandNoteInfo.getDemandNoteSelectionType().equalsIgnoreCase(FinEnum.SEND_SINGLE_MULTIPLE.getName());
		
		if(isThisUploadedData) {//if this request from upload date then no need to send the push notification and emails to customer
			employeeFinancialDemandNoteInfo.setSendNotification(false);
		} else if("DoNotSendEmail".equalsIgnoreCase(employeeFinancialDemandNoteInfo.getCondition())) {
			employeeFinancialDemandNoteInfo.setCondition(employeeFinancialDemandNoteInfo.getCondition());
			employeeFinancialDemandNoteInfo.setSendNotification(false);
			//if this request from saveBooking API then, *no need to send the push notification and emails to customer 
		} else if("Final_Demand_Note".equalsIgnoreCase(employeeFinancialDemandNoteInfo.getActionUrl()) &&  "saveBookingDetails".equalsIgnoreCase(employeeFinancialDemandNoteInfo.getRequestUrl())) {
			//if request from save booking or update booking service then don't send push notification and emails to customer
			employeeFinancialDemandNoteInfo.setSendNotification(false);
		} else {
			//send push notification and emails to customer, if this is regular or regnerate demand note
			employeeFinancialDemandNoteInfo.setSendNotification(true);
		}
		
		/* Getting Current selected Milestone Data */
		getCurrentProjectMilestoneData(employeeFinancialDemandNoteInfo);

		//loading previous milestone data
		if(true) {
			// || (employeeFinancialDemandNoteInfo.getCondition()!=null && employeeFinancialDemandNoteInfo.getCondition().contains("LoadALL_MS"))
			// for uploaded data also taking demand note using demand note logic
			//"All_MS" this is used while uploading time, to load previous ms
			if(Util.isNotEmptyObject(employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests())) {
				if(isReGenerateDemandNote) {
					if(employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().size()>=2) {
						//if this is regenerate demand note request and selected 4th ms to generate, then loading 3,2,1 ms records
						FinancialProjectMileStoneInfo currentOneFinancialProjectMileStoneInfo = employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().get(0);
						employeeFinancialDemandNoteInfo.setProjectMileStoneIds(Arrays.asList(currentOneFinancialProjectMileStoneInfo.getProjectMilestoneId()));
					}
				} else {
					//if this is the regular demand note request, and selected 4th ms to generate, then loading 3,2,1 ms records 
					FinancialProjectMileStoneInfo currentOneFinancialProjectMileStoneInfo = employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().get(0);
					employeeFinancialDemandNoteInfo.setProjectMileStoneIds(Arrays.asList(currentOneFinancialProjectMileStoneInfo.getProjectMilestoneId()));
				}
			}
			//loading previous milestone details of selected milestone in screen
			loadMilestoneData(employeeFinancialDemandNoteInfo);
		}// else {
			//if this is request from upload milestone data
			if(isThisUploadedData && isEnableUploadDemandNoteDatesLogic ){
				//if this condition true then demand note date logic will apply like
				//1st ms Demand note date = booking Date, Due date = Booking Date+15 days
				//2st ms Demand note date = booking Date, Due date = Booking Date+30 days
				//and remaining milestone will compare with booking date, if booking date is before the milestone master date, then master date will apply in demand note
				FinancialProjectMileStoneInfo currentOneFinancialProjectMileStoneInfo = employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().get(0);
				employeeFinancialDemandNoteInfo.setProjectMileStoneIds(Arrays.asList(currentOneFinancialProjectMileStoneInfo.getProjectMilestoneId()));
				employeeFinancialDemandNoteInfo.setDataUploadCondition("LoadCurrentMSDetails");
				loadMilestoneMasterData(employeeFinancialDemandNoteInfo);
			}
			
		//}
		try {
			if (employeeFinancialDemandNoteInfo.isReGenerateDemandNote()) {
				//List<FinancialProjectMileStoneInfo> mileStoneList = employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests();
				FinancialProjectMileStoneInfo dummyMileStoneInfo = employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().get(employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().size()-1); 
				dummyMileStoneInfo.setFinMilestoneClassifidesId(employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().get(0).getFinMilestoneClassifidesId());
				dummyMileStoneInfo.setProjectMilestoneId(0l);
				dummyMileStoneInfo.setMileStoneNo(0l);
			}
			log.info(employeeFinancialDemandNoteInfo.getActionUrl()+"EmployeeFinancialServiceImpl.generateDemandNoteService() "+ isEnableUploadDemandNoteDatesLogic+" SIZE ***** = "+employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().size());
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = null;
			if(isThisFlatWiseDnGenerate) {
				employeeFinancialDemandNoteInfo.setBlockIds(null);employeeFinancialDemandNoteInfo.setFloorIds(null);
				customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialDemandNoteInfo);
			}
			milestoneSize = employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().size();
			for (FinancialProjectMileStoneInfo finProjDemandNoteInfoMain : employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests()) {
				 
				finProjDemandNoteInfoMain.setCurrentprojectMileStoneIds(employeeFinancialDemandNoteInfo.getCurrentprojectMileStoneIds());
				if(Util.isNotEmptyObject(finProjDemandNoteInfoMain.getProjectMilestoneId()) && !projectMileStoneIds.contains(finProjDemandNoteInfoMain.getProjectMilestoneId())) {
					projectMileStoneIds.add(finProjDemandNoteInfoMain.getProjectMilestoneId());
				}
				
				if(isThisFlatWiseDnGenerate) {//if this is selected flat wise
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
					FinancialProjectMileStoneInfo finProjDemandNoteInfo =null;
					List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList1 = null;
					FinProjDemNoteStatisticsPojo demNoteStatisticsPojo = null;
					employeeFinancialDemandNoteInfo.setBlockIds(null);employeeFinancialDemandNoteInfo.setFloorIds(null);
						Iterator<CustomerPropertyDetailsPojo> iterator=customerPropertyDetailsPojoList.iterator();
						for (Iterator<CustomerPropertyDetailsPojo> iterator2 = iterator; iterator2.hasNext();) {
							CustomerPropertyDetailsPojo customerPropertyDetailsPojo =  iterator2.next();
							if(Util.isEmptyObject(customerPropertyDetailsPojo) || (Util.isEmptyObject(customerPropertyDetailsPojo.getFlatBookingId()) || Util.isEmptyObject(customerPropertyDetailsPojo.getPancard()))) {
								continue;
							}
							finProjDemandNoteInfo = (FinancialProjectMileStoneInfo) finProjDemandNoteInfoMain.clone();
							//boolean isDemandNoteRaised = false;
							customerPropertyDetailsInfo = financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
							customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
							if(finProjDemandNoteInfo.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
								//continue;
							}
						
						demNoteStatisticsPojo = financialMapper.copyPropertiesFromCustomerPropertyDetailsInfoTOFinProjDemNoteStatisticsPojo(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo,FinProjDemNoteStatisticsPojo.class);
						financialProjectMileStonePojoList1 = null;
						boolean flag = false;
						
						if(customerGeneratedMilestone.containsKey(customerPropertyDetailsInfo.getFlatBookingId())) {
							financialProjectMileStonePojoList1 = customerGeneratedMilestone.get(customerPropertyDetailsInfo.getFlatBookingId());
						}else {
							 if(milestoneSize != 1 && isThisUploadedData) {
								 //for loading all the milestone records, Setting upload data false
								 finProjDemandNoteInfo.setThisUplaodedData(false);
							 }
							
							//loading milestone generated records
							financialProjectMileStonePojoList1 = employeeFinancialServiceDao.isMileStoneInitiatedForThisFlatBookingFormId(finProjDemandNoteInfo,customerPropertyDetailsInfo,demNoteStatisticsPojo);
							customerGeneratedMilestone.put(customerPropertyDetailsInfo.getFlatBookingId(), financialProjectMileStonePojoList1);
							finProjDemandNoteInfo.setThisUplaodedData(isThisUploadedData);//reassigning upload data value
						}
						
						if(isEnableUploadDemandNoteDatesLogic) {//!isThisUploadedData
							employeeFinancialHelper.assignDemandNoteDate(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						} else if(!employeeFinancialDemandNoteInfo.getCurrentprojectMileStoneIds().contains(finProjDemandNoteInfo.getProjectMilestoneId())) {
							employeeFinancialHelper.assignDemandNoteDate(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						} else if(isThisUploadedData) {
							employeeFinancialHelper.setDemandNoteFormat(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						}
						if(employeeFinancialDemandNoteInfo.isReGenerateDemandNote() && Util.isEmptyObject(finProjDemandNoteInfo.getMileStoneDueDate())) {
							employeeFinancialHelper.assignDemandNoteDateForRegenerate(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						}

						finProjDemandNoteInfo.setExplicitGeneratedRecordMileStonePojo(null);
						FinancialProjectMileStonePojo generatedMileStonePojo = checkMilestoneGeneratedForFlat(financialProjectMileStonePojoList1,finProjDemandNoteInfo);
						 if(Util.isEmptyObject(generatedMileStonePojo)) {
							 flag = false;//milestone is not generated
							 finProjDemandNoteInfo.setExplicitGeneratedRecordMileStonePojo(null);
						 }else {
							 //here checking is this current processing milestone record is exist in DB or not, it will check loaded Milestone record id with  Status.EXPLICIT_GENERATED_RECORD
							 Long msStatusId = generatedMileStonePojo.getMsStatusId();
							 if(msStatusId!=null && msStatusId.equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
								 //if this condition true means the current processing milestone record is found
								 flag = false;//milestone record generated at the time of receipt entry, with out generating milestone
								 finProjDemandNoteInfo.setExplicitGeneratedRecordMileStonePojo(generatedMileStonePojo);
							} else {
								flag = true;
								if (finProjDemandNoteInfo.isReGenerateDemandNote() && finProjDemandNoteInfo.getMilestoneDate()==null) {
									if(generatedMileStonePojo!=null && generatedMileStonePojo.getMilestoneDemandNoteDate()!=null) {
										finProjDemandNoteInfo.setMilestoneDate(generatedMileStonePojo.getMilestoneDemandNoteDate());
									}
								}
							}
						 }
						Timestamp aggrementDate = null;
						bookingFormIdForPdf.add(customerPropertyDetailsInfo.getFlatBookingId());
						flatIdForPdf.add(customerPropertyDetailsInfo.getFlatId());
						if (finProjDemandNoteInfo.getMileStoneNo() != 1) {
							 aggrementDate = employeeFinancialServiceDao.getFlatAgreementCompletedDate(finProjDemandNoteInfo,customerPropertyDetailsInfo);
							 employeeFinancialDemandNoteInfo.setFinMilestoneClassifidesId(finProjDemandNoteInfo.getFinMilestoneClassifidesId());
							 //here loading customers involved Alias name, customere can't get shifted from one Alias name to another alias name
							 List<FinancialMileStoneClassifidesPojo> mileStoneClassifidesPojo = employeeFinancialServiceDao.loadCustomerInvolvedAlianNameDetails(employeeFinancialDemandNoteInfo,customerPropertyDetailsInfo);
							 if(Util.isNotEmptyObject(mileStoneClassifidesPojo) &&  !mileStoneClassifidesPojo.get(0).getFinMilestoneClassifidesId().equals(employeeFinancialDemandNoteInfo.getFinMilestoneClassifidesId())) {
								 nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
								throw new EmployeeFinancialServiceException("Demand note can not generated for "+finProjDemandNoteInfo.getMilestoneName()+" milestone. as '"+customerPropertyDetailsInfo.getFlatNo()+"' already involved in alias "+mileStoneClassifidesPojo.get(0).getMileStoneAliasName()+" group.");
							 }
							 if(Util.isEmptyObject(aggrementDate)) {
								nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
								//throw new EmployeeFinancialServiceException("Flat agreement is not completed "+customerPropertyDetailsInfo.getFlatNo());
								continue;
							 }
						}
						
						if (finProjDemandNoteInfo.isReGenerateDemandNote()) {//if this is regenerate Demand note
							if (flag) {//if milestone generated
								flag = false;
							} else {
								nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
								if(finProjDemandNoteInfo.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
									//continue;
								} else {
									throw new EmployeeFinancialServiceException("Demand note is not generated for "+finProjDemandNoteInfo.getMilestoneName()+" milestone. Flat No "+customerPropertyDetailsInfo.getFlatNo());
								}
							}
						}
						if (flag) {// if flag is true means already milestone is generated
							nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
							log.info(" invalid entry, already demand note generated on following details Flat Booking Form Id : "+customerPropertyDetailsInfo.getFlatBookingId()+" getProjectMilestoneId "+finProjDemandNoteInfo.getProjectMilestoneId());
							if(!employeeFinancialDemandNoteInfo.isReGenerateDemandNote()) {
								//throw new EmployeeFinancialServiceException(" Already demand note generated on following details Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" Mile Stone Name : "+finProjDemandNoteInfo.getMilestoneName());
							}
							//iterator2.remove();
						} else {
							//isDemandNoteRaised = true;
							if (employeeFinancialDemandNoteInfo.isNewCustomer()) {
								generatedMileStones.put(customerPropertyDetailsInfo.getFlatBookingId(),finProjDemandNoteInfo.getProjectMilestoneId());
								processDemandNoteDetails(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo);
							} else {
								 generatedMileStones.put(customerPropertyDetailsInfo.getFlatBookingId(),finProjDemandNoteInfo.getProjectMilestoneId());
								 if(finProjDemandNoteInfo.getMileStoneNo()==1) {
									processDemandNoteDetails(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo);
								} else if(Util.isNotEmptyObject(aggrementDate)) {
									processDemandNoteDetails(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo);
								}/* else if(aggrementDate!=null&&TimeUtil.differenceBetweenDays(aggrementDate, finProjDemandNoteInfo.getMilestoneDate())>0 && finProjDemandNoteInfo.getMileStoneNo()!=1) {
									processDemandNoteDetails(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo);//IMP Code	
								}*/ else {
									nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
									continue;
								}
							}
							
							try {
								isAnyDemandNoteIsGenerated = true;
								saveBookingFormDemandNoteDetails(finProjDemandNoteInfo,customerPropertyDetailsInfo,bookingFormIds,flatPreviousMilestoneNonPaidData,employeeFinancialDemandNoteInfo);
								
								bookingFormDemandNoteId.add(finProjDemandNoteInfo.getFinBookingFormDemandNoteId());
							} catch (Exception e) {
								e.printStackTrace();
								if(e.getMessage()!=null && e.getMessage().contains("Milestone due date found empty")) {
									throw new EmployeeFinancialServiceException(e.getMessage());
								} else if(e.getMessage()!=null && e.getMessage().contains("Scheme details not found")) {
									throw new EmployeeFinancialServiceException(e.getMessage());
								}
							}
						}
					}
				}
				if(!isThisFlatWiseDnGenerate) {
					//customerPropertyDetailsPojoList = new ArrayList<>();
					//String condition = "";
					List<Long> blockIds=new ArrayList<Long>();
					
					if(employeeFinancialDemandNoteInfo.getDemandNoteSelectionType().equalsIgnoreCase(FinEnum.ALL_BLOCKS.getName())){
						List<FinancialMileStoneClassifideMappingBlocksPojo> mileStoneMappingBlocksPojos = employeeFinancialServiceDao.getDemandNoteBlockDetails(employeeFinancialDemandNoteInfo, Status.ACTIVE);
						for (FinancialMileStoneClassifideMappingBlocksPojo blockDetails : mileStoneMappingBlocksPojos) {
							if(Util.isNotEmptyObject(blockDetails.getBlockId())) {
								blockIds.add(blockDetails.getBlockId());
							}
						}
						employeeFinancialDemandNoteInfo.setBlockIds(blockIds);
					} else if (employeeFinancialDemandNoteInfo.getDemandNoteSelectionType().equalsIgnoreCase(FinEnum.BLOCK_WISE.getName())) {
						blockIds.addAll(employeeFinancialDemandNoteInfo.getBlockIds());
					}
					blockIdForPdf.addAll(blockIds);
					isDemandNoteDataInserted = false;
					EmployeeFinancialServiceInfo dnInfo = (EmployeeFinancialServiceInfo) employeeFinancialDemandNoteInfo.clone();
					String prevActionUrl = dnInfo.getActionUrl();
					dnInfo.setActionUrl("GenerateDemandNote1");
					if(Util.isEmptyObject(customerPropertyDetailsPojoList)) {
						  customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(dnInfo);
				    }
					dnInfo.setActionUrl(prevActionUrl);
					FinancialProjectMileStoneInfo finProjDemandNoteInfo = null;
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
					FinProjDemNoteStatisticsPojo demNoteStatisticsPojo = null;
					List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList1 = null;
					FinancialProjectMileStonePojo generatedMileStonePojo = null;
					for (CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList) {
						if(Util.isEmptyObject(customerPropertyDetailsPojo) || (Util.isEmptyObject(customerPropertyDetailsPojo.getFlatBookingId())
								|| Util.isEmptyObject(customerPropertyDetailsPojo.getPancard()))) {
							continue;
						}
						generatedMileStonePojo = null;
						finProjDemandNoteInfo = (FinancialProjectMileStoneInfo) finProjDemandNoteInfoMain.clone();
						customerPropertyDetailsInfo = new EmployeeFinancialMapper().copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
						customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
						demNoteStatisticsPojo =  financialMapper.copyPropertiesFromCustomerPropertyDetailsInfoTOFinProjDemNoteStatisticsPojo(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo,FinProjDemNoteStatisticsPojo.class);
						
						boolean flag = false;
						financialProjectMileStonePojoList1 = null;
						
						if(customerGeneratedMilestone.containsKey(customerPropertyDetailsInfo.getFlatBookingId())) {
							financialProjectMileStonePojoList1 = customerGeneratedMilestone.get(customerPropertyDetailsInfo.getFlatBookingId());
						} else {
							 if(milestoneSize != 1 && isThisUploadedData) {
								 //setting upload data false, so it will load all generated milestone 
								 finProjDemandNoteInfo.setThisUplaodedData(false);
							 }

							financialProjectMileStonePojoList1 = employeeFinancialServiceDao.isMileStoneInitiatedForThisFlatBookingFormId(finProjDemandNoteInfo,customerPropertyDetailsInfo,demNoteStatisticsPojo);
							customerGeneratedMilestone.put(customerPropertyDetailsInfo.getFlatBookingId(), financialProjectMileStonePojoList1);
							finProjDemandNoteInfo.setThisUplaodedData(isThisUploadedData);
						}
						/*if(isEnableUploadDemandNoteDatesLogic || !employeeFinancialDemandNoteInfo.getCurrentprojectMileStoneIds().contains(finProjDemandNoteInfo.getProjectMilestoneId())) {//!isThisUploadedData
							employeeFinancialHelper.assignDemandNoteDate(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						}*/
						if(isEnableUploadDemandNoteDatesLogic) {//!isThisUploadedData
							employeeFinancialHelper.assignDemandNoteDate(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						} else if(!employeeFinancialDemandNoteInfo.getCurrentprojectMileStoneIds().contains(finProjDemandNoteInfo.getProjectMilestoneId())) {
							employeeFinancialHelper.assignDemandNoteDate(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						} else if(isThisUploadedData) {
							employeeFinancialHelper.setDemandNoteFormat(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						} 
						if(employeeFinancialDemandNoteInfo.isReGenerateDemandNote() && Util.isEmptyObject(finProjDemandNoteInfo.getMileStoneDueDate())) {
							employeeFinancialHelper.assignDemandNoteDateForRegenerate(finProjDemandNoteInfo,customerPropertyDetailsInfo,employeeFinancialDemandNoteInfo);
						}
						finProjDemandNoteInfo.setExplicitGeneratedRecordMileStonePojo(null);
						generatedMileStonePojo = checkMilestoneGeneratedForFlat(financialProjectMileStonePojoList1,finProjDemandNoteInfo);
						//List<FinancialProjectMileStonePojo>  financialProjectMileStonePojoList = employeeFinancialServiceDao.isMileStoneInitiatedForThisFlatBookingFormId(finProjDemandNoteInfo,customerPropertyDetailsInfo,demNoteStatisticsPojo);
						if(Util.isEmptyObject(generatedMileStonePojo)) {
							 flag = false;
							 finProjDemandNoteInfo.setExplicitGeneratedRecordMileStonePojo(null);
						 } else {
							 Long msStatusId = generatedMileStonePojo.getMsStatusId();
							 if(msStatusId!=null && msStatusId.equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
								 flag = false;
								 finProjDemandNoteInfo.setExplicitGeneratedRecordMileStonePojo(generatedMileStonePojo);
							} else {
								flag = true;
							}
						 }
						Timestamp aggrementDate = null;
						if (finProjDemandNoteInfo.getMileStoneNo() != 1) {
							 aggrementDate = employeeFinancialServiceDao.getFlatAgreementCompletedDate(finProjDemandNoteInfo,customerPropertyDetailsInfo);	
							 List<FinancialMileStoneClassifidesPojo> mileStoneClassifidesPojo = employeeFinancialServiceDao.loadCustomerInvolvedAlianNameDetails(employeeFinancialDemandNoteInfo,customerPropertyDetailsInfo);
							 if(Util.isNotEmptyObject(mileStoneClassifidesPojo) &&  !mileStoneClassifidesPojo.get(0).getFinMilestoneClassifidesId().equals(employeeFinancialDemandNoteInfo.getFinMilestoneClassifidesId())) {
								 nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
								throw new EmployeeFinancialServiceException("Demand note can not generated for "+finProjDemandNoteInfo.getMilestoneName()+" milestone. as '"+customerPropertyDetailsInfo.getFlatNo()+"' already involved in alias "+mileStoneClassifidesPojo.get(0).getMileStoneAliasName()+" group.");
							 }
							 if(Util.isEmptyObject(aggrementDate)) {
									nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
									//throw new EmployeeFinancialServiceException("Flat agreement is not completed "+customerPropertyDetailsInfo.getFlatNo());
									continue;
							 }
						}
						
						if (employeeFinancialDemandNoteInfo.isReGenerateDemandNote()) {
							if (flag) {
								flag=false;
							} else {
								nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
								if(finProjDemandNoteInfo.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
									log.info(finProjDemandNoteInfo.getMilestoneName());
								} else {
									throw new EmployeeFinancialServiceException("Demand note is not generated for "+finProjDemandNoteInfo.getMilestoneName()+" milestone. Flat No "+customerPropertyDetailsInfo.getFlatNo()+" can not proceed Re-generate Demand Note.");
								}
							}
						}
						
						if (flag) {
							nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
							if(!employeeFinancialDemandNoteInfo.isReGenerateDemandNote()) {
								//throw new EmployeeFinancialServiceException(" Already demand note generated on following details Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" Mile Stone Name : "+finProjDemandNoteInfo.getMilestoneName());
								continue;
							}
							//iterator2.remove();
						} else {
							generatedMileStones.put(customerPropertyDetailsInfo.getFlatBookingId(),finProjDemandNoteInfo.getProjectMilestoneId());
							if (!isDemandNoteDataInserted) {
								//processDemandNoteDetails(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo);
								
								if (finProjDemandNoteInfo.getMileStoneNo() == 1) {
									processDemandNoteDetails(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo);
								} else if(Util.isNotEmptyObject(aggrementDate)) {
									processDemandNoteDetails(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo);
								} /* else if(aggrementDate!=null&&TimeUtil.differenceBetweenDays(aggrementDate, finProjDemandNoteInfo.getMilestoneDate())>0 && finProjDemandNoteInfo.getMileStoneNo()!=1) {
									processDemandNoteDetails(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo);//IMP Code	
								}*/ else {
									nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
									continue;
								}
								
								isDemandNoteDataInserted = true;
							}
							try {
								isAnyDemandNoteIsGenerated = true;
								saveBookingFormDemandNoteDetails(finProjDemandNoteInfo,customerPropertyDetailsInfo,bookingFormIds,flatPreviousMilestoneNonPaidData,employeeFinancialDemandNoteInfo);
								bookingFormDemandNoteId.add(finProjDemandNoteInfo.getFinBookingFormDemandNoteId());
							} catch (Exception e) {
								e.printStackTrace();
								if(e.getMessage()!=null && e.getMessage().contains("Milestone due date found empty")) {
									throw new EmployeeFinancialServiceException(e.getMessage());
								} else if(e.getMessage()!=null && e.getMessage().contains("On Flat Gst percentage not found,")) {
									throw new EmployeeFinancialServiceException(e.getMessage());
								}
							}
						}
					}
				}
			}
		} catch (Exception ex) {
 			//ex.printStackTrace();
			log.info(ex.getMessage(),ex);
			//errorMsgs.add(employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests().toString());
			errorMsgs = new ArrayList<String>();
			if(Util.isNotEmptyObject(ex.getMessage())) {
				if(ex.getMessage().contains("already involved in alias")) {
					errorMsgs.add(ex.getMessage());
				} else if(ex.getMessage().contains(" Already demand note generated")) {
					errorMsgs.add(ex.getMessage());
				} else if (ex.getMessage().contains("Flat agreement is not completed")) {
					errorMsgs.add(ex.getMessage());
				} else if(ex.getMessage().contains("Demand note is not generated")) {
					errorMsgs.add(ex.getMessage());
				} else if(ex.getMessage().contains("Milestone due date found empty")) {
					errorMsgs.add(ex.getMessage());
				} else if(ex.getMessage().contains("Scheme details not found")) {
					errorMsgs.add(ex.getMessage());
				} else {
					errorMsgs.add("Error occurred  while saving some records to the database plz try again once !");
				}
			}
			//log.error("Error occurred  while saving the existing customer once again to the database plz try again once -" + ex.toString());
			throw new InSufficeientInputException(errorMsgs);
		}

		final StringBuilder exceptionRaised = new StringBuilder(); 
		if (isThisUploadedData) {
			
		} else if("DoNotSendEmail".equalsIgnoreCase(employeeFinancialDemandNoteInfo.getCondition())) {
			employeeFinancialDemandNoteInfo.setCondition(employeeFinancialDemandNoteInfo.getCondition());
			employeeFinancialDemandNoteInfo.setSendNotification(false);
			//stopping push notification and email to send
		} else if("Final_Demand_Note".equalsIgnoreCase(employeeFinancialDemandNoteInfo.getActionUrl()) && "saveBookingDetails".equalsIgnoreCase(employeeFinancialDemandNoteInfo.getRequestUrl())) {
			employeeFinancialDemandNoteInfo.setSendNotification(false);
			//stopping push notification and email to send
		} else {
			employeeFinancialDemandNoteInfo.setCondition("sendEmails");
		}
		employeeFinancialDemandNoteInfo.setSiteIds(Arrays.asList(new Long[] {employeeFinancialDemandNoteInfo.getSiteId()}));
		if (isThisFlatWiseDnGenerate) {
			employeeFinancialDemandNoteInfo.setFlatIds(new ArrayList<>(flatIdForPdf));
		} else {
			employeeFinancialDemandNoteInfo.setBlockIds(blockIdForPdf);
		}
		if(isAnyDemandNoteIsGenerated==false) {
			log.info("No Demand Note has been generated might be generated already. Please check Flat and Block Details");
			throw new InSufficeientInputException(Arrays.asList("No Demand Note has been generated. Please check Flat and Block Details"));
		}
		
		final List<Object> fileList1 = generateDemandNotePreview(employeeFinancialDemandNoteInfo,generatedMileStones,"GenerateDemandNote"
				,new HashMap<Long, List<FinancialProjectMileStonePojo>>(),flatPreviousMilestoneNonPaidData);
		//log.info("Done Done " +bookingFormDemandNoteId);
		//String s = null;s.trim();
		@SuppressWarnings("unchecked")
		final List<FileInfo> fileList = (List<FileInfo>) fileList1.get(0);
		FinBookingFormDemandNoteDocPojo demandNoteDocPojo = null;
		FinBookingFormDemandNotePojo interestLetterDetailsPojo = null;
		long docCount = 0l;
		log.info("generateDemandNoteService() All bookingFormDemandNoteId " +bookingFormDemandNoteId);
		for (FileInfo fileInfo : fileList) {
			log.info("EmployeeFinancialServiceImpl.generateDemandNoteService() " + fileInfo.getId() + " " + fileInfo);
			try {
				docCount = 0l;
				fileInfo.setCreatedBy(empId.toString());
				demandNoteDocPojo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(fileInfo, FinBookingFormDemandNoteDocPojo.class);
				if (Util.isNotEmptyObject(fileInfo.getId())) {
					demandNoteDocPojo.setFinBookingFormDemandNoteId(Long.valueOf(fileInfo.getId()));
				} else {
					throw new EmployeeFinancialServiceException("Error occurred  while saving data into the database plz try again once.");
				}
				//if this is not regenerate demand note and demand note id found do not save it to the DB
				if (!isReGenerateDemandNote) {
					docCount = employeeFinancialServiceDao.getCountOfDemandNoteDoc(demandNoteDocPojo);
				}
				if (isReGenerateDemandNote) {
					docCount = 0;
				}
				
				if (docCount == 0) {
					employeeFinancialServiceDao.saveFinBookinFormDemandNoteDoc(demandNoteDocPojo);
				}
				/* Updating Fin_Booking_Form_Demand_Note Table for Interest Letter */
				if("Interest_Letter".equalsIgnoreCase(employeeFinancialDemandNoteInfo.getActionUrl())) {
					interestLetterDetailsPojo = new FinBookingFormDemandNotePojo();
					interestLetterDetailsPojo.setFinBookingFormDemandNoteId(Util.isNotEmptyObject(fileInfo.getId())?fileInfo.getId():0l);
					interestLetterDetailsPojo.setInterestAmount(Util.isNotEmptyObject(fileInfo.getTotalPendingPenaltyAmount())?fileInfo.getTotalPendingPenaltyAmount():0d);
					interestLetterDetailsPojo.setDemandNoteType(MetadataId.INTEREST_LETTER.getId());
					interestLetterDetailsPojo.setActionUrl(employeeFinancialDemandNoteInfo.getActionUrl());
					employeeFinancialServiceDao.updateDataIntoFinBookingFormDemandNote(interestLetterDetailsPojo);
				}
			} catch (Exception e) {
				log.info("generateDemandNoteService() All bookingFormDemandNoteId \n" +bookingFormDemandNoteId
						+"\ngenerateDemandNoteService() Issue in bookingFormDemandNoteId " + fileInfo.getId());
				if(isThisUploadedData) {
					exceptionRaised.append(e.getMessage());
				} else {
					throw new EmployeeFinancialServiceException("Error occurred  while saving data into the database plz try again once.");
				}
				e.printStackTrace();
			}
		}
		
		ExecutorService executorService = Executors.newFixedThreadPool(10);
		try {
			executorService.execute(new Runnable() {
				public void run() {
					if (Util.isNotEmptyObject(projectMileStoneIds)) {
						double balanceAmount = 0.0;
						long paymentStatus = 0;

						Long[] bookingIds = flatPreviousMilestoneNonPaidData.keySet().toArray(new Long[] {});
						List<Map<String, Object>> accountDetailList = employeeFinancialServiceDao.getMilstonePaidOrNotPaidDetails(projectMileStoneIds,bookingIds);
						for (Map<String, Object> accountDetails : accountDetailList) {
							balanceAmount = 0.0;
							paymentStatus = 0;
							if (Util.isNotEmptyObject(accountDetails)) {
								if (Util.isNotEmptyObject(accountDetails.get("BALANCE_AMOUNT"))) {
									balanceAmount = accountDetails.get("BALANCE_AMOUNT")==null?0d:Double.valueOf(accountDetails.get("BALANCE_AMOUNT").toString());
									paymentStatus = accountDetails.get("PAYMENT_STATUS")==null?0l:Long.valueOf(accountDetails.get("PAYMENT_STATUS").toString());
									if (balanceAmount == 0 && paymentStatus == Status.INPROGRESS.getStatus()) {
										employeeFinancialServiceDao.updateMilstonePaidOrNotPaidStatus(accountDetails);
									}
								}
							}
						}//projectMileStoneIds for loop completed
					}//projectMileStoneIds if loop completed
				}
			});
			executorService.shutdown();
		} catch (Exception e) {
			e.printStackTrace();
			executorService.shutdown();
		}

		if(exceptionRaised.length()!=0) {
			throw new EmployeeFinancialServiceException("Error occurred  while saving the existing customer once again to the database plz try again once."); 
		}

		return employeeFinancialResponse;
	}
	
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public EmployeeFinancialResponse editDemandNoteDetails(EmployeeFinancialServiceInfo serviceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.updateDemandNoteDetails() *****");
		EmployeeFinancialResponse employeeFinancialResponse = new EmployeeFinancialResponse();
		List<FinMSChangedDtlsPojo> listOfChangedDetails  = new ArrayList<>();
		serviceInfo.setReGenerateDemandNote(false);
		//final Long empId = Util.isEmptyObject(serviceInfo.getEmpId())?0l:serviceInfo.getEmpId();
		//final boolean isReGenerateDemandNote =  serviceInfo.isReGenerateDemandNote();
		//final boolean isThisUpdateDemandNote = serviceInfo.isThisUpdateDemandNote();
		int result = 0;
		FinBookingFormAccountsPojo bookingFormAccountsPojo = null;
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(serviceInfo);
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		List<Long> processedBookingFormIds = new ArrayList<>();
		serviceInfo.setCustomerPropertyDetailsPojoList(customerPropertyDetailsPojoList);
		for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList) {
			if(Util.isNotEmptyObject(customerPropertyDetailsPojo) && Util.isNotEmptyObject(customerPropertyDetailsPojo.getFlatBookingId())
					&& Util.isNotEmptyObject(customerPropertyDetailsPojo.getPancard())) {
				 customerPropertyDetailsInfo = financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
				 customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
				 processedBookingFormIds.add(customerPropertyDetailsInfo.getFlatBookingId());
				for (FinancialProjectMileStoneInfo finProjDemandNoteInfoMain : serviceInfo.getFinancialProjectMileStoneRequests()) {
					 finProjDemandNoteInfoMain.setReGenerateDemandNote(serviceInfo.isReGenerateDemandNote());
					 //Data from front end to edit milestone 
					 FinancialProjectMileStoneInfo finProjDemandNoteInfo = (FinancialProjectMileStoneInfo) finProjDemandNoteInfoMain.clone();
					 finProjDemandNoteInfo.setCondition("EditDemandNote");
					 List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount = null;
					 finProjDemandNoteInfo.setInterestCalculationFrom("EditDemandNote");
					 finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.PENDING.getStatus() ,Status.PAID.getStatus(), Status.INPROGRESS.getStatus()}));	
					 finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()}));
					 if(finProjDemandNoteInfo.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
						 continue;
					 }
					 listOfPendingMileStoneAmount = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
					 
					 if (listOfPendingMileStoneAmount.isEmpty()) {
						 throw new EmployeeFinancialServiceException("Milestone record not found for "+finProjDemandNoteInfo.getMilestoneName()+", couldn't proceed edit milestone details.");
					 } else if(listOfPendingMileStoneAmount.size()>1) {
						 throw new EmployeeFinancialServiceException("Got multiple milestone record for "+finProjDemandNoteInfo.getMilestoneName()+", couldn't proceed edit milestone details.");
					 }
					 //data from DB
					 FinancialProjectMileStonePojo mileStonePojo = listOfPendingMileStoneAmount.get(0);
					 
					 if(finProjDemandNoteInfo.getDemandNoteDate()==null || mileStonePojo.getDemandNoteDate() == null) {
						 throw new EmployeeFinancialServiceException("Demand note date got empty, Could't proceed edit milestone details.");
					 } else if(finProjDemandNoteInfo.getMileStoneDueDate()==null ) {
						 throw new EmployeeFinancialServiceException("Demand note due date got empty, Could't proceed edit milestone details.");
					 }
					 
					 bookingFormAccountsPojo = new FinBookingFormAccountsPojo();
					 bookingFormAccountsPojo = financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinBookingFormAccountsPojo.class);
					 //inactivating penalty record using milestone accounts id, and updating Pay amount and balance amount in FIN-booking_form_account tables based on type
					 result = inActivePenaltyRecordEditMilestone(bookingFormAccountsPojo);
					 
					 //Long finBookingFormAccountsId = mileStonePojo.getFinBookingFormAccountsId();
					 //Long finBookingFormMilestonesId = mileStonePojo.getFinBookingFormMilestonesId();
					 financialMapper.constructMilestoneChangedDetailsPojo(finProjDemandNoteInfo,mileStonePojo,serviceInfo,listOfChangedDetails);
					 
					 result = employeeFinancialServiceDao.saveMilestoneChangedDetails(listOfChangedDetails);
					 
					 FinBookingFormMilestonesPojo editMilestonesPojo =  financialMapper.constructEdit_Milestone_DetailsPojo(finProjDemandNoteInfo,mileStonePojo);
					 result =  employeeFinancialServiceDao.editFinBookingForm_Milestones_Details(editMilestonesPojo);
					 if (result != 1) {
						throw new EmployeeFinancialServiceException("Failed to update record for Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" and  Mile Stone Name : "+finProjDemandNoteInfo.getMilestoneName());
					 }//updating milestone details
					 
					 //==============
					 
					 FinBookingFormAccountsPojo editAccountsPojo =  financialMapper.constructEdit_Accounts_DetailsPojo(finProjDemandNoteInfo,mileStonePojo);
					 result = employeeFinancialServiceDao.editFinBookingForm_Accounts_Details(editAccountsPojo);
				 	 if (result != 1) {
						throw new EmployeeFinancialServiceException("Failed to update record for Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" and  Mile Stone Name : "+finProjDemandNoteInfo.getMilestoneName());
					 }//updating accounts details
					
				 	double totalInterestAmount=0.0;
					finProjDemandNoteInfo.setCondition("GenerateDemandNote");
					//List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount = null;
					finProjDemandNoteInfo.setInterestCalculationFrom("Demand Note");
					finProjDemandNoteInfo.setInterestCalculationUptoDate(TimeUtil.removeOneDay(new Timestamp(new Date().getTime())));
					
					if (true) {
						//calculating interest amount
						listOfPendingMileStoneAmount = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
						processPenaltyAmount(listOfPendingMileStoneAmount,finProjDemandNoteInfo,totalInterestAmount,"insertInterestData","",new HashMap<String,Object>());
					}
				 	 
				}
			}
		}
		
		FinBookingFormAccountsInfo bookingFormAccountsInfo  = new FinBookingFormAccountsInfo();
		bookingFormAccountsInfo.setType(MetadataId.FIN_PENALTY.getId());
		bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.FIN_PENALTY.getId()));
		bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
		bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
		bookingFormAccountsInfo.setCreatedBy(serviceInfo.getEmpId());
		
		//checking any excess amount found for interest records
		putExtraAdjustedAmountInExcessAmount(processedBookingFormIds,bookingFormAccountsInfo);
		
		validatePenaltyCalcultionCompleted(serviceInfo);
		return employeeFinancialResponse;
	}

	/**
	 * Used this method for Edit Milestone details, and also for validating the interest calculation completed
	 * @param processedBookingFormIds
	 * @param bookingFormAccountsInfo
	 * @throws Exception
	 */
	private void putExtraAdjustedAmountInExcessAmount(List<Long> processedBookingFormIds, FinBookingFormAccountsInfo bookingFormAccountsInfo) throws Exception {
		//imp code
		List<FinBookingFormAccountsStatementPojo> accountsStatementPojos = null;
		EmployeeFinancialTransactionServiceInfo transactionServiceInfo = new EmployeeFinancialTransactionServiceInfo(); 
		transactionServiceInfo.setCreatedBy(bookingFormAccountsInfo.getCreatedBy());
		int result = 0;
		if(Util.isNotEmptyObject(processedBookingFormIds)) {
			List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = employeeFinancialServiceDao.getAccountsExcessAmountDetailsIfAny(bookingFormAccountsInfo,processedBookingFormIds);
			for (FinBookingFormAccountsPojo bookingFormAccountsPojo : bookingFormAccountsPojoLists) {
				double payAmount = bookingFormAccountsPojo.getPayAmount();
				double paidAmount = bookingFormAccountsPojo.getPaidAmount();
				double excessAmount = roundOffAmount(paidAmount-payAmount);
				String finBokAccInvoiceNo = bookingFormAccountsPojo.getFinBokAccInvoiceNo();
				if(paidAmount>payAmount) {
					accountsStatementPojos = employeeFinancialServiceDao.getBookingFormAccountsStatementAndReceiptData(bookingFormAccountsPojo, FinEnum.DESC);
					if(Util.isNotEmptyObject(accountsStatementPojos)) {
						FinBookingFormAccountsStatementPojo statementPojo = accountsStatementPojos.get(accountsStatementPojos.size()-1);
						
						//passing excess amount to excess amount tables
						constructExcessAmountPojos(excessAmount,bookingFormAccountsInfo.getType(),statementPojo.getFinBookingFormReceiptsId(),transactionServiceInfo,finBokAccInvoiceNo);
						
						//decreasing excess amount from penalty records
						FinBookingFormAccountsPojo finBookingFormAccountsPojo = (FinBookingFormAccountsPojo) bookingFormAccountsPojo.clone();
						finBookingFormAccountsPojo.setPaidAmount(excessAmount);
						finBookingFormAccountsPojo.setBalanceAmount(0d);
						finBookingFormAccountsPojo.setCreatedBy(bookingFormAccountsInfo.getCreatedBy());
						//employeeFinancialServiceDao.updateBookingFormAccountPaidAmount(finBookingFormAccountsPojo);
						employeeFinancialServiceDao.updateBookingFormAccountOnlyPaidAmount(finBookingFormAccountsPojo);
						
						double amoutDecreseInStatement = excessAmount;
						double statementAmountToRefund = 0d;
						//accountsStatementPojos = employeeFinancialServiceDao.getBookingFormAccountsStatementAndReceiptData(bookingFormAccountsPojo, FinEnum.DESC);
						for (FinBookingFormAccountsStatementPojo accStatementPojo : accountsStatementPojos) {
							double stmtPaidAmount = accStatementPojo.getStatementPaidAmount() == null ? 0d : accStatementPojo.getStatementPaidAmount();
							if (amoutDecreseInStatement > 0) {
								if (stmtPaidAmount > 0) {
									if (amoutDecreseInStatement >= stmtPaidAmount) {
										amoutDecreseInStatement = amoutDecreseInStatement - stmtPaidAmount;
										statementAmountToRefund = stmtPaidAmount;
									} else {
										statementAmountToRefund = amoutDecreseInStatement;
										amoutDecreseInStatement = amoutDecreseInStatement - stmtPaidAmount;
									}
							
									FinBookingFormAccountsStatementPojo accStmtPojo = new FinBookingFormAccountsStatementPojo(); 
									accStmtPojo.setStatementRefundAmount(statementAmountToRefund);
									accStmtPojo.setFinBookingFormAccountsId(finBookingFormAccountsPojo.getFinBookingFormAccountsId());
									accStmtPojo.setBookingFormId(finBookingFormAccountsPojo.getBookingFormId());
									accStmtPojo.setStatusId(Status.ACTIVE.getStatus());
									accStmtPojo.setModifiedBy(transactionServiceInfo.getEmployeeId());
									accStmtPojo.setFinBookingFormAccountsStatementId(accStatementPojo.getFinBookingFormAccountsStatementId());
									result = employeeFinancialServiceDao.decreaseBookingFormAccountStatementPaidAmount(accStmtPojo,"DecreasePaidAmount");
									if(result!=1) {}
								}//stmtPaidAmount condition
							}//amoutDecreseInStatement condition processAdjustedAccountsExcessAmount
						}
						
						
					}
				}
			}
		}	
	}

	@Override
	public List<FinancialProjectMileStonePojo> isMileStoneInitiatedForThisFlatBookingFormId(FinancialProjectMileStoneInfo financialProjectMileStoneInfo,
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo,FinProjDemNoteStatisticsPojo finProjDemNoteStatisticsPojo) {
		return employeeFinancialServiceDao.isMileStoneInitiatedForThisFlatBookingFormId(financialProjectMileStoneInfo,customerPropertyDetailsInfo, new FinProjDemNoteStatisticsPojo());
	}
	
	@Override
	public FinancialProjectMileStonePojo checkMilestoneGeneratedForFlat(List<FinancialProjectMileStonePojo> projectMileStonePojoList,
			FinancialProjectMileStoneInfo finProjDemandNoteInfo) {
		FinancialProjectMileStonePojo milestone = null;//if the record found means milestone is generated
		for (FinancialProjectMileStonePojo mileStonePojo : projectMileStonePojoList) {
			if(mileStonePojo.getType()!=null && mileStonePojo.getType().equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()) && mileStonePojo.getProjectMilestoneId()!=null && mileStonePojo.getProjectMilestoneId().equals(finProjDemandNoteInfo.getProjectMilestoneId())) {
				return mileStonePojo;
			}
		}
		return milestone;
	}

	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public EmployeeFinancialResponse uploadDemandNoteMilestones(EmployeeFinancialServiceInfo financialServiceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.uploadDemandNoteMilestones() *****");
		List<Object> listOfDemandNoteAndTRNdata = new ArrayList<Object>();
		Map<String,CustomerPropertyDetailsInfo> customersList = new HashMap<>();
		Map<String,FinancialDemandNoteMS_TRN_Info> customersDetailsListForPDF = new HashMap<>();
		Map<String,List<FinancialProjectMileStonePojo>> loadedMilestoneListList = new HashMap<>();
		Map<String,List<FinSchemeTaxMappingPojo>> loadedSchemeTaxMappingList = new HashMap<>();
		Map<String,List<FinSchemePojo>> loadedSchemeList = new HashMap<>();
		Map<String,List<FinTaxPojo>> loadedTaxList = new HashMap<>();
		Map<String,List<FinBankPojo>> loadedBankList = new HashMap<>();
		Map<String,Long> loadedSiteAccountNumberList = new HashMap<>();
		Map<Double,Long> percentageList = new HashMap<>();
		List<String> holdOnlineReferenceNumber = new ArrayList<>();
		List<String> holdDuplicateOnlineReferenceNumber = new ArrayList<>();
		List<String> holdDuplicateChequeNumber = new ArrayList<>();
		//List<String> holdFlatDetailsNotFoundIssue = new ArrayList<>();
		List<Long> holdLegalCostInsertedFlats = new ArrayList<>();
		boolean isDataUploaded = false;
		String blockAndSiteName = "";
		//List<String> siteAndBlock = new ArrayList<>();
		//inserting scheme details
		if (Util.isNotEmptyObject(financialServiceInfo.getFinancialSchemeRequests())) {//not in use
			loadFinancialSchemeIds(financialServiceInfo,loadedSchemeList,loadedTaxList,percentageList,customersList);
			
			for(FinancialSchemeInfo schemeDetails : financialServiceInfo.getFinancialSchemeRequests()) {
				if(schemeDetails.getRecordType()==null || !schemeDetails.getRecordType().trim().equals("SCHEME")) {
					//log.info("schemeDetails.getRecordType() continue statement : " +schemeDetails.getRecordType());
					continue;
				}
				//siteAndBlock.add(schemeDetails.getSiteId()+""+schemeDetails.getBlockName());
				String blockandsite = schemeDetails.getSiteName();
				if(blockAndSiteName == "") {
					blockAndSiteName = blockandsite;
				} else if (blockAndSiteName!=blockandsite) {
					throw new EmployeeFinancialServiceException("Please give same site data");
				}
				
				List<FinSchemeTaxMappingPojo> siteSchemeDetailsList = null;
				String key = schemeDetails.getSiteId()+""+schemeDetails.getStartDate()+""+schemeDetails.getEndDate()+""+schemeDetails.getPercentageValue()+""+schemeDetails.getFinSchemeId()+""+schemeDetails.getFinTaxId();
				if(loadedSchemeTaxMappingList.containsKey(key)) {
					siteSchemeDetailsList = loadedSchemeTaxMappingList.get(key); 
				} else {
					siteSchemeDetailsList = employeeFinancialServiceDao.checkSchemeDetails(schemeDetails);
				}
				if (Util.isNotEmptyObject(siteSchemeDetailsList)) {
					FinSchemeTaxMappingPojo schemeTaxMappingPojo = siteSchemeDetailsList.get(0);
					schemeDetails.setFinSchemeTaxMappingId(schemeTaxMappingPojo.getFinSchemeTaxMappingId());
					if(!loadedSchemeTaxMappingList.containsKey(key)) {
						loadedSchemeTaxMappingList.put(key, siteSchemeDetailsList);
					}
				} else {
					FinSchemeTaxMappingPojo finSchemePojo = financialMapper.constructFinSchemeTaxMappingPojo(schemeDetails, financialServiceInfo);
					employeeFinancialServiceDao.insertFinSchemeTaxMappingDetails(finSchemePojo);
					schemeDetails.setFinSchemeTaxMappingId(finSchemePojo.getFinSchemeTaxMappingId());
				}
				 
				FlatBookingSchemeMappingPojo flatBookingSchemeMappingPojo = financialMapper.constructFlatBookingSchemeMappingPojo(schemeDetails,financialServiceInfo);
				List<FlatBookingSchemeMappingPojo> flatBookingSchemeMappingPojos = employeeFinancialServiceDao.getFlatBookingSchemeMappingDetails(flatBookingSchemeMappingPojo);
				if(Util.isEmptyObject(flatBookingSchemeMappingPojos)) {
					employeeFinancialServiceDao.insertFlatBookingSchemeMappingDetails(flatBookingSchemeMappingPojo);
				}
			}		
		}
		
		/*if(Util.isNotEmptyObject(financialServiceInfo.getFinancialFlatCostDetailsRequests())) {
			processFlatCostDetails(customersList,financialServiceInfo);
		}*///financialServiceInfo.getFinancialFlatCostDetailsRequests()
		boolean isMsRecordsInRequest = Util.isNotEmptyObject(financialServiceInfo.getDemandNoteMSRequests());
		//inserting demand notes and transaction details
		if (Util.isNotEmptyObject(financialServiceInfo.getDemandNoteMSRequests()) || Util.isNotEmptyObject(financialServiceInfo.getDemandNoteTransactionRequests())) {
			if (Util.isNotEmptyObject(financialServiceInfo.getDemandNoteTransactionRequests())) {
				financialServiceInfo.getDemandNoteMSRequests().addAll(financialServiceInfo.getDemandNoteTransactionRequests());
			}
			
			for (FinancialDemandNoteMS_TRN_Info trn_MilestoneRequest : financialServiceInfo.getDemandNoteMSRequests()) {
				if(!trn_MilestoneRequest.getRecordType().trim().equalsIgnoreCase("MS") && !trn_MilestoneRequest.getRecordType().trim().equalsIgnoreCase("TRANSACTION")) {
					log.info("Currently Processing Data has been continued : "+trn_MilestoneRequest.getRecordType()+" "+trn_MilestoneRequest.getFlatNo());
					continue;
				}
				
				//log.info("Currently Processing Data : "+trn_MilestoneRequest.getRecordType()+" "+trn_MilestoneRequest.getFlatNo());
				//based on site name loading site id
				if (Util.isEmptyObject(trn_MilestoneRequest.getSiteId()) && Util.isNotEmptyObject(trn_MilestoneRequest.getSiteName())) {
					Site site = new Site();
					site.setName(trn_MilestoneRequest.getSiteName());
					if (Util.isNotEmptyObject(financialServiceInfo.getSiteId())) {
						trn_MilestoneRequest.setSiteId(financialServiceInfo.getSiteId());
						financialServiceInfo.setSiteIds(Arrays.asList(financialServiceInfo.getSiteId()));
					} else {
						List<DropDownPojo> sitesLists = employeeFinancialServiceDao.getSiteData(site);
						if (Util.isNotEmptyObject(sitesLists)) {
							trn_MilestoneRequest.setSiteId(sitesLists.get(0).getId());
							financialServiceInfo.setSiteId(sitesLists.get(0).getId());
							financialServiceInfo.setSiteIds(Arrays.asList(sitesLists.get(0).getId()));
						}
					}
				}
				EmployeeFinancialServiceInfo employeeFinancialServiceInfo = (EmployeeFinancialServiceInfo) financialServiceInfo.clone();
				employeeFinancialServiceInfo.setActionUrl("View DemandNotes");
				//loading customer details
				if(Util.isEmptyObject(trn_MilestoneRequest.getFlatId())) {
					employeeFinancialServiceInfo.setFlatNos(Arrays.asList(trn_MilestoneRequest.getFlatNo()));
					if(customersList.containsKey(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo())) {
						CustomerPropertyDetailsInfo customerPropertyDetailsInfo = customersList.get(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo());
						trn_MilestoneRequest.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
						trn_MilestoneRequest.setFlatIds(Arrays.asList(customerPropertyDetailsInfo.getFlatId()));
						trn_MilestoneRequest.setFlatId(customerPropertyDetailsInfo.getFlatId());
						trn_MilestoneRequest.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
						trn_MilestoneRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
						trn_MilestoneRequest.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
						trn_MilestoneRequest.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
						if(customersDetailsListForPDF.containsKey(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo())) {
							FinancialDemandNoteMS_TRN_Info trn_MilestoneInfo = customersDetailsListForPDF.get(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo());
							trn_MilestoneRequest.setCustomerAddressInfoList(trn_MilestoneInfo.getCustomerAddressInfoList());
							trn_MilestoneRequest.setSiteAddressInfoList(trn_MilestoneInfo.getSiteAddressInfoList());
							trn_MilestoneRequest.setFinProjectAccountResponseList(trn_MilestoneInfo.getFinProjectAccountResponseList());
							trn_MilestoneRequest.setOfficeDetailsList(trn_MilestoneInfo.getOfficeDetailsList());
							trn_MilestoneRequest.setFlatsResponse(trn_MilestoneInfo.getFlatsResponse());
						}else {
							loadCustomerDetails(trn_MilestoneRequest,employeeFinancialServiceInfo,customerPropertyDetailsInfo);
							customersDetailsListForPDF.put(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo(), trn_MilestoneRequest);
						}
						continue;
					}
					List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
					if(Util.isNotEmptyObject(customerPropertyDetailsPojoList)) {
						CustomerPropertyDetailsInfo customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
						customersList.put(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo(), customerPropertyDetailsInfo);
						trn_MilestoneRequest.setFlatIds(Arrays.asList(customerPropertyDetailsInfo.getFlatId()));
						trn_MilestoneRequest.setFlatId(customerPropertyDetailsInfo.getFlatId());
						trn_MilestoneRequest.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
						trn_MilestoneRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
						trn_MilestoneRequest.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
						trn_MilestoneRequest.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
						if(customersDetailsListForPDF.containsKey(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo())) {
							FinancialDemandNoteMS_TRN_Info trn_MilestoneInfo = customersDetailsListForPDF.get(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo());
							trn_MilestoneRequest.setCustomerAddressInfoList(trn_MilestoneInfo.getCustomerAddressInfoList());
							trn_MilestoneRequest.setSiteAddressInfoList(trn_MilestoneInfo.getSiteAddressInfoList());
							trn_MilestoneRequest.setFinProjectAccountResponseList(trn_MilestoneInfo.getFinProjectAccountResponseList());
							trn_MilestoneRequest.setOfficeDetailsList(trn_MilestoneInfo.getOfficeDetailsList());
							trn_MilestoneRequest.setFlatsResponse(trn_MilestoneInfo.getFlatsResponse());
						}else {
							loadCustomerDetails(trn_MilestoneRequest,employeeFinancialServiceInfo,customerPropertyDetailsInfo);
							customersDetailsListForPDF.put(trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getFlatNo(), trn_MilestoneRequest);
						}
					} else {
						//holdFlatDetailsNotFoundIssue.add("Flat details not found, In Site "+trn_MilestoneRequest.getSiteName()+" Flat No "+trn_MilestoneRequest.getFlatNo());
						throw new EmployeeFinancialServiceException("Flat details not found, In Site "+trn_MilestoneRequest.getSiteName()+" Flat No "+trn_MilestoneRequest.getFlatNo());
					}
				}//Flat Id condition
			}
			//ResponceCodesUtil responceCodesUtil = new ResponceCodesUtil();
			String acceptReceiptNoFromExcel = responceCodesUtil.getApplicationProperties().getProperty("ACCEPT_RECEIPT_NO_FROM_EXCEL");
			String demandNoteFormat = responceCodesUtil.getApplicationProperties().getProperty("DEMAND_NOTE_FORMAT_FOR_EXCEL");
			employeeFinancialHelper.sortUploadedData(financialServiceInfo);
			Long siteId = 0l;
			//loading all the necessary details of transactions and demand note
			for (FinancialDemandNoteMS_TRN_Info trn_MilestoneRequest : financialServiceInfo.getDemandNoteMSRequests()) {
				log.info("Currently Processing Data DN Date : "+trn_MilestoneRequest.getRecordType()+"\t"+trn_MilestoneRequest.getSalesFrTransactionReceiptNo()+"\t"+trn_MilestoneRequest.getDemandNoteDate()+" "+trn_MilestoneRequest.getFlatNo());
				//String block and site = trn_MilestoneRequest.getSiteName()+" "+trn_MilestoneRequest.getBlockName();
				String blockandsite = trn_MilestoneRequest.getSiteName();
				if(blockAndSiteName == "") {
					blockAndSiteName = blockandsite;
				} else if (!blockAndSiteName.equals(blockandsite)) {
					if(financialServiceInfo.getRequestUrl()!=null && !financialServiceInfo.getRequestUrl().equals("uploadTDS")) {
						if(isMsRecordsInRequest) {//if milestone records found in request then only throw the exception
							throw new EmployeeFinancialServiceException("Please provide same site and same block data in excel sheet, need "+blockAndSiteName +", got "+blockandsite);
						}
					}
				}
				
				if(trn_MilestoneRequest.getRecordType().trim().equalsIgnoreCase("MS")) {
					EmployeeFinancialServiceInfo employeeFinancialDemandNoteInfo = 
							financialMapper.copyFinancialDemandNoteMS_TRN_InfoToEmployeeFinancialServiceInfo(financialServiceInfo,trn_MilestoneRequest, EmployeeFinancialTransactionServiceInfo.class);
					//loading all the necessary details of demand note milestone
					loadMilestoneRecordDataIds(financialServiceInfo,trn_MilestoneRequest,employeeFinancialDemandNoteInfo,loadedMilestoneListList);
					listOfDemandNoteAndTRNdata.add(employeeFinancialDemandNoteInfo);
					if(siteId==null || siteId==0)
						siteId = trn_MilestoneRequest.getSiteId();
				} else if(trn_MilestoneRequest.getRecordType().trim().equalsIgnoreCase("TRANSACTION")) {
					//employeeFinancialHelper.validateUploadedTransactionData(trn_MilestoneRequest);
					/*if(Util.isEmptyObject(trn_MilestoneRequest.getSalesFrTransactionReceiptNo())) {
						throw new EmployeeFinancialServiceException("Transaction Receipt No found empty");
					}*/
					
					if(Util.isEmptyObject(trn_MilestoneRequest.getSalesFrTransactionReceiptNo())) {
						throw new EmployeeFinancialServiceException("Transaction Receipt No found empty");
					}
					String excelRecordNo = trn_MilestoneRequest.getSalesFrTransactionReceiptNo();
					
					if((excelRecordNo.contains("SIPL/")||excelRecordNo.contains("SHL/")) 
							&& excelRecordNo.contains("/") && excelRecordNo.contains("-") && acceptReceiptNoFromExcel.equals("yes")) {
						// && (excelRecordNo.contains("2017") || excelRecordNo.contains("2018") || excelRecordNo.contains("2019") ||  excelRecordNo.contains("2020")  ||  excelRecordNo.contains("2021"))
						//return excelRecordNo;	//please add year based on need
					} else if(acceptReceiptNoFromExcel.equals("yes")){
						log.info(" Error in  TransactionReceiptNo : "+trn_MilestoneRequest.getSalesFrTransactionReceiptNo()+", flat id :"+trn_MilestoneRequest.getFlatIds()+", flat no : "+trn_MilestoneRequest.getFlatNo());
						throw new EmployeeFinancialServiceException("Transaction Receipt No Format is wrong");
					}
					
					//log.info("Currently Processing Data TransactionReceiptNo : "+trn_MilestoneRequest.getTransactionReceiptNo()+" "+trn_MilestoneRequest.getFlatNo());
					EmployeeFinancialTransactionServiceInfo transactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) 
							financialMapper.copyFinancialDemandNoteMS_TRN_InfoToEmployeeFinancialTransactionServiceInfo(financialServiceInfo,trn_MilestoneRequest, EmployeeFinancialTransactionServiceInfo.class);
						//loading all the necessary details of transactions
					loadTransactionRecordDataIds(financialServiceInfo,trn_MilestoneRequest,transactionServiceInfo,loadedBankList,loadedSiteAccountNumberList);
					listOfDemandNoteAndTRNdata.add(transactionServiceInfo);
					if(siteId==null || siteId==0) {
						siteId = trn_MilestoneRequest.getSiteId();
					}
					if(transactionServiceInfo.getTransactionModeName()!=null 
							&& transactionServiceInfo.getTransactionModeName().equals(MetadataId.ONLINE.getName())) {
						
						if(Util.isEmptyObject(transactionServiceInfo.getReferenceNo())) {
							log.info(" Reference number should not be empty \n Currently Processing Data TransactionReceiptNo : "+trn_MilestoneRequest.getSalesFrTransactionReceiptNo()+" "+trn_MilestoneRequest.getFlatIds());
							throw new EmployeeFinancialServiceException(" Reference number should not be empty");
						}
						
						/*if(Util.isNotEmptyObject(holdOnlineReferenceNumber)) {
							List<Map<String, Object>> listOfAnonymousEntryList = employeeFinancialServiceDao.isReferenceNoIsExistForUploadData(holdOnlineReferenceNumber);
							if(Util.isNotEmptyObject(listOfAnonymousEntryList)) {
								throw new EmployeeFinancialServiceException("Found duplicate online reference number, Please change the refrence numbers "+listOfAnonymousEntryList);
							}
						}*/
						
						if(holdOnlineReferenceNumber.contains(transactionServiceInfo.getReferenceNo())) {
							holdDuplicateOnlineReferenceNumber.add(transactionServiceInfo.getReferenceNo());
							//throw new EmployeeFinancialServiceException("Found duplicate online reference number which is already exists in records. Please change the refrence number : "+transactionServiceInfo.getReferenceNo());
						}
						holdOnlineReferenceNumber.add(transactionServiceInfo.getReferenceNo());
					} else {
						String findDuplicateChequeNumber = transactionServiceInfo.getFlatNos().get(0)+""+transactionServiceInfo.getChequeNumber()+""+transactionServiceInfo.getTransactionAmount()+""+transactionServiceInfo.getTransactionDate();
						if(holdDuplicateChequeNumber.contains(findDuplicateChequeNumber)) {
							throw new EmployeeFinancialServiceException("Found duplicate cheque number with the same cheque date and amount for "+ transactionServiceInfo.getFlatNos().get(0)+","+transactionServiceInfo.getChequeNumber());
						}
						if(!transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("waived off")) {	//reciept chequ module
							holdDuplicateChequeNumber.add(findDuplicateChequeNumber);
						}
						
					}
					
					if (transactionServiceInfo.getTransactionFor() != null && transactionServiceInfo.getTransactionFor().equals("Legal Charges")) {

						if (holdLegalCostInsertedFlats.contains(transactionServiceInfo.getBookingFormId())) {
							log.info("Got Multiple payments for legal amount"+trn_MilestoneRequest.getSalesFrTransactionReceiptNo()+" "+trn_MilestoneRequest.getFlatNo());
							//throw new EmployeeFinancialServiceException("Got Multiple payments for legal amount "+transactionServiceInfo.getFlatNos().get(0));
						} else {
							holdLegalCostInsertedFlats.add(transactionServiceInfo.getBookingFormId());
						}
					}
				}/*  else if(trn_MilestoneRequest.getRecordType().equalsIgnoreCase("TRANSACTION_LEGAL")) {
					
				}*/
			}
		
			if(Util.isNotEmptyObject(holdDuplicateOnlineReferenceNumber)) {//checking in excel
				throw new EmployeeFinancialServiceException("Found duplicate online reference number, "+holdDuplicateOnlineReferenceNumber);
			}
			
			if(Util.isNotEmptyObject(holdOnlineReferenceNumber)) {//checking form DB
				List<Map<String, Object>> listOfAnonymousEntryList = employeeFinancialServiceDao.isReferenceNoIsExistForUploadData(holdOnlineReferenceNumber,siteId);
				if(Util.isNotEmptyObject(listOfAnonymousEntryList)) {
					throw new EmployeeFinancialServiceException("Found duplicate online reference number, "+listOfAnonymousEntryList);
				}
			}
			List<EmployeeFinancialTransactionServiceInfo> holdTrnForAttachment = new ArrayList<>();
			//Map<Long, List<FinancialProjectMileStonePojo>> customerGeneratedMilestone = new HashMap<Long, List<FinancialProjectMileStonePojo>>();
			//saving the records
			for (Object object : listOfDemandNoteAndTRNdata) {
				if(object==null) {
					log.info("Error occurred  while saving the demand note and transaction record to the database plz try again once");
					throw new EmployeeFinancialServiceException("Error occurred while saving the demand note and transaction record to the database plz try again once");
				}
				if(object instanceof EmployeeFinancialServiceInfo) {
					EmployeeFinancialServiceInfo demandNoteInfo = (EmployeeFinancialServiceInfo) object;
					log.info("Currently Processing Data DN Date : "+demandNoteInfo.getDemandNoteDate()+" "+demandNoteInfo.getFlatIds()+" "+demandNoteInfo.getFlatNos());
					if(demandNoteInfo.getTypeOfDemandNoteFormat()!=null) {
						demandNoteInfo.setActionUrl(demandNoteInfo.getTypeOfDemandNoteFormat());
					} else if(demandNoteFormat!=null && demandNoteFormat.equals("First_Disbursement_Demandnote")) {
						demandNoteInfo.setActionUrl("First_Disbursement_Demandnote");
					} else if(demandNoteFormat!=null && demandNoteFormat.equals("Milestone_Completion_Demandnote")) {
						demandNoteInfo.setActionUrl("Milestone_Completion_Demandnote");
					} 
					/*CustomerPropertyDetailsInfo info = demandNoteInfo.getCustomerPropertyDetailsInfo();
					List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList1 = null;
					if(customerGeneratedMilestone.containsKey(info.getFlatBookingId())) {
						financialProjectMileStonePojoList1 = customerGeneratedMilestone.get(info.getFlatBookingId());
					} else {
						financialProjectMileStonePojoList1 = employeeFinancialServiceDao.isMileStoneInitiatedForThisFlatBookingFormId(new FinancialProjectMileStoneInfo(),info, new FinProjDemNoteStatisticsPojo());
						customerGeneratedMilestone.put(info.getFlatBookingId(), financialProjectMileStonePojoList1);
					}*/

					generateDemandNoteService(demandNoteInfo);
					isDataUploaded = true;
				} else if(object instanceof EmployeeFinancialTransactionServiceInfo) {
					EmployeeFinancialTransactionServiceInfo transactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) object;
					log.info(transactionServiceInfo.getTransactionEntryId()+" Currently Processing Data "+transactionServiceInfo.getTransactionReceiptNo()+" "+transactionServiceInfo.getFlatIds()+" "+transactionServiceInfo.getFlatNos());
					
					List<Map<String, Object>> data = employeeFinancialServiceDao.getTransactionDataByReceiptNo(transactionServiceInfo,Arrays.asList(Status.INACTIVE.getStatus(),Status.ACTIVE.getStatus()));
					List<FinTransactionApprStatPojo> finTransactionApprStatPojoList = null;
					if (Util.isNotEmptyObject(data)) {//loading old transaction id using receipt no
						int index = data.size()-1;
						String TransactionEntryId = data.get(index).get("FIN_TRANSACTION_ENTRY_ID").toString();
						String sourceOfFunds = data.get(index).get("SOURCE_OF_FUNDS")==null?null:data.get(index).get("SOURCE_OF_FUNDS").toString();
						if (transactionServiceInfo.getSourceOfFunds() == null) {
							transactionServiceInfo.setSourceOfFunds(sourceOfFunds);
						}
						//if this transaction receipt no is present in DB, then taking his transaction id and inserting as previous transaction id
						transactionServiceInfo.setPrevTransactionEntryId(Long.valueOf(TransactionEntryId));
						transactionServiceInfo.setTransactionEntryId(Long.valueOf(TransactionEntryId));
						transactionServiceInfo.setPrevTransactionSetOffEntryId(Long.valueOf(data.get(index).get("FIN_TRN_SET_OFF_ENT_ID").toString()));
						log.info(transactionServiceInfo.getTransactionClosedDate() +" "+data.get(index).get("TRANSACTION_CLOSED_DATE"));
						finTransactionApprStatPojoList = employeeFinancialServiceDao.getFinTransactionApprStatData(transactionServiceInfo);
						transactionServiceInfo.setTransactionEntryId(null);
					}
					
					if(!transactionServiceInfo.getTransactionTypeName().equals(FinTransactionType.PAYMENT.getName())) {
						if(transactionServiceInfo.getTransactionModeName().equals(MetadataId.ONLINE.getName())) {
							//transactionServiceInfo.getTransactionTypeName().equals("Receipt") && 
							doOnlinePaymentAnonymousEntry(financialMapper.constructAnonymouesEntryInfo(transactionServiceInfo));
						}
					}
					if(transactionServiceInfo.getTransactionFor()!=null && transactionServiceInfo.getTransactionFor().equals("Legal Charges")) {
			
						FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
						if (Util.isNotEmptyObject(transactionServiceInfo.getSiteIds())) {
							finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
						} else if (Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
							finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
						}
						List<FinPenaltyTaxPojo> finPenaltyTaxPojoList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.LEGAL_COST.getId()));
						if (Util.isNotEmptyObject(finPenaltyTaxPojoList)) {
							double percentageValue = 0d;
							percentageValue = finPenaltyTaxPojoList.get(0).getPercentageValue();
							transactionServiceInfo.setFinTaxMappingId(finPenaltyTaxPojoList.get(0).getFinTaxMappingId());
							transactionServiceInfo.setPercentageValue(percentageValue);
							
							double gstAmount = ((percentageValue/(percentageValue+100))*(transactionServiceInfo.getTransactionAmount()));
							 
							List<FinBookingFormLegalCostInfo> finBookingFormLegalCostList = new ArrayList<>();
							FinBookingFormLegalCostInfo bookingFormLegalCostRequest = new FinBookingFormLegalCostInfo(); 
							bookingFormLegalCostRequest.setLegalAmount(transactionServiceInfo.getTransactionAmount()-gstAmount);
							bookingFormLegalCostRequest.setTaxAmount(gstAmount);
							bookingFormLegalCostRequest.setTotalAmount(transactionServiceInfo.getTransactionAmount());
							
							List<FinBookingFormLglCostDtlsInfo> finBookingFormLglCostDtlsList = new ArrayList<>();
							FinBookingFormLglCostDtlsInfo bookingFormLglCostDtlsRequest = new FinBookingFormLglCostDtlsInfo();
							bookingFormLglCostDtlsRequest.setLegalAmount(transactionServiceInfo.getTransactionAmount()-gstAmount);
							bookingFormLglCostDtlsRequest.setDescription("Flat Legal and Documentation charges");
							finBookingFormLglCostDtlsList.add(bookingFormLglCostDtlsRequest);
							
							bookingFormLegalCostRequest.setFinBookingFormLglCostDtlsList(finBookingFormLglCostDtlsList);
							finBookingFormLegalCostList.add(bookingFormLegalCostRequest);
							transactionServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
							transactionServiceInfo.setFinBookingFormLegalCostList(finBookingFormLegalCostList);
							
							saveLegalCharges(transactionServiceInfo);
							List<EmployeeFinTranPaymentSetOffInfo> paymentSetOffInfos = transactionServiceInfo.getPaymentSetOffDetails();
							for (EmployeeFinTranPaymentSetOffInfo paymentSetOffDetails : paymentSetOffInfos) {
								if(Util.isEmptyObject(paymentSetOffDetails.getAmount()) || Util.isEmptyObject(paymentSetOffDetails.getSetOffTypeName())) {
									continue;
								}
								
								if (getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.LEGAL_COST.getId()) && Util.isEmptyObject(paymentSetOffDetails.getInvoiceNo())) {
									//throw new EmployeeFinancialServiceException("Please select invoice number for Legal Charges.");
									 paymentSetOffDetails.setInvoiceNo(transactionServiceInfo.getFinBokAccInvoiceNo());
								}
							}
						} else {
							log.info("Penalty Tax Pojo is empty...");
							throw new EmployeeFinancialServiceException("Please update Legal Charges GST.");
						}
					}
					
					//transactionServiceInfo.setInsertOldApprToNewTrn(true);
					
					saveFinancialTransactionRequest(transactionServiceInfo);
					
					if(Util.isNotEmptyObject(finTransactionApprStatPojoList)) {
						for (FinTransactionApprStatPojo apprStatPojo : finTransactionApprStatPojoList) {
							apprStatPojo.setTransactionSetOffEntryId(transactionServiceInfo.getTransactionSetOffEntryId());
							apprStatPojo.setComment(apprStatPojo.getComments());
							employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,null);
							//employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
						}
					}
					
					//inserting old transaction approve reject details
					//employeeFinancialServiceDao.copyTransactionSetOffApprovaldetailsFrmUpload(transactionServiceInfo);
					
					holdTrnForAttachment.add(transactionServiceInfo);
					isDataUploaded = true;
				} else {
					log.info("Error occurred while saving the demand note and transaction record to the database plz try again once");
					throw new EmployeeFinancialServiceException("Error occurred while saving the demand note and transaction record to the database plz try again once");
				}
			}//listOfDemandNoteAndTRNdata
			
			if(!isDataUploaded) {
				throw new EmployeeFinancialServiceException("No data found to upload");
			}
		}	

		return null;
	}
	
	@Override
	public List<Object> uploadFinancialTransaction(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.uploadFinancialTransaction() *****");
		List<Object> listOfResp = new ArrayList<>();
		//List<OfficeDtlsPojo> officeDetailsPojoList = null;
		List<OfficeDtlsResponse> officeDetailsList = null;
		EmployeeFinancialServiceInfo serviceInfo = null;
		List<SitePojo> siteList = null;
		Map<String,List<OfficeDtlsResponse>> officeDetailsMap = new HashMap<>();
		Map<String,List<SitePojo>> siteDetailsMap = new HashMap<>();
		List<FinancialUploadDataInfo> financialUploadDataRequests = employeeFinancialServiceInfo.getFinancialUploadDataRequests();
		Properties prop = responceCodesUtil.getApplicationProperties();
		String condition = prop.getProperty("CUSTOMER_APP_SITE_NAME");

		for (FinancialUploadDataInfo financialUploadDataInfo : financialUploadDataRequests) {
			
			if(siteDetailsMap.containsKey(financialUploadDataInfo.getSiteName())) {
				officeDetailsList = officeDetailsMap.get(financialUploadDataInfo.getSiteName());
				siteList = siteDetailsMap.get(financialUploadDataInfo.getSiteName());
				
				SitePojo sitePojo = siteList.get(0);
				financialUploadDataInfo.setSiteId(sitePojo.getSiteId());
			} else {
				Site site = new Site();
				site.setName(financialUploadDataInfo.getSiteName());
				//System.out.println(condition);
				if(condition!=null && condition.equals("PORTAL_SITE_NAME")) {
					site.setReferMessage(condition);
				} else {
					site.setReferMessage(condition);
				}
				siteList = employeeFinancialServiceDao.getSiteDetails(site);
				
				if(Util.isEmptyObject(siteList)) {
					log.info("Error occurred while loading site details record from the database plz try again once");
					throw new EmployeeFinancialServiceException("Error occurred while loading site details record from the database plz try again once");
				} else if(siteList.size()>1) {
					log.info("Error occurred while loading site details record dound duplicate from the database plz try again once");
					throw new EmployeeFinancialServiceException("Error occurred while loading site details record from the database plz try again once");					
				}
				SitePojo sitePojo = siteList.get(0);
				
				financialUploadDataInfo.setSiteId(sitePojo.getSiteId());
				serviceInfo = new EmployeeFinancialServiceInfo();
				serviceInfo.setSiteName(sitePojo.getName());
				serviceInfo.setSiteId(sitePojo.getSiteId());
				//officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(serviceInfo);
				//officeDetailsList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
				
				//officeDetailsMap.put(financialUploadDataInfo.getSiteName(),officeDetailsList);
				siteDetailsMap.put(financialUploadDataInfo.getSiteName(),siteList);
			}
			
			financialUploadDataInfo.setOfficeDetailsList(officeDetailsList);
		}
		/*ExecutorService executorService = Executors.newFixedThreadPool(50);
		@SuppressWarnings("unchecked")
		Future<List<FileInfo>> future = executorService.submit(new Callable(){
		    public Object call() throws Exception {
		    	List<FileInfo> fileInfoList = employeeFinancialHelper.financialReceiptGeneratHelper(employeeFinancialServiceInfo);
		        return fileInfoList;
		    }
		});

		System.out.println("future.get() = " + future.get());
		List<FileInfo> fileInfoList = (List<FileInfo>) future.get();*/
		List<FileInfo> fileInfoList = employeeFinancialHelper.financialReceiptGeneratHelper(employeeFinancialServiceInfo);
		/*
		Thread.sleep(10000);
		employeeFinancialServiceInfo.setActionUrl("FinancialReceiptUploadData");
		FileInfo zipFileInfo = employeeFinancialHelper.generateZipFile(fileInfoList,employeeFinancialServiceInfo);
		if(zipFileInfo!=null && zipFileInfo.getFilePath()!=null) {
			File file = new File(zipFileInfo.getFilePath());
			long lengthOfFile = file.length();
			
			// Get length of file in bytes
			long fileSizeInBytes = file.length();
			// Convert the bytes to Kilobytes (1 KB = 1024 Bytes)
			long fileSizeInKB = fileSizeInBytes / 1024;
			// Convert the KB to MegaBytes (1 MB = 1024 KBytes)
			long fileSizeInMB = fileSizeInKB / 1024;
			zipFileInfo.setFileType(String.valueOf(fileSizeInMB));
			if(fileSizeInMB>30) {
				log.info("Zip File size is more than 30 MB");
				//throw new EmployeeFinancialServiceException("Unable to download the Zip File, size is more than 30 MB, Here is the link of file ,Before closing copy this link : "+zipFileInfo.getUrl());
			}
			log.info("\nFile Name"+zipFileInfo.getFilePath()+"\nlengthOfFile "+lengthOfFile+" \n file in  MB "+(fileSizeInMB));
			
		} else {
			log.info("Error occurred generating zip file, Please try again...");
			throw new EmployeeFinancialServiceException("Error occurred generating zip file, Please try again...");					
		}
		fileInfoList = new ArrayList<>();
		listOfResp.add(zipFileInfo);
		*/
		return listOfResp;
	}
	
/*	@SuppressWarnings("unused")
	private void processFlatCostDetails(Map<String, CustomerPropertyDetailsInfo> customersList, 
			EmployeeFinancialServiceInfo financialServiceInfo) throws Exception, IllegalAccessException {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.processFlatCostDetails() *****");
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = (EmployeeFinancialServiceInfo) financialServiceInfo.clone();
		employeeFinancialServiceInfo.setActionUrl("View DemandNotes");

		for (FinancialFlatCostDetailsInfo flatCostDetailsInfo : financialServiceInfo.getFinancialFlatCostDetailsRequests()) {
			
			if (Util.isEmptyObject(flatCostDetailsInfo.getSiteId()) && Util.isNotEmptyObject(flatCostDetailsInfo.getSiteName())) {
				Site site = new Site();
				site.setName(flatCostDetailsInfo.getSiteName());
				if (Util.isNotEmptyObject(financialServiceInfo.getSiteId())) {
					flatCostDetailsInfo.setSiteId(financialServiceInfo.getSiteId());
					financialServiceInfo.setSiteIds(Arrays.asList(financialServiceInfo.getSiteId()));
				} else {
					List<DropDownPojo> sitesLists = employeeFinancialServiceDao.getSiteData(site);
					if (Util.isNotEmptyObject(sitesLists)) {
						flatCostDetailsInfo.setSiteId(sitesLists.get(0).getId());
						financialServiceInfo.setSiteId(sitesLists.get(0).getId());
						financialServiceInfo.setSiteIds(Arrays.asList(sitesLists.get(0).getId()));
					}
				}
			}
			employeeFinancialServiceInfo.setSiteIds(financialServiceInfo.getSiteIds());
			if(Util.isEmptyObject(flatCostDetailsInfo.getFlatId())) {
				employeeFinancialServiceInfo.setFlatNos(Arrays.asList(flatCostDetailsInfo.getFlatNo()));
				if(customersList.containsKey(trn_MilestoneRequest.getSiteName()+flatCostDetailsInfo.getFlatNo())) {
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo = customersList.get(trn_MilestoneRequest.getSiteName()+flatCostDetailsInfo.getFlatNo());
					flatCostDetailsInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
					flatCostDetailsInfo.setFlatIds(Arrays.asList(customerPropertyDetailsInfo.getFlatId()));
					flatCostDetailsInfo.setFlatId(customerPropertyDetailsInfo.getFlatId());
					flatCostDetailsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
					flatCostDetailsInfo.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
					flatCostDetailsInfo.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
					flatCostDetailsInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
					continue;
				}
				List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
				if(Util.isNotEmptyObject(customerPropertyDetailsPojoList)) {
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
					customersList.put(trn_MilestoneRequest.getSiteName()+flatCostDetailsInfo.getFlatNo(), customerPropertyDetailsInfo);
					flatCostDetailsInfo.setFlatIds(Arrays.asList(customerPropertyDetailsInfo.getFlatId()));
					flatCostDetailsInfo.setFlatId(customerPropertyDetailsInfo.getFlatId());
					flatCostDetailsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
					flatCostDetailsInfo.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
					flatCostDetailsInfo.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
					flatCostDetailsInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
					 
				} else {
					throw new EmployeeFinancialServiceException("Flat details not found, In Site "+flatCostDetailsInfo.getSiteName()+" Flat No "+flatCostDetailsInfo.getFlatNo());
				}
			}//flatCostDetailsInfo.getFlatId()
		}
		
		for (FinancialFlatCostDetailsInfo flatCostDetailsInfo : financialServiceInfo.getFinancialFlatCostDetailsRequests()) {
			if(Util.isNotEmptyObject(flatCostDetailsInfo.getFlatId())) {
				CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = flatCostDetailsInfo.getCustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo2.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
				
				List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);
				FinBookingFormAccountSummaryPojo accSummaryPojo = new FinBookingFormAccountSummaryPojo();
				accSummaryPojo.setPayableAmount(flatCostDetailsInfo.getFlatCostWithBasicAndAmenities());
				accSummaryPojo.setBalanceAmount(flatCostDetailsInfo.getFlatCostWithBasicAndAmenities());
				accSummaryPojo.setBookingFormId(flatCostDetailsInfo.getBookingFormId());
				accSummaryPojo.setCreatedBy(financialServiceInfo.getEmpId());
				accSummaryPojo.setFlatGstAmount(flatCostDetailsInfo.getGstAmount());
				accSummaryPojo.setPaidAmount(0.0);
				accSummaryPojo.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
				accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
				if(!listOfBookingAccountSummaryDetails.isEmpty()) {
					//employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
				} else {
					employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
				}
			}
		}
	}
*/
	
	private void loadFinancialSchemeIds(EmployeeFinancialServiceInfo financialServiceInfo, Map<String, List<FinSchemePojo>> loadedSchemeList,
			Map<String, List<FinTaxPojo>> loadedTaxList, Map<Double, Long> percentageList,
			Map<String, CustomerPropertyDetailsInfo> customersList) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.loadFinancialSchemeIds() *****");
		for(FinancialSchemeInfo schemeDetails : financialServiceInfo.getFinancialSchemeRequests()) {
			if (Util.isEmptyObject(schemeDetails.getSiteId()) && Util.isNotEmptyObject(schemeDetails.getSiteName())) {
				Site site = new Site();
				site.setName(schemeDetails.getSiteName());
				if (Util.isNotEmptyObject(financialServiceInfo.getSiteId())) {
					schemeDetails.setSiteId(financialServiceInfo.getSiteId());
				} else {
					List<DropDownPojo> sitesLists = employeeFinancialServiceDao.getSiteData(site);
					if (Util.isNotEmptyObject(sitesLists)) {
						schemeDetails.setSiteId(sitesLists.get(0).getId());
						financialServiceInfo.setSiteId(sitesLists.get(0).getId());
						financialServiceInfo.setSiteIds(Arrays.asList(sitesLists.get(0).getId()));
					}
				}
			}
			
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = (EmployeeFinancialServiceInfo) financialServiceInfo.clone();
			employeeFinancialServiceInfo.setActionUrl("View DemandNotes");
			if(Util.isEmptyObject(schemeDetails.getFlatId())) {
				employeeFinancialServiceInfo.setFlatNos(Arrays.asList(schemeDetails.getFlatNo()));
				
				if(customersList.containsKey(schemeDetails.getSiteName()+schemeDetails.getFlatNo())) {
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo = customersList.get(schemeDetails.getSiteName()+schemeDetails.getFlatNo());
					schemeDetails.setFlatId(customerPropertyDetailsInfo.getFlatId());
					schemeDetails.setFlatIds(Arrays.asList(customerPropertyDetailsInfo.getFlatId()));
					schemeDetails.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
					schemeDetails.setBlockId(customerPropertyDetailsInfo.getBlockId());
					//continue;
				} else {
					List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
					if (Util.isNotEmptyObject(customerPropertyDetailsPojoList)) {
						CustomerPropertyDetailsInfo customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
						customersList.put(schemeDetails.getSiteName()+schemeDetails.getFlatNo(), customerPropertyDetailsInfo);
						schemeDetails.setFlatId(customerPropertyDetailsInfo.getFlatId());
						schemeDetails.setFlatIds(Arrays.asList(customerPropertyDetailsInfo.getFlatId()));
						schemeDetails.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
						schemeDetails.setBlockId(customerPropertyDetailsInfo.getBlockId());
					} else {
						throw new EmployeeFinancialServiceException("Flat details not found, In Site "
								+ schemeDetails.getSiteName() + " Flat No " + schemeDetails.getFlatNo());
					}
				}
			}
			List<FinSchemePojo> schemeTaxList =	null;
			if(Util.isNotEmptyObject(schemeDetails.getSchemeName())) {
				if(loadedSchemeList.containsKey(schemeDetails.getSiteName()+schemeDetails.getSchemeName())) {
					schemeTaxList =	loadedSchemeList.get(schemeDetails.getSiteName()+schemeDetails.getSchemeName());
				} else {
					schemeTaxList =	employeeFinancialServiceDao.getFinSchemeDetails(schemeDetails);
				}
				if(schemeTaxList!=null && schemeTaxList.size()!=0) {
					if(!loadedSchemeList.containsKey(schemeDetails.getSiteName()+schemeDetails.getSchemeName())) {
						loadedSchemeList.put(schemeDetails.getSiteName()+schemeDetails.getSchemeName(), schemeTaxList);
					}
					schemeDetails.setFinSchemeId(schemeTaxList.get(0).getFinSchemeId());
				}else {
					FinSchemePojo finSchemePojo = financialMapper.constructFinSchemePojo(schemeDetails,financialServiceInfo);
					 employeeFinancialServiceDao.insertFinSchemeDetails(finSchemePojo);
					 schemeDetails.setFinSchemeId(finSchemePojo.getFinSchemeId());
				}
			}

			List<FinTaxPojo> taxDetailsList = null;
			if(Util.isNotEmptyObject(schemeDetails.getTaxName())) {
				if(loadedTaxList.containsKey(schemeDetails.getSiteName()+schemeDetails.getTaxName())) {
					taxDetailsList = loadedTaxList.get(schemeDetails.getSiteName()+schemeDetails.getTaxName());
				} else {
				    taxDetailsList = employeeFinancialServiceDao.getFinTaxDetails(schemeDetails);
				}
				if(taxDetailsList!=null && taxDetailsList.size()!=0) {
					schemeDetails.setFinTaxId(taxDetailsList.get(0).getFinTaxId());
					if(!loadedTaxList.containsKey(schemeDetails.getSiteName()+schemeDetails.getTaxName())) {
						loadedTaxList.put(schemeDetails.getSiteName()+schemeDetails.getTaxName(),taxDetailsList);
					}
				}else {
					FinTaxPojo finTaxPojo = financialMapper.constructFinTaxPojo(schemeDetails,financialServiceInfo);	
					employeeFinancialServiceDao.insertFinTaxDetails(finTaxPojo);
					schemeDetails.setFinTaxId(finTaxPojo.getFinTaxId());
				}
			}
			
			if (Util.isEmptyObject(schemeDetails.getPercentageId())) {
				FinancialGstDetailsInfo gstDetailsInfo = new FinancialGstDetailsInfo();
				gstDetailsInfo.setPercentageValue(schemeDetails.getPercentageValue());
				
				if(percentageList.containsKey(schemeDetails.getPercentageValue())) {
					gstDetailsInfo.setPercentageId(percentageList.get(schemeDetails.getPercentageValue()));
				}else {
					int count = employeeFinancialServiceDao.isPercentageExists(gstDetailsInfo);
					if (count == 0) {
						employeeFinancialServiceDao.savePercentage(gstDetailsInfo);	
					}
				}
				schemeDetails.setPercentageId(gstDetailsInfo.getPercentageId());
				if(!percentageList.containsKey(schemeDetails.getPercentageValue())) {
					percentageList.put(schemeDetails.getPercentageValue(), gstDetailsInfo.getPercentageId());
				}
			}
		}
	}

	private void loadMilestoneRecordDataIds(EmployeeFinancialServiceInfo financialServiceInfo,
			FinancialDemandNoteMS_TRN_Info trn_MilestoneRequest,
			EmployeeFinancialServiceInfo employeeFinancialDemandNoteInfo, Map<String, List<FinancialProjectMileStonePojo>> loadedMilestoneListList) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.loadMilestoneRecordDataIds() *****");
		
		if (Util.isEmptyObject(trn_MilestoneRequest.getSiteId()) && Util.isNotEmptyObject(trn_MilestoneRequest.getSiteName())) {
			Site site = new Site();
			site.setName(trn_MilestoneRequest.getSiteName());
			if (Util.isNotEmptyObject(financialServiceInfo.getSiteId())) {
				employeeFinancialDemandNoteInfo.setSiteId(financialServiceInfo.getSiteId());
			} else {
				List<DropDownPojo> sitesLists = employeeFinancialServiceDao.getSiteData(site);
				if (Util.isNotEmptyObject(sitesLists)) {
					employeeFinancialDemandNoteInfo.setSiteId(sitesLists.get(0).getId());
					financialServiceInfo.setSiteId(sitesLists.get(0).getId());
					financialServiceInfo.setSiteIds(Arrays.asList(sitesLists.get(0).getId()));
				}
			}
		} else {
			employeeFinancialDemandNoteInfo.setSiteId(trn_MilestoneRequest.getSiteId());
			employeeFinancialDemandNoteInfo.setSiteIds(Arrays.asList(trn_MilestoneRequest.getSiteId()));
		}
		
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = (EmployeeFinancialServiceInfo) financialServiceInfo.clone();
		employeeFinancialServiceInfo.setActionUrl("View DemandNotes");
		if(Util.isEmptyObject(trn_MilestoneRequest.getFlatId())) {
			employeeFinancialServiceInfo.setFlatNos(Arrays.asList(trn_MilestoneRequest.getFlatNo()));
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojoList)) {
				employeeFinancialDemandNoteInfo.setFlatIds(Arrays.asList(customerPropertyDetailsPojoList.get(0).getFlatId()));
				employeeFinancialDemandNoteInfo.setBookingFormId(customerPropertyDetailsPojoList.get(0).getFlatBookingId());
				employeeFinancialDemandNoteInfo.setBlockIds(Arrays.asList(customerPropertyDetailsPojoList.get(0).getBlockId()));
			} else {
				throw new EmployeeFinancialServiceException("Flat details not found, In Site "+trn_MilestoneRequest.getSiteName()+" Flat No "+trn_MilestoneRequest.getFlatNo());
			}
		}
		List<FinancialProjectMileStonePojo>  listOfFinancialServicePojo = null;
		if(Util.isEmptyObject(trn_MilestoneRequest.getProjectMilestoneId()) || Util.isEmptyObject(trn_MilestoneRequest.getMileStoneNo())|| Util.isEmptyObject(trn_MilestoneRequest.getFinMilestoneClassifidesId())) {
			employeeFinancialDemandNoteInfo.setCondition(FinEnum.LOAD_BY_MILESTONE_NAME.getName());
			String milestoneKey = trn_MilestoneRequest.getSiteName()+trn_MilestoneRequest.getBlockName()+trn_MilestoneRequest.getMilestoneName();//need to be checked
			if(loadedMilestoneListList.containsKey(milestoneKey)) {
				listOfFinancialServicePojo = loadedMilestoneListList.get(milestoneKey); 	
			} else {
				listOfFinancialServicePojo = employeeFinancialServiceDao.getMilestoneDetails(employeeFinancialDemandNoteInfo);
			}
			
			if(Util.isNotEmptyObject(listOfFinancialServicePojo)) {
				if(!loadedMilestoneListList.containsKey(milestoneKey)) {
					loadedMilestoneListList.put(milestoneKey, listOfFinancialServicePojo);
				}
				List<FinancialProjectMileStoneInfo> projectMileStoneInfos = employeeFinancialDemandNoteInfo.getFinancialProjectMileStoneRequests();
				if(Util.isNotEmptyObject(projectMileStoneInfos)) {
					FinancialProjectMileStonePojo projectMileStonePojo = listOfFinancialServicePojo.get(0);
					FinancialProjectMileStoneInfo projectMileStoneInfo = projectMileStoneInfos.get(0);
					//FinancialProjectMileStoneInfo projectMileStoneInfo1 = new FinancialProjectMileStoneInfo(); 
							//(FinancialProjectMileStoneInfo) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(projectMileStonePojo, FinancialProjectMileStoneInfo.class);
					projectMileStoneInfo.setMileStoneDueDate(projectMileStoneInfo.getMileStoneDueDate());
					projectMileStoneInfo.setMilestoneDate(projectMileStoneInfo.getMilestoneDate());
					projectMileStoneInfo.setMileStoneNo(projectMileStonePojo.getMileStoneNo());
					projectMileStoneInfo.setProjectMilestoneId(projectMileStonePojo.getProjectMilestoneId());
					projectMileStoneInfo.setFinMilestoneClassifidesId(projectMileStonePojo.getFinMilestoneClassifidesId());
					projectMileStoneInfo.setPercentagesId(projectMileStonePojo.getPercentagesId());
					projectMileStoneInfo.setMileStonePercentage(projectMileStonePojo.getMileStonePercentage());
					projectMileStoneInfo.setMilestoneName(projectMileStonePojo.getMilestoneName());
					projectMileStoneInfo.setCreatedBy(employeeFinancialDemandNoteInfo.getEmpId());
					projectMileStoneInfo.setSiteId(employeeFinancialDemandNoteInfo.getSiteId());
					projectMileStoneInfo.setStatusId(Status.ACTIVE.getStatus());
					projectMileStoneInfo.setReGenerateDemandNote(employeeFinancialDemandNoteInfo.isReGenerateDemandNote());
					projectMileStoneInfo.setDemandNoteSelectionType(employeeFinancialDemandNoteInfo.getDemandNoteSelectionType());
					projectMileStoneInfo.setThisUplaodedData(Boolean.TRUE);
					projectMileStoneInfo.setShowGstInPDF(employeeFinancialDemandNoteInfo.isShowGstInPDF());projectMileStoneInfo.setSiteId(employeeFinancialDemandNoteInfo.getSiteId());
					if(trn_MilestoneRequest.getIsWithInterestOrWithOut()!=null && 
							trn_MilestoneRequest.getIsWithInterestOrWithOut().replaceAll(" ", "").equalsIgnoreCase(Status.With_Interest.getDescription().replaceAll(" ", ""))) {
						employeeFinancialDemandNoteInfo.setIsInterestOrWithOutInterest(Status.With_Interest.getDescription());
						projectMileStoneInfo.setInterestSelectionType(Status.With_Interest.getStatus());
					} else {
						projectMileStoneInfo.setInterestSelectionType(Status.With_Out_Interest.getStatus());
						employeeFinancialDemandNoteInfo.setIsInterestOrWithOutInterest(Status.With_Out_Interest.getDescription());
					}
					//System.out.println(projectMileStonePojo.getMilestoneName()+" "+projectMileStoneInfo.getMilestoneName());
					//projectMileStoneInfo = projectMileStoneInfo1;
					employeeFinancialDemandNoteInfo.setFinMilestoneClassifidesId(projectMileStonePojo.getFinMilestoneClassifidesId());
				}
			} else {
				throw new EmployeeFinancialServiceException("Milestone details not found, Milestone name : "+trn_MilestoneRequest.getMilestoneName());
			}
		}
	}

	private void loadTransactionRecordDataIds(EmployeeFinancialServiceInfo financialServiceInfo, FinancialDemandNoteMS_TRN_Info trn_Request,
			EmployeeFinancialTransactionServiceInfo transactionServiceInfo, Map<String, List<FinBankPojo>> loadedBankList,
			Map<String, Long> loadedSiteAccountNumberList) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.loadTransactionRecordDataIds() *****");
		if (Util.isEmptyObject(transactionServiceInfo.getSiteId()) && Util.isNotEmptyObject(transactionServiceInfo.getSiteName())) {
			Site site = new Site();
			site.setName(transactionServiceInfo.getSiteName());
			if(Util.isNotEmptyObject(financialServiceInfo.getSiteId())) {
				transactionServiceInfo.setSiteId(financialServiceInfo.getSiteId());
			}else {
				 List<DropDownPojo> sitesLists = employeeFinancialServiceDao.getSiteData(site);
				 if(Util.isNotEmptyObject(sitesLists)){
					 transactionServiceInfo.setSiteId(sitesLists.get(0).getId());
					 financialServiceInfo.setSiteId(sitesLists.get(0).getId());
					 financialServiceInfo.setSiteIds(Arrays.asList(sitesLists.get(0).getId()));
				 }
			}
		}else {
			transactionServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
			transactionServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
		}
		
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = (EmployeeFinancialServiceInfo) financialServiceInfo.clone();
		employeeFinancialServiceInfo.setActionUrl("View DemandNotes");
		if(Util.isEmptyObject(trn_Request.getFlatId())) {
			employeeFinancialServiceInfo.setFlatNos(Arrays.asList(trn_Request.getFlatNo()));
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojoList)) {
				transactionServiceInfo.setFlatIds(Arrays.asList(customerPropertyDetailsPojoList.get(0).getFlatId()));
				transactionServiceInfo.setBookingFormId(customerPropertyDetailsPojoList.get(0).getFlatBookingId());
			} else {
				throw new EmployeeFinancialServiceException("Flat details not found, In Site "+trn_Request.getSiteName()+" Flat No "+trn_Request.getFlatNo());
			}
		}
		if(Util.isEmptyObject(transactionServiceInfo.getBankName()) || transactionServiceInfo.getBankName() == null) {
			transactionServiceInfo.setBankName("-");
		}
		
		if(Util.isEmptyObject(transactionServiceInfo.getBankId()) && Util.isNotEmptyObject(transactionServiceInfo.getBankName())) {
			List<FinBankPojo> finBankPojoList = null;
			EmployeeFinancialTransactionServiceInfo clonetransactionServiceInfo = new EmployeeFinancialTransactionServiceInfo();
			if (loadedBankList.containsKey(transactionServiceInfo.getBankName())) {
				finBankPojoList = loadedBankList.get(transactionServiceInfo.getBankName());
			} else {
				clonetransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) transactionServiceInfo;
				clonetransactionServiceInfo.setCondition(FinEnum.LOAD_BY_NAME.getName());
				finBankPojoList = employeeFinancialServiceDao.getFinBankData(clonetransactionServiceInfo);
				loadedBankList.put(transactionServiceInfo.getBankName(), finBankPojoList);
			}
			if (Util.isEmptyObject(finBankPojoList)) {
				log.info("Bank Name Not Found : " + transactionServiceInfo.getBankName());
				FinBankPojo bankPojo = financialMapper.constructFinBankPojo(clonetransactionServiceInfo);
				employeeFinancialServiceDao.insertFinBankData(bankPojo);
				transactionServiceInfo.setBankId(bankPojo.getFinBankId());
			} else if (Util.isNotEmptyObject(finBankPojoList)) {
				transactionServiceInfo.setBankId(finBankPojoList.get(0).getFinBankId());
			}
		}
		if(Util.isEmptyObject(trn_Request.getSiteBankAccountNumber())) {
			trn_Request.setSiteBankAccountNumber("N/A");
		}
		
		String flatSaleOwnerId = "";
		if(Util.isNotEmptyObject(trn_Request.getCustomerPropertyDetailsInfo())) {
			flatSaleOwnerId = trn_Request.getCustomerPropertyDetailsInfo().getFlatSaleOwnerId();
			flatSaleOwnerId = flatSaleOwnerId == null ? "" : flatSaleOwnerId;
		}
		String key = trn_Request.getSiteName()+flatSaleOwnerId+trn_Request.getSiteBankAccountNumber();
		if (Util.isNotEmptyObject(trn_Request.getSiteBankAccountNumber())) {
			Long siteAccountId = null;
			if (loadedSiteAccountNumberList.containsKey(key)) {
				siteAccountId = loadedSiteAccountNumberList.get(key);
				trn_Request.setSiteAccountId(siteAccountId);
				transactionServiceInfo.setSiteAccountId(siteAccountId);
			} else {
				siteAccountId = employeeFinancialServiceDao.loadSiteAccountNumberIdUsingNumber(trn_Request,"uploadTransaction");
				trn_Request.setSiteAccountId(siteAccountId);
				transactionServiceInfo.setSiteAccountId(siteAccountId);
				loadedSiteAccountNumberList.put(key, siteAccountId);
				if (siteAccountId == null) {
					throw new EmployeeFinancialServiceException("Account detaile not found "+trn_Request.getSiteBankAccountNumber()+", In Site "+trn_Request.getSiteName()+" Flat No "+trn_Request.getFlatNo());
				}
			}
		}
	}

	@Override
	public EmployeeFinancialResponse deleteDemandNoteZipFile(EmployeeFinancialServiceInfo serviceInfo) {
		log.info("EmployeeFinancialServiceImpl.deleteDemandNoteZipFile()");
		//boolean isFileDeleted = false;
		if (Util.isNotEmptyObject(serviceInfo.getFileInfos())) {
			for (FileInfo fileInfo : serviceInfo.getFileInfos()) {
				if (Util.isNotEmptyObject(fileInfo.getFilePath())) {
					String filePathToDelete = fileInfo.getFilePath();
					File file = new File(filePathToDelete);
					file.delete();
				}
			}
		}
		return null;
	}
	
	@Override
	public EmployeeFinancialResponse loadDemandNotePDFFile(EmployeeFinancialServiceInfo serviceInfo) throws InstantiationException, IllegalAccessException {
		//log.info("EmployeeFinancialServiceImpl.loadDemandNotePDFFile()");
		EmployeeFinancialResponse employeeFinancialResponse = new EmployeeFinancialResponse();
		List<FinBookingFormDemandNoteDocPojo> demandNoteDetails = employeeFinancialServiceDao.loadDemandNotePDFFile(serviceInfo);
		FileInfo demandNoteDocPojo = (FileInfo)financialMapper.copyPropertiesFromInfoBeanToPojoBean(demandNoteDetails.get(0),FileInfo.class);
		List<FileInfo> fileInfos  = new ArrayList<>();
		fileInfos.add(demandNoteDocPojo);
		employeeFinancialResponse.setFileInfoList(fileInfos);
		return employeeFinancialResponse;
	}

	private void processDemandNoteDetails(EmployeeFinancialServiceInfo employeeFinancialDemandNoteInfo, FinancialProjectMileStoneInfo finProjDemandNoteInfo, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) throws InstantiationException, IllegalAccessException {
		FinancialProjectDemandNotePojo demandNotePojo = (FinancialProjectDemandNotePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finProjDemandNoteInfo,FinancialProjectDemandNotePojo.class);
		if(finProjDemandNoteInfo.isReGenerateDemandNote()) {
			demandNotePojo.setStatusId(Status.REGENERATED_DEMAND_NOTE.getStatus());
		}
		if(!finProjDemandNoteInfo.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
			Long finProjectDemandNoteId = employeeFinancialServiceDao.insertDataIntoFinProjDemandNote(demandNotePojo);
			finProjDemandNoteInfo.setFinProjectDemandNoteId(finProjectDemandNoteId);
			employeeFinancialServiceDao.insertDataIntoFinMilDemandNoteMapping((FinMilDemNoteMappingPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finProjDemandNoteInfo,FinMilDemNoteMappingPojo.class));
			employeeFinancialServiceDao.insertDataIntofinProjectDemandNoteStatistics(financialMapper.copyPropertiesFromCustomerPropertyDetailsInfoTOFinProjDemNoteStatisticsPojo(employeeFinancialDemandNoteInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo,FinProjDemNoteStatisticsPojo.class));
		}
	}
	
	/**
	 * 
	 * @param finProjDemandNoteInfo this object holding milestone related details
	 * @param finProjMileStonePojo this  object holding milestone related details
	 * @param totalInterestAmount
	 * @param payAmount this is holding payable basic amount of milestone
	 * @param paidAmount this is holding paid basic amount of milestone
	 * @param mileStoneInfo this object holding details of due date and paid date
	 * @param condition
	 * @param mileStoneDetailsList this object holding statistics of interest details
	 * @return
	 * @throws Exception
	 */
	@SuppressWarnings({ "unchecked", "unused"})
	private Double calculateMileStoneDueInterest(FinancialProjectMileStoneInfo finProjDemandNoteInfo, FinancialProjectMileStonePojo finProjMileStonePojo, 
			Double totalInterestAmount,Double payAmount, Double paidAmount, FinancialProjectMileStoneInfo mileStoneInfo, 
			String conditionPenalty, Map<String, Object> mileStoneDetailsList) throws Exception {
		//@SuppressWarnings("unused")
		String interestCalculationFrom1 = finProjDemandNoteInfo.getInterestCalculationFrom()==null?"":finProjDemandNoteInfo.getInterestCalculationFrom();
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount = new ArrayList<>();
		Double penaltyAmount = 0D;boolean flag  = false;
		long interestRateIteration = 0;
		double penaltyAmountWithTaxAmount = 0d;
		long siteId = finProjDemandNoteInfo.getSiteId();
		/*if("CalculateCustomerInterestDataSite".equalsIgnoreCase(interestCalculationFrom1)) {
			siteId = 1005;//common site for interest calc
			finProjDemandNoteInfo.setSiteId(siteId);
		}*/
		mileStoneInfo.setSiteId(siteId);
		//boolean insertData = (conditionPenalty.equalsIgnoreCase("Preview Demand Note"))?false:true;
		boolean insertData = (conditionPenalty.equalsIgnoreCase("insertInterestData"))?true:false;
		//Double finPenaltyTaxPercentage = 0D;
		//Long finPenltyTaxId = 0L;
		Double taxAmount = 0D;
		int yearDays = 365;
		int days; Double percentage;
		int sumofInterestDays = 0;
		int totalDueDatetoPaidDateDiff = 0;
		Long finInterestRatesId;
		Timestamp startDate = null;
		Timestamp endDate = null;
		int includeEndDateInCalculation = 1;
		
		double getMileStonePayAmount = mileStoneInfo.getMileStonePayAmount();
		double getMileStonePaidAmount = mileStoneInfo.getMileStonePaidAmount();
		double getMileStonePaidBasicAmount =  mileStoneInfo.getMileStonePaidBasicAmount()==null?0d:mileStoneInfo.getMileStonePaidBasicAmount();
		if(payAmount!=getMileStonePayAmount || getMileStonePaidAmount!=paidAmount) {
			throw new EmployeeFinancialServiceException("Interest Amount mismatch...");
		}
		List<FinPenaltyPojo> penaltyList = new ArrayList<>();
		List<FinPenaltyPojo> penaltyListForDN_Preview = new ArrayList<>();
		List<FinPenaltyTaxMappingPojo> pojoGstTaxMapping = null;
		List<String> avoidDupObject = null;
		List<FinPenaltyTaxPojo> finPenaltyTaxDetailsList = null;/*employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.FIN_PENALTY.getId()));
		if(Util.isEmptyObject(finPenaltyTaxDetailsList)) {
			throw new EmployeeFinancialServiceException("Gst on Interest Percentage not found, Please add the GST for Interest Percentage.");
		}*/
		
		if(Util.isNotEmptyObject(finProjDemandNoteInfo.getInterestSelectionType())) {
			if(finProjDemandNoteInfo.getInterestSelectionType().equals(Status.With_Interest.getStatus())) {
				List<FinInterestRatesPojo> finTaxDetailsListPojo = employeeFinancialServiceDao.getInterestDetailsOnDue(mileStoneInfo);
				if(!payAmount.equals(paidAmount) && Util.isEmptyObject(finTaxDetailsListPojo)) {
					//if paid amount is not equal to paying amount and rate of interest data not found, than take available rate of interest
					if(TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStonePaidDate()).equals(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(new Timestamp(new Date().getTime()))))) {
						//loading available month last date
						finTaxDetailsListPojo = employeeFinancialServiceDao.getAvailbleMonthInterestDetailsOnDue(mileStoneInfo);
						mileStoneInfo.setMileStonePaidDate(finTaxDetailsListPojo.get(0).getEndDate());//taking last date of rate of interest for calculation
						finTaxDetailsListPojo = employeeFinancialServiceDao.getInterestDetailsOnDue(mileStoneInfo);
					}
				}
				if(!interestCalculationFrom1.equals("ViewCustomerDataGetInterest") && !interestCalculationFrom1.equals("CalculateCustomerInterestBreakUpData")) {	
					if(Util.isEmptyObject(finTaxDetailsListPojo)) {
						if(TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStoneDueDate()).before(TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStonePaidDate()))) {
							log.info("Interest Rates not found, please add or update the Interest Rates.\n"+mileStoneInfo.getMileStoneDueDate()+"\t"+mileStoneInfo.getMileStonePaidDate());
							//List<FinPenaltyPojo> penaltyMaxEndDateList = employeeFinancialServiceDao.getLastInterestDateToFromMasterTB(mileStoneInfo);
							throw new EmployeeFinancialServiceException("Interest Rates not found, please add or update the Interest Rates.");		
						}
					} else {
						FinInterestRatesPojo finInterestRatesPojo = finTaxDetailsListPojo.get(finTaxDetailsListPojo.size()-1);
						Timestamp rateOfInterestendDate1 = finInterestRatesPojo.getEndDate();
						//if amount *paid date is after the Rate of interest *end date, it means rate of interest is not upto date, then throw the exception
						//as we need rate of interest is upto date
						if(TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStonePaidDate()).after(TimeUtil.removeTimePartFromTimeStamp1(rateOfInterestendDate1))) {
							log.info("Penalty Interest Rates not found, please add or update the Interest Rates.\n"+mileStoneInfo.getMileStonePaidDate()+"\t"+rateOfInterestendDate1);
							throw new EmployeeFinancialServiceException("Penalty Interest Rates not found, please add or update the Interest Rates.");
						}
					}
				}//interestCalculationFrom1.equals("Demand Note") && insertData
				totalDueDatetoPaidDateDiff = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1( mileStoneInfo.getMileStonePaidDate()))+1;
				for (int interestRateIndex = 0; interestRateIndex < finTaxDetailsListPojo.size(); interestRateIndex++) {
					avoidDupObject = new ArrayList<>();
					pojoGstTaxMapping = new ArrayList<>();
					FinPenalityInfo finPenalityInfo=new FinPenalityInfo();
					finPenalityInfo.setCreatedBy(finProjDemandNoteInfo.getCreatedBy());
					finPenalityInfo.setModifiedBy(finProjDemandNoteInfo.getCreatedBy());
					finPenalityInfo.setStatusId(Status.ACTIVE.getStatus());
					finPenalityInfo.setType(MetadataId.FIN_PENALTY.getId());
					finPenalityInfo.setBookingFormId(finProjMileStonePojo.getBookingFormId());
					finPenalityInfo.setFinBookingFormAccountsId(finProjMileStonePojo.getFinBookingFormAccountsId());

					FinInterestRatesPojo finInterestRatesPojo = finTaxDetailsListPojo.get(interestRateIndex);
					days = 0;
					if(interestRateIndex==0&&finTaxDetailsListPojo.size()==1) {
							startDate = mileStoneInfo.getMileStoneDueDate();
							endDate = mileStoneInfo.getMileStonePaidDate();
						days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1( mileStoneInfo.getMileStonePaidDate()));
					} else if (interestRateIndex == (finTaxDetailsListPojo.size() - 1)) {
						flag  = employeeFinancialServiceDao.checkTheDateBetweenTheDates(mileStoneInfo,finInterestRatesPojo);
							startDate = finInterestRatesPojo.getStartDate();
							endDate = mileStoneInfo.getMileStonePaidDate();
						days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finInterestRatesPojo.getStartDate()),TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStonePaidDate()));
					} else {
						flag  = employeeFinancialServiceDao.checkTheDateBetweenTheDates(mileStoneInfo,finInterestRatesPojo);
						if(flag&&interestRateIndex==0) {
							startDate = mileStoneInfo.getMileStoneDueDate();
							endDate = finInterestRatesPojo.getEndDate();
							days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStoneDueDate()), TimeUtil.removeTimePartFromTimeStamp1(finInterestRatesPojo.getEndDate()));
						}else if(flag&&interestRateIndex == (finTaxDetailsListPojo.size() - 1)){
							startDate = finInterestRatesPojo.getStartDate();
							endDate = mileStoneInfo.getMileStonePaidDate();
							days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finInterestRatesPojo.getStartDate()), TimeUtil.removeTimePartFromTimeStamp1(mileStoneInfo.getMileStonePaidDate()));
						}else {
							startDate = finInterestRatesPojo.getStartDate();
							endDate = finInterestRatesPojo.getEndDate();
							days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finInterestRatesPojo.getStartDate()),TimeUtil.removeTimePartFromTimeStamp1( finInterestRatesPojo.getEndDate()));	
						}
					}
					
					finPenalityInfo.setStartDate(TimeUtil.removeTimePartFromTimeStamp1(startDate));
					finPenalityInfo.setEndDate(TimeUtil.removeTimePartFromTimeStamp1(endDate));
					if(!interestCalculationFrom1.equals("CalculateCustomerInterestBreakUpData")) {
						penaltyList = employeeFinancialServiceDao.getLastInterestDateToCompare(finProjMileStonePojo);
					}
					if(!penaltyList.isEmpty()) {
						//mileStoneInfo.getMileStoneDueDate().compareTo(penaltyList.get(0).getEndDate());	
					}
					if(Util.isNotEmptyObject(finProjMileStonePojo.getPenaltyPojoList())) {//used for preview interest data
						penaltyListForDN_Preview = finProjMileStonePojo.getPenaltyPojoList();
					}
					String endDate1 = "";
					if(!interestCalculationFrom1.equals("CalculateCustomerInterestBreakUpData")) {
						//CalculateCustomerInterestBreakUpData these key is used for interest breakup report
						endDate1 = employeeFinancialServiceDao.isThisPenaltyDataExist(finPenalityInfo);
						if(Util.isNotEmptyObject(endDate1)) {
							continue;
						}
					}
					
					//if u got any interest issue please check this condition
					if(Util.isEmptyObject(endDate1) && !penaltyList.isEmpty()) {
						if(Util.isNotEmptyObject(penaltyList.get(0).getEndDate())) {
							finPenalityInfo.setStartDate(TimeUtil.addOneDay(penaltyList.get(0).getEndDate()));
							//days = TimeUtil.differenceBetweenDays(finPenalityInfo.getStartDate(), finPenalityInfo.getEndDate());
							days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finPenalityInfo.getStartDate()), TimeUtil.removeTimePartFromTimeStamp1(finPenalityInfo.getEndDate()));
						}
					} else if(Util.isNotEmptyObject(penaltyListForDN_Preview)) {
						finPenalityInfo.setStartDate(TimeUtil.addOneDay(penaltyListForDN_Preview.get(0).getEndDate()));
						
						days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finPenalityInfo.getStartDate()), TimeUtil.removeTimePartFromTimeStamp1(finPenalityInfo.getEndDate()));
					}
					if(!interestCalculationFrom1.equals("Demand Note") && !insertData && Util.isNotEmptyObject(penaltyListForDN_Preview)) {
						finPenalityInfo.setStartDate(TimeUtil.addOneDay(penaltyListForDN_Preview.get(0).getEndDate()));
						days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finPenalityInfo.getStartDate()), TimeUtil.removeTimePartFromTimeStamp1(finPenalityInfo.getEndDate()));
					}
					
					
					percentage = finInterestRatesPojo.getPercentageValue();
					finInterestRatesId = finInterestRatesPojo.getFinInterestRatesId();
					
					days += includeEndDateInCalculation;
					sumofInterestDays+=days;
					if (days <= 0) {
						if(interestCalculationFrom1.equals("CalculateCustomerInterestBreakUpData")) {/*
							 List<FinPenaltyStatisticsPojo> msPenaltyStatisticsPojos = finProjMileStonePojo.getPenaltyStatisticsPojos();
							 if(isNotEmptyObject(msPenaltyStatisticsPojos)) {//if days is less than zero and statics object present , may be there is chance that user paid amount more than 1 time in a day
								 //so first time we getting statics record, but next time onwards statics record not generating, bcoz alreay calculation happend for first payment on the day 
								 FinPenaltyStatisticsPojo pojo = msPenaltyStatisticsPojos.get(msPenaltyStatisticsPojos.size()-1);
								 if(pojo.getEndDate().equals(mileStoneInfo.getMileStonePaidDate())) {
									 FinPenaltyStatisticsPojo pojo1 =(FinPenaltyStatisticsPojo) pojo.clone();
									 pojo1.setInterestCalculationOnAmount(pojo.getInterestCalculationOnAmount()-paidAmount);
									 pojo1.setMileStonePaidBasicAmount(pojo.getMileStonePaidBasicAmount()+paidAmount);
									 msPenaltyStatisticsPojos.add(pojo1);
								 }
							 }
						*/}						 
						continue;
					}
					double interestCalculationOnAmount = payAmount - paidAmount;
					penaltyAmount = (((payAmount - paidAmount) * days * percentage) / 100d) / yearDays;
					if(payAmount.equals(paidAmount)) {
						break;
					}
					interestRateIteration++;
					penaltyAmount = roundOffAmount(penaltyAmount);
					interestCalculationOnAmount = roundOffAmount(interestCalculationOnAmount);
					totalInterestAmount = totalInterestAmount + penaltyAmount;//this line not much important 
					log.info("START DATE "+finPenalityInfo.getStartDate()+" END DATE "+finPenalityInfo.getEndDate()+" \ngetFinBookingFormAccountsId : "+finProjMileStonePojo.getFinBookingFormAccountsId()+" penaltyAmount : "+ penaltyAmount +" "+days);
					
					if(!insertData) {//code added for Demand note preview, as preview is calculating temporary so here maintaining start date and end date of interest
						if(Util.isNotEmptyObject(penaltyListForDN_Preview)) {
							FinPenaltyPojo penaltyPojo = penaltyListForDN_Preview.get(0);
							penaltyPojo.setStartDate(TimeUtil.addOneDay(finProjMileStonePojo.getMileStoneDueDate()));
							penaltyPojo.setEndDate( finPenalityInfo.getEndDate());
						} else {
							FinPenaltyPojo penaltyPojo = new FinPenaltyPojo();
							penaltyPojo.setStartDate(TimeUtil.addOneDay(finProjMileStonePojo.getMileStoneDueDate()));
							penaltyPojo.setEndDate( finPenalityInfo.getEndDate());//penaltyPojo.setPenaltyTotalAmount(penaltyTotalAmount);
							penaltyListForDN_Preview.add(penaltyPojo);
							finProjMileStonePojo.setPenaltyPojoList(penaltyListForDN_Preview);
						}
					}
					
					//loading GST on Interest Percentage, using rate of interest start date and end date 
					FinancialProjectMileStoneInfo finProjDemandNoteInfoClone = (FinancialProjectMileStoneInfo) finProjDemandNoteInfo.clone();
					finProjDemandNoteInfoClone.setMileStoneDueDate(finPenalityInfo.getStartDate());//selecting data using start date and end date of Rate of interest, for Gst on Interest
					finProjDemandNoteInfoClone.setMileStonePaidDate(finPenalityInfo.getEndDate());
					
					finPenaltyTaxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfoClone,Arrays.asList(MetadataId.FIN_PENALTY.getId()));
					if(Util.isEmptyObject(finPenaltyTaxDetailsList)) {
						log.info("Gst on Interest Percentage not found, Please add the GST for Interest Percentage.");
						throw new EmployeeFinancialServiceException("Gst on Interest Percentage not found, Please add the GST for Interest Percentage.");
					}
					
					if (penaltyAmount == 0 || penaltyAmount <0) {//after checking move this live
						continue;
					}
					
					finPenalityInfo.setBookingFormId(finProjMileStonePojo.getBookingFormId());
					finPenalityInfo.setDaysDifference(days);
					finPenalityInfo.setInterestCalculationOnAmount(interestCalculationOnAmount);
					finPenalityInfo.setInterestPercentage(percentage);
					if(interestRateIteration==1) {//this code is for getting interest calculation report
						finPenalityInfo.setMileStonePaidBasicAmount(getMileStonePaidBasicAmount);
						finPenalityInfo.setMileStonePaidDate(TimeUtil.addOneDay(mileStoneInfo.getMileStonePaidDate()));
					}
					 //finPenalityInfo.setInterestFrom("Front End");
					finPenalityInfo.setFinInterestRatesId(finInterestRatesId);
					finPenalityInfo.setPenaltyAmount(penaltyAmount);
					
					/* if(finPenalityInfo.getEndDate().equals(mileStoneInfo.getMileStonePaidDate())) {
						 finPenalityInfo.setMileStonePaidDate(TimeUtil.addOneDay(mileStoneInfo.getMileStonePaidDate()));
					 }*/
					
					//finPenaltyTaxPercentage = 0D;
					//finPenltyTaxId = 0L;
					
					double finPenaltyTaxPercentage = 0D;
					double finPenltyTaxId = 0L;
					for (FinPenaltyTaxPojo finPenaltyTaxPojo : finPenaltyTaxDetailsList) {
						String str = (finPenaltyTaxPojo.getStartDate()==null?"":finPenaltyTaxPojo.getStartDate().toString())+(finPenaltyTaxPojo.getEndDate()==null?"":finPenaltyTaxPojo.getEndDate().toString())
								+(finPenaltyTaxPojo.getPercentageValue()==null?"":finPenaltyTaxPojo.getPercentageValue());
						if(avoidDupObject.contains(str)) {
							continue;
						}
						avoidDupObject.add(str);
						finPenaltyTaxPercentage = finPenaltyTaxPojo.getPercentageValue();
						finPenltyTaxId = finPenaltyTaxPojo.getFinTaxMappingId();
					}
					Double tempTaxAmount = (penaltyAmount / 100) * finPenaltyTaxPercentage;
					//---------------------------------calcualte gst amount on interest amount
					taxAmount = getGstAmountOnInterestAmount(finPenalityInfo,finPenaltyTaxDetailsList,pojoGstTaxMapping);
					if (((long) tempTaxAmount.longValue()) != ((long) taxAmount.longValue())) {
						System.out.println("Prev "+tempTaxAmount.longValue()+", current "+taxAmount.longValue()+", days "+ days);
						//if((tempTaxAmount.longValue()-taxAmount.longValue())>1 || (tempTaxAmount.longValue()-taxAmount.longValue())<1) {
							//throw new EmployeeFinancialServiceException("Old Gst amount and new code GST does't matched..."+tempTaxAmount.longValue()+" "+taxAmount.longValue());//comment this line after changing the gst percentage
						//}
					}
					
					//taxAmount = (penaltyAmount / 100) * finPenaltyTaxPercentage;
					
					finPenalityInfo.setPenaltyTaxAmount(taxAmount);
					penaltyAmountWithTaxAmount = taxAmount + penaltyAmount;
					penaltyAmountWithTaxAmount = roundOffAmount(penaltyAmountWithTaxAmount);
					finPenalityInfo.setPenaltyTotalAmount(penaltyAmountWithTaxAmount);
					
					/* for Preview Demand Note */
					//if(Util.isNotEmptyObject(condition) && condition.equalsIgnoreCase("Preview Demand Note")) {//acp commented
						//previousPendingMilestones.setTotalPenaltyAmount(taxAmount + penaltyAmount);
						finProjMileStonePojo.setTotalPendingPenaltyAmount(finProjMileStonePojo.getTotalPendingPenaltyAmount()+penaltyAmountWithTaxAmount);
						finProjMileStonePojo.setTotalPenaltyAmount(finProjMileStonePojo.getTotalPenaltyAmount()+penaltyAmountWithTaxAmount);
						/* Total No of Days Delayed to Pay Amount is used in Interest Letter */
						if(Util.isEmptyObject(finProjMileStonePojo.getDaysDelayed())) {
							finProjMileStonePojo.setDaysDelayed(0l);
						}
						finProjMileStonePojo.setDaysDelayed(finProjMileStonePojo.getDaysDelayed()+Long.valueOf(days));
					//}
						Long finPenaltyId = 0l;
						Long finBookingFormAccountsId = 0l;
						FinBookingFormAccountSummaryPojo accSummaryPojo = (FinBookingFormAccountSummaryPojo)financialMapper.copyPropertiesFromInfoBeanToPojoBean(finPenalityInfo,FinBookingFormAccountSummaryPojo.class);
						accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
						if(insertData) {
						 finPenaltyId = employeeFinancialServiceDao.savePenaltyData((FinPenaltyPojo)financialMapper.copyPropertiesFromInfoBeanToPojoBean(finPenalityInfo,FinPenaltyPojo.class),finProjMileStonePojo,accSummaryPojo);
						}
						finPenalityInfo.setFinPenaltyId(finPenaltyId);
						//System.out.print(finPenalityInfo);
						//if(interestCalculationFrom.equalsIgnoreCase("ReceiptEditDelete") || interestCalculationFrom.equalsIgnoreCase("PaymentRefund") ) {
							finPenalityInfo.setCondition(interestCalculationFrom1);
							finBookingFormAccountsId = employeeFinancialServiceDao.isPenaltyDetailsExistInAccountTable(finPenalityInfo);
							finPenalityInfo.setFinBookingFormAccountsId(finBookingFormAccountsId);
							/*if(interestCalculationFrom.equalsIgnoreCase("ReceiptEditDelete") || interestCalculationFrom.equalsIgnoreCase("PaymentRefund") ) {
								employeeFinancialServiceDao.upadteFinBookingFormAccountPenaltyRecordTypeId(finPenalityInfo);
							} else {*/
							if(insertData) {//new penalty id is updating if we inactived fin_penalty record at the time Edit And Save time
								employeeFinancialServiceDao.upadteFinBookingFormAccountPenaltyRecordTypeId(finPenalityInfo);
							}
							//}
						/*}else {
							finBookingFormAccountsId = employeeFinancialServiceDao.isPenaltyDetailsExistInAccountTable(finPenalityInfo);
						}*/
						finPenalityInfo.setFinBookingFormAccountsId(finBookingFormAccountsId);
						FinBookingFormAccountsPojo finBookingFormAccountsPojo = financialMapper.copyPropertiesToFinBookingFormAccountsPojo(finProjDemandNoteInfo,finPenalityInfo,FinBookingFormAccountsPojo.class,"MileStonePenaltyAmt");
						finProjMileStonePojo.setMilestonePenaltyRecordPojo(finBookingFormAccountsPojo);
						if (finBookingFormAccountsId == 0) {
							if(insertData) {
								employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
							}
						} else {
							finBookingFormAccountsPojo.setFinBookingFormAccountsId(finBookingFormAccountsId);
							if (insertData) {
								employeeFinancialServiceDao.upadteFinBookingFormAccountRecords(finPenalityInfo,finBookingFormAccountsPojo);
							}
						}
//Interest Excess amount adjustment code					
					/*List excessAmountReturnList = null;
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
					customerPropertyDetailsInfo2.setType(MetadataId.FIN_PENALTY.getId());
					customerPropertyDetailsInfo2.setFlatBookingId(finProjMileStonePojo.getBookingFormId());
					customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_PENALTY.getName());
					customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());
					
					if(insertData) {
						if(listOfExcessAmount.isEmpty()) {//if data is inserting to table then need to fecth data again, bcoz amount is adjusted to interest
							listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2,Arrays.asList(MetadataId.FIN_PENALTY.getId()));
						}
					} else {
						listOfExcessAmount = (List<FinBookingFormExcessAmountPojo>) mileStoneDetailsList.get(MetadataId.FIN_PENALTY.getName());
					}
				    if(Util.isNotEmptyObject(listOfExcessAmount)) {
							FinancialProjectMileStoneInfo finProjDemandNoteInfo1 = (FinancialProjectMileStoneInfo) finProjDemandNoteInfo.clone();;
							finProjDemandNoteInfo1.setModifiedBy(finProjDemandNoteInfo.getCreatedBy());
							finProjDemandNoteInfo1.setPayAmount(finPenalityInfo.getPenaltyTotalAmount());
							excessAmountReturnList = processExcessAMount(listOfExcessAmount,new FinBookingFormAccountsInfo(),finProjDemandNoteInfo1,new CustomerPropertyDetailsInfo(),finBookingFormAccountsPojo, MetadataId.FIN_PENALTY.getName(),insertData);
						
						if (isNotEmptyObject(finBookingFormAccountsPojo.getPaidAmount())) {
								double excessAmount = isEmptyObject(finBookingFormAccountsPojo.getPaidAmount())?0d:finBookingFormAccountsPojo.getPaidAmount();
								if(finPenalityInfo.getPenaltyTotalAmount()>finProjMileStonePojo.getTotalPendingPenaltyAmount()) {
									//this code for need to check
									finProjMileStonePojo.setTotalPendingPenaltyAmount(finProjMileStonePojo.getTotalPendingPenaltyAmount()-excessAmount);
									double paidAmt = finProjMileStonePojo.getTotalPenalityPaidAmount()==null?0d:finProjMileStonePojo.getTotalPenalityPaidAmount();
									finProjMileStonePojo.setTotalPenalityPaidAmount(paidAmt+excessAmount);
								}
							if (isNotEmptyObject(finBookingFormAccountsPojo.getPaidDate()) && excessAmount != 0) {
									finProjMileStonePojo.setMileStonePaidDate(finBookingFormAccountsPojo.getPaidDate());
									//currentFinancialProjectMileStonePojo.setPaymentStatus(bookingFormAccountsPojo.getPaymentStatus());
								}
							}
						}//excess amount
*///Interest Excess amount adjustment code
				    //==============================================						
						 //here all milestone penalty statistics break up
						 List<FinPenaltyStatisticsPojo> penaltyStatisticsPojos = (List<FinPenaltyStatisticsPojo>) mileStoneDetailsList.get("penaltyStat");
						 FinPenaltyStatisticsPojo  penaltyStatisticsPojo= (FinPenaltyStatisticsPojo)financialMapper.copyPropertiesFromInfoBeanToPojoBean(finPenalityInfo,FinPenaltyStatisticsPojo.class);
						 penaltyStatisticsPojos.add(penaltyStatisticsPojo);
						 
						 //here milestone wise penalty statistics break up
						 List<FinPenaltyStatisticsPojo> msPenaltyStatisticsPojos = finProjMileStonePojo.getPenaltyStatisticsPojos();
						 if(isEmptyObject(msPenaltyStatisticsPojos)) {
							 msPenaltyStatisticsPojos = new ArrayList<>();
							 finProjMileStonePojo.setPenaltyStatisticsPojos(msPenaltyStatisticsPojos);
						 }
						 msPenaltyStatisticsPojos.add(penaltyStatisticsPojo);
						 //==============================================
					if (insertData) {
						employeeFinancialServiceDao.savePenaltyStatisticsData(penaltyStatisticsPojo,finProjMileStonePojo);
					 
						for (FinPenaltyTaxMappingPojo penaltyTaxMappingPojo : pojoGstTaxMapping) {
							penaltyTaxMappingPojo.setFinPenaltyId(finPenalityInfo.getFinPenaltyId());
							penaltyTaxMappingPojo.setFinPenaltyStatisticsId(penaltyStatisticsPojo.getFinPenaltyStatisticsId());
							penaltyTaxMappingPojo.setCreatedBy(finProjDemandNoteInfo.getCreatedBy());
						
							employeeFinancialServiceDao.savePenaltyTaxMappingDetails(penaltyTaxMappingPojo);
						}
					}
					
				}//finInterestRatesPojo
			} else if (finProjDemandNoteInfo.getInterestSelectionType() == 33) {
			}
		}
		
		if(sumofInterestDays!=totalDueDatetoPaidDateDiff) {
			log.info("Gst Days and Penalty Days Got Mismatch...! no Throw exception");//only for CUG
			//throw new EmployeeFinancialServiceException("Gst on Interest Percentage not found, Please add the GST for Interest Percentage.");
		}
		
		log.info("***** EmployeeFinancialServiceImpl.calculateMileStoneDueInterest() method execution completed *****\n"+mileStoneDetailsList.get("penaltyStat"));

		return totalInterestAmount;
	}

	//in this method interest amount is spliting on based on GST days
	private Double getGstAmountOnInterestAmount(FinPenalityInfo finPenalityInfo, List<FinPenaltyTaxPojo> finPenaltyTaxDetailsList, List<FinPenaltyTaxMappingPojo> pojoTaxMapping) throws Exception {
		Double finPenaltyTaxPercentage = 0D;
		Long finPenltyTaxId = 0L;
		Double taxAmount = 0.0;
		Double sumOfTaxAmount = 0.0;
		Double penaltyAmount = 0.0;
		FinPenaltyTaxMappingPojo penaltyTaxMappingPojo = null;
		List<String> avoidDupObject = new ArrayList<>();
		int includeEndDateInCalculation = 1;
		int sumofgstDays = 0;
		Timestamp gstStartDate = null;
		Timestamp gstEndDate = null;String str = "";
		for (int gstRateIndex = 0; gstRateIndex < finPenaltyTaxDetailsList.size(); gstRateIndex++) {
		//for (FinPenaltyTaxPojo finPenaltyTaxMapPojo : finPenaltyTaxDetailsList) {
			FinPenaltyTaxPojo finPenaltyTaxMapPojo = finPenaltyTaxDetailsList.get(gstRateIndex);
			str = (finPenaltyTaxMapPojo.getStartDate()==null?"":finPenaltyTaxMapPojo.getStartDate().toString())+(finPenaltyTaxMapPojo.getEndDate()==null?"":finPenaltyTaxMapPojo.getEndDate().toString())
					+(finPenaltyTaxMapPojo.getPercentageValue()==null?"":finPenaltyTaxMapPojo.getPercentageValue());
			if(avoidDupObject.contains(str)) {
				continue;
			}
			avoidDupObject.add(str);
			finPenaltyTaxPercentage = finPenaltyTaxMapPojo.getPercentageValue();
			finPenltyTaxId = finPenaltyTaxMapPojo.getFinTaxMappingId();
			
			FinPenaltyTaxPojo finInterestRatesPojo = finPenaltyTaxMapPojo;
			int days = 0;
			if(gstRateIndex==0&&finPenaltyTaxDetailsList.size()==1) {
				gstStartDate = finPenalityInfo.getStartDate();//mileStoneInfo.getMileStoneDueDate();
				gstEndDate = finPenalityInfo.getEndDate();//mileStoneInfo.getMileStonePaidDate();
				days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(gstStartDate),TimeUtil.removeTimePartFromTimeStamp1(gstEndDate));
			} else if (gstRateIndex == (finPenaltyTaxDetailsList.size() - 1)) {
					//flag  = employeeFinancialServiceDao.checkTheDateBetweenTheDates(mileStoneInfo,finInterestRatesPojo);
					gstStartDate = finInterestRatesPojo.getStartDate();
					gstEndDate = finPenalityInfo.getEndDate();//mileStoneInfo.getMileStonePaidDate();
					days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(gstStartDate),TimeUtil.removeTimePartFromTimeStamp1(gstEndDate));
			} else {
				//flag  = employeeFinancialServiceDao.checkTheDateBetweenTheDates(finPenalityInfo,finInterestRatesPojo);
				if(gstRateIndex==0) {//flag&&
					gstStartDate = finPenalityInfo.getStartDate();
					gstEndDate = finInterestRatesPojo.getEndDate();
					days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(gstStartDate),TimeUtil.removeTimePartFromTimeStamp1(gstEndDate));
				} else if(gstRateIndex == (finPenaltyTaxDetailsList.size() - 1)){//flag&&
					gstStartDate = finInterestRatesPojo.getStartDate();
					gstEndDate = finPenalityInfo.getEndDate();
					days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(gstStartDate),TimeUtil.removeTimePartFromTimeStamp1(gstEndDate));
				} else {
					gstStartDate = finInterestRatesPojo.getStartDate();
					gstEndDate = finInterestRatesPojo.getEndDate();
					days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(gstStartDate),TimeUtil.removeTimePartFromTimeStamp1(gstEndDate));	
				}
			}
			days += includeEndDateInCalculation;//including end date in calculation
			sumofgstDays+=days;
			//again calculating interest amount for GST amount, and on interest amount calculating GST amount,
			//based on Gst days
			penaltyAmount = (((finPenalityInfo.getInterestCalculationOnAmount()) * days * finPenalityInfo.getInterestPercentage()) / 100d) / 365d;
			penaltyAmount = roundOffAmount(penaltyAmount);
			taxAmount = (penaltyAmount / 100) * finPenaltyTaxPercentage;
			//System.out.println(taxAmount);
			
			penaltyTaxMappingPojo = new FinPenaltyTaxMappingPojo();

			penaltyTaxMappingPojo.setGstStartDate(TimeUtil.removeTimePartFromTimeStamp1(gstStartDate));
			penaltyTaxMappingPojo.setGstEndDate(TimeUtil.removeTimePartFromTimeStamp1(gstEndDate));
			penaltyTaxMappingPojo.setAmount(taxAmount);//only tax amount
			penaltyTaxMappingPojo.setFinTaxMapingId(finPenltyTaxId);
			penaltyTaxMappingPojo.setGstCalculationOnAmount(penaltyAmount);//Storing basic amount
			penaltyTaxMappingPojo.setTotalInterestAmount(penaltyAmount+taxAmount);//Storing basic amount+tax amount
			penaltyTaxMappingPojo.setDaysDifference(days);
			pojoTaxMapping.add(penaltyTaxMappingPojo);//holding all the tax details in list
			
			sumOfTaxAmount +=taxAmount;
		}
		if(sumofgstDays!=finPenalityInfo.getDaysDifference()) {
			log.info("Gst Days and Penalty Days Got Mismatch...! exception thrown...");
			throw new EmployeeFinancialServiceException("GST and Rate of interest days got mismatch...");
		}
		return sumOfTaxAmount;
	}
//https://cleartax.in/s/gst-return-late-fees
	private double calCulateDemandNoteBasicMileStoneAmountWithGst(@NotNull Double basicMileStoneAmount,Double percentageValue) {
		double mileStoneAmountWithGst = (basicMileStoneAmount / 100) * percentageValue;
		return mileStoneAmountWithGst;
	}

	private Double calCulateDemandNoteBasicMileStoneAmount(@NotNull List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails,
			FinancialProjectMileStoneInfo finProjDemandNoteInfo) {
		log.info(finProjDemandNoteInfo.getMileStoneNo()+" ***** Control inside the EmployeeFinancialServiceImpl.calCulateDemandNoteBasicMileStoneAmount() *****");
		FinBookingFormAccountSummaryPojo bookingFormAccountSummaryPojo = listOfBookingAccountSummaryDetails.get(0);
		Double basicAmount = bookingFormAccountSummaryPojo.getPayableAmount();//basic amount of the flat
		double mileStonePercentage = finProjDemandNoteInfo.getMileStonePercentage();//milestone percentage 
		double basicMileStoneAmount = (basicAmount / 100) * mileStonePercentage;
		return basicMileStoneAmount;
	}
 
	private void saveBookingFormDemandNoteDetails(@NotNull FinancialProjectMileStoneInfo finProjDemandNoteInfo, 
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo, HashMap<Long, Long> bookingFormIds,
			Map<Long, List<FinancialProjectMileStonePojo>> flatPreviousMilestoneNonPaidData, EmployeeFinancialServiceInfo employeeFinancialDemandNoteInfo) 
			throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.saveBookingFormDemandNoteDetails() *****");
		List<String> errorMsgs = new ArrayList<String>();
		Timestamp milestonePaidDate = null;
		int result = 0;
		boolean isThisDummyMilestone = (finProjDemandNoteInfo.getMilestoneName()!=null && finProjDemandNoteInfo.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note"));
		boolean isThisMsWithInterest = (isNotEmptyObject(finProjDemandNoteInfo.getInterestSelectionType()) && finProjDemandNoteInfo.getInterestSelectionType().equals(Status.With_Interest.getStatus()));
		boolean isReGeneratedDemandNote = finProjDemandNoteInfo.isReGenerateDemandNote();
		if(isThisMsWithInterest) {
			finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.PENDING.getStatus() ,Status.PAID.getStatus(), Status.INPROGRESS.getStatus()}));	
		} else {
			finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.PENDING.getStatus(), Status.INPROGRESS.getStatus()}));
		}
		
		finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()}));

		@SuppressWarnings("unused")
		Long finBookingFormMilestonesId = 0l, finBookingFormDemandNoteId = 0L, finBookingFormDemandNoteTaxMapId;
		Double basicMileStoneAmount = 0D;
		List<FinBookingFormMstSchTaxMapInfo> bokFrmDemNteSchTaxMapInfos = new ArrayList<FinBookingFormMstSchTaxMapInfo>();
		 customerPropertyDetailsInfo.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
		 //loading payble amount(balance amount)
		List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo);
		//loading customer scheme
		List<FinSchemeTaxMappingPojo> schemeTaxDetails = employeeFinancialServiceDao.getFlatBookDetailsSchemeTaxDetails(customerPropertyDetailsInfo,finProjDemandNoteInfo);
		if(schemeTaxDetails.isEmpty() && !isThisDummyMilestone) {
			flatPreviousMilestoneNonPaidData.remove(customerPropertyDetailsInfo.getFlatBookingId());
			//errorMsgs.add("Scheme details not found Please update the GST for Flat No : "+customerPropertyDetailsInfo.getFlatNo());
			log.error("On flat scheme details not found, Please update the scheme for Flat No : "+customerPropertyDetailsInfo.getFlatNo());
			throw new EmployeeFinancialServiceException("Scheme details not found, Please update the scheme for Flat No : "+customerPropertyDetailsInfo.getFlatNo());
		}
		if (!listOfBookingAccountSummaryDetails.isEmpty()) {
			basicMileStoneAmount = calCulateDemandNoteBasicMileStoneAmount(listOfBookingAccountSummaryDetails,finProjDemandNoteInfo);	
		} else {
			errorMsgs.add("Error occurred while saving loading flat cost from the database, no record found!");
			log.error("Error occurred while saving loading flat cost from the database, no record found!");
			throw new InSufficeientInputException(errorMsgs);
		}
		
		//Double interestPercentage = finProjDemandNoteInfo.getInterestPercentage();
		double totalInterestAmount=0.0;
		finProjDemandNoteInfo.setCondition("GenerateDemandNote");
		List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount = null;
		finProjDemandNoteInfo.setInterestCalculationFrom("Demand Note");
		if (isThisMsWithInterest) {
			listOfPendingMileStoneAmount = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
			processPenaltyAmount(listOfPendingMileStoneAmount,finProjDemandNoteInfo,totalInterestAmount,"insertInterestData","",new HashMap<String,Object>());
		}
		
		if(isReGeneratedDemandNote && Util.isEmptyObject(listOfPendingMileStoneAmount) && !isThisDummyMilestone) {
			finProjDemandNoteInfo.setCondition("PREVIEW_DEMAND_NOTES");
			listOfPendingMileStoneAmount = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
			if(Util.isEmptyObject(listOfPendingMileStoneAmount)) {
				//if this is regenerate demand note, and list is empty then do not process next lines
				return;
			}
		}
		
		//this method will calculate GST amount on basic milestone amount 
		processSchemeDetails(schemeTaxDetails,basicMileStoneAmount,finProjDemandNoteInfo,bokFrmDemNteSchTaxMapInfos,customerPropertyDetailsInfo);		//this code for multiple schemes
		
		FinBookingFormDemandNotePojo bookingFormDemandNotePojo=null;
		if(!isThisDummyMilestone) {//if this is not default object or dummy object		
			if(!bookingFormIds.containsKey(customerPropertyDetailsInfo.getFlatBookingId())) {//if this flat booking id not present in list
				finBookingFormDemandNoteId = employeeFinancialServiceDao.getNoOfCompletedMileStone(customerPropertyDetailsInfo);	
				String formatted = String.format("%03d", finBookingFormDemandNoteId);
				String demandNoteNo = "DN"+formatted;
				if(isReGeneratedDemandNote) {
					demandNoteNo = "RDN"+formatted;

					FinancialProjectMileStoneInfo demandNoteInfo = new FinancialProjectMileStoneInfo();
					demandNoteInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
					demandNoteInfo.setStatusId(Status.ACTIVE.getStatus());
					demandNoteInfo.setProjectMilestoneId(finProjDemandNoteInfo.getProjectMilestoneId());
					demandNoteInfo.setInterestSelectionType(Status.With_Out_Interest.getStatus());
					
					List<FinBookingFormDemandNotePojo> demandNoteDetails = employeeFinancialServiceDao.getMilestoneDemandNoteId(demandNoteInfo);
					if(Util.isNotEmptyObject(demandNoteDetails)) {
						if (isNotEmptyObject(finProjDemandNoteInfo.getInterestSelectionType()) && finProjDemandNoteInfo.getInterestSelectionType().equals(Status.With_Interest.getStatus())) {
							BeanUtils.copyProperties(finProjDemandNoteInfo, demandNoteInfo);								
							employeeFinancialServiceDao.updateDemandNoteDetails(demandNoteDetails.get(0),demandNoteInfo);
						}
					}
				}
				
				bookingFormDemandNotePojo = (FinBookingFormDemandNotePojo) financialMapper.copyPropertiesToFinBookingFormDemandNotePojo(finProjDemandNoteInfo,employeeFinancialDemandNoteInfo,customerPropertyDetailsInfo,FinBookingFormDemandNotePojo.class);
				bookingFormDemandNotePojo.setDemandNoteNo(demandNoteNo);
				bookingFormDemandNotePojo.setFinBookingFormDemandNoteId(finBookingFormDemandNoteId);
				//inserting demand note amount and holding the demand note table id
				finBookingFormDemandNoteId = employeeFinancialServiceDao.insertDataIntoFinBookingFormDemandNote(bookingFormDemandNotePojo);
				finProjDemandNoteInfo.setFinBookingFormDemandNoteId(finBookingFormDemandNoteId);
				bookingFormIds.put(customerPropertyDetailsInfo.getFlatBookingId(), finBookingFormDemandNoteId);
			} else {
				if(bookingFormIds.containsKey(customerPropertyDetailsInfo.getFlatBookingId())) {
					finProjDemandNoteInfo.setFinBookingFormDemandNoteId(bookingFormIds.get(customerPropertyDetailsInfo.getFlatBookingId()));
					bookingFormDemandNotePojo=(FinBookingFormDemandNotePojo) financialMapper.copyPropertiesToFinBookingFormDemandNotePojo(finProjDemandNoteInfo,employeeFinancialDemandNoteInfo, customerPropertyDetailsInfo,FinBookingFormDemandNotePojo.class);
					//if demand note is generated at current demand note generation time, then updating the demand note amount
					employeeFinancialServiceDao.updateDataIntoFinBookingFormDemandNote(bookingFormDemandNotePojo);
				}
			}
			
			long statusForMilestone = 0;
			if(Util.isNotEmptyObject(finProjDemandNoteInfo.getDemandNoteSelectionType()) && finProjDemandNoteInfo.getDemandNoteSelectionType().equalsIgnoreCase(FinEnum.SEND_SINGLE_MULTIPLE.getName())) {
				//statusForMilestone = Status.ACTIVE.getStatus();
				//if flat wise milestone generating then not updating milestone status
			} else {
				//changing milestone status to completed
				if(finProjDemandNoteInfo.getCurrentprojectMileStoneIds()!=null && finProjDemandNoteInfo.getCurrentprojectMileStoneIds().contains(finProjDemandNoteInfo.getProjectMilestoneId())) {
					statusForMilestone = Status.MS_COMPLETED.getStatus();
				}
			}
			if(Util.isNotEmptyObject(isReGeneratedDemandNote) && !isReGeneratedDemandNote) {
				if(statusForMilestone!=0)
					employeeFinancialServiceDao.updateProjectMilestoneStatus(finProjDemandNoteInfo,statusForMilestone);
			}
			FinBookingFormMilestonesPojo mileStonePojo = (FinBookingFormMilestonesPojo) financialMapper.copyPropertiesToFinBookingFormMileStonePojo(finProjDemandNoteInfo, customerPropertyDetailsInfo, FinBookingFormMilestonesPojo.class);
			//system generated record()receipt time entry record
			FinancialProjectMileStonePojo explicitGeneratedRecord = finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo();
			if(Util.isNotEmptyObject(finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo()) && Util.isNotEmptyObject(finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo().getFinBookingFormMilestonesId())) {
				//if this condition execute, means already record is created for current running milestone, so just updating the details
				mileStonePojo.setFinBookingFormMilestonesId(finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo().getFinBookingFormMilestonesId());
				//already record is created for milestone at the time of receipt entry, so only updayting total amount and created date and etc.
				result = employeeFinancialServiceDao.updateDataIntoFinBookingFormMilestones(mileStonePojo);
				if(result!=1) {
					throw new EmployeeFinancialServiceException("Failed to update record for Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" and  Mile Stone Name : "+finProjDemandNoteInfo.getMilestoneName());
				}
				finBookingFormMilestonesId = finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo().getFinBookingFormMilestonesId();
			}else {
				finBookingFormMilestonesId = employeeFinancialServiceDao.insertDataIntoFinBookingFormMilestones(mileStonePojo);
				
			}
			finProjDemandNoteInfo.setFinBookingFormMilestonesId(finBookingFormMilestonesId);
			
			FinBookingFormMilestoneTaxPojo bookingFormMilestoneTaxPojo = (FinBookingFormMilestoneTaxPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finProjDemandNoteInfo, FinBookingFormMilestoneTaxPojo.class);
			//storing scheme tax amount like 5% on milestone basic amount
			Long bookingFormMileStoneTaxId = employeeFinancialServiceDao.saveDataIntoBookingFormMilestoneTax(bookingFormMilestoneTaxPojo);
			finProjDemandNoteInfo.setFinBookingFormMileStoneTaxId(bookingFormMileStoneTaxId);
		
		//*****************************************************
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
			if(!isReGeneratedDemandNote) {//if not regenerate demand note
				customerPropertyDetailsInfo2.setType(MetadataId.FIN_BOOKING_FORM_MILESTONE_TAX.getId());
				customerPropertyDetailsInfo2.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
				//loading flat basic amount
				listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);
				FinBookingFormAccountSummaryPojo accSummaryPojo = (FinBookingFormAccountSummaryPojo)financialMapper.copyPropertiesFromInfoBeanToPojoBean(mileStonePojo,FinBookingFormAccountSummaryPojo.class);
				accSummaryPojo.setType(MetadataId.FIN_BOOKING_FORM_MILESTONE_TAX.getId());
				accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
				if(!listOfBookingAccountSummaryDetails.isEmpty()) {
					//every time amount will update at the time of milestone generation
					employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
				} else {
					//storing milestone tax amount 
					employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
					
					accSummaryPojo = (FinBookingFormAccountSummaryPojo)financialMapper.copyPropertiesFromInfoBeanToPojoBean(mileStonePojo,FinBookingFormAccountSummaryPojo.class);
					accSummaryPojo.setType(MetadataId.FIN_PENALTY.getId());
					accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
					accSummaryPojo.setPayableAmount(0d);
				    accSummaryPojo.setBalanceAmount(0d);
					employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
				}
			}
		//*****************************************************
		
		FinBookingFormAccountsPojo finBookingFormAccountsPojo = null;
		Long bookingFromAccountId = 0L;
		
		if(Util.isEmptyObject(finProjDemandNoteInfo.getMileStoneDueDate())) {
			throw new EmployeeFinancialServiceException("Milestone due date found empty for Flat No : "+customerPropertyDetailsInfo.getFlatNo()+", Mile Stone Name : "+finProjDemandNoteInfo.getMilestoneName());
		}
		// if(count==0) {
		FinBookingFormAccountsInfo accountsInfo = new FinBookingFormAccountsInfo();
		if(!isReGeneratedDemandNote) {
			finBookingFormAccountsPojo = financialMapper.copyPropertiesToFinBookingFormAccountsPojo(finProjDemandNoteInfo,new FinPenalityInfo(), FinBookingFormAccountsPojo.class, "MileStoneBasicAmt");
			finBookingFormAccountsPojo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
			//is system generated record found then only updating the total amount and created date etc...
			if(Util.isNotEmptyObject(finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo()) && Util.isNotEmptyObject(finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo().getFinBookingFormAccountsId())) {
				//if this condition execute, means already record is created for current running milestone, so just updating the details
				finBookingFormAccountsPojo.setFinBookingFormAccountsId(finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo().getFinBookingFormAccountsId());
				
				milestonePaidDate = finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo().getMileStonePaidDate()==null?null:TimeUtil.removeTimePartFromTimeStamp1(finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo().getMileStonePaidDate());
				if(finProjDemandNoteInfo.getMileStoneDueDate()!=null && milestonePaidDate!=null && milestonePaidDate.after(finProjDemandNoteInfo.getMileStoneDueDate())) {
					finBookingFormAccountsPojo.setIsInterestApplicable(Status.YES.getStatus());
					//if this condition execute, means customer amount paid after the due date of milestone
					//,so interest should be calculated
				}
				//updating account details if records is generated at the time of receipt entry
				result = employeeFinancialServiceDao.updateFinBookingFormAccounts(finBookingFormAccountsPojo);
				
				if(result!=1) {
					throw new EmployeeFinancialServiceException("Failed to update record for Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" and  Mile Stone Name : "+finProjDemandNoteInfo.getMilestoneName());
				}
				bookingFromAccountId = finProjDemandNoteInfo.getExplicitGeneratedRecordMileStonePojo().getFinBookingFormAccountsId();
			} else {
				bookingFromAccountId = employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
			}
		}else {
			//bookingFromAccountId = employeeFinancialServiceDao.updateFinBookingFormAccounts(finBookingFormAccountsPojo);
		}
		if(!isReGeneratedDemandNote) {
			FinBookingFormTdsDetailsPojo bookingFormTdsDetailsPojo = (FinBookingFormTdsDetailsPojo) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(finBookingFormAccountsPojo, FinBookingFormTdsDetailsPojo.class);
			bookingFormTdsDetailsPojo.setTdsStatusId(Status.PENDING.getStatus());
			employeeFinancialServiceDao.savefinBookingFormTdsDetails(bookingFormTdsDetailsPojo);
		
			accountsInfo = (FinBookingFormAccountsInfo) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(finProjDemandNoteInfo, FinBookingFormAccountsInfo.class);
			accountsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
			accountsInfo.setFinBookingFormAccountsId(bookingFromAccountId);
			customerPropertyDetailsInfo2.setCondition("PaymentRefund");
			
			double paidAmount = 0.0;
			double payAmount = finProjDemandNoteInfo.getMileStoneTotalAmount()==null?0d:new BigDecimal(finProjDemandNoteInfo.getMileStoneTotalAmount()).setScale(roundingModeSize, roundingMode).doubleValue();

			if(Util.isNotEmptyObject(explicitGeneratedRecord)) {
				Long msStatusId = explicitGeneratedRecord.getMsStatusId();
				 if(msStatusId!=null && msStatusId.equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
					 //finProjDemandNoteInfo.setPaidAmount(explicitGeneratedRecord.getPaidAmount()==null?0d:explicitGeneratedRecord.getPaidAmount());
					 paidAmount = explicitGeneratedRecord.getPaidAmount()==null?0d:new BigDecimal(explicitGeneratedRecord.getPaidAmount()).setScale(roundingModeSize, roundingMode).doubleValue();
					 //payAmount = finProjDemandNoteInfo.getMileStoneTotalAmount()==null?0d:new BigDecimal(finProjDemandNoteInfo.getMileStoneTotalAmount()).setScale(roundingModeSize, roundingMode).doubleValue();
				 }
			}
			
			if (paidAmount < payAmount) {
				List<FinBookingFormExcessAmountPojo> listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2,Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()));
				if(!listOfExcessAmount.isEmpty()) {
					processExcessAMount(listOfExcessAmount,accountsInfo,finProjDemandNoteInfo,customerPropertyDetailsInfo,finBookingFormAccountsPojo, "MileStoneBasicAmt",true);
				}
			}
		}

		for (FinBookingFormMstSchTaxMapInfo finBokFrmDemNteSchTaxMapInfo : bokFrmDemNteSchTaxMapInfos) {
			finBokFrmDemNteSchTaxMapInfo.setFinBookingFormMileStoneTaxId(bookingFormMileStoneTaxId);
			FinBokFrmDemNteSchTaxMapPojo finBokFrmDemNteSchTaxMapPojo = financialMapper.finBokFrmDemNteIdAndfinSchTaxMapIdToFinBokFrmDemNteSchTaxMapPojo(finBokFrmDemNteSchTaxMapInfo);
			Long finBokFrmDemNteSchTaxMapId = employeeFinancialServiceDao.saveFinBokFrmDemNteSchTaxMap(finBokFrmDemNteSchTaxMapPojo);
			finBokFrmDemNteSchTaxMapInfo.setFinBokFrmMstSchTaxMapId(finBokFrmDemNteSchTaxMapId);
		}
	}
		if(!isThisDummyMilestone) {
			finProjDemandNoteInfo.setCondition("PREVIEW_DEMAND_NOTES");
			if("Interest_Letter".equalsIgnoreCase(employeeFinancialDemandNoteInfo.getActionUrl())) {
				finProjDemandNoteInfo.setCondition(employeeFinancialDemandNoteInfo.getActionUrl());	
				finProjDemandNoteInfo.setCurrentprojectMileStoneIds(employeeFinancialDemandNoteInfo.getCurrentprojectMileStoneIds());
			}// else {
				listOfPendingMileStoneAmount = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
				//storing in map object, current processing milestone flatBookId, and it will be used in preview method
				flatPreviousMilestoneNonPaidData.put(customerPropertyDetailsInfo.getFlatBookingId(), listOfPendingMileStoneAmount);
			//}
		}
	}

	/**
	 * In case interest is not caluclated and not stored db, so using these method interest calculating and storing
	 */
	private void insertPenaltyData(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, EmployeeFinancialServiceInfo employeeFinancialRequest,
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo) throws Exception {
		List<FinBookingFormExcessAmountPojo> listOfPenaltyExcessAmount = new ArrayList<>();
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
		employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
		if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos= employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
				transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
			}
		}
		customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
		//taking all the requested milestone for interest waiver
		List<FinancialProjectMileStoneInfo> milestoneRequest = employeeFinancialRequest.getFinancialProjectMileStoneRequests();
		for (FinancialProjectMileStoneInfo finProjDemandNoteInfo : milestoneRequest) {
			Map<String, Object> mileStoneDetailsList = new HashMap<>();
			//FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
			List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount = null;
			finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] { Status.PENDING.getStatus(), Status.PAID.getStatus(), Status.INPROGRESS.getStatus() }));
			finProjDemandNoteInfo.setType(Arrays.asList(new Long[] { MetadataId.FIN_BOOKING_FORM_MILESTONES.getId() }));

			double totalInterestAmount = 0.0;
			finProjDemandNoteInfo.setCondition("GenerateDemandNote");
			// List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount = null;
			finProjDemandNoteInfo.setInterestCalculationFrom("Demand Note");
			finProjDemandNoteInfo.setInterestCalculationUptoDate(TimeUtil.removeOneDay(new Timestamp(new Date().getTime())));
			finProjDemandNoteInfo.setInterestSelectionType(Status.With_Interest.getStatus());
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
			customerPropertyDetailsInfo2.setType(MetadataId.FIN_PENALTY.getId());
			customerPropertyDetailsInfo2.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
			customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_PENALTY.getName());
			customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());
			if(listOfPenaltyExcessAmount.isEmpty()) {
				listOfPenaltyExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2,Arrays.asList(MetadataId.FIN_PENALTY.getId()));
				mileStoneDetailsList.put(MetadataId.FIN_PENALTY.getName(),listOfPenaltyExcessAmount);
			}
			
			// calculating interest amount
			listOfPendingMileStoneAmount = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
			processPenaltyAmount(listOfPendingMileStoneAmount, finProjDemandNoteInfo, totalInterestAmount,"insertInterestData", "", mileStoneDetailsList);
		}
	}
	
	/**
	 * validating interest calculation completed or not
	 * Used this method in Edit milestone, interest calculation report
	 * @param employeeFinancialServiceInfo
	 * @return
	 * @throws Exception
	 */
	@Transactional(propagation=Propagation.REQUIRED, rollbackFor=Exception.class)
	private List<Object> validatePenaltyCalcultionCompleted(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) throws Exception {
		Timestamp msDueDate = null;
		Timestamp msPaidDate = null;
		Timestamp statementPrevPaidDate = null;
		Timestamp penaltyStatisticsEndDate = null;
		long isInterestApplicable = 0;
		long isInterestCalcCompleted = 0;
		double balanceAmount = 0.0;
		double payAmount = 0.0;
		double paidAmount = 0.0;
		double excessAmount = 0.0;
		List<String> errorMsgs = new ArrayList<>();
		FinancialProjectMileStoneInfo finProjDemandNoteInfo = null;
		FinancialProjectMileStonePojo financialProjectMileStonePojo = null;
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = null;
		//FinPenaltyStatisticsPojo penaltyStatisticsPojo = null;
		FinPenaltyPojo penaltyPojo = null;
		//List<FinPenaltyStatisticsPojo> penaltyStatisticsPojos = null;
		//CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		FinBookingFormAccountsInfo bookingFormAccountsInfo = null;
		List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = null;
		List<FinBookingFormAccountsStatementPojo> accountsStatementPojos = null;
		List<FinBookingFormAccountsPojo> finBookingFormAccountsInterestPojos = null;
		if (Util.isEmptyObject(employeeFinancialServiceInfo.getCustomerPropertyDetailsPojoList())) {
			//customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);			
			//employeeFinancialServiceInfo.setCustomerPropertyDetailsPojoList(customerPropertyDetailsPojoList);
		} else {
			customerPropertyDetailsPojoList = employeeFinancialServiceInfo.getCustomerPropertyDetailsPojoList();
		}
		if (Util.isNotEmptyObject(customerPropertyDetailsPojoList)) {
			for (CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList) {
				//customerPropertyDetailsInfo = financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
				
				bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
				bookingFormAccountsInfo.setBookingFormId(customerPropertyDetailsPojo.getFlatBookingId());
				bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
				bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()));
				bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
				
				//here loading all the Milestone Payment Details using customer FlatBookingId
				bookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
				for(FinBookingFormAccountsPojo bookingFormAccountsPojo : bookingFormAccountsPojoLists) {
					msDueDate = null;	msPaidDate = null;	statementPrevPaidDate = null;
					penaltyStatisticsEndDate = null;	isInterestApplicable = 0;	isInterestCalcCompleted = 0;
					balanceAmount = 0.0;	payAmount = 0.0;	paidAmount = 0.0;
					excessAmount = 0.0;
					finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
					financialProjectMileStonePojo = new FinancialProjectMileStonePojo();
					bookingFormAccountsPojo.setModifiedBy(employeeFinancialServiceInfo.getEmpId());
					bookingFormAccountsPojo.setCreatedBy(employeeFinancialServiceInfo.getEmpId());
					
					balanceAmount = bookingFormAccountsPojo.getBalanceAmount();
					payAmount = bookingFormAccountsPojo.getPayAmount();
					paidAmount = bookingFormAccountsPojo.getPaidAmount();
					excessAmount = roundOffAmount(payAmount-paidAmount);
					if(excessAmount!=balanceAmount) {
						//throw new EmployeeFinancialServiceException("Balance Amount and paid amount is not matching... "+bookingFormAccountsPojo.getBookingFormId());
					}

					//loading all the statement record's of the milestone
					accountsStatementPojos = employeeFinancialServiceDao.getBookingFormAccountsStatementAndReceiptData(bookingFormAccountsPojo, FinEnum.ASC);
					
					msDueDate = bookingFormAccountsPojo.getMileStoneDueDate()==null ? null : TimeUtil.removeTimePartFromTimeStamp1(bookingFormAccountsPojo.getMileStoneDueDate());
					msPaidDate = bookingFormAccountsPojo.getPaidDate()==null ? null : TimeUtil.removeTimePartFromTimeStamp1(bookingFormAccountsPojo.getPaidDate());
					
					if (Util.isNotEmptyObject(accountsStatementPojos)) {
						//bookingFormAccountsPojo.setPaidDate(accountsStatementPojos.get(0).getPaidDate());
						for(FinBookingFormAccountsStatementPojo accountsStatementPojo : accountsStatementPojos) {
							//checking is any payment is not adjusted properly to milestones
							if(statementPrevPaidDate!=null && accountsStatementPojo.getPaidDate().before(statementPrevPaidDate)) {
								//current paid date should not be before the msPrevPaidDate value
								//throw new EmployeeFinancialServiceException("Transaction has not been set off properly For flat No : "+customerPropertyDetailsPojo.getFlatNo()+", Please contact support team.");
								errorMsgs.add("Transaction has not been set off properly For flat No : "+customerPropertyDetailsPojo.getFlatNo()+" ID "+bookingFormAccountsPojo.getFinBokAccInvoiceNo()+", Please contact support team.");
							}
							statementPrevPaidDate = accountsStatementPojo.getPaidDate();
						}
					} else {
						bookingFormAccountsPojo.setPaidDate(null);
					}
					
					if(msDueDate!=null && msPaidDate!=null && msPaidDate.after(msDueDate)) {
						isInterestApplicable = Status.YES.getStatus();//if this condition execute, means customer amount paid after the due date of milestone
						//,so interest should be calculated
					}
					
					finProjDemandNoteInfo.setFinBookingFormMilestonesId(bookingFormAccountsPojo.getTypeId());
					finProjDemandNoteInfo.setBookingFormId(bookingFormAccountsPojo.getBookingFormId());
					finProjDemandNoteInfo.setStatusId(Status.ACTIVE.getStatus());
					//loasing milestone penalty records
					finBookingFormAccountsInterestPojos = employeeFinancialServiceDao.getFinPenaltyDetailsForInterestWaiver(finProjDemandNoteInfo);
					if (Util.isNotEmptyObject(finBookingFormAccountsInterestPojos)) {
						FinBookingFormAccountsPojo penaltyRecordPaidAmtDetails = finBookingFormAccountsInterestPojos.get(0);
						financialProjectMileStonePojo.setTypeId(penaltyRecordPaidAmtDetails.getTypeId());
						financialProjectMileStonePojo.setType(penaltyRecordPaidAmtDetails.getType());
						if(penaltyRecordPaidAmtDetails.getPaidAmount()>penaltyRecordPaidAmtDetails.getPayAmount()) {
							//if paid amount is more than pay amount, then move the amount to excess amount
							log.info("EmployeeFinancialServiceImpl.validatePenaltyCalcultionCompleted() "+penaltyRecordPaidAmtDetails.getPaidAmount()+" "+penaltyRecordPaidAmtDetails.getPayAmount());
							//penaltyRecordPaidAmtDetails.setStatusId(Status.ACTIVE.getStatus());
							penaltyRecordPaidAmtDetails.setModifiedBy(employeeFinancialServiceInfo.getEmpId());
							penaltyRecordPaidAmtDetails.setCreatedBy(employeeFinancialServiceInfo.getEmpId());
							
							//putExtraAdjustedAmountInExcessAmount(penaltyRecordPaidAmtDetails);//method
							
							bookingFormAccountsInfo  = new FinBookingFormAccountsInfo();
							bookingFormAccountsInfo.setType(MetadataId.FIN_PENALTY.getId());
							bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.FIN_PENALTY.getId()));
							bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
							bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
							bookingFormAccountsInfo.setCreatedBy(employeeFinancialServiceInfo.getEmpId());
							
							//checking any excess amount found for interest records
							putExtraAdjustedAmountInExcessAmount(Arrays.asList(bookingFormAccountsPojo.getBookingFormId()),bookingFormAccountsInfo);
							
						}
						//loading milestone penalty statistics records
						List<FinPenaltyPojo> penaltyPojos = employeeFinancialServiceDao.getFinPenaltyDetails(bookingFormAccountsPojo);
						//penaltyStatisticsPojos = employeeFinancialServiceDao.loadPenaltyStatisticsData(financialProjectMileStonePojo);
						if (Util.isNotEmptyObject(penaltyPojos)) {
							penaltyPojo = penaltyPojos.get(penaltyPojos.size()-1);
							penaltyStatisticsEndDate = penaltyPojo.getEndDate();
							//adding one day from end date of statistics, as we are not calculating interest upto the amount paid date,
							//calculating amount (paid date - 1) day
							penaltyStatisticsEndDate = TimeUtil.addOneDay(TimeUtil.removeTimePartFromTimeStamp1(penaltyStatisticsEndDate));
							msPaidDate = msPaidDate == null ? null : TimeUtil.removeTimePartFromTimeStamp1(msPaidDate);
							if(msDueDate!=null && msPaidDate!=null && msPaidDate.equals(penaltyStatisticsEndDate) && balanceAmount == 0) {
								isInterestCalcCompleted = Status.YES.getStatus();
							} else if(msDueDate!=null && msPaidDate!=null && msPaidDate.before(penaltyStatisticsEndDate) && balanceAmount == 0) {
								//if milestone paid date and penalty statistics end date is not equal, then interest has to be re-calculated
								//as milestone paid date and penalty statistics end date should be equal, so that means the interest is calculated correct
								//inActivePenaltyRecord(bookingFormAccountsPojo);
							}
						}//penaltyStatisticsPojos
					}//finBookingFormAccountsInterestPojos
					
					bookingFormAccountsPojo.setIsInterestCalcCompleted(isInterestCalcCompleted);
					bookingFormAccountsPojo.setIsInterestApplicable(isInterestApplicable);
					employeeFinancialServiceDao.updateBookingFormAccountInterestDetails(bookingFormAccountsPojo);
				}
			}
			
			if(Util.isNotEmptyObject(errorMsgs)) {
				throw new EmployeeFinancialServiceException(errorMsgs);	
			}
			
		}//customerPropertyDetailsPojoList
		return null;
	}

	/**
	 * Adding extra adjusted amount to excess amount, so the amount will adjust to next records
	 * @param penaltyRecordPaidAmtDetails
	 * @throws Exception
	 */
	@SuppressWarnings("unused")
	private void putExtraAdjustedAmountInExcessAmountNotInUse(FinBookingFormAccountsPojo penaltyRecordPaidAmtDetails) throws Exception {
		List<FinBookingFormAccountsStatementPojo> accountsStatementPojos = null;
		double payAmount = 0.0;
		double paidAmount = 0.0;
		double excessAmount = 0.0;
		FinBookingFormAccountsPojo bookingFormAccountsPojo = null;

		EmployeeFinancialTransactionServiceInfo transactionServiceInfo = new EmployeeFinancialTransactionServiceInfo();
		transactionServiceInfo.setBookingFormId(penaltyRecordPaidAmtDetails.getBookingFormId());
		transactionServiceInfo.setCreatedBy(penaltyRecordPaidAmtDetails.getCreatedBy());
		accountsStatementPojos = employeeFinancialServiceDao.getBookingFormAccountsStatementAndReceiptData(penaltyRecordPaidAmtDetails, FinEnum.DESC);
		if (Util.isNotEmptyObject(accountsStatementPojos)) {
			FinBookingFormAccountsStatementPojo accountsStatementPojo = accountsStatementPojos.get(0);
			log.info("EmployeeFinancialServiceImpl.putExtraAdjustedAmountInExcessAmount() "+penaltyRecordPaidAmtDetails.getPaidAmount()+" "+penaltyRecordPaidAmtDetails.getPayAmount()+" " +penaltyRecordPaidAmtDetails.getBalanceAmount());
			payAmount = penaltyRecordPaidAmtDetails.getPayAmount();
			paidAmount = penaltyRecordPaidAmtDetails.getPaidAmount();
			excessAmount = roundOffAmount(paidAmount-payAmount);
			
			bookingFormAccountsPojo = new FinBookingFormAccountsPojo();
			bookingFormAccountsPojo.setPaidAmount(excessAmount);
			bookingFormAccountsPojo.setBalanceAmount(excessAmount);
			bookingFormAccountsPojo.setFinBookingFormAccountsId(penaltyRecordPaidAmtDetails.getFinBookingFormAccountsId());
			bookingFormAccountsPojo.setPaymentStatus(Status.PAID.getStatus());
			bookingFormAccountsPojo.setBookingFormId(penaltyRecordPaidAmtDetails.getBookingFormId());
			bookingFormAccountsPojo.setModifiedBy(transactionServiceInfo.getEmployeeId());
			//removing extra adjusted amount from accounts records and putting in excess amount
			employeeFinancialServiceDao.decreaseExtraAdjustedPaidAmount(bookingFormAccountsPojo);
			
			constructExcessAmountPojos(excessAmount, penaltyRecordPaidAmtDetails.getType(), accountsStatementPojo.getFinBookingFormReceiptsId()
					, transactionServiceInfo, "");
		}//accountsStatementPojos
	}

	/**
	 * These method is used in multiple places, receipt entry, generate demand note, regenerate demand note, view interest report, noc validation
	 */
	@SuppressWarnings("unchecked")
	private void processPenaltyAmount(List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount,
			FinancialProjectMileStoneInfo finProjDemandNoteInfoPenalty, double totalInterestAmount, String conditionPenalty,
			String requestFrom1, Map<String, Object> mileStoneDetailsList) throws Exception {
		@SuppressWarnings("unused")
		double donNotCalcInterestBelow = 0d;int days = 0;Timestamp mileStoneDueDate = null;
		boolean shouldContinueThisCondition = false;//long iteration = 0l;
		boolean isPrevPaidAndCurrDateIsSame = false;

		String interestCalculationFrom = finProjDemandNoteInfoPenalty.getInterestCalculationFrom()==null?"":finProjDemandNoteInfoPenalty.getInterestCalculationFrom();
		List<FinPenaltyStatisticsPojo> FinPenaltyStatisticsPojo = new ArrayList<>();
		mileStoneDetailsList.put("penaltyStat", FinPenaltyStatisticsPojo);
		log.info("***** Control inside the EmployeeFinancialServiceImpl.processPenaltyAmount() ***** "+interestCalculationFrom);
		for (int index = 0; index < listOfPendingMileStoneAmount.size(); index++) {
			FinancialProjectMileStonePojo finBookingFormAccountsPojo = listOfPendingMileStoneAmount.get(index);
			log.info("***** Control inside the EmployeeFinancialServiceImpl.finBookingFormAccountsPojo() ***** "+finBookingFormAccountsPojo);
			days = 0; mileStoneDueDate = null;
			if (finProjDemandNoteInfoPenalty.isReGenerateDemandNote()) {
				if (finBookingFormAccountsPojo.getProjectMilestoneId().equals(finProjDemandNoteInfoPenalty.getProjectMilestoneId())) {
					//log.info("EmployeeFinancialServiceImpl.processPenaltyAmount() got same id "+ finProjDemandNoteInfo.getProjectMilestoneId());
					continue;
				}
			}
			//checking interest calculation completed or not if completed then not calculating interest amount again 
			if(Status.YES.getStatus().equals(finBookingFormAccountsPojo.getIsInterestCalcCompleted()) && !interestCalculationFrom.equals("CalculateCustomerInterestBreakUpData")) {
				continue;
			}
			/*if(Arrays.asList(1883l,1884l,1885l,1886l).contains(finBookingFormAccountsPojo.getFinBookingFormAccountsId())) {
				log.info("EmployeeFinancialServiceImpl.processPenaltyAmount() got same id "+ finBookingFormAccountsPojo.getProjectMilestoneId());
			}*/
			mileStoneDueDate = finBookingFormAccountsPojo.getMileStoneDueDate();
			if (Util.isEmptyObject(mileStoneDueDate)) {
				//log.info(" ***** EmployeeFinancialServiceImpl.processPenaltyAmount() mileStoneDueDate IsEmpty ***** "+ finBookingFormAccountsPojo);
				continue;
			}//if due date is 15-05-22 then we are calcuating from 16-05-22
			 mileStoneDueDate = TimeUtil.addOneDay(finBookingFormAccountsPojo.getMileStoneDueDate());//we have to add one day in due date
			 shouldContinueThisCondition = false;//long iteration = 0l;
			 isPrevPaidAndCurrDateIsSame = false;
		if(index< listOfPendingMileStoneAmount.size()-1) {
			@SuppressWarnings("unused")
			FinancialProjectMileStonePojo finBookingFormAccountsPojo1 = listOfPendingMileStoneAmount.get(index+1);
		    
				if (conditionPenalty.equalsIgnoreCase("Preview Demand Note")
						&& !requestFrom1.equals("GenerateDemandNote")
						//&& isEmptyObject(requestFrom1)
						) {
					if (Util.isEmptyObject(finBookingFormAccountsPojo.getTotalPendingPenaltyAmount_Db())) {
						finBookingFormAccountsPojo.setTotalPendingPenaltyAmount_Db(0d);
					}
					
					if (Util.isEmptyObject(finBookingFormAccountsPojo.getTotalDelayedDays_Db())) {
						finBookingFormAccountsPojo.setTotalDelayedDays_Db(0l);
					}
					
					/* Total No of Days Delayed to Pay Amount is used in Interest Letter */
					if(Util.isEmptyObject(finBookingFormAccountsPojo.getDaysDelayed())) {
						finBookingFormAccountsPojo.setDaysDelayed(0l);
					}//already calculated amount stored in getTotalPendingPenaltyAmount_Db this variable, so next time already calculated amount will not calculate again* 
					finBookingFormAccountsPojo.setTotalPendingPenaltyAmount(finBookingFormAccountsPojo.getTotalPendingPenaltyAmount_Db() + 0d);
					finBookingFormAccountsPojo.setDaysDelayed(finBookingFormAccountsPojo.getTotalDelayedDays_Db() + 0l);
				}
			
			//List<FinBookingFormAccountsPojo> list = employeeFinancialServiceDao.getMileStoneDetailsFromAccount(finProjDemandNoteInfo, customerPropertyDetailsInfo,finBookingFormAccountsPojo)
		    //Double payAmount = isEmptyObject(finBookingFormAccountsPojo.getPayAmount())?0.0:finBookingFormAccountsPojo.getPayAmount();
			Double payAmount = finBookingFormAccountsPojo.getMilestonePrincipalAmount()==null?0.0:finBookingFormAccountsPojo.getMilestonePrincipalAmount();
			Double paidAmount = isEmptyObject(finBookingFormAccountsPojo.getPaidAmount())?0.0:finBookingFormAccountsPojo.getPaidAmount();
			Long paymentStatus = finBookingFormAccountsPojo.getPaymentStatus();
			
			Timestamp mileStoneDueDate1 = finBookingFormAccountsPojo.getMileStoneDueDate();
			@SuppressWarnings("unused")
			Timestamp mileStoneCompletedDate = finBookingFormAccountsPojo.getMilestoneDate();
			if(Util.isEmptyObject(mileStoneDueDate1)) {
				//log.info(" ***** EmployeeFinancialServiceImpl.processPenaltyAmount() mileStoneDueDate IsEmpty ***** "+finBookingFormAccountsPojo);
				continue;
			}
			
			Timestamp nextTimestamp = finBookingFormAccountsPojo.getMileStonePaidDate();
			
			if (Util.isNotEmptyObject(nextTimestamp) && paidAmount != 0) {
				if (paymentStatus.equals(Status.PENDING.getStatus())||paymentStatus.equals(Status.INPROGRESS.getStatus())
						||paymentStatus.equals(Status.PAID.getStatus())
						) {
					//days = TimeUtil.differenceBetweenDays(timestamp, nextTimestamp);
					//if(paidAmount==payAmount) { if(days==0) { continue; } } 
					FinBookingFormAccountsPojo bookingFormAccountsPojo  = new FinBookingFormAccountsPojo();
					bookingFormAccountsPojo.setFinBookingFormAccountsId(finBookingFormAccountsPojo.getFinBookingFormAccountsId());
					List<FinBookingFormAccountsStatementPojo> listOfAccountStatementData = employeeFinancialServiceDao.getBookingFormAccountsStatementData(bookingFormAccountsPojo);
					if(listOfAccountStatementData.isEmpty()) {
						if(conditionPenalty.equalsIgnoreCase("Preview Demand Note")
								&& !requestFrom1.equals("GenerateDemandNote")
								//&& isEmptyObject(requestFrom1)
								) {
							listOfAccountStatementData = finBookingFormAccountsPojo.getBookingFormAccountStatementPojo();
						}
					}
					if (listOfAccountStatementData.size() == 0) {
						 //days = TimeUtil.differenceBetweenDays(timestamp, nextTimestamp);
						 //totalInterestAmount += calculateMileStoneDueInterest(finProjDemandNoteInfo,finBookingFormAccountsPojo,totalInterestAmount,payAmount,paidAmount);
					 } else {
						Timestamp tempTimeStamp = mileStoneDueDate;
						Double tempPayAmount = payAmount;
						Double tempPaidAmount = 0D;
						double amountPaidBeforeDueDate = 0d;
						for (int statementDataIndex = 0; statementDataIndex < listOfAccountStatementData.size(); statementDataIndex++) {
							FinBookingFormAccountsStatementPojo accountsStatementPojo = listOfAccountStatementData.get(statementDataIndex);
							//System.out.println(accountsStatementPojo);
							//removoing gst amount from paid amount, as paid amount is included with GST, so for calculartion we require only basic basic paid amount
							excludeGstAmountOnPaidAmount(accountsStatementPojo,finBookingFormAccountsPojo);
							//taking difference from milestone due date and payment received date
							days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp),TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
							FinancialProjectMileStoneInfo mileStoneInfo = new FinancialProjectMileStoneInfo();
							mileStoneInfo.setMileStoneDueDate(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp));
							if(1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finBookingFormAccountsPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()))) {
								//ex if due date is 15-05-22(in due date we are adding one day - 16-05-22) and paid date is 16-05-22, 
								mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
								days = 1;//if milestone due date and paid date difference is one add default add one day
								shouldContinueThisCondition = true;
							}else if(shouldContinueThisCondition && 1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp),TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()))) {
								mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
								days = 1;//if milestone due date and paid date difference is one add default add one day
								shouldContinueThisCondition = true;
							} else {
								shouldContinueThisCondition = false;
								mileStoneInfo.setMileStonePaidDate(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate())));
							}
							//if days* is less than zero means, ms amount paid is before due date 
							if(days<=0) {
								if(statementDataIndex == (listOfAccountStatementData.size() - 1 )) {
									
								}else {
									tempPaidAmount = tempPaidAmount + (accountsStatementPojo.getPaidAmount() == null ? 0 : accountsStatementPojo.getPaidAmount());
									amountPaidBeforeDueDate = amountPaidBeforeDueDate + (accountsStatementPojo.getPaidAmount() == null ? 0 : accountsStatementPojo.getPaidAmount());
									continue;
								}
							}
							if(tempTimeStamp!=null && TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp).equals(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()))) {
								log.info("Same "+tempPaidAmount);
								isPrevPaidAndCurrDateIsSame=true;
							} else {
								isPrevPaidAndCurrDateIsSame=false;
							}
							tempTimeStamp=accountsStatementPojo.getPaidDate();
							mileStoneInfo.setMileStonePayAmount(tempPayAmount);mileStoneInfo.setMileStonePaidAmount(tempPaidAmount);
							//mileStoneInfo.setMileStonePaidBasicAmount(accountsStatementPojo.getPaidAmount()+amountPaidBeforeDueDate);amountPaidBeforeDueDate = 0d;
							if(amountPaidBeforeDueDate!=0) {//it means amount is paid before due date
								mileStoneInfo.setMileStonePaidBasicAmount( amountPaidBeforeDueDate);amountPaidBeforeDueDate = 0d;	
							}else {
								//mileStoneInfo.setMileStonePaidBasicAmount(accountsStatementPojo.getPaidAmount());
							}
							
							totalInterestAmount +=calculateMileStoneDueInterest(finProjDemandNoteInfoPenalty,finBookingFormAccountsPojo,totalInterestAmount,tempPayAmount,tempPaidAmount,mileStoneInfo,conditionPenalty,mileStoneDetailsList);
							
							tempPaidAmount = tempPaidAmount + accountsStatementPojo.getPaidAmount();
							amountPaidBeforeDueDate = accountsStatementPojo.getPaidAmount();
							/*donNotCalcInterestBelow = Double.valueOf(MetadataId.DON_NOT_CALC_INTEREST_BELOW.getName());
							if(tempPayAmount - tempPaidAmount>donNotCalcInterestBelow) {
								log.info(" ***** EmployeeFinancialServiceImpl.processPenaltyAmount() *****"+tempPaidAmount);
							} else {
								log.info(" ***** EmployeeFinancialServiceImpl.processPenaltyAmount() don't calculate interest on it *****"+tempPaidAmount);
								continue;
							}*/
							if(tempPayAmount.intValue() == tempPaidAmount.intValue() ) {//this code is for only interest calc breakup
								List<FinPenaltyStatisticsPojo> msPenaltyStatisticsPojos = finBookingFormAccountsPojo.getPenaltyStatisticsPojos();
								 if(isEmptyObject(msPenaltyStatisticsPojos)) {
									 msPenaltyStatisticsPojos = new ArrayList<>();
									 finBookingFormAccountsPojo.setPenaltyStatisticsPojos(msPenaltyStatisticsPojos);
								 }
								 if(isPrevPaidAndCurrDateIsSame) {
									 
								 }
								 FinPenaltyStatisticsPojo  penaltyStatisticsPojo= new FinPenaltyStatisticsPojo();
								 penaltyStatisticsPojo.setInterestCalculationOnAmount(0d);
								 penaltyStatisticsPojo.setPenaltyAmount(0d);
								 penaltyStatisticsPojo.setPenaltyTaxAmount(0d);
								 penaltyStatisticsPojo.setMileStonePaidBasicAmount(amountPaidBeforeDueDate);//penaltyStatisticsPojo.setMileStonePaidDate(tempTimeStamp);
								 msPenaltyStatisticsPojos.add(penaltyStatisticsPojo);
							}
							//tempPayAmount.doubleValue() != tempPaidAmount.doubleValue()
							if(tempPayAmount != tempPaidAmount && statementDataIndex == (listOfAccountStatementData.size() - 1 )) {
								days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate), TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp));
								if (days<=0) {
									tempTimeStamp = mileStoneDueDate;
								}
								/*days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate), TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp));
								if (days<=0) {
									tempTimeStamp = mileStoneDueDate;
								}*/
								//nextTimestamp = finBookingFormAccountsPojo1.getMilestoneDate();
								//nextTimestamp = finProjDemandNoteInfoPenalty.getMilestoneDate();
								nextTimestamp = finProjDemandNoteInfoPenalty.getInterestCalculationUptoDate();
								if(nextTimestamp==null) {
									finProjDemandNoteInfoPenalty.setInterestCalculationUptoDate(TimeUtil.removeOneDay(new Timestamp(new Date().getTime())));
									nextTimestamp = finProjDemandNoteInfoPenalty.getInterestCalculationUptoDate();
								}
								days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp), TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
								if (days<= 0) {
									continue;
								}
								mileStoneInfo = new FinancialProjectMileStoneInfo();
								mileStoneInfo.setMileStoneDueDate(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp));
								//mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
								if(interestCalculationFrom.equalsIgnoreCase("Receipt")) {
									if(1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
										mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
										days = 1;
										shouldContinueThisCondition = true;
									}else if(shouldContinueThisCondition && 1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
										mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
										days = 1;//if milestone due date and paid date difference is one add default add one day
										shouldContinueThisCondition = true;
									}else {	
										mileStoneInfo.setMileStonePaidDate(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp)));
									}
								} else {
									mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
								}
								mileStoneInfo.setMileStonePayAmount(tempPayAmount);mileStoneInfo.setMileStonePaidAmount(tempPaidAmount);
								totalInterestAmount +=calculateMileStoneDueInterest(finProjDemandNoteInfoPenalty,finBookingFormAccountsPojo,totalInterestAmount,tempPayAmount,tempPaidAmount,mileStoneInfo,conditionPenalty,mileStoneDetailsList);
							}
						}
					 }
				 }
			} else {
				//nextTimestamp = finBookingFormAccountsPojo1.getMilestoneDate();
				if(interestCalculationFrom.equalsIgnoreCase("ReceiptEditDelete") && Util.isEmptyObject(nextTimestamp)) {
				
				}else {					
					//nextTimestamp = finProjDemandNoteInfoPenalty.getMilestoneDate();
					nextTimestamp = finProjDemandNoteInfoPenalty.getInterestCalculationUptoDate();
					if(Util.isEmptyObject(nextTimestamp)) {
						///log.info(" ***** EmployeeFinancialServiceImpl.processPenaltyAmount() getMilestoneDate IsEmpty ***** "+finBookingFormAccountsPojo);
						continue;
					}
					days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate), TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
					if (days<=0) {
						continue;
					}
					FinancialProjectMileStoneInfo mileStoneInfo = new FinancialProjectMileStoneInfo();
					mileStoneInfo.setMileStoneDueDate(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate));

					if(interestCalculationFrom.equalsIgnoreCase("Receipt")) {
						if(1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finBookingFormAccountsPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
							mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
							days = 1;
							shouldContinueThisCondition = true;
						}else if(shouldContinueThisCondition && 1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
							mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
							days = 1;//if milestone due date and paid date difference is one add default add one day
							shouldContinueThisCondition = true;
						}else {
							mileStoneInfo.setMileStonePaidDate(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp)));
						}
					} else {
						mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
					}
					mileStoneInfo.setMileStonePayAmount(payAmount);mileStoneInfo.setMileStonePaidAmount(paidAmount);
					totalInterestAmount +=calculateMileStoneDueInterest(finProjDemandNoteInfoPenalty,finBookingFormAccountsPojo,totalInterestAmount,payAmount,paidAmount,mileStoneInfo,conditionPenalty,mileStoneDetailsList);
				}//ReceiptEditDelete
			}
		}else {
			
		    //Double payAmount = finBookingFormAccountsPojo.getPayAmount()==null?0.0:finBookingFormAccountsPojo.getPayAmount();
		    Double payAmount = finBookingFormAccountsPojo.getMilestonePrincipalAmount()==null?0.0:finBookingFormAccountsPojo.getMilestonePrincipalAmount();
			Double paidAmount = finBookingFormAccountsPojo.getPaidAmount()==null?0.0:finBookingFormAccountsPojo.getPaidAmount();
			Long paymentStatus = finBookingFormAccountsPojo.getPaymentStatus();
			Timestamp nextTimestamp = finBookingFormAccountsPojo.getMileStonePaidDate();
			
			if (Util.isNotEmptyObject(nextTimestamp) && paidAmount != 0) {
				if (paymentStatus.equals(Status.PENDING.getStatus())||paymentStatus.equals(Status.INPROGRESS.getStatus())
						||paymentStatus.equals(Status.PAID.getStatus())
						) {
					FinBookingFormAccountsPojo bookingFormAccountsPojo  = new FinBookingFormAccountsPojo();
					bookingFormAccountsPojo.setFinBookingFormAccountsId(finBookingFormAccountsPojo.getFinBookingFormAccountsId());
					 List<FinBookingFormAccountsStatementPojo> listOfAccountStatementData = employeeFinancialServiceDao.getBookingFormAccountsStatementData(bookingFormAccountsPojo);
						if(listOfAccountStatementData.isEmpty()) {
							if(conditionPenalty.equalsIgnoreCase("Preview Demand Note") 
									&&!requestFrom1.equals("GenerateDemandNote")
									//&& isEmptyObject(requestFrom1)
									) {
								//!requestFrom.equals("GenerateDemandNote")
								listOfAccountStatementData = finBookingFormAccountsPojo.getBookingFormAccountStatementPojo();
							}
						}
					 if(listOfAccountStatementData.size()==0) {
						 //days = TimeUtil.differenceBetweenDays(timestamp, nextTimestamp);
						 //totalInterestAmount +=calculateMileStoneDueInterest(finProjDemandNoteInfo,finBookingFormAccountsPojo,totalInterestAmount,payAmount,paidAmount);
					 }
					 else {
						 Timestamp tempTimeStamp=mileStoneDueDate;
						 Double tempPayAmount=payAmount;
						 Double tempPaidAmount = 0D;
						 double amountPaidBeforeDueDate = 0d;
						 for (int statementDataIndex = 0; statementDataIndex < listOfAccountStatementData.size(); statementDataIndex++) {
								FinBookingFormAccountsStatementPojo accountsStatementPojo = listOfAccountStatementData.get(statementDataIndex);
								excludeGstAmountOnPaidAmount(accountsStatementPojo,finBookingFormAccountsPojo);
								//log.info(accountsStatementPojo);
								days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp), TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
								FinancialProjectMileStoneInfo mileStoneInfo = new FinancialProjectMileStoneInfo();
								mileStoneInfo.setMileStoneDueDate(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp));
								if(1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finBookingFormAccountsPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()))) {
									mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
									days = 1;//if milestone due date and paid date difference is one add default add one day
									shouldContinueThisCondition = true;
								}else if(shouldContinueThisCondition && 1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp),TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()))) {
									mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
									days = 1;//if milestone due date and paid date difference is one add default add one day
									shouldContinueThisCondition = true;
								} else {
									shouldContinueThisCondition = false;
									mileStoneInfo.setMileStonePaidDate(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate())));
								}
								if(days<=0) {
									if (statementDataIndex == (listOfAccountStatementData.size() - 1)) {
										
									} else {
										tempPaidAmount = tempPaidAmount + (accountsStatementPojo.getPaidAmount()==null?0:accountsStatementPojo.getPaidAmount());
										amountPaidBeforeDueDate = amountPaidBeforeDueDate + (accountsStatementPojo.getPaidAmount() == null ? 0 : accountsStatementPojo.getPaidAmount());
										continue;
									}
								}
								tempTimeStamp=accountsStatementPojo.getPaidDate();
								mileStoneInfo.setMileStonePayAmount(tempPayAmount);mileStoneInfo.setMileStonePaidAmount(tempPaidAmount);
								//mileStoneInfo.setMileStonePaidBasicAmount(accountsStatementPojo.getPaidAmount()+amountPaidBeforeDueDate);amountPaidBeforeDueDate = 0d;
								if(amountPaidBeforeDueDate!=0) {//if means amount is before due date
									mileStoneInfo.setMileStonePaidBasicAmount(amountPaidBeforeDueDate);amountPaidBeforeDueDate = 0d;	
								}else {
									//mileStoneInfo.setMileStonePaidBasicAmount(accountsStatementPojo.getPaidAmount());
								}
								totalInterestAmount +=calculateMileStoneDueInterest(finProjDemandNoteInfoPenalty,finBookingFormAccountsPojo,totalInterestAmount,tempPayAmount,tempPaidAmount,mileStoneInfo,conditionPenalty,mileStoneDetailsList);
								
								tempPaidAmount = tempPaidAmount + accountsStatementPojo.getPaidAmount();
								amountPaidBeforeDueDate = accountsStatementPojo.getPaidAmount();
								/*donNotCalcInterestBelow = Double.valueOf(MetadataId.DON_NOT_CALC_INTEREST_BELOW.getName());
								if((tempPayAmount - tempPaidAmount)>donNotCalcInterestBelow) {
									log.info(" ***** EmployeeFinancialServiceImpl.processPenaltyAmount() remain amount *****"+(tempPayAmount - tempPaidAmount));
								} else {
									log.info(" ***** EmployeeFinancialServiceImpl.processPenaltyAmount() don't calculate interest on it *****"+(tempPayAmount - tempPaidAmount));
									continue;
								}*/
								if(tempPayAmount.intValue() == tempPaidAmount.intValue() ) {//this code os for only interest calc breakup
									List<FinPenaltyStatisticsPojo> msPenaltyStatisticsPojos = finBookingFormAccountsPojo.getPenaltyStatisticsPojos();
									 if(isEmptyObject(msPenaltyStatisticsPojos)) {
										 msPenaltyStatisticsPojos = new ArrayList<>();
										 finBookingFormAccountsPojo.setPenaltyStatisticsPojos(msPenaltyStatisticsPojos);
									 }
									 FinPenaltyStatisticsPojo  penaltyStatisticsPojo= new FinPenaltyStatisticsPojo();
									 penaltyStatisticsPojo.setInterestCalculationOnAmount(0d);
									 penaltyStatisticsPojo.setPenaltyAmount(0d);
									 penaltyStatisticsPojo.setPenaltyTaxAmount(0d);
									 penaltyStatisticsPojo.setMileStonePaidBasicAmount(amountPaidBeforeDueDate);
									 msPenaltyStatisticsPojos.add(penaltyStatisticsPojo);
								}
								if(tempPayAmount != tempPaidAmount && statementDataIndex == (listOfAccountStatementData.size()-1)) { 
									days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate), TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp));
									if (days <= 0) {
										tempTimeStamp = mileStoneDueDate;
									}
									/*days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate), TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp));
									if (days<=0) {
										tempTimeStamp = mileStoneDueDate;
									}*/
									//nextTimestamp = finProjDemandNoteInfoPenalty.getMilestoneDate();
									nextTimestamp = finProjDemandNoteInfoPenalty.getInterestCalculationUptoDate();
									if(nextTimestamp == null || tempTimeStamp == null) {
											finProjDemandNoteInfoPenalty.setInterestCalculationUptoDate(TimeUtil.removeOneDay(new Timestamp(new Date().getTime())));
											nextTimestamp = finProjDemandNoteInfoPenalty.getInterestCalculationUptoDate();
									}
									days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp), TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
									
									if(1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finBookingFormAccountsPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
										//mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
										days = 1;//if milestone due date and paid date difference is one add default add one day
										shouldContinueThisCondition = true;
									}else if(shouldContinueThisCondition && 1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
										//mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
										days = 1;//if milestone due date and paid date difference is one add default add one day
										shouldContinueThisCondition = true;
									} else {
										shouldContinueThisCondition = false;
										//mileStoneInfo.setMileStonePaidDate(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate())));
									}
									
									if (days <= 0) {
										continue;
									}//TimeUtil.addOneDay(timestamp);TimeUtil.removeOneDay(timestamp);
									mileStoneInfo = new FinancialProjectMileStoneInfo();
									mileStoneInfo.setMileStoneDueDate(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp));
								
									if(interestCalculationFrom.equalsIgnoreCase("Receipt")) {
										if(1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finBookingFormAccountsPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
											mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
											days = 1;
											shouldContinueThisCondition = true;
										}else if(shouldContinueThisCondition && 1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(tempTimeStamp),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
											mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
											days = 1;//if milestone due date and paid date difference is one add default add one day
											shouldContinueThisCondition = true;
										}else {	
											mileStoneInfo.setMileStonePaidDate(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp)));
										}
									}else {
										mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
									}
									mileStoneInfo.setMileStonePayAmount(tempPayAmount);mileStoneInfo.setMileStonePaidAmount(tempPaidAmount);
									totalInterestAmount +=calculateMileStoneDueInterest(finProjDemandNoteInfoPenalty,finBookingFormAccountsPojo,totalInterestAmount,tempPayAmount,tempPaidAmount,mileStoneInfo,conditionPenalty,mileStoneDetailsList);
								}
							} 
					 }
				 }
			} else {//amount not paid on milestone
				if(interestCalculationFrom.equalsIgnoreCase("ReceiptEditDelete") && Util.isEmptyObject(nextTimestamp)) {
					
				}else {
					//nextTimestamp = finProjDemandNoteInfoPenalty.getMilestoneDate();
					nextTimestamp = finProjDemandNoteInfoPenalty.getInterestCalculationUptoDate();
					if(Util.isEmptyObject(finProjDemandNoteInfoPenalty.getInterestCalculationUptoDate())) {
						//finProjDemandNoteInfoPenalty.setInterestCalculationUptoDate(TimeUtil.removeOneDay(new Timestamp(new Date().getTime())));
						//nextTimestamp = finProjDemandNoteInfoPenalty.getInterestCalculationUptoDate();
						continue;
					}
					days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
					if(1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finBookingFormAccountsPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
						//mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
						days = 1;//if milestone due date and paid date difference is one add default add one day
						shouldContinueThisCondition = true;
					}else if(shouldContinueThisCondition && 1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
						//mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate()));
						days = 1;//if milestone due date and paid date difference is one add default add one day
						shouldContinueThisCondition = true;
					} else {
						shouldContinueThisCondition = false;
						//mileStoneInfo.setMileStonePaidDate(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(accountsStatementPojo.getPaidDate())));
					}
					if(days<=0) {continue;}//TimeUtil.addOneDay(timestamp);TimeUtil.removeOneDay(timestamp);
					FinancialProjectMileStoneInfo mileStoneInfo = new FinancialProjectMileStoneInfo();
					mileStoneInfo.setMileStoneDueDate(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate));
					//mileStoneInfo.setMileStonePaidDate(nextTimestamp);
					if(interestCalculationFrom.equalsIgnoreCase("Receipt")) {//if this request from transaction approval, remove paid date -1
						if(1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(finBookingFormAccountsPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
							mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
							days = 1;
							shouldContinueThisCondition = true;
						}else if(shouldContinueThisCondition && 1==TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(mileStoneDueDate),TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp))) {
							mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
							days = 1;//if milestone due date and paid date difference is one add default add one day
							shouldContinueThisCondition = true;
						}else {
							mileStoneInfo.setMileStonePaidDate(TimeUtil.removeOneDay(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp)));
						}
					} else {
						mileStoneInfo.setMileStonePaidDate(TimeUtil.removeTimePartFromTimeStamp1(nextTimestamp));
					}
					mileStoneInfo.setMileStonePayAmount(payAmount);
					mileStoneInfo.setMileStonePaidAmount(paidAmount);
					totalInterestAmount+=calculateMileStoneDueInterest(finProjDemandNoteInfoPenalty,finBookingFormAccountsPojo,totalInterestAmount,payAmount,paidAmount,mileStoneInfo,conditionPenalty,mileStoneDetailsList);
				}
			}
		} 
	}
		double paidAmt = 0.0;
		double excessAmount = 0.0;
		double totalPendingPenaltyAmount = 0.0;
		FinBookingFormAccountsPojo milestonePenaltyRecordPojo = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = null;
		FinancialProjectMileStoneInfo finProjDemandNoteInfo1 = null;
		//List<Object> excessAmountReturnList = null;
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount = new ArrayList<>();
		FinancialProjectMileStonePojo finProjMileStonePojo = null;
		FinBookingFormAccountsInfo bookingFormAccountsInfo = null;
		List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = null;

		boolean insertData = (conditionPenalty.equalsIgnoreCase("insertInterestData"))?true:false;
		
		if(!interestCalculationFrom.equalsIgnoreCase("ReceiptEditDelete1")) {
			for (int index = 0; index < listOfPendingMileStoneAmount.size(); index++) {
				finProjMileStonePojo = listOfPendingMileStoneAmount.get(index);
				milestonePenaltyRecordPojo = finProjMileStonePojo.getMilestonePenaltyRecordPojo();
				// && finProjMileStonePojo.getTotalPendingPenaltyAmount()>0) {
				if(milestonePenaltyRecordPojo==null && insertData) {
					continue;
					//milestonePenaltyRecordPojo = new FinBookingFormAccountsPojo();
				} else if(milestonePenaltyRecordPojo==null && finProjMileStonePojo.getTotalPendingPenaltyAmount()!=null && finProjMileStonePojo.getTotalPendingPenaltyAmount()>0) {
					milestonePenaltyRecordPojo = new FinBookingFormAccountsPojo();
				} else if(finProjMileStonePojo.getTotalPendingPenaltyAmount() != null && (finProjMileStonePojo.getTotalPendingPenaltyAmount()<0 || finProjMileStonePojo.getTotalPendingPenaltyAmount()==0) ) {
					continue;
				}
				if(milestonePenaltyRecordPojo==null) {
					milestonePenaltyRecordPojo = new FinBookingFormAccountsPojo();
				}
				//excessAmountReturnList = null;
				paidAmt = 0.0;totalPendingPenaltyAmount = 0.0;
				excessAmount = 0.0;
				customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo2.setType(MetadataId.FIN_PENALTY.getId());
				customerPropertyDetailsInfo2.setFlatBookingId(finProjMileStonePojo.getBookingFormId());
				customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_PENALTY.getName());
				customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());

				if (insertData) {
					if (listOfExcessAmount.isEmpty()) {// if data is inserting to table then need to fecth data again, bcoz amount is adjusted to interest
						listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2, Arrays.asList(MetadataId.FIN_PENALTY.getId()));
					}
				} else {
					listOfExcessAmount = (List<FinBookingFormExcessAmountPojo>) mileStoneDetailsList.get(MetadataId.FIN_PENALTY.getName());
				}
				double interestWaiverPaidAmount = 0.0;
				if (Util.isNotEmptyObject(listOfExcessAmount)) {
					totalPendingPenaltyAmount = finProjMileStonePojo.getTotalPendingPenaltyAmount();
					if(interestCalculationFrom.equalsIgnoreCase("Receipt") || interestCalculationFrom.equalsIgnoreCase("ReceiptEditDelete")) {
						bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
						bookingFormAccountsInfo.setBookingFormId(finProjMileStonePojo.getBookingFormId());
						bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());//adding type of payment
						bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.FIN_PENALTY.getId()));
						bookingFormAccountsInfo.setTypeId(milestonePenaltyRecordPojo.getTypeId());
						bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
						bookingFormAccountsInfo.setCondition(FinEnum.LOAD_BY_ID.getName());
						//loading interest record
						bookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
						if (Util.isNotEmptyObject(bookingFormAccountsPojoLists)) {
							//check amount is paid or not for interest record
							interestWaiverPaidAmount = bookingFormAccountsPojoLists.get(0).getInterestWaiverAdjAmount()==null?0.0:bookingFormAccountsPojoLists.get(0).getInterestWaiverAdjAmount();
							totalPendingPenaltyAmount = bookingFormAccountsPojoLists.get(0).getPayAmount()-(bookingFormAccountsPojoLists.get(0).getPaidAmount()+interestWaiverPaidAmount);
						}
					}
					if (totalPendingPenaltyAmount < 0 || totalPendingPenaltyAmount == 0) {
						//if pending amount is zero or less than zero then not adjusting any excess amount
						continue;
					}
					finProjDemandNoteInfo1 = (FinancialProjectMileStoneInfo) finProjDemandNoteInfoPenalty.clone();
					finProjDemandNoteInfo1.setModifiedBy(finProjDemandNoteInfoPenalty.getCreatedBy());
					finProjDemandNoteInfo1.setPayAmount(roundOffAmount(totalPendingPenaltyAmount));
					
					processExcessAMount(listOfExcessAmount, new FinBookingFormAccountsInfo(),
							finProjDemandNoteInfo1, new CustomerPropertyDetailsInfo(), milestonePenaltyRecordPojo,
							MetadataId.FIN_PENALTY.getName(), insertData);

					if (isNotEmptyObject(milestonePenaltyRecordPojo.getPaidAmount())) {
						excessAmount = isEmptyObject(milestonePenaltyRecordPojo.getPaidAmount()) ? 0d : milestonePenaltyRecordPojo.getPaidAmount();
						//if (finPenalityInfo.getPenaltyTotalAmount() > finProjMileStonePojo.getTotalPendingPenaltyAmount()) {
							finProjMileStonePojo.setTotalPendingPenaltyAmount(finProjMileStonePojo.getTotalPendingPenaltyAmount() - excessAmount);
							paidAmt = finProjMileStonePojo.getTotalPenalityPaidAmount() == null ? 0d : finProjMileStonePojo.getTotalPenalityPaidAmount();
							finProjMileStonePojo.setTotalPenalityPaidAmount(paidAmt + excessAmount);
						//}
						if (isNotEmptyObject(milestonePenaltyRecordPojo.getPaidDate()) && excessAmount != 0) {
							finProjMileStonePojo.setMileStonePaidDate(milestonePenaltyRecordPojo.getPaidDate());
							// currentFinancialProjectMileStonePojo.setPaymentStatus(bookingFormAccountsPojo.getPaymentStatus());
						}
					}
				} //excess amount
			}
		}
}

	private void excludeGstAmountOnPaidAmount(FinBookingFormAccountsStatementPojo accountsStatementPojo,
			FinancialProjectMileStonePojo finBookingFormAccountsPojo) throws Exception {
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		FinancialProjectMileStonePojo mileStonePojo = new FinancialProjectMileStonePojo();
		mileStonePojo = financialMapper.copyPropertiesFromInfoBeanToInfoBean(finBookingFormAccountsPojo, FinancialProjectMileStonePojo.class);
		
		mileStonePojo.setSetOffAmount(accountsStatementPojo.getPaidAmount());
		Long typeId = finBookingFormAccountsPojo.getTypeId();
		
		customerPropertyDetailsInfo.setCondition("GetGSTPercentage");
		customerPropertyDetailsInfo.setType(MetadataId.GST.getId());
		customerPropertyDetailsInfo.setTypeId(typeId);
		customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
		customerPropertyDetailsInfo.setFlatBookingId(finBookingFormAccountsPojo.getBookingFormId());
		@SuppressWarnings("unused")
		Map<String, Object> mileStoneGstDetails = getGSTAmount(customerPropertyDetailsInfo,mileStonePojo);
		double gstAmount = mileStonePojo.getGstAmount()==null?0d:mileStonePojo.getGstAmount();
		double excludingGstPaidAmount = accountsStatementPojo.getPaidAmount()-gstAmount;
		accountsStatementPojo.setPaidAmount(roundOffAmount(excludingGstPaidAmount));
	}

	private void processSchemeDetails(List<FinSchemeTaxMappingPojo> schemeTaxDetails, Double basicMileStoneAmount,
			FinancialProjectMileStoneInfo finProjDemandNoteInfo,List<FinBookingFormMstSchTaxMapInfo> bokFrmDemNteSchTaxMapInfos,
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo) {
		double sumOfTaxAmount = 0.0;
		for (FinSchemeTaxMappingPojo finSchemeTaxMappingPojo : schemeTaxDetails) {
			 //setting scheme name in customer info, for generating demand note formats for diffrenet schemes
			customerPropertyDetailsInfo.setFinSchemeName(finSchemeTaxMappingPojo.getFinSchemeName());
			customerPropertyDetailsInfo.setFinSchemeId(finSchemeTaxMappingPojo.getFinSchemeId());
			customerPropertyDetailsInfo.setFinSchemeType(finSchemeTaxMappingPojo.getFinSchemeType());
			
			FinBookingFormMstSchTaxMapInfo bokFrmDemNteSchTaxMapInfo = new FinBookingFormMstSchTaxMapInfo();
			//calculating GST amount on milestone Basic amount
			Double mileStoneAmountWithGst = calCulateDemandNoteBasicMileStoneAmountWithGst(basicMileStoneAmount,finSchemeTaxMappingPojo.getPercentageValue());
			bokFrmDemNteSchTaxMapInfo.setGstAmount(mileStoneAmountWithGst);
			bokFrmDemNteSchTaxMapInfo.setCGST_Amount(mileStoneAmountWithGst / 2);
			bokFrmDemNteSchTaxMapInfo.setSGST_amount(mileStoneAmountWithGst / 2);
			bokFrmDemNteSchTaxMapInfo.setFinScheTaxMapId(finSchemeTaxMappingPojo.getFinSchemeTaxMappingId());
			bokFrmDemNteSchTaxMapInfo.setFltBookingSchemeMappingId(finSchemeTaxMappingPojo.getFltBookingSchemeMappingId());
			bokFrmDemNteSchTaxMapInfo.setBasicAmount(mileStoneAmountWithGst);
			bokFrmDemNteSchTaxMapInfo.setCreatedBy(finProjDemandNoteInfo.getCreatedBy());
			bokFrmDemNteSchTaxMapInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
			bokFrmDemNteSchTaxMapInfo.setTaxType(finSchemeTaxMappingPojo.getTaxType());
			bokFrmDemNteSchTaxMapInfo.setTaxTypeId(finSchemeTaxMappingPojo.getTaxTypeId());
			sumOfTaxAmount += mileStoneAmountWithGst;
			bokFrmDemNteSchTaxMapInfos.add(bokFrmDemNteSchTaxMapInfo);
		}
		finProjDemandNoteInfo.setBokFrmDemNteSchTaxMapInfos(bokFrmDemNteSchTaxMapInfos);
		finProjDemandNoteInfo.setMileStoneTaxAmount(sumOfTaxAmount);
		finProjDemandNoteInfo.setMileStoneBasicAmount(basicMileStoneAmount);
		finProjDemandNoteInfo.setMileStoneTotalAmount(basicMileStoneAmount + sumOfTaxAmount);
	}

	@SuppressWarnings({ "rawtypes", "unchecked" })
	private List<Object> processExcessAMount(List<FinBookingFormExcessAmountPojo> listOfExcessAmount, FinBookingFormAccountsInfo accountsInfo, 
			FinancialProjectMileStoneInfo finProjDemandNoteInfo, CustomerPropertyDetailsInfo customerPropertyDetailsInfo12345s,
			FinBookingFormAccountsPojo finBookingFormAccountsPojo, String condition, boolean isInsertData)
			throws MappingException, InstantiationException, IllegalAccessException {

		List<Object> bookingFormAccount = new ArrayList();
		List<FinBookingFormAccountsStatementPojo> bookingFormAccountStatementPojo = new ArrayList<FinBookingFormAccountsStatementPojo>();

		double usedExcessBalAmount = 0D;
		double totalUsedExcessBalanceAmount = 0D;
		Timestamp paidDateTimestamp = null;
		double amountToNullify = 0D;
		accountsInfo.setFinBookingFormAccountsId(finBookingFormAccountsPojo.getFinBookingFormAccountsId());
		//accountsInfo.setStatusId(Status.ACTIVE.getStatus());
		if (condition.equalsIgnoreCase("MileStoneBasicAmt")) {
			amountToNullify = finProjDemandNoteInfo.getMileStoneTotalAmount();
		} else if (condition.equalsIgnoreCase("MileStoneTaxAmt")) {
			amountToNullify = finProjDemandNoteInfo.getMileStoneTaxAmount();
		} else if (condition.equalsIgnoreCase(MetadataId.MODIFICATION_COST.getName()) || condition.equalsIgnoreCase(MetadataId.FIN_PENALTY.getName())) {
			amountToNullify = finProjDemandNoteInfo.getPayAmount();
		}
		double adjustAmount = amountToNullify;
		if (Util.isNotEmptyObject(listOfExcessAmount)) {
			double excessBalanceAmount = 0D;
			paidDateTimestamp = null;
			for (FinBookingFormExcessAmountPojo excessAmountPojo : listOfExcessAmount) {
				excessBalanceAmount = excessAmountPojo.getBalanceAmount();
				if (excessBalanceAmount <= 0) {
					continue;
				}
				if (adjustAmount <= 0) {
					break;
				}

				paidDateTimestamp = excessAmountPojo.getPaidDate();
				// finProjDemandNoteInfo.getMileStoneBasicAmount();
				if (excessBalanceAmount > adjustAmount) {
					log.info("EmployeeFinancialServiceImpl.processExcessAMount() mileStoneAmt>excessBalanceAmount" + (amountToNullify > excessBalanceAmount));
					usedExcessBalAmount = adjustAmount;
					totalUsedExcessBalanceAmount += usedExcessBalAmount;
					adjustAmount = adjustAmount - usedExcessBalAmount;
					//10,000 - 10,000 = 0
				} else {
					usedExcessBalAmount = excessBalanceAmount;
					totalUsedExcessBalanceAmount += usedExcessBalAmount;
					adjustAmount = adjustAmount - usedExcessBalAmount;
				}
				accountsInfo.setUsedAmount(usedExcessBalAmount);
				accountsInfo.setBalanceAmount(excessBalanceAmount - usedExcessBalAmount);
				accountsInfo.setPaidAmount(usedExcessBalAmount);
				accountsInfo.setActualPaidAmount(usedExcessBalAmount);
				// if(!isInsertData) {
				// excessAmountPojo.getBalanceAmount();
				excessAmountPojo.setBalanceAmount(excessAmountPojo.getBalanceAmount() - usedExcessBalAmount);
				// }

				if (isInsertData) {
					employeeFinancialServiceDao.updateAndReduceExcessAmount(financialMapper.copyPropertiesFromFinBookingFormExcessAmountPojo_FinBookingFormAccountsInfoToFinBookingFormExcessAmountPojo(
									accountsInfo, excessAmountPojo, finProjDemandNoteInfo, FinBookingFormExcessAmountPojo.class));
				}
				if (!listOfExcessAmount.isEmpty()) {
					/*FinBookingFormReceiptsPojo bookingFormReceiptsPojo1 = (FinBookingFormReceiptsPojo) financialMapper
							.copyPropertiesFromInfoBeanToPojoBean(accountsInfo, FinBookingFormReceiptsPojo.class);
					bookingFormReceiptsPojo1.setCreatedBy(finProjDemandNoteInfo.getCreatedBy());*/
					// Long finBookingFormReceiptId =
					// employeeFinancialServiceDao.saveBookingFormReceiptsDetials(bookingFormReceiptsPojo);
					accountsInfo.setFinBookingFormReceiptsId(excessAmountPojo.getFinBookingFormReceiptsId());
					accountsInfo.setPaidDate(paidDateTimestamp);// FinBookingFormAccountsStatementPojo
					FinBookingFormAccountsStatementPojo accountsStatementPojo = (FinBookingFormAccountsStatementPojo) financialMapper
							.copyPropertiesFromInfoBeanToPojoBean(accountsInfo, FinBookingFormAccountsStatementPojo.class);
					accountsStatementPojo.setStatusId(Status.ACTIVE.getStatus());
					if (isInsertData) {
						employeeFinancialServiceDao.saveFinBookingFormAccountsStatement(accountsStatementPojo);
						employeeFinancialServiceDao.saveBookingFormExcessAmountUsage( financialMapper.copyPropertiesFinBookingFormAccountsInfoToBookingFormExcessAmountUsage(
										accountsInfo, excessAmountPojo, finProjDemandNoteInfo, FinBookingFormExcessAmountUsagePojo.class, condition));
					}
					bookingFormAccountStatementPojo.add(accountsStatementPojo);
					// penalty data don't have while creating , if it is extra amount while
					// adjusting only penalty amount will be nullify and then data will store in
					// excess amount tables
					// Long finBookingFormAccountsId =
					// employeeFinancialServiceDao.isPenaltyDetailsExistInAccountTable(finPenalityInfo);
				}
			}
		}
		bookingFormAccount.add(0, bookingFormAccountStatementPojo);
		finBookingFormAccountsPojo.setPaidAmount(totalUsedExcessBalanceAmount);
		finBookingFormAccountsPojo.setBalanceAmount(totalUsedExcessBalanceAmount);//new added
		finBookingFormAccountsPojo.setPaidDate(paidDateTimestamp);
		if (totalUsedExcessBalanceAmount == amountToNullify) {
			if (condition.equalsIgnoreCase("MileStoneBasicAmt")) {
				finBookingFormAccountsPojo.setPaymentStatus(Status.INPROGRESS.getStatus());
			} else {
				finBookingFormAccountsPojo.setPaymentStatus(Status.PAID.getStatus());
			}
			if (isInsertData) {
				employeeFinancialServiceDao.updateBookingFormAccountPaidAmount(finBookingFormAccountsPojo);
			}
		} else if (totalUsedExcessBalanceAmount > 0D) {
			finBookingFormAccountsPojo.setPaymentStatus(Status.INPROGRESS.getStatus());
			if (isInsertData) {
				employeeFinancialServiceDao.updateBookingFormAccountPaidAmount(finBookingFormAccountsPojo);
			}
		} else {
			/* no need to update when useExcessBalanceAmount<=0 */
		}
		return bookingFormAccount;
	}

	/*public static void main(String[] args) {
		FinSchemeTaxMappingPojo finSchemeTaxMappingPojo = new FinSchemeTaxMappingPojo();
		finSchemeTaxMappingPojo.setPercentageValue(12.0);
		Double basicMileStoneAmount = 480389.930;
		Double mileStoneAmountWithGst = new EmployeeFinancialServiceImpl().calCulateDemandNoteBasicMileStoneAmountWithGst(basicMileStoneAmount,finSchemeTaxMappingPojo.getPercentageValue());
		//System.out.println(basicMileStoneAmount+mileStoneAmountWithGst);
	}*/
	
	public String generateTransactionReceiptNo(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		StringBuilder transactionReceiptNo = null;
		long booingFormId = transactionServiceInfo.getBookingFormId();
		List<Long> listId = null; 
		if (transactionServiceInfo.isThisUplaodedData()) {
			if (Util.isEmptyObject(transactionServiceInfo.getSalesFrTransactionReceiptNo())) {
				throw new EmployeeFinancialServiceException("Transaction Receipt No found empty");
			}
			System.out.println(transactionServiceInfo.getSalesFrTransactionReceiptNo());
			String excelRecordNo = transactionServiceInfo.getSalesFrTransactionReceiptNo();
			//ResponceCodesUtil responceCodesUtil = new ResponceCodesUtil();
			
			String acceptReceiptNoFromExcel = responceCodesUtil.getApplicationProperties().getProperty("ACCEPT_RECEIPT_NO_FROM_EXCEL");
			
			FinTransactionEntryDetailsInfo finTransactionEntryDetailsInfo = new FinTransactionEntryDetailsInfo();
			String requestUrl = transactionServiceInfo.getRequestUrl()==null?"":transactionServiceInfo.getRequestUrl();
			boolean condition = "saveBookingDetails".equals(requestUrl);
			if(condition && Util.isNotEmptyObject(transactionServiceInfo.getBookingRequest()) && Util.isNotEmptyObject(transactionServiceInfo.getBookingRequest().getOldBookingRequest())) {
				//assigning old booking id so we can shift doc , from old to new booking
				
				//transactionServiceInfo.setBookingFormId(transactionServiceInfo.getBookingRequest().getOldBookingRequest().getFlatBookingId());
				listId = Arrays.asList(Status.ACTIVE.getStatus());
			} else {
				listId = Arrays.asList(Status.INACTIVE.getStatus());
			}
			List<Map<String, Object>> data = employeeFinancialServiceDao.getTransactionDataByReceiptNo(transactionServiceInfo,listId);
			transactionServiceInfo.setBookingFormId(booingFormId);//assigning actual booking form id;
			
			if (Util.isNotEmptyObject(data)) {//loaded old receipt data using receipt no
				int index = data.size()-1;
				String TransactionEntryId = data.get(index).get("FIN_TRANSACTION_ENTRY_ID").toString();
				String sourceOfFunds = data.get(index).get("SOURCE_OF_FUNDS")==null?null:data.get(index).get("SOURCE_OF_FUNDS").toString();
				finTransactionEntryDetailsInfo.setTransactionEntryId(Long.valueOf(TransactionEntryId));
				if (transactionServiceInfo.getSourceOfFunds() == null) {
					transactionServiceInfo.setSourceOfFunds(sourceOfFunds);
				}
				//if this transaction receipt no is present in DB, then taking his transaction id and inserting as previous transaction id
				transactionServiceInfo.setPrevTransactionEntryId(Long.valueOf(TransactionEntryId));
			} else {
				finTransactionEntryDetailsInfo.setTransactionEntryId(0l);
			}
			if (finTransactionEntryDetailsInfo.getTransactionEntryId() != 0) {
				List<FinTransactionEntryDocPojo> transactionEntryDocPojos  = employeeFinancialServiceDao.getFinTransactionEntryDocuments(finTransactionEntryDetailsInfo, MetadataId.UPLOADED);
				System.out.println(transactionEntryDocPojos);
				List<FileInfo> fileInfos = new ArrayList<>();//copying old booking uploaded attachments, to new booking or new transaction
				for (FinTransactionEntryDocPojo finTransactionEntryDocPojo : transactionEntryDocPojos) {
					FileInfo fileInfo = new FileInfo();
					fileInfo.setName(finTransactionEntryDocPojo.getDocumentName());
					fileInfo.setFilePath(finTransactionEntryDocPojo.getFilePath());
					fileInfo.setUrl(finTransactionEntryDocPojo.getDocumentLocation());
					fileInfos.add(fileInfo);
				}
				transactionServiceInfo.setFileInfos(fileInfos);
			}
			if((excelRecordNo.contains("SIPL/") || excelRecordNo.contains("SHL/"))  && excelRecordNo.contains("-") && excelRecordNo.contains("/") && acceptReceiptNoFromExcel.equals("yes")
					&& excelRecordNo.contains("20")
					) {
				return excelRecordNo;	
			} else if(acceptReceiptNoFromExcel.equals("yes")){
				throw new EmployeeFinancialServiceException("Transaction Receipt No found empty");
			}
		}
		
		//if this is edit and shift transaction then use previous transaction receipt no
		if(transactionServiceInfo.isThisEditTransaction() || transactionServiceInfo.isThisShiftTransaction()) {
			if(Util.isEmptyObject(transactionServiceInfo.getPrevTransactionReceiptNo())) {
				log.info("Transaction Receipt No found empty, For shift and edit transaction");
				throw new EmployeeFinancialServiceException("Transaction Receipt No found empty, For shift and edit transaction");
			}
			return transactionServiceInfo.getPrevTransactionReceiptNo();
		}
		
		StringBuilder financialYear = new StringBuilder("");
		//SIPL/2018-2019/Eden Garden/483
		String siteName = transactionServiceInfo.getSiteName();
		if(transactionServiceInfo.getSiteId()!=null &&transactionServiceInfo.getSiteId().equals(131l)) {
			siteName = "Aspire Aurum";
			 transactionReceiptNo = new StringBuilder("SHL/");
		} else {
			 transactionReceiptNo = new StringBuilder("SIPL/");
		}
		int year = Calendar.getInstance().get(Calendar.YEAR);
	    int month = Calendar.getInstance().get(Calendar.MONTH);
	    if (month < 3) {
	    	financialYear.append((year - 1) + "-" + year);
	    } else {
	    	financialYear.append( year + "-" + (year + 1));
	    }
	 	//log.info("Financial Year : " +financialYear);
	 	transactionReceiptNo.append(financialYear).append("/")
	 	.append(siteName).append("/").append(transactionServiceInfo.getTransactionEntryId());
	 	log.info(" *****  generateTransactionReceiptNo() generated receipt no for transaction "+transactionReceiptNo+" \t"+transactionServiceInfo.getTransactionEntryId());
	 	return transactionReceiptNo.toString();
	}
	
	public String generateTransactionNo(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) {
		String transactionNo="";
		if(Util.isNotEmptyObject(transactionServiceInfo.getTransactionNo())) {
			transactionNo =transactionServiceInfo.getTransactionNo();
		}else if(Util.isNotEmptyObject(transactionServiceInfo.getTransactionEntryId())) {
			transactionNo = String.format("%04d",transactionServiceInfo.getTransactionEntryId());
		}
		return transactionNo;
	}
	
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialTransactionResponse modifyOrRejectSuspenseEntry(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.modifyOrRejectSuspenseEntry() *****");
		EmployeeFinancialTransactionResponse transactionResponse = new EmployeeFinancialTransactionResponse();
		
		transactionServiceInfo.setOperationType(transactionServiceInfo.getOperationType()==null?"":transactionServiceInfo.getOperationType());
		
		if(transactionServiceInfo.getOperationType().equals("RejectSuspenceEntry")){		
			EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionInfo = (EmployeeFinancialTransactionServiceInfo) transactionServiceInfo.clone();
			employeeFinancialTransactionInfo.setStatusId(Status.ACTIVE.getStatus());
			rejectSuspenseEntryRecord(employeeFinancialTransactionInfo);
			transactionServiceInfo.setTransactionActionType(Status.REJECTED.getStatus());
			employeeFinancialServiceDao.saveAnonymousApproveStatistics((FinAnnyApproveStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinAnnyApproveStatPojo.class));
			return transactionResponse;
		} else if( transactionServiceInfo.getOperationType().equals("ModifySuspenceEntry")){
			FinAnonymousEntryPojo anonymousEntryPojo = new FinAnonymousEntryPojo();
			anonymousEntryPojo.setAnonymousEntryId(transactionServiceInfo.getAnonymousEntryId());
			anonymousEntryPojo.setStatusId(Status.MODIFY.getStatus());//the suspense entry status will be changed
			anonymousEntryPojo.setActiveStatusId(Status.ACTIVE.getStatus());//this is current status of suspense entry
			
			transactionServiceInfo.setTransactionActionType(Status.MODIFY.getStatus());
			employeeFinancialServiceDao.saveAnonymousApproveStatistics((FinAnnyApproveStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinAnnyApproveStatPojo.class));
			
			Map<String, String> comment = new HashMap<>();
			comment.put("CRM", transactionServiceInfo.getComment());
			employeeFinancialServiceDao.saveAnonymousEntryComments((FinAnnyEntryCommentsPojo)financialMapper.copyPropertiesFromFinancialTransactionServiceInfoBeanToTransactionCommentsPojoBean(transactionServiceInfo,comment,FinAnnyEntryCommentsPojo.class));	
			
			employeeFinancialServiceDao.updateAnonymousEntryStatus(anonymousEntryPojo);
			return transactionResponse;
		}
		return transactionResponse;
	}

	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialTransactionResponse saveFinancialTransactionRequest(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) 
			throws Exception {
		log.info(" ***** control inside EmployeeFinancialServiceImpl.saveFinancialTransactionRequest() ***** ");
		EmployeeFinancialTransactionResponse transactionResponse = new EmployeeFinancialTransactionResponse();
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		List<String> errorMsgs = new ArrayList<>();	
		boolean isThisIsFinalLevel = false;
		boolean isThisIsModifyTransaction = false;
		boolean isThisShiftTransaction = false;
		boolean isThisEditTransaction = false;
		boolean isThisUploadTransaction = false;
		String transactionReceiptNo = "";
		List<Long> listOfBookingStatus = null;
		Long lastTXFinTxsetOfAppLevelId =null;
		transactionServiceInfo.setStatusId(Status.ACTIVE.getStatus());
		transactionServiceInfo.setTransactionStatusId(Status.NEW.getStatus());
		transactionServiceInfo.setSendNotification(Boolean.TRUE);
		String transactionFor = transactionServiceInfo.getTransactionFor();
		if(FinTransactionMode.WAIVED_OFF.getId().equals(transactionServiceInfo.getTransactionModeId())) {
			transactionServiceInfo.setSendNotification(Boolean.FALSE);
			transactionServiceInfo.setBankId(null);
			transactionServiceInfo.setBankName(null);
			transactionServiceInfo.setSiteAccountId(null);
			transactionServiceInfo.setSiteBankAccountNumber(null);
			transactionServiceInfo.setSourceOfFunds(null);
		}
		//reciept cheque module coming false
		boolean isTransactionForIsEmpty = (Util.isNotEmptyObject(transactionFor) && transactionServiceInfo.getTransactionTypeName().equals(MetadataId.PAYMENT.getName()));
		if(isTransactionForIsEmpty) {//if refund entry transaction
			transactionServiceInfo.setThisPaymentTransaction(isTransactionForIsEmpty);
			customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
			customerPropertyDetailsInfo.setFlatBookingId(transactionServiceInfo.getBookingFormId());
				
			if (transactionServiceInfo.getTransactionForId()!=null && transactionServiceInfo.getTransactionForId().equals(FinTransactionFor.FLAT_CANCELLATION.getId())) {
				//if booking cancelled already, or CANCELLED_NOT_REFUNDED, bcoz flat is not active then taking these status
				listOfBookingStatus = Arrays.asList(Status.SWAP.getStatus(),Status.ASSIGNMENT.getStatus(), Status.PRICE_UPDATE.getStatus(),Status.CANCEL.getStatus(),
						Status.RETAINED.getStatus(), Status.INACTIVE.getStatus(), Status.PMAY_SCHEME_ELIGIBLE.getStatus(),Status.CANCELLED_NOT_REFUNDED.getStatus());
			}else {
				listOfBookingStatus = Arrays.asList(Status.ACTIVE.getStatus());
			}
			customerPropertyDetailsInfo.setStatusIds(listOfBookingStatus);
			Timestamp aggrementDate = employeeFinancialServiceDao.getFlatAgreementCompletedDate(null,customerPropertyDetailsInfo);
			if(Util.isNotEmptyObject(aggrementDate)) {
				transactionServiceInfo.setFlatAgreementCompleted(Boolean.TRUE);
			} else {
				transactionServiceInfo.setFlatAgreementCompleted(Boolean.FALSE);
			}
			//transactionServiceInfo.setTransactionForId(MetadataId.valueOf(transactionFor.toUpperCase()).getId());
		}
		
		transactionServiceInfo.setOperationType(transactionServiceInfo.getOperationType()==null?"":transactionServiceInfo.getOperationType());
		
		if(transactionServiceInfo.getOperationType().equalsIgnoreCase("Modify")) {
			isThisIsModifyTransaction = true;transactionServiceInfo.setThisIsModifyTransaction(isThisIsModifyTransaction);
			//isThisPaymentRefundReqTrn = false;//is this is request from Modify Transaction
		} else if(transactionServiceInfo.getOperationType().equals("RejectSuspenceEntry")){		
			EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionInfo = (EmployeeFinancialTransactionServiceInfo) transactionServiceInfo.clone();
			employeeFinancialTransactionInfo.setStatusId(Status.ACTIVE.getStatus());
			rejectSuspenseEntryRecord(employeeFinancialTransactionInfo);//rejecting suspense entry
			return transactionResponse;
			//next lines will not execute
		} else if( transactionServiceInfo.getOperationType().equals("ModifySuspenceEntry")){
			FinAnonymousEntryPojo anonymousEntryPojo = new FinAnonymousEntryPojo();
			anonymousEntryPojo.setAnonymousEntryId(transactionServiceInfo.getAnonymousEntryId());
			anonymousEntryPojo.setStatusId(Status.MODIFY.getStatus());//the suspense entry status will be changed
			anonymousEntryPojo.setActiveStatusId(Status.ACTIVE.getStatus());//this is current status of suspense entry
			employeeFinancialServiceDao.updateAnonymousEntryStatus(anonymousEntryPojo);
			return transactionResponse;//updating susupense entry status
			//next lines will not execute
		} else if(FinEnum.SHIFT_TRANSACTION.getName().equals(transactionServiceInfo.getOperationType())) {
			isThisShiftTransaction = true;
			isThisIsFinalLevel = true;
			transactionServiceInfo.setThisShiftTransaction(isThisShiftTransaction);
			transactionServiceInfo.setThisIsFinalLevel(isThisIsFinalLevel);
			transactionServiceInfo.setSendNotification(Boolean.FALSE);
			if("saveBookingDetails".equalsIgnoreCase(transactionServiceInfo.getRequestUrl())) {
				transactionServiceInfo.setIsRecordUploaded(Status.TRANSACTION_SHIFTED.getStatus());	
			}
			//log.info("Is this final approval :> "+isThisIsFinalLevel+" "+transactionServiceInfo.getTransactionModeName());
		} else if(FinEnum.EDIT_TRANSACTION.getName().equals(transactionServiceInfo.getOperationType())) {
			isThisEditTransaction = true;
			isThisIsFinalLevel = true;
			transactionServiceInfo.setThisIsFinalLevel(isThisIsFinalLevel);
			transactionServiceInfo.setThisEditTransaction(isThisEditTransaction);
			transactionServiceInfo.setSendNotification(Boolean.FALSE);
			//log.info("Is this final approval :> "+isThisIsFinalLevel+" "+transactionServiceInfo.getTransactionModeName());
		} else if(FinEnum.UPLOADED_TRANSACTION.getName().equals(transactionServiceInfo.getOperationType())) {
			isThisIsFinalLevel = true;
			isThisUploadTransaction = true;
			transactionServiceInfo.setThisIsFinalLevel(isThisIsFinalLevel);
			transactionServiceInfo.setSendNotification(Boolean.FALSE);
			transactionServiceInfo.setBlockIds(null);
			transactionServiceInfo.setIsRecordUploaded(Status.YES.getStatus());
			if("saveBookingDetails".equalsIgnoreCase(transactionServiceInfo.getRequestUrl())) {
				transactionServiceInfo.setIsRecordUploaded(Status.TRANSACTION_SHIFTED.getStatus());	
			}
			if(transactionServiceInfo.getReceiptStage()!=null && !transactionServiceInfo.getReceiptStage().equalsIgnoreCase("Cleared")) {
				isThisIsFinalLevel = false;
				transactionServiceInfo.setThisIsFinalLevel(isThisIsFinalLevel);
			}
			//log.info("Is this final approval :> "+isThisIsFinalLevel+" "+transactionServiceInfo.getTransactionModeName());
		} else {
			
			/*List<FinTransactionEntryPojo> transactionEntryPojos = employeeFinancialServiceDao.isAnyTransactionInApproval(transactionServiceInfo,Status.CREATED);
			boolean flag = Util.isNotEmptyObject(transactionEntryPojos);
			if(flag && isTransactionForIsEmpty) {//
				throw new EmployeeFinancialServiceException("One transaction already pending can not initiate another Transaction.");
			}*/
		}
		
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
		employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
		/*if(isEmptyObject(transactionServiceInfo.getBookingFormId()) && isNotEmptyObject(transactionServiceInfo.getFlatIds())) {
			employeeFinancialServiceInfo.setFlatIds(transactionServiceInfo.getFlatIds());
			//new booking time insert, old booking trn to new booking
		}*/
		if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {
			if (transactionServiceInfo.getTransactionForId()!=null && transactionServiceInfo.getTransactionForId()!=null && transactionServiceInfo.getTransactionForId().equals(FinTransactionFor.FLAT_CANCELLATION.getId())) {
				employeeFinancialServiceInfo.setStatusIds(listOfBookingStatus);
				employeeFinancialServiceInfo.setCondition(FinEnum.GET_INACTIVE_BOOKINGS.getName());
			}
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos= employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {	//reciept cheque module
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
				transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
				if(isEmptyObject(customerPropertyDetailsInfo)) {
					throw new EmployeeFinancialServiceException("Failed to create transaction, Customer details not found.");
				}
			} else {
				throw new EmployeeFinancialServiceException("Failed to create transaction, Customer details not found.");
			}
		}

		//reciept cheque module
		//Payemnt set off like, principal amount , legal charges, maintenance etc...
		getPaymentSetOffType(transactionServiceInfo);//get the payment set off id's for approval mapping
		long count  = employeeFinancialServiceDao.checkDemandNoteIsGeneratedOrNotForTransaction(transactionServiceInfo);
		if (count == 0) {
			transactionServiceInfo.setDemandNoteGenerated(false);
			//throw new EmployeeFinancialServiceException("Demand note not generated for Flat, Please generate Demand Note and try again!");
		} else {
			transactionServiceInfo.setDemandNoteGenerated(true);
		}
		List<FinTransactionApprovalDetailsPojo> approvalDetailsList = null;
		if(isThisIsModifyTransaction) {// if this is modify transaction request
			//if this is modify transaction check employee is valid or not, and then send transaction to next approval level, from the current modifying trn level
			List<FinTransactionApprovalDetailsPojo> approveDetails = employeeFinancialServiceDao.isValidEmployeeToApproveTransaction(transactionServiceInfo,Status.CREATED);
			if (!approveDetails.isEmpty()) {
				long transactionSetOffApprovalId = approveDetails.get(0).getTransactionSetOffApprovalId();
				transactionServiceInfo.setTransactionSetOffApprovalId(transactionSetOffApprovalId);
			} else {
				throw new EmployeeFinancialServiceException("No approval found for this transaction.");
			}
			 approvalDetailsList = employeeFinancialServiceDao.getNextLevelEmployeeApprovalDetails(transactionServiceInfo,approveDetails.get(0),Status.APPROVED);
		} else {//saveFinancialTransactionMethod
			approvalDetailsList = employeeFinancialServiceDao.getNextLevelEmployeeApprovalDetails(transactionServiceInfo,null,Status.CREATED);	
		}
		
		//if this is not the shift transaction then only check the approvals
		if(isThisShiftTransaction==false && isThisEditTransaction == false && isThisUploadTransaction!=true || (transactionServiceInfo.getReceiptStage()!=null 
				&& (transactionServiceInfo.getReceiptStage().equalsIgnoreCase("Received") || transactionServiceInfo.getReceiptStage().equalsIgnoreCase("Bounce"))) )  {
			if(approvalDetailsList.isEmpty()) {
				log.error("No mapping found for the transaction. Please contact to Support Team"+customerPropertyDetailsInfo.getFlatNo());
				throw new EmployeeFinancialServiceException("No mapping found for the transaction. Please contact to Support Team ");
			} else if(approvalDetailsList.size()>1) {
				log.error("No mapping found for the transaction. Please contact to Support Team"+customerPropertyDetailsInfo.getFlatNo());
				throw new EmployeeFinancialServiceException("Found duplicate approval mapping for the Transaction ");
			} else {	//reciept chequ module first level
				//if found next level id, then updating in FIN_TRANSACTION_SET_OFF_APPROVAL table , so will get to know , in which level this transaction is pending
				FinTransactionApprovalDetailsPojo approvalDetails = approvalDetailsList.get(0);
				transactionServiceInfo.setThisTransactionRequest(false);
				if(approvalDetails.getTrnRequestLevel()!=null) {
					transactionServiceInfo.setThisTransactionRequest(MetadataId.YES.getId().equals(approvalDetails.getTrnRequestLevel()));	
				}
				isThisIsFinalLevel = isEmptyObject(approvalDetails.getNextTransactionSetOffApprovalLevelId())?true:false;
				
				transactionServiceInfo.setThisIsFinalLevel(isThisIsFinalLevel);log.info("Is this final approval :> "+isThisIsFinalLevel+" Mode "+transactionServiceInfo.getTransactionModeName());
				transactionServiceInfo.setTransactionSetOffApprovalLevelId(approvalDetails.getNextTransactionSetOffApprovalLevelId());
				transactionServiceInfo.setCurrentApprovalLevelName(transactionServiceInfo.getEmployeeName());
			}
		}
		//String s = null;s.trim();
		Long transactionEntryId = 0l,transactionSetOffEntryId;
		try {
			
			/*EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());

			if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
				customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
			} else {
				if (transactionServiceInfo.getTransactionForId()!=null && transactionServiceInfo.getTransactionForId()!=null && transactionServiceInfo.getTransactionForId().equals(FinTransactionFor.FLAT_CANCELLATION.getId())) {
					employeeFinancialServiceInfo.setStatusIds(listOfBookingStatus);
					employeeFinancialServiceInfo.setCondition(FinEnum.GET_INACTIVE_BOOKINGS.getName());
				}
				List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos= employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
				if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
					customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
					transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
				}
			}*/
			
			
			if(transactionServiceInfo.getTransactionReceiveDate()!=null) {	//reciept chequ module
				transactionServiceInfo.setTransactionReceiveDate(TimeUtil.addCurrentTimeToTimeStamp(transactionServiceInfo.getTransactionReceiveDate()));
			}
			if(transactionServiceInfo.getTransactionDate()!=null) {	//reciept chequ module
				transactionServiceInfo.setTransactionDate(TimeUtil.addCurrentTimeToTimeStamp(transactionServiceInfo.getTransactionDate()));
			}
			if(transactionServiceInfo.getTransactionTypeId().equals(FinTransactionType.RECEIPT.getId()) && transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("online")) {	//reciept chequ module
				transactionServiceInfo.setTransactionDate(transactionServiceInfo.getTransactionReceiveDate());
			}
			//bvr
			if(transactionServiceInfo.getTransactionTypeId().equals(FinTransactionType.RECEIPT.getId()) && transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("waived off")) {	//reciept chequ module
				transactionServiceInfo.setTransactionDate(transactionServiceInfo.getTransactionReceiveDate());
			}
			String requestUrl = transactionServiceInfo.getRequestUrl()==null?"":transactionServiceInfo.getRequestUrl();
			boolean condition = "saveBookingDetails".equals(requestUrl) && transactionServiceInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId());
			//this request should not be from new booking time shift transaction , from old booking to new booking
			if(isThisIsFinalLevel && isThisUploadTransaction && !condition) {//if this is upload transaction and final level, then checking any next receive date for this current transaction receive date
				FinTransactionEntryDetailsInfo transactionEntryDetailsInfo = (FinTransactionEntryDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, FinTransactionEntryDetailsInfo.class);
				//if this is upload transaction and any transaction has to adjust based on trn receive date 
				if (transactionServiceInfo.getTransactionTypeName().equalsIgnoreCase(FinTransactionType.PAYMENT.getName())) {
					transactionServiceInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionDate());
					transactionEntryDetailsInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionDate());
					transactionEntryDetailsInfo.setActualTransactionDate(transactionServiceInfo.getTransactionDate());
				} else {
					transactionServiceInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
					transactionEntryDetailsInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
					transactionEntryDetailsInfo.setActualTransactionDate(transactionServiceInfo.getTransactionReceiveDate());
				}
				transactionEntryDetailsInfo.setTransactionEntryId(0l);//giving default values so all the transaction will load in Shift transaction method
				/*transactionServiceInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
				transactionEntryDetailsInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
				transactionEntryDetailsInfo.setActualTransactionDate(transactionServiceInfo.getTransactionReceiveDate());*/
				if(transactionServiceInfo.getPaymentSetOffTypes().contains(MetadataId.PRINCIPAL_AMOUNT.getId())) {
					transactionServiceInfo.setThisShiftTransactionFromApproval(true);
					shiftThePaymentTransactions(transactionServiceInfo, transactionEntryDetailsInfo);
					shiftTheReceiptTransactions(transactionServiceInfo, transactionEntryDetailsInfo, customerPropertyDetailsInfo);	
				}
			}
			
			//12-may - 1st milestone
			//15-may - 2nd milestone - deleted  
			//16-may - 3rd milestone
			
			//12-may - 1st milestone
			//16-may - 2rd milestone
			
			/*	//reciept chequ module*/
			transactionEntryId = employeeFinancialServiceDao.saveTransactionEntryDetails(financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionEntryPojo.class));
			transactionServiceInfo.setTransactionEntryId(transactionEntryId);
			//-----------------------Generating transaction invoice number
			getFinancialTransactionInvoiceNumber(transactionServiceInfo);
			//------------------------Generating transaction receipt number, and taking 
			transactionReceiptNo = generateTransactionReceiptNo(transactionServiceInfo);
			//updating receipt no to record
			transactionServiceInfo.setTransactionReceiptNo(transactionReceiptNo);
			//updating FIN_TRANSACTION_ENTRY table
			employeeFinancialServiceDao.updateTransactionDetails(transactionServiceInfo);	//reciept chequ module
			
			transactionSetOffEntryId = employeeFinancialServiceDao.saveTransactionSetOffEntryDetails(financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionSetOffEntryPojo.class));	//reciept chequ module
			transactionServiceInfo.setTransactionSetOffEntryId(transactionSetOffEntryId);
		
			if (isThisShiftTransaction == false) {// && isThisEditTransaction == false	//reciept chequ module
				//for shift transaction comments also shifting using query, so need here
				if(Util.isNotEmptyObject(transactionServiceInfo.getComments())) {
					for (Map<String, String> comment : transactionServiceInfo.getComments()) {
						employeeFinancialServiceDao.saveTransactionEntryComments((FinTransactionCommentsPojo)financialMapper.copyPropertiesFromFinancialTransactionServiceInfoBeanToTransactionCommentsPojoBean(transactionServiceInfo,comment,FinTransactionCommentsPojo.class));	
					}
				}
			}
			
			FinTransactionSetOffApprovalPojo  finTransactionSetOffApprovalPojo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionSetOffApprovalPojo.class);
			if(transactionServiceInfo.isThisIsFinalLevel() && Util.isNotEmptyObject(approvalDetailsList)) {
				finTransactionSetOffApprovalPojo.setTransactionSetOffApprovalLevelId(approvalDetailsList.get(0).getTransactionSetOffApprovalLevelId());
			}
			if (FinEnum.UPLOADED_TRANSACTION.getName().equals(transactionServiceInfo.getOperationType())) {
				if (Util.isEmptyObject(finTransactionSetOffApprovalPojo.getTransactionSetOffApprovalLevelId())) {
					lastTXFinTxsetOfAppLevelId = employeeFinancialServiceDao.getLastTXFinTxsetOfAppLevelId(transactionServiceInfo);
					finTransactionSetOffApprovalPojo.setTransactionSetOffApprovalLevelId(lastTXFinTxsetOfAppLevelId);
				}
			}
			//if this is shift and edit transactio not storing next level approval details, as we are copying these details from old transaction to new transaction  
			if(isThisShiftTransaction==false && isThisEditTransaction == false) {
				employeeFinancialServiceDao.saveNextLeveTransactionApprovalDetails(finTransactionSetOffApprovalPojo);
			}
			
			//FinTransactionApprRejectStatPojo
			transactionServiceInfo.setTransactionActionType(Status.CREATED.getStatus());
			long transactionApproveStatId = 0l;
			if(isThisShiftTransaction == false) {//for shift transaction no need to insert new approve reject details, copying all the approve reject details from previous transaction
				log.info(" SaveFinancial Transaction Request saveApproveRejectStatistics"+transactionServiceInfo.getTransactionSetOffEntryId());
				FinTransactionApprRejectStatPojo apprRejectStatPojo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionApprRejectStatPojo.class);
				if(isThisEditTransaction) {
					apprRejectStatPojo.setActionType(Status.TRANSACTION_EDITED.getStatus());
				}
				if(isThisIsModifyTransaction) {
					apprRejectStatPojo.setActionType(Status.MODIFY_CREATED.getStatus());
				}
				if(isThisUploadTransaction) {
					apprRejectStatPojo.setActionType(Status.UPLOADED_DATA.getStatus());
				}
				//inserting FIN_TRANSACTION_APPR_STAT table
				transactionApproveStatId = employeeFinancialServiceDao.saveApproveRejectStatistics(apprRejectStatPojo);	//reciept chequ module
			}
			transactionServiceInfo.setTransactionApproveStatId(transactionApproveStatId);
			transactionServiceInfo.setTransactionSetOffApprovalId(finTransactionSetOffApprovalPojo.getTransactionSetOffApprovalId());
			
			if(isThisIsModifyTransaction || isThisEditTransaction) {
				checkChangedTransactionDetails(transactionServiceInfo);
			}
		
		} catch (Exception ex) {
			ex.printStackTrace();
			errorMsgs = new ArrayList<String>();
			errorMsgs.add("Error occurred while saving some records to the database plz try again once !");
			log.error("Error occurred while saving the existing customer once again to the database plz try again once -" + ex.toString());
			throw new InSufficeientInputException(errorMsgs);
		}
		try {
			transactionServiceInfo.setThisIsModifyTransaction(isThisIsModifyTransaction);
			if(transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("cheque")) {
					employeeFinancialServiceDao.saveTransactionChequeDetials( financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionChequePojo.class));	
			} else if(transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("online")) {
				if(!transactionServiceInfo.getTransactionTypeName().equals(FinTransactionType.PAYMENT.getName())) {
					Long anonymousEntryId=0L;
					
					List<FinAnonymousEntryPojo> listOfAnonymousEntryList = employeeFinancialServiceDao.getOnlinePaymentRererenceNumber(transactionServiceInfo);
					
					//if(!isThisIsModifyTransaction) {
						 if(listOfAnonymousEntryList.size()>1) {
							errorMsgs = new ArrayList<>();
							errorMsgs.add("Duplicate found for reference no " + transactionServiceInfo.getReferenceNo()+", Can not proceed the transaction.");
							throw new EmployeeFinancialServiceException("Duplicate found for reference no : " + transactionServiceInfo.getReferenceNo()+", Can not proceed the transaction.");
						}else if(!listOfAnonymousEntryList.isEmpty()) {
							anonymousEntryId = listOfAnonymousEntryList.get(0).getAnonymousEntryId();
						} else {
							errorMsgs = new ArrayList<>();
							errorMsgs.add("No data found for reference no " + transactionServiceInfo.getReferenceNo()+", Can not proceed the transaction");
							throw new EmployeeFinancialServiceException("No data found for reference no : " + transactionServiceInfo.getReferenceNo()+", Can not proceed the transaction");
						}
						if(!isThisIsModifyTransaction && !isThisShiftTransaction && !isThisEditTransaction) {
							FinAnonymousEntryPojo anonymousEntryPojo = listOfAnonymousEntryList.get(0);
							anonymousEntryPojo.setStatusId(Status.TRANSACTION_COMPLETED.getStatus());
							anonymousEntryPojo.setActiveStatusId(Status.ACTIVE.getStatus());
							employeeFinancialServiceDao.updateAnonymousEntryStatus(anonymousEntryPojo);
						}
					//}
					
					transactionServiceInfo.setAnonymousEntryId(anonymousEntryId);
					employeeFinancialServiceDao.saveTransactionAnonymousEntryMapping( financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinAnonymousEntryMapPojo.class));
				}
				FinTransactionOnlinePojo transactionOnlinePojo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionOnlinePojo.class);
				if(transactionServiceInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId())) {
					transactionOnlinePojo.setTransactionDate(transactionServiceInfo.getTransactionDate());
				}
				employeeFinancialServiceDao.saveTransactionOnlineDetails(transactionOnlinePojo);
			}//online
			else if (transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("waived off")) {
				FinTransactionWaivedOffPojo pojo =financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionWaivedOffPojo.class);
				pojo.setWaivedOffDate(transactionServiceInfo.getTransactionReceiveDate());
				employeeFinancialServiceDao.saveTransactionWaivedOffDetials(pojo );	
			}
		} catch (Exception ex) {ex.printStackTrace();
			errorMsgs = new ArrayList<String>();
			if(ex.getMessage()!=null && ex.getMessage().contains("No data found for reference no")) {
				errorMsgs.add(ex.getMessage());
			} else if(ex.getMessage()!=null && ex.getMessage().contains("Duplicate found for reference")) {
				errorMsgs.add(ex.getMessage());
			} else{
				errorMsgs.add("Error occurred while saving some records to the database plz try again once !");
			}
			log.error("Error occurred while saving the existing customer once again to the database plz try again once -" + ex.toString());
			throw new InSufficeientInputException(errorMsgs);
		}
		
		//payment set off details processing here
		processPaymentSetOffDetails(transactionServiceInfo,isTransactionForIsEmpty);
		//if the data is uploaded, then here below setting the loaded data to employeeFinancialServiceInfo
		employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
		employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
		employeeFinancialServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
		employeeFinancialServiceInfo.setThisUplaodedData(transactionServiceInfo.isThisUplaodedData());
		employeeFinancialServiceInfo.setCustomerAddressInfoList(transactionServiceInfo.getCustomerAddressInfoList());
		employeeFinancialServiceInfo.setSiteAddressInfoList(transactionServiceInfo.getSiteAddressInfoList());
		employeeFinancialServiceInfo.setFinProjectAccountResponseList(transactionServiceInfo.getFinProjectAccountResponseList());
		employeeFinancialServiceInfo.setOfficeDetailsList(transactionServiceInfo.getOfficeDetailsList());
		employeeFinancialServiceInfo.setFlatsResponse(transactionServiceInfo.getFlatsResponse());
		
		/*bvr 1 */
		//getting flat saleOwner Id based on account id and passing for recipet document
		Long siteAccountId1 =transactionServiceInfo.getSiteAccountId();transactionServiceInfo.getSiteBankAccountNumber();
		//Long transactionEntryId=transactionServiceInfo.getTransactionEntryId();
		EmployeeFinancialServiceInfo employeeFinancialRequestObj = new EmployeeFinancialServiceInfo();
		employeeFinancialRequestObj.setSiteAccountId(siteAccountId1);
		employeeFinancialRequestObj.setTransactionEntryId(transactionEntryId);
		employeeFinancialRequestObj.setSiteId(transactionServiceInfo.getSiteId());
		List<FlatSaleOwnersByAccount> saleOwner=employeeFinancialServiceDao.getFlatSaleOwnerByAccountId(employeeFinancialRequestObj);
		if(Util.isNotEmptyObject(saleOwner)) {
			transactionServiceInfo.setFlatSaleOwnerIdBasedOnAccountId(saleOwner.get(0).getFlatSaleOwnerIdBasedOnAccountId());
			transactionServiceInfo.setFlatSaleOwnerNameBasedOnAccountId(saleOwner.get(0).getFlatSaleOwnerNameBasedOnAccountId());
		}
		if(Util.isEmptyObject(saleOwner)) {
			log.info("***** Control inside the saleOwner.saleOwner() ***** "+saleOwner);
		}
		//if it is single level
		if(isThisIsFinalLevel) {//status changing from pending to completed 
			//if this is final level then receipt will generate
			processTransactionToFinalLevel(transactionServiceInfo,employeeFinancialServiceInfo,isTransactionForIsEmpty, isThisIsFinalLevel);
		}

		if(isThisIsModifyTransaction || isThisShiftTransaction || isThisEditTransaction) {
			long trnStatus = 0l;
			if (isThisIsModifyTransaction) {
				trnStatus = Status.MODIFY_INACTIVE.getStatus();//if any transaction is modified, then new transaction record will create, so old trn status changing to modify inactive
			} else if (isThisShiftTransaction) {
				trnStatus = Status.TRANSACTION_SHIFTED.getStatus();
			} else if(isThisEditTransaction) {
				trnStatus = Status.TRANSACTION_EDITED.getStatus();
			}
			//this code in activating previous transaction
			//this code should be end of the method to in activate Modified transaction
			EmployeeFinancialTransactionServiceInfo transactionServiceInfo2 = (EmployeeFinancialTransactionServiceInfo) transactionServiceInfo.clone();
			transactionServiceInfo2.setTransactionEntryId(transactionServiceInfo.getPrevTransactionEntryId());
			
			employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo2,trnStatus);
		}

		if(transactionServiceInfo.getReceiptStage()!=null && transactionServiceInfo.getReceiptStage().equalsIgnoreCase("Bounce")) {
			FinTransactionChequePojo chequePojo = (FinTransactionChequePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionChequePojo.class);
			chequePojo.setChequeBounceReasonId(MetadataId.OTHER.getId());
			chequePojo.setModifiedBy(transactionServiceInfo.getEmployeeId());
			chequePojo.setChequeBounceComment("Cheque Bounced");
			employeeFinancialServiceDao.updateChequeBounceDetails(chequePojo);
			transactionResponse =  rejectTransaction(transactionServiceInfo,transactionResponse,Status.CHEQUE_BOUNCED.getStatus());
		}
		
		if(!isThisUploadTransaction && !isThisShiftTransaction) {	//reciept chequ module
			List<FinTransactionApprovalDetailsPojo> listOfNextApprovalEmaEmails = employeeFinancialServiceDao.getTheNextLevelEmplaoyeeDetails(transactionServiceInfo);
			List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
			List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
			
			if(Util.isNotEmptyObject(listOfNextApprovalEmaEmails)) {	//reciept chequ module
				for (FinTransactionApprovalDetailsPojo approvalDetailsPojo : listOfNextApprovalEmaEmails) {
					transactionServiceInfo.setNextApprovalLevelName(approvalDetailsPojo.getEmpName());
					transactionServiceInfo.setListOfNextApprovalEmaEmails(Arrays.asList(approvalDetailsPojo));
					transactionServiceInfo.setOfficeDetailsList(officeDetailsResponseList);
					String status =  Status.CREATED.getDescription();
					if(transactionServiceInfo.isThisTransactionRequest() && transactionServiceInfo.isThisPaymentTransaction()) {
						status =  "Transaction Payment Request";
					}
					if(!isThisIsFinalLevel) {//no need email approval intimation for final level
						employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo),status,null);
					}
				}
			}
			//String s=null;s.trim();
		}
		
		if(isThisIsFinalLevel && isThisUploadTransaction) {
			//if this is upload transaction and final level
			insertReadjustedTransactionDetails(transactionServiceInfo);
		}
		
		if(transactionServiceInfo.isInsertOldApprToNewTrn()) {
		//inserting old transaction approve reject details
			employeeFinancialServiceDao.copyTransactionSetOffApprovaldetailsFrmUpload(transactionServiceInfo);
		}

		if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos())) {
			transactionServiceInfo = storeTransationUploadedImages(transactionServiceInfo,transactionServiceInfo.getTransactionModeName(),transactionServiceInfo.getTransactionEntryId());
			//if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos()))
			for (FileInfo fileInfo : transactionServiceInfo.getFileInfos()) {
				//System.out.println(fileInfo);
				fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
				FinTransactionEntryDocPojo pojo = (FinTransactionEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(fileInfo, FinTransactionEntryDocPojo.class);
				pojo.setTransactionEntryId(transactionEntryId);
				pojo.setDocumentType(MetadataId.UPLOADED.getId());
				pojo.setStatusId(Status.ACTIVE.getStatus());
				employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
			}
		}
		
		List<FileInfo> deleteFileList = transactionServiceInfo.getDeleteFileInfos();
		if(Util.isNotEmptyObject(deleteFileList)) {
			EmployeeFinancialRequest employeeFinancialRequest = new EmployeeFinancialRequest();
			employeeFinancialRequest.setFileInfos(deleteFileList);
			deleteUploadedAttachments(employeeFinancialRequest);
		}
		
		/*List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
		List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
		transactionServiceInfo.setOfficeDetailsList(officeDetailsResponseList);
		
		employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo), Status.CREATED.getDescription());*/
		return transactionResponse;
	}

	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialTransactionResponse saveInterestWaiver(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) 
			throws Exception {
		
		log.info(" ***** control inside EmployeeFinancialServiceImpl.saveInterestWaiver() ***** ");
		EmployeeFinancialTransactionResponse transactionResponse = new EmployeeFinancialTransactionResponse();
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		List<String> errorMsgs = new ArrayList<>();	
		boolean isThisIsFinalLevel = false;
		boolean isThisIsModifyTransaction = false;
		boolean isThisShiftTransaction = false;
		boolean isThisEditTransaction = false;
		boolean isThisUploadTransaction = false;
		String transactionReceiptNo = "";
		transactionServiceInfo.setStatusId(Status.ACTIVE.getStatus());
		transactionServiceInfo.setTransactionStatusId(Status.NEW.getStatus());
		transactionServiceInfo.setSendNotification(Boolean.TRUE);
		
		transactionServiceInfo.setOperationType(transactionServiceInfo.getOperationType()==null?"":transactionServiceInfo.getOperationType());
		
		getPaymentSetOffType(transactionServiceInfo);
		
		List<FinTransactionApprovalDetailsPojo> approvalDetailsList = null;
		if(isThisIsModifyTransaction) {
			//if this is modify transaction check employee is valid or not, and then send transaction to next approval level, from the current modifying trn level
			List<FinTransactionApprovalDetailsPojo> approveDetails = employeeFinancialServiceDao.isValidEmployeeToApproveTransaction(transactionServiceInfo,Status.CREATED);
			if (!approveDetails.isEmpty()) {
				long transactionSetOffApprovalId = approveDetails.get(0).getTransactionSetOffApprovalId();
				transactionServiceInfo.setTransactionSetOffApprovalId(transactionSetOffApprovalId);
			} else {
				throw new EmployeeFinancialServiceException("No approval found for this transaction.");
			}
			approvalDetailsList = employeeFinancialServiceDao.getNextLevelEmployeeApprovalDetails(transactionServiceInfo,approveDetails.get(0),Status.APPROVED);
		} else {//saveInterestWaiver
			approvalDetailsList = employeeFinancialServiceDao.getNextLevelEmployeeApprovalDetails(transactionServiceInfo,null,Status.CREATED);	
		}
		
		//if this is not the shift transaction then only check the approvals
		if(isThisShiftTransaction==false && isThisEditTransaction == false && isThisUploadTransaction!=true || (transactionServiceInfo.getReceiptStage()!=null 
				&& (transactionServiceInfo.getReceiptStage().equalsIgnoreCase("Received") || transactionServiceInfo.getReceiptStage().equalsIgnoreCase("Bounce"))) )  {
			if(approvalDetailsList.isEmpty()) {
				log.error("No mapping found for the transaction. Please contact to Support Team"+customerPropertyDetailsInfo.getFlatNo());
				throw new EmployeeFinancialServiceException("No mapping found for the transaction. Please contact to Support Team ");
			} else if(approvalDetailsList.size()>1) {
				log.error("No mapping found for the transaction. Please contact to Support Team"+customerPropertyDetailsInfo.getFlatNo());
				throw new EmployeeFinancialServiceException("Found duplicate approval mapping for the Transaction ");
			} else {
				FinTransactionApprovalDetailsPojo approvalDetails = approvalDetailsList.get(0);
				transactionServiceInfo.setThisTransactionRequest(false);
				if(approvalDetails.getTrnRequestLevel()!=null) {
					transactionServiceInfo.setThisTransactionRequest(MetadataId.YES.getId().equals(approvalDetails.getTrnRequestLevel()));	
				}
				isThisIsFinalLevel = isEmptyObject(approvalDetails.getNextTransactionSetOffApprovalLevelId())?true:false;
				
				transactionServiceInfo.setThisIsFinalLevel(isThisIsFinalLevel);log.info("Is this final approval :> "+isThisIsFinalLevel+" Mode "+transactionServiceInfo.getTransactionModeName());
				transactionServiceInfo.setTransactionSetOffApprovalLevelId(approvalDetails.getNextTransactionSetOffApprovalLevelId());
				transactionServiceInfo.setCurrentApprovalLevelName(transactionServiceInfo.getEmployeeName());
			}
		}
		
		List<FinTransactionEntryPojo> transactionEntryPojos = employeeFinancialServiceDao.isAnyInterestWaiverInApproval(transactionServiceInfo,Status.CREATED);
		boolean flag = Util.isNotEmptyObject(transactionEntryPojos);
		if(flag) {
			//throw new EmployeeFinancialServiceException("One interest waiver already pending can not initiate another Interest Waiver.");
		}
		
		Long transactionEntryId = 0l,transactionSetOffEntryId;
		try {
			
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());

			if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
				customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
			} else {
				List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos= employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
				if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
					customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
					transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
				}
			}
			transactionServiceInfo.setSiteName(customerPropertyDetailsInfo.getSiteName());
			
			transactionEntryId = employeeFinancialServiceDao.saveTransactionEntryDetails(financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionEntryPojo.class));
			transactionServiceInfo.setTransactionEntryId(transactionEntryId);
			getFinancialTransactionInvoiceNumber(transactionServiceInfo);
			transactionReceiptNo = generateTransactionReceiptNo(transactionServiceInfo);
			transactionServiceInfo.setTransactionReceiptNo(transactionReceiptNo);
			employeeFinancialServiceDao.updateTransactionDetails(transactionServiceInfo);
			
			transactionSetOffEntryId = employeeFinancialServiceDao.saveTransactionSetOffEntryDetails(financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionSetOffEntryPojo.class));
			transactionServiceInfo.setTransactionSetOffEntryId(transactionSetOffEntryId);
		
			if(Util.isNotEmptyObject(transactionServiceInfo.getComments())) {
				for (Map<String, String> comment : transactionServiceInfo.getComments()) {
					employeeFinancialServiceDao.saveTransactionEntryComments((FinTransactionCommentsPojo)financialMapper.copyPropertiesFromFinancialTransactionServiceInfoBeanToTransactionCommentsPojoBean(transactionServiceInfo,comment,FinTransactionCommentsPojo.class));	
				}
			}
			
			FinTransactionSetOffApprovalPojo  finTransactionSetOffApprovalPojo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionSetOffApprovalPojo.class);
			if(transactionServiceInfo.isThisIsFinalLevel() && Util.isNotEmptyObject(approvalDetailsList)) {
				finTransactionSetOffApprovalPojo.setTransactionSetOffApprovalLevelId(approvalDetailsList.get(0).getTransactionSetOffApprovalLevelId());
			}
			
			employeeFinancialServiceDao.saveNextLeveTransactionApprovalDetails(finTransactionSetOffApprovalPojo);
			
			//FinTransactionApprRejectStatPojo
			transactionServiceInfo.setTransactionActionType(Status.CREATED.getStatus());
			long transactionApproveStatId = 0l;
				
			log.error(" SaveFinancial Transaction Request saveApproveRejectStatistics"+transactionServiceInfo.getTransactionSetOffEntryId());
			FinTransactionApprRejectStatPojo apprRejectStatPojo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionApprRejectStatPojo.class);
			 
			if(isThisIsModifyTransaction) {
				apprRejectStatPojo.setActionType(Status.MODIFY_CREATED.getStatus());
			}
			transactionApproveStatId = employeeFinancialServiceDao.saveApproveRejectStatistics(apprRejectStatPojo);
 
			transactionServiceInfo.setTransactionApproveStatId(transactionApproveStatId);
			transactionServiceInfo.setTransactionSetOffApprovalId(finTransactionSetOffApprovalPojo.getTransactionSetOffApprovalId());
			
			if(isThisIsModifyTransaction || isThisEditTransaction) {
				checkChangedTransactionDetails(transactionServiceInfo);
			}
		
		} catch (Exception ex) {
			errorMsgs = new ArrayList<String>();
			errorMsgs.add("Error occurred while saving some records to the database plz try again once !");
			log.error("Error occurred while saving the existing customer once again to the database plz try again once -" + ex.toString());
			throw new InSufficeientInputException(errorMsgs);
		}
		
		//payment set off details processing here
		processPaymentSetOffDetails(transactionServiceInfo,false);

		if(isThisIsFinalLevel) {
			processTransactionToFinalLevel(transactionServiceInfo,null,false, isThisIsFinalLevel);
		}
		
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
		employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
		employeeFinancialServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
		
		if(!isThisUploadTransaction) {
			List<FinTransactionApprovalDetailsPojo> listOfNextApprovalEmaEmails = employeeFinancialServiceDao.getTheNextLevelEmplaoyeeDetails(transactionServiceInfo);
			List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
			List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
			
			if(Util.isNotEmptyObject(listOfNextApprovalEmaEmails)) {
				for (FinTransactionApprovalDetailsPojo approvalDetailsPojo : listOfNextApprovalEmaEmails) {
					transactionServiceInfo.setNextApprovalLevelName(approvalDetailsPojo.getEmpName());
					transactionServiceInfo.setListOfNextApprovalEmaEmails(Arrays.asList(approvalDetailsPojo));
					transactionServiceInfo.setOfficeDetailsList(officeDetailsResponseList);
					String status =  "Interest waiver initiated";

					if(!isThisIsFinalLevel) {//no need email approval intimation for final level
						employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo),status,null);
					}
				}
			}
			//String s=null;s.trim();
		}

		if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos())) {
			transactionServiceInfo = storeTransationUploadedImages(transactionServiceInfo,transactionServiceInfo.getTransactionModeName(),transactionServiceInfo.getTransactionEntryId());
			//if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos()))
			for (FileInfo fileInfo : transactionServiceInfo.getFileInfos()) {
				//System.out.println(fileInfo);
				fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
				FinTransactionEntryDocPojo pojo = (FinTransactionEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(fileInfo, FinTransactionEntryDocPojo.class);
				pojo.setTransactionEntryId(transactionEntryId);
				pojo.setDocumentType(MetadataId.UPLOADED.getId());
				pojo.setStatusId(Status.ACTIVE.getStatus());
				employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
			}
		}
		return transactionResponse;
	}
	//here added Propagation.REQUIRES_NEW
	//not req @Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	private List<Long> getPaymentSetOffType(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		List<Long> paymentSetOffTypes = new ArrayList<>();
		List<String> transactionTowards = new ArrayList<>();
		for (EmployeeFinTranPaymentSetOffInfo paymentSetOffDetails : transactionServiceInfo.getPaymentSetOffDetails()) {
			if (Util.isEmptyObject(paymentSetOffDetails.getAmount()) || Util.isEmptyObject(paymentSetOffDetails.getSetOffTypeName()) || paymentSetOffDetails.getAmount()==0) {
				continue;
			}
			
			if(paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("PRINCIPAL_AMOUNT") || paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("Fin_Booking_Form_Milestones") ) {
				paymentSetOffTypes.add(MetadataId.PRINCIPAL_AMOUNT.getId());
			}else {
				//this getMetaDataId method give legal,maintennaance id's
				long id = getMetaDataId(paymentSetOffDetails.getSetOffTypeName());
				if(paymentSetOffTypes.contains(id)) {
					continue;
				}
				paymentSetOffTypes.add(id);
			}
			String setOffAmountType = getConvenienceNameFromMetaData(paymentSetOffDetails.getSetOffTypeName());
			transactionTowards.add(setOffAmountType);
			if (getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.MODIFICATION_COST.getId()) && Util.isEmptyObject(paymentSetOffDetails.getInvoiceNo())) {
				throw new EmployeeFinancialServiceException("Please select invoice number for Modification Charges.");
			} else if (getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.LEGAL_COST.getId()) && Util.isEmptyObject(paymentSetOffDetails.getInvoiceNo())) {
				throw new EmployeeFinancialServiceException("Please select invoice number for Legal Charges.");
			}
		}
		
		if(Util.isEmptyObject(paymentSetOffTypes)) {
			log.info("Payment set off details not found could not proceed transaction."+transactionServiceInfo.getBookingFormId());
			throw new EmployeeFinancialServiceException("Payment set off details not found could not proceed transaction.");
		}
		
		if(paymentSetOffTypes.contains(MetadataId.FIN_PENALTY.getId()) &&
				FinTransactionType.RECEIPT.getId().equals(transactionServiceInfo.getTransactionTypeId()) &&
				!FinTransactionType.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionTypeId())) {
			try {

				//if set off type contains penalty id, then calculate interest amount
				EmployeeFinancialServiceInfo serviceInfo1 = new EmployeeFinancialServiceInfo();
				//FinancialProjectMileStoneInfo msInfo = new FinancialProjectMileStoneInfo();
				Timestamp date = new Timestamp(new Date().getTime());
				serviceInfo1.setPortNumber(transactionServiceInfo.getPortNumber());
				serviceInfo1.setEmpId(transactionServiceInfo.getEmployeeId());
				serviceInfo1.setBookingFormId(transactionServiceInfo.getBookingFormId());
				serviceInfo1.setBlockIds(Arrays.asList(transactionServiceInfo.getCustomerPropertyDetailsInfo().getBlockId()));
				serviceInfo1.setSiteId(transactionServiceInfo.getSiteId());
				
				/*msInfo.setProjectMilestoneId(0l);
				msInfo.setMileStoneNo(0l);
				msInfo.setMilestoneName("Dummy MileStone for Regenerate Demand Note");
				msInfo.setDemandNoteDate(date);
				msInfo.setMileStoneDueDate(date);
				msInfo.setInterestCalculationUptoDate(date);
				serviceInfo1.setFinancialProjectMileStoneRequests(Arrays.asList(msInfo));*/
				//loading last milestone object for calculating interest amount
				List<FinancialProjectMileStonePojo> lastMilestoneObjectPojoList = employeeFinancialServiceDao.getLastMilestoneDetails(serviceInfo1, Status.ACTIVE,"saveFinancialTransaction");
				if(Util.isNotEmptyObject(lastMilestoneObjectPojoList)) {
					FinancialProjectMileStoneInfo mileStoneInfo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(lastMilestoneObjectPojoList.get(0), FinancialProjectMileStoneInfo.class);
					mileStoneInfo.setDemandNoteDate(date);
					mileStoneInfo.setMileStoneDueDate(date);
					mileStoneInfo.setInterestCalculationUptoDate(date);
					
					mileStoneInfo.setSiteId(transactionServiceInfo.getSiteId());
					serviceInfo1.setFinancialProjectMileStoneRequests(Arrays.asList(mileStoneInfo));	
					serviceInfo1.setBlockIds(null);//making blockids empty, other wise it will calculate all flats interest
					serviceInfo1.setRequestUrl("saveFinancialTransaction");
					//calculating interest upto date, if this is interest paid transaction
					interestCalculateAndConstructTransactionObject(serviceInfo1);
				}
			
			} catch(Exception ex) {
				ex.printStackTrace();
			}
		}
		
		transactionServiceInfo.setPaymentSetOffTypes(paymentSetOffTypes);
		transactionServiceInfo.setTransactionTowards(transactionTowards);
		return paymentSetOffTypes;
	}

	@SuppressWarnings("unused")
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)//uncomment it
	public EmployeeFinancialTransactionResponse editFinancialTransaction(EmployeeFinancialTransactionServiceInfo serviceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.editFinancialTransaction() *****");
		EmployeeFinancialTransactionResponse resp = new EmployeeFinancialTransactionResponse();

		long transactionTypeId = serviceInfo.getTransactionTypeId();
		long transactionModeId = serviceInfo.getTransactionModeId();
		String transactionTypeName = serviceInfo.getTransactionTypeName();
		String transactionModeName = serviceInfo.getTransactionModeName();
		List<FileInfo> deleteFileList = serviceInfo.getDeleteFileInfos();
		FinTransactionEntryDetailsInfo transactionEntryDetailsInfo = (FinTransactionEntryDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(serviceInfo, FinTransactionEntryDetailsInfo.class);
		transactionEntryDetailsInfo.setCondition(FinEnum.EDIT_TRANSACTION.getName());
		serviceInfo.setCondition(FinEnum.EDIT_TRANSACTION.getName());
		serviceInfo.setThisEditTransaction(Boolean.TRUE);
		try {
			if(serviceInfo.getTransactionModeName().equals(MetadataId.ONLINE.getName())) {
				//transactionServiceInfo.getTransactionTypeName().equals("Receipt") && 
				EmployeeFinancialTransactionServiceInfo serviceInfoFoAnmsEntry = financialMapper.constructAnonymouesEntryInfo(serviceInfo);
				doOnlinePaymentAnonymousEntry(serviceInfoFoAnmsEntry);
				
				FinAnonymousEntryPojo anonymousEntryPojo = new FinAnonymousEntryPojo();
				anonymousEntryPojo.setAnonymousEntryId(serviceInfoFoAnmsEntry.getAnonymousEntryId());
				anonymousEntryPojo.setStatusId(Status.TRANSACTION_COMPLETED.getStatus());
				anonymousEntryPojo.setActiveStatusId(Status.ACTIVE.getStatus());
				//updating AnonymousEntryStatus status to completed,bcoz completed transaction edited 
				employeeFinancialServiceDao.updateAnonymousEntryStatus(anonymousEntryPojo);
			}
		} catch(Exception ex) {
			log.info(ex.getMessage(), ex);	
		}
		if (transactionTypeName.equalsIgnoreCase("Receipt")) {
			
			if(FinTransactionMode.WAIVED_OFF.getId().equals(serviceInfo.getTransactionModeId())) {
				for(EmployeeFinTranPaymentSetOffInfo setOff :serviceInfo.getPaymentSetOffDetails())
				{
					if("Principal_Amount".equalsIgnoreCase(setOff.getSetOffTypeName()) && 0<setOff.getAmount())
					{
						throw new EmployeeFinancialServiceException("Principal Amount can't be Waived off.");
					}
				}
			}
			//if(serviceInfo.isRecievedDateORSetOffChanged()) {
	  			 //reverting and shifting the transaction of receipt transactions
				 editReceiptTransactionAmount(serviceInfo, transactionEntryDetailsInfo);
			/*} else {
				FinTransactionEntryPojo entryPojo = (FinTransactionEntryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(serviceInfo,FinTransactionEntryPojo.class);
				employeeFinancialServiceDao.updateTransactionEntryDetails(entryPojo);
				if(serviceInfo.getTransactionModeName().equalsIgnoreCase("cheque")) {
					employeeFinancialServiceDao.updateTransactionChequeDetials((FinTransactionChequePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(serviceInfo,FinTransactionChequePojo.class));	
				} else {
					employeeFinancialServiceDao.updateTransactionOnlineDetails((FinTransactionOnlinePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(serviceInfo,FinTransactionOnlinePojo.class));
				}
			}*/
		} else {
			// reverting and shifting the transaction of Payment transactions
			editPaymentTransactionAmount(serviceInfo, transactionEntryDetailsInfo);
		}
		
		if(Util.isNotEmptyObject(deleteFileList)) {//deleting files in edit transaction, if any file deleted
			EmployeeFinancialRequest employeeFinancialRequest = new EmployeeFinancialRequest();
			employeeFinancialRequest.setFileInfos(deleteFileList);
			deleteUploadedAttachments(employeeFinancialRequest);
		}

		log.info("***** EmployeeFinancialServiceImpl.editFinancialTransaction() method execution completed *****");
		return resp;
	}
	
	@SuppressWarnings("unused")
	@Override
	public EmployeeFinancialTransactionResponse reAdjustTransaction(EmployeeFinancialTransactionServiceInfo serviceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.reAdjustTransaction() *****");
		long transactionTypeId = serviceInfo.getTransactionTypeId();
		long transactionModeId = serviceInfo.getTransactionModeId();
		String transactionTypeName = serviceInfo.getTransactionTypeName();
		String transactionModeName = serviceInfo.getTransactionModeName();

		FinTransactionEntryDetailsInfo transactionEntryDetailsInfo = (FinTransactionEntryDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(serviceInfo, FinTransactionEntryDetailsInfo.class);
		transactionEntryDetailsInfo.setCondition(FinEnum.EDIT_TRANSACTION.getName());
		serviceInfo.setCondition(FinEnum.EDIT_TRANSACTION.getName());
		serviceInfo.setThisEditTransaction(Boolean.TRUE);
		
		if (transactionTypeName.equalsIgnoreCase("Receipt")) {
			//reverting and shifting the transaction of receipt transactions
			//editReceiptTransactionAmount(serviceInfo, transactionEntryDetailsInfo);
			shiftTheReceiptTransactions(serviceInfo, transactionEntryDetailsInfo, null);
		} else {
			// reverting and shifting the transaction of Payment transactions
			//editPaymentTransactionAmount(serviceInfo, transactionEntryDetailsInfo);
			shiftThePaymentTransactions(serviceInfo, transactionEntryDetailsInfo);
		}
		
		return null;
	}
	
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	private void editPaymentTransactionAmount(EmployeeFinancialTransactionServiceInfo editTransactionInfo,
			FinTransactionEntryDetailsInfo transactionEntryDetailsInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.editPaymentTransactionAmount() *****");
		EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) editTransactionInfo.clone();
		clonedTransactionServiceInfo.setOperationType(FinEnum.EDIT_TRANSACTION.getName());
		clonedTransactionServiceInfo.setThisEditTransaction(Boolean.TRUE);
		
		List<Long> actualFlatIds = editTransactionInfo.getActualFlatIds(); 
		Long actualBookingFormId = editTransactionInfo.getActualBookingFormId();
		
		//if flat changed then we have to take the actual Flat Adjusted amount back, so here assigning actual values to object	
		editTransactionInfo.setFlatIds(actualFlatIds); 
		editTransactionInfo.setBookingFormId(actualBookingFormId);
		editTransactionInfo.setStatusId(Status.ACTIVE.getStatus());
		
		transactionEntryDetailsInfo.setBookingFormId(actualBookingFormId);//flat no can change so maintining actual data
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo.setFlatBookingId(editTransactionInfo.getBookingFormId());
		customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
		customerPropertyDetailsInfo.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());
		
		List<FinBookingFormAccountPaymentDetailsPojo> paymentList = employeeFinancialServiceDao.getTransactionPayemntDetails(transactionEntryDetailsInfo);
		if(Util.isEmptyObject(paymentList)) {
			log.info("Failed to process transaction.");
			throw new EmployeeFinancialServiceException("Failed to process transaction.");
		}

		if(editTransactionInfo.getTransactionReceiveDate()!=null) {
			editTransactionInfo.setTransactionReceiveDate(TimeUtil.addCurrentTimeToTimeStamp(editTransactionInfo.getTransactionReceiveDate()));
		}
		if(editTransactionInfo.getTransactionDate()!=null) {
			editTransactionInfo.setTransactionDate(TimeUtil.addCurrentTimeToTimeStamp(editTransactionInfo.getTransactionDate()));
		}

		if (editTransactionInfo.getTransactionDate().before(paymentList.get(0).getTransactionDate())) {
			editTransactionInfo.setActualTransactionDate(editTransactionInfo.getTransactionDate());
			transactionEntryDetailsInfo.setActualTransactionReceiveDate(editTransactionInfo.getTransactionDate());
			transactionEntryDetailsInfo.setActualTransactionDate(editTransactionInfo.getTransactionDate());
		} else {
			editTransactionInfo.setActualTransactionDate(paymentList.get(0).getTransactionDate());
			transactionEntryDetailsInfo.setActualTransactionReceiveDate(paymentList.get(0).getTransactionDate());
			transactionEntryDetailsInfo.setActualTransactionDate(paymentList.get(0).getTransactionDate());
		}
		clonedTransactionServiceInfo.setPrevTransactionReceiptNo(paymentList.get(0).getTransactionReceiptNo());
		clonedTransactionServiceInfo.setTransactionClosedDate(paymentList.get(0).getTransactionClosedDate());
		clonedTransactionServiceInfo.setIsRecordUploaded(paymentList.get(0).getIsRecordUploaded());
		clonedTransactionServiceInfo.setExcelRecordNo(paymentList.get(0).getExcelRecordNo());

		takePaymentTransactionAmountBack(paymentList,editTransactionInfo);

		shiftThePaymentTransactions(editTransactionInfo, transactionEntryDetailsInfo);		

		shiftTheReceiptTransactions(editTransactionInfo, transactionEntryDetailsInfo, customerPropertyDetailsInfo);
		
		List<FinTransactionApprStatPojo> finTransactionApprStatPojoList = employeeFinancialServiceDao.getFinTransactionApprStatData(clonedTransactionServiceInfo);
		clonedTransactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);

		if(Util.isEmptyObject(editTransactionInfo.getReConstructedtransactionServiceRequest())) {
			editTransactionInfo.setReConstructedtransactionServiceRequest(new ArrayList<EmployeeFinancialTransactionServiceInfo>());
		}
		//clonedTransactionServiceInfo is the current transaction edited info
		editTransactionInfo.getReConstructedtransactionServiceRequest().add(0,clonedTransactionServiceInfo);
		
		employeeFinancialHelper.sortTransactionDataOnEdit(editTransactionInfo);

		if(Util.isNotEmptyObject(editTransactionInfo.getReConstructedtransactionServiceRequest())) {
			//Re-executing the Request For Edit Transaction
			for (EmployeeFinancialTransactionServiceInfo reConstructedtransactionServiceInfo : editTransactionInfo.getReConstructedtransactionServiceRequest()) {
				
				EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo1 = (EmployeeFinancialTransactionServiceInfo) reConstructedtransactionServiceInfo.clone();
				System.out.println(reConstructedtransactionServiceInfo.getTransactionDate()+""+reConstructedtransactionServiceInfo.getTransactionReceiveDate()+"\t"+reConstructedtransactionServiceInfo.getPrevTransactionEntryId()+"\t"+(reConstructedtransactionServiceInfo.getTransactionEntryId())+"\t"+reConstructedtransactionServiceInfo.getTransactionAmount());
				saveFinancialTransactionRequest(reConstructedtransactionServiceInfo);
				
				if(Util.isNotEmptyObject(reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList())) {
					for (FinTransactionApprStatPojo apprStatPojo : reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList()) {
						apprStatPojo.setTransactionSetOffEntryId(reConstructedtransactionServiceInfo.getTransactionSetOffEntryId());
						apprStatPojo.setComment(apprStatPojo.getComments());
						employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,reConstructedtransactionServiceInfo);
						//employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
					}
				}
				if(!reConstructedtransactionServiceInfo.getPrevTransactionEntryId().equals(editTransactionInfo.getTransactionEntryId())) {
					List<FinTransactionEntryDocResponse> transactionEntryDocResponsesList = reConstructedtransactionServiceInfo.getPrevTransactionEntryDetailsResponse().getTransactionEntryDocResponsesList();
					if(Util.isNotEmptyObject(transactionEntryDocResponsesList)) {
						for (FinTransactionEntryDocResponse entryDocResponse : transactionEntryDocResponsesList) {
							FinTransactionEntryDocPojo pojo = financialMapper.constructFinTransactionEntryDocPojoObject(entryDocResponse,reConstructedtransactionServiceInfo);
							employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						}
					}
				}
				employeeFinancialServiceDao.copyTransactionSetOffApprovaldetails(clonedTransactionServiceInfo1,reConstructedtransactionServiceInfo);
			}
		}
		
		log.info("***** EmployeeFinancialServiceImpl.editPaymentTransactionAmount() method execution completed *****");
	}

	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	private void editReceiptTransactionAmount(EmployeeFinancialTransactionServiceInfo editTransactionInfo,
			FinTransactionEntryDetailsInfo transactionEntryDetailsInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.editReceiptTransactionAmount() *****");
		//Cloning the object if in case of Flat changed, So we can send this object for re - adjusting the amount
		EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) editTransactionInfo.clone();
		clonedTransactionServiceInfo.setOperationType(FinEnum.EDIT_TRANSACTION.getName());
		clonedTransactionServiceInfo.setThisEditTransaction(Boolean.TRUE);
		
		List<Long> actualFlatIds = editTransactionInfo.getActualFlatIds(); 
		Long actualBookingFormId = editTransactionInfo.getActualBookingFormId();

		//if flat changed then we have to take the actual Flat Adjusted amount back, so here assigning actual id values to object	
		editTransactionInfo.setFlatIds(actualFlatIds); 
		editTransactionInfo.setBookingFormId(actualBookingFormId);
		transactionEntryDetailsInfo.setBookingFormId(actualBookingFormId);
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo.setFlatBookingId(editTransactionInfo.getBookingFormId());
		customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
		customerPropertyDetailsInfo.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());
		editTransactionInfo.setStatusId(Status.ACTIVE.getStatus());

		//this clone object is used for load same payment list again
		FinTransactionEntryDetailsInfo transactionEntryDetailsInfoForLoadPaymentList = (FinTransactionEntryDetailsInfo) transactionEntryDetailsInfo.clone();
		//------------------this object holding current editing transaction actual data 
		List<FinTransactionEntryDetailsPojo> paymentList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfo, customerPropertyDetailsInfo);

		if(Util.isEmptyObject(paymentList)) {
			log.info("Failed to process transaction.");
			throw new EmployeeFinancialServiceException("Failed to process transaction.");
		}
		//loading actual payment set off details
		//List<FinTransactionSetOffPojo> finTransactionSetOffPojoList = employeeFinancialServiceDao.getFinTransactionSetOffData(transactionEntryDetailsInfo);
		
		if(editTransactionInfo.getTransactionReceiveDate()!=null) {
			editTransactionInfo.setTransactionReceiveDate(TimeUtil.addCurrentTimeToTimeStamp(editTransactionInfo.getTransactionReceiveDate()));
		}
		if(editTransactionInfo.getTransactionDate()!=null) {
			editTransactionInfo.setTransactionDate(TimeUtil.addCurrentTimeToTimeStamp(editTransactionInfo.getTransactionDate()));
		}
		
		//12-may - 1st milestone - Receipt 
		//15-may - 2nd milestone - edited , changed to 11-may
		//16-may - 2nd milestone - refund
		//18-may - 3rd milestone - Receipt 

		//12-may - 1st milestone
		//15-may - 2nd milestone
		//18-may - 3rd milestone

		//if current edited received date is before the Actual edited date, then take current edited date to load next trn of this date
		if (editTransactionInfo.getTransactionReceiveDate().before(paymentList.get(0).getTransactionReceiveDate())) {
			editTransactionInfo.setActualTransactionReceiveDate(editTransactionInfo.getTransactionReceiveDate());
			transactionEntryDetailsInfo.setActualTransactionReceiveDate(editTransactionInfo.getTransactionReceiveDate());
			transactionEntryDetailsInfo.setActualTransactionDate(editTransactionInfo.getTransactionReceiveDate());
		}else {//if current edited received date is after the Actual edited date, then take actual date to load next trn of this date
			editTransactionInfo.setActualTransactionReceiveDate(paymentList.get(0).getTransactionReceiveDate());
			transactionEntryDetailsInfo.setActualTransactionReceiveDate(paymentList.get(0).getTransactionReceiveDate());
			transactionEntryDetailsInfo.setActualTransactionDate(paymentList.get(0).getTransactionReceiveDate());
		}
		clonedTransactionServiceInfo.setPrevTransactionReceiptNo(paymentList.get(0).getTransactionReceiptNo());
		clonedTransactionServiceInfo.setTransactionClosedDate(paymentList.get(0).getTransactionClosedDate());
		clonedTransactionServiceInfo.setIsRecordUploaded(paymentList.get(0).getIsRecordUploaded());
		clonedTransactionServiceInfo.setExcelRecordNo(paymentList.get(0).getExcelRecordNo());
		
		//shifting the Payment refund transaction
		shiftThePaymentTransactions(editTransactionInfo, transactionEntryDetailsInfo);
		//shifting the Receipt entry transaction
		shiftTheReceiptTransactions(editTransactionInfo, transactionEntryDetailsInfo, customerPropertyDetailsInfo);
		
		paymentList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfoForLoadPaymentList, customerPropertyDetailsInfo);
		//reverting all the adjusted amount of current edited transaction
		takeReceiptTransactionAmountBack(paymentList,editTransactionInfo,transactionEntryDetailsInfo,customerPropertyDetailsInfo);
		
		if(Util.isEmptyObject(editTransactionInfo.getReConstructedtransactionServiceRequest())) {
			editTransactionInfo.setReConstructedtransactionServiceRequest(new ArrayList<EmployeeFinancialTransactionServiceInfo>());
		}
		
		List<FinTransactionApprStatPojo> finTransactionApprStatPojoList = employeeFinancialServiceDao.getFinTransactionApprStatData(clonedTransactionServiceInfo);
		clonedTransactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);
		//-----------------clonedTransactionServiceInfo this obejct is clone object of current editing transaction
		editTransactionInfo.getReConstructedtransactionServiceRequest().add(0,clonedTransactionServiceInfo);
		//sorting the transaction based on recive date, after reverting adjusted amount
		employeeFinancialHelper.sortTransactionDataOnEdit(editTransactionInfo);
		
		if(Util.isNotEmptyObject(editTransactionInfo.getReConstructedtransactionServiceRequest())) {
			//Re-executing the Request For Edit Transaction
			//reinserting the transaction, so these transaction again readjust on milestones
			for (EmployeeFinancialTransactionServiceInfo reConstructedtransactionServiceInfo : editTransactionInfo.getReConstructedtransactionServiceRequest()) {
				
				EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo1 = (EmployeeFinancialTransactionServiceInfo) reConstructedtransactionServiceInfo.clone();
				System.out.println(reConstructedtransactionServiceInfo.getTransactionDate()+""+reConstructedtransactionServiceInfo.getTransactionReceiveDate()+"\t"+reConstructedtransactionServiceInfo.getPrevTransactionEntryId()+"\t"+(reConstructedtransactionServiceInfo.getTransactionEntryId())+"\t"+reConstructedtransactionServiceInfo.getTransactionAmount());
				reConstructedtransactionServiceInfo.setBookingFormId(reConstructedtransactionServiceInfo.getActualBookingFormId());
				saveFinancialTransactionRequest(reConstructedtransactionServiceInfo);
				
				if(Util.isNotEmptyObject(reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList())) {
					for (FinTransactionApprStatPojo apprStatPojo : reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList()) {
						apprStatPojo.setTransactionSetOffEntryId(reConstructedtransactionServiceInfo.getTransactionSetOffEntryId());
						apprStatPojo.setComment(apprStatPojo.getComments());
						//copying approve reject details
						employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,reConstructedtransactionServiceInfo);
						//copying changed details
						//employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
					}
				}
				//adding previous document records to new
				if(!reConstructedtransactionServiceInfo.getPrevTransactionEntryId().equals(editTransactionInfo.getTransactionEntryId())) {
					List<FinTransactionEntryDocResponse> transactionEntryDocResponsesList = reConstructedtransactionServiceInfo.getPrevTransactionEntryDetailsResponse().getTransactionEntryDocResponsesList();
					if(Util.isNotEmptyObject(transactionEntryDocResponsesList)) {
						for (FinTransactionEntryDocResponse entryDocResponse : transactionEntryDocResponsesList) {
							FinTransactionEntryDocPojo pojo = financialMapper.constructFinTransactionEntryDocPojoObject(entryDocResponse,reConstructedtransactionServiceInfo);
							employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						}
					}
				}
				employeeFinancialServiceDao.copyTransactionSetOffApprovaldetails(clonedTransactionServiceInfo1,reConstructedtransactionServiceInfo);
				
			}
		}
		log.info("***** EmployeeFinancialServiceImpl.editReceiptTransactionAmount() method execution completed *****");
		//String s=null;s.trim();
	}

	@SuppressWarnings("unused")
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)//uncomment it
	public EmployeeFinancialTransactionResponse deleteFinancialTransaction(EmployeeFinancialTransactionServiceInfo serviceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.deleteFinancialTransaction() *****");
		EmployeeFinancialTransactionResponse resp = new EmployeeFinancialTransactionResponse();

		long transactioEntryId = serviceInfo.getTransactionEntryId();
		long transactioSetOffEntryId = serviceInfo.getTransactionSetOffEntryId();
		long transactionTypeId = serviceInfo.getTransactionTypeId();
		long transactionModeId = serviceInfo.getTransactionModeId();
		String transactionTypeName = serviceInfo.getTransactionTypeName();
		String transactionModeName = serviceInfo.getTransactionModeName();
		
		FinTransactionEntryDetailsInfo transactionEntryDetailsInfo = (FinTransactionEntryDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(serviceInfo, FinTransactionEntryDetailsInfo.class);
		transactionEntryDetailsInfo.setCondition(FinEnum.DELETE_TRANSACTION.getName());
		serviceInfo.setCondition(FinEnum.DELETE_TRANSACTION.getName());
		serviceInfo.setThisDeleteTransaction(Boolean.TRUE);
		if (transactionTypeName.equalsIgnoreCase("Receipt")) {
			// reverting and shifting the transaction of receipt transactions
			revertReceiptTransactionAmount(serviceInfo, transactionEntryDetailsInfo);

			//12-may - 1st milestone - Receipt 
			//15-may - 2nd milestone - deleted  
			//16-may - 3rd milestone - Receipt 
			//18-may - 2nd milestone - Payment
			//20-may - 3rd milestone - Receipt
			
			//12-may - 1st milestone
			//16-may - 2nd milestone
			//20-may - 3rd milestone
			
		} else {
			// reverting and shifting the transaction of Payment transactions
			revertPyamentTransactionAmount(serviceInfo, transactionEntryDetailsInfo);
		}

		log.info("***** EmployeeFinancialServiceImpl.deleteFinancialTransaction() method execution completed *****");
		return resp;
	}
	
	private void revertPyamentTransactionAmount(EmployeeFinancialTransactionServiceInfo serviceInfo,
			FinTransactionEntryDetailsInfo transactionEntryDetailsInfo) throws Exception{
		log.info("***** Control inside the EmployeeFinancialServiceImpl.revertPyamentTransactionAmount() *****");
		List<FinBookingFormAccountPaymentDetailsPojo> paymentList = employeeFinancialServiceDao.getTransactionPayemntDetails(transactionEntryDetailsInfo);
		if(paymentList.isEmpty()) {
			log.info("Failed to process transaction.");
			throw new EmployeeFinancialServiceException("Failed to process transaction.");
		}

		if (Util.isNotEmptyObject(paymentList)) {
			if(paymentList.get(0).getTransactionEntryId().equals(serviceInfo.getTransactionEntryId())) {
				serviceInfo.setTransactionSetOffEntryId(paymentList.get(0).getTransactionSetOffEntryId());
			}
		}
		
		serviceInfo.setActualTransactionDate(paymentList.get(0).getTransactionDate());
		transactionEntryDetailsInfo.setActualTransactionDate(paymentList.get(0).getTransactionDate());//data will load the after this paymentList.get(0).getTransactionDate() fro shifting
		
		serviceInfo.setActualTransactionReceiveDate(paymentList.get(0).getTransactionDate());
		transactionEntryDetailsInfo.setActualTransactionReceiveDate(paymentList.get(0).getTransactionDate());//data will load the after this paymentList.get(0).getTransactionDate() fro shifting 

		serviceInfo.setTransactionClosedDate(paymentList.get(0).getTransactionClosedDate());
		serviceInfo.setIsRecordUploaded(paymentList.get(0).getIsRecordUploaded());
		serviceInfo.setExcelRecordNo(paymentList.get(0).getExcelRecordNo());
		
		//if this is payment trn then take all amount revert
		takePaymentTransactionAmountBack(paymentList,serviceInfo);

		if (Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && !serviceInfo.isThisReCallService()) {
			serviceInfo.setTransactionActionType(Status.TRANSACTION_DELETED.getStatus());
			log.info("*****  revertPyamentTransactionAmount() calling saveApproveRejectStatistics() *****"+serviceInfo.getTransactionSetOffEntryId());
			employeeFinancialServiceDao.saveApproveRejectStatistics(financialMapper.copyPropertiesFromInfoBeanToPojoBean(serviceInfo,FinTransactionApprRejectStatPojo.class));
			employeeFinancialServiceDao.updateTransactionStatus(serviceInfo, Status.TRANSACTION_DELETED.getStatus());
		} else {
			employeeFinancialServiceDao.updateTransactionStatus(serviceInfo, Status.REJECTED.getStatus());
		}
		// if this is not recalled method then only execute the shiftTheTransactions method
		if (Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && !serviceInfo.isThisReCallService()) {
			shiftThePaymentTransactions(serviceInfo, transactionEntryDetailsInfo);
		}

		if (Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && serviceInfo.isThisReCallService() == false) {
			shiftTheReceiptTransactions(serviceInfo, transactionEntryDetailsInfo, null);
		}

		
		//====================== added later missed this code 12-04-2021
		
		if(Util.isNotEmptyObject(serviceInfo.getReConstructedtransactionServiceRequest()) && Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && !serviceInfo.isThisReCallService()) {
			employeeFinancialHelper.sortTransactionDataOnEdit(serviceInfo);
			//Re-executing the Request For Edit Transaction
			for (EmployeeFinancialTransactionServiceInfo reConstructedtransactionServiceInfo : serviceInfo.getReConstructedtransactionServiceRequest()) {
				
				EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo1 = (EmployeeFinancialTransactionServiceInfo) reConstructedtransactionServiceInfo.clone();
				System.out.println(reConstructedtransactionServiceInfo.getTransactionDate()+""+reConstructedtransactionServiceInfo.getTransactionReceiveDate()+"\t"+reConstructedtransactionServiceInfo.getPrevTransactionEntryId()+"\t"+(reConstructedtransactionServiceInfo.getTransactionEntryId())+"\t"+reConstructedtransactionServiceInfo.getTransactionAmount());
				saveFinancialTransactionRequest(reConstructedtransactionServiceInfo);
				
				if(Util.isNotEmptyObject(reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList())) {
					for (FinTransactionApprStatPojo apprStatPojo : reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList()) {
						apprStatPojo.setTransactionSetOffEntryId(reConstructedtransactionServiceInfo.getTransactionSetOffEntryId());
						apprStatPojo.setComment(apprStatPojo.getComments());
						//copying prev transaction approval details to current shifted transaction approval details
						employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,reConstructedtransactionServiceInfo);
						//copying prev transaction changed details to current shifted transaction
						//employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
					}
				}
				
				if(!reConstructedtransactionServiceInfo.getPrevTransactionEntryId().equals(serviceInfo.getTransactionEntryId()) && Util.isNotEmptyObject(reConstructedtransactionServiceInfo.getPrevTransactionEntryDetailsResponse())) {
					List<FinTransactionEntryDocResponse> transactionEntryDocResponsesList = reConstructedtransactionServiceInfo.getPrevTransactionEntryDetailsResponse().getTransactionEntryDocResponsesList();
					if(Util.isNotEmptyObject(transactionEntryDocResponsesList)) {
						for (FinTransactionEntryDocResponse entryDocResponse : transactionEntryDocResponsesList) {
							FinTransactionEntryDocPojo pojo = financialMapper.constructFinTransactionEntryDocPojoObject(entryDocResponse,reConstructedtransactionServiceInfo);
							employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						}
					}
				}
				
				//copying Transaction SetOff Approval details of prev transction
				employeeFinancialServiceDao.copyTransactionSetOffApprovaldetails(clonedTransactionServiceInfo1,reConstructedtransactionServiceInfo);
				
			}
		}
		//======================
		
		
		log.info("***** EmployeeFinancialServiceImpl.revertPyamentTransaction() method execution completed ***** ");
	}

	private void takePaymentTransactionAmountBack(List<FinBookingFormAccountPaymentDetailsPojo> paymentList,
			EmployeeFinancialTransactionServiceInfo serviceInfo) {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.takePaymentTransactionAmountBack() *****");
		@SuppressWarnings("unused")
		int result = 0;
		double refundAmount = 0d;
		Long paymentType = null;
		FinancialProjectMileStonePojo penaltyaccPojo = null;
		List<FinPenaltyStatisticsPojo> penaltyStatisticsPojos = null;
		FinancialProjectMileStoneInfo finProjDemandNoteInfo = null;
		for (FinBookingFormAccountPaymentDetailsPojo paymentRefundDetailsPojo : paymentList) {
			log.info(paymentRefundDetailsPojo); paymentType = null;
			if (paymentRefundDetailsPojo != null) {
				refundAmount = paymentRefundDetailsPojo.getRefundAmount() == null ? 0d : paymentRefundDetailsPojo.getRefundAmount();
				//reverting all the refund amount on Payment
				if (refundAmount != 0 && paymentRefundDetailsPojo.getType() != null) {
					if(paymentRefundDetailsPojo.getType().equals(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId())) {
						//here again assigning refunded amount to the excess amount record  
						FinBookingFormExcessAmountPojo excessAmountPojo = financialMapper.constructFinBookingFormExcessAmountPojo(paymentRefundDetailsPojo,serviceInfo);
						result = employeeFinancialServiceDao.revertExcessAmountOfPayment(excessAmountPojo);	
					} else if(paymentRefundDetailsPojo.getType().equals(MetadataId.FIN_BOOKING_FORM_ACCOUNTS.getId())) {
						//here again assigning refunded amount to the FinBookingFormAccounts record
						FinBookingFormAccountsPojo bookingFormAccountsPojo = financialMapper.constructFinBookingFormAccountsPojo(paymentRefundDetailsPojo,serviceInfo);
						result = employeeFinancialServiceDao.revertFinBookingFormAccountsAmountOfPayment(bookingFormAccountsPojo);
						
						bookingFormAccountsPojo.setIsInterestCalcCompleted(null);
						employeeFinancialServiceDao.updateBookingFormAccountInterestDetails(bookingFormAccountsPojo);
						
						finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
						finProjDemandNoteInfo.setCondition("SetOffPayment");
						finProjDemandNoteInfo.setFinBookingFormAccountsId(bookingFormAccountsPojo.getFinBookingFormAccountsId());
						
						List<Map<String, Object>> recordDetailslist = employeeFinancialServiceDao.getFinBookingFormAccountType(finProjDemandNoteInfo);
						if(Util.isNotEmptyObject(recordDetailslist)) {
							paymentType = Long.valueOf(recordDetailslist.get(0).get("TYPE").toString());
							finProjDemandNoteInfo.setType(Arrays.asList(paymentType));
							if (paymentType.equals(MetadataId.FIN_PENALTY.getId())) {
								penaltyaccPojo = new FinancialProjectMileStonePojo();
								penaltyaccPojo.setTypeId(Long.valueOf(recordDetailslist.get(0).get("TYPE_ID").toString()));//penalty record id
								penaltyaccPojo.setType(paymentType);
							
								penaltyStatisticsPojos = employeeFinancialServiceDao.loadPenaltyStatisticsData(penaltyaccPojo);
								penaltyaccPojo.setPenaltyStatisticsPojos(penaltyStatisticsPojos);

								penaltyaccPojo.setSetOffAmount(bookingFormAccountsPojo.getPaidAmount());//refund amount
								penaltyGstAmountAndAdjustAmount(penaltyaccPojo,false);//penalty adjustment, false means adjust the amount, or increase
								//listOfPaidInterestCostList.add(penaltyaccPojo);//Refund transaction
							}
						}
						
						//double settleAmount = 0d;
						//double paidAmount = bookingFormAccountsPojo.getPaidAmount()==null?0d: bookingFormAccountsPojo.getPaidAmount();
						//List<FinBookingFormAccountsStatementPojo> accountsStatementPojos = employeeFinancialServiceDao.
						//		getBookingFormAccountsStatementAndReceiptData(bookingFormAccountsPojo, FinEnum.DESC);
						/*for (FinBookingFormAccountsStatementPojo accStatementPojo : accountsStatementPojos) {//not in use
							double actualPaidAmount = accStatementPojo.getActualPaidAmount() == null ? 0d :accStatementPojo.getActualPaidAmount();
							double statementRefundAmount = accStatementPojo.getStatementRefundAmount() == null ? 0d :accStatementPojo.getStatementRefundAmount();
							if (paidAmount > 0 && statementRefundAmount != 0) {
								if (actualPaidAmount > paidAmount) {
									actualPaidAmount = paidAmount;
									settleAmount = actualPaidAmount;
									paidAmount = paidAmount - actualPaidAmount;
								} else {
									settleAmount = actualPaidAmount;
									paidAmount = paidAmount - actualPaidAmount;
								}
								//System.out.println(statementRefundAmount == settleAmount);
								FinBookingFormAccountsStatementPojo accStmtPojo = new FinBookingFormAccountsStatementPojo();
								accStmtPojo.setModifiedBy(serviceInfo.getEmployeeId());
								accStmtPojo.setStatementRefundAmount(settleAmount);
								accStmtPojo.setFinBookingFormAccountsId(accStatementPojo.getFinBookingFormAccountsId());
								accStmtPojo.setStatusId(Status.ACTIVE.getStatus());
								accStmtPojo.setFinBookingFormAccountsStatementId(accStatementPojo.getFinBookingFormAccountsStatementId());
								//employeeFinancialServiceDao.revertFinBookingFormAccountsStatementAmountOfPayment(accStmtPojo);
							}
						}*/
					} else if(paymentRefundDetailsPojo.getType().equals(MetadataId.FIN_BOOKING_FORM_ACCOUNTS_STATEMENT.getId())) {
						//here reassigning refunded amount to statement table
						FinBookingFormAccountsStatementPojo accStmtPojo = new FinBookingFormAccountsStatementPojo();
						accStmtPojo.setModifiedBy(serviceInfo.getEmployeeId());
						accStmtPojo.setStatementRefundAmount(refundAmount);
						//accStmtPojo.setFinBookingFormAccountsId(accStatementPojo.getFinBookingFormAccountsId());
						accStmtPojo.setStatusId(Status.ACTIVE.getStatus());
						accStmtPojo.setFinBookingFormAccountsStatementId(paymentRefundDetailsPojo.getTypeId());
						employeeFinancialServiceDao.revertFinBookingFormAccountsStatementAmountOfPayment(accStmtPojo);
					}
				}
				employeeFinancialServiceDao.inActiveBookingFormAccountPayment(paymentRefundDetailsPojo);
			} // paymentRefundDetailsPojo!=null condition
		} // for loop
	}

	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)//new added //uncomment it
	private void shiftThePaymentTransactions(EmployeeFinancialTransactionServiceInfo serviceInfo,
			FinTransactionEntryDetailsInfo transactionEntryDetailsInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.shiftThePaymentTransactions() *****");
		transactionEntryDetailsInfo.setCondition(FinEnum.SHIFT_TRANSACTION.getName());
		List<FinBookingFormAccountPaymentDetailsPojo> paymentList = employeeFinancialServiceDao.getTransactionPayemntDetails(transactionEntryDetailsInfo);
		long transactionEntryId = 0l;
		List<Long> listOfTransactionEntryId = new ArrayList<>();
		for (FinBookingFormAccountPaymentDetailsPojo paymentRefundDetailsPojo : paymentList) {
			//avoiding duplicate objects if any exists.0.
			/*if (transactionEntryId == paymentRefundDetailsPojo.getTransactionEntryId()) {
				continue;
			}*/
			if(listOfTransactionEntryId.contains(paymentRefundDetailsPojo.getTransactionEntryId())) {
				continue;
			}
			transactionEntryId = paymentRefundDetailsPojo.getTransactionEntryId();
			listOfTransactionEntryId.add(transactionEntryId);
			
			EmployeeFinancialTransactionServiceInfo reConstructedtransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(paymentRefundDetailsPojo, EmployeeFinancialTransactionServiceInfo.class);
			EmployeeFinancialTransactionResponse transactionDetails = getMisReceiptChequeOnlineData(reConstructedtransactionServiceInfo,new ArrayList<Long>());
			if (Util.isEmptyObject(transactionDetails.getFinTransactionEntryDetailsResponseList())) {
				log.info("No Data Found for Delete Transaction.");
				throw new EmployeeFinancialServiceException("No Data Found for Delete Transaction.");
			}
			FinTransactionEntryDetailsResponse dataForRecall = transactionDetails.getFinTransactionEntryDetailsResponseList().get(0);
			EmployeeFinancialTransactionServiceInfo transactionServiceInfoForRecall = (EmployeeFinancialTransactionServiceInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(dataForRecall, EmployeeFinancialTransactionServiceInfo.class);
			if(Util.isNotEmptyObject(dataForRecall.getTransferMode())) {
				transactionServiceInfoForRecall.setTransferModeName(dataForRecall.getTransferMode());
				reConstructedtransactionServiceInfo.setTransferModeName(dataForRecall.getTransferMode());
			}
			//here reverting current processing transaction amount and in activating the Transaction
			//and again re adjusting the transaction against milestones
			transactionServiceInfoForRecall.setThisReCallService(Boolean.TRUE);
			deleteFinancialTransaction(transactionServiceInfoForRecall);
			List<Long> listOfSetTypes = new ArrayList<>();
			if(Util.isNotEmptyObject(transactionDetails.getFinTransactionEntryDetailsResponseList())) {
				//Re-Constructing request for shifting( or re-adjusting the amount against milestone)
				reConstructedtransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionDetails.getFinTransactionEntryDetailsResponseList().get(0), EmployeeFinancialTransactionServiceInfo.class);
				reConstructedtransactionServiceInfo.setTransferModeName(dataForRecall.getTransferMode());
				List<EmployeeFinTranPaymentSetOffInfo> paymentSetOffDetails = new ArrayList<>();
				for (FinTransactionSetOffResponse finTransactionEntryDetailsPojo : transactionDetails.getFinTransactionEntryDetailsResponseList().get(0).getFinTransactionSetOffResponseList()) {
					EmployeeFinTranPaymentSetOffInfo paymentSetOffInfo = (EmployeeFinTranPaymentSetOffInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finTransactionEntryDetailsPojo, EmployeeFinTranPaymentSetOffInfo.class);
					if(paymentSetOffInfo.getSetOffTypeName()!=null && paymentSetOffInfo.getSetOffTypeId()!=null) {
						if(!paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.MODIFICATION_COST.getId()) && 
								!paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.LEGAL_COST.getId())
								) {
							//make invoice number as empty other than modification and legal cost, as we are selecting invoice no for only modification and legal cost 
							paymentSetOffInfo.setInvoiceNo("");
						}
						if (reConstructedtransactionServiceInfo.getTransactionFor().equalsIgnoreCase("Refund")) {
							paymentSetOffInfo.setRefundFromMileStone(Boolean.TRUE.toString());
						} else {
							paymentSetOffInfo.setRefundFromMileStone(Boolean.TRUE.toString());
						}
					}
					
					if (listOfSetTypes.contains(paymentSetOffInfo.getSetOffTypeId()) && !paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.INTEREST_WAIVER.getId()) ) {

					} else {
						paymentSetOffDetails.add(paymentSetOffInfo);
						listOfSetTypes.add(paymentSetOffInfo.getSetOffTypeId());
					}	
				}
				reConstructedtransactionServiceInfo.setPaymentSetOffDetails(paymentSetOffDetails);
				reConstructedtransactionServiceInfo.setPrevTransactionEntryDetailsResponse(transactionDetails.getFinTransactionEntryDetailsResponseList().get(0));
				reConstructedtransactionServiceInfo.setPrevTransactionEntryId(reConstructedtransactionServiceInfo.getTransactionEntryId());
				reConstructedtransactionServiceInfo.setPrevTransactionReceiptNo(reConstructedtransactionServiceInfo.getTransactionReceiptNo());
				reConstructedtransactionServiceInfo.setEditOrShiftUsingTrnEntId(serviceInfo.getTransactionEntryId());
				reConstructedtransactionServiceInfo.setOperationType(FinEnum.SHIFT_TRANSACTION.getName());
				reConstructedtransactionServiceInfo.setFlatIds(serviceInfo.getFlatIds());
				reConstructedtransactionServiceInfo.setPortNumber(serviceInfo.getPortNumber());
				reConstructedtransactionServiceInfo.setCreatedBy(serviceInfo.getEmployeeId());
				reConstructedtransactionServiceInfo.setEmployeeId(serviceInfo.getEmployeeId());
				
				//copying all the records of approve reject details
				List<FinTransactionApprStatPojo> finTransactionApprStatPojoList = employeeFinancialServiceDao.getFinTransactionApprStatData(reConstructedtransactionServiceInfo);
				reConstructedtransactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);
				//EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) reConstructedtransactionServiceInfo.clone();
				if (serviceInfo.isThisEditTransaction() == true  || serviceInfo.isThisDeleteTransaction() || true) {
					List<EmployeeFinancialTransactionServiceInfo> reConstructedtransactionServiceRequest = 
							Util.isEmptyObject(serviceInfo.getReConstructedtransactionServiceRequest())?
										new ArrayList<EmployeeFinancialTransactionServiceInfo>():serviceInfo.getReConstructedtransactionServiceRequest();
					reConstructedtransactionServiceRequest.add(reConstructedtransactionServiceInfo);
					serviceInfo.setReConstructedtransactionServiceRequest(reConstructedtransactionServiceRequest);
				}// else {
					// this is regenerating transaction, here request is constructed() for re adjustment of the milestone
					/*saveFinancialTransactionRequest(reConstructedtransactionServiceInfo);
					for (FinTransactionApprStatPojo apprStatPojo : finTransactionApprStatPojoList) {
						apprStatPojo.setTransactionSetOffEntryId(reConstructedtransactionServiceInfo.getTransactionSetOffEntryId());
						apprStatPojo.setComment(apprStatPojo.getComments());
						employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,reConstructedtransactionServiceInfo);
						employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
					}
					
					employeeFinancialServiceDao.copyTransactionSetOffApprovaldetails(clonedTransactionServiceInfo,reConstructedtransactionServiceInfo);*/
				//}
				
			}
		}
		log.info("***** EmployeeFinancialServiceImpl.shiftThePaymentTransactions() method execution completed *****");
	}

	//@SuppressWarnings("unused")
	private void revertReceiptTransactionAmount(EmployeeFinancialTransactionServiceInfo serviceInfo, FinTransactionEntryDetailsInfo transactionEntryDetailsInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.revertReceiptTransactionAmount() *****"+serviceInfo.getTransactionSetOffEntryId());
		List<Long> setOffTypesToDelete = new ArrayList<>();
		EmployeeFinancialTransactionServiceInfo clonedServiceInfo = (EmployeeFinancialTransactionServiceInfo) serviceInfo.clone();
		//List<Long> actualFlatIds = serviceInfo.getActualFlatIds(); 
		//Long actualBookingFormId = serviceInfo.getActualBookingFormId();
		
		//long transactionTypeId = serviceInfo.getTransactionTypeId();
		//long transactionModeId = serviceInfo.getTransactionModeId();
		//String transactionTypeName = serviceInfo.getTransactionTypeName();
		String transactionModeName = serviceInfo.getTransactionModeName();
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo.setFlatBookingId(serviceInfo.getBookingFormId());
		customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
		customerPropertyDetailsInfo.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());
		serviceInfo.setStatusId(Status.ACTIVE.getStatus());
		//this clone object is used for load same payment list again
		FinTransactionEntryDetailsInfo transactionEntryDetailsInfoForLoadPaymentList = (FinTransactionEntryDetailsInfo) transactionEntryDetailsInfo.clone();
		//List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;
		// this method used in multiple places
		List<FinTransactionEntryDetailsPojo> paymentList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfo, customerPropertyDetailsInfo);
		
		if(Util.isEmptyObject(paymentList)) {
			//if the list found empty means transaction not found or has excess amount
			int result = employeeFinancialServiceDao.isThisTransactionHavingOnlyExces(transactionEntryDetailsInfo, customerPropertyDetailsInfo);
			if(result == 1) {
				//if the result got one means this transaciton amount not found in statement table, and complete amount went to excess table
				
				FinTransactionEntryDetailsPojo entryDetailsPojo = new FinTransactionEntryDetailsPojo();
				entryDetailsPojo.setBookingFormId(serviceInfo.getBookingFormId());
				entryDetailsPojo.setTransactionSetOffEntryId(serviceInfo.getTransactionSetOffEntryId());
				employeeFinancialServiceDao.inActiveReceiptRecord(entryDetailsPojo);
				
				serviceInfo.setTransactionActionType(Status.TRANSACTION_DELETED.getStatus());
				clonedServiceInfo.setTransactionActionType(Status.TRANSACTION_DELETED.getStatus());
				log.info("*****  revertReceiptTransactionAmount() calling saveApproveRejectStatistics() *****"+clonedServiceInfo.getTransactionSetOffEntryId());
				FinTransactionApprRejectStatPojo pojo = (FinTransactionApprRejectStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(clonedServiceInfo,FinTransactionApprRejectStatPojo.class);
				employeeFinancialServiceDao.saveApproveRejectStatistics(pojo);
				employeeFinancialServiceDao.updateTransactionStatus(serviceInfo, Status.TRANSACTION_DELETED.getStatus());

			}
			
			log.info("Failed to process transaction. no data found for transaction.");
			throw new EmployeeFinancialServiceException("Failed to process transaction.");
		}

		//serviceInfo.setActualTransactionReceiveDate(paymentList.get(0).getTransactionReceiveDate());
		//transactionEntryDetailsInfo.setActualTransactionDate(paymentList.get(0).getTransactionReceiveDate());		

		if (Util.isNotEmptyObject(paymentList)) {
			for (FinTransactionEntryDetailsPojo entryDetailsPojo : paymentList) {
				setOffTypesToDelete.add(entryDetailsPojo.getType());
			}
			if(paymentList.get(0).getTransactionEntryId().equals(serviceInfo.getTransactionEntryId())) {
				serviceInfo.setTransactionSetOffEntryId(paymentList.get(0).getTransactionSetOffEntryId());
				clonedServiceInfo.setTransactionSetOffEntryId(paymentList.get(0).getTransactionSetOffEntryId());
				
				serviceInfo.setActualTransactionDate(paymentList.get(0).getTransactionDate());
				transactionEntryDetailsInfo.setActualTransactionDate(paymentList.get(0).getTransactionDate());//data will load the after this paymentList.get(0).getTransactionDate() for shifting
				
				serviceInfo.setActualTransactionReceiveDate(paymentList.get(0).getTransactionReceiveDate());
				transactionEntryDetailsInfo.setActualTransactionReceiveDate(paymentList.get(0).getTransactionReceiveDate());//data will load the after this paymentList.get(0).getTransactionDate() fro shifting 
			}
		}
		serviceInfo.setTransactionClosedDate(paymentList.get(0).getTransactionClosedDate());
		serviceInfo.setIsRecordUploaded(paymentList.get(0).getIsRecordUploaded());
		serviceInfo.setExcelRecordNo(paymentList.get(0).getExcelRecordNo());
		
		// if this is not recalled method then only execute the shiftTheTransactions method
		if (Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && !serviceInfo.isThisReCallService()) {
			shiftThePaymentTransactions(serviceInfo, transactionEntryDetailsInfo);
		}
		
		if (Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && !serviceInfo.isThisReCallService()) {
			shiftTheReceiptTransactions(serviceInfo, transactionEntryDetailsInfo, customerPropertyDetailsInfo);
		}
		//loading again data bcoz, payment amount reverted, so need to take updated data
		if (Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && !serviceInfo.isThisReCallService()) {
			paymentList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfoForLoadPaymentList, customerPropertyDetailsInfo);
		}
		//removing current transaction adjustment of milestone
		takeReceiptTransactionAmountBack(paymentList,serviceInfo,transactionEntryDetailsInfo,customerPropertyDetailsInfo);
		
		if (Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && !serviceInfo.isThisReCallService()) {	
			serviceInfo.setTransactionActionType(Status.TRANSACTION_DELETED.getStatus());
			clonedServiceInfo.setTransactionActionType(Status.TRANSACTION_DELETED.getStatus());
			log.info("*****  revertReceiptTransactionAmount() calling saveApproveRejectStatistics() *****"+clonedServiceInfo.getTransactionSetOffEntryId());
			FinTransactionApprRejectStatPojo pojo = (FinTransactionApprRejectStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(clonedServiceInfo,FinTransactionApprRejectStatPojo.class);
			employeeFinancialServiceDao.saveApproveRejectStatistics(pojo);
			employeeFinancialServiceDao.updateTransactionStatus(serviceInfo, Status.TRANSACTION_DELETED.getStatus());
		} else {
			employeeFinancialServiceDao.updateTransactionStatus(serviceInfo, Status.REJECTED.getStatus());
		}

		if(FinTransactionType.RECEIPT.getId().equals(serviceInfo.getTransactionTypeId()) && transactionModeName.equals(MetadataId.ONLINE.getName())) {
			updateSuspenseEntry(serviceInfo);
		}
		
		//if this is not re-called method, then only execute the shiftTheTransactions method	
		if(Util.isNotEmptyObject(serviceInfo.getReConstructedtransactionServiceRequest()) && Util.isNotEmptyObject(serviceInfo.isThisReCallService()) && !serviceInfo.isThisReCallService()) {
			employeeFinancialHelper.sortTransactionDataOnEdit(serviceInfo);
			//Re-executing the Request For Edit Transaction
			for (EmployeeFinancialTransactionServiceInfo reConstructedtransactionServiceInfo : serviceInfo.getReConstructedtransactionServiceRequest()) {
				
				EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo1 = (EmployeeFinancialTransactionServiceInfo) reConstructedtransactionServiceInfo.clone();
				System.out.println(reConstructedtransactionServiceInfo.getTransactionDate()+""+reConstructedtransactionServiceInfo.getTransactionReceiveDate()+"\t"+reConstructedtransactionServiceInfo.getPrevTransactionEntryId()+"\t"+(reConstructedtransactionServiceInfo.getTransactionEntryId())+"\t"+reConstructedtransactionServiceInfo.getTransactionAmount());
				saveFinancialTransactionRequest(reConstructedtransactionServiceInfo);
				
				if(Util.isNotEmptyObject(reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList())) {
					for (FinTransactionApprStatPojo apprStatPojo : reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList()) {
						apprStatPojo.setTransactionSetOffEntryId(reConstructedtransactionServiceInfo.getTransactionSetOffEntryId());
						apprStatPojo.setComment(apprStatPojo.getComments());
						//copying prev transaction approval details to current shifted transaction approval details
						employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,reConstructedtransactionServiceInfo);
						//copying prev transaction changed details to current shifted transaction
						//employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
					}
				} else {
					throw new EmployeeFinancialServiceException("Failed to process transaction.");	
				}
				
				if(!reConstructedtransactionServiceInfo.getPrevTransactionEntryId().equals(serviceInfo.getTransactionEntryId()) && Util.isNotEmptyObject(reConstructedtransactionServiceInfo.getPrevTransactionEntryDetailsResponse())) {
					List<FinTransactionEntryDocResponse> transactionEntryDocResponsesList = reConstructedtransactionServiceInfo.getPrevTransactionEntryDetailsResponse().getTransactionEntryDocResponsesList();
					if(Util.isNotEmptyObject(transactionEntryDocResponsesList)) {
						for (FinTransactionEntryDocResponse entryDocResponse : transactionEntryDocResponsesList) {
							FinTransactionEntryDocPojo pojo = financialMapper.constructFinTransactionEntryDocPojoObject(entryDocResponse,reConstructedtransactionServiceInfo);
							employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						}
					}
				}
				
				//copying Transaction SetOff Approval details of prev transction
				employeeFinancialServiceDao.copyTransactionSetOffApprovaldetails(clonedTransactionServiceInfo1,reConstructedtransactionServiceInfo);
				
			}
		}
		
		log.info("***** EmployeeFinancialServiceImpl.revertFinancialTransactionAmount() method execution completed *****");
	}

	private void updateSuspenseEntry(EmployeeFinancialTransactionServiceInfo serviceInfo) {
		List<FinAnonymousEntryPojo> listOfAnonymousEntryList = employeeFinancialServiceDao.getCompletedTrnOnlinePaymentRererenceNumber(serviceInfo);
		@SuppressWarnings("unused")
		long anonymousEntryId = 0l;
			
			if(listOfAnonymousEntryList.size()>1) {
				throw new RefundAmountException(Arrays.asList("Duplicate found for reference no " + serviceInfo.getReferenceNo()+" can not proceed the transaction."));
			} else if(!listOfAnonymousEntryList.isEmpty()) {
				anonymousEntryId = listOfAnonymousEntryList.get(0).getAnonymousEntryId();
			} else {
				throw new RefundAmountException(Arrays.asList("No data found for reference no " + serviceInfo.getReferenceNo()+" can not proceed the transaction"));
			}
			FinAnonymousEntryPojo anonymousEntryPojo = listOfAnonymousEntryList.get(0);
			if(!serviceInfo.isThisReCallService()) {
				anonymousEntryPojo.setStatusId(Status.INACTIVE.getStatus());
				anonymousEntryPojo.setActiveStatusId(Status.TRANSACTION_COMPLETED.getStatus());
				employeeFinancialServiceDao.updateAnonymousEntryStatus(anonymousEntryPojo);
			}	
	}
	
	private void rejectSuspenseEntryRecord(EmployeeFinancialTransactionServiceInfo serviceInfo) throws Exception {
		List<FinAnonymousEntryPojo> listOfAnonymousEntryList = employeeFinancialServiceDao.getOnlinePaymentRererenceNumber(serviceInfo);
		@SuppressWarnings("unused")
		long anonymousEntryId = 0l;
			
			if(listOfAnonymousEntryList.size()>1) {
				throw new RefundAmountException(Arrays.asList("Duplicate found for reference no " + serviceInfo.getReferenceNo()+" can not proceed the transaction."));
			} else if(!listOfAnonymousEntryList.isEmpty()) {
				anonymousEntryId = listOfAnonymousEntryList.get(0).getAnonymousEntryId();
			} else {
				throw new RefundAmountException(Arrays.asList("No data found for reference no " + serviceInfo.getReferenceNo()+" can not proceed the transaction"));
			}
			FinAnonymousEntryPojo anonymousEntryPojo = listOfAnonymousEntryList.get(0);
			if(!serviceInfo.isThisReCallService()) {
				anonymousEntryPojo.setStatusId(Status.INACTIVE.getStatus());
				anonymousEntryPojo.setActiveStatusId(Status.ACTIVE.getStatus());
				employeeFinancialServiceDao.updateAnonymousEntryStatus(anonymousEntryPojo);
			}	
	}

	private void takeReceiptTransactionAmountBack(List<FinTransactionEntryDetailsPojo> paymentList, EmployeeFinancialTransactionServiceInfo serviceInfo,
			FinTransactionEntryDetailsInfo transactionEntryDetailsInfo, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) throws Exception {
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;
		List<Long> typeIds = new ArrayList<>();
		List<FinancialProjectMileStonePojo> listOfPaidInterestCostList = new ArrayList<>();
		FinancialProjectMileStonePojo penaltyaccPojo = null;
		List<FinPenaltyStatisticsPojo> penaltyStatisticsPojos = null;
		for (FinTransactionEntryDetailsPojo entryDetailsPojo : paymentList) {
			double setOffAmount = entryDetailsPojo.getSetOffAmount() == null ? 0d : entryDetailsPojo.getSetOffAmount();
			//double refundAmount = entryDetailsPojo.getRefundAmount() == null ? 0d : entryDetailsPojo.getRefundAmount();
			// long statementId = entryDetailsPojo.getFinBookingFormAccountsStatementId();
			// long accountsId = entryDetailsPojo.getFinBookingFormAccountsId();
			if (setOffAmount > 0) {
				FinBookingFormReceiptsPojo bookingFormReceiptsPojo = null;
				FinBookingFormAccountsStatementPojo bookingFormAccountsStatementPojo = null;
				if (serviceInfo.getCondition()!=null && serviceInfo.getCondition().equals(FinEnum.DELETE_TRANSACTION.getName()) 
						|| serviceInfo.getCondition().equals(FinEnum.EDIT_TRANSACTION.getName())) {
					if(Util.isEmptyObject(listOfExcessAmount)) {
						listOfExcessAmount = validateRefundAmount(serviceInfo, customerPropertyDetailsInfo);
						if(serviceInfo.isThisDeleteTransaction()) {// if this is delete transaction
							for (FinBookingFormExcessAmountPojo bookingFormExcessAmountPojo : listOfExcessAmount) {
								//System.out.println("bookingFormExcessAmountPojo "+bookingFormExcessAmountPojo);
								employeeFinancialServiceDao.updateAndRevertExcessAmount(bookingFormExcessAmountPojo);
							}
						}
					}
				}
				
				FinBookingFormAccountPaymentPojo bookingFormAccountPaymentPojo = new FinBookingFormAccountPaymentPojo();
				bookingFormAccountPaymentPojo.setType(MetadataId.FIN_BOOKING_FORM_ACCOUNTS.getId());
				bookingFormAccountPaymentPojo.setTypeId(entryDetailsPojo.getFinBookingFormAccountsId());
				bookingFormAccountPaymentPojo.setStatusId(Status.ACTIVE.getStatus());
				//String transactionNo = "-";
				
				/*if (refundAmount != 0) {//if milestone has refund amount , and trying to delete the receipt, it will not allow bcoz from the current deleting receipt some amount has refunded, if deleted receipt then we don't know from which receipt amount has refunded
					List<FinBookingFormAccountPaymentDetailsPojo> excessAmountReturnDetails = employeeFinancialServiceDao.getExcessAmountPaymentRefundDetails(bookingFormAccountPaymentPojo);
					if (Util.isNotEmptyObject(excessAmountReturnDetails)) {
						transactionNo = excessAmountReturnDetails.get(0).getFinTransactionNo();
						throw new EmployeeFinancialServiceException(Arrays.asList("Can not delete or readjust the Transaction, as already some amount has been refund on the Transaction, Payment Refund Transaction No - "+transactionNo));//, Transaction No - "+generateTransactionNo(serviceInfo)
					}
				}*/
				
				//in activating receipt record and statement records
				employeeFinancialServiceDao.inActiveAccountStatementRecord(entryDetailsPojo);
				employeeFinancialServiceDao.inActiveReceiptRecord(entryDetailsPojo);

				FinBookingFormAccountSummaryPojo accountSummaryPojo = financialMapper.constructFinBookingFormAccountSummaryPojo(serviceInfo, entryDetailsPojo,bookingFormReceiptsPojo, FinBookingFormAccountSummaryPojo.class);
				// taking amount back from Booking Form Account Summary
				employeeFinancialServiceDao.revertBookingFormAccountSummaryAmount(accountSummaryPojo);

				//List<FinBookingFormReceiptsPojo> list = employeeFinancialServiceDao.getPreviousTransactionPaidDate(transactionEntryDetailsInfo);
				FinBookingFormAccountsPojo bookingFormAccountsPojo = financialMapper.constructFinBookingFormAccountsPojo(serviceInfo, entryDetailsPojo, bookingFormReceiptsPojo,FinBookingFormAccountsPojo.class);
				List<FinBookingFormAccountsStatementPojo> accountsStatementPojos = employeeFinancialServiceDao.getBookingFormAccountsStatementAndReceiptData(bookingFormAccountsPojo, FinEnum.DESC);
				if (!accountsStatementPojos.isEmpty()) {
					bookingFormAccountsStatementPojo = accountsStatementPojos.get(0);
					bookingFormAccountsPojo.setPaidDate(bookingFormAccountsStatementPojo.getPaidDate());
				} else {
					bookingFormAccountsPojo.setPaidDate(null);
				}
				typeIds.add(entryDetailsPojo.getType());
				serviceInfo.setTypeIds(typeIds);

				bookingFormAccountsPojo.setIsInterestCalcCompleted(null);
				employeeFinancialServiceDao.updateBookingFormAccountInterestDetails(bookingFormAccountsPojo);

				// taking amount back from Booking Form Account
				employeeFinancialServiceDao.revertBookingFormAccountAmount(bookingFormAccountsPojo);
				
				if(MetadataId.FIN_PENALTY.getId().equals(entryDetailsPojo.getType())) {
					penaltyaccPojo = new FinancialProjectMileStonePojo();
					penaltyaccPojo.setTypeId(entryDetailsPojo.getTypeId());//penalty record id
					penaltyaccPojo.setType(entryDetailsPojo.getType());
					System.out.println(entryDetailsPojo.getFinBookingFormAccountsId()+" "+entryDetailsPojo.getTypeId());
					penaltyStatisticsPojos = employeeFinancialServiceDao.loadPenaltyStatisticsData(penaltyaccPojo);
					penaltyaccPojo.setPenaltyStatisticsPojos(penaltyStatisticsPojos);

					penaltyaccPojo.setSetOffAmount(bookingFormAccountsPojo.getPaidAmount());//refund amount
					penaltyGstAmountAndAdjustAmount(penaltyaccPojo,true);//penalty adjustment, true means refund the amount, or decrease
					listOfPaidInterestCostList.add(penaltyaccPojo);//Refund transaction
				}
			}
		}
		if(Util.isEmptyObject(paymentList)) {
			FinTransactionEntryDetailsPojo entryDetailsPojo = new FinTransactionEntryDetailsPojo();
			entryDetailsPojo.setBookingFormId(serviceInfo.getBookingFormId());
			entryDetailsPojo.setTransactionSetOffEntryId(serviceInfo.getTransactionSetOffEntryId());
			employeeFinancialServiceDao.inActiveReceiptRecord(entryDetailsPojo);
		}
		List<FinancialProjectMileStonePojo> listOfNonPaidMileStoneDetails = new ArrayList<FinancialProjectMileStonePojo>();
		for (FinTransactionEntryDetailsPojo entryDetailsPojo : paymentList) {
			FinBookingFormAccountsPojo bookingFormAccountsPojo = financialMapper.constructFinBookingFormAccountsPojo(serviceInfo, entryDetailsPojo, null,FinBookingFormAccountsPojo.class);
			
			if((serviceInfo.isThisEditTransaction() || serviceInfo.isThisDeleteTransaction() || serviceInfo.isThisShiftTransactionFromApproval())// ||serviceInfo.isThisDeleteTransaction() 
					&& entryDetailsPojo.getType()!=null && entryDetailsPojo.getType().equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId())) {
				
				if (serviceInfo.getActualTransactionReceiveDate() != null
						&& serviceInfo.getTransactionReceiveDate() != null 
						&& (serviceInfo.getTransactionReceiveDate().before(serviceInfo.getActualTransactionReceiveDate())) || serviceInfo.isThisDeleteTransaction()  || serviceInfo.isThisShiftTransactionFromApproval() ) {//|| 

					FinPenalityInfo finPenalityInfo = new FinPenalityInfo();
					finPenalityInfo.setBookingFormId(bookingFormAccountsPojo.getBookingFormId());
					/*List<FinPenaltyPojo> penaltyPojos = employeeFinancialServiceDao.getFinPenaltyDetails(bookingFormAccountsPojo);
					if(Util.isNotEmptyObject(penaltyPojos)) {
						FinPenaltyPojo finPenaltyPojo1 = new FinPenaltyPojo();
						//finPenaltyPojo.setStatusId(Status.SHIFT_RECORD_DETAILS.getStatus());
						finPenaltyPojo1.setFinPenaltyId(penaltyPojos.get(0).getFinPenaltyId());
						finPenaltyPojo1.setActiveStatusId(Status.ACTIVE.getStatus());
						finPenaltyPojo1.setCreatedBy(serviceInfo.getEmployeeId());
						//updating Fin_Penalty Record, for recalculation of penalty amount
						employeeFinancialServiceDao.updateFinPenaltyStatus(bookingFormAccountsPojo);
						//updating Penalty Record, and giving status SHIFT_RECORD_DETAILS, if any paid amount is exists , then we can shift the amount using the SHIFT_RECORD_DETAILS id 			
						employeeFinancialServiceDao.updateBookingFormAccountStatus(finPenaltyPojo1,MetadataId.FIN_PENALTY);
					}*/
					inActivePenaltyRecord(bookingFormAccountsPojo);//#ACP
					FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
					//finProjDemandNoteInfo.setDataSelectionOrder("DESC");
					finProjDemandNoteInfo.setCondition("SetOffPayment");
					finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {entryDetailsPojo.getType()}));
					finProjDemandNoteInfo.setFinBookingFormAccountsId(entryDetailsPojo.getFinBookingFormAccountsId());
					finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.INPROGRESS.getStatus(),Status.PENDING.getStatus()}));
					finProjDemandNoteInfo.setCreatedBy(serviceInfo.getCreatedBy());
					finProjDemandNoteInfo.setInterestSelectionType(entryDetailsPojo.getInterestSelectionType());
					finProjDemandNoteInfo.setSiteId(serviceInfo.getSiteId());
					if (serviceInfo.isThisDeleteTransaction()) {
						finProjDemandNoteInfo.setInterestCalculationFrom("ReceiptEditDelete");
					}
					 
					entryDetailsPojo.setInterestSelectionType(Status.With_Interest.getStatus());//move after testing
					//Checking here, can we calculate the penalty for milestone or not 
					if(Util.isNotEmptyObject(entryDetailsPojo.getInterestSelectionType()) && entryDetailsPojo.getInterestSelectionType().equals(Status.With_Interest.getStatus())) {

						transactionEntryDetailsInfo.setCondition("LoadPreviousTransaction");
						//loading the previous transaction details for Getting transaction receive date, for penalty calculation
						List<FinTransactionEntryDetailsPojo> previousPaymentList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfo, null);

						if (serviceInfo.isThisEditTransaction()) {
							if (!previousPaymentList.isEmpty()) {
								finProjDemandNoteInfo.setMilestoneDate(previousPaymentList.get(previousPaymentList.size()-1).getTransactionReceiveDate());
								finProjDemandNoteInfo.setInterestCalculationUptoDate(previousPaymentList.get(previousPaymentList.size()-1).getTransactionReceiveDate());
							}else {
								finProjDemandNoteInfo.setMilestoneDate(serviceInfo.getTransactionReceiveDate());
								finProjDemandNoteInfo.setInterestCalculationUptoDate(serviceInfo.getTransactionReceiveDate());
							}
						} else if (serviceInfo.isThisDeleteTransaction()) {
							
							FinBookingFormDemandNotePojo demandNoteInfo = new FinBookingFormDemandNotePojo();
							demandNoteInfo.setBookingFormId(serviceInfo.getBookingFormId());
							demandNoteInfo.setStatusId(Status.REGENERATED_DEMAND_NOTE.getStatus());
							//Loading the Re-generated demand note details for penalty calculation
							List<FinBookingFormDemandNotePojo> demandNotePojos = employeeFinancialServiceDao.getDemandNoteId(demandNoteInfo);
							if (!previousPaymentList.isEmpty()) {
								finProjDemandNoteInfo.setMilestoneDate(previousPaymentList.get(previousPaymentList.size()-1).getTransactionReceiveDate());
								finProjDemandNoteInfo.setInterestCalculationUptoDate(previousPaymentList.get(previousPaymentList.size()-1).getTransactionReceiveDate());
							} else if (!demandNotePojos.isEmpty()) {
								finProjDemandNoteInfo.setMilestoneDate(demandNotePojos.get(0).getCreatedDate());
								finProjDemandNoteInfo.setInterestCalculationUptoDate(demandNotePojos.get(0).getCreatedDate());
							} else {
								finProjDemandNoteInfo.setMilestoneDate(entryDetailsPojo.getMileStoneDueDate());
								finProjDemandNoteInfo.setInterestCalculationUptoDate(entryDetailsPojo.getMileStoneDueDate());
							}
						}
						
						//loading the milestone details
						List<FinancialProjectMileStonePojo> listOfNonPaidMileStoneDetails1 = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
						if(!listOfNonPaidMileStoneDetails1.isEmpty()) {
							listOfNonPaidMileStoneDetails.add(listOfNonPaidMileStoneDetails1.get(0));
						}
					}//entryDetailsPojo.getInterestSelectionType() condition
										
					double totalInterestAmount = 0.0; 
					//recalculating penalty amount
					Timestamp nextTimestamp = finProjDemandNoteInfo.getInterestCalculationUptoDate();
					if(nextTimestamp == null) {
						Timestamp timestamp = new Timestamp(new Date().getTime());
						finProjDemandNoteInfo.setInterestCalculationUptoDate(TimeUtil.removeOneDay(timestamp));
						log.info("Dates found empty "+nextTimestamp);
					}

					if(Util.isNotEmptyObject(entryDetailsPojo.getInterestSelectionType())  && entryDetailsPojo.getInterestSelectionType().equals(Status.With_Interest.getStatus())) {
						processPenaltyAmount(listOfNonPaidMileStoneDetails,finProjDemandNoteInfo,totalInterestAmount,"insertInterestData","",new HashMap<String,Object>());
					}
					//Code for updating penalty paid amount 
					
						/*FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
						bookingFormAccountsInfo.setBookingFormId(serviceInfo.getBookingFormId());
						bookingFormAccountsInfo.setStatusId(Status.SHIFT_RECORD_DETAILS.getStatus());
						bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.FIN_PENALTY.getId()));
						bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
						bookingFormAccountsInfo.setCondition(FinEnum.LOAD_BY_ID.getName());
						bookingFormAccountsInfo.setTypeId((!penaltyPojos.isEmpty())?penaltyPojos.get(0).getFinPenaltyId():0l);*/
						
						//here loading all the Milestone Payment Details using customer FlatBookingId
						//List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo );
						//here shifting the amount of penalty record if any 
						/*if(!bookingFormAccountsPojoLists.isEmpty()) {//Not in Use
						for(FinBookingFormAccountsPojo bookingFormAccountsPojo1 : bookingFormAccountsPojoLists) {
							if(Util.isNotEmptyObject(bookingFormAccountsPojo1.getPaidAmount())) {
								penaltyPojos = employeeFinancialServiceDao.getFinPenaltyDetails(bookingFormAccountsPojo);
								bookingFormAccountsInfo.setBookingFormId(serviceInfo.getBookingFormId());
								bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
								bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.FIN_PENALTY.getId()));
								bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
								bookingFormAccountsInfo.setCondition(FinEnum.LOAD_BY_ID.getName());
								bookingFormAccountsInfo.setTypeId((!penaltyPojos.isEmpty())?penaltyPojos.get(0).getFinPenaltyId():0l);
								List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists1 = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
								FinBookingFormAccountsPojo prevData = bookingFormAccountsPojoLists.get(0);
								if (!bookingFormAccountsPojoLists1.isEmpty()) {
									//if any paid amount is there for Penalty record, shifting the old penalty Details for new penalty record
									FinBookingFormAccountsPojo currData = bookingFormAccountsPojoLists1.get(0);
									//updating previous penalty record id, to new calculated penalty record id 
									employeeFinancialServiceDao.updateBookingFormAccountStatementData(prevData,currData);
	
									FinPenaltyPojo finPenaltyPojo = financialMapper.constructFinPenaltyPojo(prevData,serviceInfo);
									//updating penalty record id
									employeeFinancialServiceDao.updateBookingFormAccountStatus(finPenaltyPojo, MetadataId.FIN_PENALTY);
									prevData.setFinBookingFormAccountsId(currData.getFinBookingFormAccountsId());
									prevData.setStatusId(Status.ACTIVE.getStatus());
									employeeFinancialServiceDao.updateBookingFormAccountPaidAmount(prevData);
								} else {
									//Inactive penalty record, if new penalty record not calculated  
									FinPenaltyPojo finPenaltyPojo = financialMapper.constructFinPenaltyPojo(prevData,serviceInfo);
									employeeFinancialServiceDao.updateBookingFormAccountStatus(finPenaltyPojo, MetadataId.FIN_PENALTY);
								}
							}
						}
					}*/ 
					 //Code for updating penalty paid amount, and recalculating the penalty amount
					
				}
			}//condition
		}
	}

	private void inActivePenaltyRecord(FinBookingFormAccountsPojo bookingFormAccountsPojo) {
		List<FinPenaltyPojo> penaltyPojos = employeeFinancialServiceDao.getFinPenaltyDetails(bookingFormAccountsPojo);
		if(Util.isNotEmptyObject(penaltyPojos)) {
			FinPenaltyPojo finPenaltyPojo1 = new FinPenaltyPojo();
			//finPenaltyPojo.setStatusId(Status.SHIFT_RECORD_DETAILS.getStatus());
			finPenaltyPojo1.setFinPenaltyId(penaltyPojos.get(0).getFinPenaltyId());
			finPenaltyPojo1.setActiveStatusId(Status.ACTIVE.getStatus());
			finPenaltyPojo1.setCreatedBy(bookingFormAccountsPojo.getCreatedBy());
			//updating Fin_Penalty Record, for recalculation of penalty amount
			employeeFinancialServiceDao.updateFinPenaltyStatus(bookingFormAccountsPojo);
			//updating Penalty Record, and giving status SHIFT_RECORD_DETAILS, if any paid amount is exists , then we can shift the amount using the SHIFT_RECORD_DETAILS id 			
			employeeFinancialServiceDao.updateBookingFormAccountStatus(finPenaltyPojo1,MetadataId.FIN_PENALTY);
		}
	}

	private int inActivePenaltyRecordEditMilestone(FinBookingFormAccountsPojo bookingFormAccountsPojo) {
		int result = 0;
		List<FinPenaltyPojo> penaltyPojos = employeeFinancialServiceDao.getFinPenaltyDetails(bookingFormAccountsPojo);
		if(Util.isNotEmptyObject(penaltyPojos)) {
			FinPenaltyPojo finPenaltyPojo1 = new FinPenaltyPojo();
			//finPenaltyPojo.setStatusId(Status.SHIFT_RECORD_DETAILS.getStatus());
			finPenaltyPojo1.setFinPenaltyId(penaltyPojos.get(0).getFinPenaltyId());
			finPenaltyPojo1.setActiveStatusId(Status.ACTIVE.getStatus());
			finPenaltyPojo1.setCreatedBy(bookingFormAccountsPojo.getCreatedBy());
			//updating Fin_Penalty Record, for recalculation of penalty amount
			employeeFinancialServiceDao.updateFinPenaltyStatus(bookingFormAccountsPojo);
			//updating Penalty Record, and giving status SHIFT_RECORD_DETAILS, if any paid amount is exists , then we can shift the amount using the SHIFT_RECORD_DETAILS id 			
			result = employeeFinancialServiceDao.updateBookingFormAccountStatus(finPenaltyPojo1,MetadataId.FIN_PENALTY);
			log.info("***** EmployeeFinancialServiceImpl.inActivePenaltyRecordEditMilestone() ***** "+result);
		}
		return result;
	}
	
	private List<FinBookingFormExcessAmountPojo> validateRefundAmount(EmployeeFinancialTransactionServiceInfo serviceInfo, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.validateRefundAmount() *****");
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;double totalUsedAmount = 0.0d,usedAmount = 0.0d;
		List<Long> typeOfRecords =  Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId(),
				MetadataId.MODIFICATION_COST.getId(),
				MetadataId.LEGAL_COST.getId(),
				MetadataId.REFUNDABLE_ADVANCE.getId(),
				MetadataId.FIN_PENALTY.getId());
		customerPropertyDetailsInfo.setTransactionSetOffEntryId(serviceInfo.getTransactionSetOffEntryId());
		listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo,typeOfRecords);
		for (FinBookingFormExcessAmountPojo excessAmountPojo : listOfExcessAmount) {
			//double excessBalanceAmount = excessAmountPojo.getBalanceAmount();
			//double excessAmount = excessAmountPojo.getExcessAmount();
			usedAmount = excessAmountPojo.getUsedAmount();
			String transactionNo = "-";
			if (usedAmount != 0) {//IF USED amount is not zero means amount is refunded for the current deleting receipt,as the amount refunded on current receipt, so can not delete it
				FinBookingFormAccountPaymentPojo bookingFormAccountPaymentPojo = new FinBookingFormAccountPaymentPojo();
				bookingFormAccountPaymentPojo.setType(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId());
				bookingFormAccountPaymentPojo.setTypeId(excessAmountPojo.getFinBookingFormExcessAmountId());
				bookingFormAccountPaymentPojo.setStatusId(Status.ACTIVE.getStatus());

				List<FinBookingFormExcessAmountUsagePojo> bookingFormExcessAmtUsageList = employeeFinancialServiceDao.getExcessAmountUsage(excessAmountPojo,serviceInfo);
				if (Util.isNotEmptyObject(bookingFormExcessAmtUsageList)) {
					totalUsedAmount = bookingFormExcessAmtUsageList.get(0).getTotalUsageAmount();
					if (totalUsedAmount != usedAmount) {
						List<FinBookingFormAccountPaymentDetailsPojo>  excessAmountReturnDetails = employeeFinancialServiceDao.getExcessAmountPaymentRefundDetails(bookingFormAccountPaymentPojo);
						if (Util.isNotEmptyObject(excessAmountReturnDetails)) {
							transactionNo = excessAmountReturnDetails.get(0).getFinTransactionNo();
						}
						//throw new EmployeeFinancialServiceException(Arrays.asList("Can not delete or readjusts the Transaction, as already some amount has been refund on the Transaction"));//, Transaction No - "+generateTransactionNo(serviceInfo)
						throw new EmployeeFinancialServiceException(Arrays.asList("Can not delete or readjust the Transaction, as already some amount has been refund on the Transaction, Payment Refund Transaction No - "+transactionNo));//, Transaction No - "+generateTransactionNo(serviceInfo)
					}
				} else {
					List<FinBookingFormAccountPaymentDetailsPojo> excessAmountReturnDetails = employeeFinancialServiceDao.getExcessAmountPaymentRefundDetails(bookingFormAccountPaymentPojo);
					if (Util.isNotEmptyObject(excessAmountReturnDetails)) {
						transactionNo = excessAmountReturnDetails.get(0).getFinTransactionNo();
					}
					//throw new EmployeeFinancialServiceException(Arrays.asList("Can not delete or readjust the Transaction, as already some amount has been refund on the Transaction"));//, Transaction No - "+generateTransactionNo(serviceInfo)
					throw new EmployeeFinancialServiceException(Arrays.asList("Can not delete or readjust the Transaction, as already some amount has been refund on the Transaction, Payment Refund Transaction No - "+transactionNo));//, Transaction No - "+generateTransactionNo(serviceInfo)
				}
			}
		}
		return listOfExcessAmount;
	}
	
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)//new added
	private void shiftTheReceiptTransactions(EmployeeFinancialTransactionServiceInfo serviceInfo, FinTransactionEntryDetailsInfo transactionEntryDetailsInfo
			, CustomerPropertyDetailsInfo customerPropertyDetailsInfo1NotInUse) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.shiftTheTransactions() *****");
		transactionEntryDetailsInfo.setCondition(FinEnum.SHIFT_TRANSACTION.getName());
		//calling saveFinancialService to recreated the transaction
		List<FinTransactionEntryDetailsPojo> paymentList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfo, null);
		EmployeeFinancialTransactionServiceInfo reConstructedtransactionServiceInfo = null;
		EmployeeFinancialTransactionResponse transactionDetails = null;
		FinTransactionEntryDetailsResponse dataForRecall = null;
		EmployeeFinancialTransactionServiceInfo transactionServiceInfoForRecall = null;
		long transactionEntryId = 0;
		List<Long> listOfTransactionEntryId = new ArrayList<>();
		for (FinTransactionEntryDetailsPojo entryDetailsPojo : paymentList) {
			//avoiding duplicate objects if any exists

			if(listOfTransactionEntryId.contains(entryDetailsPojo.getTransactionEntryId())) {
				continue;
			}
			transactionEntryId = entryDetailsPojo.getTransactionEntryId();
			listOfTransactionEntryId.add(transactionEntryId);
			reConstructedtransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(entryDetailsPojo, EmployeeFinancialTransactionServiceInfo.class);
			transactionDetails = getMisReceiptChequeOnlineData(reConstructedtransactionServiceInfo,new ArrayList<Long>());
			if (Util.isEmptyObject(transactionDetails.getFinTransactionEntryDetailsResponseList())) {
				throw new EmployeeFinancialServiceException("No Data Found for Delete Transaction.");
			}
			dataForRecall = transactionDetails.getFinTransactionEntryDetailsResponseList().get(0);//loaded data from DB
			transactionServiceInfoForRecall = (EmployeeFinancialTransactionServiceInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(dataForRecall, EmployeeFinancialTransactionServiceInfo.class);
			if(dataForRecall.getTransferMode()!=null) {
				transactionServiceInfoForRecall.setTransferModeName(dataForRecall.getTransferMode());
			}
			//here reverting current processing transaction amount and in activating the Transaction
			//and again re adjusting the transaction against milestones
			transactionServiceInfoForRecall.setThisReCallService(Boolean.TRUE);
			transactionServiceInfoForRecall.setThisShiftTransaction(Boolean.TRUE);
			deleteFinancialTransaction(transactionServiceInfoForRecall);//delete transaction adjustment
			
			if (Util.isNotEmptyObject(transactionDetails.getFinTransactionEntryDetailsResponseList())) {
				//Re-Constructing request for shifting( or re-adjusting the amount against milestone)
				reConstructedtransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionDetails.getFinTransactionEntryDetailsResponseList().get(0), EmployeeFinancialTransactionServiceInfo.class);
				if(dataForRecall.getTransferMode()!=null) {
					reConstructedtransactionServiceInfo.setTransferModeName(dataForRecall.getTransferMode());
				}
				reConstructTransactionRequest(transactionDetails,serviceInfo,reConstructedtransactionServiceInfo,FinEnum.SHIFT_TRANSACTION.getName());
				
/*				List<EmployeeFinTranPaymentSetOffInfo> paymentSetOffDetails = new ArrayList<>();
				for (FinTransactionSetOffResponse finTransactionEntryDetailsPojo : transactionDetails.getFinTransactionEntryDetailsResponseList().get(0).getFinTransactionSetOffResponseList()) {
					EmployeeFinTranPaymentSetOffInfo paymentSetOffInfo = (EmployeeFinTranPaymentSetOffInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finTransactionEntryDetailsPojo, EmployeeFinTranPaymentSetOffInfo.class);
					if(paymentSetOffInfo.getSetOffTypeName()!=null && paymentSetOffInfo.getSetOffTypeId()!=null) {
						System.out.println(paymentSetOffInfo.getSetOffTypeName()+" ID "+paymentSetOffInfo.getSetOffTypeId());
						if(!paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.MODIFICATION_COST.getId()) && 
								!paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.LEGAL_COST.getId())
								) {
							//make invoice number as empty other than modification and legal cost, as we are selecting invoice no for only modification and legal cost 
							paymentSetOffInfo.setInvoiceNo("");
						}
					}
					if (listOfSetTypes.contains(paymentSetOffInfo.getSetOffTypeId())) {

					} else {
						paymentSetOffDetails.add(paymentSetOffInfo);
						listOfSetTypes.add(paymentSetOffInfo.getSetOffTypeId());
					}
				}
				
				reConstructedtransactionServiceInfo.setPaymentSetOffDetails(paymentSetOffDetails);
				reConstructedtransactionServiceInfo.setPrevTransactionEntryId(reConstructedtransactionServiceInfo.getTransactionEntryId());
				reConstructedtransactionServiceInfo.setEditOrShiftUsingTrnEntId(serviceInfo.getTransactionEntryId());
				reConstructedtransactionServiceInfo.setOperationType(FinEnum.SHIFT_TRANSACTION.getName());
				reConstructedtransactionServiceInfo.setFlatIds(serviceInfo.getFlatIds());
				reConstructedtransactionServiceInfo.setPortNumber(serviceInfo.getPortNumber());
				reConstructedtransactionServiceInfo.setCreatedBy(serviceInfo.getEmployeeId());
				reConstructedtransactionServiceInfo.setEmployeeId(serviceInfo.getEmployeeId());*/
				
				
				
				//copying all the records of approve reject details
				List<FinTransactionApprStatPojo> finTransactionApprStatPojoList = employeeFinancialServiceDao.getFinTransactionApprStatData(reConstructedtransactionServiceInfo);
				
				//EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) reConstructedtransactionServiceInfo.clone();
				//this is regenerating transaction, here request is constructed() for re adjustment of the milestone
				reConstructedtransactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);
				if (serviceInfo.isThisEditTransaction() == true || serviceInfo.isThisDeleteTransaction() || true) {//
					//if this this is Edit Transaction Here Collecting All the Re-constructed Transaction request object,
					//so we can again re-adjust the amount
					List<EmployeeFinancialTransactionServiceInfo> reConstructedtransactionServiceRequest = 
							Util.isEmptyObject(serviceInfo.getReConstructedtransactionServiceRequest())?
										new ArrayList<EmployeeFinancialTransactionServiceInfo>():serviceInfo.getReConstructedtransactionServiceRequest();
					reConstructedtransactionServiceRequest.add(reConstructedtransactionServiceInfo);
					serviceInfo.setReConstructedtransactionServiceRequest(reConstructedtransactionServiceRequest);
				}// else {
					/*saveFinancialTransactionRequest(reConstructedtransactionServiceInfo);
					//EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) reConstructedtransactionServiceInfo.clone();
					for (FinTransactionApprStatPojo apprStatPojo : finTransactionApprStatPojoList) {
						apprStatPojo.setTransactionSetOffEntryId(reConstructedtransactionServiceInfo.getTransactionSetOffEntryId());
						apprStatPojo.setComment(apprStatPojo.getComments());
						employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,reConstructedtransactionServiceInfo);
						employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
					}
					employeeFinancialServiceDao.copyTransactionSetOffApprovaldetails(clonedTransactionServiceInfo,reConstructedtransactionServiceInfo);*/
				//}
				
			} else {
				log.info("No Data Found for Transaction");
				throw new EmployeeFinancialServiceException("No Data Found for Transaction");
			}
		}
		
		FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
		bookingFormAccountsInfo.setBookingFormId(serviceInfo.getBookingFormId());
		bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
		bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()));
		bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
		
		//here loading all the Milestone Payment Details using customer FlatBookingId
		List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
		for(FinBookingFormAccountsPojo bookingFormAccountsPojo : bookingFormAccountsPojoLists) {
			List<FinBookingFormAccountsStatementPojo> accountsStatementPojos = employeeFinancialServiceDao.getBookingFormAccountsStatementAndReceiptData(bookingFormAccountsPojo, FinEnum.DESC);
			bookingFormAccountsPojo.setModifiedBy(serviceInfo.getEmployeeId());
			if (Util.isNotEmptyObject(accountsStatementPojos)) {
				bookingFormAccountsPojo.setPaidDate(accountsStatementPojos.get(0).getPaidDate());
			} else {
				bookingFormAccountsPojo.setPaidDate(null);
			}
			//Here Updating the Paid Date
			employeeFinancialServiceDao.updateBookingFormAccountPaidDate(bookingFormAccountsPojo);
		}

	}

	public EmployeeFinancialTransactionServiceInfo reConstructTransactionRequest(EmployeeFinancialTransactionResponse transactionDetails,
			EmployeeFinancialTransactionServiceInfo serviceInfo, EmployeeFinancialTransactionServiceInfo reConstructedtransactionServiceInfo, String operationType) throws Exception {
		List<Long> listOfSetTypes = new ArrayList<>();
		List<EmployeeFinTranPaymentSetOffInfo> paymentSetOffDetails = new ArrayList<>();
		for (FinTransactionSetOffResponse finTransactionEntryDetailsPojo : transactionDetails.getFinTransactionEntryDetailsResponseList().get(0).getFinTransactionSetOffResponseList()) {
			EmployeeFinTranPaymentSetOffInfo paymentSetOffInfo = (EmployeeFinTranPaymentSetOffInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finTransactionEntryDetailsPojo, EmployeeFinTranPaymentSetOffInfo.class);
			if(paymentSetOffInfo.getSetOffTypeName()!=null && paymentSetOffInfo.getSetOffTypeId()!=null) {
				System.out.println(paymentSetOffInfo.getSetOffTypeName()+" ID "+paymentSetOffInfo.getSetOffTypeId());
				if(!paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.MODIFICATION_COST.getId()) && 
						!paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.LEGAL_COST.getId()) && !paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.INTEREST_WAIVER.getId())
						) {
					//make invoice number as empty other than modification and legal cost, as we are selecting invoice no for only modification and legal cost 
					paymentSetOffInfo.setInvoiceNo("");
				}
			}
			if (listOfSetTypes.contains(paymentSetOffInfo.getSetOffTypeId()) && !paymentSetOffInfo.getSetOffTypeId().equals(MetadataId.INTEREST_WAIVER.getId()) ) {

			} else {
				paymentSetOffDetails.add(paymentSetOffInfo);
				listOfSetTypes.add(paymentSetOffInfo.getSetOffTypeId());
			}
		}
		//adding payment set off details , as this trn approving from list page so we don't have all the details
		reConstructedtransactionServiceInfo.setPaymentSetOffDetails(paymentSetOffDetails);
		if(operationType!=null && operationType.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName())) {
			reConstructedtransactionServiceInfo.setRequestUrl(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName());
		}else {
			reConstructedtransactionServiceInfo.setPrevTransactionEntryId(reConstructedtransactionServiceInfo.getTransactionEntryId());
			reConstructedtransactionServiceInfo.setPrevTransactionReceiptNo(reConstructedtransactionServiceInfo.getTransactionReceiptNo());
			reConstructedtransactionServiceInfo.setEditOrShiftUsingTrnEntId(serviceInfo.getTransactionEntryId());
		}
		
		reConstructedtransactionServiceInfo.setPrevTransactionEntryDetailsResponse(transactionDetails.getFinTransactionEntryDetailsResponseList().get(0));
		reConstructedtransactionServiceInfo.setOperationType(operationType);
		reConstructedtransactionServiceInfo.setFlatIds(serviceInfo.getFlatIds());
		reConstructedtransactionServiceInfo.setPortNumber(serviceInfo.getPortNumber());
		reConstructedtransactionServiceInfo.setCreatedBy(serviceInfo.getEmployeeId());
		reConstructedtransactionServiceInfo.setEmployeeId(serviceInfo.getEmployeeId());
		return reConstructedtransactionServiceInfo;
	}

	/**
	 * @Description if u r doing any changes on invoice number pls look on to this method also
	 * {@link #shiftTheTransactions(EmployeeFinancialTransactionServiceInfo, FinTransactionEntryDetailsInfo, CustomerPropertyDetailsInfo)}
	 * here we are making empty invoice no
	 * @param transactionServiceInfo
	 * @param isTransactionForIsEmpty
	 * @throws Exception
	 */
	private void processPaymentSetOffDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, boolean isTransactionForIsEmpty) throws Exception {
		log.info("***** Control inside EmployeeFinancialServiceImpl.processPaymentSetOffDetails() *****");
		List<Long> listOfTransactionSetOffAccMap = new ArrayList<Long>();
		List<Long> listOfTransactionPaymentSetOffMap = new ArrayList<Long>();
		long transactionActionType = transactionServiceInfo.getTransactionActionType();
		
		long transactionSetOffEntryId =  transactionServiceInfo.getTransactionSetOffEntryId();
		List<String> errorMsgs = new ArrayList<>();
		//double transactionPayingAmount = transactionServiceInfo.getTransactionAmount();
		//double transactionAmountToRefund = transactionPayingAmount;
		double settledAmount = 0;
		@SuppressWarnings("unused")
		int countSetOffDetails = 0;
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;
		//String paymentSetOffType = "";
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
		employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
		
		if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos= employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
			}
		}
		/*List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos= employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
			customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
		}*/
		
		transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
		List<FinancialProjectMileStonePojo> listOfNonPaidMileStoneDetails = new ArrayList<FinancialProjectMileStonePojo>();
		
		for (EmployeeFinTranPaymentSetOffInfo paymentSetOffDetails : transactionServiceInfo.getPaymentSetOffDetails()) {
			if(Util.isEmptyObject(paymentSetOffDetails.getAmount()) || Util.isEmptyObject(paymentSetOffDetails.getSetOffTypeName())) {
				continue;
			}
			
			double payingAmount = paymentSetOffDetails.getAmount();
			double amountToRefund = payingAmount;
			//paymentSetOffType = paymentSetOffDetails.getSetOffTypeName();
			listOfTransactionSetOffAccMap = new ArrayList<Long>();
			listOfTransactionPaymentSetOffMap = new ArrayList<Long>();
			double excessAmount = 0d;
			//payingAmount for receipt entry//amountToRefund  = payment refund entry
			if (payingAmount <= 0 || amountToRefund <= 0) {
				//if amount is zero, and getFinTransactionSetOff Id is not the zero means the amount is removed from payment setoff,
				//so inactivating the record from payment set off
				if(Util.isNotEmptyObject(paymentSetOffDetails.getFinTransactionSetOffId()) && !paymentSetOffDetails.getFinTransactionSetOffId().equals(0l)) {
					paymentSetOffDetails.setTransactionSetOffEntryId(transactionSetOffEntryId);
					employeeFinancialServiceDao.updateTransactionSetOffDetails((FinTransactionSetOffPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(paymentSetOffDetails,FinTransactionSetOffPojo.class),Status.ACTIVE.getStatus());
					paymentSetOffDetails.setCreatedBy(transactionServiceInfo.getCreatedBy());
					if (transactionActionType != Status.CREATED.getStatus()) {
						listOfTransactionPaymentSetOffMap.add(0l);
						if (!listOfTransactionPaymentSetOffMap.isEmpty()) {
							//inactivating records
							//before adjusting to the 1st milestone id and 2nd milestone id,
 							employeeFinancialServiceDao.updateTranPaymentSetOffAccountDetails(listOfTransactionPaymentSetOffMap,paymentSetOffDetails);
						}
						listOfTransactionSetOffAccMap.add(0l);
						if (!listOfTransactionSetOffAccMap.isEmpty()) {
							//inactivating records
							employeeFinancialServiceDao.updateTranSetOffAccountDetails(listOfTransactionSetOffAccMap,paymentSetOffDetails);
						}
					}
					
				}
				continue;
			}
			if(FinTransactionType.RECEIPT.getId().equals(transactionServiceInfo.getTransactionTypeId())
					//&& FinTransactionMode.ONLINE.getId().equals(financialTransactionRequest.getTransactionModeId())
					){
				if(transactionServiceInfo.isThisIsFinalLevel()) {
					//these records will be inserted only one time in accounts table
					if(transactionServiceInfo.getPaymentSetOffTypes().contains(MetadataId.MAINTENANCE_CHARGE.getId()) && getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.MAINTENANCE_CHARGE.getId())) {
						saveMaintenance_Charges(transactionServiceInfo);
					} else if(transactionServiceInfo.getPaymentSetOffTypes().contains(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId()) && getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId())) {
						saveFlatKhataBifurcationAndOtherCharges(transactionServiceInfo);
					} else if(transactionServiceInfo.getPaymentSetOffTypes().contains(MetadataId.CORPUS_FUND.getId()) && getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.CORPUS_FUND.getId())) {
						saveCorpusFund(transactionServiceInfo);
					}
				}//final level
			}
			
			log.info("Currenlty processing setoff\t"+paymentSetOffDetails.getSetOffTypeName());
			
			/* written by venkat */
			/* inserting data into the FIN_BOOKING_FORM_FLAT_CANCELLATION_COST */
			if(transactionServiceInfo.isThisIsFinalLevel())
			if (Util.isNotEmptyObject(paymentSetOffDetails.getSetOffTypeName())
					? paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.FLAT_CANCELLATION.getName())
					: false) {
				double amount = paymentSetOffDetails.getAmount();
				Long bookingFormId = transactionServiceInfo.getBookingFormId();
				Long transactionEntryId = transactionServiceInfo.getTransactionEntryId();
				FlatCancellationCostPojo pojo = financialMapper.createFlatCancellationCostPojo(bookingFormId,transactionEntryId, amount);
				Long pk = employeeFinancialServiceDao.saveFlatCancelationCost(pojo);
				
				FinBookingFormAccountsPojo finBookingFormAccountsPojo = financialMapper
						.createFinBookingFormAccountsPojo(pk,MetadataId.FLAT_CANCELLATION.getId(),paymentSetOffDetails,transactionServiceInfo);
				
				@SuppressWarnings("unused")
				Long finBookingFormAccountsPk = employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
				/* written by venkat */
				CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo2.setType(MetadataId.FLAT_CANCELLATION.getId());
				customerPropertyDetailsInfo2.setFlatBookingId(transactionServiceInfo.getBookingFormId());

				List<FinBookingFormAccountSummaryPojo>  listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);
				FinBookingFormAccountSummaryPojo accSummaryPojo = financialMapper.createFinBookingFormAccountSummaryPojo(MetadataId.FLAT_CANCELLATION.getId(),paymentSetOffDetails,transactionServiceInfo);
				
				if (! listOfBookingAccountSummaryDetails.isEmpty()) {
					employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
				} else {
					employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
				}
				//continue;
			}
			
			/* inserting data into the QRY_TO_INSERT_FIN_BKNG_FORM_REFUNDABLE_ADV  */
			if(transactionServiceInfo.isThisIsFinalLevel())
			if (Util.isNotEmptyObject(paymentSetOffDetails.getSetOffTypeName())? (paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.REFUNDABLE_ADVANCE.getName()) || paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.TDS.getName())): false) {
				if(transactionServiceInfo.getTransactionTypeName().equalsIgnoreCase("Receipt")) {
				double amount = paymentSetOffDetails.getAmount();
				Long pk =  null;
			    Long bookingFormId = transactionServiceInfo.getBookingFormId();
			    Long transactionEntryId = transactionServiceInfo.getTransactionEntryId();
			    Long employeeId = transactionServiceInfo.getEmployeeId();
			    FinBookingFormRefundableAdvancePojo pojo = financialMapper.createFinBookingFormRefundableAdvancePojo(bookingFormId,transactionEntryId, amount,employeeId);
			    if(paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.REFUNDABLE_ADVANCE.getName()))
			    	pk =  employeeFinancialServiceDao.saveFinBookingFormRefundableAdvance(pojo);
			    
			    FinBookingFormAccountsPojo finBookingFormAccountsPojo = financialMapper
						.createFinBookingFormAccountsPojo(pk,getMetaDataId(paymentSetOffDetails.getSetOffTypeName()),paymentSetOffDetails,transactionServiceInfo);
				employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
				/* written by venkat */
				CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo2.setType(getMetaDataId(paymentSetOffDetails.getSetOffTypeName()));
				customerPropertyDetailsInfo2.setFlatBookingId(transactionServiceInfo.getBookingFormId());
				customerPropertyDetailsInfo2.setFlatNo(customerPropertyDetailsInfo.getFlatNo()); 
				customerPropertyDetailsInfo2.setFlatId(customerPropertyDetailsInfo.getFlatId());
				customerPropertyDetailsInfo2.setPancard(customerPropertyDetailsInfo.getPancard());
				List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);
				FinBookingFormAccountSummaryPojo accSummaryPojo = financialMapper.createFinBookingFormAccountSummaryPojo(getMetaDataId(paymentSetOffDetails.getSetOffTypeName()),paymentSetOffDetails,transactionServiceInfo);
				
				if (! listOfBookingAccountSummaryDetails.isEmpty()) {
					employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
				} else {
					employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
				}
				   //continue;
				} else {//if it is refund entry
					//if(transactionServiceInfo.getTransactionTypeName().equalsIgnoreCase("Receipt")) {
						double amount = paymentSetOffDetails.getAmount();
					    Long bookingFormId = transactionServiceInfo.getBookingFormId();
					    Long transactionEntryId = transactionServiceInfo.getTransactionEntryId();
					    Long employeeId = transactionServiceInfo.getEmployeeId();
					    FinBookingFormRefundableAdvancePojo pojo = financialMapper.createFinBookingFormRefundableAdvancePojo(bookingFormId,transactionEntryId, amount,employeeId);
					    Long pk =  employeeFinancialServiceDao.saveFinBookingFormRefundableAdvance(pojo);
					    
					    @SuppressWarnings("unused")
						FinBookingFormAccountsPojo finBookingFormAccountsPojo = financialMapper
								.createFinBookingFormAccountsPojo(pk,getMetaDataId(paymentSetOffDetails.getSetOffTypeName()),paymentSetOffDetails,transactionServiceInfo);
						//Long finBookingFormAccountsPk = employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
					
						/* written by venkat */
						CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
						customerPropertyDetailsInfo2.setType(getMetaDataId(paymentSetOffDetails.getSetOffTypeName()));
						customerPropertyDetailsInfo2.setFlatBookingId(transactionServiceInfo.getBookingFormId());

						@SuppressWarnings("unused")
						List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);
						@SuppressWarnings("unused")
						FinBookingFormAccountSummaryPojo accSummaryPojo = financialMapper.createFinBookingFormAccountSummaryPojo(getMetaDataId(paymentSetOffDetails.getSetOffTypeName()),paymentSetOffDetails,transactionServiceInfo);
						//employeeFinancialServiceDao.updateBookingFormAccountSummaryRefundAmount(accSummaryPojo);
						
						/*if(Util.isNotEmptyObject(listOfBookingAccountSummaryDetails)) {
							FinBookingFormAccountSummaryPojo  accountSummaryPojo= listOfBookingAccountSummaryDetails.get(0);
							double payableAmount = Util.isEmptyObject(accountSummaryPojo.getPayableAmount())?0d:new BigDecimal(accountSummaryPojo.getPayableAmount()).setScale(roundingModeSize, roundingMode).doubleValue();
							double refundAmount = Util.isEmptyObject(accountSummaryPojo.getRefundAmount())?0d:new BigDecimal(accountSummaryPojo.getRefundAmount()).setScale(roundingModeSize, roundingMode).doubleValue();;
							
							if((refundAmount+payingAmount)>payableAmount) {
								throw new EmployeeFinancialServiceException("Refunding amount more then the paid amount Paid Amount "+payableAmount+", Already refund amount "+refundAmount+" trying to refund amount "+(refundAmount+payingAmount));
							}
						} else {
							throw new EmployeeFinancialServiceException("Refundable details not found, Payment refund process got failed.");
						}*/
						/*
						 * if (! listOfBookingAccountSummaryDetails.isEmpty()) {
						 * employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
						 * } else {
						 * employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo); }
						 */
				//   }
				}
			}

			
			String setOffAmountType = getConvenienceNameFromMetaData(paymentSetOffDetails.getSetOffTypeName());
			CustomerPropertyDetailsInfo info = new CustomerPropertyDetailsInfo();
			info.setFlatBookingId(transactionServiceInfo.getBookingFormId());
			info.setType(getMetaDataId(paymentSetOffDetails.getSetOffTypeName()));
			info.setFlatNo(customerPropertyDetailsInfo.getFlatNo()); info.setFlatId(customerPropertyDetailsInfo.getFlatId()); info.setPancard(customerPropertyDetailsInfo.getPancard());
			info.setStatusId(Status.ACTIVE.getStatus());
			
			if(paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("PRINCIPAL_AMOUNT") || paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("Fin_Booking_Form_Milestones") ) {
				info.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
			}
			
			List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(info);
			if(listOfBookingAccountSummaryDetails.isEmpty()) {
				//if the payment set off is  REFUNDABLE_ADVANCE or FLAT_CANCELLATION, as we have screen for other type of transaction, we are ignoring these type, bcoz these data we are inserting on receipt entry time
				if (paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.TDS.getName()) || paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.REFUNDABLE_ADVANCE.getName())
						|| paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.FLAT_CANCELLATION.getName())
						|| getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.INTEREST_WAIVER.getId())
						|| getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.FIN_PENALTY.getId())
						|| getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId())
						|| getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.MAINTENANCE_CHARGE.getId())
						|| getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.CORPUS_FUND.getId())
						) {
					//ignore the account summary data for this type of metadata, bcoz this type don't have any screen to create this type
				} else {
					log.info("Currenlty processing setoff\t"+paymentSetOffDetails.getSetOffTypeName());
					throw new EmployeeFinancialServiceException(setOffAmountType+" Details not found for Payment set off.");
				}
			}
			paymentSetOffDetails.setPayableAmount(Util.isEmptyObject(listOfBookingAccountSummaryDetails)?0d:listOfBookingAccountSummaryDetails.get(0).getPayableAmount());
			//paymentSetOffDetails.setTransactionEntryId(transactionEntryId);
			paymentSetOffDetails.setTransactionSetOffEntryId(transactionSetOffEntryId);
			paymentSetOffDetails.setTypeId(getMetaDataId(paymentSetOffDetails.getSetOffTypeName()));
			if(paymentSetOffDetails.getPaidByName()!=null) {
				paymentSetOffDetails.setPaidById(getMetaDataId(paymentSetOffDetails.getPaidByName()));
			}
			paymentSetOffDetails.setCreatedBy(transactionServiceInfo.getEmployeeId());
			paymentSetOffDetails.setStatusId(Status.ACTIVE.getStatus());
			Long transactionSetOffId = 0l;
			if(transactionActionType==Status.CREATED.getStatus()) {
			//if the request from create new transaction, inserting payment set off record
				transactionSetOffId = employeeFinancialServiceDao.saveTransactionSetOffDetails((FinTransactionSetOffPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(paymentSetOffDetails,FinTransactionSetOffPojo.class));
			}else {//if approving these transaction 
				transactionSetOffId = paymentSetOffDetails.getFinTransactionSetOffId();
				if(Util.isEmptyObject(paymentSetOffDetails.getFinTransactionSetOffId()) || paymentSetOffDetails.getFinTransactionSetOffId().equals(0l)) {
                   //if the request from approve transaction, and new payment set off added then inserting payment set off record
					transactionSetOffId = employeeFinancialServiceDao.saveTransactionSetOffDetails((FinTransactionSetOffPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(paymentSetOffDetails,FinTransactionSetOffPojo.class));
				} else {
				//if the request from approve transaction, and existing payment set off modified then updating payment set off record
					//paymentSetOffDetails.setTransactionSetOffEntryId(transactionSetOffEntryId);
					employeeFinancialServiceDao.updateTransactionSetOffDetails((FinTransactionSetOffPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(paymentSetOffDetails,FinTransactionSetOffPojo.class),Status.ACTIVE.getStatus());
				}
			}	
			
			/*  written by venkat k */
			if (Util.isNotEmptyObject(paymentSetOffDetails.getSetOffTypeName())? (paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.REFUNDABLE_ADVANCE.getName()) || paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.TDS.getName())): false) {
				countSetOffDetails++;paymentSetOffDetails.setRefundFromMileStone("true");
				if(!transactionServiceInfo.getTransactionTypeName().equalsIgnoreCase("Receipt")) {
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
					customerPropertyDetailsInfo2.setType(getMetaDataId(paymentSetOffDetails.getSetOffTypeName()));
					customerPropertyDetailsInfo2.setFlatBookingId(transactionServiceInfo.getBookingFormId());
	
					List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails1 = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);
					//FinBookingFormAccountSummaryPojo accSummaryPojo = financialMapper.createFinBookingFormAccountSummaryPojo(getMetaDataId(paymentSetOffDetails.getSetOffTypeName()),paymentSetOffDetails,transactionServiceInfo);
					//employeeFinancialServiceDao.updateBookingFormAccountSummaryRefundAmount(accSummaryPojo);
					
					if(Util.isNotEmptyObject(listOfBookingAccountSummaryDetails1)) {
						 
					} else {
						throw new EmployeeFinancialServiceException("Refundable details not found, payment refund process got failed.");
					}
					if(!transactionServiceInfo.isThisIsFinalLevel()) {
						continue;
					}
				} else {
					
				}
				if(!transactionServiceInfo.isThisIsFinalLevel()) {
					continue;
				}
				//continue;
			}
			/*  written by venkat  */
			if (Util.isNotEmptyObject(paymentSetOffDetails.getSetOffTypeName())? paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.FLAT_CANCELLATION.getName()): false) {
				countSetOffDetails++;
				continue;
			}
			
			FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
			finProjDemandNoteInfo.setFinBokAccInvoiceNo(paymentSetOffDetails.getInvoiceNo());
			//checking here type of payement set off, and based on type loading records, for payment set off
			if(paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("PRINCIPAL_AMOUNT")||paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase(MetadataId.FIN_BOOKING_FORM_MILESTONES.getName())) {
				//if u paying principal amount means u r paying milestone amount
				finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()}));
				//transactionServiceInfo.setFlatPayableAmount(listOfBookingAccountSummaryDetails.get(0).getPayableAmount());
			} else if(paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("TAX_AMOUNT")) {//not in use
				finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {MetadataId.FIN_BOOKING_FORM_MILESTONE_TAX.getId()}));	
			} else if(paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("INTEREST")) {
				finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {MetadataId.FIN_PENALTY.getId()}));//interest amount	
			} else if(paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("Interest_Waiver")) {
				finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {MetadataId.FIN_PENALTY.getId()}));	//interest amount
			} else {
			 	finProjDemandNoteInfo.setType(Arrays.asList(MetadataId.valueOf(paymentSetOffDetails.getSetOffTypeName().toUpperCase()).getId()));
			}
			finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.INPROGRESS.getStatus(),Status.PENDING.getStatus()}));
			//we don't required paid status
			//Long typeId = finProjDemandNoteInfo.getType().get(0);
			if(isTransactionForIsEmpty) {//condition for payment refund transaction
				paymentSetOffDetails.setRefundFromMileStone("true");
				finProjDemandNoteInfo.setDataSelectionOrder("DESC");
				finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.INPROGRESS.getStatus(),Status.PAID.getStatus()}));
				info.setCondition("PaymentRefund");
				info.setFinBokAccInvoiceNo(paymentSetOffDetails.getInvoiceNo());//refunding amount on invoice no for legal and modification invoice
				//loading data from excess amount, if any amount exists	for refund
				listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(info,Arrays.asList(getMetaDataId(paymentSetOffDetails.getSetOffTypeName())));
				//info.setFinBokAccInvoiceNo("");
				if(isNotEmptyObject(paymentSetOffDetails.getRefundFromMileStone())
						&&paymentSetOffDetails.getRefundFromMileStone().equalsIgnoreCase("true")) {
						finProjDemandNoteInfo.setCondition("ProcessPaymentSetOff");//loading paid amount data of milestone for refund
					    listOfNonPaidMileStoneDetails = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, info,FinEnum.DO_NOT_lOAD_DATA);
				} else {
					if (listOfExcessAmount.isEmpty()) {//if excess amount is empty, so we don't have any amount for refund
						errorMsgs = new ArrayList<>();
						errorMsgs.add("No excess amount exists for payment refund on " + setOffAmountType + ".");
						throw new RefundAmountException(errorMsgs);
					}
				}
				//12-may - 1st milestone
				//15-may - 2nd milestone  
				//16-may - 3rd milestone - inactive 3 rd ms id
				//16-may - 3rd milestone - hold 1st ms id

				//refunding excess amount if any
				for (FinBookingFormExcessAmountPojo finBookingFormExcessAmountPojo : listOfExcessAmount) {
					excessAmount = finBookingFormExcessAmountPojo.getBalanceAmount();//
					if (excessAmount > 0) {//balance amount if more then zero
						if (amountToRefund > 0) {//and amount to refund also more than zero
							paymentSetOffDetails.setFinTransactionSetOffId(transactionSetOffId);
							//paymentSetOffDetails.setSetOffTypeName(String.valueOf(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId()));
							paymentSetOffDetails.setSetOffTypeId(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId());
							paymentSetOffDetails.setStatusId(Status.ACTIVE.getStatus());
							paymentSetOffDetails.setTypeId(finBookingFormExcessAmountPojo.getFinBookingFormExcessAmountId());
							amountToRefund = roundOffAmount(amountToRefund - excessAmount);
							//got amount to refund from excess amount
							FinTransactionPmtSetOffAccMapPojo paymentSetOffAccMapPojo=(FinTransactionPmtSetOffAccMapPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(paymentSetOffDetails,FinTransactionPmtSetOffAccMapPojo.class);
							//paymentSetOffAccMapPojo.setType(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId());
							//paymentSetOffAccMapPojo.setTypeId(finBookingFormExcessAmountPojo.getFinBookingFormExcessAmountId());
							long finTrnPaymentSetOffAccMapId = employeeFinancialServiceDao.saveTranPaymentSetOffAccountDetails(paymentSetOffAccMapPojo);
							listOfTransactionPaymentSetOffMap.add(finTrnPaymentSetOffAccMapId);
							//holding inserted primary key id's, so we can inactivate other id's which is not required for refund
							countSetOffDetails++;
						} else {
							break;
						}
					}
				}
			}
			
			if(!isTransactionForIsEmpty) {//if this Receipt entry Type Transaction
				finProjDemandNoteInfo.setCondition("ProcessPaymentSetOff");
				listOfNonPaidMileStoneDetails = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, info,FinEnum.DO_NOT_lOAD_DATA);
				if(Util.isNotEmptyObject(finProjDemandNoteInfo.getFinBokAccInvoiceNo()) && isEmptyObject(listOfNonPaidMileStoneDetails)) {
					/*errorMsgs = new ArrayList<>();
					errorMsgs.add("No Payment details found for " + setOffAmountType + ", cannot proceed set off payment");*/
					log.info("Failed to process " + setOffAmountType + ", No data found for invoice no "+finProjDemandNoteInfo.getFinBokAccInvoiceNo());
					throw new EmployeeFinancialServiceException("Failed to process " + setOffAmountType + ", No data found for invoice no "+finProjDemandNoteInfo.getFinBokAccInvoiceNo());
				}
			}
			
			if(isNotEmptyObject(paymentSetOffDetails.getRefundFromMileStone()) && paymentSetOffDetails.getRefundFromMileStone().equalsIgnoreCase("true")) {
				//if this both excess amount and paid amount found empty, so we don't have anything to adjust
				if (isEmptyObject(listOfNonPaidMileStoneDetails) && isEmptyObject(listOfExcessAmount)) {
					errorMsgs = new ArrayList<>();
					errorMsgs.add("Payment details not found for " + setOffAmountType + ", cannot proceed set off payment.");
					log.info("errorMsgs "+errorMsgs);
					throw new RefundAmountException(errorMsgs);
				}
			}
			
			settledAmount = settledAmount + payingAmount;
			for (FinancialProjectMileStonePojo accPojo : listOfNonPaidMileStoneDetails) {
				Double accPayAmount  = accPojo.getPayAmount();
				Double accPaidAmount  = accPojo.getPaidAmount();
				Double pendingAmount = accPayAmount-accPaidAmount;//finalAmt is nothing but remaining amount on milestone
				//log.info(" amount to set off "+finalAmt+" on against "+accPojo.getFinBookingFormAccountsId());
				//from milestone refunding amount
					if (isTransactionForIsEmpty) {//this condition is for payment refund
						if(isNotEmptyObject(paymentSetOffDetails.getRefundFromMileStone()) && paymentSetOffDetails.getRefundFromMileStone().equalsIgnoreCase("true")) {
							if(accPaidAmount>0) {//for refund amount, paid amount should be more than zero
								if(amountToRefund>0) {//for current request refund amount should be more than zero
									paymentSetOffDetails.setFinTransactionSetOffId(transactionSetOffId);
									paymentSetOffDetails.setFinBookingFormAccountsId(accPojo.getFinBookingFormAccountsId());
									paymentSetOffDetails.setSetOffTypeId(MetadataId.FIN_BOOKING_FORM_ACCOUNTS.getId());
									// paymentSetOffDetails.setSetOffTypeName(String.valueOf(MetadataId.FIN_BOOKING_FORM_ACCOUNTS.getId()));
									paymentSetOffDetails.setTypeId(accPojo.getFinBookingFormAccountsId());
									paymentSetOffDetails.setStatusId(Status.ACTIVE.getStatus());//we have to refund amount if amount is paid
									amountToRefund = roundOffAmount(amountToRefund - accPaidAmount);
									excessAmount +=accPaidAmount;
									FinTransactionPmtSetOffAccMapPojo paymentSetOffAccMapPojo = (FinTransactionPmtSetOffAccMapPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(paymentSetOffDetails,FinTransactionPmtSetOffAccMapPojo.class);
									long finTrnPaymentSetOffAccMapId = employeeFinancialServiceDao.saveTranPaymentSetOffAccountDetails(paymentSetOffAccMapPojo);
									listOfTransactionPaymentSetOffMap.add(finTrnPaymentSetOffAccMapId);
									countSetOffDetails++;
								}else {
									break;
								}
							}
						}
					} else {//this condition is for Receipt* Type transaction
						if (pendingAmount <= 0) {
							continue;
						}
						if(payingAmount>0) {
							paymentSetOffDetails.setFinTransactionSetOffId(transactionSetOffId);
							paymentSetOffDetails.setFinBookingFormAccountsId(accPojo.getFinBookingFormAccountsId());
							paymentSetOffDetails.setStatusId(Status.ACTIVE.getStatus());
							double msWiseAmountToSetOff = 0;
							//transactionPayingAmount += payingAmount; 
							if(payingAmount>pendingAmount) {
								msWiseAmountToSetOff = pendingAmount;
							} else {
								msWiseAmountToSetOff = payingAmount;
							}
							
							payingAmount = payingAmount- pendingAmount;
							
							paymentSetOffDetails.setMsWiseAmountToSetOff(msWiseAmountToSetOff);
							FinTransactionSetOffAccMapPojo pojo = (FinTransactionSetOffAccMapPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(paymentSetOffDetails,FinTransactionSetOffAccMapPojo.class);
							long finTransactionSetOffAccMapId = employeeFinancialServiceDao.saveTranSetOffAccountDetails(pojo);
							listOfTransactionSetOffAccMap.add(finTransactionSetOffAccMapId);
							countSetOffDetails++;
						}
					}
				}
				if (isTransactionForIsEmpty) {
					if (payingAmount > 0) {
						//log.info("Got extra amount than set off " + payingAmount + " " + paymentSetOffDetails);
					}
				}
				if (isTransactionForIsEmpty) {//if refund entry
					if (amountToRefund > 0) {//if amount refund is more than zero,
						//if refund entry amount is 5,00,000 but customer paid only 4,00,000, so remaining is 1,00,000, so we are thowing exception  
						errorMsgs =new ArrayList<>();
						//if this amount is refunding from milestone adjusted amount show this msg
						if("true".equalsIgnoreCase(paymentSetOffDetails.getRefundFromMileStone())) {
							errorMsgs.add("You are trying to refund amount more than paid amount on "+setOffAmountType+", paid amount is : "+excessAmount+" trying to refund amount :"+(amountToRefund+excessAmount));	
							log.info("EmployeeFinancialServiceImpl.processPaymentSetOffDetails() "+errorMsgs);
						} else {
							errorMsgs.add("You are trying to refund amount more than paid amount on "+setOffAmountType+", Excess amount is : "+excessAmount+" trying to refund amount :"+(amountToRefund+excessAmount));
							log.info("EmployeeFinancialServiceImpl.processPaymentSetOffDetails() "+errorMsgs);
						}
						log.info("EmployeeFinancialServiceImpl.processPaymentSetOffDetails() "+errorMsgs);
						throw new RefundAmountException(errorMsgs);
					}
				}
			if (transactionActionType != Status.CREATED.getStatus()) {
				if (!listOfTransactionPaymentSetOffMap.isEmpty()) {
					//inactivating records other than listOfTransactionPaymentSetOffMap
					employeeFinancialServiceDao.updateTranPaymentSetOffAccountDetails(listOfTransactionPaymentSetOffMap,paymentSetOffDetails);
				}
				if (!listOfTransactionSetOffAccMap.isEmpty()) {
					employeeFinancialServiceDao.updateTranSetOffAccountDetails(listOfTransactionSetOffAccMap,paymentSetOffDetails);
				}
			}
		}
		//if nothing is set off throw the exception
		/*if(countSetOffDetails==0) {
			throw new EmployeeFinancialServiceException("No payment set off has been done... ");
		}*/
	}

	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)//new added //uncomment it
	public EmployeeFinancialTransactionServiceInfo interestCalculateAndConstructTransactionObject(EmployeeFinancialServiceInfo employeeFinancialRequest) throws Exception {
		double amount = 0d;
		EmployeeFinancialTransactionServiceInfo info = new EmployeeFinancialTransactionServiceInfo();
		//creating save financial transaction request object
		BeanUtils.copyProperties(employeeFinancialRequest, info);
		info.setSiteId(employeeFinancialRequest.getSiteId());
		info.setFlatIds(employeeFinancialRequest.getFlatIds());
		info.setRequestUrl(employeeFinancialRequest.getRequestUrl());
		info.setBookingFormId(employeeFinancialRequest.getBookingFormId());
		info.setTransactionTypeId(FinTransactionType.INTEREST_WAIVER.getId());
		info.setTransactionTypeName(FinTransactionType.INTEREST_WAIVER.getName());
		info.setPortNumber(employeeFinancialRequest.getPortNumber());
		info.setCreatedBy(Long.valueOf(employeeFinancialRequest.getEmpId()));
		info.setEmployeeId(Long.valueOf(employeeFinancialRequest.getEmpId()));
		info.setTransactionModeId(FinTransactionMode.INTEREST_WAIVER.getId());
		info.setTransactionModeName(FinTransactionMode.INTEREST_WAIVER.getName());
		/*info.setComments(employeeFinancialRequest.getComments());
		info.setComment(employeeFinancialRequest.getComment());*/
		info.setTransactionDate(new Timestamp(new Date().getTime()));
		
		info.setFileInfos(employeeFinancialRequest.getFileInfos());
		//---------------------------------------- using this method interest will calculate
		insertPenaltyData(info,employeeFinancialRequest,null);//insertPenaltyData
		
		CustomerPropertyDetailsInfo flatInfo = info.getCustomerPropertyDetailsInfo();
		
		if(employeeFinancialRequest.getRequestUrl()!=null && employeeFinancialRequest.getRequestUrl().equals("saveFinancialTransaction")) {
			return info;
		}
		
		List<EmployeeFinTranPaymentSetOffInfo> paymentSetOffDetails = new ArrayList<EmployeeFinTranPaymentSetOffInfo>();
		//selected milestone for interest waiver
		List<FinancialProjectMileStoneInfo> milestoneRequest = employeeFinancialRequest.getFinancialProjectMileStoneRequests();
		for (FinancialProjectMileStoneInfo finProjDemandNoteInfo : milestoneRequest) {
			if(finProjDemandNoteInfo.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
				 continue;
			}
			EmployeeFinTranPaymentSetOffInfo setOffInfo = new EmployeeFinTranPaymentSetOffInfo();
			/*FinancialProjectMileStoneInfo mileStoneInfo = new FinancialProjectMileStoneInfo();
			mileStoneInfo.setFinBookingFormMilestonesId(financialProjectMileStoneRequest.getFinBookingFormMilestonesId());*/
			finProjDemandNoteInfo.setBookingFormId(employeeFinancialRequest.getBookingFormId());
			List<FinBookingFormAccountsPojo> finBookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinPenaltyDetailsForInterestWaiver(finProjDemandNoteInfo);
			if(Util.isNotEmptyObject(finBookingFormAccountsPojoLists)) {
				if (finBookingFormAccountsPojoLists.size() > 1) {
					throw new EmployeeFinancialServiceException("Found duplicate record for interest, Please contact to support team...");
				}
				FinBookingFormAccountsPojo accPojo = finBookingFormAccountsPojoLists.get(0);
				System.out.println("accPojo.getInterestWaiverAdjAmount() "+accPojo.getInterestWaiverAdjAmount()+", accPojo.getPaidAmount() "+accPojo.getPaidAmount());
				flatInfo.setFinBokAccInvoiceNo(accPojo.getFinBokAccInvoiceNo());
				//already pending waiver amount for approval
				double sumOfInitiatedWaiverAmount = employeeFinancialServiceDao.getInitiatedInterestWaiverDetails(flatInfo,"saveInterestWaiver");
				double amt = new BigDecimal(finProjDemandNoteInfo.getSetOffAmount()+accPojo.getInterestWaiverAdjAmount()+accPojo.getPaidAmount()+sumOfInitiatedWaiverAmount).setScale(roundingModeSize, roundingMode).doubleValue();
				if(amt > accPojo.getPayAmount()) {
					if(sumOfInitiatedWaiverAmount!=0) {
						//throw new EmployeeFinancialServiceException("Amount should not be initiate more than Interest Amount, Milestone Name : "+finProjDemandNoteInfo.getMilestoneName()+",Please approve pending interest waiver amount "+sumOfInitiatedWaiverAmount);
						throw new EmployeeFinancialServiceException("The interest waiver request is already initiatedfor the selected milestones. Milestone Detail: "+finProjDemandNoteInfo.getMilestoneName()+" And Amount is : "+sumOfInitiatedWaiverAmount);
					}
					throw new EmployeeFinancialServiceException("The interest amount of Rs "+accPojo.getPaidAmount()+" is paid by thecustomer against the following milestone "+finProjDemandNoteInfo.getMilestoneName()+", and Waived off amount "+accPojo.getInterestWaiverAdjAmount()+". Could not proceed transaction.");
					//throw new EmployeeFinancialServiceException("The interest amount is paid by thecustomer. Please ignore/reject the request.");
				}
				setOffInfo.setInvoiceNo(accPojo.getFinBokAccInvoiceNo());
			} else {
				throw new EmployeeFinancialServiceException("Record not found for interest, Please contact to support team...");
			}
			
			setOffInfo.setAmount(finProjDemandNoteInfo.getSetOffAmount());
			setOffInfo.setSetOffTypeName("INTEREST_WAIVER");
			amount += finProjDemandNoteInfo.getSetOffAmount();
			paymentSetOffDetails.add(setOffInfo);
		}
		info.setTransactionAmount(amount);
		info.setPaymentSetOffDetails(paymentSetOffDetails);
		return info;
	}
	
	private Map<String, Boolean> checkChangedTransactionDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) 
			throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.checkChangedTransactionDetails() *****");
		long transactionApproveStatId = transactionServiceInfo.getTransactionApproveStatId();
		SimpleDateFormat dateFormat = new SimpleDateFormat("dd-MM-yyyy");
		Map<String, Boolean> map =  new HashMap<>();
		boolean isPaymentSetOffDetailsChanged = false;
		List<FinTransactionChangedDtlsPojo> changedDetailsList = new ArrayList<>();
		//Map<String, StringBuilder> changedDetailsMapList = new HashMap<>();
		EmployeeFinancialTransactionServiceInfo prevTransactionServiceDetails = (EmployeeFinancialTransactionServiceInfo) transactionServiceInfo.clone();
			
			//if(!transactionServiceInfo.getTransactionActionType().equals(Status.MODIFY.getStatus())) {
				prevTransactionServiceDetails.setTransactionEntryId(Util.isNotEmptyObject(transactionServiceInfo.getPrevTransactionEntryId())?transactionServiceInfo.getPrevTransactionEntryId():transactionServiceInfo.getTransactionEntryId());
				if(transactionServiceInfo.isThisEditTransaction()) {
					prevTransactionServiceDetails.setBookingFormId(transactionServiceInfo.getActualBookingFormId());
					prevTransactionServiceDetails.setFlatIds(transactionServiceInfo.getActualFlatIds());
				}
				if(transactionServiceInfo.isThisIsModifyTransaction()) {
					EmployeeFinancialTransactionServiceInfo actualServiceInfo = transactionServiceInfo.getActualTransactionRequest();
					if(Util.isNotEmptyObject(actualServiceInfo)) {
						prevTransactionServiceDetails.setBookingFormId(actualServiceInfo.getBookingFormId());
						prevTransactionServiceDetails.setFlatIds(actualServiceInfo.getFlatIds());
						prevTransactionServiceDetails.setTransactionEntryId(transactionServiceInfo.getPrevTransactionEntryId());
					}
				}
			//}
			//loading actual details of the transaction before editing and modifiying
			EmployeeFinancialTransactionResponse response = getMisReceiptChequeOnlineData(prevTransactionServiceDetails, Arrays.asList(FinEnum.CHECK_CHANGED_TRANSACTION_DETAILS.getId()));
			log.info(response.getFinTransactionEntryDetailsResponseList());
			if(Util.isEmptyObject(response.getFinTransactionEntryDetailsResponseList()) || Util.isEmptyObject(response.getFinTransactionEntryDetailsResponseList().get(0))) {
				//log.info("Transaction data not found...");
				throw new EmployeeFinancialServiceException("Transaction data not found...");
			}
			if(FinTransactionType.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionTypeId())) {
				CustomerPropertyDetailsInfo flatInfo = (CustomerPropertyDetailsInfo) transactionServiceInfo.getCustomerPropertyDetailsInfo().clone();
				List<FinancialProjectMileStoneResponse> listOfMilestones = response.getFinTransactionEntryDetailsResponseList().get(0).getFinancialProjectMileStoneResponseList();
				if(Util.isNotEmptyObject(listOfMilestones)) {
					for (FinancialProjectMileStoneResponse mileStoneResponse : listOfMilestones) {
						FinancialProjectMileStoneInfo finProjDemandNoteInfo  = new FinancialProjectMileStoneInfo();
						finProjDemandNoteInfo.setFinBookingFormMilestonesId(mileStoneResponse.getFinBookingFormMilestonesId());
						finProjDemandNoteInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
						finProjDemandNoteInfo.setMilestoneName(mileStoneResponse.getMilestoneName());
								List<FinBookingFormAccountsPojo> finBookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinPenaltyDetailsForInterestWaiver(finProjDemandNoteInfo);
								if(Util.isNotEmptyObject(finBookingFormAccountsPojoLists)) {
									if (finBookingFormAccountsPojoLists.size() > 1) {
										throw new EmployeeFinancialServiceException("Found duplicate record for interest, Please contact to support team...");
									}
									FinBookingFormAccountsPojo accPojo = finBookingFormAccountsPojoLists.get(0);
									System.out.println("accPojo.getInterestWaiverAdjAmount() "+accPojo.getInterestWaiverAdjAmount()+", accPojo.getPaidAmount() "+accPojo.getPaidAmount());
									flatInfo.setFinBokAccInvoiceNo(accPojo.getFinBokAccInvoiceNo());
									flatInfo.setTransactionSetOffEntryId(transactionServiceInfo.getTransactionSetOffEntryId());
									double sumOfInitiatedWaiverAmount = employeeFinancialServiceDao.getInitiatedInterestWaiverDetails(flatInfo,"approveInterestWaiver");
									double amt = new BigDecimal(mileStoneResponse.getSetOffAmount()+accPojo.getInterestWaiverAdjAmount()+accPojo.getPaidAmount()+sumOfInitiatedWaiverAmount).setScale(roundingModeSize, roundingMode).doubleValue();
									if(amt > accPojo.getPayAmount()) {
										if(sumOfInitiatedWaiverAmount!=0) {
											throw new EmployeeFinancialServiceException("The interest waiver request is already initiatedfor the selected milestones. Milestone Detail: "+finProjDemandNoteInfo.getMilestoneName()+" And Amount is : "+sumOfInitiatedWaiverAmount);
											//throw new EmployeeFinancialServiceException("Amount should not be initiate more than Interest Amount, Milestone Name : "+finProjDemandNoteInfo.getMilestoneName()+",Please approve pending interest waiver amount "+sumOfInitiatedWaiverAmount);	
										}
										throw new EmployeeFinancialServiceException("The interest amount of Rs "+accPojo.getPaidAmount()+" is paid by thecustomer against the following milestone "+finProjDemandNoteInfo.getMilestoneName()+", and Waived off amount "+accPojo.getInterestWaiverAdjAmount()+". Please ignore/reject the request");
									}
									//setOffInfo.setInvoiceNo(accPojo.getFinBokAccInvoiceNo());
								} else {
									throw new EmployeeFinancialServiceException("Record not found for interest, Please contact to support team...");
								}
					}
				} else {
					throw new EmployeeFinancialServiceException("Failed to load milestone details for interest waiver, Please try again later.!");	
				}
			}
			
			//log.info(response.getFinTransactionEntryDetailsResponseList().get(0).getFinTransactionSetOffResponseList());
			
			FinTransactionChangedDtlsPojo changedDtlsPojo = new FinTransactionChangedDtlsPojo();
			//if request from save booking and booking status is swap, or price update
			if(Util.isNotEmptyObject(transactionServiceInfo.getBookingRequest())) {
				//if this booking is from approve booking and transaction shifting from one booking to another booking
				BookingFormRequest oldBookingRequest = transactionServiceInfo.getBookingRequest().getOldBookingRequest();
				BookingFormRequest newBookingRequest = transactionServiceInfo.getBookingRequest().getNewBookingRequest();
				
				if(Util.isNotEmptyObject(oldBookingRequest) && Util.isNotEmptyObject(newBookingRequest)) {
					changedDtlsPojo = new FinTransactionChangedDtlsPojo();
					changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
					changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
					changedDtlsPojo.setColumnId(MetadataId.FLAT_BOOKING.getId());
					
					changedDtlsPojo.setActualValue(oldBookingRequest.getFlatBookingId()==null?"":oldBookingRequest.getFlatBookingId().toString());
					changedDtlsPojo.setChangedValue(newBookingRequest.getFlatBookingId()==null?"":newBookingRequest.getFlatBookingId().toString());
					changedDtlsPojo.setActionType(Status.TRANSACTION_SHIFTED.getStatus());
					changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
							.append(" Transaction shifted from Booking Id ")
							.append(oldBookingRequest.getFlatBookingId())
							.append(" to ")
							.append(newBookingRequest.getFlatBookingId()).toString());
					changedDetailsList.add(changedDtlsPojo);
				}
			}
			
			//StringBuilder changedDetails = new StringBuilder("");
		if(Util.isNotEmptyObject(response.getFinTransactionEntryDetailsResponseList())) {
			//here checking with actual data with changed data(changed data means data is coming from request and actual data is coming from DB) 
				FinTransactionEntryDetailsResponse prevTransactionEntryDetails = response.getFinTransactionEntryDetailsResponseList().get(0);
				transactionServiceInfo.setPrevTransactionEntryDetailsResponse(prevTransactionEntryDetails);
				//transaction date is nothing but check date
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getTransactionDate()) && Util.isNotEmptyObject(transactionServiceInfo.getTransactionDate())) {
					if(!TimeUtil.removeTimePartFromTimeStamp1(prevTransactionEntryDetails.getTransactionDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getTransactionDate()))) {
						
						String previousTransactionDate = dateFormat.format(prevTransactionEntryDetails.getTransactionDate());
						String currentTransactionDate = dateFormat.format(transactionServiceInfo.getTransactionDate());
						
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.CHEQUE_DATE.getId());
						
						changedDtlsPojo.setActualValue(previousTransactionDate);
						changedDtlsPojo.setChangedValue(currentTransactionDate);
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed cheque date ")
								.append(previousTransactionDate)
								.append(" to ")
								.append(currentTransactionDate).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				} else if(Util.isEmptyObject(prevTransactionEntryDetails.getTransactionDate()) && Util.isNotEmptyObject(transactionServiceInfo.getTransactionDate())) {
					String previousTransactionDate = null;//dateFormat.format(prevTransactionEntryDetails.getTransactionDate());
					String currentTransactionDate = dateFormat.format(transactionServiceInfo.getTransactionDate());
					
					changedDtlsPojo = new FinTransactionChangedDtlsPojo();
					changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
					changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
					changedDtlsPojo.setColumnId(MetadataId.CHEQUE_DATE.getId());
					
					changedDtlsPojo.setActualValue(previousTransactionDate);
					changedDtlsPojo.setChangedValue(currentTransactionDate);
					changedDtlsPojo.setActionType(Status.ADDED.getStatus());
					changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
							.append(" added cheque date ")
							.append(currentTransactionDate).toString());
					changedDetailsList.add(changedDtlsPojo);
				}
				//for payment cheque transactions
				 if(Util.isEmptyObject(prevTransactionEntryDetails.getChequeHandoverDate()) && Util.isNotEmptyObject(transactionServiceInfo.getChequeHandoverDate())) {
						String previousTransactionDate = null;//dateFormat.format(prevTransactionEntryDetails.getTransactionDate());
						String currentTransactionDate = dateFormat.format(transactionServiceInfo.getChequeHandoverDate());
						
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.CHEQUE_DATE.getId());
						
						changedDtlsPojo.setActualValue(previousTransactionDate);
						changedDtlsPojo.setChangedValue(currentTransactionDate);
						changedDtlsPojo.setActionType(Status.ADDED.getStatus());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" added cheque handover date ")
								.append(currentTransactionDate).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getTransactionReceiveDate()) && Util.isNotEmptyObject(transactionServiceInfo.getTransactionReceiveDate())) {
					if(!TimeUtil.removeTimePartFromTimeStamp1(prevTransactionEntryDetails.getTransactionReceiveDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getTransactionReceiveDate()))) {
						String previousTransactionReceiveDate = dateFormat.format(prevTransactionEntryDetails.getTransactionReceiveDate());
						String currentTransactionReceiveDate = dateFormat.format(transactionServiceInfo.getTransactionReceiveDate());
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.RECEIVED_DATE.getId());
						changedDtlsPojo.setActualValue(previousTransactionReceiveDate);
						changedDtlsPojo.setChangedValue(currentTransactionReceiveDate);
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed receive date ")
								.append(previousTransactionReceiveDate)
								.append(" to ")
								.append(currentTransactionReceiveDate).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				}//receive date

				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getChequeClearanceDate()) && Util.isNotEmptyObject(transactionServiceInfo.getChequeClearanceDate())) {
					if(!TimeUtil.removeTimePartFromTimeStamp1(prevTransactionEntryDetails.getChequeClearanceDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getChequeClearanceDate()))) {
						String previouschequeClearanceDate = dateFormat.format(prevTransactionEntryDetails.getChequeClearanceDate());
						String currentchequeClearanceDate = dateFormat.format(transactionServiceInfo.getChequeClearanceDate());
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.CHEQUE_CLEARANCE_DATE.getId());
						changedDtlsPojo.setActualValue(previouschequeClearanceDate);
						changedDtlsPojo.setChangedValue(currentchequeClearanceDate);
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed clearance date ")
								.append(previouschequeClearanceDate)
								.append(" to ")
								.append(currentchequeClearanceDate).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				}//chequeClearanceDate date
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getChequeDepositedDate()) && Util.isNotEmptyObject(transactionServiceInfo.getChequeDepositedDate())) {
					if(!TimeUtil.removeTimePartFromTimeStamp1(prevTransactionEntryDetails.getChequeDepositedDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getChequeDepositedDate()))) {
						String previouschequeDepositedDate = dateFormat.format(prevTransactionEntryDetails.getChequeDepositedDate());
						String currentchequeDepositedDate = dateFormat.format(transactionServiceInfo.getChequeDepositedDate());
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.CHEQUE_DEPOSITED_DATE.getId());
						changedDtlsPojo.setActualValue(previouschequeDepositedDate);
						changedDtlsPojo.setChangedValue(currentchequeDepositedDate);
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed deposited date ")
								.append(previouschequeDepositedDate)
								.append(" to ")
								.append(currentchequeDepositedDate).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				}//getChequeDepositedDate date

				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getChequeNumber()) && Util.isNotEmptyObject(transactionServiceInfo.getChequeNumber())) {
					if(!prevTransactionEntryDetails.getChequeNumber().equals(transactionServiceInfo.getChequeNumber())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.CHEQUE_NUMBER.getId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getChequeNumber().toString());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getChequeNumber().toString());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed cheque number ")
								.append(prevTransactionEntryDetails.getChequeNumber())
								.append(" to ")
								.append(transactionServiceInfo.getChequeNumber()).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				} else if(Util.isEmptyObject(prevTransactionEntryDetails.getChequeNumber()) && Util.isNotEmptyObject(transactionServiceInfo.getChequeNumber())) {
					changedDtlsPojo = new FinTransactionChangedDtlsPojo();
					changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
					changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
					changedDtlsPojo.setColumnId(MetadataId.CHEQUE_NUMBER.getId());
					changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getChequeNumber());
					changedDtlsPojo.setChangedValue(transactionServiceInfo.getChequeNumber());
					changedDtlsPojo.setActionType(Status.ADDED.getStatus());
					changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
							.append(" added cheque number ") 
							.append(transactionServiceInfo.getChequeNumber()).toString());
					changedDetailsList.add(changedDtlsPojo);
				}//check number
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getTransactionAmount()) && Util.isNotEmptyObject(transactionServiceInfo.getTransactionAmount())) {
					if(!prevTransactionEntryDetails.getTransactionAmount().equals(transactionServiceInfo.getTransactionAmount())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.AMOUNT.getId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getTransactionAmount().toString());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getTransactionAmount().toString());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed transaction amount ")
								.append(prevTransactionEntryDetails.getTransactionAmount())
								.append(" to ")
								.append(transactionServiceInfo.getTransactionAmount()).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				}//cheque amount
				
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getTransactionModeName()) && Util.isNotEmptyObject(transactionServiceInfo.getTransactionModeName())) {
					if(!prevTransactionEntryDetails.getTransactionModeName().equals(transactionServiceInfo.getTransactionModeName())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.TRANSACTION_MODE.getId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getTransactionModeName().toString());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getTransactionModeName().toString());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed online transaction mode ")
								.append(prevTransactionEntryDetails.getTransactionModeName())
								.append(" to ")
								.append(transactionServiceInfo.getTransactionModeName()).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				}//transaction mode
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getBankName()) && Util.isNotEmptyObject(transactionServiceInfo.getBankName())) {
					if(!prevTransactionEntryDetails.getBankName().equals(transactionServiceInfo.getBankName())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getBankName());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getBankName());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setColumnId(MetadataId.BANK_NAME.getId());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed bank ")
								.append(prevTransactionEntryDetails.getBankName())
								.append(" to ")
								.append(transactionServiceInfo.getBankName()).toString());
						changedDetailsList.add(changedDtlsPojo);
					}//bank name
				} else if(Util.isNotEmptyObject(prevTransactionEntryDetails.getBankName()) && Util.isEmptyObject(transactionServiceInfo.getBankName())) {
					changedDtlsPojo = new FinTransactionChangedDtlsPojo();
					changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
					changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
					changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getBankName());
					changedDtlsPojo.setChangedValue(transactionServiceInfo.getBankName());
					changedDtlsPojo.setActionType(Status.REMOVED.getStatus());
					changedDtlsPojo.setColumnId(MetadataId.BANK_NAME.getId());
					changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
							.append(" removed bank from transaction bank name ")
							.append(prevTransactionEntryDetails.getBankName()).toString());
					changedDetailsList.add(changedDtlsPojo);
				
				} else if (Util.isEmptyObject(prevTransactionEntryDetails.getBankName()) && Util.isNotEmptyObject(transactionServiceInfo.getBankName())) {
					changedDtlsPojo = new FinTransactionChangedDtlsPojo();
					changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
					changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
					changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getBankName());
					changedDtlsPojo.setChangedValue(transactionServiceInfo.getBankName());
					changedDtlsPojo.setActionType(Status.ADDED.getStatus());
					changedDtlsPojo.setColumnId(MetadataId.BANK_NAME.getId());
					changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
							.append(" Added bank for transaction bank name ")
							.append(transactionServiceInfo.getBankName()).toString());
					changedDetailsList.add(changedDtlsPojo);
				}
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getSourceOfFunds()) && Util.isNotEmptyObject(transactionServiceInfo.getSourceOfFunds())) {
					if(!prevTransactionEntryDetails.getSourceOfFunds().equals(transactionServiceInfo.getSourceOfFunds())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getSourceOfFunds());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getSourceOfFunds());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setColumnId(MetadataId.SOURCE_OF_FUNDS.getId());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed source of funds ")
								.append(prevTransactionEntryDetails.getSourceOfFunds())
								.append(" to ")
								.append(transactionServiceInfo.getSourceOfFunds()).toString());
						changedDetailsList.add(changedDtlsPojo);
					}//Source Of Funds name
				}
				
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getSiteId()) && Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
					if(!prevTransactionEntryDetails.getSiteId().equals(transactionServiceInfo.getSiteId())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getSiteId().toString());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getSiteId().toString());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setColumnId(MetadataId.SOURCE_OF_FUNDS.getId());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed Project ")
								.append(prevTransactionEntryDetails.getSiteId())
								.append(" to ")
								.append(transactionServiceInfo.getSiteId()).toString());
						changedDetailsList.add(changedDtlsPojo);
					}//Source Of Funds name
				}
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getSiteBankAccountNumber()) && Util.isNotEmptyObject(transactionServiceInfo.getSiteBankAccountNumber())) {
					if(!prevTransactionEntryDetails.getSiteBankAccountNumber().equals(transactionServiceInfo.getSiteBankAccountNumber())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getSiteBankAccountNumber().toString());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getSiteBankAccountNumber().toString());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setColumnId(MetadataId.FIN_SITE_PROJ_ACC_MAP_ID.getId());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed site bank account number")
								.append(prevTransactionEntryDetails.getSiteBankAccountNumber())
								.append(" to ")
								.append(transactionServiceInfo.getSiteBankAccountNumber()).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				} else if(Util.isEmptyObject(prevTransactionEntryDetails.getSiteBankAccountNumber()) && Util.isNotEmptyObject(transactionServiceInfo.getSiteBankAccountNumber())) {
					changedDtlsPojo = new FinTransactionChangedDtlsPojo();
					changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
					changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
					changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getSiteBankAccountNumber());
					changedDtlsPojo.setChangedValue(transactionServiceInfo.getSiteBankAccountNumber());
					changedDtlsPojo.setActionType(Status.ADDED.getStatus());
					changedDtlsPojo.setColumnId(MetadataId.FIN_SITE_PROJ_ACC_MAP_ID.getId());
					changedDtlsPojo.setRemarks(new StringBuilder("")
							.append(" added site bank account number ")
							.append(transactionServiceInfo.getSiteBankAccountNumber()).toString());
					changedDetailsList.add(changedDtlsPojo);
				}
				
				if(Util.isNotEmptyObject(prevTransactionEntryDetails.getReferenceNo()) && Util.isNotEmptyObject(transactionServiceInfo.getReferenceNo())) {
					if(!prevTransactionEntryDetails.getReferenceNo().equals(transactionServiceInfo.getReferenceNo())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getReferenceNo());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getReferenceNo());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setColumnId(MetadataId.REFERENCE_NUMBER.getId());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed reference number")
								.append(prevTransactionEntryDetails.getReferenceNo())
								.append(" to ")
								.append(transactionServiceInfo.getReferenceNo()).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				} else if(Util.isEmptyObject(prevTransactionEntryDetails.getReferenceNo()) && Util.isNotEmptyObject(transactionServiceInfo.getReferenceNo())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setActualValue(prevTransactionEntryDetails.getReferenceNo());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getReferenceNo());
						changedDtlsPojo.setActionType(Status.ADDED.getStatus());
						changedDtlsPojo.setColumnId(MetadataId.REFERENCE_NUMBER.getId());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" added reference number ")
								.append(transactionServiceInfo.getReferenceNo()).toString());
						changedDetailsList.add(changedDtlsPojo);
				}
				
				if(Util.isNotEmptyObject(transactionServiceInfo.getFlatNos()) && Util.isNotEmptyObject(transactionServiceInfo.getActualFlatNos())
					&&	Util.isNotEmptyObject(transactionServiceInfo.getFlatIds()) && Util.isNotEmptyObject(transactionServiceInfo.getActualFlatIds())
						) {
					if(!transactionServiceInfo.getBookingFormId().equals(transactionServiceInfo.getActualBookingFormId())) {
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setActualValue(transactionServiceInfo.getActualBookingFormId().toString());
						changedDtlsPojo.setChangedValue(transactionServiceInfo.getBookingFormId().toString());
						changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
						changedDtlsPojo.setColumnId(MetadataId.BOOKING_FORM_ID.getId());
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" changed Flat ")
								.append(transactionServiceInfo.getActualFlatNos().get(0))
								.append(" to ")
								.append(transactionServiceInfo.getFlatNos().get(0)).toString());
						changedDetailsList.add(changedDtlsPojo);
					}
				}//Flat Change
			}
			
			List<Long> prevSetOffTypeIds = new ArrayList<>();
			List<Long> currentSetOffTypeIds = new ArrayList<>();
			
			if(Util.isNotEmptyObject(response.getFinTransactionEntryDetailsResponseList().get(0).getFinTransactionSetOffResponseList()) && Util.isNotEmptyObject(transactionServiceInfo.getPaymentSetOffDetails())) {
				List<FinTransactionSetOffResponse> previousPaymentSetOffList = response.getFinTransactionEntryDetailsResponseList().get(0).getFinTransactionSetOffResponseList();
				List<EmployeeFinTranPaymentSetOffInfo> currentPaymentSetOffInfos = transactionServiceInfo.getPaymentSetOffDetails();
				
				for (FinTransactionSetOffResponse prevPaymentSetOffInfo : previousPaymentSetOffList) {
					if(!prevSetOffTypeIds.contains(prevPaymentSetOffInfo.getSetOffType())) {
						prevSetOffTypeIds.add(prevPaymentSetOffInfo.getSetOffType());
					}
				}
				
				for (EmployeeFinTranPaymentSetOffInfo currentPaymentSetOffInfo : currentPaymentSetOffInfos) {
					currentSetOffTypeIds.add(getMetaDataId(currentPaymentSetOffInfo.getSetOffTypeName()));
				}
				
				for (int prevIndex = 0; prevIndex < previousPaymentSetOffList.size(); prevIndex++) {
					for (int currIndex = 0; currIndex < currentPaymentSetOffInfos.size(); currIndex++) {
						FinTransactionSetOffResponse prevPaymentSetOffDetails = previousPaymentSetOffList.get(prevIndex);
						EmployeeFinTranPaymentSetOffInfo currentPaymentSetOffInfo = currentPaymentSetOffInfos.get(currIndex);
						//getMetaDataId(currentPaymentSetOffInfo.getSetOffTypeName());
						if (Util.isNotEmptyObject(prevPaymentSetOffDetails.getSetOffType()) && prevPaymentSetOffDetails.getSetOffType().equals(getMetaDataId(currentPaymentSetOffInfo.getSetOffTypeName()))) {
							if(Util.isNotEmptyObject(prevPaymentSetOffDetails.getSetOffAmount()) && !prevPaymentSetOffDetails.getSetOffAmount().equals(currentPaymentSetOffInfo.getAmount())) {
								double prevSetOffAmount = Util.isEmptyObject(prevPaymentSetOffDetails.getSetOffAmount())?0.0:prevPaymentSetOffDetails.getSetOffAmount();
								double currentSetOffAmount = Util.isEmptyObject(currentPaymentSetOffInfo.getAmount())?0.0:currentPaymentSetOffInfo.getAmount();
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setColumnId(MetadataId.PAYMENT_SET_OFF_AMOUNT.getId());
								changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
								changedDtlsPojo.setActualValue(String.valueOf(prevSetOffAmount));
								changedDtlsPojo.setChangedValue(String.valueOf(currentSetOffAmount));
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" changed "+getConvenienceNameFromMetaData(currentPaymentSetOffInfo.getSetOffTypeName())+" ")
										.append(prevSetOffAmount)
										.append(" to ")
										.append(currentSetOffAmount).toString());
								changedDetailsList.add(changedDtlsPojo);
								isPaymentSetOffDetailsChanged = true;
								break;
							}
							if(prevPaymentSetOffDetails.getPaidByName()!=null && currentPaymentSetOffInfo.getPaidByName()!=null && !prevPaymentSetOffDetails.getPaidByName().equalsIgnoreCase(currentPaymentSetOffInfo.getPaidByName())) {
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setColumnId(MetadataId.PAID_BY.getId());
								changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
								changedDtlsPojo.setActualValue(String.valueOf(prevPaymentSetOffDetails.getPaidByName()));
								changedDtlsPojo.setChangedValue(String.valueOf(currentPaymentSetOffInfo.getPaidByName()));
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" changed "+getConvenienceNameFromMetaData(currentPaymentSetOffInfo.getSetOffTypeName())+" Paid By ")
										.append(prevPaymentSetOffDetails.getPaidByName())
										.append(" to ")
										.append(currentPaymentSetOffInfo.getPaidByName()).toString());
								changedDetailsList.add(changedDtlsPojo);
								isPaymentSetOffDetailsChanged = true;
								break;
							}
							
						}//set off type
					}//current data from request
				}//actual data from DBs
				
				for (int currIndex = 0; currIndex < currentPaymentSetOffInfos.size(); currIndex++) {
						EmployeeFinTranPaymentSetOffInfo currentPaymentSetOffInfo = currentPaymentSetOffInfos.get(currIndex);
						//if in previous payment set off ids current set off not exists then it means that payment set off details is added 
						if(!prevSetOffTypeIds.contains(getMetaDataId(currentPaymentSetOffInfo.getSetOffTypeName()))) {
							if(Util.isNotEmptyObject(currentPaymentSetOffInfo.getAmount()) && !currentPaymentSetOffInfo.getAmount().equals(0.0)) {
								double currentSetOffAmount = Util.isEmptyObject(currentPaymentSetOffInfo.getAmount())?0.0:currentPaymentSetOffInfo.getAmount();
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setActionType(Status.ADDED.getStatus());
								changedDtlsPojo.setActualValue(String.valueOf(currentSetOffAmount));
								changedDtlsPojo.setChangedValue(String.valueOf(currentSetOffAmount));
								changedDtlsPojo.setColumnId(MetadataId.PAYMENT_SET_OFF_AMOUNT.getId());
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" added "+getConvenienceNameFromMetaData(currentPaymentSetOffInfo.getSetOffTypeName())+" ")
										.append(String.valueOf(currentSetOffAmount)).toString());
								changedDetailsList.add(changedDtlsPojo);
								isPaymentSetOffDetailsChanged = true;
							}
						}
				}//added payment set off details
				
				//checking removed payment set off details
				for (int prevIndex = 0; prevIndex < previousPaymentSetOffList.size(); prevIndex++) {
					FinTransactionSetOffResponse prevPaymentSetOffDetails = previousPaymentSetOffList.get(prevIndex);
					//if in current set off payment id previous set off payment id is not exists then that record is removed 
					if(!currentSetOffTypeIds.contains(prevPaymentSetOffDetails.getSetOffType())) {
						double prevSetOffAmount = Util.isEmptyObject(prevPaymentSetOffDetails.getSetOffAmount())?0.0:prevPaymentSetOffDetails.getSetOffAmount();
						changedDtlsPojo = new FinTransactionChangedDtlsPojo();
						changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
						changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
						changedDtlsPojo.setColumnId(MetadataId.PAYMENT_SET_OFF_AMOUNT.getId());
						changedDtlsPojo.setActionType(Status.REMOVED.getStatus());
						changedDtlsPojo.setActualValue(String.valueOf(prevSetOffAmount));
						//changedDtlsPojo.setChangedValue(String.valueOf(prevSetOffAmount));
						changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
								.append(" removed "+getConvenienceNameFromMetaData(prevPaymentSetOffDetails.getSetOffTypeName())+" ")
								.append(String.valueOf(prevSetOffAmount)).toString());
						changedDetailsList.add(changedDtlsPojo);
						isPaymentSetOffDetailsChanged = true;
					}
				}
				//checking removed payment set off details
			}//payment set off condition
			
		if (!changedDetailsList.isEmpty()) {
			map.put("isTransactionDetailsChanged", true);
			employeeFinancialServiceDao.saveTransactionChangedDetails(changedDetailsList);
		} else {
			map.put("isTransactionDetailsChanged", false);
		}
		map.put("isPaymentSetOffDetailsChanged", isPaymentSetOffDetailsChanged);

		// String s=null;s.trim();
		return map;
	}

	public static Long getMetaDataId(String type) {
		if(type.equalsIgnoreCase("Principal_Amount")) {
			return MetadataId.FIN_BOOKING_FORM_MILESTONES.getId();
		}else if(type.equalsIgnoreCase("Interest")) {
			return MetadataId.FIN_PENALTY.getId();
		} else {
			return MetadataId.valueOf(type.toUpperCase()).getId();
		}
	}

	public static String getConvenienceNameFromMetaData(String paymentSetOffDetails) {
		if(paymentSetOffDetails.equalsIgnoreCase("Interest")) {
			return "Interest Amount";	
		} else if(paymentSetOffDetails.equalsIgnoreCase("Fin_Penalty")) {
			return "Interest Amount";
		} else if(paymentSetOffDetails.equalsIgnoreCase("FIN_BOOKING_FORM_MILESTONES")) {
			return "Principal Amount";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Refundable_Advance")){
			return "Refundable Advance";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Corpus_Fund")){
			return "Corpus Fund";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Maintenance_Charge")){
			return "Maintenance Charge";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Individual_Flat_Khata_bifurcation_and_other_charges")){
			return "Individual Flat Khata bifurcation and other charges";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Flat_Cancellation")) {
			return "Flat Cancellation";
		} else {
			return MetadataId.valueOf(paymentSetOffDetails.toUpperCase()).getName();
		}
	}
	
	public static String getConvenienceNameFromMetaDataSalesForce(String paymentSetOffDetails, Long transactionTypeId) throws Exception {
		
		if (FinTransactionType.PAYMENT.getId().equals(transactionTypeId)) {
			if (paymentSetOffDetails.equalsIgnoreCase("TDS")) {
				return "TDS";
			} else if (paymentSetOffDetails.equalsIgnoreCase("FIN_BOOKING_FORM_MILESTONES")) {
				return "Amount Refund";
			}
		}
		
		if(paymentSetOffDetails.equalsIgnoreCase("Interest")) {
			return "Interest";	
		} else if(paymentSetOffDetails.equalsIgnoreCase("Fin_Penalty")) {
			return "Interest";	
		} else if(paymentSetOffDetails.equalsIgnoreCase("FIN_BOOKING_FORM_MILESTONES")) {
			return "Principal";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Refundable_Advance")){
			return "Refundable Advance";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Corpus_Fund")){
			return "Corpus Fund";
		} else if(paymentSetOffDetails.equalsIgnoreCase("LEGAL_COST")){
			return "Legal Charges";
		} else if(paymentSetOffDetails.equalsIgnoreCase("MODIFICATION_COST")){
			return "Modification Charges";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Maintenance_Charge")){
			return "Maintenance Charges";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Individual_Flat_Khata_bifurcation_and_other_charges")){
			return "Khata Charges";
		} else if(paymentSetOffDetails.equalsIgnoreCase("Flat_Cancellation")) {
			return "Flat Cancellation";
		} else if(paymentSetOffDetails.equalsIgnoreCase("TDS")) {
			return "TDS";
		}  else {
			return MetadataId.valueOf(paymentSetOffDetails.toUpperCase()).getName();
		}
		
	}

	@Override
	public EmployeeFinancialResponse getCustomerLedger(EmployeeFinancialServiceInfo serviceInfo) {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getCustomerLedger() *****");
		EmployeeFinancialResponse employeeFinancialResponse = new EmployeeFinancialResponse();
		serviceInfo.setActionUrl("View DemandNotes");
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(serviceInfo);
		List<CustomerPropertyDetailsInfo> customerPropertyDetailsInfo = financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoListToCustomerPropertyDetailsInfoList(customerPropertyDetailsPojoList,CustomerPropertyDetailsInfo.class);
		employeeFinancialResponse.setFlatsResponse(customerPropertyDetailsInfo);
		return employeeFinancialResponse;
	}
	
	@Override
	public List<CustomerPropertyDetailsInfo> getCustomerPropertyDetails(EmployeeFinancialServiceInfo serviceInfo) {
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(serviceInfo);
		List<CustomerPropertyDetailsInfo> customerPropertyDetailsInfo = financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoListToCustomerPropertyDetailsInfoList(customerPropertyDetailsPojoList,CustomerPropertyDetailsInfo.class);
		/*if(Util.isEmptyObject(customerPropertyDetailsInfo)) {
			customerPropertyDetailsInfo.add(new CustomerPropertyDetailsInfo());
		}*/
		return customerPropertyDetailsInfo;
	}
	
	@Override
	public EmployeeFinancialResponse getCustomerLedgerDetails(EmployeeFinancialServiceInfo serviceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getCustomerLedgerDetails() *****");
		double creditAmount1 = 0.0;
		double debitAmount1 = 0.0;
		double balanceAmount = 0.0;

		EmployeeFinancialResponse response = new EmployeeFinancialResponse();
		List<FinCustomerLedgerResponse> customerLedgerResponses = new ArrayList<FinCustomerLedgerResponse>();
		List<FinCustomerLedgerInfo> customerLedgerInfos = new ArrayList<FinCustomerLedgerInfo>();

		List<FinCustomerLedgerInfo> debitCustomerLedgerInfos = new ArrayList<FinCustomerLedgerInfo>();
		List<FinCustomerLedgerInfo> creditCustomerLedgerInfos = new ArrayList<FinCustomerLedgerInfo>();

		Set<FinCustomerLedgerInfo> ledgerInfos = new HashSet<FinCustomerLedgerInfo>();
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo;
		RestTemplate restTemplate = new RestTemplate();
		response.setCustomerLedgerResponses(customerLedgerResponses);
		Financial financial = null;
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(serviceInfo);
		if(Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0))) {
			customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
			List<CoApplicantPojo> coApplicantPojoList = employeeFinancialServiceDao.getCoApplicantDetails(customerPropertyDetailsInfo);
			/* setting customer full Name and Coapp full name to customerPropertyDetailsInfo */
			setCustomerAndCoApplicantFullName(coApplicantPojoList, customerPropertyDetailsInfo);		
		}else {
			 customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		}

		Customer customer = new Customer();
		if(customerPropertyDetailsPojoList.size()!=0) {
			customer.setCustomerId(Util.isEmptyObject(customerPropertyDetailsInfo.getCustomerId())?0l:customerPropertyDetailsInfo.getCustomerId());
			customer.setFlatId(Util.isEmptyObject(customerPropertyDetailsInfo.getFlatId())?0l:customerPropertyDetailsInfo.getFlatId());
			customer.setDeviceId(customer.getDeviceId());
			customer.setFlatBookingId(Util.isEmptyObject(customerPropertyDetailsInfo.getFlatBookingId())?0l:customerPropertyDetailsInfo.getFlatBookingId());
			customer.setComments("RequestFromEmployeeService");
			customer.setRequestUrl("RequestFromEmployeeService");
			
			if("8090".equals(serviceInfo.getPortNumber().toString())||"8888".equals(serviceInfo.getPortNumber().toString())||"9999".equals(serviceInfo.getPortNumber().toString())) {
				//EmployeeFinancialResponse resultOfDemandNote = (EmployeeFinancialResponse) restTemplate.postForObject("http://localhost:"+employeeFinancialRequest.getPortNumber()+"/employeeservice/financial/generatedDemandNotePreview.spring", employeeFinancialRequest, EmployeeFinancialResponse.class);
				financial = (Financial) restTemplate.postForObject("http://localhost:"+serviceInfo.getPortNumber()+"/customerservice/financial/financialDtls.spring", customer, Financial.class);
				}
				else if("7777".equals(serviceInfo.getPortNumber().toString())||"443".equals(serviceInfo.getPortNumber().toString())) {
					financial = (Financial) restTemplate.postForObject("https://localhost:"+serviceInfo.getPortNumber()+"/customerservice/financial/financialDtls.spring", customer, Financial.class);
				}
			//financial = (Financial) restTemplate.postForObject("http://localhost:"+serviceInfo.getPortNumber()+"/customerservice/financial/financialDtls.spring", customer, Financial.class);
		}
		
		FinancialProjectMileStoneInfo financialProjectMileStoneInfo = new FinancialProjectMileStoneInfo();
		
		FinTransactionEntryDetailsInfo transactionEntryDetailsInfo = new FinTransactionEntryDetailsInfo();
		
		transactionEntryDetailsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
		
		customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
		customerPropertyDetailsInfo.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
		List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo);
		if(Util.isEmptyObject(listOfBookingAccountSummaryDetails)) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Flat cost details not found."));
		}
		//No Need to load charges Data loading all the Milestone Data
		financialProjectMileStoneInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.PENDING.getStatus(),Status.INPROGRESS.getStatus(),Status.PAID.getStatus() }));
		financialProjectMileStoneInfo.setType(Arrays.asList(new Long[] {MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()}));
		List<FinancialProjectMileStonePojo> previouseFinancialProjectMileStonePojoList = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(financialProjectMileStoneInfo, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
		if(Util.isEmptyObject(previouseFinancialProjectMileStonePojoList)) {
			if(Util.isNotEmptyObject(financial)) {
				response.setTotalFlatCost(Util.isEmptyObject(financial.getTotoalAmount())?"0.00":financial.getTotoalAmount());
				response.setBookingDate(Util.isEmptyObject(customerPropertyDetailsInfo.getBookingDate())?null:customerPropertyDetailsInfo.getBookingDate());
			}
			return response;
		}
		List<FinTransactionEntryDetailsPojo> receiptDetailsList = null;
		List<FinTransactionEntryDetailsPojo> paymentDetailsList = null;
		long serialNumber = 1;
		try {
			//loading all the Milestone receipt Data
			transactionEntryDetailsInfo.setCondition(MetadataId.CUSTOMER_LEDGER.getName());
			receiptDetailsList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfo,customerPropertyDetailsInfo);
			
			//loading all the Milestone payment Data
			transactionEntryDetailsInfo.setCondition("CustomerLedgerPayment");
			paymentDetailsList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfo,customerPropertyDetailsInfo);

		}catch(Exception e ) {
			e.printStackTrace();
			log.error("Error occurred while saving the existing customer once again to the database plz try again once -" + e.toString());
			throw new InSufficeientInputException(Arrays.asList("Error occurred while loading some records from the database plz try again once !"));
		}
		
		//Demand note amount is Debit
		if(previouseFinancialProjectMileStonePojoList!=null)
		for (FinancialProjectMileStonePojo financialProjectMileStonePojo : previouseFinancialProjectMileStonePojoList) {
			String demandNoteTotalAmount =  Util.isEmptyObject(financialProjectMileStonePojo.getDemandNoteTotalAmount())?"0.00":financialProjectMileStonePojo.getDemandNoteTotalAmount().toString();
			//String payAMount = Util.isEmptyObject(financialProjectMileStonePojo.getPayAmount())?"0.00":financialProjectMileStonePojo.getPayAmount().toString();
			FinCustomerLedgerInfo customerLedgerInfo = new FinCustomerLedgerInfo();
			customerLedgerInfo.setDate(financialProjectMileStonePojo.getDemandNoteDate());
			customerLedgerInfo.setCreatedDate(financialProjectMileStonePojo.getDnCreationDate());
			//customerLedgerInfo.setDescription(financialProjectMileStonePojo.getMilestoneName());
			demandNoteTotalAmount = BigDecimal.valueOf(Double.valueOf(demandNoteTotalAmount)).setScale(roundingModeSize, roundingMode).toString();
			customerLedgerInfo.setSerialNumber(serialNumber++);
			//customerLedgerInfo.setId(financialProjectMileStonePojo.getFinBokFomDmdNoteId());
			customerLedgerInfo.setDescription("Demand Note For Milestone");
			customerLedgerInfo.setIsDemandNoteOrTransactionRecord("Demand Note");
			customerLedgerInfo.setReferenceNumber(financialProjectMileStonePojo.getDemandNoteNo());
			customerLedgerInfo.setUrl(financialProjectMileStonePojo.getDocumentLocation());
			customerLedgerInfo.setDebitAmount(demandNoteTotalAmount);
			customerLedgerInfo.setSuffix("Dr");
			customerLedgerInfo.setRecordType("Debit");
			if(Util.isNotEmptyObject(financialProjectMileStonePojo.getDemandNoteNo()) && Util.isNotEmptyObject(financialProjectMileStonePojo.getDocumentLocation())) {
				debitCustomerLedgerInfos.add(customerLedgerInfo);
			}
		}
		
		ledgerInfos = new HashSet<>(debitCustomerLedgerInfos);
		debitCustomerLedgerInfos = new ArrayList<>(ledgerInfos);
		//Collections.sort(debitCustomerLedgerInfos);
		List<Long> receiptExcessAmountLoaded = new ArrayList<>();
		//debitCustomerLedgerInfos.sort(c);
		if(receiptDetailsList!=null)
		for (int index = 0; index < receiptDetailsList.size(); index++) {
			FinTransactionEntryDetailsPojo finTransactionEntryDetailsPojo = receiptDetailsList.get(index);
			/*//String creditAmt = Util.isEmptyObject(finTransactionEntryDetailsPojo.getSetOffAmount())?"0.0":finTransactionEntryDetailsPojo.getSetOffAmount().toString();
			//String actualPaidAmount = Util.isEmptyObject(finTransactionEntryDetailsPojo.getActualPaidAmount())?"0.0":finTransactionEntryDetailsPojo.getActualPaidAmount().toString();
			//creditAmt = actualPaidAmount;*/			
			double excessAmount = 0d;
			//String creditAmt = Util.isEmptyObject(finTransactionEntryDetailsPojo.getTransactionAmount())?"0.0":finTransactionEntryDetailsPojo.getTransactionAmount().toString();
			String creditAmt = Util.isEmptyObject(finTransactionEntryDetailsPojo.getSetOffAmount())?"0.0":finTransactionEntryDetailsPojo.getSetOffAmount().toString();
			//String statementRefundAmount = Util.isEmptyObject(finTransactionEntryDetailsPojo.getStatementRefundAmount())?"0.0":finTransactionEntryDetailsPojo.getStatementRefundAmount().toString();
			//String transactionReceiptNo = Util.isEmptyObject(finTransactionEntryDetailsPojo.getTransactionReceiptNo())?"":finTransactionEntryDetailsPojo.getTransactionReceiptNo();
			FinCustomerLedgerInfo customerLedgerInfo = new FinCustomerLedgerInfo();

			if(!receiptExcessAmountLoaded.contains(finTransactionEntryDetailsPojo.getTransactionSetOffEntryId())) {
				customerPropertyDetailsInfo.setCondition("PaymentRefund");
				customerPropertyDetailsInfo.setTransactionSetOffEntryId(finTransactionEntryDetailsPojo.getTransactionSetOffEntryId());
				List<FinBookingFormExcessAmountPojo> listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo,Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()));
				if(Util.isNotEmptyObject(listOfExcessAmount)) {
					if(Util.isNotEmptyObject(listOfExcessAmount.get(0).getExcessAmount())) {
						excessAmount += listOfExcessAmount.get(0).getExcessAmount();
					}
				}else {
					//System.out.println("Empty "+finTransactionEntryDetailsPojo.getTransactionSetOffEntryId());
				}	
			}
			receiptExcessAmountLoaded.add(finTransactionEntryDetailsPojo.getTransactionSetOffEntryId());
			
			//creditAmt = Double.valueOf(creditAmt)+excessAmount;
			creditAmt = BigDecimal.valueOf(Double.valueOf(creditAmt)+excessAmount).setScale(roundingModeSize, roundingMode).toString();
			customerLedgerInfo.setSerialNumber(serialNumber++);
			customerLedgerInfo.setId(finTransactionEntryDetailsPojo.getTransactionEntryId());
			//customerLedgerInfo.setFinBookingFormAccountsStatementId(finTransactionEntryDetailsPojo.getFinBookingFormAccountsStatementId());
			customerLedgerInfo.setDate(finTransactionEntryDetailsPojo.getTransactionReceiveDate());
			customerLedgerInfo.setCreatedDate(finTransactionEntryDetailsPojo.getTrnCreationDate());
			//customerLedgerInfo.setDescription("Payment on - "+finTransactionEntryDetailsPojo.getMilestoneName());
			customerLedgerInfo.setDescription("Payment on Milestone");
			customerLedgerInfo.setIsDemandNoteOrTransactionRecord("Regular_Transaction");
			customerLedgerInfo.setReferenceNumber(finTransactionEntryDetailsPojo.getTransactionReceiptNo());
			customerLedgerInfo.setCreditAmount(creditAmt);
			customerLedgerInfo.setUrl(finTransactionEntryDetailsPojo.getLocation());
			customerLedgerInfo.setSuffix("Dr");
			customerLedgerInfo.setRecordType("Credit");
			creditCustomerLedgerInfos.add(customerLedgerInfo);
		}
		
		if(paymentDetailsList!=null)
			for (int index = 0; index < paymentDetailsList.size(); index++) {
				FinTransactionEntryDetailsPojo finTransactionEntryDetailsPojo = paymentDetailsList.get(index);
				//String creditAmt = Util.isEmptyObject(finTransactionEntryDetailsPojo.getTotalRefundAmount())?"0.0":finTransactionEntryDetailsPojo.getTotalRefundAmount().toString();
				String creditAmt = Util.isEmptyObject(finTransactionEntryDetailsPojo.getSetOffAmount())?"0.0":finTransactionEntryDetailsPojo.getSetOffAmount().toString();
				//String creditAmt = Util.isEmptyObject(finTransactionEntryDetailsPojo.getTransactionAmount())?"0.0":finTransactionEntryDetailsPojo.getTransactionAmount().toString();
				double excessAmount = 0d;
				
				FinCustomerLedgerInfo customerLedgerInfo = new FinCustomerLedgerInfo();
				creditAmt = BigDecimal.valueOf(Double.valueOf(creditAmt)+excessAmount).setScale(roundingModeSize, roundingMode).toString();
				customerLedgerInfo.setSerialNumber(serialNumber++);
				customerLedgerInfo.setId(finTransactionEntryDetailsPojo.getTransactionEntryId());
				//customerLedgerInfo.setFinBookingFormAccountsStatementId(finTransactionEntryDetailsPojo.getFinBookingFormAccountsStatementId());
				customerLedgerInfo.setDate(finTransactionEntryDetailsPojo.getPaymentDate());
				customerLedgerInfo.setCreatedDate(finTransactionEntryDetailsPojo.getTrnCreationDate());
				//customerLedgerInfo.setDescription("Refund on - "+finTransactionEntryDetailsPojo.getMilestoneName());
				customerLedgerInfo.setDescription("Refund on Milestone");
				customerLedgerInfo.setIsDemandNoteOrTransactionRecord("Refund_Transaction");
				customerLedgerInfo.setReferenceNumber(finTransactionEntryDetailsPojo.getTransactionReceiptNo());
				customerLedgerInfo.setCreditAmount(creditAmt);
				//customerLedgerInfo.setDebitAmount(creditAmt);
				customerLedgerInfo.setUrl("");
				customerLedgerInfo.setSuffix("Dr");
				customerLedgerInfo.setRecordType("Credit");
				creditCustomerLedgerInfos.add(customerLedgerInfo);
			}
		//log.info("Before Sorting Credit: "+creditCustomerLedgerInfos);
	    ledgerInfos = new HashSet<>(creditCustomerLedgerInfos);
	    creditCustomerLedgerInfos = new ArrayList<>(ledgerInfos);
	    //Collections.sort(creditCustomerLedgerInfos);
	    //log.info("After Sorting Credit: "+creditCustomerLedgerInfos);
	    if(!debitCustomerLedgerInfos.isEmpty())  customerLedgerInfos.addAll(debitCustomerLedgerInfos);
	    if(!creditCustomerLedgerInfos.isEmpty()) customerLedgerInfos.addAll(creditCustomerLedgerInfos);
	    
		//Sorting data
		//Collections.sort(customerLedgerInfos);
	    //log.info("Before Sorting : "+customerLedgerInfos);
		Collections.sort(customerLedgerInfos, new Comparator<FinCustomerLedgerInfo>() {
			@Override
			public int compare(FinCustomerLedgerInfo o1, FinCustomerLedgerInfo o2) {

				if (o1 == null || o2 == null) {
					return 0;
				}

				if (o1.getDate() == null) {
					return 0;
				}

				if (o2.getDate() == null) {
					return 1;
				}

				try {
					//log.info("O1 "+o1.getDate()+"  O2 "+(o2.getDate()) +" "+o1.getCreatedDate()+" "+o2.getCreatedDate());
					if (TimeUtil.removeTimePartFromTimeStamp1(o1.getDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(o2.getDate()))) {
						/*if(o1.getReferenceNumber().equals("DN150")){
							System.out.println("EmployeeFinancialServiceImpl.getCustomerLedgerDetails() "+o1.getReferenceNumber()+" "+o2.getReferenceNumber());
						}
						System.out.println("EmployeeFinancialServiceImpl.getCustomerLedgerDetails() "+o1.getReferenceNumber()+" "+o2.getReferenceNumber());*/
						/*if (o1.getCreatedDate()!=null && o2.getCreatedDate() !=null &&  o1.getCreatedDate().compareTo(o2.getCreatedDate())>=1) {
							return 1;
						}*/
						return o1.getCreatedDate().compareTo(o2.getCreatedDate());
					} else if (TimeUtil.removeTimePartFromTimeStamp1(o1.getDate()).after(TimeUtil.removeTimePartFromTimeStamp1(o2.getDate()))) {
						return 1;
					} 
					/*else if (TimeUtil.removeTimePartFromTimeStamp1(this.getDate()).compareTo(TimeUtil.removeTimePartFromTimeStamp1(ledgerInfo.getDate())) >= 1) {
						return 1;
					}*/
					else {
						return -1;
					}
				} catch (Exception e) {
					return 0;
				}
			}	
		});
		//log.info("After Sorting : "+customerLedgerInfos);
		for (int index = 0; index < customerLedgerInfos.size(); index++) {
			FinCustomerLedgerInfo customerLedgerInfo= customerLedgerInfos.get(index);
			//log.info("Current processing record : "+customerLedgerInfo);
			
			if (Util.isNotEmptyObject(customerLedgerInfo.getCreditAmount())) {//customerLedgerInfo.getRecordType().equals("Credit")
				//this is paid amount
				String creditAmt = customerLedgerInfo.getCreditAmount();
				
				//creditAmount1 += Double.valueOf(creditAmt);
				//balanceAmount -= Double.valueOf(creditAmt);
				

				if(customerLedgerInfo.getIsDemandNoteOrTransactionRecord()!=null && customerLedgerInfo.getIsDemandNoteOrTransactionRecord().equals("Refund_Transaction")) {
					customerLedgerInfo.setCreditAmount("-"+currencyUtil.getTheAmountWithCommas(Double.valueOf(creditAmt),roundingModeSize,roundingMode));
					creditAmount1 -= Double.valueOf(creditAmt);
					balanceAmount += Double.valueOf(creditAmt);
				}else {
					customerLedgerInfo.setCreditAmount(currencyUtil.getTheAmountWithCommas(Double.valueOf(creditAmt),roundingModeSize,roundingMode));
					creditAmount1 += Double.valueOf(creditAmt);
					balanceAmount -= Double.valueOf(creditAmt);
				}
				//if balance is less than zero then that amount is excess amount // && (customerLedgerInfos.size()-1)==index
				if (balanceAmount < 0 ) {
					customerLedgerInfo.setSuffix("Cr");
					customerLedgerInfo.setBalanceAmount(currencyUtil.getTheAmountWithCommas(Math.abs(balanceAmount),roundingModeSize,roundingMode)+" "+customerLedgerInfo.getSuffix());
				} else {
					//if balance amount is greater than zero that amount to be pay 
					customerLedgerInfo.setBalanceAmount(currencyUtil.getTheAmountWithCommas(balanceAmount,roundingModeSize,roundingMode)+" "+customerLedgerInfo.getSuffix());
				}
			} else if (Util.isNotEmptyObject(customerLedgerInfo.getDebitAmount())) {//customerLedgerInfo.getRecordType().equals("Debit")
				//this is milestone amount 
				String debitAmt = customerLedgerInfo.getDebitAmount();
				debitAmount1 += Double.valueOf(debitAmt);
				balanceAmount += Double.valueOf(debitAmt);
				//roundOffAmount()
				if (balanceAmount < 0 ) {
					customerLedgerInfo.setSuffix("Cr");
				} 
				customerLedgerInfo.setBalanceAmount(currencyUtil.getTheAmountWithCommas(Math.abs(balanceAmount),roundingModeSize,roundingMode)+" "+customerLedgerInfo.getSuffix());
				customerLedgerInfo.setDebitAmount(currencyUtil.getTheAmountWithCommas(Double.valueOf(debitAmt),roundingModeSize,roundingMode));
			}
		}
		
		for (FinCustomerLedgerInfo customerLedgerInfo : customerLedgerInfos) {
			customerLedgerResponses.add((FinCustomerLedgerResponse) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerLedgerInfo,FinCustomerLedgerResponse.class));
		}
		response.setCustomerLedgerResponses(customerLedgerResponses);
		response.setTotalFlatCost(Util.isEmptyObject(financial.getTotoalAmount())?"0.00":financial.getTotoalAmount());
		response.setBookingDate(Util.isEmptyObject(customerPropertyDetailsInfo.getBookingDate())?null:customerPropertyDetailsInfo.getBookingDate());
		//log.info("***** EmployeeFinancialServiceImpl.getCustomerLedgerDetails() method execution completed *****"+creditAmount1+"\t"+debitAmount1);
		response.setTotalCreditAmount(currencyUtil.getTheAmountWithCommas(creditAmount1,roundingModeSize,roundingMode));
		response.setTotalDebitAmount(currencyUtil.getTheAmountWithCommas(debitAmount1,roundingModeSize,roundingMode));
		response.setTotalBalanceAmount(currencyUtil.getTheAmountWithCommas(balanceAmount,roundingModeSize,roundingMode));
		return response;
	}

	@Override
	public EmployeeFinancialResponse loadRequestedData(EmployeeFinancialServiceInfo serviceInfo) {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.loadRequestedData() *****");
		EmployeeFinancialResponse resp = new EmployeeFinancialResponse();
		if(Util.isNotEmptyObject(serviceInfo.getActionUrl())) {
			if(serviceInfo.getActionUrl().equals(FinEnum.LOAD_INTEREST_DATA.getName())) {
				serviceInfo.setCondition(serviceInfo.getActionUrl());
				List<FinInterestRatesPojo> result = employeeFinancialServiceDao.getTaxOnInterestData(serviceInfo, null);
				resp.setData(result);
				return resp;
			}
		}
		return resp;
	}
	
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialResponse updateInterestRates(EmployeeFinancialServiceInfo serviceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.updateInterestRates() *****");
		//@SuppressWarnings("unused")
		List<Long> siteIds = serviceInfo.getSiteIds();
		String errorMessage = "";
		Timestamp currentDate = new Timestamp(new Date().getTime());
		//serviceInfo.setCondition(EmployeeFinancialEnum.UPDATE_INTEREST_DATA.getName());
		Timestamp holdPrevEndDate = null;
		EmployeeFinancialResponse response  = new EmployeeFinancialResponse();
		if (Util.isNotEmptyObject(serviceInfo.getFinancialGstDetailsInfos())) {
			for (FinancialGstDetailsInfo gstDetailsInfo : serviceInfo.getFinancialGstDetailsInfos()) {
				Timestamp startdate = gstDetailsInfo.getStartDate();
				Timestamp enddate = gstDetailsInfo.getEndDate();
				checkDatesOrder(startdate,enddate);
				//log.info(gstDetailsInfo.getStartDate()+" "+gstDetailsInfo.getEndDate());
				
				if(enddate.after(startdate)) {
					//System.out.println(enddate.after(gstDetailsInfo.getStartDate()));
				}else if (enddate.before(startdate)) {
					throw new EmployeeFinancialServiceException("End date should be greater than Start date, Start Date : "+TimeUtil.timestampToDD_MM_YYYY(startdate)+", End Date : "+TimeUtil.timestampToDD_MM_YYYY(enddate));
				}

				if(holdPrevEndDate!=null && holdPrevEndDate.after(startdate)) {
					//System.out.println("Date is lesser "+startdate+" "+holdPrevEndDate);
					throw new EmployeeFinancialServiceException("Start date should not be lesser than End date, Start Date : "+TimeUtil.timestampToDD_MM_YYYY(startdate)+", End Date : "+TimeUtil.timestampToDD_MM_YYYY(holdPrevEndDate));
				}else if(holdPrevEndDate!=null && startdate.equals(holdPrevEndDate)) {
					//System.out.println("Date is same "+gstDetailsInfo.getStartDate()+" "+gstDetailsInfo.getEndDate());
					throw new EmployeeFinancialServiceException("Start date and end date should not be same, Start Date : "+TimeUtil.timestampToDD_MM_YYYY(startdate)+", End Date : "+TimeUtil.timestampToDD_MM_YYYY(holdPrevEndDate));
				}
				holdPrevEndDate = enddate;
			}
			
			for (FinancialGstDetailsInfo gstDetailsInfo : serviceInfo.getFinancialGstDetailsInfos()) {
				if (Util.isEmptyObject(gstDetailsInfo.getPercentageId())) {
					int count = employeeFinancialServiceDao.isPercentageExists(gstDetailsInfo);
					if (count == 0) {
						employeeFinancialServiceDao.savePercentage(gstDetailsInfo);
					}
				}
			}
			
			for (FinancialGstDetailsInfo gstDetailsInfo : serviceInfo.getFinancialGstDetailsInfos()) {
				if(Util.isEmptyObject(gstDetailsInfo.getEndDate()) || Util.isEmptyObject(gstDetailsInfo.getStartDate())) {
					continue;
				}
				serviceInfo.setCondition(FinEnum.COUNT_DATA.getName());
				String rowStatus = gstDetailsInfo.getRowStatus();
				Timestamp endDate = gstDetailsInfo.getEndDate();
				//Time stamp startDate = gstDetailsInfo.getStartDate();
				FinInterestRatesPojo interestRatesPojo = (FinInterestRatesPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(gstDetailsInfo, FinInterestRatesPojo.class);
				interestRatesPojo.setStatusId(Status.ACTIVE.getStatus());
				interestRatesPojo.setCreatedBy(serviceInfo.getEmpId());
				//check this is get any issue in calculating interest on amount , in demand note
				interestRatesPojo.setStartDate(TimeUtil.startingOfTheDayTimestamp(interestRatesPojo.getStartDate()));
				interestRatesPojo.setEndDate(TimeUtil.endOfTheDayTimestamp(interestRatesPojo.getEndDate()));

				List<FinInterestRatesPojo> result = employeeFinancialServiceDao.getTaxOnInterestData(serviceInfo,gstDetailsInfo);
				if (rowStatus!=null && rowStatus.equalsIgnoreCase(Status.ADDED.getDescription())) {
					for (Long siteId : siteIds) {
						FinInterestRatesPojo finInterestRatesPojo = new FinInterestRatesPojo();
						finInterestRatesPojo.setSiteId(siteId);
						interestRatesPojo.setSiteId(siteId);
						List<String> msg = employeeFinancialServiceDao.validateInterestRatesDates(serviceInfo, gstDetailsInfo, finInterestRatesPojo);
						if (msg.size() != 0) {
							throw new EmployeeFinancialServiceException(msg.get(0));
						}
						// inserting new interest rates records
						employeeFinancialServiceDao.insertInterestDetails(interestRatesPojo);
					}
				}
				if (result.size() == 0) {
					
				} else {
					if (TimeUtil.removeTimePartFromTimeStamp1(endDate).compareTo(TimeUtil.removeTimePartFromTimeStamp1(currentDate)) == -1 && rowStatus!=null && rowStatus.equalsIgnoreCase(Status.MODIFY.getDescription())) {
						//!gstDetailsInfo.getStartDate().equals(gstDetailsInfo.getActualStartDate()) ||
						if(!TimeUtil.removeTimePartFromTimeStamp1(gstDetailsInfo.getStartDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(gstDetailsInfo.getActualStartDate())) 
								|| !TimeUtil.removeTimePartFromTimeStamp1(gstDetailsInfo.getEndDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(gstDetailsInfo.getActualEndDate()))
								) {
							errorMessage = "Date cannot be changed after the time period is completed, Start Date is : "+TimeUtil.timestampToDD_MM_YYYY(gstDetailsInfo.getStartDate()) +", End Date is "+TimeUtil.timestampToDD_MM_YYYY(gstDetailsInfo.getEndDate());
							////log.debug(errorMessage);
							throw new EmployeeFinancialServiceException(errorMessage);	
						} else if(!gstDetailsInfo.getPercentageValue().equals(gstDetailsInfo.getActualPercentageValue()
								)) {
							errorMessage = "Percentage cannot be changed after the time period is completed, Start Date is : "+TimeUtil.timestampToDD_MM_YYYY(gstDetailsInfo.getStartDate()) +", End Date is "+TimeUtil.timestampToDD_MM_YYYY(gstDetailsInfo.getEndDate());
							//log.debug(errorMessage);
							throw new EmployeeFinancialServiceException(errorMessage);
						}
					}
					serviceInfo.setCondition(FinEnum.UPDATE_INTEREST_DATA.getName());
					for (FinInterestRatesPojo finInterestRatesPojo : result) {
						List<String> msg = employeeFinancialServiceDao.validateInterestRatesDates(serviceInfo, gstDetailsInfo, finInterestRatesPojo);
						if (msg.size() != 0) {
							throw new EmployeeFinancialServiceException(msg.get(0));
						}
						interestRatesPojo = (FinInterestRatesPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(gstDetailsInfo, FinInterestRatesPojo.class);
						interestRatesPojo.setStatusId(Status.ACTIVE.getStatus());
						interestRatesPojo.setCreatedBy(serviceInfo.getEmpId());
						// check this is get any issue in calculating interest on amount , in demand note
						interestRatesPojo.setStartDate(TimeUtil.startingOfTheDayTimestamp(interestRatesPojo.getStartDate()));
						interestRatesPojo.setEndDate(TimeUtil.endOfTheDayTimestamp(interestRatesPojo.getEndDate()));
						interestRatesPojo.setSiteId(finInterestRatesPojo.getSiteId());
						//log.info(gstDetailsInfo);
						if (rowStatus != null) {	
							if (rowStatus.equalsIgnoreCase(Status.ADDED.getDescription())) {
								//inserting new interest rates records 
								employeeFinancialServiceDao.insertInterestDetails(interestRatesPojo);
							} else if (rowStatus.equalsIgnoreCase(Status.MODIFY.getDescription())) {
								//in activating records and again inserting new interest rates records
								//interestRatesPojo.setActiveStatusId(Status.ACTIVE.getStatus());
								if(!TimeUtil.removeTimePartFromTimeStamp1(gstDetailsInfo.getStartDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(gstDetailsInfo.getActualStartDate())) 
										|| !TimeUtil.removeTimePartFromTimeStamp1(gstDetailsInfo.getEndDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(gstDetailsInfo.getActualEndDate()))
										|| !gstDetailsInfo.getPercentageValue().equals(gstDetailsInfo.getActualPercentageValue())) {
									employeeFinancialServiceDao.inActiveInterestRatesDetails(serviceInfo, gstDetailsInfo,finInterestRatesPojo);
									employeeFinancialServiceDao.insertInterestDetails(interestRatesPojo);
								}
							} else if(rowStatus.equalsIgnoreCase(Status.REMOVED.getDescription())){
								//only in activating record
								employeeFinancialServiceDao.inActiveInterestRatesDetails(serviceInfo, gstDetailsInfo,finInterestRatesPojo);
							}
						}
					}
				}
			}
		}
		return response;
	}
	
	private void checkDatesOrder(Timestamp startdate, Timestamp enddate) {
		
	}

	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialTransactionResponse doOnlinePaymentAnonymousEntry(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws InSufficeientInputException, EmployeeFinancialServiceException {
		log.info(" ***** Control Inside EmployeeFinancialServiceImpl.doOnlinePaymentAnonymousEntry() ***** ");
		EmployeeFinancialTransactionResponse transactionResponse = new EmployeeFinancialTransactionResponse();
		List<String> errorMsgs = null;
		Long anonymousEntryId = 0l;
		if (Util.isNotEmptyObject(transactionServiceInfo.getReferenceNo())) {
			transactionServiceInfo.setReferenceNo(transactionServiceInfo.getReferenceNo().trim());
			Pattern pattern = Pattern.compile("[^a-zA-Z0-9]");
			Matcher matcher = pattern.matcher(transactionServiceInfo.getReferenceNo());
			boolean isStringContainsSpecialCharacter = matcher.find();
			if (isStringContainsSpecialCharacter) {
				throw new EmployeeFinancialServiceException("Found special characters in refrence number. Please change the refrence number : "+transactionServiceInfo.getReferenceNo());
			}
		}
		transactionServiceInfo.setStatusId(Status.ACTIVE.getStatus());
		boolean flag = employeeFinancialServiceDao.isReferenceNoIsExist(transactionServiceInfo);
		if (flag) {
			throw new EmployeeFinancialServiceException("Found duplicate refrence number which is already exists in records. Please change the refrence number : "+transactionServiceInfo.getReferenceNo());
		}
		if(transactionServiceInfo.isThisUplaodedData()) {
			transactionServiceInfo.setIsRecordUploaded(Status.YES.getStatus());	
		}
		
		try {
			anonymousEntryId = employeeFinancialServiceDao.savePaymentAnonymousEntry((FinAnonymousEntryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, FinAnonymousEntryPojo.class));
			transactionServiceInfo.setAnonymousEntryId(anonymousEntryId);
			
			if(Util.isNotEmptyObject(transactionServiceInfo.getComments())) {
				for (Map<String, String> comment : transactionServiceInfo.getComments()) {
					employeeFinancialServiceDao.saveAnonymousEntryComments((FinAnnyEntryCommentsPojo)financialMapper.copyPropertiesFromFinancialTransactionServiceInfoBeanToTransactionCommentsPojoBean(transactionServiceInfo,comment,FinAnnyEntryCommentsPojo.class));	
				}
			}
	
			transactionServiceInfo.setTransactionActionType(Status.CREATED.getStatus());
			employeeFinancialServiceDao.saveAnonymousApproveStatistics((FinAnnyApproveStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinAnnyApproveStatPojo.class));

			if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos())) {
				transactionServiceInfo = storeTransationUploadedImages(transactionServiceInfo,"AnonymousEntry",transactionServiceInfo.getAnonymousEntryId());
 
				for (FileInfo fileInfo : transactionServiceInfo.getFileInfos()) {
					//System.out.println(fileInfo);
					fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()==null?"0":transactionServiceInfo.getEmployeeId()));
					FinAnnyEntryDocPojo pojo = (FinAnnyEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(fileInfo, FinAnnyEntryDocPojo.class);
					pojo.setFinAnmsEntryId(anonymousEntryId);
					pojo.setStatusId(Status.ACTIVE.getStatus());
					employeeFinancialServiceDao.saveAnonymousEntryDocuments(pojo);
				}
			}
		} catch (Exception ex) {
			ex.printStackTrace();
			errorMsgs = new ArrayList<String>();
			errorMsgs.add("Error occurred while saving some records to the database plz try again once !");
			log.error("Error occurred while saving the existing customer once again to the database plz try again once -" + ex.toString());
			throw new InSufficeientInputException(errorMsgs);
		}
		return transactionResponse;
	}
	
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialTransactionResponse updateOnlinePaymentAnonymousEntry(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.updateOnlinePaymentAnonymousEntry() *****");
		EmployeeFinancialTransactionResponse resp = new EmployeeFinancialTransactionResponse();
		if(transactionServiceInfo.getButtonType()!=null && transactionServiceInfo.getButtonType().equals("Reject")) {
			FinAnonymousEntryPojo anonymousEntryPojo = new FinAnonymousEntryPojo();
			anonymousEntryPojo.setAnonymousEntryId(transactionServiceInfo.getAnonymousEntryId());
			anonymousEntryPojo.setStatusId(Status.INACTIVE.getStatus());
			anonymousEntryPojo.setActiveStatusId(Status.MODIFY.getStatus());
			employeeFinancialServiceDao.updateAnonymousEntryStatus(anonymousEntryPojo);
			return resp;
		}
		
		long  anonymousEntryId = 0l;
		boolean flag = employeeFinancialServiceDao.isReferenceNoIsExistById(transactionServiceInfo);
		if (flag) {
			throw new EmployeeFinancialServiceException("Found duplicate refrence number which is already exists in records. Please change the refrence number : "+transactionServiceInfo.getReferenceNo());
		}
		
		FinAnonymousEntryPojo anonymousEntryPojo = (FinAnonymousEntryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, FinAnonymousEntryPojo.class);
		anonymousEntryId = anonymousEntryPojo.getAnonymousEntryId();
		anonymousEntryPojo.setStatusId(Status.ACTIVE.getStatus());
		anonymousEntryPojo.setActiveStatusId(Status.MODIFY.getStatus());
		employeeFinancialServiceDao.updateAnonymousEntryDetails(anonymousEntryPojo);
		
		getAnonymousEntryChangedDetails(transactionServiceInfo);
		
		if(Util.isNotEmptyObject(transactionServiceInfo.getComments())) {
			for (Map<String, String> comment : transactionServiceInfo.getComments()) {
				employeeFinancialServiceDao.saveAnonymousEntryComments((FinAnnyEntryCommentsPojo)financialMapper.copyPropertiesFromFinancialTransactionServiceInfoBeanToTransactionCommentsPojoBean(transactionServiceInfo,comment,FinAnnyEntryCommentsPojo.class));	
			}
		}

		
		transactionServiceInfo.setTransactionActionType(Status.TRANSACTION_EDITED.getStatus());
		employeeFinancialServiceDao.saveAnonymousApproveStatistics((FinAnnyApproveStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinAnnyApproveStatPojo.class));
		
		if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos())) {
			
			List<FileInfo> listOfInfo = transactionServiceInfo.getFileInfos();
			for (Iterator<FileInfo> iterator = listOfInfo.iterator(); iterator.hasNext();) {
				FileInfo fileInfo = iterator.next();
				if(Util.isNotEmptyObject(fileInfo) && Util.isEmptyObject(fileInfo.getBase64()) && Util.isNotEmptyObject(fileInfo.getUrl())) {
					iterator.remove();
				}
			}
			
			transactionServiceInfo = storeTransationUploadedImages(transactionServiceInfo,"AnonymousEntry",transactionServiceInfo.getAnonymousEntryId());

			for (FileInfo fileInfo : transactionServiceInfo.getFileInfos()) {
				fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()==null?"0":transactionServiceInfo.getEmployeeId()));
				FinAnnyEntryDocPojo pojo = (FinAnnyEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(fileInfo, FinAnnyEntryDocPojo.class);
				pojo.setFinAnmsEntryId(anonymousEntryId);
				pojo.setStatusId(Status.ACTIVE.getStatus());
				employeeFinancialServiceDao.saveAnonymousEntryDocuments(pojo);
			}
		}
		
		if(Util.isNotEmptyObject(transactionServiceInfo.getDeleteFileInfos())) {
			for (FileInfo fileInfo : transactionServiceInfo.getDeleteFileInfos()) {
				if (fileInfo.getFilePath()!=null && fileInfo.getId()!=null) {
					int result = employeeFinancialServiceDao.deleteAnonymousEntryDocuments(fileInfo);
					System.out.println(result);
					try {
						String filePathToDelete = fileInfo.getFilePath();
						File file = new File(filePathToDelete);
						file.delete();	
					} catch (Exception e) {

					}
				}
			}
			
		}
		
		return resp;
	}
	
	private void getAnonymousEntryChangedDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getAnonymousEntryChangedDetails() *****");
		EmployeeFinancialTransactionServiceInfo actualTransactionRequest = transactionServiceInfo.getActualTransactionRequest();
		SimpleDateFormat dateFormat = new SimpleDateFormat("dd-MM-yyyy");
		List<FinTransactionChangedDtlsPojo> changedDetailsList = new ArrayList<>();
		FinTransactionChangedDtlsPojo changedDtlsPojo = new FinTransactionChangedDtlsPojo();
		//Long transactionApproveStatId = null;
		long anonymousEntryId = transactionServiceInfo.getAnonymousEntryId();
		if(Util.isNotEmptyObject(actualTransactionRequest.getTransactionReceiveDate()) && Util.isNotEmptyObject(transactionServiceInfo.getTransactionReceiveDate())) {
							if(!TimeUtil.removeTimePartFromTimeStamp1(actualTransactionRequest.getTransactionReceiveDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getTransactionReceiveDate()))) {
								String previousTransactionReceiveDate = dateFormat.format(actualTransactionRequest.getTransactionReceiveDate());
								String currentTransactionReceiveDate = dateFormat.format(transactionServiceInfo.getTransactionReceiveDate());
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								//changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setAnonymousEntryId(anonymousEntryId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setColumnId(MetadataId.RECEIVED_DATE.getId());
								changedDtlsPojo.setActualValue(previousTransactionReceiveDate);
								changedDtlsPojo.setChangedValue(currentTransactionReceiveDate);
								changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" changed receive date ")
										.append(previousTransactionReceiveDate)
										.append(" to ")
										.append(currentTransactionReceiveDate).toString());
								changedDetailsList.add(changedDtlsPojo);
							}
						}//receive date
						
						if(Util.isNotEmptyObject(actualTransactionRequest.getReferenceNo()) && Util.isNotEmptyObject(transactionServiceInfo.getReferenceNo())) {
							if(!actualTransactionRequest.getReferenceNo().equals(transactionServiceInfo.getReferenceNo())) {
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								//changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setAnonymousEntryId(anonymousEntryId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setColumnId(MetadataId.REFERENCE_NUMBER.getId());
								changedDtlsPojo.setActualValue(actualTransactionRequest.getReferenceNo().toString());
								changedDtlsPojo.setChangedValue(transactionServiceInfo.getReferenceNo().toString());
								changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" changed reference number ")
										.append(actualTransactionRequest.getReferenceNo())
										.append(" to ")
										.append(transactionServiceInfo.getReferenceNo()).toString());
								changedDetailsList.add(changedDtlsPojo);
							}
						}//cheque number
						
						if(Util.isNotEmptyObject(actualTransactionRequest.getReceivedAmount()) && Util.isNotEmptyObject(transactionServiceInfo.getReceivedAmount())) {
							if(!actualTransactionRequest.getReceivedAmount().equals(transactionServiceInfo.getReceivedAmount())) {
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								//changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setAnonymousEntryId(anonymousEntryId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setColumnId(MetadataId.AMOUNT.getId());
								changedDtlsPojo.setActualValue(actualTransactionRequest.getReceivedAmount().toString());
								changedDtlsPojo.setChangedValue(transactionServiceInfo.getReceivedAmount().toString());
								changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" changed transaction amount ")
										.append(actualTransactionRequest.getReceivedAmount())
										.append(" to ")
										.append(transactionServiceInfo.getReceivedAmount()).toString());
								changedDetailsList.add(changedDtlsPojo);
							}
						}//cheque amount
						
						if(Util.isNotEmptyObject(actualTransactionRequest.getTransactionModeName()) && Util.isNotEmptyObject(transactionServiceInfo.getTransactionModeName())) {
							if(!actualTransactionRequest.getTransactionModeName().equals(transactionServiceInfo.getTransactionModeName())) {
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								//changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setAnonymousEntryId(anonymousEntryId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setColumnId(MetadataId.TRANSACTION_MODE.getId());
								changedDtlsPojo.setActualValue(actualTransactionRequest.getTransactionModeName().toString());
								changedDtlsPojo.setChangedValue(transactionServiceInfo.getTransactionModeName().toString());
								changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" changed online transaction mode ")
										.append(actualTransactionRequest.getTransactionModeName())
										.append(" to ")
										.append(transactionServiceInfo.getTransactionModeName()).toString());
								changedDetailsList.add(changedDtlsPojo);
							}
						}//cheque amount
						
						
						 if(Util.isNotEmptyObject(actualTransactionRequest.getBankName()) && Util.isNotEmptyObject(transactionServiceInfo.getBankName())) {
							if(!actualTransactionRequest.getBankName().equals(transactionServiceInfo.getBankName())) {
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								//changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setAnonymousEntryId(anonymousEntryId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setActualValue(actualTransactionRequest.getBankName());
								changedDtlsPojo.setChangedValue(transactionServiceInfo.getBankName());
								changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
								changedDtlsPojo.setColumnId(MetadataId.BANK_NAME.getId());
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" changed bank ")
										.append(actualTransactionRequest.getBankName())
										.append(" to ")
										.append(transactionServiceInfo.getBankName()).toString());
								changedDetailsList.add(changedDtlsPojo);
							}//bank name
						} else if(Util.isNotEmptyObject(actualTransactionRequest.getBankName()) && Util.isEmptyObject(transactionServiceInfo.getBankName())) {
							changedDtlsPojo = new FinTransactionChangedDtlsPojo();
							//changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
							changedDtlsPojo.setAnonymousEntryId(anonymousEntryId);
							changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
							changedDtlsPojo.setActualValue(actualTransactionRequest.getBankName());
							changedDtlsPojo.setChangedValue(transactionServiceInfo.getBankName());
							changedDtlsPojo.setActionType(Status.REMOVED.getStatus());
							changedDtlsPojo.setColumnId(MetadataId.BANK_NAME.getId());
							changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
									.append(" removed bank from transaction ")
									.append(actualTransactionRequest.getBankName()).toString());
							changedDetailsList.add(changedDtlsPojo);
						
						} else if (Util.isEmptyObject(actualTransactionRequest.getBankName()) && Util.isNotEmptyObject(transactionServiceInfo.getBankName())) {
							changedDtlsPojo = new FinTransactionChangedDtlsPojo();
							//changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
							changedDtlsPojo.setAnonymousEntryId(anonymousEntryId);
							changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
							changedDtlsPojo.setActualValue(actualTransactionRequest.getBankName());
							changedDtlsPojo.setChangedValue(transactionServiceInfo.getBankName());
							changedDtlsPojo.setActionType(Status.ADDED.getStatus());
							changedDtlsPojo.setColumnId(MetadataId.BANK_NAME.getId());
							changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
									.append(" Added bank for transaction ")
									.append(transactionServiceInfo.getBankName()).toString());
							changedDetailsList.add(changedDtlsPojo);
						}

						if(Util.isNotEmptyObject(actualTransactionRequest.getSiteBankAccountNumber()) && 	Util.isNotEmptyObject(transactionServiceInfo.getSiteBankAccountNumber())) {
							if(!actualTransactionRequest.getSiteBankAccountNumber().equals(transactionServiceInfo.getSiteBankAccountNumber())) {
								changedDtlsPojo = new FinTransactionChangedDtlsPojo();
								//changedDtlsPojo.setTransactionApproveStatId(transactionApproveStatId);
								changedDtlsPojo.setAnonymousEntryId(anonymousEntryId);
								changedDtlsPojo.setEmpId(transactionServiceInfo.getEmployeeId());
								changedDtlsPojo.setActualValue(actualTransactionRequest.getSiteBankAccountNumber().toString());
								changedDtlsPojo.setChangedValue(transactionServiceInfo.getSiteBankAccountNumber().toString());
								changedDtlsPojo.setActionType(Status.CHANGED.getStatus());
								changedDtlsPojo.setColumnId(MetadataId.FIN_SITE_PROJ_ACC_MAP_ID.getId());
								changedDtlsPojo.setRemarks(new StringBuilder("")//transactionServiceInfo.getEmployeeName()
										.append(" changed site bank account number")
										.append(actualTransactionRequest.getSiteBankAccountNumber())
										.append(" to ")
										.append(transactionServiceInfo.getSiteBankAccountNumber()).toString());
								//changedDetailsList.add(changedDtlsPojo);
							}
						}//site bank account number
						
		if(Util.isNotEmptyObject(changedDetailsList)) {
			employeeFinancialServiceDao.saveTransactionChangedDetails(changedDetailsList);	
		}
	}

	//@Override
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	public FileInfo actualdoModificationChargesEntry(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws InSufficeientInputException {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.actualdoModificationChargesEntry() *****");
		try {
			EmployeeFinancialTransactionResponse transactionResponse = new EmployeeFinancialTransactionResponse();
			List<FinBookingFormModiCostDtlsPojo> modificationChargesPojos = new ArrayList<FinBookingFormModiCostDtlsPojo>();
			List<EmployeeFinBokFrmModiCostTaxInfo> modificationTaxPojos = new ArrayList<EmployeeFinBokFrmModiCostTaxInfo>();
			FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
			transactionServiceInfo.setStatusId(Status.ACTIVE.getStatus());
			if (Util.isNotEmptyObject(transactionServiceInfo.getSiteIds())) {
				finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
			} else if (Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
				finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
			}
			
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo;
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0))) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
			}else {
				 throw new EmployeeFinancialServiceException("Customer details not found, Failed to generate modification invoice.");
			}
			
			//List<FinPenaltyTaxPojo> taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,MetadataId.MODIFICATION_COST.getId());
			Long finBookingFormModiCostId = 0l;//,finBookingFormModiCostTaxId ;
			double modificationChargeWithGst = 0d;
			EmployeeFinModiCostInfo finModiCostinfo = (EmployeeFinModiCostInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, EmployeeFinModiCostInfo.class);
			
			/*
			if(Util.isNotEmptyObject(taxDetailsList)) {
				for (FinPenaltyTaxPojo finModificationChargesPojo : taxDetailsList) {
					double modiChargeWithGst = (transactionServiceInfo.getTransactionAmount() / 100) * finModificationChargesPojo.getPercentageValue();
					EmployeeFinBokFrmModiCostTaxInfo info = new EmployeeFinBokFrmModiCostTaxInfo();
					modificationChargeWithGst +=modiChargeWithGst;
					info.setAmount(modiChargeWithGst);
					info.setFinTaxMappingId(finModificationChargesPojo.getFinTaxMappingId());
					modificationTaxPojos.add(info);
					transactionResponse.setPercentageValue(finModificationChargesPojo.getPercentageValue());
				}
			} else {

			}*/
			
			double modiChargeWithGst = (transactionServiceInfo.getTransactionAmount() / 100) * transactionServiceInfo.getPercentageValue();
			EmployeeFinBokFrmModiCostTaxInfo info = new EmployeeFinBokFrmModiCostTaxInfo();
			modificationChargeWithGst +=modiChargeWithGst;
			info.setAmount(modiChargeWithGst);
			//info.setFinTaxMappingId(finModificationChargesPojo.getFinTaxMappingId());
			info.setPercentageId(transactionServiceInfo.getPercentageId());
			modificationTaxPojos.add(info);
			transactionResponse.setPercentageValue(transactionServiceInfo.getPercentageValue());
			
			
				finModiCostinfo.setTaxAmount(modificationChargeWithGst);
				finModiCostinfo.setTotalAmount(transactionServiceInfo.getTransactionAmount()+modificationChargeWithGst);
				FinBookingFormModiCostPojo bookingFormModiCostPojo = (FinBookingFormModiCostPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finModiCostinfo, FinBookingFormModiCostPojo.class);
				finBookingFormModiCostId = employeeFinancialServiceDao.saveBookingFormModificationCost(bookingFormModiCostPojo);
				bookingFormModiCostPojo.setFinBookingFormModiCostId(finBookingFormModiCostId);
				CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo2.setType(MetadataId.MODIFICATION_COST.getId());
				customerPropertyDetailsInfo2.setFlatBookingId(transactionServiceInfo.getBookingFormId());
				customerPropertyDetailsInfo2.setCondition(MetadataId.MODIFICATION_COST.getName());
				List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);
				FinBookingFormAccountSummaryPojo accSummaryPojo = (FinBookingFormAccountSummaryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormModiCostPojo,FinBookingFormAccountSummaryPojo.class);
				accSummaryPojo.setType(MetadataId.MODIFICATION_COST.getId());
				accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
				/* inserting into Fin_Booking_Form_Accounts Table */
				FinBookingFormAccountsPojo finBookingFormAccountsPojo = financialMapper.copyPropertiesToFinBookingFormAccountsPojo(null,bookingFormModiCostPojo,FinBookingFormAccountsPojo.class,"modificationCost");
				Long finBookingFormAccountsId = employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
				finBookingFormAccountsPojo.setFinBookingFormAccountsId(finBookingFormAccountsId);
				/* geting access amount and adjusted to that amount in pay Amount */
				List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;//employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2,Arrays.asList(MetadataId.MODIFICATION_COST.getId()));
				if(Util.isNotEmptyObject(listOfExcessAmount)) {
					finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
					finProjDemandNoteInfo.setModifiedBy(transactionServiceInfo.getEmployeeId());
					finProjDemandNoteInfo.setPayAmount(bookingFormModiCostPojo.getTotalAmount());
					processExcessAMount(listOfExcessAmount,new FinBookingFormAccountsInfo(),finProjDemandNoteInfo,customerPropertyDetailsInfo2,finBookingFormAccountsPojo, MetadataId.MODIFICATION_COST.getName(),true);					
				}

			if(!listOfBookingAccountSummaryDetails.isEmpty()) {
					employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
			} else {
					employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
			}
				
			for (EmployeeFinBokFrmModiCostTaxInfo info1 : modificationTaxPojos) {
					info1.setFinBookingFormModiCostId(finBookingFormModiCostId);
					info1.setCreatedBy(transactionServiceInfo.getCreatedBy());
					employeeFinancialServiceDao.saveBookingFormModiCostTax((FinBookingFormModiCostTaxPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(info1, FinBookingFormModiCostTaxPojo.class));	
			}
				
			for (EmployeeFinModiCostInfo finModificationChargesinfo : transactionServiceInfo.getModiCostDtlsInfos()) {
				finModificationChargesinfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
				finModificationChargesinfo.setCreatedBy(transactionServiceInfo.getCreatedBy());
				FinBookingFormModiCostDtlsPojo modificationChargesPojo = (FinBookingFormModiCostDtlsPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finModificationChargesinfo, FinBookingFormModiCostDtlsPojo.class);
				//modificationChargesPojo.setTaxAmount(modificationChargeWithGst);
				//modificationChargesPojo.setTotalAmount(finModificationChargesinfo.getModificationAmount()+modificationChargeWithGst);
				modificationChargesPojo.setFinBookingFormModiCostId(finBookingFormModiCostId);
				modificationChargesPojos.add(modificationChargesPojo);
				employeeFinancialServiceDao.saveBookingFormModificationCostDetails(modificationChargesPojo);
			}
			/* getting All Responses form infos and Pojos */
			List<FinBookingFormModiCostDtlsResponse> finBookingFormModiCostDtlsResponseList = financialMapper.employeeFinModiCostInfoListToFinBookingFormModiCostDtlsPojoList(transactionServiceInfo.getModiCostDtlsInfos());
			FinBookingFormModiCostResponse finBookingFormModiCostResponse = (FinBookingFormModiCostResponse) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormModiCostPojo, FinBookingFormModiCostResponse.class);
			FinBookingFormAccountsResponse finBookingFormAccountsResponse = (FinBookingFormAccountsResponse) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finBookingFormAccountsPojo, FinBookingFormAccountsResponse.class);
			
			/* Getting Customer and CoApplicant Full Names and Other Details*/
			getModificationInvoiceNumber(finBookingFormAccountsResponse);
			/* getting Office_Details */
			employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
			employeeFinancialServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
			employeeFinancialServiceInfo.setCondition("MODIFICATION_COST");
			loadCustomerDetails(transactionResponse, employeeFinancialServiceInfo, customerPropertyDetailsInfo);
			employeeFinancialServiceInfo.setCondition("");
			if(Util.isEmptyObject(transactionResponse.getFinProjectAccountResponseList().get(0).getSiteBankAccountNumber())) {
				throw new EmployeeFinancialServiceException("Please add Account number for Modification Invoice, Account number not found.");
			}
			/*List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
			List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);*/
			/* setting all required Responses to response Obejct */
			//transactionResponse.setFlatsResponse(new ArrayList<CustomerPropertyDetailsInfo>(Arrays.asList(customerPropertyDetailsInfo)));
			transactionResponse.setFinBookingFormAccountsResponse(finBookingFormAccountsResponse);
			finBookingFormModiCostResponse.setFinBookingFormModiCostDtlsList(finBookingFormModiCostDtlsResponseList);
			transactionResponse.setFinBookingFormModiCostResponse(finBookingFormModiCostResponse);
			setFlatNoAndMileStoneName(transactionResponse, new FinancialProjectMileStoneInfo(), customerPropertyDetailsInfo, MetadataId.MODIFICATION_COST.getName(), null);
			transactionResponse.setEmployeeId(transactionServiceInfo.getEmployeeId());
			//transactionResponse.setOfficeDetailsList(officeDetailsResponseList);
			FileInfo fileInfo = employeeFinancialHelper.modificationChargesInvoiceGeneratorHelper(transactionResponse,transactionServiceInfo);
			/* sending mail to customers */
			// MetadataId.MODIFICATION_COST.getName()
			//@in use employeeFinancialHelper.sendFinancialMailToCustomers123(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(transactionResponse)), new ArrayList<FileInfo>(Arrays.asList(fileInfo)), MetadataId.MODIFICATION_COST.getName());
			/* preparing invoice document location pojo and inserting into table */
			List<InvoiceDocumentLocationPojo> invoiceDocumentLocationPojoList = getInvoiceDocumentLocationPojoList(new ArrayList<FileInfo>(Arrays.asList(fileInfo)), new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(transactionResponse)), MetadataId.MODIFICATION_COST);
			employeeFinancialServiceDao.saveInvoiceDocumentLocationForCharges(invoiceDocumentLocationPojoList);
			///String s = null;s.trim();
			return fileInfo;
		} catch (Exception ex) {
			ex.printStackTrace();
			List<String> errorMsgs = new ArrayList<String>();
			if(ex.getMessage()!=null && ex.getMessage().contains("Customer details not found")) {
				errorMsgs.add(ex.getMessage());
			}else if(ex.getMessage()!=null && ex.getMessage().contains("Please add Account number")) {
				errorMsgs.add(ex.getMessage());
			}else {
				errorMsgs.add("Error occurred while saving records to the database plz try again once !");
			}
			log.error("Error occurred while saving to the database plz try again once -" + ex.toString());
			throw new InSufficeientInputException(errorMsgs);
		}
	}

	@Override
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	public FileInfo doModificationChargesEntry(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws  Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.doModificationChargesEntry() *****");
		Long finBookingFormModiCostId = 0l;
		double modificationChargeWithGst = 0d;
		//boolean isThisIsFinalLevel = false;
		Long nextApprLevelId = 0l;
		double totalAmountBeforeTax = 0d;
		double totalAmountAfterTax = 0d;
		
		try {
			nextApprLevelId = employeeFinancialServiceDao.getApprovalNextLevelId(transactionServiceInfo,Status.CREATED);
		} catch (Exception e) {
			throw new EmployeeFinancialServiceException("No mapping found for this transaction, Please contact support team.");
		}
		try {
			
			EmployeeFinancialTransactionResponse transactionResponse = new EmployeeFinancialTransactionResponse();
			List<FinBookingFormModiCostDtlsPojo> modificationChargesPojos = new ArrayList<FinBookingFormModiCostDtlsPojo>();
			List<EmployeeFinBokFrmModiCostTaxInfo> modificationTaxPojos = new ArrayList<EmployeeFinBokFrmModiCostTaxInfo>();
			
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			transactionServiceInfo.setFinsetOffAppLevelId(nextApprLevelId);
			transactionServiceInfo.setStatusId(Status.ACTIVE.getStatus());
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo;
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0))) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
				transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);				
			}else {
				 throw new EmployeeFinancialServiceException("Customer details not found, Failed to generate modification invoice.");
			}
			if(nextApprLevelId == null) {
				//isThisIsFinalLevel = true;
			}
			totalAmountAfterTax = transactionServiceInfo.getTransactionAmount();
			double gstAmount = ((transactionServiceInfo.getPercentageValue()/(transactionServiceInfo.getPercentageValue()+100))*(transactionServiceInfo.getTransactionAmount()));
			totalAmountBeforeTax = roundOffAmount(totalAmountAfterTax-gstAmount);
			transactionServiceInfo.setTransactionAmount(totalAmountBeforeTax);
			
			EmployeeFinModiCostInfo finModiCostinfo = (EmployeeFinModiCostInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, EmployeeFinModiCostInfo.class);
			
			//double modiChargeWithGst = (transactionServiceInfo.getTransactionAmount() / 100) * transactionServiceInfo.getPercentageValue();
			modificationChargeWithGst += gstAmount;

			EmployeeFinBokFrmModiCostTaxInfo info = new EmployeeFinBokFrmModiCostTaxInfo();
			info.setAmount(gstAmount);
			info.setPercentageId(transactionServiceInfo.getPercentageId());
			modificationTaxPojos.add(info);

			transactionResponse.setPercentageValue(transactionServiceInfo.getPercentageValue());

			finModiCostinfo.setModifiacationStatusId(Status.PENDING.getStatus());
			finModiCostinfo.setFinsetOffAppLevelId(nextApprLevelId);
			finModiCostinfo.setTaxAmount(modificationChargeWithGst);
			finModiCostinfo.setTotalAmount(transactionServiceInfo.getTransactionAmount() + modificationChargeWithGst);

			FinBookingFormModiCostPojo bookingFormModiCostPojo = (FinBookingFormModiCostPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finModiCostinfo, FinBookingFormModiCostPojo.class);
			finBookingFormModiCostId = employeeFinancialServiceDao.saveBookingFormModificationCost(bookingFormModiCostPojo);
			transactionServiceInfo.setFinBookingFormModiCostId(finBookingFormModiCostId);
			
			ModicationInvoiceAppRej modicationInvoiceAppRej = financialMapper.constructModificationInvoiceApprRejectDetailsPojo(transactionServiceInfo,Status.CREATED);
			employeeFinancialServiceDao.saveModifiactionInvocieAppRej(modicationInvoiceAppRej);
			bookingFormModiCostPojo.setFinBookingFormModiCostId(finBookingFormModiCostId);


			for (EmployeeFinBokFrmModiCostTaxInfo info1 : modificationTaxPojos) {
				info1.setFinBookingFormModiCostId(finBookingFormModiCostId);
				info1.setCreatedBy(transactionServiceInfo.getCreatedBy());
				employeeFinancialServiceDao.saveBookingFormModiCostTax((FinBookingFormModiCostTaxPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(info1, FinBookingFormModiCostTaxPojo.class));
			}
				
			for (EmployeeFinModiCostInfo finModificationChargesinfo : transactionServiceInfo.getModiCostDtlsInfos()) {
				finModificationChargesinfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
				finModificationChargesinfo.setCreatedBy(transactionServiceInfo.getCreatedBy());
				FinBookingFormModiCostDtlsPojo modificationChargesPojo = (FinBookingFormModiCostDtlsPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finModificationChargesinfo, FinBookingFormModiCostDtlsPojo.class);
				//modificationChargesPojo.setTaxAmount(modificationChargeWithGst);
				//modificationChargesPojo.setTotalAmount(finModificationChargesinfo.getModificationAmount()+modificationChargeWithGst);
				modificationChargesPojo.setFinBookingFormModiCostId(finBookingFormModiCostId);
				modificationChargesPojos.add(modificationChargesPojo);
				employeeFinancialServiceDao.saveBookingFormModificationCostDetails(modificationChargesPojo);
			}
			
			/* getting Office_Details */
			transactionServiceInfo.setCondition("MODIFICATION_COST");
			//loadCustomerDetails(transactionResponse, employeeFinancialServiceInfo, customerPropertyDetailsInfo);
			List<FinProjectAccountPojo> finProjectAccountPojoList = employeeFinancialServiceDao.getFinProjectAccountData(transactionServiceInfo, null);
			employeeFinancialServiceInfo.setCondition("");
			if(Util.isEmptyObject(finProjectAccountPojoList)) {
				throw new EmployeeFinancialServiceException("Please add Account number for Modification Invoice, Account number not found.");
			}
			//account number mapped sale owner id mapping
			customerPropertyDetailsInfo.setFlatSaleOwnerIdBasedOnAccountId(finProjectAccountPojoList.get(0).getFlatSaleOwnerId());
			customerPropertyDetailsInfo.setFlatSaleOwnerNameBasedOnAccountId(finProjectAccountPojoList.get(0).getFlatSaleOwner());

			List<ModicationInvoiceAppRej> nextApprovalDetailsList = employeeFinancialServiceDao.getNextModificationApprovalDetails(transactionServiceInfo);
			
			employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
			employeeFinancialServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));

			List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
			List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
			transactionServiceInfo.setOfficeDetailsList(officeDetailsResponseList);
			transactionServiceInfo.setCurrentApprovalLevelName(transactionServiceInfo.getEmployeeName());
			//try {
			transactionServiceInfo.setTransactionAmount(totalAmountAfterTax);
			//sending mail to approval level employee's
			employeeFinancialHelper.approvalModificationInoviceEmailHelper(transactionServiceInfo,nextApprovalDetailsList,"Modification invoice created");
			//} catch (Exception ex) {}
			return null;
		} catch (Exception ex) {
			ex.printStackTrace();
			List<String> errorMsgs = new ArrayList<String>();
			if(ex.getMessage()!=null && ex.getMessage().contains("Customer details not found")) {
				errorMsgs.add(ex.getMessage());
			} else if(ex.getMessage()!=null && ex.getMessage().contains("Please add Account number")) {
				errorMsgs.add(ex.getMessage());
			} else {
				errorMsgs.add("Error occured while saving records to the database plz try again once !");
			}
			log.error("Error occured while saving to the database plz try again once -" + ex.toString());
			throw new InSufficeientInputException(errorMsgs);
		}
	}
	
	private void getModificationInvoiceNumber(FinBookingFormAccountsResponse finBookingFormAccountsResponse) {
		//log.info(" ***** control inside  getInvoiceNumber in EmployeeFinancialServiceImpl ***** ");
		String num = String.format("%04d",finBookingFormAccountsResponse.getTypeId());
		finBookingFormAccountsResponse.setFinBokAccInvoiceNo("INV"+num);
	}
	
	private void getFinancialTransactionInvoiceNumber(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) {
		//log.info(" ***** control inside  getInvoiceNumber in EmployeeFinancialServiceImpl ***** ");
		String num = String.format("%04d",transactionServiceInfo.getTransactionEntryId());
		transactionServiceInfo.setTransactionNo("TRN"+num);
	}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	public FileInfo approveModificationChargesEntry(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws InSufficeientInputException {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.approveModificationChargesEntry() *****");
		try {
			double totalAmountBeforeTax = 0d;
			double totalAmountAfterTax = 0d;

			CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
			FileInfo fileInfo = null;
			boolean isThisIsFinalLevel = false;
			double modificationChargeWithGst = 0d;
			Long finBookingFormModiCostId = transactionServiceInfo.getFinBookingFormModiCostId();
			Long invoiceStatus = Status.PENDING.getStatus();
			
			transactionServiceInfo.setStatusId(Status.ACTIVE.getStatus());
			
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
			employeeFinancialServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
			
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if (Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0))) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
				transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
			} else {
				throw new EmployeeFinancialServiceException("Customer details not found, Failed to process modification invoice.");
			}

			totalAmountAfterTax = transactionServiceInfo.getTransactionAmount();
			double gstAmount = ((transactionServiceInfo.getPercentageValue()/(transactionServiceInfo.getPercentageValue()+100))*(transactionServiceInfo.getTransactionAmount()));
			totalAmountBeforeTax = roundOffAmount(totalAmountAfterTax-gstAmount);
			transactionServiceInfo.setTransactionAmount(totalAmountBeforeTax);

			//double modiChargeWithGst = (transactionServiceInfo.getTransactionAmount() / 100) * transactionServiceInfo.getPercentageValue();
			modificationChargeWithGst += gstAmount;
			
			EmployeeFinBokFrmModiCostTaxInfo info = new EmployeeFinBokFrmModiCostTaxInfo();
			info.setAmount(gstAmount);
			info.setPercentageId(transactionServiceInfo.getPercentageId());

			EmployeeFinModiCostInfo finModiCostinfo = (EmployeeFinModiCostInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, EmployeeFinModiCostInfo.class);
			finModiCostinfo.setTaxAmount(modificationChargeWithGst);
			finModiCostinfo.setTotalAmount(transactionServiceInfo.getTransactionAmount() + modificationChargeWithGst);
			finModiCostinfo.setFinBookingFormModiCostId(finBookingFormModiCostId);
			
			FinBookingFormModiCostPojo bookingFormModiCostPojo = (FinBookingFormModiCostPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finModiCostinfo, FinBookingFormModiCostPojo.class);
			
			Long nextApprLevelId=employeeFinancialServiceDao.getApprovalNextLevelId(transactionServiceInfo,Status.APPROVED);
			//boolean flag = employeeFinancialServiceDao.isValidModificationInvoiceToApprove(transactionServiceInfo, Status.APPROVED);
			if (nextApprLevelId == null) {
				isThisIsFinalLevel = true;
				invoiceStatus = Status.TRANSACTION_COMPLETED.getStatus();
			} else {
				transactionServiceInfo.setFinsetOffAppLevelId(nextApprLevelId);
			}

			List<ModicationInvoiceAppRej>  nextApprovalDetailsList = employeeFinancialServiceDao.getNextModificationApprovalDetails(transactionServiceInfo);
			
			transactionServiceInfo.setModificationNextApprovalDetailsList(nextApprovalDetailsList);
			transactionServiceInfo.setModificationApproveRejectDetailsList(null);

			employeeFinancialServiceDao.updateModificationTransactionStatus(transactionServiceInfo, invoiceStatus);
			
			ModicationInvoiceAppRej modicationInvoiceAppRej = 	financialMapper.constructModificationInvoiceApprRejectDetailsPojo(transactionServiceInfo,Status.APPROVED);
			employeeFinancialServiceDao.saveModifiactionInvocieAppRej(modicationInvoiceAppRej);
			
			List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
			List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
			transactionServiceInfo.setOfficeDetailsList(officeDetailsResponseList);
			transactionServiceInfo.setCurrentApprovalLevelName(transactionServiceInfo.getEmployeeName());
			
			if(isThisIsFinalLevel) {
				return processModificationToFinanlLevel(transactionServiceInfo,customerPropertyDetailsInfo,employeeFinancialServiceInfo,bookingFormModiCostPojo,isThisIsFinalLevel);
			} else {
				//try {
				transactionServiceInfo.setTransactionAmount(totalAmountAfterTax);
					employeeFinancialHelper.approvalModificationInoviceEmailHelper(transactionServiceInfo,nextApprovalDetailsList,"Modification invoice approved");
					//employeeFinancialHelper.sendModificationInoviceApprovalEmail(Arrays.asList(transactionServiceInfo), "Modification invoice approved", null);
				//} catch (Exception e) {

				//}
			}
			
			//String s = null; s.trim();
			return fileInfo;
		} catch (Exception ex) {
			ex.printStackTrace();
			List<String> errorMsgs = new ArrayList<String>();
			if (ex.getMessage() != null && ex.getMessage().contains("Customer details not found")) {
				errorMsgs.add(ex.getMessage());
			} else if (ex.getMessage() != null && ex.getMessage().contains("Please add Account number")) {
				errorMsgs.add(ex.getMessage());
			} else {
				errorMsgs.add("Error occured while saving records to the database plz try again once !");
			}
			log.error("Error occured while saving to the database plz try again once -" + ex.toString());
			throw new InSufficeientInputException(errorMsgs);
		}
	}

	private FileInfo processModificationToFinanlLevel(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, CustomerPropertyDetailsInfo customerPropertyDetailsInfo, EmployeeFinancialServiceInfo employeeFinancialServiceInfo,
			FinBookingFormModiCostPojo bookingFormModiCostPojo, boolean isThisIsFinalLevel) throws Exception {
		FileInfo fileInfo = null;
		EmployeeFinancialTransactionResponse transactionResponse = new EmployeeFinancialTransactionResponse();
		transactionResponse.setPercentageValue(transactionServiceInfo.getPercentageValue());
		transactionResponse.setEmployeeId(transactionServiceInfo.getEmployeeId());
		FinancialProjectMileStoneInfo finProjDemandNoteInfo = null;
		FinBookingFormAccountsPojo finBookingFormAccountsPojo = null;
		List<FinBookingFormModiCostDtlsResponse> finBookingFormModiCostDtlsResponseList = null;
		FinBookingFormModiCostResponse finBookingFormModiCostResponse = null;
		FinBookingFormAccountsResponse finBookingFormAccountsResponse = null;
		
		if (isThisIsFinalLevel) {
		
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
			customerPropertyDetailsInfo2.setType(MetadataId.MODIFICATION_COST.getId());
			customerPropertyDetailsInfo2.setCondition(MetadataId.MODIFICATION_COST.getName());
			customerPropertyDetailsInfo2.setFlatBookingId(transactionServiceInfo.getBookingFormId());

			List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);
			FinBookingFormAccountSummaryPojo accSummaryPojo = (FinBookingFormAccountSummaryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormModiCostPojo,FinBookingFormAccountSummaryPojo.class);
			accSummaryPojo.setType(MetadataId.MODIFICATION_COST.getId());
			accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());

			/* inserting into Fin_Booking_Form_Accounts Table */
			finBookingFormAccountsPojo = financialMapper.copyPropertiesToFinBookingFormAccountsPojo(null,bookingFormModiCostPojo, FinBookingFormAccountsPojo.class, "modificationCost");
			Long finBookingFormAccountsId = employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
			finBookingFormAccountsPojo.setFinBookingFormAccountsId(finBookingFormAccountsId);

			List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;//employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2,Arrays.asList(MetadataId.MODIFICATION_COST.getId()));
			if(Util.isNotEmptyObject(listOfExcessAmount)) {//imp code
				finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
				finProjDemandNoteInfo.setModifiedBy(transactionServiceInfo.getEmployeeId());
				finProjDemandNoteInfo.setPayAmount(bookingFormModiCostPojo.getTotalAmount());
				processExcessAMount(listOfExcessAmount,new FinBookingFormAccountsInfo(),finProjDemandNoteInfo,customerPropertyDetailsInfo2,finBookingFormAccountsPojo, MetadataId.MODIFICATION_COST.getName(),true);					
			}

			/* getting All Responses form info and Pojo */
			finBookingFormModiCostDtlsResponseList = financialMapper.employeeFinModiCostInfoListToFinBookingFormModiCostDtlsPojoList(transactionServiceInfo.getModiCostDtlsInfos());
			finBookingFormModiCostResponse = (FinBookingFormModiCostResponse) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormModiCostPojo,FinBookingFormModiCostResponse.class);

			/* getting Office_Details */
			employeeFinancialServiceInfo.setCondition("MODIFICATION_COST");
			loadCustomerDetails(transactionResponse, employeeFinancialServiceInfo, customerPropertyDetailsInfo);
			
			//loading account details for legal based on selected account number in front end
			EmployeeFinancialTransactionServiceInfo loadAccDetails = new EmployeeFinancialTransactionServiceInfo();
			loadAccDetails.setSiteIds(employeeFinancialServiceInfo.getSiteIds());
			loadAccDetails.setCondition(employeeFinancialServiceInfo.getCondition());
			loadAccDetails.setSiteAccountId(transactionServiceInfo.getSiteAccountId());
			List<FinProjectAccountPojo> finProjectAccountPojoList = employeeFinancialServiceDao.getFinProjectAccountData(loadAccDetails,null);
			//List<FinProjectAccountResponse> 
			List<FinProjectAccountResponse> finProjectAccountResponseList = financialMapper.finProjectAccountPojoListToFinProjectAccountResponseList(finProjectAccountPojoList);
			if(finProjectAccountResponseList.isEmpty()) {
				finProjectAccountResponseList.add(new FinProjectAccountResponse());
			}
			if(Util.isNotEmptyObject(finProjectAccountPojoList) && Util.isNotEmptyObject(finProjectAccountPojoList.get(0).getSiteBankAccountNumber())) {
				finProjectAccountResponseList.get(0).setSiteBankAccountNumber(finProjectAccountPojoList.get(0).getSiteBankAccountNumber());
			}

			transactionResponse.setFinProjectAccountResponseList(finProjectAccountResponseList);
			
			employeeFinancialServiceInfo.setCondition("");
			if (Util.isEmptyObject(transactionResponse.getFinProjectAccountResponseList().get(0).getSiteBankAccountNumber())) {
				throw new EmployeeFinancialServiceException("Please add Account number for Modification Invoice, Account number not found.");
			}
			if(Util.isEmptyObject(finProjectAccountResponseList.get(0).getFlatSaleOwnerId())) {
				throw new EmployeeFinancialServiceException("Sale owner found empty for the selected account number.");
			}
			//account number mapped sale owner id mapping
			customerPropertyDetailsInfo.setFlatSaleOwnerIdBasedOnAccountId(finProjectAccountResponseList.get(0).getFlatSaleOwnerId());
			customerPropertyDetailsInfo.setFlatSaleOwnerNameBasedOnAccountId(finProjectAccountResponseList.get(0).getFlatSaleOwner());
			//selected account number sale owner mapping to the flat
			customerPropertyDetailsInfo.setFlatSaleOwnerId(String.valueOf(finProjectAccountResponseList.get(0).getFlatSaleOwnerId()));
			customerPropertyDetailsInfo.setFlatSaleOwner(finProjectAccountResponseList.get(0).getFlatSaleOwner());
			
			if (!listOfBookingAccountSummaryDetails.isEmpty()) {
				employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
			} else {
				employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
			}
			/*//account number mapped sale owner id mapping
			customerPropertyDetailsInfo.setFlatSaleOwnerIdBasedOnAccountId(finProjectAccountResponseList.get(0).getFlatSaleOwnerId());
			customerPropertyDetailsInfo.setFlatSaleOwnerNameBasedOnAccountId(finProjectAccountResponseList.get(0).getFlatSaleOwner());*/

			finBookingFormAccountsResponse = (FinBookingFormAccountsResponse) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finBookingFormAccountsPojo, FinBookingFormAccountsResponse.class);

			finBookingFormModiCostResponse.setFinBookingFormModiCostDtlsList(finBookingFormModiCostDtlsResponseList);
			transactionResponse.setFinBookingFormAccountsResponse(finBookingFormAccountsResponse);
			transactionResponse.setFinBookingFormModiCostResponse(finBookingFormModiCostResponse);

			/* Getting Customer and CoApplicant Full Names and Other Details */
			//getModificationInvoiceNumber(finBookingFormAccountsResponse);

			setFlatNoAndMileStoneName(transactionResponse, new FinancialProjectMileStoneInfo(),customerPropertyDetailsInfo, MetadataId.MODIFICATION_COST.getName(), null);

			fileInfo = employeeFinancialHelper.modificationChargesInvoiceGeneratorHelper(transactionResponse,transactionServiceInfo);
			
			//employeeFinancialHelper.sendModificationInoviceApprovalEmail(Arrays.asList(transactionServiceInfo), Status.APPROVED.getDescription(), null);
			/* sending mail to customers */
			// MetadataId.MODIFICATION_COST.getName()
			//employeeFinancialHelper.sendFinancialMailToCustomers(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(transactionResponse)),new ArrayList<FileInfo>(Arrays.asList(fileInfo)), MetadataId.MODIFICATION_COST.getName(), null);
			/* preparing invoice document location pojo and inserting into table *///new ArrayList<FileInfo>(Arrays.asList(fileInfo))
			List<InvoiceDocumentLocationPojo> invoiceDocumentLocationPojoList = getInvoiceDocumentLocationPojoList(Arrays.asList(fileInfo),
					Arrays.asList(transactionResponse), MetadataId.MODIFICATION_COST);
			employeeFinancialServiceDao.saveInvoiceDocumentLocationForCharges(invoiceDocumentLocationPojoList);
			return fileInfo;
		}
		return null;
	}

	@Override
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	public void rejectModificationChargesEntry(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		transactionServiceInfo.getModiCostDtlsInfos();
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		log.info("***** Control insideEmployeeFinancialServiceInfo employeeFinancialServiceInfo the EmployeeFinancialServiceImpl.rejectModificationChargesEntry() *****");
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
		employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
		employeeFinancialServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
		
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		if (Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0))) {
			customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
			transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
		} else {
			throw new EmployeeFinancialServiceException("Customer details not found, Failed to process modification invoice.");
		}
		
		List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
		List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
		transactionServiceInfo.setOfficeDetailsList(officeDetailsResponseList);
		transactionServiceInfo.setCurrentApprovalLevelName(transactionServiceInfo.getEmployeeName());
		//List<ModicationInvoiceAppRej>  nextApprovalDetailsList = employeeFinancialServiceDao.getNextModificationApprovalDetails(transactionServiceInfo);
		
		List<ModicationInvoiceAppRej> listOfApprRejectDetailsList = employeeFinancialServiceDao.getModificationApprRejectDetails(transactionServiceInfo);
		employeeFinancialServiceDao.updateModificationTransactionStatus(transactionServiceInfo, Status.REJECTED.getStatus());
		ModicationInvoiceAppRej modicationInvoiceAppRej = financialMapper.constructModificationInvoiceApprRejectDetailsPojo(transactionServiceInfo,Status.REJECTED);
		employeeFinancialServiceDao.saveModifiactionInvocieAppRej(modicationInvoiceAppRej);
		
		transactionServiceInfo.setModificationNextApprovalDetailsList(null);
		transactionServiceInfo.setModificationApproveRejectDetailsList(listOfApprRejectDetailsList);
		
		//employeeFinancialHelper.sendModificationInoviceApprovalEmail(Arrays.asList(transactionServiceInfo),"Modification invoice rejected",null);
		try {
			employeeFinancialHelper.rejectModificationInoviceEmailHelper(Arrays.asList(transactionServiceInfo),"Modification invoice rejected",null);
		} catch (Exception ex) {
			
		}
	}
	
	private EmployeeFinancialTransactionServiceInfo storeTransationUploadedImages(EmployeeFinancialTransactionServiceInfo transactionServiceInfo1, String type, Long tableKey) throws  Exception {
		log.info(" ***** control inside  EmployeeFinancialServiceImpl.storeTransationUploadedImages() ***** ");
		long portNumber = transactionServiceInfo1.getPortNumber();
		Long siteId = transactionServiceInfo1.getSiteId();
		//String bookingFormId = transactionServiceInfo1.getBookingFormId()==null?"":transactionServiceInfo1.getBookingFormId().toString();
		
		String financialDirectoryFilePath = "";
		String financialFileGetPath = "";
		Properties prop= responceCodesUtil.getApplicationProperties();

		if (portNumber == Long.valueOf(MetadataId.LOCAL_PORT_NUMBER.getName())) {
			financialDirectoryFilePath = prop.getProperty("UAT_FINANCIAL_TRANSACTION_FILE_PATH");
			financialFileGetPath =prop.getProperty("UAT_FINANCIAL_TRANSACTION_FILE_URL");	
		} else if (portNumber == Long.valueOf(MetadataId.UAT_PORT_NUMBER.getName())) {
			financialDirectoryFilePath = prop.getProperty("UAT_FINANCIAL_TRANSACTION_FILE_PATH");
			financialFileGetPath =prop.getProperty("UAT_FINANCIAL_TRANSACTION_FILE_URL");	
		} else if (portNumber == Long.valueOf(MetadataId.CUG_PORT_NUMBER.getName())) {
			financialDirectoryFilePath = prop.getProperty("CUG_FINANCIAL_TRANSACTION_FILE_PATH");
			financialFileGetPath =prop.getProperty("CUG_FINANCIAL_TRANSACTION_FILE_URL");
		}else if (portNumber == Long.valueOf(MetadataId.HTTPS_CUG_PORT_NUMBER.getName())) {
			financialDirectoryFilePath = prop.getProperty("CUG_FINANCIAL_TRANSACTION_FILE_PATH");
			financialFileGetPath =prop.getProperty("CUG_FINANCIAL_TRANSACTION_FILE_URL");
		} else if (portNumber == Long.valueOf(MetadataId.LIVE_PORT_NUMBER.getName())) {
			financialDirectoryFilePath = prop.getProperty("LIVE_FINANCIAL_TRANSACTION_FILE_PATH");
			financialFileGetPath =prop.getProperty("LIVE_FINANCIAL_TRANSACTION_FILE_URL");
		}else if (portNumber == Long.valueOf(MetadataId.HTTPS_LIVE_PORT_NUMBER.getName())) {
			financialDirectoryFilePath = prop.getProperty("LIVE_FINANCIAL_TRANSACTION_FILE_PATH");
			financialFileGetPath =prop.getProperty("LIVE_FINANCIAL_TRANSACTION_FILE_URL");
		}
		Base64FileUtil base64Image = new Base64FileUtil();
		
		String givenLength = prop.getProperty("FINANCIAL_TRANSACTION_IMAGE_UPLOAD_LENGTH");
		List<FileInfo> fileInfos = transactionServiceInfo1.getFileInfos();
		//List<Map<String, String>> imageLocation = new ArrayList<Map<String, String>>();
		for (FileInfo fileInfo : fileInfos) {
			if(Util.isNotEmptyObject(fileInfo) && Util.isNotEmptyObject(fileInfo.getBase64()) && Util.isNotEmptyObject(fileInfo.getName())) {

				fileInfo.setName(Util.replaceSpecialCharacters(fileInfo.getName()));
				// throws an exception if ImageSize is greater than 1Mb
				Long length=(long) fileInfo.getBase64().length();
				//Map<String, String> imageLocationDetails = new HashMap<String,String>();
				Long restrictedLength=Long.valueOf(givenLength);
				if(length>=restrictedLength) {
					log.debug("\"Image size should not be greater than 1MB\"" );
					throw new EmployeeFinancialServiceException("Image size should not be greater than 1MB");
				}
				String name = fileInfo.getName();
				fileInfo.setExtension(name.substring(name.lastIndexOf(".") + 1));
				List<FileInfo> fileInfoList1 = new ArrayList<FileInfo>();
				fileInfoList1.add(fileInfo);
				
				String filePath = base64Image.store(fileInfoList1, financialDirectoryFilePath+"/"+type+"/"+siteId+"/"+tableKey);
				fileInfo.setUrl(String.valueOf(financialFileGetPath)+""+type+"/"+siteId+"/"+tableKey+"/"+ filePath);
				fileInfo.setFilePath(String.valueOf(financialDirectoryFilePath)+""+type+"/"+siteId+"/"+tableKey+"/"+ filePath);
				
			} else if(Util.isNotEmptyObject(fileInfo) && Util.isNotEmptyObject(fileInfo.getFilePath()) && Util.isNotEmptyObject(fileInfo.getName())) {
				if(transactionServiceInfo1.isThisIsModifyTransaction() || "AnonymousEntry".equals(type)) {
					
				} else {
					String requestFilePath = fileInfo.getFilePath();
					//String requestFileName = fileInfo.getName();
					File fileSource = new File(requestFilePath);
					
					String filePath =  financialDirectoryFilePath+"/"+type+"/"+siteId+"/"+tableKey;
					File destination = new File(filePath);
					
					List<FileInfo> fileInfoList1 = new ArrayList<FileInfo>();
					fileInfoList1.add(fileInfo);
					String filePath1 = base64Image.getStoredFileName(fileInfoList1, financialDirectoryFilePath+"/"+type+"/"+siteId+"/"+tableKey);
					
					fileInfo.setUrl(String.valueOf(financialFileGetPath)+""+type+"/"+siteId+"/"+tableKey+"/"+ filePath1);
					fileInfo.setFilePath(String.valueOf(financialDirectoryFilePath)+""+type+"/"+siteId+"/"+tableKey+"/"+ filePath1);
					//FileUtils.copyDirectory(fileSource, destination);
					
				   // FileUtils.copyFileToDirectory(fileSource, destination);
					
					/*File temppdfFile = new File(String.valueOf(financialDirectoryFilePath)+""+type+"\\"+tableKey+"\\"+ requestFileName);
					File convFile = new File(String.valueOf(financialDirectoryFilePath)+""+type+"\\"+tableKey+"\\"+ filePath1);
					temppdfFile.renameTo(convFile);*/
					//filePath1 = base64Image.getStoredFileName(fileInfoList1, financialDirectoryFilePath+"\\"+type+"\\"+tableKey);
					
					//fileSource.delete();
				}//transactionServiceInfo1.isThisIsModifyTransaction()
			}
		}
		return transactionServiceInfo1;
	}

	@Override
	public List<DropDownPojo> getAllIncompletedEmpSitesList(EmployeeFinancialRequest employeeFinancialRequest) throws InSufficeientInputException {
		//log.info("**** The control is inside the getAllIncompletedEmpSitesList in EmployeeFinancialServiceImpl *****");
		return employeeFinancialServiceDao.getAllIncompletedEmpSitesList(employeeFinancialRequest);
	}

	@Override
	public List<FinancialMileStoneClassifidesPojo> getAllAliasNamesForMileStone(EmployeeFinancialRequest employeeFinancialRequest) {
		//log.info("**** The control is inside the getAllAliasNamesForMileStone in EmployeeFinancialServiceImpl *****");
		return employeeFinancialServiceDao.getAllAliasNamesForMileStone(employeeFinancialRequest);
	}

	@Override
	public List<PercentagesPojo> getMileStonePercentages(EmployeeFinancialRequest employeeFinancialRequest) {
		//log.info("**** The control is inside the getMileStonePercentages in EmployeeFinancialServiceImpl *****");
		return employeeFinancialServiceDao.getMileStonePercentages(employeeFinancialRequest);
	}

	@Override
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	public void createMileStoneDataForDemandNote(EmployeeFinancialRequest employeeFinancialRequest) throws InformationNotFoundException {
		log.info("**** The control is inside the createMileStoneDataForDemandNote in EmployeeFinancialServiceImpl *****");
		FinancialMileStoneClassifidesPojo financialMileStoneClassifidesPojo = financialMapper.employeeFinancialRequestToFinancialMileStoneClassifidesPojo(employeeFinancialRequest);
		Long finMilestoneClassifidesId = employeeFinancialServiceDao.saveFinMileStoneClassifides(financialMileStoneClassifidesPojo);
		if(Util.isNotEmptyObject(finMilestoneClassifidesId)) {
			employeeFinancialRequest.setFinMilestoneClassifidesId(finMilestoneClassifidesId); 
			employeeFinancialServiceDao.saveFinancialMileStoneClassifideMappingBlocks(employeeFinancialRequest);
			List<FinancialProjectMileStonePojo> financialProjectMileStonePojosList = financialMapper.employeeFinancialRequestToFinancialProjectMileStonePojosList(employeeFinancialRequest);
			employeeFinancialServiceDao.saveFinancialProjectMileStoneClassifides(financialProjectMileStonePojosList);
		}else {
			List<String> errorMsgs = new ArrayList<String>();
			errorMsgs.add("*** FinMileStoneClassifides insertion exception and the Primary Key not generated ***");
			log.error("*** FinMileStoneClassifides insertion exception and the Primary Key generated is***"+finMilestoneClassifidesId);
			throw new InformationNotFoundException(errorMsgs);
		}
	}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	public void updateMileStoneDataForDemandNote(EmployeeFinancialRequest employeeFinancialRequest) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.updateMileStoneDataForDemandNote() *****");
		Long finMilestoneClassifidesId = employeeFinancialRequest.getFinMilestoneClassifidesId();
		boolean isCompletedMsFound = false;
		boolean isInCompletedMsFound = false;
		List<FinancialProjectMileStoneRequest> list = employeeFinancialRequest.getFinancialProjectMileStoneRequests();
		//Long prevStatusId = 0l;
		//in milestone status changed in order, then only we can update the status 
		for (FinancialProjectMileStoneRequest  mileStoneRequest : list) {
			if (mileStoneRequest.getStatusId() == null && mileStoneRequest.getProjectMsStatusId() != null) {
				mileStoneRequest.setStatusId(mileStoneRequest.getProjectMsStatusId());
			}
			if (mileStoneRequest.getStatusId() != null) {
				
				if(Status.MS_COMPLETED.getStatus().equals(mileStoneRequest.getStatusId())) {
					isCompletedMsFound = true;
				}
				if(Status.MS_INCOMPLETE.getStatus().equals(mileStoneRequest.getStatusId()) && isCompletedMsFound) {
					isInCompletedMsFound = true;
				}
				//if status found completed and incomplete in update data then throw error, as we need to update status in order
				if(isCompletedMsFound && isInCompletedMsFound) {
					//throw new EmployeeFinancialServiceException("Please update the milestone status in order.!");					
				}
				/*if(prevStatusId.equals(mileStoneRequest.getStatusId())) {
					throw new EmployeeFinancialServiceException("Please change the milestone status in order.!");
				}*/
				//prevStatusId = mileStoneRequest.getStatusId();
			}
		}
		
		if(Util.isNotEmptyObject(finMilestoneClassifidesId)) {
			for (FinancialProjectMileStoneRequest  mileStoneRequest : list) {
				mileStoneRequest.setCreatedBy(String.valueOf(employeeFinancialRequest.getEmpId()));
				employeeFinancialServiceDao.updateMilestoneStatus(mileStoneRequest);
			}
		}else {
			List<String> errorMsgs = new ArrayList<String>();
			errorMsgs.add("Failed to update the records, Please try again later.!");
			log.info("Failed to update the records, Please try again later.!"+finMilestoneClassifidesId);
			throw new InformationNotFoundException(errorMsgs);
		}
		//String s = null;
		//s.trim();
	}
	
	@Override
	public List<SiteDetailsInfo> getRaisedMilestoneSites(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) {
		log.info("**** The control is inside the getRaisedMilestoneSites in EmployeeFinancialServiceImpl *****");
		List<SiteDetailsPojo> siteDetailsPojoList = employeeFinancialServiceDao.getRaisedMilestoneSites(employeeFinancialServiceInfo);
		return financialMapper.siteDetailsPojoListToSiteDetailsInfoList(siteDetailsPojoList);
	}
	
	@Override
	public List<SiteDetailsInfo> getActiveBlocksFlats(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) {
		log.info("**** The control is inside the getActiveBlocksFlats in EmployeeFinancialServiceImpl *****");
		List<SiteDetailsPojo> siteDetailsPojoList = employeeFinancialServiceDao.getActiveBlocksFlats(employeeFinancialServiceInfo);
		return financialMapper.siteDetailsPojoListToSiteDetailsInfoList(siteDetailsPojoList);
	}

	@Override
	public EmployeeFinancialResponse getDemandNotes(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) {
		log.info("**** The control is inside the getDemandNotes in EmployeeFinancialServiceImpl *****");
		EmployeeFinancialResponse employeeFinancialResponse = new EmployeeFinancialResponse();
		List<Long> flatBookingIdsList = new ArrayList<>();
		employeeFinancialServiceInfo.setActionUrl("View DemandNotes");
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList) {
			if(Util.isNotEmptyObject(customerPropertyDetailsPojo) && Util.isNotEmptyObject(customerPropertyDetailsPojo.getFlatBookingId())) {
				flatBookingIdsList.add(customerPropertyDetailsPojo.getFlatBookingId());
			}	
		}
		if(Util.isNotEmptyObject(flatBookingIdsList)) {
			employeeFinancialServiceInfo.setBookingFormIds(flatBookingIdsList);
			List<FinBookingFormDemandNotePojo> finBookingFormDemandNotePojoList = employeeFinancialServiceDao.getDemandNotes(employeeFinancialServiceInfo);
			List<FinBookingFormDemandNoteResponse> finBookingFormDemandNoteResponseList = financialMapper.finBookingFormDemandNotePojoListToFinBookingFormDemandNoteResponseList(finBookingFormDemandNotePojoList);
			/* Converting amount into Currency Format for Interest Letters */
			if("Interest_Letter".equalsIgnoreCase(employeeFinancialServiceInfo.getRequestUrl())) {
				for(FinBookingFormDemandNoteResponse finBookingFormDemandNoteResponse : finBookingFormDemandNoteResponseList) {
					if(Util.isNotEmptyObject(finBookingFormDemandNoteResponse)) {
						if(Util.isNotEmptyObject(finBookingFormDemandNoteResponse.getInterestAmount())) {
							finBookingFormDemandNoteResponse.setInterestAmountWithFormat(currencyUtil.convertUstoInFormat(BigDecimal.valueOf(finBookingFormDemandNoteResponse.getInterestAmount()).setScale(roundingModeSize, roundingMode).toString()));
						}else {
							finBookingFormDemandNoteResponse.setInterestAmountWithFormat("0.0");
						}
					}
				}
			}
			employeeFinancialResponse.setFinBookingFormDemandNoteesponse(finBookingFormDemandNoteResponseList);
		}
		return employeeFinancialResponse;
	}
	//ViewCustomerDataGetInterest from customer app
	@SuppressWarnings({ "unchecked", "rawtypes" })
	@Override
	public List<Object> generateDemandNotePreview(final EmployeeFinancialServiceInfo employeeFinancialServiceInfo, HashMap<Long, Long> generatedMileStones
			, String requestFrom, Map<Long, List<FinancialProjectMileStonePojo>> customerGeneratedMilestone
			, Map<Long, List<FinancialProjectMileStonePojo>> flatPreviousMilestoneNonPaidData) throws Exception {
		log.info(employeeFinancialServiceInfo.getActionUrl()+"**** The control is inside the generatedDemandNotePreview in EmployeeFinancialServiceImpl *****" + employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size());
		List<EmployeeFinancialResponse> employeeFinancialResponseList = new ArrayList<>();
		List<FileInfo> fileInfoList = new ArrayList<>();
		final boolean isThisUploadedData = employeeFinancialServiceInfo.isThisUplaodedData();
		boolean isRequestFromGenereteDnService = requestFrom==null?false:requestFrom.equalsIgnoreCase("GenerateDemandNote");
		//Map<String, Object> returnResponse = new HashMap<>();
		List<CustomerPropertyDetailsInfo> nonGeneratedDemandNoteForFlats = new ArrayList<CustomerPropertyDetailsInfo>();
		EmployeeFinancialResponse employeeFinancialResponse12 = new EmployeeFinancialResponse();
		final boolean isReGenerateDemandNote =  Util.isEmptyObject(employeeFinancialServiceInfo.isReGenerateDemandNote())?false:employeeFinancialServiceInfo.isReGenerateDemandNote();
		employeeFinancialResponse12.setNonSavedDemandNoteDetails(nonGeneratedDemandNoteForFlats);
		String requestUrl = employeeFinancialServiceInfo.getRequestUrl()==null?"":employeeFinancialServiceInfo.getRequestUrl();
		if (isReGenerateDemandNote) {
			//loading last milestone and giving default values to avoid null pointer excetion
			FinancialProjectMileStoneInfo dummyMileStoneInfo = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size()-1); 
			dummyMileStoneInfo.setFinMilestoneClassifidesId(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getFinMilestoneClassifidesId());
			dummyMileStoneInfo.setProjectMilestoneId(0l);
			dummyMileStoneInfo.setMileStoneNo(0l);
		}
		
		if(!requestFrom.equalsIgnoreCase("GenerateDemandNote") && !requestUrl.equals("ViewCustomerDataGetInterest")) {
			employeeFinancialServiceInfo.setDemandNoteSelectionType("");
		}

		/* Getting Current Milestone selected Data */
		if(!isRequestFromGenereteDnService) {//
			getCurrentProjectMilestoneData(employeeFinancialServiceInfo);
		}

		FinancialProjectMileStoneInfo currentOneFinancialProjectMileStoneInfo = null;
		/* getting previous  MileStone Demand Note List */
		FinancialProjectMileStoneInfo financialProjectMileStoneInfo1 = new FinancialProjectMileStoneInfo();
		financialProjectMileStoneInfo1.setCondition("PREVIEW_DEMAND_NOTES");
		if("Interest_Letter".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl())) {
			financialProjectMileStoneInfo1.setCondition(employeeFinancialServiceInfo.getActionUrl());
			financialProjectMileStoneInfo1.setCurrentprojectMileStoneIds(employeeFinancialServiceInfo.getCurrentprojectMileStoneIds());
			if(Util.isEmptyObject(employeeFinancialServiceInfo.getCurrentprojectMileStoneIds())) {
				throw new EmployeeFinancialServiceException("Failed to generate interest letter, Please try again later.");
			}
		}
		financialProjectMileStoneInfo1.setReGenerateDemandNote(employeeFinancialServiceInfo.isReGenerateDemandNote());
		if(employeeFinancialServiceInfo.getIsInterestOrWithOutInterest().equalsIgnoreCase(Status.With_Interest.getDescription())) {
			financialProjectMileStoneInfo1.setInterestSelectionType(Status.With_Interest.getStatus());
		}
		
		/*if("Interest_Letter".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl())) {
			//don't move this line to live
			//financialProjectMileStoneInfo1.setCurrentprojectMileStoneIds(employeeFinancialServiceInfo.getCurrentprojectMileStoneIds());
		}*/
		if(Util.isNotEmptyObject(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests())) {
			if(isReGenerateDemandNote) {
				if(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size()>=2) {
					currentOneFinancialProjectMileStoneInfo = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size()-2);
					financialProjectMileStoneInfo1.setProjectMilestoneId(currentOneFinancialProjectMileStoneInfo.getProjectMilestoneId());
					employeeFinancialServiceInfo.setProjectMileStoneIds(Arrays.asList(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getProjectMilestoneId()));
				}
			}else {
				currentOneFinancialProjectMileStoneInfo = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size()-1);
				financialProjectMileStoneInfo1.setProjectMilestoneId(currentOneFinancialProjectMileStoneInfo.getProjectMilestoneId());
				employeeFinancialServiceInfo.setProjectMileStoneIds(Arrays.asList(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getProjectMilestoneId()));
			}
		}
		//if this is with interest demand note then selecting all payment status types
		if(employeeFinancialServiceInfo.getIsInterestOrWithOutInterest().equalsIgnoreCase(Status.With_Interest.getDescription())) {
			financialProjectMileStoneInfo1.setPaymentStatus(Arrays.asList(new Long[] {Status.PENDING.getStatus() ,Status.PAID.getStatus(), Status.INPROGRESS.getStatus()}));
		} else {
			financialProjectMileStoneInfo1.setPaymentStatus(Arrays.asList(new Long[] {Status.PENDING.getStatus(), Status.INPROGRESS.getStatus()}));
		}
		//commented at the time of paid ms calculation financialProjectMileStoneInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.PENDING.getStatus(), Status.INPROGRESS.getStatus()}));
		financialProjectMileStoneInfo1.setType(Arrays.asList(new Long[] {MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()}));		//milestone is equals to principal
		
		if(!employeeFinancialServiceInfo.isThisUplaodedData() && !requestFrom.equals("GenerateDemandNote")  && !requestUrl.equals("ViewCustomerDataGetInterest")) {
			//from generate demand note service already loadMilestoneData() called so not required to call again in preview method 
			loadMilestoneData(employeeFinancialServiceInfo);
		}
		//5th ms
		List<String> errorMsgs = null;
		Map<String, Object> mileStoneDetailsList = null;
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;
		List<FinBookingFormExcessAmountPojo> listOfPenaltyExcessAmount = null;
		EmployeeFinancialResponse employeeFinancialResponse = null;
		List<FinancialProjectMileStoneResponse> financialProjectMileStoneResponseList = null;
		List<FinancialProjectMileStoneResponse> previouseProjectMileStoneResponseList = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = null;
		FinancialProjectMileStoneInfo currentFinancialProjectMileStoneInfo = null;
		List<FinancialProjectMileStonePojo> previouseFinancialProjectMileStonePojoList = null;
		FinancialProjectMileStonePojo explicitGeneratedRecord = null;
		EmployeeFinancialTransactionServiceInfo transactionServiceInfo = null;

		boolean isDemandNoteRaised = true, isAggrementCompleted = false;
		long mileStoneNo = 0;
		int milestoneSize = 0;
		/* Getting Customer Property Details */
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		employeeFinancialServiceInfo.setCustomerPropertyDetailsPojoList(customerPropertyDetailsPojoList);
		for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList) {
			if(Util.isNotEmptyObject(customerPropertyDetailsPojo) && Util.isNotEmptyObject(customerPropertyDetailsPojo.getFlatBookingId())
					&& Util.isNotEmptyObject(customerPropertyDetailsPojo.getPancard())) {
				mileStoneDetailsList = new HashMap<>(); errorMsgs = null;
				listOfExcessAmount = null;
				previouseFinancialProjectMileStonePojoList = null;
				listOfPenaltyExcessAmount = new ArrayList<>();
				employeeFinancialResponse = new EmployeeFinancialResponse();
				financialProjectMileStoneResponseList = new ArrayList<>();
				currentFinancialProjectMileStoneInfo = null;
				explicitGeneratedRecord = null;
				transactionServiceInfo = null;
				previouseProjectMileStoneResponseList = null;
				customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo2.setType(MetadataId.FIN_PENALTY.getId());
				customerPropertyDetailsInfo2.setFlatBookingId(customerPropertyDetailsPojo.getFlatBookingId());
				customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_PENALTY.getName());
				customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());
				List excessAmountReturnList = null;//new ArrayList<>();
				if(listOfPenaltyExcessAmount.isEmpty()) {//loading interest excess(extra) paid amount
					listOfPenaltyExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2,Arrays.asList(MetadataId.FIN_PENALTY.getId()));
					mileStoneDetailsList.put(MetadataId.FIN_PENALTY.getName(),listOfPenaltyExcessAmount);
				}

				/* setting Customer Property Details in respective Object */
				//employeeFinancialResponse.setShowGstInPDF(employeeFinancialServiceInfo.isShowGstInPDF());
				customerPropertyDetailsInfo = financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
				customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());

				//if this request coming form generate demand note service then take data from map object from method parameter
				if(isRequestFromGenereteDnService && !isReGenerateDemandNote) {
					//if this request from Generate Demand note service
					previouseFinancialProjectMileStonePojoList = flatPreviousMilestoneNonPaidData.get(customerPropertyDetailsInfo.getFlatBookingId());
					if(Util.isEmptyObject(previouseFinancialProjectMileStonePojoList)) {
							continue;
					}
				} else {
					//if this is regenerate demand note or preview then load data from DB
					previouseFinancialProjectMileStonePojoList = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(financialProjectMileStoneInfo1, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
					if(isReGenerateDemandNote) {
						if(Util.isEmptyObject(previouseFinancialProjectMileStonePojoList)) {
							//if this is regenerate demand note and this object is empty then continue the loop
							//means there is no pending milestone
							continue;
						}
					}
				}

				/* checking two conditions AggrementCompleted ( agreement completed no need to raise other than one milestone or Demand Note is Raised */
				isDemandNoteRaised = true;
				isAggrementCompleted = false;
				mileStoneNo = 0;
				milestoneSize = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size();
				for(FinancialProjectMileStoneInfo currentFinancialProjectMileStoneInfoMain : employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests()) {
					List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList1 = null;
					FinancialProjectMileStonePojo generatedMileStonePojo = null;
					List<FinancialMileStoneClassifidesPojo> mileStoneClassifidesPojo = null;
					explicitGeneratedRecord = null;
					transactionServiceInfo = new EmployeeFinancialTransactionServiceInfo();
					transactionServiceInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());					
					boolean isMilestoneGenerated = false;

					//cloning object so actual object values will not change, as we need to use to actual object for multiple customers
					currentFinancialProjectMileStoneInfo = (FinancialProjectMileStoneInfo) currentFinancialProjectMileStoneInfoMain.clone(); 
					mileStoneNo = currentFinancialProjectMileStoneInfo.getMileStoneNo();

					if(customerGeneratedMilestone.containsKey(customerPropertyDetailsInfo.getFlatBookingId())) {
						financialProjectMileStonePojoList1 = customerGeneratedMilestone.get(customerPropertyDetailsInfo.getFlatBookingId());
					} else {
						
						if(milestoneSize != 1 && isThisUploadedData) {
							 //for loading all the milestone records, Setting upload data false
							currentFinancialProjectMileStoneInfo.setThisUplaodedData(false);
						 }
						//if the milestone is not generated then add that milestone in demand note pdf file
						financialProjectMileStonePojoList1 = employeeFinancialServiceDao.isMileStoneInitiatedForThisFlatBookingFormId(currentFinancialProjectMileStoneInfo,customerPropertyDetailsInfo, new FinProjDemNoteStatisticsPojo());
						customerGeneratedMilestone.put(customerPropertyDetailsInfo.getFlatBookingId(), financialProjectMileStonePojoList1);
						currentFinancialProjectMileStoneInfo.setThisUplaodedData(isThisUploadedData);//reassigning upload data value
					}

					generatedMileStonePojo = checkMilestoneGeneratedForFlat(financialProjectMileStonePojoList1,currentFinancialProjectMileStoneInfo);
					
					if(Util.isEmptyObject(generatedMileStonePojo)) {
						 isMilestoneGenerated = false;
					 } else {
						 //explicit generated record means, that record not generated by employee using UI, that record is generated bcoz of user paid some excess amount 
						 //so for that milestone record status will be the EXPLICIT_GENERATED_RECORD
						 explicitGeneratedRecord = generatedMileStonePojo;
						 Long msStatusId = explicitGeneratedRecord.getMsStatusId();
						 if(msStatusId!=null && msStatusId.equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
							 //Status.EXPLICIT_GENERATED_RECORD.getStatus() means milestone record generated at time of the receipt entry
							 //so the milestone is not generated manually
							 isDemandNoteRaised = false;
							 isMilestoneGenerated = false;
						 }else {//active
							 isMilestoneGenerated = true;
						 }
					 }
					if(currentFinancialProjectMileStoneInfo.getMileStoneNo()!=1) {
						employeeFinancialServiceInfo.setFinMilestoneClassifidesId(currentFinancialProjectMileStoneInfo.getFinMilestoneClassifidesId());
						if(!currentFinancialProjectMileStoneInfo.getMilestoneName().equals("Dummy MileStone for Regenerate Demand Note")) {
							mileStoneClassifidesPojo = employeeFinancialServiceDao.loadCustomerInvolvedAlianNameDetails(employeeFinancialServiceInfo,customerPropertyDetailsInfo);
							if(Util.isNotEmptyObject(mileStoneClassifidesPojo) &&  !mileStoneClassifidesPojo.get(0).getFinMilestoneClassifidesId().equals(employeeFinancialServiceInfo.getFinMilestoneClassifidesId())) {
								nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
								//if flat no changing his alias name group,
								throw new EmployeeFinancialServiceException("Demand note can not generated for "+currentFinancialProjectMileStoneInfo.getMilestoneName()+" milestone. as '"+customerPropertyDetailsInfo.getFlatNo()+"' already involved in alias "+mileStoneClassifidesPojo.get(0).getMileStoneAliasName()+" group.");
							}
						}
					}
					
					if(currentFinancialProjectMileStoneInfo.getMileStoneNo()!=1) {//cheking condition for other than first millestone
						Timestamp aggrementDate = employeeFinancialServiceDao.getFlatAgreementCompletedDate(currentFinancialProjectMileStoneInfo,customerPropertyDetailsInfo);	
						if(Util.isEmptyObject(aggrementDate)) {
							nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
							isAggrementCompleted = true ;
							continue;
						}
					}
					
					if (currentFinancialProjectMileStoneInfo.isReGenerateDemandNote()) {
						if (isMilestoneGenerated) {//is this is regenerate Demand Note Preview or Generate Demand Note
							//isMilestoneGenerated = false;
							isDemandNoteRaised = false;
							for (Iterator<FinancialProjectMileStonePojo> iterator = previouseFinancialProjectMileStonePojoList.iterator(); iterator.hasNext();) {
								FinancialProjectMileStonePojo msPojo = (FinancialProjectMileStonePojo) iterator.next();
								if(msPojo.getBookingFormId().equals(customerPropertyDetailsInfo.getFlatBookingId()) && msPojo.getProjectMilestoneId().equals(currentFinancialProjectMileStoneInfo.getProjectMilestoneId()) ) {
									FinBookingFormDemandNotePojo demandNoteInfo = new FinBookingFormDemandNotePojo();
									demandNoteInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
									demandNoteInfo.setStatusId(Status.REGENERATED_DEMAND_NOTE.getStatus());
									
									List<FinBookingFormDemandNotePojo> demandNotePojos = employeeFinancialServiceDao.getDemandNoteId(demandNoteInfo);
									if(Util.isNotEmptyObject(demandNotePojos) && demandNotePojos.size()!=0) {
										msPojo.setFinBokFomDmdNoteId(Util.isEmptyObject(demandNotePojos.get(0).getFinBookingFormDemandNoteId())?0l:demandNotePojos.get(0).getFinBookingFormDemandNoteId());
										msPojo.setDemandNoteNo(Util.isEmptyObject(demandNotePojos.get(0).getDemandNoteNo())?"":demandNotePojos.get(0).getDemandNoteNo());
										//msPojo.setDemandNoteDate(Util.isEmptyObject(demandNotePojos.get(0).getDemandNoteDate())?null:demandNotePojos.get(0).getDemandNoteDate());
									}else {
										if(requestFrom!=null && requestFrom.equals("GenerateDemandNote")) {
											msPojo.setFinBokFomDmdNoteId(0l);
											msPojo.setDemandNoteNo("N/A");
											msPojo.setDemandNoteDate(null);	
										}
									}
								}
							}
						} else {
							//if this is regenerate demand note, and trying to create not regenerate demand note that is not generated throw the exception or continue it
							if(currentFinancialProjectMileStoneInfo.getMilestoneName().equals("Dummy MileStone for Regenerate Demand Note")) {
								
							}else {
								continue;
								//throw new EmployeeFinancialServiceException("Demand note is not generated for "+currentFinancialProjectMileStoneInfo.getMilestoneName()+" milestone.");
							}
						}
					}
					
					if(isNotEmptyObject(generatedMileStones)) {//is this is not empty means request is from Generate Demand Note Service
							for (Iterator<FinancialProjectMileStonePojo> iterator = previouseFinancialProjectMileStonePojoList.iterator(); iterator.hasNext();) {
								FinancialProjectMileStonePojo msPojo = (FinancialProjectMileStonePojo) iterator.next();
								//log.info("EmployeeFinancialServiceImpl.generateDemandNotePreview() " +customerPropertyDetailsInfo.getFlatNo()+" "+Util.isNotEmptyObject(msPojo.getProjectMilestoneId()));
								//log.info(Util.isNotEmptyObject(msPojo.getBookingFormId())+" "+Util.isNotEmptyObject(customerPropertyDetailsInfo.getFlatBookingId()));
								//log.info(Util.isNotEmptyObject(currentFinancialProjectMileStoneInfo.getProjectMilestoneId()));
								if(Util.isNotEmptyObject(msPojo.getProjectMilestoneId()) && msPojo.getBookingFormId().equals(customerPropertyDetailsInfo.getFlatBookingId()) && msPojo.getProjectMilestoneId().equals(currentFinancialProjectMileStoneInfo.getProjectMilestoneId()) ) {
									//iterator.remove();if(isMilestoneGenerated) {if(msPojo.getPaidAmount()>0) {}}
									isMilestoneGenerated = true;
 								    isDemandNoteRaised = false;
 								    
 								    //customerPropertyDetailsInfo.setCondition("GetGSTPercentage");
 									customerPropertyDetailsInfo.setType(MetadataId.GST.getId());
 									customerPropertyDetailsInfo.setTypeId(msPojo.getTypeId());
 									msPojo.setSetOffAmount(msPojo.getPayAmount());

								}
						}
					}
					if(!isMilestoneGenerated) {//if isMilestoneGenerated is not true means milestone is not generated
						customerPropertyDetailsInfo.setCondition("");
						/* get basic Amount and Tax Amount of milestone */
						getBasicAmountAndTaxAmountForEmployeeRaisedMilestone(currentFinancialProjectMileStoneInfo, customerPropertyDetailsInfo);
						if(!requestUrl.equalsIgnoreCase("ViewCustomerData") || !employeeFinancialServiceInfo.getCurrentprojectMileStoneIds().contains(currentFinancialProjectMileStoneInfo.getProjectMilestoneId()) || !employeeFinancialServiceInfo.isThisUplaodedData()) {
							//!employeeFinancialServiceInfo.isThisUplaodedData()
							employeeFinancialHelper.assignDemandNoteDate(currentFinancialProjectMileStoneInfo,customerPropertyDetailsInfo,employeeFinancialServiceInfo);
						}
						if(Util.isNotEmptyObject(explicitGeneratedRecord)) {
							Long msStatusId = explicitGeneratedRecord.getMsStatusId();
							 if(msStatusId!=null && msStatusId.equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
								 isDemandNoteRaised = false;
								 //adding not generated milestone amount
								 currentFinancialProjectMileStoneInfo.setPaidAmount(explicitGeneratedRecord.getPaidAmount()==null?0d:explicitGeneratedRecord.getPaidAmount());
							 }
						}

						isDemandNoteRaised = false;
						/* Calculating Interest or Penalty Amount for previous Milestones List */
						double totalInterestAmount = 0d;
						if(employeeFinancialServiceInfo.getIsInterestOrWithOutInterest().equalsIgnoreCase(Status.With_Interest.getDescription())) {
							currentFinancialProjectMileStoneInfo.setInterestSelectionType(Status.With_Interest.getStatus());
							if(requestUrl.equals("ViewCustomerDataGetInterest")) {
								currentFinancialProjectMileStoneInfo.setInterestCalculationFrom(requestUrl);
							}
							processPenaltyAmount(previouseFinancialProjectMileStonePojoList,currentFinancialProjectMileStoneInfo,totalInterestAmount,"Preview Demand Note",requestFrom,mileStoneDetailsList);
						}
						FinancialProjectMileStonePojo currentFinancialProjectMileStonePojo = (FinancialProjectMileStonePojo) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(currentFinancialProjectMileStoneInfo, FinancialProjectMileStonePojo.class);
						currentFinancialProjectMileStonePojo.setPaymentStatus(Status.PENDING.getStatus());
						
						FinBookingFormAccountsInfo accountsInfo = new FinBookingFormAccountsInfo();
						FinBookingFormAccountsPojo bookingFormAccountsPojo = new FinBookingFormAccountsPojo();		
						if(isEmptyObject(listOfExcessAmount)) {//loading excess amount if any on milestone amount
							double paidAmount = currentFinancialProjectMileStoneInfo.getPaidAmount()==null?0d:new BigDecimal(currentFinancialProjectMileStoneInfo.getPaidAmount()).setScale(roundingModeSize, roundingMode).doubleValue();
							double payAmount = currentFinancialProjectMileStoneInfo.getPayAmount()==null?0d:new BigDecimal(currentFinancialProjectMileStoneInfo.getPayAmount()).setScale(roundingModeSize, roundingMode).doubleValue();
							//10,00,000 < 10,00,000
							if (paidAmount < payAmount) {
								customerPropertyDetailsInfo.setCondition("PaymentRefund");
								listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo,Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()));
							}
						}
						excessAmountReturnList = new ArrayList();
						if(isNotEmptyObject(listOfExcessAmount)) {
							excessAmountReturnList = processExcessAMount(listOfExcessAmount,accountsInfo,currentFinancialProjectMileStoneInfo,customerPropertyDetailsInfo,bookingFormAccountsPojo, "MileStoneBasicAmt",false);
						}
						if(isNotEmptyObject(bookingFormAccountsPojo.getPaidAmount())) {
							double excessAmount = isEmptyObject(bookingFormAccountsPojo.getPaidAmount())?0d:bookingFormAccountsPojo.getPaidAmount();
							currentFinancialProjectMileStonePojo.setPaidAmount(currentFinancialProjectMileStonePojo.getPaidAmount()+excessAmount);
							if(isNotEmptyObject(bookingFormAccountsPojo.getPaidDate()) && excessAmount!=0) {
								currentFinancialProjectMileStonePojo.setMileStonePaidDate(bookingFormAccountsPojo.getPaidDate());
								//currentFinancialProjectMileStonePojo.setPaymentStatus(bookingFormAccountsPojo.getPaymentStatus());
								currentFinancialProjectMileStonePojo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
								currentFinancialProjectMileStonePojo.setBookingFormAccountStatementPojo((List<FinBookingFormAccountsStatementPojo>) excessAmountReturnList.get(0));
							}
						}
						previouseFinancialProjectMileStonePojoList.add(currentFinancialProjectMileStonePojo);
						
					}else{
						if(Util.isEmptyObject(requestFrom) && !employeeFinancialServiceInfo.isReGenerateDemandNote()) {
							if(Util.isNotEmptyObject(employeeFinancialServiceInfo.getDemandNoteSelectionType()) && !employeeFinancialServiceInfo.getDemandNoteSelectionType().equalsIgnoreCase(FinEnum.SEND_SINGLE_MULTIPLE.getName())) {
								throw new EmployeeFinancialServiceException(" Already demand note generated on following details Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" Mile Stone Name : "+currentFinancialProjectMileStoneInfo.getMilestoneName());
							}else {
								nonGeneratedDemandNoteForFlats.add(customerPropertyDetailsInfo);
							}
						}
						log.info(" invalid entry, already demand note generated on following details Flat Booking Form Id : "+customerPropertyDetailsInfo.getFlatBookingId()+" Mile Stone No "+currentFinancialProjectMileStoneInfo.getProjectMilestoneId());
					}

				}
				if(isDemandNoteRaised || isAggrementCompleted) {
					errorMsgs = new ArrayList<>();
					log.error(HttpStatus.insufficientInput.getDescription() +" Already demand note generated on following details Flat No : "+customerPropertyDetailsInfo.getFlatNo());
					if(Util.isNotEmptyObject(employeeFinancialServiceInfo.getDemandNoteSelectionType()) && !employeeFinancialServiceInfo.getDemandNoteSelectionType().equalsIgnoreCase(FinEnum.SEND_SINGLE_MULTIPLE.getName())) {
						errorMsgs.add(HttpStatus.insufficientInput.getDescription()+", Might be demand note already generated, Please check and generate Demand Note  Flat No : "+customerPropertyDetailsInfo.getFlatNo());
					}else if(isAggrementCompleted && mileStoneNo!=1){
						errorMsgs.add("Flat agreement is not completed "+customerPropertyDetailsInfo.getFlatNo());
					}else {
						if(Util.isNotEmptyObject(nonGeneratedDemandNoteForFlats)) {
							errorMsgs.add(" Already demand note generated on following details Flat No : "+customerPropertyDetailsInfo.getFlatNo());				
						}
					}
					if(Util.isNotEmptyObject(employeeFinancialServiceInfo.getFlatIds())) {
						if(errorMsgs.isEmpty()) {errorMsgs.add("Failed to generate Demand Note, Please try again once !");}
						throw new InSufficeientInputException(errorMsgs);
					}else if(Util.isNotEmptyObject(employeeFinancialServiceInfo.getBlockIds())) {
						log.info(errorMsgs);
						continue;
					}

				}
				
				/* mapping FinancialProjectMileStonePojo List to FinancialProjectMileStoneResponse List */
				previouseProjectMileStoneResponseList = financialMapper.financialProjectMileStonePojoListToFinancialProjectMileStoneResponseList(previouseFinancialProjectMileStonePojoList);
				/* setting all milestones Demand Note individual to List in respective Object */
				if(!previouseProjectMileStoneResponseList.isEmpty() && !isDemandNoteRaised) {
					financialProjectMileStoneResponseList.addAll(previouseProjectMileStoneResponseList);
				}
				if(employeeFinancialServiceInfo.isReGenerateDemandNote()) {
					log.info("***** Control inside the EmployeeFinancialServiceImpl.getCustomerFinancialDetails() *****");
					if(financialProjectMileStoneResponseList.size()==1) {
						//if this is regenerate demand note and this object size is one then continue the loop
						//as this list contains only dummy object details
						continue;
					}
				}
				if(!requestUrl.equals("ViewCustomerDataGetInterest")) {
					String condition = employeeFinancialServiceInfo.getCondition();
					employeeFinancialServiceInfo.setCondition("DEMAND_NOTE_ACCOUNT_NUMBER");
					
					//loding account number, customer details, site address, company billing address
					loadCustomerDetails(employeeFinancialResponse,employeeFinancialServiceInfo,customerPropertyDetailsInfo);
					
					employeeFinancialServiceInfo.setCondition(condition);
					if(Util.isEmptyObject(employeeFinancialResponse.getFinProjectAccountResponseList().get(0).getSiteBankAccountNumber())) {
						throw new EmployeeFinancialServiceException("Please add Account number for Demand Note, Account number not found.");
					}
					employeeFinancialResponse.setFinancialProjectMileStoneResponse(financialProjectMileStoneResponseList);				
					/* setting true for with Interest or false */
					if(Util.isNotEmptyObject(employeeFinancialServiceInfo.getIsInterestOrWithOutInterest()) && employeeFinancialServiceInfo.getIsInterestOrWithOutInterest().equalsIgnoreCase(Status.With_Interest.getDescription())) {
						employeeFinancialResponse.setIsInterestOrWithOutInterest(Boolean.TRUE);
					} else {
						employeeFinancialResponse.setIsInterestOrWithOutInterest(Boolean.FALSE);
					}

					/* adding all individual amounts to total amount and to respective object */
					getAllTotalAmounts(employeeFinancialResponse, employeeFinancialServiceInfo);
					
					/* For Interest Letter We need to throw One Exception if Interest Amount is null or 0.0 */
					if("Interest_Letter".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl()) && (Util.isEmptyObject(employeeFinancialResponse.getTotalPendingPenaltyAmount())
						|| 0.0==employeeFinancialResponse.getTotalPendingPenaltyAmount())) {
						throw new InvalidStatusException(Arrays.asList("Interest Amount for the generated Interest Letter is Zero."));
					}
					if("First_Disbursement_Demandnote".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl())) {
						FinancialProjectMileStoneResponse currentOneFinancialProjectMileStoneResp = getMilestoneLastObject(employeeFinancialResponse,isReGenerateDemandNote);
						//loading last milestone details for demand note pdf name
						currentOneFinancialProjectMileStoneInfo = (FinancialProjectMileStoneInfo) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(currentOneFinancialProjectMileStoneResp, FinancialProjectMileStoneInfo.class);
					}
					/* adding customer flatNo, site and milestone name  to Demand Note Pdf File Name */
					setFlatNoAndMileStoneName(employeeFinancialResponse,currentOneFinancialProjectMileStoneInfo, customerPropertyDetailsInfo, MetadataId.BOOKING_FORM_DEMAND_NOTE.getName(),previouseProjectMileStoneResponseList);
				} else {
					employeeFinancialResponse.setFinancialProjectMileStoneResponse(financialProjectMileStoneResponseList);
				}
				//ViewCustomerDataGetInterest
				
				employeeFinancialResponseList.add(employeeFinancialResponse);
			}
		}
		
		List<Object> listOfResp = new ArrayList<>();
		if(!requestUrl.equals("ViewCustomerDataGetInterest")) {//if this request not form mobile app
			if(Util.isNotEmptyObject(employeeFinancialResponseList) && requestFrom.equalsIgnoreCase("GenerateDemandNote")) {//if this request from Generate Demand note service
				for(EmployeeFinancialResponse resp : employeeFinancialResponseList ) {
					if(resp.getFinancialProjectMileStoneResponse()!=null && !resp.getFinancialProjectMileStoneResponse().isEmpty()) {
						for(FinancialProjectMileStoneResponse response : resp.getFinancialProjectMileStoneResponse()) {
			         		if(Util.isEmptyObject(response.getFinBokFomDmdNoteId()) && response.getMilestoneName()!=null && 
			         				!response.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {//if demand note id is null then thorw the exception,
			         			//this is holds demand note location
			         			log.info("Error occurred while saving data into the database plz try again once.");
			         			log.info("\nMilestone demand note id empty \n data is : "+response);
			         			throw new EmployeeFinancialServiceException("Error occurred while saving data into the database plz try again once.");
			         		}
			         	}	
					}
				}	
			}//employeeFinancialResponseList
			
			/* generating demand note */
			fileInfoList = employeeFinancialHelper.demandNoteGenaratorHelper(employeeFinancialResponseList,requestFrom,employeeFinancialServiceInfo,flatPreviousMilestoneNonPaidData);
			
			if(!requestFrom.equalsIgnoreCase("GenerateDemandNote")) {
				FileInfo zipFileInfo = null;
				//create Zip1 file of generated 
				if(Util.isEmptyObject(fileInfoList)) {
					throw new InSufficeientInputException(Arrays.asList("No Demand Note has been generated. Please check Flat and Block Details"));
				}
				zipFileInfo = employeeFinancialHelper.generateZipFile(fileInfoList,employeeFinancialServiceInfo);
				fileInfoList = new ArrayList<>();
				fileInfoList.add(zipFileInfo);
			}
			
			/* sending Mail to customers */
			/* For Interest Letter We need to Change Mail Subject and Body */
			if(requestFrom.equalsIgnoreCase("GenerateDemandNote") && "Interest_Letter".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl())
				&& Util.isNotEmptyObject(employeeFinancialServiceInfo.getCondition()) && employeeFinancialServiceInfo.getCondition().equalsIgnoreCase("sendEmails")) {
				//log.info("not Send Email for "+employeeFinancialServiceInfo.getActionUrl());
				List<EmployeeFinancialTransactionResponse> transactionResponseList = financialMapper.employeeFinancialResponseToFinancialTransactionResponse(employeeFinancialResponseList);
				employeeFinancialHelper.sendFinancialMailToCustomers(transactionResponseList, fileInfoList, MetadataId.INTEREST_LETTER.getName(),flatPreviousMilestoneNonPaidData);			
			}else if(requestFrom.equalsIgnoreCase("GenerateDemandNote") && Util.isNotEmptyObject(employeeFinancialServiceInfo.getCondition()) && employeeFinancialServiceInfo.getCondition().equalsIgnoreCase("sendEmails")) {
				boolean finalDemandNote = "Final_Demand_Note".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl()) && "saveBookingDetails".equalsIgnoreCase(employeeFinancialServiceInfo.getRequestUrl());
				if(employeeFinancialServiceInfo.isSendNotification() && !employeeFinancialServiceInfo.isThisUplaodedData() && !finalDemandNote) {
					List<EmployeeFinancialTransactionResponse> transactionResponseList = financialMapper.employeeFinancialResponseToFinancialTransactionResponse(employeeFinancialResponseList);
					if(transactionResponseList.isEmpty() || fileInfoList.isEmpty()) {
						throw new EmployeeFinancialServiceException("Error occurred while saving data into the database plz try again once.");
					} else if (transactionResponseList.size()!=fileInfoList.size()) {
						throw new EmployeeFinancialServiceException("Error occurred  while saving data into the database plz try again once.");
					}
					employeeFinancialHelper.validateFileAttachementd(transactionResponseList,fileInfoList,flatPreviousMilestoneNonPaidData);
					employeeFinancialHelper.sendFinancialMailToCustomers(transactionResponseList, fileInfoList, MetadataId.BOOKING_FORM_DEMAND_NOTE.getName(),flatPreviousMilestoneNonPaidData);
				}
			}
			listOfResp.add(fileInfoList);
		} else {
			listOfResp.add(employeeFinancialResponseList);
		}
		
		if(requestUrl.equals("ViewCustomerDataGetInterest")) {//if this is the request from mobile side
			ExecutorService executorService = Executors.newFixedThreadPool(2);
			executorService.submit(new Callable<List<Object>>(){
			    public List<Object> call() throws Exception {//loading interest amount
			    	return validatePenaltyCalcultionCompleted(employeeFinancialServiceInfo);
			    }
			});
		}

		return listOfResp;
	}


	private FinancialProjectMileStoneResponse getMilestoneLastObject(EmployeeFinancialResponse employeeFinancialResponse, boolean isReGenerateDemandNote) {
		FinancialProjectMileStoneResponse currentOneFinancialProjectMileStoneResp = null;
		if(Util.isNotEmptyObject(employeeFinancialResponse.getFinancialProjectMileStoneResponse())) {
			if(isReGenerateDemandNote) {
				if(employeeFinancialResponse.getFinancialProjectMileStoneResponse().size()>=2) {
					currentOneFinancialProjectMileStoneResp = employeeFinancialResponse.getFinancialProjectMileStoneResponse().get(employeeFinancialResponse.getFinancialProjectMileStoneResponse().size()-2);
				}
			}else {
				currentOneFinancialProjectMileStoneResp = employeeFinancialResponse.getFinancialProjectMileStoneResponse().get(employeeFinancialResponse.getFinancialProjectMileStoneResponse().size()-1);
			}
		}
		return currentOneFinancialProjectMileStoneResp;
	}

	@Override
	public List<Object> generateDemandNoteAndReplacePDF(EmployeeFinancialServiceInfo employeeFinancialServiceInfo, HashMap<Long, Long> generatedMileStones
			, String requestFrom, Map<Long, List<FinancialProjectMileStonePojo>> customerGeneratedMilestone
			, Map<Long, List<FinancialProjectMileStonePojo>> flatPreviousMilestoneNonPaidData) throws Exception {
		
		return null;
	}

	@Transactional(propagation=Propagation.REQUIRED, rollbackFor=Exception.class)
	@Override
	public void validatePenaltyRecords(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) throws Exception {
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = null;
		if(Util.isEmptyObject(employeeFinancialServiceInfo.getCustomerPropertyDetailsPojoList())) {
			customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			employeeFinancialServiceInfo.setCustomerPropertyDetailsPojoList(customerPropertyDetailsPojoList);
		} else {
			customerPropertyDetailsPojoList = employeeFinancialServiceInfo.getCustomerPropertyDetailsPojoList();
		}
		
		//validating the penalty calculation completed or not, and add 
		validatePenaltyCalcultionCompleted(employeeFinancialServiceInfo);	
	}
	
	/**
	 * This service is calling for single page 
	 * 1. View Interest Breakup in View Customer Date Module
	 * 2. View Interest Report in Module View Interest Paid And Waived Details
	 * 3. Interest Waiver approval page
	 */
	public List<Object> getCustomerFinancialDetails(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getCustomerFinancialDetails() *****");
		String requestUrl = "";
		String actionUrl = "";
		List<EmployeeFinancialResponse> employeeFinancialResponseList = new ArrayList<>();
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = null;
		List<FileInfo> fileInfoList = new ArrayList<>();
		List<Object> listOfResp = new ArrayList<>();
		double getMilestonePaidAmount = 0.0;
		double excessMilestoneBalanceAmount = 0.0;
		
		double getModificationPayAmount = 0.0;
		double getModificationPaidAmount = 0.0;
		double excessModificationBalanceAmount = 0.0;
		double excessLegalBalanceAmount = 0.0;
		double getLegalPaidAmount = 0.0;
		double excessFlatKhataBalanceAmount = 0.0;
		double getFlatKhataPaidAmount = 0.0;
		double getMaintenanceChargePaidAmount = 0.0;
		double excessMaintenanceChargeBalanceAmount = 0.0;
		double getCorpusChargePaidAmount = 0.0;
		double excessCorpusBalanceAmount = 0.0;
		
		FinancialProjectMileStoneInfo financialProjectMileStoneInfo1 = null;
		FinancialProjectMileStoneInfo ms = null;
		EmployeeFinancialResponse employeeFinancialResponse = null;
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;
		List<FinBookingFormAccountsPojo> milestonePaidList = null;
		List<FinBookingFormExcessAmountPojo> listOfPenaltyExcessAmount = null;
		Map<String, Object> mileStoneDetailsList = null;
		List<Map<String, Object>> paymentPaidList = null;
		Map<String, Object> paymentPaid = null;
		List<FinancialProjectMileStoneInfo> listOfMilestone = null;
		List<FinancialProjectMileStonePojo> previouseFinancialProjectMileStonePojoList = null;
		List<FinancialProjectMileStoneResponse> previouseFinancialProjectMileStoneResponseList = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = null;
		List<FinancialProjectMileStoneResponse> financialProjectMileStoneResponseList = null;
		BookingFormRequest bookingFormRequestCopy = null;
		FinancialProjectMileStoneInfo finProjDemandNoteInfo = null;
		/* Getting Current Milestone selected Data */
		getCurrentProjectMilestoneData(employeeFinancialServiceInfo);
		//query.append("  (SELECT NVL(SUM(AMOUNT),0) FROM FIN_TRANSACTION_ENTRY F2 WHERE FB.FLAT_BOOK_ID = F2.BOOKING_FORM_ID AND STATUS_ID = 6 AND FIN_TRANSACTION_TYPE_ID = 3)>0 AND");
		requestUrl = employeeFinancialServiceInfo.getRequestUrl()==null?"":employeeFinancialServiceInfo.getRequestUrl();
		actionUrl = employeeFinancialServiceInfo.getActionUrl()==null?"":employeeFinancialServiceInfo.getActionUrl();
		if(Util.isEmptyObject(employeeFinancialServiceInfo.getCustomerPropertyDetailsPojoList())) {
			customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			employeeFinancialServiceInfo.setCustomerPropertyDetailsPojoList(customerPropertyDetailsPojoList);
		} else {
			customerPropertyDetailsPojoList = employeeFinancialServiceInfo.getCustomerPropertyDetailsPojoList();
		}
		bookingFormRequestCopy = new BookingFormRequest();
		bookingFormRequestCopy.setSiteId(employeeFinancialServiceInfo.getSiteId());
		finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
		finProjDemandNoteInfo.setSiteId(employeeFinancialServiceInfo.getSiteId());
		finProjDemandNoteInfo.setStatusId(Status.ACTIVE.getStatus());
		//loading site other charges details, like corpus fund ,maintennance charges
		List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList = bookingFormServiceDaoImpl.getTheSiteOtherChargesDetails(bookingFormRequestCopy);
		//tax details on like corpus fund ,maintennance charges
		List<FinPenaltyTaxPojo> taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId(),MetadataId.MAINTENANCE_CHARGE.getId(),MetadataId.LEGAL_COST.getId()));
		
		List<Long> paymentTypes = Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId(),MetadataId.PRINCIPAL_AMOUNT.getId(), 
				MetadataId.MODIFICATION_COST.getId(), MetadataId.LEGAL_COST.getId(), MetadataId.FIN_PENALTY.getId()
				,MetadataId.MAINTENANCE_CHARGE.getId(),MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId(),MetadataId.CORPUS_FUND.getId()
				);
		//validating the penalty calculation completed or not
		//validatePenaltyCalcultionCompleted(employeeFinancialServiceInfo);

		for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList) {
			if(Util.isNotEmptyObject(customerPropertyDetailsPojo) && Util.isNotEmptyObject(customerPropertyDetailsPojo.getFlatBookingId())
					&& Util.isNotEmptyObject(customerPropertyDetailsPojo.getPancard())) {
				getMilestonePaidAmount = 0.0;
				excessMilestoneBalanceAmount = 0.0;
				getModificationPayAmount = 0.0;
				getModificationPaidAmount = 0.0;
				excessModificationBalanceAmount = 0.0;
				excessLegalBalanceAmount = 0.0;
				getLegalPaidAmount = 0.0;
				excessFlatKhataBalanceAmount = 0.0;
				getFlatKhataPaidAmount = 0.0;

				getMaintenanceChargePaidAmount = 0.0;
				excessMaintenanceChargeBalanceAmount = 0.0;
				getCorpusChargePaidAmount = 0.0;
				excessCorpusBalanceAmount = 0.0;
				listOfPenaltyExcessAmount = null; ms = null;mileStoneDetailsList = null;
				listOfMilestone = null;previouseFinancialProjectMileStonePojoList = null;
				previouseFinancialProjectMileStoneResponseList = null;
				customerPropertyDetailsInfo = null;customerPropertyDetailsInfo2 = null;
				financialProjectMileStoneResponseList = null; financialProjectMileStoneInfo1 = null;
				//List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;
				listOfPenaltyExcessAmount = new ArrayList<>();
				paymentPaidList = new ArrayList<>();
				paymentPaid = new HashMap<>();
				mileStoneDetailsList = new HashMap<>();
				
				employeeFinancialResponse = new EmployeeFinancialResponse();
				financialProjectMileStoneResponseList = new ArrayList<>();
				
				customerPropertyDetailsInfo = financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
				customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
				
				customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo2.setType(MetadataId.FIN_PENALTY.getId());
				customerPropertyDetailsInfo2.setFlatBookingId(customerPropertyDetailsPojo.getFlatBookingId());
				customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_PENALTY.getName());//loading penalty excess amount
				customerPropertyDetailsInfo2.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());
				bookingFormRequestCopy.setFlatId(customerPropertyDetailsInfo.getFlatId());
				//List<FlatDetailsPojo> flatDetailsPojos = bookingFormServiceDaoImpl.getFlatDetails(bookingFormRequestCopy);
				//List  excessAmountReturnList = null;// new ArrayList<>();
				if(Util.isEmptyObject(listOfPenaltyExcessAmount)) {//listOfPenaltyExcessAmount.isEmpty()
					listOfPenaltyExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2,Arrays.asList(MetadataId.FIN_PENALTY.getId()));
					mileStoneDetailsList.put(MetadataId.FIN_PENALTY.getName(),listOfPenaltyExcessAmount);
				}
				
				financialProjectMileStoneInfo1 = new FinancialProjectMileStoneInfo();
				financialProjectMileStoneInfo1.setCondition(requestUrl);
				financialProjectMileStoneInfo1.setReGenerateDemandNote(true);
				financialProjectMileStoneInfo1.setInterestSelectionType(Status.With_Interest.getStatus());
				//this is for calculating interest data and returning the Excel file
				if(requestUrl.equals("CalculateCustomerInterestBreakUpData") || requestUrl.equalsIgnoreCase("milestoneWiseInterestDetails") || requestUrl.equalsIgnoreCase("GiveInterestWaiverReport")) {
					//taking all the selected milestone id's
					financialProjectMileStoneInfo1.setCurrentprojectMileStoneIds(employeeFinancialServiceInfo.getCurrentprojectMileStoneIds());
					listOfMilestone = new ArrayList<>();
					ms = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size()-1);
					listOfMilestone.add(ms);
					//taking only last milestone for interest calculation, and reseting object
					employeeFinancialServiceInfo.setFinancialProjectMileStoneRequests(listOfMilestone);
				} else  if(requestUrl.equals("ViewCustomerDataGetInterest12")){
					financialProjectMileStoneInfo1.setCurrentprojectMileStoneIds(employeeFinancialServiceInfo.getCurrentprojectMileStoneIds());
					listOfMilestone = new ArrayList<>();
					ms = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size()-1);
					listOfMilestone.add(ms);
					//taking only last milestone for interest calculation, and reseting object
					employeeFinancialServiceInfo.setFinancialProjectMileStoneRequests(listOfMilestone);
				} else {//CalculateCustomerInterestData
					listOfMilestone = new ArrayList<>();
					ms = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().size()-1);
					listOfMilestone.add(ms);
					//taking only last milestone for interest calculation, and reseting object
					employeeFinancialServiceInfo.setFinancialProjectMileStoneRequests(listOfMilestone);
					financialProjectMileStoneInfo1.setProjectMilestoneId(150000l);	
				}
				
				employeeFinancialServiceInfo.setProjectMileStoneIds(Arrays.asList(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getProjectMilestoneId()));
				financialProjectMileStoneInfo1.setPaymentStatus(Arrays.asList(Status.PENDING.getStatus() ,Status.PAID.getStatus(), Status.INPROGRESS.getStatus()));
				financialProjectMileStoneInfo1.setType(Arrays.asList(new Long[] {MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()}));
				//load all previous milestone details
				previouseFinancialProjectMileStonePojoList = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(financialProjectMileStoneInfo1, customerPropertyDetailsInfo,FinEnum.lOAD_DATA);
				double totalInterestAmount = 0d;
				for(FinancialProjectMileStoneInfo currentFinancialProjectMileStoneInfo : employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests()) {
					currentFinancialProjectMileStoneInfo.setInterestCalculationFrom(requestUrl);
					processPenaltyAmount(previouseFinancialProjectMileStonePojoList,currentFinancialProjectMileStoneInfo,totalInterestAmount,"Preview Demand Note","Interest Amount",mileStoneDetailsList);
				}
				
				previouseFinancialProjectMileStoneResponseList = financialMapper.financialProjectMileStonePojoListToFinancialProjectMileStoneResponseList(previouseFinancialProjectMileStonePojoList);
				/* setting all milestones Demand Note individual to List in respective Object */
				if (!previouseFinancialProjectMileStoneResponseList.isEmpty()) {
					financialProjectMileStoneResponseList.addAll(previouseFinancialProjectMileStoneResponseList);
				}
				
				employeeFinancialResponse.setFinancialProjectMileStoneResponse(financialProjectMileStoneResponseList);	
				employeeFinancialResponse.setIsInterestOrWithOutInterest(Boolean.TRUE);
				employeeFinancialResponse.setFlatsResponse(Arrays.asList(customerPropertyDetailsInfo));
				/* adding all individual amounts to total amount and to respective object */
				getAllTotalAmounts(employeeFinancialResponse, employeeFinancialServiceInfo);

				customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo2.setFlatBookingId(customerPropertyDetailsPojo.getFlatBookingId());
				customerPropertyDetailsInfo2.setStatusId(Status.ACTIVE.getStatus());
				//loading sum of paid amoount details
				milestonePaidList = employeeFinancialServiceDao.getSumOfFlatPaidAmountDetails(customerPropertyDetailsInfo2, paymentTypes);
				customerPropertyDetailsInfo2.setCondition("PaymentRefund");
				//loading excess amount if any
				listOfExcessAmount = employeeFinancialServiceDao.getSumOfFlatPaidExcessAmount(customerPropertyDetailsInfo2, paymentTypes);
				//listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo2, paymentTypes);
				if(Util.isNotEmptyObject(listOfExcessAmount)) {
					for (FinBookingFormExcessAmountPojo excessAmountPojo : listOfExcessAmount) {
						if (MetadataId.FIN_BOOKING_FORM_MILESTONES.getId().equals(excessAmountPojo.getType())) {
							excessMilestoneBalanceAmount += excessAmountPojo.getBalanceAmount() ==null? 0d :excessAmountPojo.getBalanceAmount();
						} else if (MetadataId.MODIFICATION_COST.getId().equals(excessAmountPojo.getType())) {
							excessModificationBalanceAmount += excessAmountPojo.getBalanceAmount() ==null? 0d :excessAmountPojo.getBalanceAmount();
						} else if (MetadataId.LEGAL_COST.getId().equals(excessAmountPojo.getType())) {
							excessLegalBalanceAmount += excessAmountPojo.getBalanceAmount() ==null? 0d :excessAmountPojo.getBalanceAmount();
						} else if (MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(excessAmountPojo.getType())) {
							excessFlatKhataBalanceAmount += excessAmountPojo.getBalanceAmount() ==null? 0d :excessAmountPojo.getBalanceAmount();
						} else if (MetadataId.MAINTENANCE_CHARGE.getId().equals(excessAmountPojo.getType())) {
							excessMaintenanceChargeBalanceAmount += excessAmountPojo.getBalanceAmount() ==null? 0d :excessAmountPojo.getBalanceAmount();
						} else if (MetadataId.CORPUS_FUND.getId().equals(excessAmountPojo.getType())) {
							excessCorpusBalanceAmount += excessAmountPojo.getBalanceAmount() ==null? 0d :excessAmountPojo.getBalanceAmount();
						}
					}
				}

				double getLegalPayAmount = getLegalPayAmount(siteOtherChargesDetailsList,taxDetailsList,finProjDemandNoteInfo);
				double getFlatKhataPayAmount = getFlatKhataPayAmount(siteOtherChargesDetailsList,taxDetailsList,finProjDemandNoteInfo);
				double getMaintenanceChargePayAmount = getMaintenanceChargePayAmount(siteOtherChargesDetailsList,taxDetailsList,finProjDemandNoteInfo,null,customerPropertyDetailsInfo);
				double getCorpusChargePayAmount = getCorpusPayAmount(siteOtherChargesDetailsList,taxDetailsList,finProjDemandNoteInfo,null,customerPropertyDetailsInfo);
				
				if (Util.isNotEmptyObject(milestonePaidList)) {
					for (FinBookingFormAccountsPojo pojo : milestonePaidList) {
						if (MetadataId.FIN_BOOKING_FORM_MILESTONES.getId().equals(pojo.getType())) {
							getMilestonePaidAmount += (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());
						} else if (MetadataId.MODIFICATION_COST.getId().equals(pojo.getType())) {
							getModificationPayAmount += (pojo.getPayAmount() == null ? 0 : pojo.getPayAmount());
							getModificationPaidAmount += (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());	
						} else if (MetadataId.LEGAL_COST.getId().equals(pojo.getType())) {
							getLegalPaidAmount += (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());	
						} else if (MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(pojo.getType())) {
							getFlatKhataPaidAmount += (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());	
						} else if (MetadataId.MAINTENANCE_CHARGE.getId().equals(pojo.getType())) {
							getMaintenanceChargePaidAmount += (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());	
						} else if (MetadataId.CORPUS_FUND.getId().equals(pojo.getType())) {
							getCorpusChargePaidAmount += (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());	
						}
					}
				}

				paymentPaid.put("corpusPayAmount", getCorpusChargePayAmount);
				paymentPaid.put("corpusPaidAmount", new BigDecimal(getCorpusChargePaidAmount+excessCorpusBalanceAmount).setScale(roundingModeSize, roundingMode).doubleValue());
				//paymentPaid.put("corpusBalanceAmount", new BigDecimal(getCorpusChargePayAmount-(getCorpusChargePaidAmount+excessCorpusBalanceAmount)).setScale(roundingModeSize, roundingMode).doubleValue());
				
				paymentPaid.put("modificationPayAmount", getModificationPayAmount);
				paymentPaid.put("modificationPaidAmount", new BigDecimal(getModificationPaidAmount+excessModificationBalanceAmount).setScale(roundingModeSize, roundingMode).doubleValue());
				//paymentPaid.put("modificationBalanceAmount", new BigDecimal(getModificationPayAmount-(getModificationPaidAmount+excessModificationBalanceAmount)).setScale(roundingModeSize, roundingMode).doubleValue());
				
				paymentPaid.put("legalPayAmount", getLegalPayAmount);
				paymentPaid.put("legalPaidAmount", new BigDecimal(getLegalPaidAmount+excessLegalBalanceAmount).setScale(roundingModeSize, roundingMode).doubleValue());
				//paymentPaid.put("legalBalanceAmount", new BigDecimal(getLegalPayAmount-(getLegalPaidAmount+excessLegalBalanceAmount)).setScale(roundingModeSize, roundingMode).doubleValue());
				
				paymentPaid.put("flatKhataPayAmount", getFlatKhataPayAmount);
				paymentPaid.put("flatKhataPaidAmount", new BigDecimal(getFlatKhataPaidAmount+excessFlatKhataBalanceAmount).setScale(roundingModeSize, roundingMode).doubleValue());
				//paymentPaid.put("flatKhataBalanceAmount", new BigDecimal(getFlatKhataPayAmount-(getFlatKhataPaidAmount+excessFlatKhataBalanceAmount)).setScale(roundingModeSize, roundingMode).doubleValue());
				
				paymentPaid.put("maintenanceChargePayAmount", getMaintenanceChargePayAmount);
				paymentPaid.put("maintenanceChargePaidAmount", new BigDecimal(getMaintenanceChargePaidAmount+excessMaintenanceChargeBalanceAmount).setScale(roundingModeSize, roundingMode).doubleValue());
				//paymentPaid.put("maintenanceChargeBalanceAmount", new BigDecimal(getMaintenanceChargePayAmount-(getMaintenanceChargePaidAmount+excessMaintenanceChargeBalanceAmount)).setScale(roundingModeSize, roundingMode).doubleValue());
				
				System.out.println(paymentPaid);
				paymentPaidList.add(paymentPaid);
				getMilestonePaidAmount += excessMilestoneBalanceAmount;
				employeeFinancialResponse.setTotalPaidAmount(getMilestonePaidAmount);
				employeeFinancialResponse.setPaymentPaidList(paymentPaidList);
				employeeFinancialResponseList.add(employeeFinancialResponse);
				
			}//condition
		}//For loop customerPropertyDetailsPojo
		
		if(requestUrl.equals("GiveInterestWaiverReport") && actionUrl.equals("InterestWaiverRequest")) {
			listOfResp.add(employeeFinancialResponseList);
			return listOfResp;
		}
		
		/*if(!requestUrl.equals("ViewCustomerDataGetInterest") && !requestUrl.equals("CalculateCustomerInterestBreakUpData")) {//
			fileInfoList = employeeFinancialHelper.demandNoteInterestExcelGenaratorHelper(employeeFinancialResponseList,employeeFinancialServiceInfo,employeeFinancialServiceDao,bookingFormServiceDaoImpl);	
			listOfResp.add(fileInfoList);
		} else*/ 
		
		if(requestUrl.equals("CalculateCustomerInterestBreakUpData")) {
			//comment this line before moving live, not in use
			//fileInfoList = employeeFinancialHelper.demandNoteInterestExcelGenaratorHelper(employeeFinancialResponseList,employeeFinancialServiceInfo);
			Map<String,List<Map<String,Object>>> dataForPdf1 = new HashMap<>();
			List<Map<String,Object>> dataForPdf = new ArrayList<>();
			
			double sumOfTotalAmount = 0d;
			double sumOfPaidAMount = 0d;
			double sumOfPendingAmount = 0d;
			
			for (EmployeeFinancialResponse resp : employeeFinancialResponseList) {
				if (Util.isNotEmptyObject(resp.getFinancialProjectMileStoneResponse()) && Util.isNotEmptyObject(resp.getFinancialProjectMileStoneResponse().get(0).getPenaltyStatisticsPojos())) {
					for (FinancialProjectMileStoneResponse mileStoneResponse : resp.getFinancialProjectMileStoneResponse()) {
						//rowCount++;
							double lastPaidAmount = 0d;
							double totalInterestAmount = 0d;
							double totalInterestPendingAmount = mileStoneResponse.getTotalPendingPenaltyAmount()==null?0d:mileStoneResponse.getTotalPendingPenaltyAmount();
							double totalInterestWaiverAmount = mileStoneResponse.getInterestWaiverAdjAmount()==null?0d:mileStoneResponse.getInterestWaiverAdjAmount();
							double totalPaidAmount = mileStoneResponse.getTotalPenalityPaidAmount() == null ?0d:mileStoneResponse.getTotalPenalityPaidAmount();
							totalPaidAmount += totalInterestWaiverAmount;
							long iterationCompleted = 0l;
							if(totalPaidAmount==0 && totalInterestPendingAmount == 0) {
								continue;
							}
							if(mileStoneResponse.getPenaltyStatisticsPojos()!=null) {
									
							for (FinPenaltyStatisticsPojo penaltyStatisticsPojo : mileStoneResponse.getPenaltyStatisticsPojos()) {
								Map<String,Object> closingBalanceReport = new HashMap<String,Object>();
								

								if(iterationCompleted==0) {
									if(penaltyStatisticsPojo.getInterestCalculationOnAmount() !=null
											&& mileStoneResponse.getMileStoneBasicAmount()!=null 
											&& penaltyStatisticsPojo.getInterestCalculationOnAmount().intValue() != mileStoneResponse.getMileStoneBasicAmount().intValue() ) {
										lastPaidAmount =  mileStoneResponse.getMileStoneBasicAmount();
									}else {
										lastPaidAmount = penaltyStatisticsPojo.getInterestCalculationOnAmount();
									}
								}
								closingBalanceReport.put("milestoneNo",mileStoneResponse.getMileStoneNo());
								closingBalanceReport.put("milestoneName",mileStoneResponse.getMilestoneName());
								closingBalanceReport.put("demandNoteDate",mileStoneResponse.getDemandNoteDate());
								closingBalanceReport.put("demandNoteDueDate", mileStoneResponse.getMileStoneDueDate());
								
								closingBalanceReport.put("demandNoteBasicAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(mileStoneResponse.getMileStoneBasicAmount()).setScale(roundingModeSize, roundingMode).toString()));
								
								double currentPaid = penaltyStatisticsPojo.getInterestCalculationOnAmount(); 
								double currPayAmt = lastPaidAmount- currentPaid;
								//cell.setCellValue(penaltyStatisticsPojo.getMileStonePaidBasicAmount()==null?0d:penaltyStatisticsPojo.getMileStonePaidBasicAmount());
								/*if(lastPaidAmount==currentPaid) {
									
								}*/
								
								closingBalanceReport.put("paidBasicAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(Math.abs(currPayAmt)).setScale(roundingModeSize, roundingMode).toString()));
								if(penaltyStatisticsPojo.getMileStonePaidDate()!=null) {
									closingBalanceReport.put("milestonePaidDate", penaltyStatisticsPojo.getMileStonePaidDate());
								}else {
									closingBalanceReport.put("milestonePaidDate","");
								}
								//closingBalanceReport.put("",mileStoneResponse.getMileStoneBasicAmount()-penaltyStatisticsPojo.getInterestCalculationOnAmount());
								
								closingBalanceReport.put("interestCalculationOnAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(penaltyStatisticsPojo.getInterestCalculationOnAmount()).setScale(roundingModeSize, roundingMode).toString()));
								lastPaidAmount = penaltyStatisticsPojo.getInterestCalculationOnAmount();
								if(penaltyStatisticsPojo.getStartDate()!=null) {
									closingBalanceReport.put("startDate", penaltyStatisticsPojo.getStartDate());
								}else {
									closingBalanceReport.put("startDate","");
								}	
								if(penaltyStatisticsPojo.getEndDate()!=null) {
									closingBalanceReport.put("endDate",penaltyStatisticsPojo.getEndDate());
								}else {
									closingBalanceReport.put("endDate","");
								}
								closingBalanceReport.put("daysDifference",penaltyStatisticsPojo.getDaysDifference()==null?0l:penaltyStatisticsPojo.getDaysDifference());
								
								closingBalanceReport.put("interestAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(penaltyStatisticsPojo.getPenaltyAmount()==null?0d: penaltyStatisticsPojo.getPenaltyAmount()).setScale(roundingModeSize, roundingMode).toString()));
								
								closingBalanceReport.put("gstAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(penaltyStatisticsPojo.getPenaltyTaxAmount()==null?0d: penaltyStatisticsPojo.getPenaltyTaxAmount()).setScale(roundingModeSize, roundingMode).toString()));
								double interestAmount = penaltyStatisticsPojo.getPenaltyAmount()+penaltyStatisticsPojo.getPenaltyTaxAmount();
								closingBalanceReport.put("interestTotalAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(interestAmount).setScale(roundingModeSize, roundingMode).toString()));
								totalInterestAmount += roundOffAmount(interestAmount);
								
								closingBalanceReport.put("interestPercentage",penaltyStatisticsPojo.getInterestPercentage()==null?0d:penaltyStatisticsPojo.getInterestPercentage());
								dataForPdf.add(closingBalanceReport);

								iterationCompleted++;
							}
							
							Map<String,Object> closingBalanceReport = new HashMap<String,Object>();
							/*closingBalanceReport.put("milestoneNo", "");
							closingBalanceReport.put("milestoneName", "");
							closingBalanceReport.put("demandNoteDate", "");
							closingBalanceReport.put("demandNoteDueDate","");
							closingBalanceReport.put("demandNoteBasicAmount","");
							closingBalanceReport.put("paidBasicAmount","");
							closingBalanceReport.put("milestonePaidDate","");
							closingBalanceReport.put("interestCalculationOnAmount","");
							closingBalanceReport.put("startDate","");
							closingBalanceReport.put("endDate","");
							closingBalanceReport.put("daysDifference","");
							closingBalanceReport.put("interestAmount","");*/
							closingBalanceReport.put("gstAmount","Total Amount");
							closingBalanceReport.put("interestTotalAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(totalInterestAmount).setScale(roundingModeSize, roundingMode).toString()));
							//closingBalanceReport.put("interestPercentage","");
							dataForPdf.add(closingBalanceReport);
							sumOfTotalAmount += roundOffAmount(totalInterestAmount);
							
							double paidAmount = totalPaidAmount;
							Map<String,Object> closingBalanceReport2 = new HashMap<String,Object>();
							closingBalanceReport2.put("gstAmount","Paid Amount");
							closingBalanceReport2.put("interestTotalAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(paidAmount).setScale(roundingModeSize, roundingMode).toString()));
							dataForPdf.add(closingBalanceReport2);
							sumOfPaidAMount +=  paidAmount;
							
							double pendingAmout = roundOffAmount(totalInterestAmount-paidAmount);
							Map<String,Object> closingBalanceReport3 = new HashMap<String,Object>();
							closingBalanceReport3.put("gstAmount","Pending Amount");
							closingBalanceReport3.put("interestTotalAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(pendingAmout).setScale(roundingModeSize, roundingMode).toString()));
							dataForPdf.add(closingBalanceReport3);
							sumOfPendingAmount += pendingAmout;
							
							Map<String,Object> closingBalanceReport4 = new HashMap<String,Object>();
							/*closingBalanceReport4.put("milestoneNo", "");
							closingBalanceReport4.put("milestoneName", "");
							closingBalanceReport4.put("demandNoteDate", "");
							closingBalanceReport4.put("demandNoteDueDate","");
							closingBalanceReport4.put("demandNoteBasicAmount","");
							closingBalanceReport4.put("paidBasicAmount","");
							closingBalanceReport4.put("milestonePaidDate","");
							closingBalanceReport4.put("interestCalculationOnAmount","");
							closingBalanceReport4.put("startDate","");
							closingBalanceReport4.put("endDate","");
							closingBalanceReport4.put("daysDifference","");
							closingBalanceReport4.put("interestAmount","");
							closingBalanceReport4.put("gstAmount","");
							closingBalanceReport4.put("interestTotalAmount","");
							closingBalanceReport4.put("interestPercentage","");*/
							dataForPdf.add(closingBalanceReport4);
							
						}//mileStoneResponse.getPenaltyStatisticsPojos()
							
					}//end of milestone
					
				}
			}
			if(!dataForPdf.isEmpty()) {
				Map<String,Object> closingBalanceReport = new HashMap<String,Object>();
				closingBalanceReport.put("gstAmount","Sum of Total Amount");
				closingBalanceReport.put("interestTotalAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(sumOfTotalAmount).setScale(roundingModeSize, roundingMode).toString()));
				dataForPdf.add(closingBalanceReport);
				
				Map<String,Object> closingBalanceReport2 = new HashMap<String,Object>();
				closingBalanceReport2.put("gstAmount","Sum of Paid Amount");
				closingBalanceReport2.put("interestTotalAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(sumOfPaidAMount).setScale(roundingModeSize, roundingMode).toString()));
				dataForPdf.add(closingBalanceReport2);
			
				Map<String,Object> closingBalanceReport3 = new HashMap<String,Object>();
				closingBalanceReport3.put("gstAmount","Sum of Pending Amount");
				closingBalanceReport3.put("interestTotalAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(sumOfPendingAmount).setScale(roundingModeSize, roundingMode).toString()));
				dataForPdf.add(closingBalanceReport3);
			}
			
			dataForPdf1.put("interestBreakUpDate", dataForPdf);
			listOfResp.add(dataForPdf);
		} else {
			fileInfoList = employeeFinancialHelper.demandNoteInterestExcelGenaratorHelper(employeeFinancialResponseList,employeeFinancialServiceInfo,employeeFinancialServiceDao,bookingFormServiceDaoImpl);	
			listOfResp.add(fileInfoList);
		}
		
		//validatePenaltyCalcultionCompleted(employeeFinancialServiceInfo);
		
		return listOfResp;
	}
	
	private double getCorpusPayAmount(List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList,
			List<FinPenaltyTaxPojo> taxDetailsList, FinancialProjectMileStoneInfo finProjDemandNoteInfo,
			List<FlatDetailsPojo> flatDetailsPojos1, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) {
		double flatcorpusPaidAmountAndDocumentationChargesAmt = 0.0;
		double flatcorpusPaidAmountCostGstAmount = 0.0;
		double totalcorpusPaidAmountCostToPay = 0.0;
		SiteOtherChargesDetailsPojo siteOtherChargesDetailsPojo = getSiteOtherChargesDetailsObject(siteOtherChargesDetailsList,MetadataId.CORPUS_FUND.getId());
		//FinPenaltyTaxPojo finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,MetadataId.CORPUS_FUND.getId());
			
			//taking principal amount from master tables
			if (MetadataId.CORPUS_FUND.getId().equals(siteOtherChargesDetailsPojo.getMeteDataTypeId())) {
				//maintenanceAmount = other.getAmount();
				if(customerPropertyDetailsInfo.getSiteId().equals(131l)) {
					flatcorpusPaidAmountAndDocumentationChargesAmt = siteOtherChargesDetailsPojo.getAmount();
				} else {
					//flatcorpusPaidAmountAndDocumentationChargesAmt = flatDetailsPojos.get(0).getSbua() * siteOtherChargesDetailsPojo.getAmount();
					flatcorpusPaidAmountAndDocumentationChargesAmt = customerPropertyDetailsInfo.getSbua() * siteOtherChargesDetailsPojo.getAmount();
				}
			}
			
			/*if(finTaxPojo == null) {
				throw new EmployeeFinancialServiceException(Arrays.asList("Please add corpus charges GST percentage..."));
			}*/
			//calculating GST amount on principal amounr
			flatcorpusPaidAmountCostGstAmount =  0.0;//(flatMaintainanceAndDocumentationChargesAmt * finTaxPojo.getPercentageValue()) / 100;
			totalcorpusPaidAmountCostToPay = flatcorpusPaidAmountAndDocumentationChargesAmt+flatcorpusPaidAmountCostGstAmount;

			totalcorpusPaidAmountCostToPay = roundOffAmount(totalcorpusPaidAmountCostToPay);

		return totalcorpusPaidAmountCostToPay;
	}

	private double getMaintenanceChargePayAmount(List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList,
			List<FinPenaltyTaxPojo> taxDetailsList, FinancialProjectMileStoneInfo finProjDemandNoteInfo, List<FlatDetailsPojo> flatDetailsPojos1
			, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) throws Exception {
		
		Properties prop = responceCodesUtil.getApplicationProperties();
		SimpleDateFormat format = new SimpleDateFormat("dd-MM-yyyy");
		
		Timestamp startDate = null;
		Timestamp endDateForMaintencenDate = null;

		/*if(customerPropertyDetailsInfo.getSiteId().equals(111l)) {
			startDate = new Timestamp(format.parse("01-02-2022").getTime());
			endDateForMaintencenDate = new Timestamp(format.parse("31-01-2023").getTime());			
			startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
			endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());
		} else if(customerPropertyDetailsInfo.getSiteId().equals(107l)) {
			startDate = new Timestamp(format.parse("01-03-2022").getTime());
			endDateForMaintencenDate = new Timestamp(format.parse("28-02-2023").getTime());
			startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
			endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());			
		}*/
		
		if(Util.isNotEmptyObject(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE"))) {
			startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
		}
		if(Util.isNotEmptyObject(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE"))) {
			endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());
		}
		
		Timestamp bookingDate = customerPropertyDetailsInfo.getBookingDate();
		
		double flatMaintainanceAndDocumentationChargesAmt = 0.0;
		double flatMaintainanceCostGstAmount = 0.0;
		double totalMaintainanceCostToPay = 0.0;
		SiteOtherChargesDetailsPojo siteOtherChargesDetailsPojo = getSiteOtherChargesDetailsObject(siteOtherChargesDetailsList,MetadataId.MAINTENANCE_CHARGE.getId());
		FinPenaltyTaxPojo finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,MetadataId.MAINTENANCE_CHARGE.getId());
		if (finTaxPojo == null) {
			finProjDemandNoteInfo.setCondition("");//not adding any condition, so taking current date gst percentages
			taxDetailsList.addAll(employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.MAINTENANCE_CHARGE.getId())));
			finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,MetadataId.MAINTENANCE_CHARGE.getId());
		}
		
		//taking principal amount from master tables
		if (MetadataId.MAINTENANCE_CHARGE.getId().equals(siteOtherChargesDetailsPojo.getMeteDataTypeId())) {
			//maintenanceAmount = other.getAmount();flatDetailsPojos.get(0).getSbua()
			flatMaintainanceAndDocumentationChargesAmt = customerPropertyDetailsInfo.getSbua() * siteOtherChargesDetailsPojo.getAmount();
		}
		
		if(finTaxPojo == null) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add maintenance charges GST percentage..."));
		}
		//calculating GST amount on principal amounr
		flatMaintainanceCostGstAmount =  (flatMaintainanceAndDocumentationChargesAmt * finTaxPojo.getPercentageValue()) / 100;
		totalMaintainanceCostToPay = flatMaintainanceAndDocumentationChargesAmt+flatMaintainanceCostGstAmount;
		
		List<FlatDetailsPojo> flatDetailsPojos = new ArrayList<>();
		FlatDetailsPojo f1 = new FlatDetailsPojo();
		f1.setSbua(customerPropertyDetailsInfo.getSbua().doubleValue());
		flatDetailsPojos.add(f1);
		//Bounce
		if(bookingDate!=null && startDate !=null) {
			if(bookingDate.after(startDate) || bookingDate.equals(startDate)) {//if booking date is after the start date then only enter to condition
				totalMaintainanceCostToPay = bookingFormServiceImpl.getTotalMaintainanceCostToPay(startDate,endDateForMaintencenDate,customerPropertyDetailsInfo,flatDetailsPojos,finTaxPojo,siteOtherChargesDetailsPojo).get("totalMaintainanceCostToPay");
			}
		}
		
		totalMaintainanceCostToPay = roundOffAmount(totalMaintainanceCostToPay);
		return totalMaintainanceCostToPay;
	}

	private double getFlatKhataPayAmount(List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList,
			List<FinPenaltyTaxPojo> taxDetailsList, FinancialProjectMileStoneInfo finProjDemandNoteInfo) throws EmployeeFinancialServiceException {
		double flatFlatKhataAndDocumentationChargesAmt = 0.0;
		double flatFlatKhataCostGstAmount = 0.0;
		double totalFlatKhataCostToPay = 0.0;
		SiteOtherChargesDetailsPojo siteOtherChargesDetailsPojo = getSiteOtherChargesDetailsObject(siteOtherChargesDetailsList,MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId());
		FinPenaltyTaxPojo finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId());
		if (finTaxPojo == null) {
			finProjDemandNoteInfo.setCondition("");//not adding any condition, so taking current date gst percentages
			taxDetailsList.addAll(employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId())));
			finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId());
		}
		
		//taking principal amount from master tables
		if (MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(siteOtherChargesDetailsPojo.getMeteDataTypeId())) {
			//maintenanceAmount = other.getAmount();
			flatFlatKhataAndDocumentationChargesAmt = siteOtherChargesDetailsPojo.getAmount();
		}
		
		if(finTaxPojo == null) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add flat khata charges GST percentage..."));
		}
		//calculating GST amount on principal amount
		flatFlatKhataCostGstAmount =  (flatFlatKhataAndDocumentationChargesAmt * finTaxPojo.getPercentageValue()) / 100;
		totalFlatKhataCostToPay = flatFlatKhataAndDocumentationChargesAmt+flatFlatKhataCostGstAmount;
		
		return totalFlatKhataCostToPay;
	}

	private double getLegalPayAmount(List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList,
			List<FinPenaltyTaxPojo> taxDetailsList, FinancialProjectMileStoneInfo finProjDemandNoteInfo) throws EmployeeFinancialServiceException {
		double flatLegalAndDocumentationChargesAmt = 0.0;
		double flatLegalCostGstAmount = 0.0;
		double totalLegalCostToPay = 0.0;
		SiteOtherChargesDetailsPojo siteOtherChargesDetailsPojo = getSiteOtherChargesDetailsObject(siteOtherChargesDetailsList,MetadataId.LEGAL_COST.getId());
		FinPenaltyTaxPojo finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,MetadataId.LEGAL_COST.getId());
		if (finTaxPojo == null) {
			finProjDemandNoteInfo.setCondition("");//not adding any condition, so taking current date gst percentages
			taxDetailsList.addAll(employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.LEGAL_COST.getId())));
			finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,MetadataId.LEGAL_COST.getId());
		}
		
		/*FinancialProjectMileStonePojo pojo = new FinancialProjectMileStonePojo();//need to load generate inovice time, gst percentage for legal charges 
		  employeeFinancialServiceDao.getLegalCostDetails(pojo);*/
		//taking principal amount from master tables
		if (MetadataId.LEGAL_COST.getId().equals(siteOtherChargesDetailsPojo.getMeteDataTypeId())) {
			//maintenanceAmount = other.getAmount();
			flatLegalAndDocumentationChargesAmt =  siteOtherChargesDetailsPojo.getAmount();
		}
		if (finTaxPojo == null) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add legal charges GST percentage..."));
		}
		//calculating GST amount on principal amounr
		flatLegalCostGstAmount =  (flatLegalAndDocumentationChargesAmt * finTaxPojo.getPercentageValue()) / 100;
		totalLegalCostToPay = flatLegalAndDocumentationChargesAmt+flatLegalCostGstAmount;

		return totalLegalCostToPay;
	}

	public SiteOtherChargesDetailsPojo getSiteOtherChargesDetailsObject(List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList, Long type) {
		for (SiteOtherChargesDetailsPojo siteOtherChargesDetailsPojo : siteOtherChargesDetailsList) {
			if(type.equals(siteOtherChargesDetailsPojo.getMeteDataTypeId())) {
				return siteOtherChargesDetailsPojo;
			}
		}
		return null;
	}

	
	/*@Override
	public void loadLastApprovedWaiverAmount(List<DemandNoteGeneratorInfo> demandNoteGeneratorInfoList) {
		
	}*/

	private void getCurrentProjectMilestoneData(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) {
		List<Long> currentprojectMileStoneIds = new ArrayList<>();
		//itereating all the selected milestone and taking selected miletone id's
		for(FinancialProjectMileStoneInfo financialProjectMilestoneInfo : employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests()) {
			currentprojectMileStoneIds.add(financialProjectMilestoneInfo.getProjectMilestoneId());
		}
		employeeFinancialServiceInfo.setCurrentprojectMileStoneIds(currentprojectMileStoneIds);
	}
	
	private static Map<Long,List<FinancialProjectMileStonePojo>> maplastMilestoneObjectPojoList = new HashMap<Long,List<FinancialProjectMileStonePojo>>();
	private void loadMilestoneData(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) throws Exception {
		double sumOfDemandNotePercentage = 0;
		long finMilestoneClassifidesId = 0;
		FinancialProjectMileStonePojo lastMilestoneObject = null;
		List<FinancialProjectMileStoneInfo> acutualMilestoneData = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests();
		List<FinancialProjectMileStoneInfo> changedMilestoneData = new ArrayList<>();
		finMilestoneClassifidesId = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getFinMilestoneClassifidesId();
		employeeFinancialServiceInfo.setFinMilestoneClassifidesId(finMilestoneClassifidesId);
		//loading last milestone object for final demand note purpose
		List<FinancialProjectMileStonePojo> lastMilestoneObjectPojoList = null;
		if( Util.isNotEmptyObject(finMilestoneClassifidesId) && maplastMilestoneObjectPojoList.containsKey(finMilestoneClassifidesId)) {
			lastMilestoneObjectPojoList = maplastMilestoneObjectPojoList.get(finMilestoneClassifidesId);
		} else {
			 lastMilestoneObjectPojoList = employeeFinancialServiceDao.getLastMilestoneDetails(employeeFinancialServiceInfo, Status.ACTIVE,"generateDemandNote");
			 maplastMilestoneObjectPojoList.put(finMilestoneClassifidesId,lastMilestoneObjectPojoList);
		}
		
		//loading the milestone details
		List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList = employeeFinancialServiceDao.getMileStoneNameAssociatedWithMilestoneClassifidesIdForDemandNote(employeeFinancialServiceInfo, Status.ACTIVE,"");
		if(Util.isNotEmptyObject(lastMilestoneObjectPojoList)) {
			lastMilestoneObject = lastMilestoneObjectPojoList.get(lastMilestoneObjectPojoList.size()-1);
		}
		for (FinancialProjectMileStonePojo financialProjectMileStonePojo : financialProjectMileStonePojoList) {
				
				System.out.println(financialProjectMileStonePojo.getStatusName()+" - "+financialProjectMileStonePojo.getMileStoneNo());
				FinancialProjectMileStoneInfo mileStoneInfo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(financialProjectMileStonePojo, FinancialProjectMileStoneInfo.class);
			 
				mileStoneInfo.setDemandNoteDate(financialProjectMileStonePojo.getMasterDemandNotedate());
				mileStoneInfo.setMileStoneDueDate(financialProjectMileStonePojo.getMasterDemandDueDate());
				
				mileStoneInfo.setMasterDemandNotedate(financialProjectMileStonePojo.getMasterDemandNotedate());
				mileStoneInfo.setMasterDemandDueDate(financialProjectMileStonePojo.getMasterDemandDueDate());
				
				mileStoneInfo.setInterestSelectionType(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getInterestSelectionType());
				mileStoneInfo.setDemandNoteSelectionType(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getDemandNoteSelectionType());
				mileStoneInfo.setReGenerateDemandNote(employeeFinancialServiceInfo.isReGenerateDemandNote());
				mileStoneInfo.setThisUplaodedData(employeeFinancialServiceInfo.isThisUplaodedData());
				mileStoneInfo.setShowGstInPDF(employeeFinancialServiceInfo.isShowGstInPDF());
				mileStoneInfo.setCreatedBy(employeeFinancialServiceInfo.getEmpId());
				mileStoneInfo.setStatusId(Status.ACTIVE.getStatus());
				mileStoneInfo.setSiteId(employeeFinancialServiceInfo.getSiteId());
				
				if(Util.isEmptyObject(mileStoneInfo.getMilestoneDate())) {
					mileStoneInfo.setMilestoneDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getMilestoneDate());
				}//don't move to live, keep in CUG
				if(Util.isEmptyObject(mileStoneInfo.getDemandNoteDate()) && Util.isEmptyObject(financialProjectMileStonePojo.getMasterDemandNotedate())
						&& Status.MS_COMPLETED.getDescription().equals(financialProjectMileStonePojo.getStatusName())) {
					//System.out.println("EmployeeFinancialServiceImpl.loadMilestoneData()");
					//if milestone status is completed, but master dates are not available then taken last milestone demand note date, which is selected in front end
					if(financialProjectMileStonePojo.getMileStoneNo()!=1 && financialProjectMileStonePojo.getMileStoneNo()!=2) {
						//enable this if u want last selected milestone date to previous milestones
						//mileStoneInfo.setDemandNoteDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getDemandNoteDate());
					}
				}
				if(Util.isEmptyObject(mileStoneInfo.getMileStoneDueDate()) && Util.isEmptyObject(financialProjectMileStonePojo.getMasterDemandDueDate()) 
						&& Status.MS_COMPLETED.getDescription().equals(financialProjectMileStonePojo.getStatusName())) {
					//System.out.println("EmployeeFinancialServiceImpl.loadMilestoneData()");
					//if milestone status is completed, but master dates are not available then taken last milestone demand note due date, which is selected in front end
					if(financialProjectMileStonePojo.getMileStoneNo()!=1 && financialProjectMileStonePojo.getMileStoneNo()!=2) {
						//enable this if u want last selected milestone date to previous milestones
						//mileStoneInfo.setMileStoneDueDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getMileStoneDueDate());
					}
				}
				//if the milestone status is not completed, add that milestone object id to CurrentprojectMileStoneIds
				if(financialProjectMileStonePojo.getStatusName()!=null && !financialProjectMileStonePojo.getStatusName().equals(Status.MS_COMPLETED.getDescription())) {
					employeeFinancialServiceInfo.getCurrentprojectMileStoneIds().add(financialProjectMileStonePojo.getProjectMilestoneId());
					
					if(Util.isEmptyObject(mileStoneInfo.getDemandNoteDate())) {
						mileStoneInfo.setDemandNoteDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getDemandNoteDate());
					}

					if(Util.isEmptyObject(mileStoneInfo.getMileStoneDueDate())) {
						mileStoneInfo.setMileStoneDueDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getMileStoneDueDate());
					}
					//need to check this line is to uncomment,new added lines
					/*mileStoneInfo.setMasterDemandNotedate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getDemandNoteDate());
					mileStoneInfo.setMasterDemandDueDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getMileStoneDueDate());*/
					
				}
				
			changedMilestoneData.add(mileStoneInfo);
		}
		changedMilestoneData.addAll(acutualMilestoneData);//acutualMilestoneData this object contains last ms details
		if (employeeFinancialServiceInfo.isThisUplaodedData() && changedMilestoneData!=null) {
			if(employeeFinancialServiceInfo.getDataUploadCondition()!=null && employeeFinancialServiceInfo.getDataUploadCondition().contains("LoadALL_MS")) {
				employeeFinancialServiceInfo.setFinancialProjectMileStoneRequests(changedMilestoneData);
			}
			for (FinancialProjectMileStoneInfo finProjDemandNoteInfo : changedMilestoneData) {
				if(lastMilestoneObject!=null  && lastMilestoneObject.getProjectMilestoneId().equals(finProjDemandNoteInfo.getProjectMilestoneId())) {
					employeeFinancialServiceInfo.setActionUrl("Final_Demand_Note");//upload time need to check
				}
				//if(finProjDemandNoteInfo.getMilestoneName()!=null && !finProjDemandNoteInfo.getMilestoneName().equals("Dummy MileStone for Regenerate Demand Note")) {
					sumOfDemandNotePercentage += finProjDemandNoteInfo.getMileStonePercentage()==null?0d:finProjDemandNoteInfo.getMileStonePercentage();
					if(finProjDemandNoteInfo.getInterestCalculationUptoDate()==null && finProjDemandNoteInfo.getDemandNoteDate()!=null) {
						finProjDemandNoteInfo.setInterestCalculationUptoDate(finProjDemandNoteInfo.getDemandNoteDate());
					}
				//}
			}
		} else {
			employeeFinancialServiceInfo.setFinancialProjectMileStoneRequests(changedMilestoneData);
			boolean isThisFinalDemandNote = "Final_Demand_Note".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl());
			for (FinancialProjectMileStoneInfo finProjDemandNoteInfo : employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests()) {
				if(!isThisFinalDemandNote && lastMilestoneObject!=null  && lastMilestoneObject.getProjectMilestoneId().equals(finProjDemandNoteInfo.getProjectMilestoneId())) {
					if(!"saveBookingDetails".equalsIgnoreCase(employeeFinancialServiceInfo.getRequestUrl())) {
						//if request not from saveBookingDetails, then assign final demand note value to generate Demand note
						employeeFinancialServiceInfo.setActionUrl("Final_Demand_Note");
					}
				}
				if(finProjDemandNoteInfo.getMilestoneName()!=null && !finProjDemandNoteInfo.getMilestoneName().equals("Dummy MileStone for Regenerate Demand Note")) {
					sumOfDemandNotePercentage += finProjDemandNoteInfo.getMileStonePercentage()==null?0d:finProjDemandNoteInfo.getMileStonePercentage();
				}
			}
		}
		
		employeeFinancialServiceInfo.setSumOfDemandNotePercentage(sumOfDemandNotePercentage);
	}
	
	public void loadMilestoneMasterData(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) throws Exception{
		double sumOfDemandNotePercentage = 0;
		List<FinancialProjectMileStoneInfo> acutualMilestoneData = employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests();
		List<FinancialProjectMileStoneInfo> changedMilestoneData = new ArrayList<>();

		employeeFinancialServiceInfo.setFinMilestoneClassifidesId(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getFinMilestoneClassifidesId());
		List<FinancialProjectMileStonePojo> financialProjectMileStonePojoList = employeeFinancialServiceDao.getMileStoneNameAssociatedWithMilestoneClassifidesIdForDemandNote(employeeFinancialServiceInfo, Status.ACTIVE,"");
		if(Util.isEmptyObject(financialProjectMileStonePojoList)) {
			log.info("Failed to load milestone data"+employeeFinancialServiceInfo.getProjectMileStoneIds());
			throw new EmployeeFinancialServiceException(Arrays.asList("Failed to load milestone data"));
		} else if(financialProjectMileStonePojoList.size()>1) {
			log.info("Failed to load milestone data Size Issue"+employeeFinancialServiceInfo.getProjectMileStoneIds());
			throw new EmployeeFinancialServiceException(Arrays.asList("Failed to load milestone data"));
		}
		
		FinancialProjectMileStonePojo financialProjectMileStonePojo1 =  financialProjectMileStonePojoList.get(0);
		if(Util.isNotEmptyObject(financialProjectMileStonePojo1)) {
			employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).setDemandNoteDate(financialProjectMileStonePojo1.getMasterDemandNotedate());
			employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).setMileStoneDueDate(financialProjectMileStonePojo1.getMasterDemandDueDate());
			return;
		}
		
		for (FinancialProjectMileStonePojo financialProjectMileStonePojo : financialProjectMileStonePojoList) {
			System.out.println(financialProjectMileStonePojo.getStatusName());
			FinancialProjectMileStoneInfo mileStoneInfo = financialMapper.copyPropertiesFromInfoBeanToPojoBean(financialProjectMileStonePojo, FinancialProjectMileStoneInfo.class);
			 
				mileStoneInfo.setDemandNoteDate(financialProjectMileStonePojo.getMasterDemandNotedate());
				mileStoneInfo.setMileStoneDueDate(financialProjectMileStonePojo.getMasterDemandDueDate());
				
				mileStoneInfo.setMasterDemandNotedate(financialProjectMileStonePojo.getMasterDemandNotedate());
				mileStoneInfo.setMasterDemandDueDate(financialProjectMileStonePojo.getMasterDemandDueDate());
				
				mileStoneInfo.setInterestSelectionType(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getInterestSelectionType());
				mileStoneInfo.setDemandNoteSelectionType(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getDemandNoteSelectionType());
				mileStoneInfo.setReGenerateDemandNote(employeeFinancialServiceInfo.isReGenerateDemandNote());
				mileStoneInfo.setShowGstInPDF(employeeFinancialServiceInfo.isShowGstInPDF());
				mileStoneInfo.setCreatedBy(employeeFinancialServiceInfo.getEmpId());
				mileStoneInfo.setStatusId(Status.ACTIVE.getStatus());
				mileStoneInfo.setSiteId(employeeFinancialServiceInfo.getSiteId());
				
				if(Util.isEmptyObject(mileStoneInfo.getMilestoneDate())) {
					mileStoneInfo.setMilestoneDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getMilestoneDate());
				}
				//if the milestone status is not completed, add that milestone object id to CurrentprojectMileStoneIds
				if(financialProjectMileStonePojo.getStatusName()!=null && !financialProjectMileStonePojo.getStatusName().equals(Status.MS_COMPLETED.getDescription())) {
					employeeFinancialServiceInfo.getCurrentprojectMileStoneIds().add(financialProjectMileStonePojo.getProjectMilestoneId());
					
					if(Util.isEmptyObject(mileStoneInfo.getDemandNoteDate())) {
						mileStoneInfo.setDemandNoteDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getDemandNoteDate());
					}

					if(Util.isEmptyObject(mileStoneInfo.getMileStoneDueDate())) {
						mileStoneInfo.setMileStoneDueDate(employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests().get(0).getMileStoneDueDate());
					}
				}
				
			//changedMilestoneData.add(mileStoneInfo);
		}
		changedMilestoneData.addAll(acutualMilestoneData);
		if (employeeFinancialServiceInfo.isThisUplaodedData() && changedMilestoneData!=null) {

			for (FinancialProjectMileStoneInfo finProjDemandNoteInfo : changedMilestoneData) {
				if(finProjDemandNoteInfo.getMilestoneName()!=null && !finProjDemandNoteInfo.getMilestoneName().equals("Dummy MileStone for Regenerate Demand Note")) {
					sumOfDemandNotePercentage += finProjDemandNoteInfo.getMileStonePercentage()==null?0d:finProjDemandNoteInfo.getMileStonePercentage();
					if(finProjDemandNoteInfo.getInterestCalculationUptoDate()==null && finProjDemandNoteInfo.getDemandNoteDate()!=null) {
						finProjDemandNoteInfo.setInterestCalculationUptoDate(finProjDemandNoteInfo.getDemandNoteDate());
					}
				}
			}
		} else {
			employeeFinancialServiceInfo.setFinancialProjectMileStoneRequests(changedMilestoneData);
			for (FinancialProjectMileStoneInfo finProjDemandNoteInfo : employeeFinancialServiceInfo.getFinancialProjectMileStoneRequests()) {
				if(finProjDemandNoteInfo.getMilestoneName()!=null && !finProjDemandNoteInfo.getMilestoneName().equals("Dummy MileStone for Regenerate Demand Note")) {
					sumOfDemandNotePercentage += finProjDemandNoteInfo.getMileStonePercentage()==null?0d:finProjDemandNoteInfo.getMileStonePercentage();
				}
			}
		}
		
		employeeFinancialServiceInfo.setSumOfDemandNotePercentage(sumOfDemandNotePercentage);
	}

	private void loadCustomerDetails(Object object, EmployeeFinancialServiceInfo employeeFinancialServiceInfo, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) {
		boolean isThisUploadedData = employeeFinancialServiceInfo.isThisUplaodedData();
		List<OfficeDtlsResponse> officeDetailsResponseList = null;
		List<FinProjectAccountResponse> finProjectAccountResponseList = null;
		List<AddressInfo> siteAddressInfoList = null;
		List<AddressInfo> customerAddressInfoList = null;
		String actionUrl = "";
		String condition = employeeFinancialServiceInfo.getCondition()==null?"":employeeFinancialServiceInfo.getCondition();
		boolean isLegalUploadData = (isThisUploadedData && condition.equals("LEGAL_COST"));
		//boolean isMilestoneUploadData = (isThisUploadedData && condition.equals("FIN_BOOKING_FORM_MILESTONES"));
		boolean isMilestoneUploadData = (isThisUploadedData && condition.equals("DEMAND_NOTE_ACCOUNT_NUMBER"));
		if(isLegalUploadData || isMilestoneUploadData) {
			/* get site Account Bank Details */
			EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionServiceInfo = new EmployeeFinancialTransactionServiceInfo();
			employeeFinancialTransactionServiceInfo.setSiteIds(employeeFinancialServiceInfo.getSiteIds());
			employeeFinancialTransactionServiceInfo.setCondition(employeeFinancialServiceInfo.getCondition());
			List<FinProjectAccountPojo> finProjectAccountPojoList = employeeFinancialServiceDao.getFinProjectAccountData(employeeFinancialTransactionServiceInfo,customerPropertyDetailsInfo);
			//List<FinProjectAccountResponse> 
			finProjectAccountResponseList = financialMapper.finProjectAccountPojoListToFinProjectAccountResponseList(finProjectAccountPojoList);
			if(finProjectAccountResponseList.isEmpty()) {
				finProjectAccountResponseList.add(new FinProjectAccountResponse());
			}
			if(Util.isNotEmptyObject(finProjectAccountPojoList) && Util.isNotEmptyObject(finProjectAccountPojoList.get(0).getSiteBankAccountNumber())) {
				finProjectAccountResponseList.get(0).setSiteBankAccountNumber(finProjectAccountPojoList.get(0).getSiteBankAccountNumber());
			}
		} else {//is this upload data and already account details is loaded  
			finProjectAccountResponseList = employeeFinancialServiceInfo.getFinProjectAccountResponseList();	
		}
		
		if(Util.isNotEmptyObject(employeeFinancialServiceInfo.getCustomerAddressInfoList())
				&& Util.isNotEmptyObject(employeeFinancialServiceInfo.getSiteAddressInfoList())
				&& Util.isNotEmptyObject(employeeFinancialServiceInfo.getOfficeDetailsList())
				&& Util.isNotEmptyObject(employeeFinancialServiceInfo.getFlatsResponse())
				) {
			//if this request form upload excel
			customerPropertyDetailsInfo.setCoAppFullName(employeeFinancialServiceInfo.getFlatsResponse().get(0).getCoAppFullName());
			//employeeFinancialServiceInfo.getFinProjectAccountResponseList();
			customerAddressInfoList = employeeFinancialServiceInfo.getCustomerAddressInfoList();
			siteAddressInfoList = employeeFinancialServiceInfo.getSiteAddressInfoList();
			
			/*if(!isLegalUploadData && !isMilestoneUploadData) {
				finProjectAccountResponseList = employeeFinancialServiceInfo.getFinProjectAccountResponseList();	
			}*/
			
			officeDetailsResponseList = employeeFinancialServiceInfo.getOfficeDetailsList();
		} else {
			//other than upload excel reques, this else condiiton will execute
			
			actionUrl = customerPropertyDetailsInfo.getActionUrl();//taking actual action url
			customerPropertyDetailsInfo.setActionUrl("All");
			/* getting Co_Applicant Details */
			List<CoApplicantPojo> coApplicantPojoList = employeeFinancialServiceDao.getCoApplicantDetails(customerPropertyDetailsInfo);
			customerPropertyDetailsInfo.setActionUrl(actionUrl);//reassigning actual action url
			/* setting customer full Name and Coapp full name to customerPropertyDetailsInfo */
			setCustomerAndCoApplicantFullName(coApplicantPojoList, customerPropertyDetailsInfo);
			/* getting customer address details *///List<AddressInfo> 
			customerAddressInfoList = getCustomerAddressDetails(customerPropertyDetailsInfo);
			/* getting site address details *///List<AddressInfo> 
			List<AddressPojo> siteAddressPojoList = employeeFinancialServiceDao.getSiteAddressDetails(employeeFinancialServiceInfo);
			siteAddressInfoList = financialMapper.addressPojoListToAddressInfoList(siteAddressPojoList);
			if(siteAddressInfoList.isEmpty()) {
				siteAddressInfoList.add(new AddressInfo());
			}
			/* get site Account Bank Details */
			EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionServiceInfo1 = new EmployeeFinancialTransactionServiceInfo();
			employeeFinancialTransactionServiceInfo1.setSiteIds(employeeFinancialServiceInfo.getSiteIds());
			employeeFinancialTransactionServiceInfo1.setCondition(employeeFinancialServiceInfo.getCondition());
			List<FinProjectAccountPojo> finProjectAccountPojoList = employeeFinancialServiceDao.getFinProjectAccountData(employeeFinancialTransactionServiceInfo1,customerPropertyDetailsInfo);
			//List<FinProjectAccountResponse> 
			finProjectAccountResponseList = financialMapper.finProjectAccountPojoListToFinProjectAccountResponseList(finProjectAccountPojoList);
			if(finProjectAccountResponseList.isEmpty()) {
				finProjectAccountResponseList.add(new FinProjectAccountResponse());
			}
			if(condition.equals("DEMAND_NOTE_ACCOUNT_NUMBER") || condition.equals("LEGAL_COST") || condition.equals("MODIFICATION_COST")) {
				//taking account number without sale owner and type of account
				if(Util.isNotEmptyObject(finProjectAccountPojoList) && Util.isNotEmptyObject(finProjectAccountPojoList.get(0).getSiteBankAccountNumber())) {
					finProjectAccountResponseList.get(0).setSiteBankAccountNumber(finProjectAccountPojoList.get(0).getSiteBankAccountNumber());
				}
			}
			if(customerAddressInfoList.isEmpty()) {
				AddressInfo addressInfo = new AddressInfo();
				addressInfo.setAddressMappingType(new AddressMappingInfo());
				customerAddressInfoList.add(addressInfo);
			}
			/* getting Office_Details *///List<OfficeDtlsResponse> 
			List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
			officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
	}
		if(object instanceof EmployeeFinancialResponse) {
			EmployeeFinancialResponse employeeFinancialResponse = (EmployeeFinancialResponse) object;
			/* setting Customer Address List, Site Address List, MileStone Demand Note List and Fin Project Account List to Respective Object */
			employeeFinancialResponse.setDemandNoteDate(employeeFinancialServiceInfo.getDemandNoteDate());
			employeeFinancialResponse.setCustomerAddressInfoList(customerAddressInfoList);
			employeeFinancialResponse.setSiteAddressInfoList(Util.isNotEmptyObject(siteAddressInfoList)?siteAddressInfoList:new ArrayList<>(Arrays.asList(new AddressInfo())));
			employeeFinancialResponse.setFinProjectAccountResponseList(finProjectAccountResponseList);
			employeeFinancialResponse.setOfficeDetailsList(officeDetailsResponseList);
			employeeFinancialResponse.setFlatsResponse(Arrays.asList(customerPropertyDetailsInfo));
		}else if(object instanceof EmployeeFinancialTransactionResponse){
			EmployeeFinancialTransactionResponse employeeFinancialResponse = (EmployeeFinancialTransactionResponse) object;
			/* setting Customer Address List, Site Address List, MileStone Demand Note List and Fin Project Account List to Respective Object */
			//employeeFinancialResponse.setDemandNoteDate(employeeFinancialServiceInfo.getDemandNoteDate());
			employeeFinancialResponse.setCustomerAddressInfoList(customerAddressInfoList);
			employeeFinancialResponse.setSiteAddressInfoList(Util.isNotEmptyObject(siteAddressInfoList)?siteAddressInfoList:new ArrayList<>(Arrays.asList(new AddressInfo())));
			employeeFinancialResponse.setFinProjectAccountResponseList(finProjectAccountResponseList);
			employeeFinancialResponse.setOfficeDetailsList(officeDetailsResponseList);
			employeeFinancialResponse.setFlatsResponse(Arrays.asList(customerPropertyDetailsInfo));
		}else if(object instanceof FinancialDemandNoteMS_TRN_Info) {
			FinancialDemandNoteMS_TRN_Info employeeFinancialResponse = (FinancialDemandNoteMS_TRN_Info) object;
			employeeFinancialResponse.setDemandNoteDate(employeeFinancialResponse.getDemandNoteDate());
			employeeFinancialResponse.setCustomerAddressInfoList(customerAddressInfoList);
			employeeFinancialResponse.setSiteAddressInfoList(Util.isNotEmptyObject(siteAddressInfoList)?siteAddressInfoList:new ArrayList<>(Arrays.asList(new AddressInfo())));
			employeeFinancialResponse.setFinProjectAccountResponseList(finProjectAccountResponseList);
			employeeFinancialResponse.setOfficeDetailsList(officeDetailsResponseList);
			employeeFinancialResponse.setFlatsResponse(Arrays.asList(customerPropertyDetailsInfo));
		}
	}

	private void setFlatNoAndMileStoneName(Object employeeFinancialResponse,FinancialProjectMileStoneInfo currentOneFinancialProjectMileStoneInfo,
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo, String condition, List<FinancialProjectMileStoneResponse> previouseProjectMileStoneResponseList) {
		//log.info("**** The control is inside the setFlatNoAndMileStoneName *****");
		String flatNo = Util.isNotEmptyObject(customerPropertyDetailsInfo.getFlatNo())?customerPropertyDetailsInfo.getFlatNo():"NA";
		String siteName = Util.isNotEmptyObject(customerPropertyDetailsInfo.getSiteName())?customerPropertyDetailsInfo.getSiteName():"NA";
		String mileStoneName = Util.isNotEmptyObject(currentOneFinancialProjectMileStoneInfo.getMilestoneName())?currentOneFinancialProjectMileStoneInfo.getMilestoneName():"NA";
		String currentMilestoneName = Util.isNotEmptyObject(currentOneFinancialProjectMileStoneInfo.getMilestoneName())?currentOneFinancialProjectMileStoneInfo.getMilestoneName():"NA";
		if(customerPropertyDetailsInfo.getSiteId()!=null &&customerPropertyDetailsInfo.getSiteId().equals(131l)) {
			siteName = "Aspire Aurum";
		}
		StringBuilder demandNotePdfFileName = new StringBuilder(flatNo).append("-").append(siteName);
		
		if(condition.equalsIgnoreCase(MetadataId.BOOKING_FORM_DEMAND_NOTE.getName())) {
			if(currentOneFinancialProjectMileStoneInfo.isReGenerateDemandNote()) {
				mileStoneName = "Regenerated";
				for (FinancialProjectMileStoneResponse financialProjectMileStoneResponse : previouseProjectMileStoneResponseList) {
					if(!financialProjectMileStoneResponse.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
						mileStoneName = " "+ financialProjectMileStoneResponse.getMilestoneName();
					}
				}
			}
			
			demandNotePdfFileName.append("-").append(mileStoneName).append(".pdf");
			EmployeeFinancialResponse targetObject = (EmployeeFinancialResponse) employeeFinancialResponse;
			targetObject.setDemandNotePdfFileName(demandNotePdfFileName.toString());
			targetObject.setCurrentMilestoneName(currentMilestoneName);
			targetObject.setCurrentMilestoneDueDate(currentOneFinancialProjectMileStoneInfo.getMileStoneDueDate());
		}else if(condition.equalsIgnoreCase(MetadataId.LEGAL_COST.getName())) {
			demandNotePdfFileName.append("-").append("Legal_Charge_Invoice").append(".pdf");
			EmployeeFinancialTransactionResponse targetObject = (EmployeeFinancialTransactionResponse) employeeFinancialResponse;
			targetObject.setDemandNotePdfFileName(demandNotePdfFileName.toString());
		}else if(condition.equalsIgnoreCase(MetadataId.MODIFICATION_COST.getName())) {
			demandNotePdfFileName.append("-").append("Modification_Charge_Invoice").append(".pdf");
			EmployeeFinancialTransactionResponse targetObject = (EmployeeFinancialTransactionResponse) employeeFinancialResponse;
			targetObject.setDemandNotePdfFileName(demandNotePdfFileName.toString());
		}
	}

	
	/**
	 * 
	 * @param coApplicantPojoList
	 * @param customerPropertyDetailsInfo
	 */
	private void setCustomerAndCoApplicantFullName(List<CoApplicantPojo> coApplicantPojoList, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) {
		StringBuffer coAppFullName = new StringBuffer("");
		StringBuffer coAppFullName1 = new StringBuffer("");
		String namePrefix = "";
		String firstName= "";
		String lastName= "";
		for (CoApplicantPojo coApplicantPojo : coApplicantPojoList) {
			//custFullName.append(Util.isNotEmptyObject(coApplicantPojo.getCustFullName())?coApplicantPojo.getCustFullName():customerPropertyDetailsInfo.getCustomerName());
			coAppFullName.append(Util.isNotEmptyObject(coApplicantPojo.getCoAppFullName())?coApplicantPojo.getCoAppFullName(): "").append("\n");
			
			namePrefix = Util.isNotEmptyObject(coApplicantPojo.getNameprefix())?coApplicantPojo.getNameprefix(): "";
			firstName = Util.isNotEmptyObject(coApplicantPojo.getFirstName())?coApplicantPojo.getFirstName(): "";
			lastName = Util.isNotEmptyObject(coApplicantPojo.getLastName())?coApplicantPojo.getLastName(): "";
			
			coAppFullName1.append(namePrefix).append(" ").append(firstName).append(" ").append(lastName).append("\n");			
		}
		
		System.out.println("coAppFullName "+coAppFullName);
		System.out.println("coAppFullName "+coAppFullName1);
		
		if(Util.isNotEmptyObject(coApplicantPojoList) && Util.isNotEmptyObject(coApplicantPojoList.get(0))) {
			customerPropertyDetailsInfo.setCustFullName(Util.isNotEmptyObject(coApplicantPojoList.get(0).getCustFullName())?coApplicantPojoList.get(0).getCustFullName():customerPropertyDetailsInfo.getCustomerName());
			customerPropertyDetailsInfo.setCoAppFullName(coAppFullName1.toString());
		}
	}

	/**
	 * 
	 * @param employeeFinancialResponse
	 */
	private void getAllTotalAmounts(EmployeeFinancialResponse employeeFinancialResponse, EmployeeFinancialServiceInfo employeeFinancialServiceInfo) {
		log.info("*** The control is inside the getAllTotalAmounts in EmployeeFinancialServiceImpl ***");
		boolean isThisFirstBisbrusment = "First_Disbursement_Demandnote".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl());
		Double totalMileStoneAmount = 0.0;long isItMoreThanOneMsSelected = 0;
		Double totalmileStoneBasicAmount = 0.0;
        Double totalMileStoneTaxAmount = 0.0;
        Double totalSgstAmount = 0.0;
        Double totalCgstAmount = 0.0;
        Double totalPaidSgstAmount = 0.0;
        Double totalPaidCgstAmount = 0.0;
        Double totalInterestWaiverAdjAmount = 0.0;
        Double totalPenalityPaidAmount = 0.0;
        Double totalPaidAmount = 0.0;
        Double totalPenaltyAmount = 0.0;
        Double totalPendingPenaltyAmount = 0.0;
        double totalDuePercentages = 0.0;
        Long totalDaysDelayed = 0l;
      //Double totalDueAmount = 0.0;
        FinancialProjectMileStoneResponse respoo = new FinancialProjectMileStoneResponse();
        respoo.setMilestoneName("Within 30 days from the day of booking");
        respoo.setMileStoneNo(2l);
        respoo.setMileStoneTotalAmount(0d);
		respoo.setMileStoneBasicAmount(0d);
		respoo.setMileStonePercentage(0d);
		respoo.setDaysDelayed(0l);
		respoo.setPaidAmount(0d);
		 //totalPenaltyAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getTotalPenaltyAmount())?financialProjectMileStoneResponse.getTotalPenaltyAmount():0.0;
		respoo.setTotalPendingPenaltyAmount(0d);
		respoo.setMileStoneTaxAmount(0d);
		respoo.setSgstAmount(0d);
		respoo.setCgstAmount(0d);
		
        List<FinancialProjectMileStoneResponse> listb = employeeFinancialResponse.getFinancialProjectMileStoneResponse();
        for (Iterator<FinancialProjectMileStoneResponse> iterator = listb.iterator(); iterator.hasNext();) {
			FinancialProjectMileStoneResponse financialProjectMileStoneResponse = (FinancialProjectMileStoneResponse) iterator.next();
			if(financialProjectMileStoneResponse.getMilestoneName()!=null && !financialProjectMileStoneResponse.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
				totalMileStoneAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getMileStoneTotalAmount())?roundOffAmount(financialProjectMileStoneResponse.getMileStoneTotalAmount()):0.0;
				totalmileStoneBasicAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getMileStoneBasicAmount())?roundOffAmount(financialProjectMileStoneResponse.getMileStoneBasicAmount()):0.0;
				//totalMileStoneTaxAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getMileStoneTaxAmount())?roundOffAmount(financialProjectMileStoneResponse.getMileStoneTaxAmount()):0.0;
				totalDuePercentages += Util.isNotEmptyObject(financialProjectMileStoneResponse.getMileStonePercentage())?roundOffAmount(financialProjectMileStoneResponse.getMileStonePercentage()):0.0;
				totalDaysDelayed += Util.isNotEmptyObject(financialProjectMileStoneResponse.getDaysDelayed())?financialProjectMileStoneResponse.getDaysDelayed():0l;
				double cgstAmount = 0;
         		double sgstAmount = 0;
         		if(Util.isNotEmptyObject(financialProjectMileStoneResponse.getBokFrmDemNteSchTaxMapInfos())) {
         			List<FinBookingFormMstSchTaxMapInfo> listOfSchemeDetails = financialProjectMileStoneResponse.getBokFrmDemNteSchTaxMapInfos();
         			double otherThanGstAmount = 0d;
         			for (FinBookingFormMstSchTaxMapInfo bokFrmDemNteSchTaxMapInfo : listOfSchemeDetails) {
         				if(Util.isEmptyObject(employeeFinancialResponse.getFlatsResponse().get(0).getFinSchemeType())) {
         					employeeFinancialResponse.getFlatsResponse().get(0).setFinSchemeType(bokFrmDemNteSchTaxMapInfo.getFinSchemeType());
         					employeeFinancialResponse.getFlatsResponse().get(0).setFinSchemeName(bokFrmDemNteSchTaxMapInfo.getFinSchemeName());
         					employeeFinancialResponse.getFlatsResponse().get(0).setFinSchemeId(bokFrmDemNteSchTaxMapInfo.getFinSchemeId());
         				}
         				if(Util.isNotEmptyObject(bokFrmDemNteSchTaxMapInfo.getTaxTypeId()) && bokFrmDemNteSchTaxMapInfo.getTaxTypeId().equals(MetadataId.GST.getId())) {
         					//cgstAmount = bokFrmDemNteSchTaxMapInfo.getBasicAmount()/2;
         					//sgstAmount = bokFrmDemNteSchTaxMapInfo.getBasicAmount()/2;
         					//gstPercentage = bokFrmDemNteSchTaxMapInfo.getPercentageValue();
         				} else {
         					otherThanGstAmount = bokFrmDemNteSchTaxMapInfo.getBasicAmount();
         				}
        			}
         			
         			for (FinBookingFormMstSchTaxMapInfo bokFrmDemNteSchTaxMapInfo : listOfSchemeDetails) {
         				if(Util.isNotEmptyObject(bokFrmDemNteSchTaxMapInfo.getTaxTypeId()) && bokFrmDemNteSchTaxMapInfo.getTaxTypeId().equals(MetadataId.GST.getId())) {
         					double GSTAMount = roundOffAmount(bokFrmDemNteSchTaxMapInfo.getBasicAmount());
         					
         					if(Util.isNotEmptyObject(financialProjectMileStoneResponse.getPaidAmount()) && financialProjectMileStoneResponse.getPaidAmount()!=0) {
         						//finding remaining GST amount to pay
               					GSTAMount = ((bokFrmDemNteSchTaxMapInfo.getPercentageValue()/(bokFrmDemNteSchTaxMapInfo.getPercentageValue()+100))*(financialProjectMileStoneResponse.getMileStoneTotalAmount()-financialProjectMileStoneResponse.getPaidAmount()-otherThanGstAmount));
               					cgstAmount = GSTAMount/2;
             					sgstAmount = GSTAMount/2;
             					
             					//finding total GST paid amount on paid amount
             					GSTAMount = ((bokFrmDemNteSchTaxMapInfo.getPercentageValue()/(bokFrmDemNteSchTaxMapInfo.getPercentageValue()+100))*(financialProjectMileStoneResponse.getPaidAmount()-otherThanGstAmount));
             			        totalPaidSgstAmount += roundOffAmount(GSTAMount/2);
             			        totalPaidCgstAmount += roundOffAmount(GSTAMount/2);
         					} else {
	         					cgstAmount = GSTAMount/2;
	         					sgstAmount = GSTAMount/2;
         					}
         				}
    				}
         		}
         		
         		sgstAmount = roundOffAmount(sgstAmount);
         		cgstAmount = roundOffAmount(cgstAmount);
         		
         		totalMileStoneTaxAmount += sgstAmount+cgstAmount;
         		financialProjectMileStoneResponse.setMileStoneTaxAmount(sgstAmount+cgstAmount);
         		
         		totalSgstAmount += sgstAmount;
         		totalCgstAmount += cgstAmount;
         		
         		financialProjectMileStoneResponse.setSgstAmount(sgstAmount);
         		financialProjectMileStoneResponse.setCgstAmount(cgstAmount);
				/*totalSgstAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getSgstAmount())?financialProjectMileStoneResponse.getSgstAmount():0.0;
				totalCgstAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getCgstAmount())?financialProjectMileStoneResponse.getCgstAmount():0.0;*/
         		totalInterestWaiverAdjAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getInterestWaiverAdjAmount())?roundOffAmount(financialProjectMileStoneResponse.getInterestWaiverAdjAmount()):0.0;
         		totalPenalityPaidAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getTotalPenalityPaidAmount())?roundOffAmount(financialProjectMileStoneResponse.getTotalPenalityPaidAmount()):0.0;
				totalPaidAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getPaidAmount())?roundOffAmount(financialProjectMileStoneResponse.getPaidAmount()):0.0;
				totalPenaltyAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getTotalPenaltyAmount())?financialProjectMileStoneResponse.getTotalPenaltyAmount():0.0;
				totalPendingPenaltyAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getTotalPendingPenaltyAmount())?roundOffAmount(financialProjectMileStoneResponse.getTotalPendingPenaltyAmount()):0.0;
				
				System.out.println(totalPenaltyAmount+" - "+totalPendingPenaltyAmount+" - "+totalPenalityPaidAmount+" - "+totalInterestWaiverAdjAmount);
				log.info("financialProjectMileStoneResponse.getFinBokFomDmdNoteId() " +financialProjectMileStoneResponse.getFinBokFomDmdNoteId()+" "+financialProjectMileStoneResponse.getDemandNoteDate());
		
				if(isThisFirstBisbrusment) {
					if(financialProjectMileStoneResponse.getMileStoneNo()!=1) {
						iterator.remove();isItMoreThanOneMsSelected++;
						respoo.setFinBokFomDmdNoteId(financialProjectMileStoneResponse.getFinBokFomDmdNoteId());
						respoo.setMilestoneDate(financialProjectMileStoneResponse.getMilestoneDate());
						respoo.setDemandNoteDate(financialProjectMileStoneResponse.getDemandNoteDate());
						respoo.setMilestoneDemandNoteDate(financialProjectMileStoneResponse.getMilestoneDemandNoteDate());
						respoo.setMileStoneDueDate(financialProjectMileStoneResponse.getMileStoneDueDate());
						//respoo.setProjectMilestoneId(projectMilestoneId);
						
						respoo.setMileStoneTotalAmount(respoo.getMileStoneTotalAmount()+(Util.isNotEmptyObject(financialProjectMileStoneResponse.getMileStoneTotalAmount())?roundOffAmount(financialProjectMileStoneResponse.getMileStoneTotalAmount()):0.0));
						respoo.setMileStoneBasicAmount(respoo.getMileStoneBasicAmount()+(Util.isNotEmptyObject(financialProjectMileStoneResponse.getMileStoneBasicAmount())?roundOffAmount(financialProjectMileStoneResponse.getMileStoneBasicAmount()):0.0));
						respoo.setMileStonePercentage(respoo.getMileStonePercentage()+(Util.isNotEmptyObject(financialProjectMileStoneResponse.getMileStonePercentage())?roundOffAmount(financialProjectMileStoneResponse.getMileStonePercentage()):0.0));
						respoo.setDaysDelayed(respoo.getDaysDelayed()+(Util.isNotEmptyObject(financialProjectMileStoneResponse.getDaysDelayed())?financialProjectMileStoneResponse.getDaysDelayed():0l));
						respoo.setPaidAmount(respoo.getPaidAmount()+(Util.isNotEmptyObject(financialProjectMileStoneResponse.getPaidAmount())?roundOffAmount(financialProjectMileStoneResponse.getPaidAmount()):0.0));
						 //totalPenaltyAmount += Util.isNotEmptyObject(financialProjectMileStoneResponse.getTotalPenaltyAmount())?financialProjectMileStoneResponse.getTotalPenaltyAmount():0.0;
						respoo.setTotalPendingPenaltyAmount(respoo.getTotalPendingPenaltyAmount()+(Util.isNotEmptyObject(financialProjectMileStoneResponse.getTotalPendingPenaltyAmount())?roundOffAmount(financialProjectMileStoneResponse.getTotalPendingPenaltyAmount()):0.0));
						respoo.setMileStoneTaxAmount(respoo.getMileStoneTaxAmount()+financialProjectMileStoneResponse.getMileStoneTaxAmount());
						respoo.setSgstAmount(respoo.getSgstAmount()+financialProjectMileStoneResponse.getSgstAmount());
						respoo.setCgstAmount(respoo.getCgstAmount()+financialProjectMileStoneResponse.getCgstAmount());
					}/* else if(financialProjectMileStoneResponse.getMileStoneNo()!=1) {
						
					}*/
				}				
			}
		}
        if(isThisFirstBisbrusment) {
        	if(employeeFinancialServiceInfo.isReGenerateDemandNote()) {
        		if(isItMoreThanOneMsSelected!=0) {
        			listb.add(listb.size()-1,respoo);
        		}
        	} else {
        		if(isItMoreThanOneMsSelected!=0) {
        			listb.add(respoo);
        		}
        	}
        }
		//if("First_Disbursement_Demandnote".equalsIgnoreCase(employeeFinancialServiceInfo.getActionUrl())) {
			//getTheObjectForFirstDisbursement(employeeFinancialResponse);	
		//}
        
		//totalDueAmount = totalMileStoneAmount - totalPaidAmount ;
		employeeFinancialResponse.setTotalMileStoneAmount(totalMileStoneAmount);
		employeeFinancialResponse.setTotalmileStoneBasicAmount(totalmileStoneBasicAmount-(totalPaidAmount-(totalPaidSgstAmount+totalPaidCgstAmount)));
		employeeFinancialResponse.setTotalMileStoneTaxAmount(totalMileStoneTaxAmount);
		employeeFinancialResponse.setTotalSgstAmount(totalSgstAmount);
		employeeFinancialResponse.setTotalCgstAmount(totalCgstAmount);
		employeeFinancialResponse.setTotalPaidAmount(totalPaidAmount);
		employeeFinancialResponse.setTotalMilestoneDuePercent(totalDuePercentages);
		employeeFinancialResponse.setTotalInterestWaiverAdjAmount(totalInterestWaiverAdjAmount);
		employeeFinancialResponse.setTotalPenalityPaidAmount(totalPenalityPaidAmount);
		if (employeeFinancialServiceInfo.getIsInterestOrWithOutInterest().equalsIgnoreCase(Status.With_Interest.getDescription())) {
			employeeFinancialResponse.setTotalPendingPenaltyAmount(totalPendingPenaltyAmount);
			employeeFinancialResponse.setTotalPenaltyAmount(totalPenaltyAmount);
		} else {
			employeeFinancialResponse.setTotalPenaltyAmount(0.0);
			
		}
		employeeFinancialResponse.setTotalDueAmount(totalMileStoneAmount-totalPaidAmount);
		//log.info("totalPendingPenaltyAmount " +totalPendingPenaltyAmount);
		if(employeeFinancialServiceInfo.getIsInterestOrWithOutInterest()!=null && 
				employeeFinancialServiceInfo.getIsInterestOrWithOutInterest().equalsIgnoreCase(Status.With_Interest.getDescription())) {
			employeeFinancialResponse.setTotalDemandNoteAmount((totalMileStoneAmount-totalPaidAmount)+totalPendingPenaltyAmount);
			/* Total No of Days Delayed to Pay Amount is used in Interest Letter */
			employeeFinancialResponse.setTotalDaysDelayed(totalDaysDelayed);
		} else {
			employeeFinancialResponse.setTotalDemandNoteAmount((totalMileStoneAmount-totalPaidAmount));
		}
	}
	
	@Override
	public double roundOffAmount(Double amount) {
		if(amount!=null) {
			return BigDecimal.valueOf(amount).setScale(roundingModeSize, roundingMode).doubleValue();	
		}else {
			//log.info("***** Control inside the EmployeeFinancialServiceImpl.roundOffAmount() *****");
			//log.debug("***** Control inside the EmployeeFinancialServiceImpl.roundOffAmount() *****");
			throw new NumberFormatException("Invalid amount found to round off");
		}
	}
	
	@Override
	public String convertUstoInFormat(Double amount) {
		if(amount!=null) {
			return currencyUtil.convertUstoInFormat(BigDecimal.valueOf(amount).setScale(roundingModeSize, roundingMode).toString());	
		}else {
			//log.info("***** Control inside the EmployeeFinancialServiceImpl.roundOffAmount() *****");
			//log.debug("***** Control inside the EmployeeFinancialServiceImpl.roundOffAmount() *****");
			throw new NumberFormatException("Invalid amount found to round off");
		}
	}

	/**
	 * @param financialProjectMileStoneResponse
	 * @param customerPropertyDetailsInfo
	 * @return 
	 * @throws Exception 
	 */
	public List<FinSchemeTaxMappingPojo> getBasicAmountAndTaxAmountForEmployeeRaisedMilestone(@NotNull FinancialProjectMileStoneInfo currentFinancialProjectMileStoneResponse, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) throws Exception{
		log.info("*** The control is inside the getBasicAmountAndTaxAmountForEmployeeRaisedMilestone in EmployeeFinancialServiceImpl ***");
		customerPropertyDetailsInfo.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
		List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo);
		List<FinSchemeTaxMappingPojo> schemeTaxDetails = employeeFinancialServiceDao.getFlatBookDetailsSchemeTaxDetails(customerPropertyDetailsInfo,currentFinancialProjectMileStoneResponse);
		FinancialProjectMileStoneInfo financialProjectMileStoneInfo = new FinancialProjectMileStoneInfo();
		financialProjectMileStoneInfo.setMileStonePercentage(currentFinancialProjectMileStoneResponse.getMileStonePercentage());
		if(Util.isEmptyObject(listOfBookingAccountSummaryDetails)) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Flat cost details not found. For Flat No "+customerPropertyDetailsInfo.getFlatNo()));
		}
		if(schemeTaxDetails.isEmpty() && !currentFinancialProjectMileStoneResponse.getMilestoneName().equalsIgnoreCase("Dummy MileStone for Regenerate Demand Note")) {
			log.error("Scheme details not found Please update the GST for Flat No : "+customerPropertyDetailsInfo.getFlatNo());
			throw new InSufficeientInputException(Arrays.asList("Scheme details not found, Please update the Scheme for Flat No : "+customerPropertyDetailsInfo.getFlatNo()));
		}
		//milestone basic amount calculated on Flat basic amount
		Double basicMileStoneAmount = calCulateDemandNoteBasicMileStoneAmount(listOfBookingAccountSummaryDetails,financialProjectMileStoneInfo);		
		//this code for multiple schemes
		double sumOfTaxAmount = 0.0;
		List<FinBookingFormMstSchTaxMapInfo> bokFrmDemNteSchTaxMapInfos = new ArrayList<>();
		for (FinSchemeTaxMappingPojo finSchemeTaxMappingPojo : schemeTaxDetails) {
			//if(Util.isNotEmptyObject(finSchemeTaxMappingPojo.getTaxTypeId()) && finSchemeTaxMappingPojo.getTaxTypeId().equals(MetadataId.GST.getId())) {
			 //setting scheme name in customer info, for generating demand note formats for diffrenet schemes
			customerPropertyDetailsInfo.setFinSchemeName(finSchemeTaxMappingPojo.getFinSchemeName());
			customerPropertyDetailsInfo.setFinSchemeId(finSchemeTaxMappingPojo.getFinSchemeId());
			customerPropertyDetailsInfo.setFinSchemeType(finSchemeTaxMappingPojo.getFinSchemeType());
			
			FinBookingFormMstSchTaxMapInfo bokFrmDemNteSchTaxMapInfo = new FinBookingFormMstSchTaxMapInfo();
			//calculate GST amount on milestone basic amount
				Double mileStoneAmountWithGst = calCulateDemandNoteBasicMileStoneAmountWithGst(basicMileStoneAmount,finSchemeTaxMappingPojo.getPercentageValue());
				bokFrmDemNteSchTaxMapInfo.setGstAmount(mileStoneAmountWithGst);
				bokFrmDemNteSchTaxMapInfo.setCGST_Amount(mileStoneAmountWithGst / 2);
				bokFrmDemNteSchTaxMapInfo.setSGST_amount(mileStoneAmountWithGst / 2);
				bokFrmDemNteSchTaxMapInfo.setBasicAmount(mileStoneAmountWithGst);
				bokFrmDemNteSchTaxMapInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
				//bokFrmDemNteSchTaxMapInfo.setFinSchemeTaxMappingId(finSchemeTaxMappingPojo.getFinSchemeTaxMappingId());
				bokFrmDemNteSchTaxMapInfo.setFinScheTaxMapId(finSchemeTaxMappingPojo.getFinSchemeTaxMappingId());
				bokFrmDemNteSchTaxMapInfo.setFltBookingSchemeMappingId(finSchemeTaxMappingPojo.getFltBookingSchemeMappingId());
				bokFrmDemNteSchTaxMapInfo.setTaxType(finSchemeTaxMappingPojo.getTaxType());
				bokFrmDemNteSchTaxMapInfo.setTaxTypeId(finSchemeTaxMappingPojo.getTaxTypeId());
				bokFrmDemNteSchTaxMapInfo.setPercentageValue(finSchemeTaxMappingPojo.getPercentageValue());
				bokFrmDemNteSchTaxMapInfo.setPercentageId(finSchemeTaxMappingPojo.getPercentageId());
				sumOfTaxAmount += mileStoneAmountWithGst;
				bokFrmDemNteSchTaxMapInfos.add(bokFrmDemNteSchTaxMapInfo);
			//}
		}
		currentFinancialProjectMileStoneResponse.setMileStoneTaxAmount(sumOfTaxAmount);//sum of all gst amount
		currentFinancialProjectMileStoneResponse.setCgstAmount(sumOfTaxAmount/2);
		currentFinancialProjectMileStoneResponse.setSgstAmount(sumOfTaxAmount/2);
		currentFinancialProjectMileStoneResponse.setMileStoneBasicAmount(basicMileStoneAmount);//only calculate milestone basic amount
		currentFinancialProjectMileStoneResponse.setMilestonePrincipalAmount(basicMileStoneAmount);//only calculate milestone basic amount
		currentFinancialProjectMileStoneResponse.setMileStoneTotalAmount(basicMileStoneAmount+sumOfTaxAmount);//total amount of the milestone
		currentFinancialProjectMileStoneResponse.setTotalDueAmount(basicMileStoneAmount+sumOfTaxAmount);
		//currentFinancialProjectMileStoneResponse.setPayAmount(basicMileStoneAmount+sumOfTaxAmount);//ACP added
		currentFinancialProjectMileStoneResponse.setPaidAmount(0.0);
		currentFinancialProjectMileStoneResponse.setTotalPenaltyAmount(0.0);
		currentFinancialProjectMileStoneResponse.setTotalPendingPenaltyAmount(0.0);
		/* For Penalty Amount Calculations */
		currentFinancialProjectMileStoneResponse.setBokFrmDemNteSchTaxMapInfos(bokFrmDemNteSchTaxMapInfos);
		currentFinancialProjectMileStoneResponse.setPayAmount(basicMileStoneAmount+sumOfTaxAmount);
		return schemeTaxDetails;
	}
	
	/**
	 * 
	 * @param customerPropertyDetailsInfo
	 * @return List<AddressInfo>
	 */
	public List<AddressInfo> getCustomerAddressDetails(CustomerPropertyDetailsInfo customerPropertyDetailsInfo) {
		log.info("*** The control is inside the getCustomerAddressDetails in EmployeeFinancialServiceImpl ***");
		/* preparing booking form request */
		BookingFormRequest bookingFormRequest = new BookingFormRequest();
		bookingFormRequest.setCustomerId(customerPropertyDetailsInfo.getCustomerId());
		bookingFormRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
		/* getting CustBookInfoPojo List */
		List<CustBookInfoPojo> custBookInfoPojos = bookingFormServiceDaoImpl.getCustBookInfo(bookingFormRequest);
		List<AddressInfo> customerAddressInfos = new ArrayList<>();
		if (Util.isNotEmptyObject(custBookInfoPojos) ) {
			/* mapping CustBookInfoPojo List to customerBookingInfo */
			CustomerBookingInfo customerBookingInfo = bookingFormMapper.custBookInfoPojoToCustomerBookingInfo(custBookInfoPojos.get(0));
			/* preparing booking form request */
			bookingFormRequest.setMetadataId(MetadataId.CUSTOMER.getId());
			bookingFormRequest.setCustBookInfoId(customerBookingInfo.getCustBookInfoId());
			List<AddressMappingPojo> addressMappingPojos = null;
			/* getting AddressMappingPojos */
			addressMappingPojos = bookingFormServiceDaoImpl.getAddressMapping(bookingFormRequest);
			if (Util.isNotEmptyObject(addressMappingPojos)) {
				for (AddressMappingPojo addressMappingPojo : addressMappingPojos) {
					/* getting AddressPojos by AddressMappingPojos */
					List<AddressPojo> addrPojos = bookingFormServiceDaoImpl.getAddress(addressMappingPojo.getAddressId());
					List<AddressInfo> addressInfos = bookingFormMapper.addressPojosTocustomerAddressInfos(addrPojos,addressMappingPojo);
					customerAddressInfos.addAll(addressInfos);
				}
			}else {
				/* adding empty AddressInfos List */
				customerAddressInfos.add(new AddressInfo());
			}
		}else {
			/* adding empty AddressInfos List */
			customerAddressInfos.add(new AddressInfo());
		}
		return customerAddressInfos;
	}

	@Override
	public EmployeeFinancialTransactionResponse getFinTransactionTypeModeData(EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionInfo) {
		log.info("*** The control is inside the getFinTransactionTypeModeData in EmployeeFinancialServiceImpl ***");
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		if(Util.isNotEmptyObject(employeeFinancialTransactionInfo) && Util.isNotEmptyObject(employeeFinancialTransactionInfo.getCondition())){
			if(employeeFinancialTransactionInfo.getCondition().equalsIgnoreCase(MetadataId.FIN_ANONYMOUS_ENTRY.getName())) {
				List<FinTransferModePojo> finTransferModePojoList = employeeFinancialServiceDao.getFinTransferModeData(employeeFinancialTransactionInfo);
				List<FinTransferModeResponse> finTransferModeResponseList = financialMapper.finTransferModePojoListToFinTransferModeResponseList(finTransferModePojoList);
				employeeFinancialTransactionResponse.setFinTransferModeResponseList(finTransferModeResponseList);
			} else if(employeeFinancialTransactionInfo.getCondition().equalsIgnoreCase(MetadataId.PAYMENT.getName())) {
				List<FinTransactionForPojo> transactionForPojos = employeeFinancialServiceDao.getTransactionForDetails(employeeFinancialTransactionInfo);
				List<FinTransactionForResponse> transactionForResponseList = financialMapper.finFinTransactionForPojoListToFinTransactionForResponseList(transactionForPojos);
				employeeFinancialTransactionResponse.setTransactionForResponseList(transactionForResponseList);
			} else if(employeeFinancialTransactionInfo.getCondition().equalsIgnoreCase("fetchTransactionData")) {
				/* getting Fin Transaction Mode Pojo List */
				List<FinTransactionModePojo> finTransactionModePojoList = employeeFinancialServiceDao.getFinTransactionModeData(employeeFinancialTransactionInfo);
				List<FinTransactionModeResponse> finTransactionModeResponseList = financialMapper.finTransactionModePojoListToFinTransactionModeResponseList(finTransactionModePojoList);
				/* getting Fin Transaction Type Pojo List */
				List<FinTransactionTypePojo> finTransactionTypePojoList = employeeFinancialServiceDao.getFinTransactionTyeData(employeeFinancialTransactionInfo);
				List<FinTransactionTypeResponse> finTransactionTypeResponseList = financialMapper.finTransactionTypePojoListToFinTransactionTypeResponseList(finTransactionTypePojoList);
				/* setting all info list to employeeFinancialTransactionResponse */
				employeeFinancialTransactionResponse.setFinTransactionModeResponseList(finTransactionModeResponseList);
				employeeFinancialTransactionResponse.setFinTrnasactionTypeResponseList(finTransactionTypeResponseList);
			} else if(employeeFinancialTransactionInfo.getCondition().equalsIgnoreCase("fetchPaymentData")) {
				/* getting Bank Details Pojo List */
				List<FinBankPojo> finBankPojoList = employeeFinancialServiceDao.getFinBankData(employeeFinancialTransactionInfo);
				List<FinBankResponse> finBankResponseList = financialMapper.finBankPojoListTofinBankResponseList(finBankPojoList);
				/* getting Fin Transaction Mode Pojo List */
				List<FinTransactionModePojo> finTransactionModePojoList = employeeFinancialServiceDao.getFinTransactionModeData(employeeFinancialTransactionInfo);
				List<FinTransactionModeResponse> finTransactionModeResponseList = financialMapper.finTransactionModePojoListToFinTransactionModeResponseList(finTransactionModePojoList);
				/* getting Fin Transaction Type Pojo List */
				List<FinTransactionTypePojo> finTransactionTypePojoList = employeeFinancialServiceDao.getFinTransactionTyeData(employeeFinancialTransactionInfo);
				List<FinTransactionTypeResponse> finTransactionTypeResponseList = financialMapper.finTransactionTypePojoListToFinTransactionTypeResponseList(finTransactionTypePojoList);
				/* setting all info list to employeeFinancialTransactionResponse */
				employeeFinancialTransactionResponse.setFinBankResponseList(finBankResponseList);
				employeeFinancialTransactionResponse.setFinTransactionModeResponseList(finTransactionModeResponseList);
				employeeFinancialTransactionResponse.setFinTrnasactionTypeResponseList(finTransactionTypeResponseList);
			}else {//here condition is "fetchAllData" 
				/* getting Bank Details Pojo List */
				List<FinBankPojo> finBankPojoList = employeeFinancialServiceDao.getFinBankData(employeeFinancialTransactionInfo);
				List<FinBankResponse> finBankResponseList = financialMapper.finBankPojoListTofinBankResponseList(finBankPojoList);
				/* getting Fin Transaction Mode Pojo List */
				List<FinTransactionModePojo> finTransactionModePojoList = employeeFinancialServiceDao.getFinTransactionModeData(employeeFinancialTransactionInfo);
				List<FinTransactionModeResponse> finTransactionModeResponseList = financialMapper.finTransactionModePojoListToFinTransactionModeResponseList(finTransactionModePojoList);
				/* getting Fin Transaction Type Pojo List */
				List<FinTransactionTypePojo> finTransactionTypePojoList = employeeFinancialServiceDao.getFinTransactionTyeData(employeeFinancialTransactionInfo);
				List<FinTransactionTypeResponse> finTransactionTypeResponseList = financialMapper.finTransactionTypePojoListToFinTransactionTypeResponseList(finTransactionTypePojoList);
				/* setting all info list to employeeFinancialTransactionResponse */
				employeeFinancialTransactionResponse.setFinBankResponseList(finBankResponseList);
				employeeFinancialTransactionResponse.setFinTransactionModeResponseList(finTransactionModeResponseList);
				employeeFinancialTransactionResponse.setFinTrnasactionTypeResponseList(finTransactionTypeResponseList);
			}
		}
		return employeeFinancialTransactionResponse;
	}

	@Override
	public EmployeeFinancialTransactionResponse getFinProjectAccountData(EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionInfo) throws Exception {
		log.info("*** The control is inside the getFinProjectAccountData in EmployeeFinancialServiceImpl ***");
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		/* getting Site Account Pojo List based on Site Id */
		List<FinProjectAccountPojo> finProjectAccountPojoList = employeeFinancialServiceDao.getFinProjectAccountData(employeeFinancialTransactionInfo,null);
		if (Util.isNotEmptyObject(employeeFinancialTransactionInfo.getCondition()) && Util.isEmptyObject(finProjectAccountPojoList)) {
			if (employeeFinancialTransactionInfo.getCondition().equals("MODIFICATION_COST")) {
				throw new EmployeeFinancialServiceException("Please add Account Number for Modification Invoice, Account Number not found.");
			} else if (employeeFinancialTransactionInfo.getCondition().equals("LEGAL_COST")) {
				throw new EmployeeFinancialServiceException("Please add Account Number for Legal Invoice, Account Number not found.");
			} else if(employeeFinancialTransactionInfo.getCondition().equals("FIN_BOOKING_FORM_MILESTONES")) {
				throw new EmployeeFinancialServiceException("Please add Account Number for Demand Note, Account Number not found.");
			}
		}
		List<FinProjectAccountResponse> finProjectAccountResponseList = financialMapper.finProjectAccountPojoListToFinProjectAccountResponseList(finProjectAccountPojoList);
		employeeFinancialTransactionResponse.setFinProjectAccountResponseList(finProjectAccountResponseList);
		return employeeFinancialTransactionResponse;
	}

	@Override
	public EmployeeFinancialTransactionResponse viewFinProjectAccountDataForInvoices(EmployeeFinancialTransactionServiceInfo serviceInfo) throws Exception {
		log.info("*** The control is inside the  viewFinProjectAccountDataForInvoices in EmployeeFinancialServiceImpl ***");
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		/* getting Site Account Pojo List based on Site Id */
		List<FinProjectAccountPojo> finProjectAccountPojoList = employeeFinancialServiceDao.viewFinProjectAccountDataForInvoices(serviceInfo,null);
		if (Util.isNotEmptyObject(serviceInfo.getCondition()) && Util.isEmptyObject(finProjectAccountPojoList)) {
			if (serviceInfo.getCondition().equals("MODIFICATION_COST")) {
				throw new EmployeeFinancialServiceException("Please add Account Number for Modification Invoice, Account Number not found.");
			} else if (serviceInfo.getCondition().equals("LEGAL_COST")) {
				throw new EmployeeFinancialServiceException("Please add Account Number for Legal Invoice, Account Number not found.");
			} else if(serviceInfo.getCondition().equals("FIN_BOOKING_FORM_MILESTONES")) {
				throw new EmployeeFinancialServiceException("Please add Account Number for Demand Note, Account Number not found.");
			}
		}
		List<FinProjectAccountResponse> finProjectAccountResponseList = financialMapper.finProjectAccountPojoListToFinProjectAccountResponseList(finProjectAccountPojoList);
		employeeFinancialTransactionResponse.setFinProjectAccountResponseList(finProjectAccountResponseList);
		return employeeFinancialTransactionResponse;
	}
	
	@Override
	public EmployeeFinancialTransactionResponse getPendingAmountData(EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionInfo) {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getPendingAmountData() *****"+employeeFinancialTransactionInfo.getRequestUrl()+""+employeeFinancialTransactionInfo.getCondition());
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		/* employeeFinancialServiceInfo.setBlockIds(employeeFinancialTransactionInfo.getBlockIds()); */
		employeeFinancialServiceInfo.setBookingFormIds(employeeFinancialTransactionInfo.getBookingFormIds());
		/* getting Customer Details */
        if(Util.isNotEmptyObject(employeeFinancialTransactionInfo.getBookingFormId()) &&Util.isNotEmptyObject(employeeFinancialTransactionInfo.getButtonType()) && "initiatepayemt".equalsIgnoreCase(employeeFinancialTransactionInfo.getButtonType()))
        {
        	employeeFinancialServiceInfo.setBookingFormId(employeeFinancialTransactionInfo.getBookingFormId());
        	employeeFinancialServiceInfo.setFlatIds(null);
        	employeeFinancialServiceInfo.setCondition("saveBookingDetails");
        }else
        {
    	   employeeFinancialServiceInfo.setFlatIds(employeeFinancialTransactionInfo.getFlatIds());
        }
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		List<FinancialProjectMileStoneResponse> financialProjectMileStoneResponseList = new ArrayList<>();
		for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList){
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo =  financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
			/* getting customer pending amount and penalty amount */
			List<FinBookingFormAccountsPojo> finBookingFormAccountsPojoList = employeeFinancialServiceDao.getFinBookingFormAccountsData1(customerPropertyDetailsInfo);
			FinancialProjectMileStoneResponse financialProjectMileStoneResponse = new FinancialProjectMileStoneResponse();
			//financialProjectMileStoneResponse.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
			if(Util.isNotEmptyObject(finBookingFormAccountsPojoList)) {
				getTotalPendingDueAmount(finBookingFormAccountsPojoList, customerPropertyDetailsPojoList.get(0), financialProjectMileStoneResponse);
			}else {
				/* setting default values */
				financialProjectMileStoneResponse.setTotalDueAmount(0.0);
				financialProjectMileStoneResponse.setTotalPenaltyAmount(0.0);
				//financialProjectMileStoneResponse.setBookingFormId(customerPropertyDetailsPojoList.get(0).getFlatBookingId());
				financialProjectMileStoneResponse.setCustomerName(Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0).getCustomerName())?customerPropertyDetailsPojoList.get(0).getCustomerName():"N/A");
			}
			/* getting invoice Numbers for Modification and Legal Charges Invoice Numbers */
			List<FinBookingFormAccountsPojo> finBookingFormAccountsInvoicesPojoList ;
			if(employeeFinancialTransactionInfo.getCondition()!=null
					&& employeeFinancialTransactionInfo.getCondition().equalsIgnoreCase(MetadataId.CRM.getName())) {
				customerPropertyDetailsInfo.setCondition(employeeFinancialTransactionInfo.getCondition());
				
				//if this request from completed transaction
				if(employeeFinancialTransactionInfo.getRequestUrl()!=null && employeeFinancialTransactionInfo.getRequestUrl().equals("CompletedTransaction")) {
					customerPropertyDetailsInfo.setCondition(employeeFinancialTransactionInfo.getRequestUrl());
				}
				
				finBookingFormAccountsInvoicesPojoList = employeeFinancialServiceDao.getFinBookingFormAccountsInvoices(customerPropertyDetailsInfo);
			}else {
				finBookingFormAccountsInvoicesPojoList = new ArrayList<FinBookingFormAccountsPojo>();
			}
			List<FinBookingFormAccountsResponse> finBookingFormAccountsInvoicesResponseList = financialMapper.finBookingFormAccountsPojoListToFinBookingFormAccountsResponseList(finBookingFormAccountsInvoicesPojoList);
			/* setting Modification and Legal Charges Invoice Numbers List to Response object */
			financialProjectMileStoneResponse.setFinBookingFormAccountsResponseList(finBookingFormAccountsInvoicesResponseList);
			financialProjectMileStoneResponseList.add(financialProjectMileStoneResponse);		
		}
		
		employeeFinancialTransactionResponse.setFinancialProjectMileStoneResponse(financialProjectMileStoneResponseList);
		return employeeFinancialTransactionResponse;
	}

	private void getTotalPendingDueAmount(List<FinBookingFormAccountsPojo> finBookingFormAccountsPojoList,CustomerPropertyDetailsPojo customerPropertyDetailsPojo,
			FinancialProjectMileStoneResponse financialProjectMileStoneResponse) {
		log.info("*** The control is inside the getTotalPendingDueAmount in EmployeeFinancialServiceImpl ***");
		Double totalDueAmount = 0.0;
		Double totalPenaltyAmount = 0.0;
		double sumOfPayAmount = 0.0;
		double sumOfPaidAmount = 0.0;
		for(FinBookingFormAccountsPojo finBookingFormAccountsPojo : finBookingFormAccountsPojoList) {
			if(finBookingFormAccountsPojo.getType()!=null && !finBookingFormAccountsPojo.getType().equals(MetadataId.FIN_PENALTY.getId())) {
				totalDueAmount += Util.isNotEmptyObject(finBookingFormAccountsPojo.getPendingAmount())?finBookingFormAccountsPojo.getPendingAmount():0.0;
				
				if(finBookingFormAccountsPojo.getMsStatusId()!=null && !finBookingFormAccountsPojo.getMsStatusId().equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
					sumOfPayAmount += Util.isNotEmptyObject(finBookingFormAccountsPojo.getPayAmount())?finBookingFormAccountsPojo.getPayAmount():0.0;	
				}
				sumOfPaidAmount += Util.isNotEmptyObject(finBookingFormAccountsPojo.getPaidAmount())?finBookingFormAccountsPojo.getPaidAmount():0.0;
				
			} else if(finBookingFormAccountsPojo.getType()!=null && finBookingFormAccountsPojo.getType().equals(MetadataId.FIN_PENALTY.getId())) {
				totalPenaltyAmount += Util.isNotEmptyObject(finBookingFormAccountsPojo.getPendingAmount())?finBookingFormAccountsPojo.getPendingAmount():0.0;
			}
		}
		System.out.println(sumOfPayAmount-sumOfPaidAmount);
		//double amount = sumOfPaidAmount-sumOfPayAmount;
		//if(sumOfPaidAmount>sumOfPayAmount) {
			financialProjectMileStoneResponse.setTotalDueAmount(new BigDecimal(sumOfPayAmount-sumOfPaidAmount).setScale(roundingModeSize, roundingMode).doubleValue());	
		/*}else {
			financialProjectMileStoneResponse.setTotalDueAmount(new BigDecimal(sumOfPayAmount-sumOfPaidAmount).setScale(roundingModeSize, roundingMode).doubleValue());
		}*/
		
		//financialProjectMileStoneResponse.setTotalDueAmount(new BigDecimal(totalDueAmount).setScale(roundingModeSize, roundingMode).doubleValue());
		//financialProjectMileStoneResponse.setTotalPenaltyAmount(new BigDecimal(totalPenaltyAmount).setScale(roundingModeSize, roundingMode).doubleValue());
		financialProjectMileStoneResponse.setTotalPenaltyAmount(0d);
		financialProjectMileStoneResponse.setCustomerName(Util.isNotEmptyObject(customerPropertyDetailsPojo.getCustomerName())?customerPropertyDetailsPojo.getCustomerName():"N/A");
		//financialProjectMileStoneResponse.setBookingFormId(customerPropertyDetailsPojo.getFlatBookingId());
	}

	@Override
	public FinancialProjectMileStoneResponse getCustomerInvoices(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		log.info("*** The control is inside the getInvoices in EmployeeFinancialServiceImpl ***");
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		/* For Employee Portal Side we need Extra Data i.e Paid Amount and Payable Amount and For Customer Side We don't Need */
		Boolean flag = true;
		/* Getting Legal Invoice and Modification Invoice in Customer App Side based on request */
		if("Customer_Invoices".equalsIgnoreCase(transactionServiceInfo.getActionUrl())) {
			flag = false;
			employeeFinancialServiceInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
		/* Getting Both Legal Invoice and Modification Invoice in Employee Portal Side */
		}else {
			employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
			employeeFinancialServiceInfo.setBookingFormIds(transactionServiceInfo.getBookingFormIds());
		}
		FinancialProjectMileStoneResponse financialProjectMileStoneResponse = new FinancialProjectMileStoneResponse();
		//List<FinancialProjectMileStoneResponse> financialProjectMileStoneResponseList = new ArrayList<>();
		List<FinBookingFormAccountsPojo> finBookingFormAccountsInvoicesPojoList = null;
		List<FinBookingFormAccountPaymentDetailsPojo> excessAmountReturnDetails = null;
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList){
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo =  financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);

			//finBookingFormAccountsInvoicesPojoList = employeeFinancialServiceDao.getCustomerInvoices(transactionServiceInfo);
			customerPropertyDetailsInfo.setCondition(transactionServiceInfo.getRequestUrl());
			/* Getting Legal Invoice and Modification Invoice in Customer App Side based on request */
			if("Customer_Invoices".equalsIgnoreCase(transactionServiceInfo.getActionUrl())) {
				customerPropertyDetailsInfo.setActionUrl(transactionServiceInfo.getActionUrl());
			}
			finBookingFormAccountsInvoicesPojoList = employeeFinancialServiceDao.getFinBookingFormAccountsInvoices(customerPropertyDetailsInfo);
			if(flag) {
				for (FinBookingFormAccountsPojo finBookingFormAccountsPojo : finBookingFormAccountsInvoicesPojoList) {
					double excessAmount = 0d;
					double usedExcessAmount = 0d;
					double sumOfRefundAmount = 0d;
					FinBookingFormAccountPaymentPojo bookingFormAccountPaymentPojo = new FinBookingFormAccountPaymentPojo();
					bookingFormAccountPaymentPojo.setStatusId(Status.ACTIVE.getStatus());

					customerPropertyDetailsInfo.setCondition(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId().toString());
					customerPropertyDetailsInfo.setFinBokAccInvoiceNo(finBookingFormAccountsPojo.getFinBokAccInvoiceNo());
					List<FinBookingFormExcessAmountPojo> listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo,Arrays.asList(finBookingFormAccountsPojo.getType()));
					if(Util.isNotEmptyObject(listOfExcessAmount)) {
						FinBookingFormExcessAmountPojo excessAmountObject = listOfExcessAmount.get(0);
						if(Util.isNotEmptyObject(excessAmountObject.getExcessAmount())) {
							excessAmount += excessAmountObject.getExcessAmount();
							usedExcessAmount += excessAmountObject.getUsedAmount();
							if(usedExcessAmount!=0) {
								bookingFormAccountPaymentPojo.setTypeId(excessAmountObject.getFinBookingFormExcessAmountId());
								bookingFormAccountPaymentPojo.setType(MetadataId.FIN_BOOKING_FORM_EXCESS_AMOUNT.getId());
								excessAmountReturnDetails = employeeFinancialServiceDao.getExcessAmountPaymentRefundDetails(bookingFormAccountPaymentPojo);
								if (Util.isNotEmptyObject(excessAmountReturnDetails)) {
									for (FinBookingFormAccountPaymentDetailsPojo accountPaymentDetailsPojo : excessAmountReturnDetails) {
										sumOfRefundAmount+=accountPaymentDetailsPojo.getRefundAmount();
									}
								}
							}
						}
					}else {
						//System.out.println("Empty "+finTransactionEntryDetailsPojo.getTransactionSetOffEntryId());
					}	

					bookingFormAccountPaymentPojo.setType(MetadataId.FIN_BOOKING_FORM_ACCOUNTS.getId());
					bookingFormAccountPaymentPojo.setTypeId(finBookingFormAccountsPojo.getFinBookingFormAccountsId());

					if (finBookingFormAccountsPojo.getRefundAmount() != 0) {
						excessAmountReturnDetails = employeeFinancialServiceDao.getExcessAmountPaymentRefundDetails(bookingFormAccountPaymentPojo);
						if (Util.isNotEmptyObject(excessAmountReturnDetails)) {
							for (FinBookingFormAccountPaymentDetailsPojo accountPaymentDetailsPojo : excessAmountReturnDetails) {
								sumOfRefundAmount+=accountPaymentDetailsPojo.getRefundAmount();
							}
						}
					}
					
					finBookingFormAccountsPojo.setPaidAmount((finBookingFormAccountsPojo.getPaidAmount()+excessAmount)-sumOfRefundAmount);
					finBookingFormAccountsPojo.setBalanceAmount(finBookingFormAccountsPojo.getPayAmount()-finBookingFormAccountsPojo.getPaidAmount());
					finBookingFormAccountsPojo.setRefundAmount(sumOfRefundAmount);
				}
			}
			
			List<FinBookingFormAccountsResponse> finBookingFormAccountsInvoicesResponseList = financialMapper.finBookingFormAccountsPojoListToFinBookingFormAccountsResponseList(finBookingFormAccountsInvoicesPojoList);
			/* setting Modification and Legal Charges Invoice Numbers List to Response object */
			financialProjectMileStoneResponse.setFlatsResponse(Arrays.asList(customerPropertyDetailsInfo));
			financialProjectMileStoneResponse.setFinBookingFormAccountsResponseList(finBookingFormAccountsInvoicesResponseList);
		}

		return financialProjectMileStoneResponse;
	}
	
	@Override
	public EmployeeFinancialTransactionResponse getMisPendingTransactions(EmployeeFinancialTransactionServiceInfo tansactionServiceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getMisPendingTransactions() *****");
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		List<FinTransactionEntryPojo> finTransactionEntryPojoList = null;
		String condition = tansactionServiceInfo.getCondition()==null?"":tansactionServiceInfo.getCondition();
		if(condition.equalsIgnoreCase("loadCompletedTransaction") || condition.equalsIgnoreCase("loadCompletedTrnActiveBookingData")
				|| condition.equalsIgnoreCase("clearedCompletedTransaction")) {
			finTransactionEntryPojoList = employeeFinancialServiceDao.getMisCompletedTransactions(tansactionServiceInfo);
		} else if(condition.equalsIgnoreCase("transactionStatus")) {
			finTransactionEntryPojoList = employeeFinancialServiceDao.getMisPendingTransactionsStatus(tansactionServiceInfo);
		} else {
			finTransactionEntryPojoList = employeeFinancialServiceDao.getMisPendingTransactions(tansactionServiceInfo);
		}
		List<FinTransactionEntryResponse> finTransactionEntryResponseList = financialMapper.finTransactionEntryPojoListToFinTransactionEntryResponseList(finTransactionEntryPojoList,tansactionServiceInfo);
		employeeFinancialTransactionResponse.setFinTransactionEntryResponseList(finTransactionEntryResponseList);
		return employeeFinancialTransactionResponse;
	}

	@Override
	public EmployeeFinancialTransactionResponse getPendingInterestWaiverTransactions(EmployeeFinancialTransactionServiceInfo tansactionServiceInfo) {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getPendingInterestWaiverTransactions() *****");
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		List<FinTransactionEntryPojo> finTransactionEntryPojoList = null;
		
		finTransactionEntryPojoList = employeeFinancialServiceDao.getMisPendingTransactions(tansactionServiceInfo);
		
		List<FinTransactionEntryResponse> finTransactionEntryResponseList = financialMapper.finTransactionEntryPojoListToFinTransactionEntryResponseList(finTransactionEntryPojoList,tansactionServiceInfo);
		employeeFinancialTransactionResponse.setFinTransactionEntryResponseList(finTransactionEntryResponseList);
		return employeeFinancialTransactionResponse;
	}
	
	/**
	 * Method used for loading transaction details
	 * 1. Edit Transaction 
	 * 2. Delete Transaction
	 * 3. View Completed Transaction
	 * 4. View Temporary Transaction Status
	 * 5. Interest Waiver Approval Page
	 * Note : Before changing any existing code need to check these modules
	 */
	@Override
	public EmployeeFinancialTransactionResponse getMisReceiptChequeOnlineData(EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionInfo, List<Long> loadType) throws Exception {
		//log.info("*** The control is inside the getMisReceiptChequeData in EmployeeFinancialServiceImpl ***\n"+employeeFinancialTransactionInfo.getBookingFormId()+" Booking Form Id");
		List<CustomerPropertyDetailsInfo> customerPropertyDetailsInfoList = new ArrayList<>();
		List<FinTransactionEntryDetailsResponse> finTransactionEntryDetailsResponseList = new ArrayList<>();
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		employeeFinancialTransactionResponse.setOperationType(employeeFinancialTransactionInfo.getOperationType());
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setSiteId(employeeFinancialTransactionInfo.getSiteId());
		/*employeeFinancialServiceInfo.setBlockIds(employeeFinancialTransactionInfo.getBlockIds()); */
		//employeeFinancialServiceInfo.setFlatIds(employeeFinancialTransactionInfo.getFlatIds());
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(new Long[] {employeeFinancialTransactionInfo.getBookingFormId()}));
		boolean isThisFinalLevel = false;
		employeeFinancialServiceInfo.setCondition(FinEnum.GET_ACTIVE_INACTIVE_FLATS.getName());
		List<Long> listOfBookingStatus = Arrays.asList(Status.CANCEL.getStatus(),
				Status.PENDING.getStatus(),Status.SWAP.getStatus(),
				Status.AVAILABLE.getStatus(),Status.BLOCKED.getStatus(),
				Status.NOT_OPEN.getStatus(),Status.PRICE_UPDATE.getStatus(),
				Status.LEGAL_CASE.getStatus(),Status.PMAY_SCHEME_ELIGIBLE.getStatus()
				,Status.RETAINED.getStatus(),Status.ACTIVE.getStatus(),Status.INACTIVE.getStatus()
				,Status.CANCELLED_NOT_REFUNDED.getStatus(),Status.ASSIGNMENT.getStatus()
				);
		List<Long> transactionStatusList = Arrays.asList(Status.NEW.getStatus(),Status.APPROVED.getStatus(),Status.PENDING.getStatus());
		employeeFinancialServiceInfo.setStatusIds(listOfBookingStatus);
		/* getting Customer Details */
		final List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList) {
			if(Util.isNotEmptyObject(customerPropertyDetailsPojo) && Util.isNotEmptyObject(customerPropertyDetailsPojo.getFlatBookingId())) {
				
				List<FinTransactionChangedDtlsPojo> changedDetailsPojoList = null;
				List<FinTransactionChangedDtlsResponse> changedDetailsResponseList = null;
				
				List<FinTransactionEntryDocPojo> transactionEntryDocPojos  = null;
				List<FinTransactionEntryDocResponse> transactionEntryDocResponses = null;
				
				List<FinTransactionEntryDocPojo> transactionReceiptDocPojos  = null;
				List<FinTransactionEntryDocResponse> transactionReceiptResponses = null;
				
				List<FinTransactionCommentsPojo> finTransactionCommentsPojoList = null;
				List<FinTransactionCommentsResponse> finTransactionCommentsResponseList = null;

				List<FinTransactionApprStatPojo> finTransactionApprStatPojoList = null;
				List<FinTransactionApprStatResponse> finTransactionApprStatResponseList = null;
						
				List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount = null;
				List<FinancialProjectMileStoneResponse> previouseFinancialProjectMileStoneResponseList = null;
				
				Map<String,Object> customerAmountData = null;
				double totalInterestAmount = 0.0;
				double totalPenalityPaidAmount  =  0.0;
				double totalPendingInterestAmount = 0.0;
				double totalInterestWaiverAdjAmount =  0.0;
				//double sumOfInitiatedWaiverAmount = 0.0;
				Double sumOfPendingWaiverAmount = 0.0;
				final CustomerPropertyDetailsInfo customerPropertyDetailsInfo = financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
				customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
				/* adding customer property Details to List */
				customerPropertyDetailsInfoList.add(customerPropertyDetailsInfo);
				/* getting fin Transaction Cheque Data */
				List<FinTransactionEntryDetailsPojo> finTransactionEntryDetailsPojoList = employeeFinancialServiceDao.getFinTransactionEntryDetails(employeeFinancialTransactionInfo,customerPropertyDetailsInfo); 
				if(Util.isNotEmptyObject(finTransactionEntryDetailsPojoList) && Util.isNotEmptyObject(finTransactionEntryDetailsPojoList.get(0))) {
					
					FinTransactionEntryDetailsInfo finTransactionEntryDetailsInfo = financialMapper.finTransactionEntryDetailsPojoToFinTransactionEntryDetailsInfo(finTransactionEntryDetailsPojoList.get(0));
					/* getting SetOff Payment Amounts TDS, Modification, Legal , Principal and Interest Amounts */
					List<FinTransactionSetOffPojo> finTransactionSetOffPojoList = employeeFinancialServiceDao.getFinTransactionSetOffData(finTransactionEntryDetailsInfo);
					List<FinTransactionSetOffResponse> finTransactionSetOffResponseList = financialMapper.finTransactionSetOffPojoListToFinTransactionSetOffResponseList(finTransactionSetOffPojoList);
					
					//if(loadType!=null && (!loadType.contains(FinEnum.CHECK_CHANGED_TRANSACTION_DETAILS.getId()) && !loadType.contains(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getId()))) {
						if(FinTransactionType.INTEREST_WAIVER.getId().equals(finTransactionEntryDetailsInfo.getTransactionTypeId())) {
							//loading details for interest waiver
							List<Long> finBookingFormAccountsId = new ArrayList<>();

							FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
//For Calculating Interest Amount
							try {
								List<Object> interestData = null;
								ExecutorService executorService = Executors.newFixedThreadPool(2);
								Future<List<Object>> future = executorService.submit(new Callable<List<Object>>(){
								    public List<Object> call() throws Exception {
								    	return loadInterestAmount(customerPropertyDetailsPojoList,customerPropertyDetailsInfo);
								    }
								});
								//System.out.println("future.get() = " + future.get());
								interestData = future.get();
								
								if( Util.isNotEmptyObject(interestData)) {
									@SuppressWarnings("unchecked")
									List<EmployeeFinancialResponse>  employeeFinancialResponseList =  (List<EmployeeFinancialResponse>) interestData.get(0);
									EmployeeFinancialResponse employeeFinancialResponse = employeeFinancialResponseList.get(0);
									//taking interest amount details
									totalInterestAmount = employeeFinancialResponse.getTotalPenaltyAmount()==null?0d:employeeFinancialResponse.getTotalPenaltyAmount();
									totalPenalityPaidAmount  =  employeeFinancialResponse.getTotalPenalityPaidAmount()==null?0d:employeeFinancialResponse.getTotalPenalityPaidAmount();
									totalPendingInterestAmount = employeeFinancialResponse.getTotalPendingPenaltyAmount()==null?0d:employeeFinancialResponse.getTotalPendingPenaltyAmount();
									totalInterestWaiverAdjAmount =  employeeFinancialResponse.getTotalInterestWaiverAdjAmount()==null?0d:employeeFinancialResponse.getTotalInterestWaiverAdjAmount();
									
									if(finTransactionEntryDetailsInfo.getTransactionStatusId().equals(Status.TRANSACTION_COMPLETED.getStatus()) && finTransactionEntryDetailsInfo.getTransactionDate()!=null) {
										//totalInterestWaiverAdjAmount -= finTransactionEntryDetailsInfo.getTransactionAmount();
										//loading all the previous interest waiver amount. before the current loading interest waiver
										customerPropertyDetailsInfo.setEndDate(finTransactionEntryDetailsInfo.getTransactionDate());
										totalInterestWaiverAdjAmount = employeeFinancialServiceDao.getInitiatedInterestWaiverDetails(customerPropertyDetailsInfo,"InterestWaiverRequest");
									}
								}
							} catch(Exception exx) {
								System.out.println(exx);	
							}
							//using penalty id loading milestone id and using milestoe id loading milestone details and demand note date due date
							//For Calculating Interest Amount and principal amount details

							customerAmountData = loadCustomerInterestAmountDetails(customerPropertyDetailsInfo);
							customerAmountData.put("TotalInterestAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(totalInterestAmount).setScale(roundingModeSize, roundingMode).toString()));
							customerAmountData.put("totalPendingInterestAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(totalPendingInterestAmount).setScale(roundingModeSize, roundingMode).toString()));
							customerAmountData.put("TotalInterestWaiverAdjAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(totalInterestWaiverAdjAmount).setScale(roundingModeSize, roundingMode).toString()));
							customerAmountData.put("TotalPenalityPaidAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(totalPenalityPaidAmount).setScale(roundingModeSize, roundingMode).toString()));
							
							for(FinTransactionSetOffPojo setOffPojo : finTransactionSetOffPojoList) {//stored penalty ids at the time of save interest waiver
								finBookingFormAccountsId.add(setOffPojo.getFinBookingFormAccountsId());//this are the penalty id's for interest wavier, this id storing at the time of Save Interest Waiver
							}
							finProjDemandNoteInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
							
							finProjDemandNoteInfo.setCurrentprojectMileStoneIds(finBookingFormAccountsId);
							//loading milestone details id using penalty id
							List<FinBookingFormAccountsPojo> finBookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinMilestoneDetailsForInterestWaiver1(finProjDemandNoteInfo);
							finBookingFormAccountsId.clear();//cleared penalty id's
							for(FinBookingFormAccountsPojo accountsPojo : finBookingFormAccountsPojoLists) {//holding milestone record id, for loading ms records
								finBookingFormAccountsId.add(accountsPojo.getFinBookingFormAccountsId());//this is the milestone id's
							}
							finProjDemandNoteInfo.setCurrentprojectMileStoneIds(finBookingFormAccountsId);
							finProjDemandNoteInfo.setType(Arrays.asList(new Long[] { MetadataId.FIN_BOOKING_FORM_MILESTONES.getId() }));
							//loading milestone details
							listOfPendingMileStoneAmount = loadGeneratedMilestoneDetails(customerPropertyDetailsInfo,finProjDemandNoteInfo);
							previouseFinancialProjectMileStoneResponseList = financialMapper.financialProjectMileStonePojoListToFinancialProjectMileStoneResponseList(listOfPendingMileStoneAmount);
							if(transactionStatusList.contains(finTransactionEntryDetailsInfo.getTransactionStatusId())) {
								//if this is the pending or new transaction, loading interest waiver pending amount for approval, other than current trn
								int count = 0;
								for(FinancialProjectMileStoneResponse mileStoneResponse : previouseFinancialProjectMileStoneResponseList) {
									if(mileStoneResponse.getMilestoneDemandNoteDate()!=null) {
										mileStoneResponse.setDemandNoteDate(mileStoneResponse.getMilestoneDemandNoteDate());
									}
									customerPropertyDetailsInfo.setFinBokAccInvoiceNo(finTransactionSetOffPojoList.get(count++).getFinBokAccInvoiceNo());
									customerPropertyDetailsInfo.setTransactionSetOffEntryId(finTransactionEntryDetailsInfo.getTransactionSetOffEntryId());
									sumOfPendingWaiverAmount = employeeFinancialServiceDao.getInitiatedInterestWaiverDetails(customerPropertyDetailsInfo,"approveInterestWaiver");
									mileStoneResponse.setInterestWaiverPendingAmount(sumOfPendingWaiverAmount.toString());//interest waiver amount, other than current interest waiver trn amount
									customerAmountData.put("totalPendingInterestAmount",currencyUtil.convertUstoInFormat(BigDecimal.valueOf(totalPendingInterestAmount-sumOfPendingWaiverAmount-totalInterestWaiverAdjAmount).setScale(roundingModeSize, roundingMode).toString()));
								}
							}
						}//interest waiver trn condition
				//}
				try {
					EmployeeFinancialTransactionServiceInfo transactionServiceInfo = new EmployeeFinancialTransactionServiceInfo();  
					BeanUtils.copyProperties(finTransactionEntryDetailsInfo, transactionServiceInfo);
					transactionServiceInfo.setRequestUrl(employeeFinancialTransactionInfo.getRequestUrl());
					transactionServiceInfo.setEmpIdFromUrl(employeeFinancialTransactionInfo.getEmpIdFromUrl());
					if(loadType!=null && (!loadType.contains(FinEnum.CHECK_CHANGED_TRANSACTION_DETAILS.getId()) && !loadType.contains(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getId()))) {
						if(finTransactionEntryDetailsInfo.getTransactionStatusId()!=null && !finTransactionEntryDetailsInfo.getTransactionStatusId().equals(Status.TRANSACTION_COMPLETED.getStatus())
								|| (transactionServiceInfo.getRequestUrl()!=null && transactionServiceInfo.getEmpIdFromUrl()!=null && "approveFromMail".equals(transactionServiceInfo.getRequestUrl()))
								) {
							
							List<FinTransactionApprovalDetailsPojo> approveDetails = employeeFinancialServiceDao.isValidEmployeeToApproveTransaction(transactionServiceInfo,null);
							
							if (!approveDetails.isEmpty()) {
								//transactionSetOffApprovalId = approveDetails.get(0).getTransactionSetOffApprovalId();
								//transactionServiceInfo.setTransactionSetOffApprovalId(transactionSetOffApprovalId);
							} else {
								if(Util.isNotEmptyObject(transactionServiceInfo.getRequestUrl()) && Util.isNotEmptyObject(transactionServiceInfo.getEmpIdFromUrl())) {
									throw new EmployeeFinancialServiceException("Invalid request for transaction, No approval found for this transaction.");
								} else {
									throw new EmployeeFinancialServiceException("No approval found for this transaction.");
								}
							}
							//load approve time data
							List<FinTransactionApprovalDetailsPojo> approvalDetails = employeeFinancialServiceDao.getNextLevelEmployeeApprovalDetails(transactionServiceInfo,approveDetails.get(0),Status.APPROVED);
							if (!approvalDetails.isEmpty()) { 
								isThisFinalLevel = isEmptyObject(approvalDetails.get(0).getNextTransactionSetOffApprovalLevelId())?true:false;
								//log.info("Is this final approval "+isThisFinalLevel);
								//transactionServiceInfo.setTransactionSetOffApprovalLevelId(approvalDetails.get(0).getNextTransactionSetOffApprovalLevelId());
							}
						 }
					}
					}catch(Exception e) {
						e.printStackTrace();
						if(e.getMessage()!=null && e.getMessage().contains("Invalid request for transaction,")) {
							throw new EmployeeFinancialServiceException(e.getMessage());
						}
					}

				if(loadType!=null && (!loadType.contains(FinEnum.CHECK_CHANGED_TRANSACTION_DETAILS.getId()) && !loadType.contains(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getId()))) {
					/*loading transaction changed details*/
					changedDetailsPojoList = employeeFinancialServiceDao.getTransactionChnagedDetails(finTransactionEntryDetailsInfo);
					changedDetailsResponseList = financialMapper.copyPropertiesFromFinTransactionChangedDtlsPojoTOFinTransactionChangedDtlsResponseList(changedDetailsPojoList);
					
					//loading attachments
					transactionEntryDocPojos  = employeeFinancialServiceDao.getFinTransactionEntryDocuments(finTransactionEntryDetailsInfo, MetadataId.UPLOADED);
					transactionEntryDocResponses = financialMapper.copyPropertiesFromFinTransactionEntryDocPojoTOFinTransactionEntryDocResponseList(transactionEntryDocPojos);
					
					//loading receipt documents
					transactionReceiptDocPojos  = employeeFinancialServiceDao.getFinTransactionEntryDocuments(finTransactionEntryDetailsInfo, MetadataId.GENERATED);
					transactionReceiptResponses = financialMapper.copyPropertiesFromFinTransactionEntryDocPojoTOFinTransactionEntryDocResponseList(transactionReceiptDocPojos);
					
					/* getting all Transaction Comments */
					employeeFinancialTransactionInfo.setTypeId(finTransactionEntryDetailsInfo.getTransactionEntryId());
					finTransactionCommentsPojoList = employeeFinancialServiceDao.getFinTransactionCommentsData(employeeFinancialTransactionInfo);
					finTransactionCommentsResponseList = financialMapper.finTransactionCommentsPojoListToFinTransactionCommentsResponseList(finTransactionCommentsPojoList);
					
					/* getting transaction approval details*/
					finTransactionApprStatPojoList = employeeFinancialServiceDao.getFinTransactionApprStatData(employeeFinancialTransactionInfo);
					finTransactionApprStatResponseList = financialMapper.finTransactionApprStatPojoListToFinTransactionApprStatResponseList(finTransactionApprStatPojoList);
				}					
					Timestamp transactionEditedDate = null;
					String transactionEditedBy = "";
					if(Util.isNotEmptyObject(changedDetailsPojoList)) {
						FinTransactionChangedDtlsPojo changedDtlsPojo = changedDetailsPojoList.get(changedDetailsPojoList.size()-1);
						 transactionEditedDate = changedDtlsPojo.getCreatedDate();
						 transactionEditedBy = Util.isEmptyObject(changedDtlsPojo.getEmpName())?"":changedDtlsPojo.getEmpName();
					} else if(Util.isNotEmptyObject(finTransactionApprStatPojoList)) {
						FinTransactionApprStatPojo apprStatPojo = finTransactionApprStatPojoList.get(0);
						transactionEditedDate = apprStatPojo.getCreatedDate();
						transactionEditedBy = Util.isEmptyObject(apprStatPojo.getEmpName())?"":apprStatPojo.getEmpName();
						if(customerAmountData!=null) {
							customerAmountData.put("crmName",transactionEditedBy);
						}
					}
					employeeFinancialTransactionResponse.setLastTransactionEditedDate(transactionEditedDate);
					employeeFinancialTransactionResponse.setLastTransactionEditedBy(transactionEditedBy);
					
					/* Adding All Responses to finTransactionEntryDetailsResponse */
					FinTransactionEntryDetailsResponse finTransactionEntryDetailsResponse = financialMapper.finTransactionEntryDetailsPojoToFinTransactionEntryDetailsResponse(finTransactionEntryDetailsPojoList.get(0), finTransactionSetOffResponseList, 
							finTransactionCommentsResponseList, finTransactionApprStatResponseList,changedDetailsResponseList,transactionEntryDocResponses,transactionReceiptResponses,previouseFinancialProjectMileStoneResponseList);
					finTransactionEntryDetailsResponse.setIsThisFinalLevel(isThisFinalLevel);
					finTransactionEntryDetailsResponse.setCustomerAmountData(customerAmountData);
					finTransactionEntryDetailsResponseList.add(finTransactionEntryDetailsResponse);
				}
			}
		}
		/* setting Customer Property Details List and FinTransaction Cheque List to Response Object */
		employeeFinancialTransactionResponse.setCustomerPropertyDetailsInfoList(customerPropertyDetailsInfoList);
		employeeFinancialTransactionResponse.setFinTransactionEntryDetailsResponseList(finTransactionEntryDetailsResponseList);
		return employeeFinancialTransactionResponse;
	}

	@Override
	public List<Object> loadInterestAmount(List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList, CustomerPropertyDetailsInfo customerPropertyDetailsInfo) throws Exception {
		Timestamp timestamp = new Timestamp(new Date().getTime());
		//constructing object for getting interest records
		EmployeeFinancialServiceInfo employeeFinancialRequest = new EmployeeFinancialServiceInfo();
		employeeFinancialRequest.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
		employeeFinancialRequest.setRequestUrl("GiveInterestWaiverReport");
		employeeFinancialRequest.setActionUrl("InterestWaiverRequest");
		employeeFinancialRequest.setIsInterestOrWithOutInterest("With Interest");
		employeeFinancialRequest.setReGenerateDemandNote(true);
		employeeFinancialRequest.setCustomerPropertyDetailsPojoList(customerPropertyDetailsPojoList);
		employeeFinancialRequest.setSiteId(customerPropertyDetailsInfo.getSiteId());
		
		List<FinancialProjectMileStoneInfo> milestoneRequest = new ArrayList<>(); 
		//Creating dummy milestone object for loading interest amount
		FinancialProjectMileStoneInfo milestoneInfoForInterest = new FinancialProjectMileStoneInfo();
		milestoneInfoForInterest.setProjectMilestoneId(0l);
		milestoneInfoForInterest.setMilestoneName("Dummy MileStone for Regenerate Demand Note");
		milestoneInfoForInterest.setFinMilestoneClassifidesId(1l);
		milestoneInfoForInterest.setPercentagesId(10l);
		milestoneInfoForInterest.setMileStonePercentage(12d);
		milestoneInfoForInterest.setMilestoneDate(timestamp);
		milestoneInfoForInterest.setMileStoneDueDate(timestamp);
		milestoneInfoForInterest.setMileStoneNo(0l);
		milestoneInfoForInterest.setDemandNoteDate(timestamp);
		milestoneInfoForInterest.setInterestCalculationUptoDate(TimeUtil.removeOneDay(timestamp));
		milestoneInfoForInterest.setSiteId(customerPropertyDetailsInfo.getSiteId());
		milestoneInfoForInterest.setInterestSelectionType(Status.With_Interest.getStatus());
		
		milestoneRequest.add(milestoneInfoForInterest);
		employeeFinancialRequest.setFinancialProjectMileStoneRequests(milestoneRequest);
		//these method used in many places 
		List<Object> list = getCustomerFinancialDetails(employeeFinancialRequest);
		return list;
	}

	private Map<String, Object> loadCustomerInterestAmountDetails(CustomerPropertyDetailsInfo customerPropertyDetailsInfo) {
		Map<String,Object> customerAmountData = new HashMap<>();
		BookingFormRequest bookingFormRequest = new BookingFormRequest();
		bookingFormRequest.setSiteId(customerPropertyDetailsInfo.getSiteId());
		bookingFormRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
		
		List<FinBookingFormAccountsPojo> milestonePaidList = employeeFinancialServiceDao.getFlatPaidAmountDetails(bookingFormRequest,Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId(),MetadataId.FIN_PENALTY.getId()));
		
		long blockWorkCompletion = employeeFinancialServiceDao.loadBlockCompletionPercent(bookingFormRequest);
		double totalPendingAmountOnFlat = customerPropertyDetailsInfo.getTotalAgreementCost();
		double flatCost = customerPropertyDetailsInfo.getTotalAgreementCost();
		//double getMilestoneInitiatedAmount = 0.0;
		double getMilestonePaidAmount = 0.0;
		
		//double interestWaiverAdjAmount = 0.0;
		//double interestPaidAmount = 0.0;
		if (milestonePaidList != null) {
			for (FinBookingFormAccountsPojo pojo : milestonePaidList) {
				if(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId().equals(pojo.getType())) {
					if(pojo.getMsStatusId()!=null && !pojo.getMsStatusId().equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
						//getMilestoneInitiatedAmount += (pojo.getPayAmount() == null ? 0 : pojo.getPayAmount());
					}
					getMilestonePaidAmount += (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());
					//getMilestoneInitiatedBalanceAmount += getMilestoneInitiatedAmount - getMilestonePaidAmount;
					totalPendingAmountOnFlat -= (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());
				} else if(MetadataId.FIN_PENALTY.getId().equals(pojo.getType())) {
					//interestWaiverAdjAmount += (pojo.getInterestWaiverAdjAmount() == null ? 0 : pojo.getInterestWaiverAdjAmount());
					//interestPaidAmount += (pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount());
				} else {
					
				}
			}
		}
		
		//customerAmountData.put("interestWaiverAdjAmount", currencyUtil.getTheAmountWithCommas(Double.valueOf(interestWaiverAdjAmount),roundingModeSize,roundingMode));
		//customerAmountData.put("interestPaidAmount", currencyUtil.getTheAmountWithCommas(Double.valueOf(interestPaidAmount),roundingModeSize,roundingMode));
		customerAmountData.put("blockCompletionPercent", blockWorkCompletion+"%");
		customerAmountData.put("totalPendingAmount", currencyUtil.getTheAmountWithCommas(Double.valueOf(totalPendingAmountOnFlat),roundingModeSize,roundingMode));
		customerAmountData.put("totalAmountPaid", currencyUtil.getTheAmountWithCommas(Double.valueOf(getMilestonePaidAmount),roundingModeSize,roundingMode) );
		customerAmountData.put("flatCost", currencyUtil.getTheAmountWithCommas(Double.valueOf(flatCost),roundingModeSize,roundingMode) );
	 return customerAmountData;
	}//method

	private List<FinancialProjectMileStonePojo> loadGeneratedMilestoneDetails(CustomerPropertyDetailsInfo customerPropertyDetailsInfo, FinancialProjectMileStoneInfo finProjDemandNoteInfo) throws Exception {
		//FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
		List<FinancialProjectMileStonePojo> listOfPendingMileStoneAmount = null;
		finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] { Status.PENDING.getStatus(), Status.PAID.getStatus(), Status.INPROGRESS.getStatus() }));

		finProjDemandNoteInfo.setCondition("LoadMilestoneDetails");
		finProjDemandNoteInfo.setInterestCalculationFrom("LoadMilestoneDetails");
		finProjDemandNoteInfo.setInterestSelectionType(Status.With_Out_Interest.getStatus());

		// calculating interest amount
		listOfPendingMileStoneAmount = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo,FinEnum.DO_NOT_lOAD_DATA);
		return listOfPendingMileStoneAmount;
	}

	/**
	 * these method approves the receipt and payment and interest waiver transaction
	 */
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialTransactionResponse setApproveOrRejectMisReceiptOrPayment(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, FinEnum multipleOrSingleApproval)
			throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.setApproveOrRejectMisReceiptOrPayment() *****");
		
		if(transactionServiceInfo.getOptionalButtonType()!=null && transactionServiceInfo.getOptionalButtonType().equals("Modify")){
			//if transaction mode changed to cheque to online or vise versa, then inserting new transaction 
			boolean  resp = checkModeorFlatNoChanged(transactionServiceInfo);
			if(resp) {
				return new EmployeeFinancialTransactionResponse();
			}
			if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos())) {
				List<FileInfo> listOfInfo = transactionServiceInfo.getFileInfos();
				for (Iterator<FileInfo> iterator = listOfInfo.iterator(); iterator.hasNext();) {
					FileInfo fileInfo = iterator.next();//if base64 is empty then no need this file, can be removed
					if(Util.isNotEmptyObject(fileInfo) && Util.isEmptyObject(fileInfo.getBase64()) && Util.isNotEmptyObject(fileInfo.getUrl())) {
						iterator.remove();
					}
				}
			}
		}
		boolean isThisIsFinalLevel = false;
		//boolean isRequestFromMultipleApproval =false;
		long transactionSetOffApprovalId = 0l;
		Long transactionApproveStatId =  0l;
		Long nextApprovalModule = 0l;
		List<Long> listOfBookingStatusAppr = null;
		long transactionEntryId =  transactionServiceInfo.getTransactionEntryId();
		transactionServiceInfo.setStatusId(Status.ACTIVE.getStatus());
		transactionServiceInfo.setSendNotification(Boolean.TRUE);
		EmployeeFinancialTransactionResponse response2 = new EmployeeFinancialTransactionResponse();
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		String transactionFor = transactionServiceInfo.getTransactionFor();
		boolean isThisPaymentTransaction = (Util.isNotEmptyObject(transactionFor) && transactionServiceInfo.getTransactionTypeName().equals(MetadataId.PAYMENT.getName()));
		String requestUrl = transactionServiceInfo.getRequestUrl()==null?"":transactionServiceInfo.getRequestUrl();
		getPaymentSetOffType(transactionServiceInfo);
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
		employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
		transactionServiceInfo.setThisPaymentTransaction(isThisPaymentTransaction);
		//if (transactionServiceInfo.getTransactionForId()!=null && transactionServiceInfo.getTransactionForId().equals(FinTransactionFor.FLAT_CANCELLATION.getId())) {
			listOfBookingStatusAppr = Arrays.asList(Status.ACTIVE.getStatus(),Status.SWAP.getStatus(), Status.PRICE_UPDATE.getStatus(), Status.CANCEL.getStatus(),
					Status.RETAINED.getStatus(), Status.INACTIVE.getStatus(), Status.PMAY_SCHEME_ELIGIBLE.getStatus(),Status.CANCELLED_NOT_REFUNDED.getStatus());
		//}
		
		if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {
			if (transactionServiceInfo.getTransactionForId()!=null && transactionServiceInfo.getTransactionForId().equals(FinTransactionFor.FLAT_CANCELLATION.getId())) {
				//if this is the payment refund request, then loading all types of status data
				employeeFinancialServiceInfo.setStatusIds(listOfBookingStatusAppr);
				employeeFinancialServiceInfo.setCondition(FinEnum.GET_INACTIVE_BOOKINGS.getName());
			}
			//loading customer details
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
				transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
				employeeFinancialServiceInfo.setCustomerPropertyDetailsPojoList(customerPropertyDetailsPojos);
			} else {
				if (transactionServiceInfo.getButtonType().equalsIgnoreCase("Reject")) {
					//if customer data is not loaded,means customer is not active, so loading remaining status data
					employeeFinancialServiceInfo.setStatusIds(listOfBookingStatusAppr);
					employeeFinancialServiceInfo.setCondition(FinEnum.GET_INACTIVE_BOOKINGS.getName());
					//loading non active customer details
					customerPropertyDetailsPojos= employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
					if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
						customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
						transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
					}
				}
			}
			if(Util.isEmptyObject(customerPropertyDetailsPojos)) {
				throw new EmployeeFinancialServiceException("Invalid request for transaction, The Current running transaction booking is not active, Please reject and recreate the transaction.");
			}
		}
		
		
		/*bvr 1 */
		//getting flat saleOwner Id based on account id and passing for recipet document
		Long siteAccountId1 =transactionServiceInfo.getSiteAccountId();
		//Long transactionEntryId=transactionServiceInfo.getTransactionEntryId();
		EmployeeFinancialServiceInfo employeeFinancialRequestObj = new EmployeeFinancialServiceInfo();
		employeeFinancialRequestObj.setSiteAccountId(siteAccountId1);
		employeeFinancialRequestObj.setTransactionEntryId(transactionEntryId);
		employeeFinancialRequestObj.setSiteId(transactionServiceInfo.getSiteId());
		List<FlatSaleOwnersByAccount> saleOwner=employeeFinancialServiceDao.getFlatSaleOwnerByAccountId(employeeFinancialRequestObj);
		if(Util.isNotEmptyObject(saleOwner)) {
			transactionServiceInfo.setFlatSaleOwnerIdBasedOnAccountId(saleOwner.get(0).getFlatSaleOwnerIdBasedOnAccountId());
			transactionServiceInfo.setFlatSaleOwnerNameBasedOnAccountId(saleOwner.get(0).getFlatSaleOwnerNameBasedOnAccountId());
		}
		
		List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
		List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
		transactionServiceInfo.setOfficeDetailsList(officeDetailsResponseList);
		//loading current approval details
		List<FinTransactionApprovalDetailsPojo> approveDetails = employeeFinancialServiceDao.isValidEmployeeToApproveTransaction(transactionServiceInfo,null);
		if (Util.isNotEmptyObject(approveDetails)) {//!approveDetails.isEmpty()//uncleared cheque
			//current employee approval id, so using this id we will load next approval id using getNextLevelEmployeeApprovalDetails() method
			transactionSetOffApprovalId = approveDetails.get(0).getTransactionSetOffApprovalId();
			transactionServiceInfo.setTransactionSetOffApprovalId(transactionSetOffApprovalId);
		} else {
			//if this is the request from email approval, and we don't found any approval then throw the exception
			if(transactionServiceInfo.getRequestUrl()!=null && transactionServiceInfo.getEmpIdFromUrl()!=null && "approveFromMail".equals(transactionServiceInfo.getRequestUrl())) {
				throw new EmployeeFinancialServiceException("Invalid request for transaction, No approval found for this transaction.");
			} else {
				//if this transaction approving from employee portal and we don't found any data of approval, thenn  throw the exception
				throw new EmployeeFinancialServiceException("No approval found for this transaction.");
			}
		}
		//setApproveOrRejectMisReceiptOrPayment
		//using these object loading approveDetails next approval details
		List<FinTransactionApprovalDetailsPojo> approvalDetailsList = employeeFinancialServiceDao.getNextLevelEmployeeApprovalDetails(transactionServiceInfo,approveDetails.get(0),Status.APPROVED);
		if (approvalDetailsList.isEmpty()) {
			throw new EmployeeFinancialServiceException("No approval found for this transaction.");
		} else if (approvalDetailsList.size() > 1) {
			throw new EmployeeFinancialServiceException("Found duplicate approval mapping for transaction.");
		} else {//pending transaction for approval level 2
			FinTransactionApprovalDetailsPojo approvalDetails = approvalDetailsList.get(0);
			transactionServiceInfo.setThisTransactionRequest(false);
			if(approvalDetails.getTrnRequestLevel()!=null) {
				transactionServiceInfo.setThisTransactionRequest(MetadataId.YES.getId().equals(approvalDetails.getTrnRequestLevel()));	
			}
			nextApprovalModule = approvalDetails.getNextApprovalModule()==null?0l:approvalDetails.getNextApprovalModule();
			isThisIsFinalLevel = isEmptyObject(approvalDetails.getNextTransactionSetOffApprovalLevelId())?true:false;log.info("Is this final approval "+isThisIsFinalLevel);
			transactionServiceInfo.setTransactionSetOffApprovalLevelId(approvalDetails.getNextTransactionSetOffApprovalLevelId());
			transactionServiceInfo.setCurrentApprovalLevelName(transactionServiceInfo.getEmployeeName());
			transactionServiceInfo.setNextApprovalModule(nextApprovalModule);
		}
		
		if(Util.isEmptyObject(transactionServiceInfo.getTransactionNo())) {
			getFinancialTransactionInvoiceNumber(transactionServiceInfo);
		}//previous approve details
		//loading approve reject details of the current transaction, so we can send mail to these id's
		List<FinTransactionApprStatPojo> finTransactionApprStatPojoList = employeeFinancialServiceDao.getFinTransactionApprStatData(transactionServiceInfo);
		if (transactionServiceInfo.getButtonType().equalsIgnoreCase("Reject")) {
			
			if(FinTransactionType.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionTypeId())) {
				employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo,Status.REJECTED.getStatus());
				sendInterestWaiverTransactionApprovedMailDetails(transactionServiceInfo,finTransactionApprStatPojoList,officeDetailsResponseList,requestUrl);
				return response2;
			}//if this is waiver remaining code will not execute
			
			//sending email to this finTransactionApprStatPojoList object emails
			transactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);
			if(multipleOrSingleApproval!=null && transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("online")) {
				EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionInfo = (EmployeeFinancialTransactionServiceInfo) transactionServiceInfo.clone();
				employeeFinancialTransactionInfo.setStatusId(Status.TRANSACTION_COMPLETED.getStatus());
				if(FinTransactionType.RECEIPT.getId().equals(transactionServiceInfo.getTransactionTypeId())) {
					updateSuspenseEntry(employeeFinancialTransactionInfo);
				}
			}
			
			//handling in backend if selected reason other than "Others" in drop down
			if(Util.isNotEmptyObject(transactionServiceInfo.getChequeBounceReasonValue()) && !"Others".equals(transactionServiceInfo.getChequeBounceReasonValue())) {
				//cheque bounce reasong value only cheque bounce comment
				transactionServiceInfo.setChequeBounceComment(transactionServiceInfo.getChequeBounceReasonValue());
			}

			if(transactionServiceInfo.getOptionalButtonType()!=null && transactionServiceInfo.getOptionalButtonType().equals(Status.CHEQUE_BOUNCED.getDescription())) {
				transactionServiceInfo.setButtonType(Status.CHEQUE_BOUNCED.getDescription());
				transactionServiceInfo.setChequeBounceReasonValue(MetadataId.OTHER.getName());
				//
				if(Util.isEmptyObject(transactionServiceInfo.getChequeBounceReasonValue()) && Util.isEmptyObject(transactionServiceInfo.getChequeBounceComment())) {
					throw new EmployeeFinancialServiceException("Cheque bounce reason found empty, Please enter cheque bounce reason... ");
				}
			}
			//if bounce reason is not empty
			if (Util.isNotEmptyObject(transactionServiceInfo.getChequeBounceReasonValue())) {
				FinTransactionChequePojo chequePojo = (FinTransactionChequePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionChequePojo.class);
				chequePojo.setChequeBounceReasonId(getMetaDataId(transactionServiceInfo.getChequeBounceReasonValue().toUpperCase()));
				chequePojo.setModifiedBy(transactionServiceInfo.getEmployeeId());
				
				if (transactionServiceInfo.getChequeBounceReasonValue().equalsIgnoreCase(MetadataId.INSUFFICIENT_BALANCE.getName())) {
						isThisIsFinalLevel = false;
						employeeFinancialServiceDao.updateChequeBounceDetails(chequePojo);
						transactionServiceInfo.setTransactionActionType(Status.INPROGRESS.getStatus());
						transactionApproveStatId =  employeeFinancialServiceDao.saveApproveRejectStatistics((FinTransactionApprRejectStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionApprRejectStatPojo.class));
						transactionServiceInfo.setTransactionApproveStatId(transactionApproveStatId);
				} else if (transactionServiceInfo.getChequeBounceReasonValue().equalsIgnoreCase(MetadataId.OTHER.getName())) {
						employeeFinancialServiceDao.updateChequeBounceDetails(chequePojo);
						response2 =  rejectTransaction(transactionServiceInfo,response2,Status.CHEQUE_BOUNCED.getStatus());
						if(!requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName()) ) {//if this request is not from trn multiple approval 
							employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo),Status.CHEQUE_BOUNCED.getDescription(),null);
						}
						
						if (FinTransactionType.RECEIPT.getName().equalsIgnoreCase(transactionServiceInfo.getTransactionTypeName())
								&& FinTransactionMode.CHEQUE.getName().equalsIgnoreCase(transactionServiceInfo.getTransactionModeName())
								) {
							//sending cheque bounce email to customer and push notification
							employeeFinancialHelper.sendFinancialChequeBounceEmail(Arrays.asList(transactionServiceInfo),Status.CHEQUE_BOUNCED.getDescription(),null);
							employeeFinancialHelper.sendFinancialChequeBouncePushNoti(transactionServiceInfo);
						}
						
						return response2;
					}
					return response2;
			} else {
				//if is rejected transaction
				response2 = rejectTransaction(transactionServiceInfo,response2,Status.REJECTED.getStatus());
				if(!requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName())) {
					employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo),Status.REJECTED.getDescription(),null);
				}
				return response2;
			}		 	
		 } else if(transactionServiceInfo.getButtonType().equalsIgnoreCase("ModifyReject")){
			transactionServiceInfo.setTransactionActionType(Status.MODIFY_REJECT.getStatus());
			transactionApproveStatId = employeeFinancialServiceDao.saveApproveRejectStatistics((FinTransactionApprRejectStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(
							transactionServiceInfo, FinTransactionApprRejectStatPojo.class));
			transactionServiceInfo.setTransactionApproveStatId(transactionApproveStatId);
			employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo,Status.MODIFY_REJECT.getStatus());
			return response2;
		 } else if(transactionServiceInfo.getButtonType().equalsIgnoreCase("Modify")){
				customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsInfo.setFlatBookingId(transactionServiceInfo.getBookingFormId());
			 	Timestamp aggrementDate = employeeFinancialServiceDao.getFlatAgreementCompletedDate(null,customerPropertyDetailsInfo);
			 	FinTransactionApprovalDetailsPojo modifyapprovalDetailsPojo = null;
			 	List<FinTransactionApprovalDetailsPojo> listOfNextApprovalEmaEmailsForModify = null;
			 	List<FinTransactionApprovalDetailsPojo> approvalDetailsListForModify = null;
			 	transactionServiceInfo.setThisPaymentTransaction(isThisPaymentTransaction);
				if(Util.isNotEmptyObject(aggrementDate)) {
					transactionServiceInfo.setFlatAgreementCompleted(Boolean.TRUE);
				} else {
					transactionServiceInfo.setFlatAgreementCompleted(Boolean.FALSE);
				}
				
			 	transactionServiceInfo.setTransactionActionType(Status.MODIFY.getStatus());
				transactionApproveStatId =  employeeFinancialServiceDao.saveApproveRejectStatistics((FinTransactionApprRejectStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionApprRejectStatPojo.class));
				transactionServiceInfo.setTransactionApproveStatId(transactionApproveStatId);
			    
				List<FinTransactionApprovalDetailsPojo> approvalDetailsForModification = employeeFinancialServiceDao.getModifyLevelDetails(transactionServiceInfo,approvalDetailsList.get(0));
				//List<FinTransactionApprovalDetailsPojo> approvalDetailsForModification = employeeFinancialServiceDao.getNextLevelEmployeeApprovalDetails(transactionServiceInfo,null,Status.CREATED);

			    if(approvalDetailsForModification.isEmpty()) {
					throw new EmployeeFinancialServiceException("No mapping found for this transaction, Please contact support team.");
				} else if(approvalDetailsForModification.size()>1) {
					throw new EmployeeFinancialServiceException("Found duplicate approval mapping for transaction, Please contact support team.");
				} else {
					modifyapprovalDetailsPojo = approvalDetailsForModification.get(0);
					transactionServiceInfo.setTransactionSetOffApprovalLevelId(modifyapprovalDetailsPojo.getTransactionSetOffApprovalLevelId());
					//transactionServiceInfo.setNextApprovalLevelName(approvalDetailsForModification.get(0).getLevelName());
				}
			    /*if(Util.isNotEmptyObject(finTransactionApprStatPojoList)) {
			    	finTransactionApprStatPojoList.get(0).getEmpId();
			    }*/
			    boolean isTransactionCreatedEmpExistsInFirstLevel = true;
				employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo,Status.MODIFY.getStatus());

			if (modifyapprovalDetailsPojo.getLevelName() != null && modifyapprovalDetailsPojo.getLevelName().equalsIgnoreCase("Level1")) {
				//loading level1 employee details to trigger the modify transaction email	
				listOfNextApprovalEmaEmailsForModify = employeeFinancialServiceDao.getTheNextLevelEmplaoyeeDetails(transactionServiceInfo);
					if(Util.isNotEmptyObject(listOfNextApprovalEmaEmailsForModify)) {
						for (FinTransactionApprovalDetailsPojo approvalDetailsPojo : listOfNextApprovalEmaEmailsForModify) {
							if(finTransactionApprStatPojoList.get(0).getEmpId().equals(approvalDetailsPojo.getEmpId())) {
								//checking is approval statistics pojo emp id is exist in first level or not,
								//if not then load the transaction created employee level, to transfer transaction to his login
								isTransactionCreatedEmpExistsInFirstLevel = false;
							}
						}
						if(isTransactionCreatedEmpExistsInFirstLevel) {//this value true means, the transaction created employee not in first level of mapping
							EmployeeFinancialTransactionServiceInfo modtransactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) transactionServiceInfo.clone();
							modtransactionServiceInfo.setTransactionStatusId(Status.NEW.getStatus());
							modtransactionServiceInfo.setEmployeeId(finTransactionApprStatPojoList.get(0).getEmpId());
							//if this transaction created employee id does't exists in first level mapping, then load transaction created employee level details,
							//so we can transfer this transaction to his login details
							approvalDetailsListForModify = employeeFinancialServiceDao.getNextLevelEmployeeApprovalDetails(modtransactionServiceInfo,null,Status.CREATED);
							if (approvalDetailsListForModify.isEmpty()) {
								throw new EmployeeFinancialServiceException("No mapping found for this transaction, Please contact to support team..!");
							} else if (approvalDetailsListForModify.size() > 1) {
								throw new EmployeeFinancialServiceException("Found duplicate approval mapping for transaction.");
							} else {
								modtransactionServiceInfo.setTransactionSetOffApprovalLevelId(approvalDetailsListForModify.get(0).getTransactionSetOffApprovalLevelId());
							}
							employeeFinancialServiceDao.updateNextLevelTransactionApprovalDetails((FinTransactionSetOffApprovalPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(modtransactionServiceInfo,FinTransactionSetOffApprovalPojo.class));
						
							transactionServiceInfo.setNextApprovalLevelName(finTransactionApprStatPojoList.get(0).getEmpName());
							transactionServiceInfo.setListOfNextApprovalEmaEmails(null);
							transactionServiceInfo.setFinTransactionApprStatPojoList(Arrays.asList(finTransactionApprStatPojoList.get(0)));//not required approve reject data for sending modify email
							
							if(!requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName())) {
								employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo),Status.MODIFY.getDescription(),null);
							}
						} else {
							employeeFinancialServiceDao.updateNextLevelTransactionApprovalDetails((FinTransactionSetOffApprovalPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionSetOffApprovalPojo.class));
							//sending mail to next level approval employee's
							for (FinTransactionApprovalDetailsPojo approvalDetailsPojo : listOfNextApprovalEmaEmailsForModify) {
								transactionServiceInfo.setNextApprovalLevelName(approvalDetailsPojo.getEmpName());
								transactionServiceInfo.setListOfNextApprovalEmaEmails(Arrays.asList(approvalDetailsPojo));
								transactionServiceInfo.setFinTransactionApprStatPojoList(null);//not required approve reject data for sending modify email
								
								if(!requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName())) {//if request is not from multiple approval 
									employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo),Status.MODIFY.getDescription(),null);
								}
							}
						}
					}
				} else {
					
				}
				//transactionServiceInfo.setListOfNextApprovalEmaEmails(listOfNextApprovalEmaEmails);
				//transactionServiceInfo.setFinTransactionApprStatPojoList(null);//not required approve reject data for sending modify email
				//employeeFinancialServiceDao.takeTransactionBackToEmployee(approveDetails);
				/*if(!requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName())) {
					employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo),Status.MODIFY.getDescription(),null);
				}*/
				//String s = null;s.trim();
			return response2;
		}
		
		FinancialDemandNoteMS_TRN_Info trn_Request = new FinancialDemandNoteMS_TRN_Info();
		trn_Request.setSiteId(customerPropertyDetailsInfo.getSiteId());
		trn_Request.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
		trn_Request.setSiteBankAccountNumber(transactionServiceInfo.getSiteBankAccountNumber());
		trn_Request.setSiteAccountId(transactionServiceInfo.getSiteAccountId());
		if(!FinTransactionType.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionTypeId())) {//pending transaction for approval,uncleared cheque
			if(!transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("waived off")) {
			      List<Map<String, Object>> siteAccountId = employeeFinancialServiceDao.loadListSiteAccountNumberIdUsingNumber(trn_Request,"ApproveTransaction");
			      if (Util.isNotEmptyObject(siteAccountId)) {
				    for (Map<String, Object> map : siteAccountId) {
					  if(!customerPropertyDetailsInfo.getSiteId().equals(map.get("SITE_ID")==null?0:Long.valueOf(map.get("SITE_ID").toString()))) {
						throw new EmployeeFinancialServiceException("Account number not found in : "+customerPropertyDetailsInfo.getSiteName()+", Transaction amount "+transactionServiceInfo.getTransactionAmount());
					   }
				     }
			      } else {
				  throw new EmployeeFinancialServiceException("Account number not found in : "+customerPropertyDetailsInfo.getSiteName()+", Transaction amount "+transactionServiceInfo.getTransactionAmount());
				//transactionServiceInfo.setSiteAccountId(siteAccountId);
			      }
			}
		}
		
		if(transactionServiceInfo.getTransactionReceiveDate()!=null) {//pending transaction for approval
			transactionServiceInfo.setTransactionReceiveDate(TimeUtil.addCurrentTimeToTimeStamp(transactionServiceInfo.getTransactionReceiveDate()));
		}
		if(transactionServiceInfo.getTransactionDate()!=null) {//pending transaction for approval
			transactionServiceInfo.setTransactionDate(TimeUtil.addCurrentTimeToTimeStamp(transactionServiceInfo.getTransactionDate()));
		}
		
		//============================================
		if(isThisIsFinalLevel) {//uncleared cheque
			FinTransactionEntryDetailsInfo transactionEntryDetailsInfo = (FinTransactionEntryDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, FinTransactionEntryDetailsInfo.class);
			
			if (transactionServiceInfo.getTransactionTypeName().equalsIgnoreCase(FinTransactionType.PAYMENT.getName())) {
				transactionServiceInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionDate());
				transactionEntryDetailsInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionDate());
				transactionEntryDetailsInfo.setActualTransactionDate(transactionServiceInfo.getTransactionDate());
			} else {//uncleared cheque
				transactionServiceInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
				transactionEntryDetailsInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
				transactionEntryDetailsInfo.setActualTransactionDate(transactionServiceInfo.getTransactionReceiveDate());
			}
			/*transactionServiceInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
			transactionEntryDetailsInfo.setActualTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
			transactionEntryDetailsInfo.setActualTransactionDate(transactionServiceInfo.getTransactionReceiveDate());*/
			if(transactionServiceInfo.getPaymentSetOffTypes().contains(MetadataId.PRINCIPAL_AMOUNT.getId())) {//uncleared cheque
				transactionServiceInfo.setThisShiftTransactionFromApproval(true);
				shiftThePaymentTransactions(transactionServiceInfo, transactionEntryDetailsInfo);
				shiftTheReceiptTransactions(transactionServiceInfo, transactionEntryDetailsInfo, customerPropertyDetailsInfo);	
			}
		}
		
		//12-may - 1st milestone
		//15-may - 2nd milestone   
		//16-may - 3rd milestone
		
		
		//12-may - 2st milestone
		//15-may - 3nd milestone   
		//16-may - 4rd milestone
		//11-may - 1rd milestone
		//=============================================
		//this code is used tell user to approve trn in received date order
		/*List<FinTransactionEntryPojo> transactionEntryPojos = employeeFinancialServiceDao.isAnyTransactionInApproval(transactionServiceInfo,Status.APPROVED);
		if(Util.isNotEmptyObject(transactionEntryPojos) && isThisIsFinalLevel) {
			for (FinTransactionEntryPojo finTransactionEntryPojo : transactionEntryPojos) {	//2019-08-29 23:59:50.0 is not before 2019-08-13 23:59:50.0 
				if(transactionServiceInfo.getTransactionReceiveDate()!=null &&
						finTransactionEntryPojo.getTransactionReceiveDate() !=null && 
						finTransactionEntryPojo.getTransactionReceiveDate().before(transactionServiceInfo.getTransactionReceiveDate())) {
					String str = "You cannot approve receipt/payment on Flat "+customerPropertyDetailsInfo.getFlatNo()+" of Project "+customerPropertyDetailsInfo.getSiteName()+" with received date "+TimeUtil.timestampToDD_MM_YYYY(transactionServiceInfo.getTransactionReceiveDate())+", as there are previous payment(s)/receipt(s) pending on that Flat.";
					throw new EmployeeFinancialServiceException(str);
				} else if(finTransactionEntryPojo.getTransactionDate()!=null && 
						transactionServiceInfo.getTransactionDate() !=null &&
						finTransactionEntryPojo.getTransactionDate().before(transactionServiceInfo.getTransactionDate())) {
					//String str = "You cannot approve receipt/payment on Flat "+customerPropertyDetailsInfo.getFlatNo()+" of Project "+customerPropertyDetailsInfo.getSiteName()+" with received date "+TimeUtil.timestampToDD_MM_YYYY(transactionServiceInfo.getTransactionReceiveDate())+", as there are previous payment(s)/receipt(s) pending on that Flat.";
					//throw new EmployeeFinancialServiceException(str);
				}
			}
		}*/
		
		long count  = employeeFinancialServiceDao.checkDemandNoteIsGeneratedOrNotForTransaction(transactionServiceInfo);
		if (count == 0) {
			transactionServiceInfo.setDemandNoteGenerated(false);
			//throw new EmployeeFinancialServiceException("Demand note not generated for Flat, Please generate Demand Note and try again!");
		} else {
			transactionServiceInfo.setDemandNoteGenerated(true);
		}
		if(transactionServiceInfo.getTransactionTypeId().equals(FinTransactionType.RECEIPT.getId()) && transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("online")) {
			transactionServiceInfo.setTransactionDate(transactionServiceInfo.getTransactionReceiveDate());
		} else if(transactionServiceInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId()) && transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("online")) {
			transactionServiceInfo.setChequeNumber(null);
		}
		if(!isThisIsFinalLevel && !transactionServiceInfo.getButtonType().equalsIgnoreCase("Modify")) {
			//for final approval not updating next level approval id, as for final level approval id is null
			employeeFinancialServiceDao.updateNextLevelTransactionApprovalDetails((FinTransactionSetOffApprovalPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionSetOffApprovalPojo.class));
		}
		Long transactionStatus = 0l;
		if(transactionServiceInfo.getButtonType().equalsIgnoreCase("Approve")) {
			//here changing the transaction status
			if(isThisIsFinalLevel) {
				transactionServiceInfo.setTransactionActionType(Status.TRANSACTION_COMPLETED.getStatus());
				if(FinTransactionType.RECEIPT.getId().equals(transactionServiceInfo.getTransactionTypeId()) && 
						FinTransactionMode.CHEQUE.getId().equals(transactionServiceInfo.getTransactionModeId())
						) {
					if(Util.isEmptyObject(transactionServiceInfo.getChequeDepositedDate())) {
						throw new EmployeeFinancialServiceException("Please select cheque deposit date for flat no : "+customerPropertyDetailsInfo.getFlatNo()+", Transaction amount "+transactionServiceInfo.getTransactionAmount());
					}
					if(Util.isEmptyObject(transactionServiceInfo.getChequeClearanceDate())) {
						throw new EmployeeFinancialServiceException("Please select cheque clearance date for flat no : "+customerPropertyDetailsInfo.getFlatNo()+", Transaction amount "+transactionServiceInfo.getTransactionAmount());
					}
					if(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getChequeClearanceDate()).before(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getChequeDepositedDate()))) {
						throw new EmployeeFinancialServiceException("Cheque clearance date found before cheque deposit date for flat no : "+customerPropertyDetailsInfo.getFlatNo()+", Transaction amount "+transactionServiceInfo.getTransactionAmount());
					}
				}
			}else {//pending transaction for approval
				transactionServiceInfo.setTransactionActionType(Status.APPROVED.getStatus());
				transactionStatus = Status.PENDING.getStatus();
				/*if(transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("cheque") && 
						Util.isNotEmptyObject(transactionServiceInfo.getChequeDepositedDate())) {*/
				if(nextApprovalModule.equals(SubModule.UNCLEARED_CHEQUE.getId())) {	
					transactionStatus = Status.UNCLEARED_CHEQUE.getStatus();
					
					if(FinTransactionType.RECEIPT.getId().equals(transactionServiceInfo.getTransactionTypeId()) && 
							FinTransactionMode.CHEQUE.getId().equals(transactionServiceInfo.getTransactionModeId())
							) {
						
						if(Util.isEmptyObject(transactionServiceInfo.getChequeDepositedDate())) {
							throw new EmployeeFinancialServiceException("Please select cheque deposit date for flat no : "+customerPropertyDetailsInfo.getFlatNo()+", Transaction amount "+transactionServiceInfo.getTransactionAmount());
						}
						if(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getChequeDepositedDate()).before(TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getTransactionDate()))) {
							throw new EmployeeFinancialServiceException("Cheque deposit date found before cheque date for flat no : "+customerPropertyDetailsInfo.getFlatNo()+", Transaction amount "+transactionServiceInfo.getTransactionAmount());
						}
					}
					
				}
				employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo, transactionStatus);
			}
		} else if(transactionServiceInfo.getButtonType().equalsIgnoreCase("Reject")){
			transactionServiceInfo.setTransactionActionType(Status.REJECTED.getStatus());
		}

		//save approve reject details
		transactionApproveStatId =  employeeFinancialServiceDao.saveApproveRejectStatistics((FinTransactionApprRejectStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionApprRejectStatPojo.class));
		transactionServiceInfo.setTransactionApproveStatId(transactionApproveStatId);
		transactionServiceInfo.setThisIsFinalLevel(isThisIsFinalLevel);
		
		//checking changed details
		Map<String, Boolean> transactionDetailsChanged = checkChangedTransactionDetails(transactionServiceInfo);
		
		boolean isTransactionDetailsChanged = transactionDetailsChanged.get("isTransactionDetailsChanged");
		boolean isPaymentSetOffDetailsChanged = transactionDetailsChanged.get("isPaymentSetOffDetailsChanged");
		
		if(isPaymentSetOffDetailsChanged || isThisIsFinalLevel) {//if payment set off details is changed
			//calling in save method and approve method
			processPaymentSetOffDetails(transactionServiceInfo,isThisPaymentTransaction);
		}
		
		if(transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("cheque") && 
				Util.isNotEmptyObject(transactionServiceInfo.getChequeDepositedDate())) {
			employeeFinancialServiceDao.updateTransactionChequeDetials((FinTransactionChequePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionChequePojo.class));
		}
		
		if(isTransactionDetailsChanged || isThisIsFinalLevel) {
			//if(isTransactionDetailsChanged) {
				FinTransactionEntryPojo entryPojo = (FinTransactionEntryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionEntryPojo.class);
				employeeFinancialServiceDao.updateTransactionEntryDetails(entryPojo);
			//}
			if(transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("cheque")) {
				employeeFinancialServiceDao.updateTransactionChequeDetials((FinTransactionChequePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionChequePojo.class));	
			}else if(transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("waived off")) {
				FinTransactionWaivedOffPojo finTransactionWaivedOffPojo =financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionWaivedOffPojo.class);
				finTransactionWaivedOffPojo.setWaivedOffDate(transactionServiceInfo.getTransactionReceiveDate());
				employeeFinancialServiceDao.updateTransactionWaivedOffDetials(finTransactionWaivedOffPojo);	
			}
			else {
				FinTransactionOnlinePojo transactionOnlinePojo = (FinTransactionOnlinePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionOnlinePojo.class);
				if(transactionServiceInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId()) && transactionServiceInfo.getTransactionDate()!=null) {
					transactionOnlinePojo.setTransactionDate(transactionServiceInfo.getTransactionDate());
				}
				FinAnonymousEntryPojo anonymousEntryPojo = (FinAnonymousEntryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, FinAnonymousEntryPojo.class);
				anonymousEntryPojo.setStatusId(Status.ACTIVE.getStatus());
				anonymousEntryPojo.setAmount(transactionServiceInfo.getTransactionAmount());
				anonymousEntryPojo.setActiveStatusId(Status.TRANSACTION_COMPLETED.getStatus());
				//updating reference number and amount
				employeeFinancialServiceDao.updateAnonymousEntryReferenceNoAmount(anonymousEntryPojo);

				employeeFinancialServiceDao.updateTransactionOnlineDetails(transactionOnlinePojo);
			}
		}
		
/*		if(isThisIsFinalLevel) {
			if(transactionServiceInfo.getTransactionModeName().equalsIgnoreCase("cheque")) {
				employeeFinancialServiceDao.updateTransactionChequeDetials((FinTransactionChequePojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionChequePojo.class));	
			}
		}
*/		
		employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
		employeeFinancialServiceInfo.setSiteId(transactionServiceInfo.getSiteId());
		employeeFinancialServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
		employeeFinancialServiceInfo.setThisUplaodedData(transactionServiceInfo.isThisUplaodedData());
		employeeFinancialServiceInfo.setCustomerAddressInfoList(transactionServiceInfo.getCustomerAddressInfoList());
		employeeFinancialServiceInfo.setSiteAddressInfoList(transactionServiceInfo.getSiteAddressInfoList());
		employeeFinancialServiceInfo.setFinProjectAccountResponseList(transactionServiceInfo.getFinProjectAccountResponseList());
		employeeFinancialServiceInfo.setOfficeDetailsList(transactionServiceInfo.getOfficeDetailsList());
		employeeFinancialServiceInfo.setFlatsResponse(transactionServiceInfo.getFlatsResponse());

		response2 = processTransactionToFinalLevel(transactionServiceInfo,employeeFinancialServiceInfo,isThisPaymentTransaction,isThisIsFinalLevel);//pending transaction for approval level 2
		
		if(isThisIsFinalLevel) {
			validatePenaltyCalcultionCompleted(employeeFinancialServiceInfo);
		}
		
		if(FinTransactionType.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionTypeId())) {
			sendInterestWaiverTransactionApprovedMailDetails(transactionServiceInfo,finTransactionApprStatPojoList,officeDetailsResponseList,requestUrl);
		} else {//pending transaction for approval level 2
			//sending email's to next level employee 
			sendTransactionApprovedMailDetails(transactionServiceInfo,finTransactionApprStatPojoList,officeDetailsResponseList,requestUrl);
			//inserting readjusted transaction's
			insertReadjustedTransactionDetails(transactionServiceInfo);					
		}
		if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos())) {
			transactionServiceInfo = storeTransationUploadedImages(transactionServiceInfo,transactionServiceInfo.getTransactionModeName(),transactionServiceInfo.getTransactionEntryId());
				//if(Util.isNotEmptyObject(transactionServiceInfo.getFileInfos()))
			for (FileInfo fileInfo : transactionServiceInfo.getFileInfos()) {
					//System.out.println(fileInfo);
				fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
				FinTransactionEntryDocPojo pojo = (FinTransactionEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(fileInfo, FinTransactionEntryDocPojo.class);
				pojo.setTransactionEntryId(transactionEntryId);
				pojo.setDocumentType(MetadataId.UPLOADED.getId());
				pojo.setStatusId(Status.ACTIVE.getStatus());
				employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
			}
		}
		
		//deleting attached files
		List<FileInfo> deleteFileList = transactionServiceInfo.getDeleteFileInfos();
		if(Util.isNotEmptyObject(deleteFileList)) {
			EmployeeFinancialRequest employeeFinancialRequest = new EmployeeFinancialRequest();
			employeeFinancialRequest.setFileInfos(deleteFileList);
			deleteUploadedAttachments(employeeFinancialRequest);
		}
		//TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();	
		return response2;
	}
	
	private void insertReadjustedTransactionDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		boolean isThisIsFinalLevel = transactionServiceInfo.isThisIsFinalLevel();
		if(Util.isNotEmptyObject(transactionServiceInfo.getReConstructedtransactionServiceRequest()) && isThisIsFinalLevel) {
			employeeFinancialHelper.sortTransactionDataOnEdit(transactionServiceInfo);
				//Re-executing the Request For Edit Transaction
				for (EmployeeFinancialTransactionServiceInfo reConstructedtransactionServiceInfo : transactionServiceInfo.getReConstructedtransactionServiceRequest()) {
					
					EmployeeFinancialTransactionServiceInfo clonedTransactionServiceInfo1 = (EmployeeFinancialTransactionServiceInfo) reConstructedtransactionServiceInfo.clone();
					System.out.println(reConstructedtransactionServiceInfo.getTransactionDate()+""+reConstructedtransactionServiceInfo.getTransactionReceiveDate()+"\t"+reConstructedtransactionServiceInfo.getPrevTransactionEntryId()+"\t"+(reConstructedtransactionServiceInfo.getTransactionEntryId())+"\t"+reConstructedtransactionServiceInfo.getTransactionAmount());
					saveFinancialTransactionRequest(reConstructedtransactionServiceInfo);
					
					if(Util.isNotEmptyObject(reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList())) {
						for (FinTransactionApprStatPojo apprStatPojo : reConstructedtransactionServiceInfo.getFinTransactionApprStatPojoList()) {
							apprStatPojo.setTransactionSetOffEntryId(reConstructedtransactionServiceInfo.getTransactionSetOffEntryId());
							apprStatPojo.setComment(apprStatPojo.getComments());
							//copying approve reject details
							employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,reConstructedtransactionServiceInfo);
							//copying changed details
							//employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
						}
					}
					if(!reConstructedtransactionServiceInfo.getPrevTransactionEntryId().equals(transactionServiceInfo.getTransactionEntryId())) {
						List<FinTransactionEntryDocResponse> transactionEntryDocResponsesList = reConstructedtransactionServiceInfo.getPrevTransactionEntryDetailsResponse().getTransactionEntryDocResponsesList();
						if(Util.isNotEmptyObject(transactionEntryDocResponsesList)) {
							for (FinTransactionEntryDocResponse entryDocResponse : transactionEntryDocResponsesList) {
								FinTransactionEntryDocPojo pojo = financialMapper.constructFinTransactionEntryDocPojoObject(entryDocResponse,reConstructedtransactionServiceInfo);
								employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
							}
						}
					}
					employeeFinancialServiceDao.copyTransactionSetOffApprovaldetails(clonedTransactionServiceInfo1,reConstructedtransactionServiceInfo);
			}
		}
	}

	private void sendTransactionApprovedMailDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo,
			List<FinTransactionApprStatPojo> finTransactionApprStatPojoList, List<OfficeDtlsResponse> officeDetailsResponseList, String requestUrl) throws Exception {
		Long nextApprovalModule = transactionServiceInfo.getNextApprovalModule();
		boolean isThisIsFinalLevel = transactionServiceInfo.isThisIsFinalLevel();
		//Assert.notNull(nextApprovalModule, "Next Module should not be empty");
		String buttonType = "";Long transactionStatus = 0l;
		List<String> toEmails = new ArrayList<>();
		List<FinTransactionApprovalDetailsPojo> listOfNextApprovalEmaEmails = null;
		if(transactionServiceInfo.isThisPaymentTransaction()){
			//if this is payment, and single or multiple approval
			if(transactionServiceInfo.isThisTransactionRequest() && transactionServiceInfo.isThisPaymentTransaction()) {
				takePreviousApprovedEmpDetails(transactionServiceInfo,finTransactionApprStatPojoList);
				//if request approved then need to send email to previous employee
				//here approving transaction request
				buttonType = "Transaction Payment Request Approved";
			}
			
			if(!transactionServiceInfo.isThisTransactionRequest() && transactionServiceInfo.isThisPaymentTransaction() && isThisIsFinalLevel ) {
				//if payment transaction approved then need to send email to previous employee
				//from here regular transaction approving
				buttonType = "Transaction Payment Refund Approved";
				takePreviousApprovedEmpDetails(transactionServiceInfo,finTransactionApprStatPojoList);
			}

			if(requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName())){
				if(Util.isNotEmptyObject(transactionServiceInfo.getFinTransactionApprStatPojoList())) {
					toEmails.add(transactionServiceInfo.getFinTransactionApprStatPojoList().get(0).getEmpEmail());
				}
			}
			
			if(!transactionServiceInfo.isThisTransactionRequest() && transactionServiceInfo.isThisPaymentTransaction()  && !isThisIsFinalLevel ) {
				buttonType = "Transaction Payment Refund";//from here regular transaction starting 
				//here we are not taking previous approval details, bcoz this is regular transaction 
				listOfNextApprovalEmaEmails = employeeFinancialServiceDao.getTheNextLevelEmplaoyeeDetails(transactionServiceInfo);
				if(!requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName()) && !isThisIsFinalLevel) {//if this is not multiple approval transaction
					for (FinTransactionApprovalDetailsPojo approvalDetailsPojo : listOfNextApprovalEmaEmails) {
						transactionServiceInfo.setListOfNextApprovalEmaEmails(Arrays.asList(approvalDetailsPojo));
					}
				}
				toEmails = takeNextLevelApprovalDetails(transactionServiceInfo,listOfNextApprovalEmaEmails);
				if(nextApprovalModule.equals(SubModule.UNCLEARED_CHEQUE.getId())) {
					transactionStatus = Status.UNCLEARED_CHEQUE.getStatus();	
					employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo, transactionStatus);
				}/* else {
					//buttonType = "APPROVED";//from here regular transaction starting
				}*/			
			}
			employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo), buttonType,toEmails);
		}
		else {
			listOfNextApprovalEmaEmails = employeeFinancialServiceDao.getTheNextLevelEmplaoyeeDetails(transactionServiceInfo);
		
			if(Util.isNotEmptyObject(listOfNextApprovalEmaEmails)) {
				for (FinTransactionApprovalDetailsPojo approvalDetailsPojo : listOfNextApprovalEmaEmails) {
					transactionServiceInfo.setNextApprovalLevelName(approvalDetailsPojo.getEmpName());
					transactionServiceInfo.setListOfNextApprovalEmaEmails(Arrays.asList(approvalDetailsPojo));
					transactionServiceInfo.setOfficeDetailsList(officeDetailsResponseList);

					if(!requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName()) && !isThisIsFinalLevel) {
						
						if(transactionServiceInfo.getButtonType().equalsIgnoreCase("Approve")) {
							buttonType = Status.APPROVED.getDescription();
						} else if (isThisIsFinalLevel){
							buttonType = Status.TRANSACTION_COMPLETED.getDescription();
						}
						/*if(transactionServiceInfo.isThisTransactionRequest() && transactionServiceInfo.isThisPaymentTransaction()) {
							takePreviousApprovedEmpDetails(transactionServiceInfo,finTransactionApprStatPojoList);
							//if request approved then need to send email to previous employee
							buttonType = "Transaction Payment Request Approved";
						} 
						if(!transactionServiceInfo.isThisTransactionRequest() && transactionServiceInfo.isThisPaymentTransaction()) {
							buttonType = "Transaction Payment Refund";
						} 
						if(!transactionServiceInfo.isThisTransactionRequest() && transactionServiceInfo.isThisPaymentTransaction() && isThisIsFinalLevel ) {
							//if payment transaction approved then need to send email to previous employee
							buttonType = "Transaction Payment Refund Approved";//not executing condition
							takePreviousApprovedEmpDetails(transactionServiceInfo,finTransactionApprStatPojoList);
						}*/
						//no need email approval intimation for final level
						employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo), buttonType,null);
					}
				}
			}
	    }

	}

	private void sendInterestWaiverTransactionApprovedMailDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo,
			List<FinTransactionApprStatPojo> finTransactionApprStatPojoList, List<OfficeDtlsResponse> officeDetailsResponseList, String requestUrl) throws Exception {
		boolean isThisIsFinalLevel = transactionServiceInfo.isThisIsFinalLevel();
		//Assert.notNull(nextApprovalModule, "Next Module should not be empty");
		String buttonType = "";
		List<String> toEmails = new ArrayList<>();
		
		if(transactionServiceInfo.getButtonType().equalsIgnoreCase("Reject")) {
			buttonType = "Interest waiver rejected";
			transactionServiceInfo.setListOfNextApprovalEmaEmails(null);
			transactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);
			//toEmails = takePreviousApprovedEmpDetails(transactionServiceInfo,finTransactionApprStatPojoList);
			transactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);
			toEmails = takePreviousAllApprovedEmpDetails(transactionServiceInfo,finTransactionApprStatPojoList);
			employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo), buttonType,toEmails);
		} else {
			List<FinTransactionApprovalDetailsPojo> listOfNextApprovalEmaEmails = new ArrayList<>();
			listOfNextApprovalEmaEmails = employeeFinancialServiceDao.getTheNextLevelEmplaoyeeDetails(transactionServiceInfo);
			toEmails = takeNextLevelApprovalDetails(transactionServiceInfo,listOfNextApprovalEmaEmails);
			buttonType = "Interest waiver initiated"; 
			if(isThisIsFinalLevel) {
				buttonType =  "Interest waiver approved";
				transactionServiceInfo.setListOfNextApprovalEmaEmails(null);
				transactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);
				//toEmails = takePreviousApprovedEmpDetails(transactionServiceInfo,finTransactionApprStatPojoList);
				transactionServiceInfo.setFinTransactionApprStatPojoList(finTransactionApprStatPojoList);
				toEmails = takePreviousAllApprovedEmpDetails(transactionServiceInfo,finTransactionApprStatPojoList);
			}
			if(!requestUrl.equals(FinEnum.APPROVE_MULTIPLE_TRANSACTION.getName()) && !isThisIsFinalLevel) {
				for (FinTransactionApprovalDetailsPojo approvalDetailsPojo : listOfNextApprovalEmaEmails) {
						transactionServiceInfo.setListOfNextApprovalEmaEmails(Arrays.asList(approvalDetailsPojo));
				}
			}
			
			transactionServiceInfo.setCurrentApprovalLevelName(finTransactionApprStatPojoList.get(0).getEmpName());//setting crm employee name, bocz this waiver initiated by CRM
			employeeFinancialHelper.sendFinancialApprovalEmail(Arrays.asList(transactionServiceInfo), buttonType,toEmails);
		 }
	}
	
	private boolean checkModeorFlatNoChanged(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		EmployeeFinancialTransactionServiceInfo actualRequest = transactionServiceInfo.getActualTransactionRequest();
		boolean insertNewRecord = false;
		if(Util.isEmptyObject(actualRequest)) {
			return insertNewRecord;
		}
		if(!transactionServiceInfo.getTransactionModeId().equals(actualRequest.getTransactionModeId())) {
			 insertNewRecord = true;
		} else if(!transactionServiceInfo.getBookingFormId().equals(actualRequest.getBookingFormId())) {
			insertNewRecord = true;
		} else if(!transactionServiceInfo.getSiteId().equals(actualRequest.getSiteId())) {
			insertNewRecord = true;
		}
		
		if(insertNewRecord) {
			//transactionServiceInfo.setButtonType("Modify");
			transactionServiceInfo.setOperationType("Modify");
			transactionServiceInfo.setPrevTransactionEntryId(transactionServiceInfo.getTransactionEntryId());
			saveFinancialTransactionRequest(transactionServiceInfo);
		}
		
		return insertNewRecord;
	}

	private List<String> takeNextLevelApprovalDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo,
			List<FinTransactionApprovalDetailsPojo> listOfNextApprovalEmaEmails) {
		List<String> toMails = new ArrayList<>();
		if(Util.isNotEmptyObject(listOfNextApprovalEmaEmails)) {
			for (FinTransactionApprovalDetailsPojo approvalDetailsPojo : listOfNextApprovalEmaEmails) {
				transactionServiceInfo.setNextApprovalLevelName(approvalDetailsPojo.getEmpName());
				if(Util.isNotEmptyObject(approvalDetailsPojo.getEmpEmail()) && !toMails.contains(approvalDetailsPojo.getEmpEmail())) {
					toMails.add(approvalDetailsPojo.getEmpEmail());
				}
			}
		}
		return toMails;
	}

	private List<String> takePreviousApprovedEmpDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, List<FinTransactionApprStatPojo> finTransactionApprStatPojoList) {
		List<String> toMails = new ArrayList<>();
		transactionServiceInfo.setListOfNextApprovalEmaEmails(null);
		if(Util.isNotEmptyObject(finTransactionApprStatPojoList)) {
			FinTransactionApprStatPojo apprStatPojo = finTransactionApprStatPojoList.get(finTransactionApprStatPojoList.size()-1);
			transactionServiceInfo.setNextApprovalLevelName(apprStatPojo.getEmpName());
			transactionServiceInfo.setFinTransactionApprStatPojoList(Arrays.asList(apprStatPojo));
			if(Util.isNotEmptyObject(apprStatPojo.getEmpEmail()) && !toMails.contains(apprStatPojo.getEmpEmail())) {
				toMails.add(apprStatPojo.getEmpEmail());
			}
		}
		return toMails;
	}
	
	private List<String> takePreviousAllApprovedEmpDetails(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, List<FinTransactionApprStatPojo> finTransactionApprStatPojoList) {
		List<String> toMails = new ArrayList<>();
		transactionServiceInfo.setListOfNextApprovalEmaEmails(null);
		if(Util.isNotEmptyObject(finTransactionApprStatPojoList)) {
			for (FinTransactionApprStatPojo apprStatPojo : finTransactionApprStatPojoList) {				
				transactionServiceInfo.setNextApprovalLevelName(apprStatPojo.getEmpName());
				//transactionServiceInfo.setFinTransactionApprStatPojoList(Arrays.asList(apprStatPojo));
				if(Util.isNotEmptyObject(apprStatPojo.getEmpEmail()) && !toMails.contains(apprStatPojo.getEmpEmail())) {
					toMails.add(apprStatPojo.getEmpEmail());
				}
			}
		}
		return toMails;
	}

	private EmployeeFinancialTransactionResponse rejectTransaction(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, EmployeeFinancialTransactionResponse response2, Long transactionStatus) throws Exception {
		log.info("*****  rejectTransaction() calling saveApproveRejectStatistics() *****");
		transactionServiceInfo.setTransactionActionType(transactionStatus);
		long transactionApproveStatId =  employeeFinancialServiceDao.saveApproveRejectStatistics((FinTransactionApprRejectStatPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo,FinTransactionApprRejectStatPojo.class));
		transactionServiceInfo.setTransactionApproveStatId(transactionApproveStatId);
		employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo,transactionStatus);
		return response2;
	}
	
	@Override
	public List<FinTransactionEntryPojo> getTransactionDataOnReceiveDate(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, Status approved, MetadataId transactionType) {
		return employeeFinancialServiceDao.getTransactionDataOnReceiveDate(transactionServiceInfo,approved,transactionType);
	}

	/**
	 * @used this method for transaction Create and approve time, if this is final level, transaction will be competed and adjusted to it's respective payement set off
	 * @param transactionServiceInfo
	 * @param employeeFinancialServiceInfo
	 * @param isTransactionForIsEmpty
	 * @param isThisIsFinalLevel
	 * @return
	 * @throws Exception
	 */
	private EmployeeFinancialTransactionResponse processTransactionToFinalLevel(EmployeeFinancialTransactionServiceInfo transactionServiceInfo,
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo, boolean isTransactionForIsEmpty, boolean isThisIsFinalLevel)
					throws Exception {
		Properties prop = responceCodesUtil.getApplicationProperties();
		long transactionEntryId = transactionServiceInfo.getTransactionEntryId();
		List<FinancialProjectMileStonePojo> listOfNonPaidMileStoneDetailsList = new ArrayList<>();
		List<FinancialProjectMileStonePojo> listOfPaidModificationCostList = new ArrayList<>();
		List<FinancialProjectMileStonePojo> listOfPaidLegalCostList = new ArrayList<>();
		List<FinancialProjectMileStonePojo> listOfPaidMaintenanceCost = new ArrayList<>();
		List<FinancialProjectMileStonePojo> listOfPaidFlatKhata = new ArrayList<>();
		List<FinancialProjectMileStonePojo> listOfPaidCorpusFunds = new ArrayList<>();
		List<FinPenaltyTaxPojo> taxDetailsList = null;
		FinancialProjectMileStoneInfo taxPercentageLoadingInfo = null;
		/* Malladi Changes */
		List<FinancialProjectMileStonePojo> listOfPaidInterestCostList = new ArrayList<>();
		FileInfo fileInfo = null;
		List<FileInfo> fileInfoList = null;
		String transactionReceiptNo = null;
		boolean sendEmailAndNotification = false;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		//boolean isThisUploadedData = transactionServiceInfo.isThisUplaodedData();
		if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos= employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
			}
		}
		
		if (isTransactionForIsEmpty && isThisIsFinalLevel) {
			//this condition is for Payment Type Transaction means refund transaction
			//transactionServiceInfo.setTransactionForId(MetadataId.valueOf(transactionFor.toUpperCase()).getId());
			
			CustomerPropertyDetailsInfo info = new CustomerPropertyDetailsInfo();
			info.setStatusId(transactionServiceInfo.getStatusId());
			info.setFlatBookingId(transactionServiceInfo.getBookingFormId());
			info.setCondition("PaymentRefund");
			int resultOfAdjustment = employeeFinancialServiceDao.checkIsThisPaymentRefundTransactionAlreadyAdjusted(transactionServiceInfo,FinEnum.RECEIPT);
			if(resultOfAdjustment!=0) {
				log.info("Found duplicate request for transaction can not approve transaction, Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" and Transaction id "+transactionServiceInfo.getTransactionNo());
				throw new EmployeeFinancialServiceException("Found duplicate request for transaction can not approve transaction, Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" and Transaction id "+transactionServiceInfo.getTransactionNo());
			}
			List<FinTransactionEntryDetailsPojo> listOfPaymentSetOffData = employeeFinancialServiceDao.getFinancialTransactionPaymentRefundSetOffData(transactionServiceInfo);
			Long type = 0l;
			String metaDataName = "";
			long tempTransactionSetOffId = 0l;
			double setOffAmount = 0.0;
			Long bookingFormAccountPaymentId = 0l;
			double totalRefundAmount = 0d;
			double settleAmount = 0d;
			List<FinBookingFormExcessAmountPojo> listOfExcessAmount = null;
			FinTransactionEntryDetailsPojo entryDetailsPojo = null;
			for (int index = 0; index < listOfPaymentSetOffData.size(); index++) {
				entryDetailsPojo = listOfPaymentSetOffData.get(index);
				type = entryDetailsPojo.getSetOffType();//29 = FIN_BOOKING_FORM_MILESTONES, 27 = FIN_PENALTY
				metaDataName = entryDetailsPojo.getSetOffTypeName();
				//log.info(setOffAmount+" Amount got extra "+metaDataName);
				
				long transactionSetOffId = entryDetailsPojo.getTransactionSetOffId();
				if(tempTransactionSetOffId!=transactionSetOffId) {//if previous id and current id is not same then, process current set of data
 					tempTransactionSetOffId = transactionSetOffId;
 					setOffAmount = entryDetailsPojo.getSetOffAmount();
				}
				//log.info(setOffAmount+" Amount got extra "+metaDataName);
				if(metaDataName.equalsIgnoreCase(MetadataId.FIN_BOOKING_FORM_MILESTONES.getName())) {
					//bookingFormAccountsInfo.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
				}
				info.setTypeId(entryDetailsPojo.getTypeId());
				
				if (!entryDetailsPojo.getSetOffTypeName().equalsIgnoreCase(MetadataId.FIN_BOOKING_FORM_ACCOUNTS.getName())) {
					//refunding amount from excess amount
					listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(info,Arrays.asList(type));
					if (listOfExcessAmount.isEmpty()) {
						throw new EmployeeFinancialServiceException("No excess amount found to refund " + metaDataName);
					} else {
						if(Util.isNotEmptyObject(listOfExcessAmount.get(0))) {
							if(listOfExcessAmount.get(0).getBalanceAmount()<=0) {
								//throw new EmployeeFinancialServiceException("No excess amount found to refund " + metaDataName);
							}
						}else {
							throw new EmployeeFinancialServiceException("No excess amount found to refund " + metaDataName);
						}
					}
					//setOffAmount this variable holding refund amount,
					//setOffAmount = 1000
					for (FinBookingFormExcessAmountPojo finBookingFormExcessAmountPojo : listOfExcessAmount) {
						double excessAmount = Util.isEmptyObject(finBookingFormExcessAmountPojo.getBalanceAmount())?0d:finBookingFormExcessAmountPojo.getBalanceAmount();
						//excessAmount = 5000
						if (excessAmount > 0) {
							if (setOffAmount > 0) {
								if (setOffAmount >= excessAmount) {//current  
									//System.out.println(1);
									 setOffAmount = setOffAmount - excessAmount;
									 settleAmount = excessAmount;
								} else {
									//System.out.println(2);
									//setOffAmount = setOffAmount - excessAmount;
									settleAmount = setOffAmount;//1,000 = 4,000 is 
								}
								totalRefundAmount +=settleAmount;
								finBookingFormExcessAmountPojo.setModifiedBy(transactionServiceInfo.getEmployeeId());
								finBookingFormExcessAmountPojo.setUsedAmount(settleAmount);
								employeeFinancialServiceDao.updateAndReduceExcessAmount(finBookingFormExcessAmountPojo);
								
//								FinBookingFormAccountSummaryPojo accSummaryPojo = (FinBookingFormAccountSummaryPojo)financialMapper.copyPropertiesFromInfoBeanToPojoBean(finBookingFormExcessAmountPojo, FinBookingFormAccountSummaryPojo.class);
//								accSummaryPojo.setRefundAmount(setOffAmount);accSummaryPojo.setBookingFormId(transactionServiceInfo.getBookingFormId());
//								employeeFinancialServiceDao.updateBookingFormAccountSummaryRefundAmount(accSummaryPojo);
								
								FinBookingFormAccountPaymentPojo pojo = financialMapper.constructFinBookingFormAccountPaymentPojo(transactionServiceInfo,settleAmount,entryDetailsPojo,FinBookingFormAccountPaymentPojo.class);
								 if(bookingFormAccountPaymentId==0) {
									 bookingFormAccountPaymentId = employeeFinancialServiceDao.saveBookingFormAccountPayments(pojo);
								 }else {
									 pojo.setBookingFormAccountPaymentId(bookingFormAccountPaymentId);
								 }
								employeeFinancialServiceDao.saveBookingFormAccountPaymentsDetails(pojo);
								taxPercentageLoadingInfo = new FinancialProjectMileStoneInfo();
								taxPercentageLoadingInfo.setMilestoneDate(transactionServiceInfo.getTransactionReceiveDate() == null? transactionServiceInfo.getTransactionDate() :transactionServiceInfo.getTransactionReceiveDate());
								taxPercentageLoadingInfo.setSiteId(customerPropertyDetailsInfo.getSiteId());
								taxPercentageLoadingInfo.setCondition("ReceiptEntry");
								
								taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(taxPercentageLoadingInfo,Arrays.asList(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId(),MetadataId.MAINTENANCE_CHARGE.getId(),MetadataId.LEGAL_COST.getId(),MetadataId.FIN_PENALTY.getId()));
								//if any excess amount found in penalty records
								if(MetadataId.FIN_PENALTY.getId().equals(finBookingFormExcessAmountPojo.getType())) {
									putPenaltyExcessAmountInReceipt(settleAmount,listOfPaidInterestCostList,taxDetailsList,finBookingFormExcessAmountPojo.getType());
								}
								if(MetadataId.MAINTENANCE_CHARGE.getId().equals(finBookingFormExcessAmountPojo.getType())) {
									putMaintenanceExcessAmountInReceipt(settleAmount,listOfPaidMaintenanceCost,taxDetailsList,finBookingFormExcessAmountPojo.getType());
								}
								if(MetadataId.CORPUS_FUND.getId().equals(finBookingFormExcessAmountPojo.getType())) {
									putCorpusFundExcessAmountInReceipt(settleAmount,listOfPaidCorpusFunds,taxDetailsList,finBookingFormExcessAmountPojo.getType());
								}
								if(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(finBookingFormExcessAmountPojo.getType())) {
									putFlatKhataExcessAmountInReceipt(settleAmount,listOfPaidFlatKhata,taxDetailsList,finBookingFormExcessAmountPojo.getType());
								}
								
							} else {
								break;
							}
						}
						
					}//listOfExcessAmount
				} else {
					//refunding from FIN_BOOKING_FORM_ACCOUNTS table
					FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
					finProjDemandNoteInfo.setCondition("SetOffPayment");
					finProjDemandNoteInfo.setType(Arrays.asList(new Long[] { type }));
					finProjDemandNoteInfo.setFinBookingFormAccountsId(entryDetailsPojo.getTypeId());
					if (entryDetailsPojo.getSetOffTypeName().equals(MetadataId.FIN_BOOKING_FORM_ACCOUNTS.getName())) {
						List<Map<String, Object>> recordDetailslist = employeeFinancialServiceDao.getFinBookingFormAccountType(finProjDemandNoteInfo);
						if(Util.isNotEmptyObject(recordDetailslist)) {//loading the Type of account table record, as we have only accounts id
							//based on accounts id loading Type, so from thta type amount will refund
							finProjDemandNoteInfo.setType(Arrays.asList(Long.valueOf(recordDetailslist.get(0).get("TYPE").toString())));	
						}
					}
					
					finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] { Status.PAID.getStatus() ,Status.INPROGRESS.getStatus()}));
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
					customerPropertyDetailsInfo2.setStatusId(transactionServiceInfo.getStatusId());
					customerPropertyDetailsInfo2.setFlatBookingId(transactionServiceInfo.getBookingFormId());

					//loading previous non paid milestone details 
					List<FinancialProjectMileStonePojo> listOfNonPaidMileStoneDetails = employeeFinancialServiceDao
							.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo2,FinEnum.lOAD_DATA);
					//double totalInterestAmount = 0d;
					//int days = 0;
					//setOffAmount this variable will hold current transaction payemnt set off refund amount
					for (FinancialProjectMileStonePojo accPojo : listOfNonPaidMileStoneDetails) {
						//double accPayAmount = accPojo.getPayAmount();
						double accPaidAmount = Util.isEmptyObject(accPojo.getPaidAmount()) ? 0d : accPojo.getPaidAmount();
						double amountToSetOff = accPaidAmount;//ex 5,00,000
						//Long paymentStatusId = accPojo.getPaymentStatus();//
						if (setOffAmount > 0) {
							if (amountToSetOff > 0) {
								//log.info(" setOffAmount : " + setOffAmount + " -> amountToSetOff :  " + amountToSetOff + " Booking Form Id -> " + accPojo.getFinBookingFormAccountsId());
								if (setOffAmount >= amountToSetOff) {
									 
									 setOffAmount = setOffAmount - amountToSetOff;
									 settleAmount = amountToSetOff;
								} else {
									
									settleAmount = setOffAmount;
									setOffAmount = setOffAmount - amountToSetOff;
								}
								totalRefundAmount +=settleAmount;
								FinBookingFormAccountSummaryPojo accSummaryPojo = (FinBookingFormAccountSummaryPojo)financialMapper.copyPropertiesFromInfoBeanToPojoBean(accPojo, FinBookingFormAccountSummaryPojo.class);
								accSummaryPojo.setRefundAmount(settleAmount);
								
								if(accPojo.getType().equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId())) {
									accSummaryPojo.setType(MetadataId.PRINCIPAL_AMOUNT.getId());//FIN_BOOKING_FORM_MILESTONES is nothing but principal amount
								}
								employeeFinancialServiceDao.updateBookingFormAccountSummaryRefundAmount(accSummaryPojo);
								//maintaing milestone wise amount refund history
								FinBookingFormAccountPaymentPojo pojo = financialMapper.constructFinBookingFormAccountPaymentPojo(transactionServiceInfo,settleAmount,entryDetailsPojo,FinBookingFormAccountPaymentPojo.class);
								if(bookingFormAccountPaymentId==0) {
									 bookingFormAccountPaymentId = employeeFinancialServiceDao.saveBookingFormAccountPayments(pojo);
								}else {
									pojo.setBookingFormAccountPaymentId(bookingFormAccountPaymentId);
								}
								employeeFinancialServiceDao.saveBookingFormAccountPaymentsDetails(pojo);
								accPojo.setSetOffAmount(settleAmount);
								FinBookingFormAccountsPojo bookingFormAccountsPojo = new FinBookingFormAccountsPojo();
								bookingFormAccountsPojo.setPaidAmount(settleAmount);
								bookingFormAccountsPojo.setFinBookingFormAccountsId(accPojo.getFinBookingFormAccountsId());
								bookingFormAccountsPojo.setPaymentStatus(Status.INPROGRESS.getStatus());
								bookingFormAccountsPojo.setBookingFormId(accPojo.getBookingFormId());
								bookingFormAccountsPojo.setModifiedBy(transactionServiceInfo.getEmployeeId());
								employeeFinancialServiceDao.decreaseBookingFormAccountPaidAmount(bookingFormAccountsPojo);
								/*if(accPojo.getType().equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId())) {
									listOfNonPaidMileStoneDetailsList.add(accPojo);
								}*/

								if(MetadataId.FIN_PENALTY.getId().equals(accPojo.getType())) {
									accPojo.setSetOffAmount(settleAmount);//refund amount
									penaltyGstAmountAndAdjustAmount(accPojo,isTransactionForIsEmpty);//penalty adjustment
									listOfPaidInterestCostList.add(accPojo);//Refund transaction
								}
								if(MetadataId.MAINTENANCE_CHARGE.getId().equals(accPojo.getType())) {
									accPojo.setSetOffAmount(settleAmount);//refund amount
									listOfPaidMaintenanceCost.add(accPojo);//Refund transaction
								}
								if(MetadataId.CORPUS_FUND.getId().equals(accPojo.getType())) {
									accPojo.setSetOffAmount(settleAmount);//refund amount
									listOfPaidCorpusFunds.add(accPojo);//Refund transaction
								}
								if(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(accPojo.getType())) {
									accPojo.setSetOffAmount(settleAmount);//refund amount
									listOfPaidFlatKhata.add(accPojo);//Refund transaction
								}
								if(accPojo.getType().equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId())) {
									listOfNonPaidMileStoneDetailsList.add(accPojo);
									inActivePenaltyRecord(bookingFormAccountsPojo);//inacticating interest amount records
									//See the method in this processTransactionForFinel insertPenaltyData
									
									/*this is for recalculation interest amount
									FinPenalityInfo finPenalityInfo = new FinPenalityInfo();
									finPenalityInfo.setBookingFormId(bookingFormAccountsPojo.getBookingFormId());
									List<FinPenaltyPojo> penaltyPojos = employeeFinancialServiceDao.getFinPenaltyDetails(bookingFormAccountsPojo);
									if(Util.isNotEmptyObject(penaltyPojos)) {
										FinPenaltyPojo finPenaltyPojo = new FinPenaltyPojo();
										finPenaltyPojo.setStatusId(Status.SHIFT_RECORD_DETAILS.getStatus());
										finPenaltyPojo.setFinPenaltyId(penaltyPojos.get(0).getFinPenaltyId());
										finPenaltyPojo.setActiveStatusId(Status.ACTIVE.getStatus());
										finPenaltyPojo.setCreatedBy(transactionServiceInfo.getEmployeeId());
										//updating Fin_Penalty Record, for recalculation of penalty amount
										employeeFinancialServiceDao.updateFinPenaltyStatus(bookingFormAccountsPojo);
										//updating Penalty Record, and giving status SHIFT_RECORD_DETAILS, if any paid amount is exists , then we can shift the amount using the SHIFT_RECORD_DETAILS id 			
										employeeFinancialServiceDao.updateBookingFormAccountStatus(finPenaltyPojo,MetadataId.FIN_PENALTY);
									}		
									FinTransactionEntryDetailsInfo transactionEntryDetailsInfo = (FinTransactionEntryDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(transactionServiceInfo, FinTransactionEntryDetailsInfo.class);
									transactionEntryDetailsInfo.setCondition("LoadPreviousTransaction");
									//loading the previous transaction details for Getting transaction receive date, for penalty calculation
									List<FinTransactionEntryDetailsPojo> previousPaymentList = employeeFinancialServiceDao.getTransactionDetails(transactionEntryDetailsInfo, null);

									FinBookingFormDemandNotePojo demandNoteInfo = new FinBookingFormDemandNotePojo();
									demandNoteInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
									demandNoteInfo.setStatusId(Status.REGENERATED_DEMAND_NOTE.getStatus());
									//Loading the Re-generated demand note details for penalty calculation
									List<FinBookingFormDemandNotePojo> demandNotePojos = employeeFinancialServiceDao.getDemandNoteId(demandNoteInfo);
									if (!previousPaymentList.isEmpty()) {
										finProjDemandNoteInfo.setMilestoneDate(previousPaymentList.get(previousPaymentList.size()-1).getTransactionReceiveDate());
									} else if (!demandNotePojos.isEmpty()) {
										finProjDemandNoteInfo.setMilestoneDate(demandNotePojos.get(0).getCreatedDate());
									} else {
										finProjDemandNoteInfo.setMilestoneDate(entryDetailsPojo.getMileStoneDueDate());
									}
									
									
									days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(accPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getTransactionReceiveDate()));
									if(days>0) {
										long isMileStoneWithInterest = Util.isEmptyObject(accPojo.getInterestSelectionType())?0l:accPojo.getInterestSelectionType();
										log.info("EmployeeFinancialServiceImpl.processTransactionToFinalLevel() calculating Intereast isMileStoneWithInterest :"+isMileStoneWithInterest);
										finProjDemandNoteInfo.setMilestoneDate(transactionServiceInfo.getTransactionReceiveDate());
										finProjDemandNoteInfo.setInterestSelectionType(accPojo.getInterestSelectionType());
										finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
										finProjDemandNoteInfo.setInterestCalculationFrom("Receipt");
										
										processPenaltyAmount(listOfNonPaidMileStoneDetails,finProjDemandNoteInfo,totalInterestAmount,"","",new HashMap<String,Object>());
									}
								*/}//accPojo.getType().equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId())
								
								double amoutDecreseInStatement = settleAmount;
								double statementAmountToRefund = 0d;
								List<FinBookingFormAccountsStatementPojo> accountsStatementPojos = employeeFinancialServiceDao.
										getBookingFormAccountsStatementAndReceiptData(bookingFormAccountsPojo, FinEnum.DESC);
								//this code is used in processAdjustedAccountsExcessAmount method
								for (FinBookingFormAccountsStatementPojo accStatementPojo : accountsStatementPojos) {
									double stmtPaidAmount = accStatementPojo.getStatementPaidAmount() == null ? 0d : accStatementPojo.getStatementPaidAmount();
									if (amoutDecreseInStatement > 0) {
										if (stmtPaidAmount > 0) {
											if (amoutDecreseInStatement >= stmtPaidAmount) {
												amoutDecreseInStatement = amoutDecreseInStatement - stmtPaidAmount;
												statementAmountToRefund = stmtPaidAmount;
											} else {
												statementAmountToRefund = amoutDecreseInStatement;
												amoutDecreseInStatement = amoutDecreseInStatement - stmtPaidAmount;
											}
									
											FinBookingFormAccountsStatementPojo accStmtPojo = new FinBookingFormAccountsStatementPojo(); 
											accStmtPojo.setStatementRefundAmount(statementAmountToRefund);
											accStmtPojo.setFinBookingFormAccountsId(accPojo.getFinBookingFormAccountsId());
											accStmtPojo.setBookingFormId(accPojo.getBookingFormId());
											accStmtPojo.setStatusId(Status.ACTIVE.getStatus());
											accStmtPojo.setModifiedBy(transactionServiceInfo.getEmployeeId());
											accStmtPojo.setFinBookingFormAccountsStatementId(accStatementPojo.getFinBookingFormAccountsStatementId());
											employeeFinancialServiceDao.decreaseBookingFormAccountStatementPaidAmount(accStmtPojo,"");
											
											//maintaining Statement wise amount refund history
											FinBookingFormAccountPaymentPojo accStmtRefundHistoryPojo = financialMapper.constructFinBookingFormAccountPaymentOfStatementPojo(transactionServiceInfo,statementAmountToRefund,accStmtPojo,FinBookingFormAccountPaymentPojo.class);
											if(bookingFormAccountPaymentId==0) {
												 bookingFormAccountPaymentId = employeeFinancialServiceDao.saveBookingFormAccountPayments(accStmtRefundHistoryPojo);
											}else {
												accStmtRefundHistoryPojo.setBookingFormAccountPaymentId(bookingFormAccountPaymentId);
											}
											employeeFinancialServiceDao.saveBookingFormAccountPaymentsDetails(accStmtRefundHistoryPojo);
											
										}//stmtPaidAmount condition
									}//amoutDecreseInStatement condition
								}
							}
						}//Set off Amount condition
					}
				}
			}
			
		FinBookingFormAccountPaymentPojo pojo = financialMapper.constructFinBookingFormAccountPaymentPojo(transactionServiceInfo, totalRefundAmount, null, FinBookingFormAccountPaymentPojo.class);
		if (bookingFormAccountPaymentId != 0) {
				employeeFinancialServiceDao.updateBookingFormAccountPayments(pojo);
		}//10,00,000 = 6,00,000  = 4,00,000 
		String requestUrl = transactionServiceInfo.getRequestUrl()==null?"":transactionServiceInfo.getRequestUrl();
		boolean condition = "saveBookingDetails".equals(requestUrl) && transactionServiceInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId());
		//This code is for calculating the interest after refund of milestone amount
		if(!listOfNonPaidMileStoneDetailsList.isEmpty() && !condition) {//Testing Pending,&& condition
			FinancialProjectMileStonePojo msPojo = listOfNonPaidMileStoneDetailsList.get(listOfNonPaidMileStoneDetailsList.size()-1);
			EmployeeFinancialServiceInfo employeeFinancialRequest = new EmployeeFinancialServiceInfo();
			List<FinancialProjectMileStoneInfo> milestoneRequest = new ArrayList<>(); 
			employeeFinancialRequest.setFinancialProjectMileStoneRequests(milestoneRequest);
			FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
			finProjDemandNoteInfo.setMileStoneNo(0l);
			finProjDemandNoteInfo.setProjectMilestoneId(0l);
			finProjDemandNoteInfo.setMilestoneName("Dummy MileStone for Regenerate Demand Note");
			finProjDemandNoteInfo.setMileStonePercentage(12d);
			finProjDemandNoteInfo.setMilestoneDate(msPojo.getMilestoneDate());
			finProjDemandNoteInfo.setMileStoneDueDate(TimeUtil.removeOneDay(new Timestamp(new Date().getTime())));
			finProjDemandNoteInfo.setDemandNoteDate(TimeUtil.removeOneDay(new Timestamp(new Date().getTime())));
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
			milestoneRequest.add(finProjDemandNoteInfo);
			
			insertPenaltyData(transactionServiceInfo,employeeFinancialRequest,null);//insertPenaltyData
		}			
		//This code is for calculating the interest after refund of milestone amount		
		} else if (isThisIsFinalLevel) {
			//Receipt cheque and Online transaction condition
			boolean isAnyRecordExistForAdjustment = false;
			// List<FinBookingFormAccountsInfo> list
			int resultOfAdjustment = employeeFinancialServiceDao.checkIsThisReceiptTransactionAlreadyAdjusted(transactionServiceInfo,FinEnum.RECEIPT);
			if(resultOfAdjustment!=0) {
				log.info("Found duplicate request for transaction can not approve transaction, Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" and Transaction id "+transactionServiceInfo.getTransactionNo());
				throw new EmployeeFinancialServiceException("Found duplicate request for transaction can not approve transaction, Flat No : "+customerPropertyDetailsInfo.getFlatNo()+" and Transaction id "+transactionServiceInfo.getTransactionNo());
			}
			//saving data into booking from account receipts
			long bookingFormReceiptId = employeeFinancialServiceDao.saveBookingFormReceiptsDetials(
					(FinBookingFormReceiptsPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean( transactionServiceInfo, FinBookingFormReceiptsPojo.class));
			transactionServiceInfo.setBookingFormReceiptId(bookingFormReceiptId);
			transactionServiceInfo.setStatusId(Status.ACTIVE.getStatus());
			//loading all the payment set off
			List<FinTransactionEntryDetailsPojo> listOfPaymentSetOffData = employeeFinancialServiceDao .getFinancialTransactionPaymentSetOffData(transactionServiceInfo);
			Map<String, Double> setOffAmountListObject = new HashMap<>();
			//List<Double> setOffAmountListObject  = new ArrayList<>();
			long tempTransactionSetOffId = 0l;
			double setOffAmount = 0.0;
			Long typeId = 0l;
			String metaDataName = "";
			String finBokAccInvoiceNo = "";
			double settleAmount = 0d;
			for (int index = 0; index < listOfPaymentSetOffData.size(); index++) {
				FinTransactionEntryDetailsPojo entryDetailsPojo = listOfPaymentSetOffData.get(index);
				long transactionSetOffId = entryDetailsPojo.getTransactionSetOffId();

				if (tempTransactionSetOffId != transactionSetOffId ) {
					//1,000 rs interest amount and he paid 1,200 = 200 is excess amount
					//in next itereation if set setOffAmount is more than zero then it's excess amount of previous set off
					if (setOffAmount > 0 && tempTransactionSetOffId != 0) {
						//log.info(setOffAmount + " Amount got extra " + metaDataName);
						if (typeId.equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()) && isAnyRecordExistForAdjustment) {
							setOffAmountListObject.put("setOffAmount",setOffAmount);
							putExcessAmountInReceipt(setOffAmount,typeId,transactionServiceInfo,customerPropertyDetailsInfo,listOfNonPaidMileStoneDetailsList,setOffAmountListObject,"ProcessTransactionFinalLvl");
							setOffAmount = setOffAmountListObject.get("setOffAmount");
						}//if set off amount is more than zero and it's not the waiver transaction
						
						if (setOffAmount > 0 && !FinTransactionMode.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionModeId())) {
							constructExcessAmountPojos(setOffAmount, typeId, bookingFormReceiptId, transactionServiceInfo,finBokAccInvoiceNo);
						}
						
						taxPercentageLoadingInfo = new FinancialProjectMileStoneInfo();
						taxPercentageLoadingInfo.setMilestoneDate(transactionServiceInfo.getTransactionReceiveDate() == null? transactionServiceInfo.getTransactionDate() :transactionServiceInfo.getTransactionReceiveDate());
						taxPercentageLoadingInfo.setSiteId(customerPropertyDetailsInfo.getSiteId());
						taxPercentageLoadingInfo.setCondition("ReceiptEntry");

						taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(taxPercentageLoadingInfo,Arrays.asList(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId(),MetadataId.MAINTENANCE_CHARGE.getId(),MetadataId.LEGAL_COST.getId(),MetadataId.FIN_PENALTY.getId()));
						//if any excess amount found in penalty records
						if(MetadataId.FIN_PENALTY.getId().equals(typeId)) {
							putPenaltyExcessAmountInReceipt(setOffAmount,listOfPaidInterestCostList,taxDetailsList,typeId);
						}
						
						if(MetadataId.MAINTENANCE_CHARGE.getId().equals(typeId)) {
							putMaintenanceExcessAmountInReceipt(setOffAmount,listOfPaidMaintenanceCost,taxDetailsList,typeId);
						}
						if(MetadataId.CORPUS_FUND.getId().equals(typeId)) {
							putCorpusFundExcessAmountInReceipt(setOffAmount,listOfPaidCorpusFunds,taxDetailsList,typeId);
						}
						if(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(typeId)) {
							putFlatKhataExcessAmountInReceipt(setOffAmount,listOfPaidFlatKhata,taxDetailsList,typeId);
						}

					}
					tempTransactionSetOffId = transactionSetOffId;
					setOffAmount = entryDetailsPojo.getSetOffAmount();
				}
				
					typeId = entryDetailsPojo.getSetOffType();
					metaDataName = entryDetailsPojo.getSetOffTypeName();
					finBokAccInvoiceNo = entryDetailsPojo.getFinBokAccInvoiceNo();
					Long finBookingFormAccountsIs = entryDetailsPojo.getFinBookingFormAccountsId();
					if(MetadataId.INTEREST_WAIVER.getId().equals(typeId)) {
						//interest waiver is nothing but adjusting the penalty amount so here need to change the type
						typeId = MetadataId.FIN_PENALTY.getId();
						metaDataName = MetadataId.FIN_PENALTY.getName();
					}
					FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
					//finProjDemandNoteInfo.setDataSelectionOrder("DESC");
					finProjDemandNoteInfo.setCondition("SetOffPayment");
					finProjDemandNoteInfo.setType(Arrays.asList(new Long[] {typeId}));
					finProjDemandNoteInfo.setFinBookingFormAccountsId(finBookingFormAccountsIs);
					finProjDemandNoteInfo.setPaymentStatus(Arrays.asList(new Long[] {Status.INPROGRESS.getStatus(),Status.PENDING.getStatus()}));
					finProjDemandNoteInfo.setCreatedBy(transactionServiceInfo.getCreatedBy());
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
					//customerPropertyDetailsInfo2.setType(MetadataId.MODIFICATION_COST.getId());
					customerPropertyDetailsInfo2.setStatusId(transactionServiceInfo.getStatusId());
					customerPropertyDetailsInfo2.setFlatBookingId(transactionServiceInfo.getBookingFormId());
					
					List<FinancialProjectMileStonePojo> listOfNonPaidMileStoneDetails = employeeFinancialServiceDao.getPreviousNonPaidMileStoneDetails(finProjDemandNoteInfo, customerPropertyDetailsInfo2,FinEnum.lOAD_DATA);
					/*if(isEmptyObject(listOfNonPaidMileStoneDetails)) {
						//Got Excess amount  
						constructExcessAmountPojos(setOffAmount, typeId, bookingFormReceiptId, transactionServiceInfo);
					}*/
					double totalInterestAmount = 0d;
					int days = 0;
					if(listOfNonPaidMileStoneDetails.isEmpty()) {// && !transactionServiceInfo.isDemandNoteGenerated()
						FinancialProjectMileStonePojo accPojo = new FinancialProjectMileStonePojo();
						accPojo.setMilestoneName("Excess Amount");
						accPojo.setSetOffAmount(setOffAmount);
						accPojo.setType(typeId);
						if(typeId.equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId())) {
							isAnyRecordExistForAdjustment = false;
							if(!transactionServiceInfo.isDemandNoteGenerated()) {//if demand note is not generated then putting amount to excess amount 
								setOffAmountListObject.put("setOffAmount",setOffAmount);
								putExcessAmountInReceipt(setOffAmount,typeId,transactionServiceInfo,customerPropertyDetailsInfo,listOfNonPaidMileStoneDetailsList,setOffAmountListObject,"ProcessTransactionFinalLvl");
								setOffAmount = setOffAmountListObject.get("setOffAmount");
								/*EmployeeFinancialServiceInfo employeeFinancialInfo = new EmployeeFinancialServiceInfo();
								employeeFinancialInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
								FinancialProjectMileStoneInfo financialProjectMileStoneInfo = new FinancialProjectMileStoneInfo();
								financialProjectMileStoneInfo.setMileStoneNo(1l);
								employeeFinancialInfo.setFinancialProjectMileStoneRequests(Arrays.asList(financialProjectMileStoneInfo));
								employeeFinancialInfo.setCondition(FinEnum.LOAD_BY_MILESTONE.getName());
								employeeFinancialInfo.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
								
								List<FinancialProjectMileStonePojo>  listOfFinancialServicePojo = employeeFinancialServiceDao.getMilestoneDetails(employeeFinancialInfo);
								if(!listOfFinancialServicePojo.isEmpty()) {
									accPojo.setMilestoneName(listOfFinancialServicePojo.get(0).getMilestoneName());
									accPojo.setMileStoneNo(listOfFinancialServicePojo.get(0).getMileStoneNo());
								}
								listOfNonPaidMileStoneDetailsList.add(accPojo);*/
							} else {
								setOffAmountListObject.put("setOffAmount",setOffAmount);
								putExcessAmountInReceipt(setOffAmount,typeId,transactionServiceInfo,customerPropertyDetailsInfo,listOfNonPaidMileStoneDetailsList,setOffAmountListObject,"ProcessTransactionFinalLvl");
								setOffAmount = setOffAmountListObject.get("setOffAmount");
								/*
								//double basicMileStoneAmount = 0d;
								EmployeeFinancialServiceInfo employeeFinancialInfo = new EmployeeFinancialServiceInfo();
								employeeFinancialInfo.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
								employeeFinancialInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
								List<FinancialProjectMileStonePojo> generatedMileStonePojoList = employeeFinancialServiceDao.getGeneratedMilestoneDetailsOfFlat(employeeFinancialInfo,FinEnum.LOAD_BY_MILESTONE.getId());
								if(!generatedMileStonePojoList.isEmpty()) {
									List<FinancialProjectMileStonePojo> nextMileStonePojoList = employeeFinancialServiceDao.getNextMilestoneDetails(generatedMileStonePojoList.get(generatedMileStonePojoList.size()-1));
									if(!nextMileStonePojoList.isEmpty()) {
										accPojo.setMilestoneName(nextMileStonePojoList.get(0).getMilestoneName());
										accPojo.setMileStoneNo(nextMileStonePojoList.get(0).getMileStoneNo());
									} else {
										accPojo.setMilestoneName("Excess Amount");
										accPojo.setMileStoneNo(0l);
									}
								}
							*/}	
/*							employeeFinancialServiceDao.updatePaidAmountBookingFormAccountSummary((FinBookingFormAccountSummaryPojo) 
									financialMapper.constructFinBookingFormAccountSummaryPojo1(transactionServiceInfo,accPojo,FinBookingFormAccountSummaryPojo.class));
*/							
						} else {
							employeeFinancialServiceDao.updatePaidAmountBookingFormAccountSummary((FinBookingFormAccountSummaryPojo) 
									financialMapper.constructFinBookingFormAccountSummaryPojo1(transactionServiceInfo,accPojo,FinBookingFormAccountSummaryPojo.class));
						}
					}
					
				for (FinancialProjectMileStonePojo accPojo : listOfNonPaidMileStoneDetails) {
						double accPayAmount  = Util.isEmptyObject(accPojo.getPayAmount())?0d:accPojo.getPayAmount();
						double accPaidAmount  = Util.isEmptyObject(accPojo.getPaidAmount())?0d:accPojo.getPaidAmount();
						double amountToSetOff = accPayAmount-accPaidAmount;
						amountToSetOff = roundOffAmount(amountToSetOff);
					if (setOffAmount > 0) {
						if (amountToSetOff > 0) {
							//log.info(" setOffAmount : "+setOffAmount+" -> amountToSetOff :  "+amountToSetOff+" Booking Form Id -> "+accPojo.getFinBookingFormAccountsId()+" "+metaDataName);
							//setOffAmount = setOffAmount- amountToSetOff;
							FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
							
							if (setOffAmount >= amountToSetOff) {
								bookingFormAccountsInfo.setPaymentStatus(Status.PAID.getStatus());
							} else {
								bookingFormAccountsInfo.setPaymentStatus(Status.INPROGRESS.getStatus());
							}
							 Long msStatusId = accPojo.getMsStatusId();
							 if(msStatusId!=null && msStatusId.equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
								bookingFormAccountsInfo.setPaymentStatus(Status.INPROGRESS.getStatus());
							}
							//we are calculating interest amount only for Milestone record
							if (metaDataName.equalsIgnoreCase(MetadataId.FIN_BOOKING_FORM_MILESTONES.getName()) && accPojo.getMileStoneDueDate()!=null) {
								days = TimeUtil.differenceBetweenDays(TimeUtil.removeTimePartFromTimeStamp1(accPojo.getMileStoneDueDate()),TimeUtil.removeTimePartFromTimeStamp1(transactionServiceInfo.getTransactionReceiveDate()));
								if(days>0) {//if this condition execute means the customer paid amount after the due date
									//long isMileStoneWithInterest = Util.isEmptyObject(accPojo.getInterestSelectionType())?0l:accPojo.getInterestSelectionType();
									//log.info("EmployeeFinancialServiceImpl.processTransactionToFinalLevel() calculating Interest isMileStoneWithInterest :"+isMileStoneWithInterest);
									
									finProjDemandNoteInfo.setMilestoneDate(transactionServiceInfo.getTransactionReceiveDate());
									finProjDemandNoteInfo.setInterestCalculationUptoDate(transactionServiceInfo.getTransactionReceiveDate());
									//finProjDemandNoteInfo.setInterestSelectionType(accPojo.getInterestSelectionType());
									finProjDemandNoteInfo.setInterestSelectionType(Status.With_Interest.getStatus());
									finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
									finProjDemandNoteInfo.setInterestCalculationFrom("Receipt");
									finProjDemandNoteInfo.setCreatedBy(transactionServiceInfo.getEmployeeId()==null?transactionServiceInfo.getCreatedBy():transactionServiceInfo.getEmployeeId());
									
									processPenaltyAmount(listOfNonPaidMileStoneDetails,finProjDemandNoteInfo,totalInterestAmount,"insertInterestData","",new HashMap<String,Object>());
								}
							}
								//amountToSetOff holding amount to set off in milestone
								//setOffAmount holding how much amount we can set off against milestone
								if (amountToSetOff > setOffAmount) {
									amountToSetOff = setOffAmount;
									settleAmount = amountToSetOff;
									setOffAmount = setOffAmount - amountToSetOff;
								} else {
									settleAmount = amountToSetOff;
									setOffAmount = setOffAmount - amountToSetOff;
								}
								if(settleAmount!=amountToSetOff) {
									throw new RuntimeException("Amount not matching");
								}
							if(FinTransactionMode.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionModeId())) {
								//if this is INTEREST_WAIVER paid amount will be zero, bcoz this amount is not paying by customer, this amount is waiving by company on request
								bookingFormAccountsInfo.setPaidAmount(0d);
								bookingFormAccountsInfo.setInterestWaiverAdjAmount(amountToSetOff);
							} else {
								bookingFormAccountsInfo.setPaidAmount(amountToSetOff);
								bookingFormAccountsInfo.setInterestWaiverAdjAmount(0d);
							}
							bookingFormAccountsInfo.setActualPaidAmount(amountToSetOff);
							bookingFormAccountsInfo.setBalanceAmount(amountToSetOff);
							bookingFormAccountsInfo.setPaidDate(transactionServiceInfo.getTransactionReceiveDate());
							bookingFormAccountsInfo.setFinBookingFormAccountsId(accPojo.getFinBookingFormAccountsId());
							bookingFormAccountsInfo.setFinBookingFormReceiptsId(bookingFormReceiptId);
							bookingFormAccountsInfo.setCreatedBy(transactionServiceInfo.getEmployeeId());
							bookingFormAccountsInfo.setModifiedBy(transactionServiceInfo.getEmployeeId());
							bookingFormAccountsInfo.setType(typeId);
							bookingFormAccountsInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
							bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
							//FinBookingFormAccountsPojo finBookingFormAccountsPojo = new FinBookingFormAccountsPojo();
							//update account table
							employeeFinancialServiceDao.updateBookingFormAccountPaidAmount((FinBookingFormAccountsPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfo,FinBookingFormAccountsPojo.class));
							employeeFinancialServiceDao.saveFinBookingFormAccountsStatement((FinBookingFormAccountsStatementPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfo,FinBookingFormAccountsStatementPojo.class));
								
							if (typeId.equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId())) {
								accPojo.setSetOffAmount(settleAmount);
								listOfNonPaidMileStoneDetailsList.add(accPojo);
								isAnyRecordExistForAdjustment = true;
								bookingFormAccountsInfo.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
							}
							
							/* for Modification Cost Receipt */
							if (typeId.equals(MetadataId.MODIFICATION_COST.getId())) {
								accPojo.setSetOffAmount(settleAmount);
								listOfPaidModificationCostList.add(accPojo);
							}
							/* for Legal Cost Receipt */
							if (typeId.equals(MetadataId.LEGAL_COST.getId())) {
								//accPojo.setSetOffAmount(settleAmount); changed
								accPojo.setSetOffAmount(entryDetailsPojo.getSetOffAmount());
								listOfPaidLegalCostList.add(accPojo);
							}
							if(MetadataId.MAINTENANCE_CHARGE.getId().equals(typeId)) {
								accPojo.setSetOffAmount(settleAmount);//refund amount
								listOfPaidMaintenanceCost.add(accPojo);//Refund transaction
							}
							if(MetadataId.CORPUS_FUND.getId().equals(typeId)) {
								accPojo.setSetOffAmount(settleAmount);//refund amount
								listOfPaidCorpusFunds.add(accPojo);//Refund transaction
							}
							if(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(typeId)) {
								accPojo.setSetOffAmount(settleAmount);//refund amount
								listOfPaidFlatKhata.add(accPojo);//Refund transaction
							}
							
							/* Malladi Changes */
							/* for Interest cost Receipt */
							if(MetadataId.FIN_PENALTY.getId().equals(typeId)) {
								accPojo.setSetOffAmount(settleAmount);
								listOfPaidInterestCostList.add(accPojo);
								
								penaltyGstAmountAndAdjustAmount(accPojo,isTransactionForIsEmpty);//penalty adjustment
							}
							
							//update booking form account details
								employeeFinancialServiceDao.updatePaidAmountBookingFormAccountSummary((FinBookingFormAccountSummaryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfo,FinBookingFormAccountSummaryPojo.class));
							}
						}
					}

			    //if set off amount more than zero means the amount has been adjusted and we got the excess amount
				if (index == listOfPaymentSetOffData.size() - 1) {//if it is last iteration of the set off
					if (setOffAmount > 0 && tempTransactionSetOffId != 0) {
						//log.info(setOffAmount + " Amount got extra " + metaDataName);
						if (typeId.equals(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()) && isAnyRecordExistForAdjustment) {
							setOffAmountListObject.put("setOffAmount",setOffAmount);
							putExcessAmountInReceipt(setOffAmount,typeId,transactionServiceInfo,customerPropertyDetailsInfo,listOfNonPaidMileStoneDetailsList,setOffAmountListObject,"ProcessTransactionFinalLvl");
							setOffAmount = setOffAmountListObject.get("setOffAmount");
						}
						if (setOffAmount > 0 && !FinTransactionMode.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionModeId())) {
							//inserting amount in excess amount pojo
							constructExcessAmountPojos(setOffAmount, typeId, bookingFormReceiptId, transactionServiceInfo,finBokAccInvoiceNo);
						}
						
						taxPercentageLoadingInfo = new FinancialProjectMileStoneInfo();
						taxPercentageLoadingInfo.setMilestoneDate(transactionServiceInfo.getTransactionReceiveDate() == null? transactionServiceInfo.getTransactionDate() :transactionServiceInfo.getTransactionReceiveDate());
						taxPercentageLoadingInfo.setSiteId(customerPropertyDetailsInfo.getSiteId());
						taxPercentageLoadingInfo.setCondition("ReceiptEntry");

						taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(taxPercentageLoadingInfo,Arrays.asList(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId(),MetadataId.MAINTENANCE_CHARGE.getId(),MetadataId.LEGAL_COST.getId(),MetadataId.FIN_PENALTY.getId()));
						//if any excess amount found in penalty records
						if(MetadataId.FIN_PENALTY.getId().equals(typeId)) {
							putPenaltyExcessAmountInReceipt(setOffAmount,listOfPaidInterestCostList,taxDetailsList,typeId);
						}
						if(MetadataId.MAINTENANCE_CHARGE.getId().equals(typeId)) {
							putMaintenanceExcessAmountInReceipt(setOffAmount,listOfPaidMaintenanceCost,taxDetailsList,typeId);
						}
						if(MetadataId.CORPUS_FUND.getId().equals(typeId)) {
							putCorpusFundExcessAmountInReceipt(setOffAmount,listOfPaidCorpusFunds,taxDetailsList,typeId);
						}
						if(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(typeId)) {
							putFlatKhataExcessAmountInReceipt(setOffAmount,listOfPaidFlatKhata,taxDetailsList,typeId);
						}

					}
				}
			}
		}
		
		//if this is interest waiver
		if (FinTransactionMode.INTEREST_WAIVER.getId().equals(transactionServiceInfo.getTransactionModeId())) {
			if(isThisIsFinalLevel) {
				List<FinancialProjectMileStoneResponse> interestCostResponseList = new ArrayList<>();
				employeeFinancialHelper.sendInterestWaiverPushNotification(transactionServiceInfo);
				employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo,Status.TRANSACTION_COMPLETED.getStatus());
				updateInterestWaiverTrnGstAmount(listOfPaidInterestCostList,interestCostResponseList,transactionServiceInfo);
			}
			//no need to execute the next line of code
			return new EmployeeFinancialTransactionResponse();
		}
		
		//this is common for receipt and payment entry
		//here receipt pdf will generate
		if (isThisIsFinalLevel) {
			double sumOfPrincipalCGST = 0d;
			double sumOfPrincipalSGST = 0d;
			double sumOfPrincipalGstAmount = 0d;
			double totalReceiptPaidAmount = 0d;
			@SuppressWarnings("unused")
			int result = 0;
			EmployeeFinancialTransactionResponse response1 = (EmployeeFinancialTransactionResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(transactionServiceInfo, EmployeeFinancialTransactionResponse.class);
			//update transaction entry table
			employeeFinancialServiceDao.updateTransactionStatus(transactionServiceInfo,Status.TRANSACTION_COMPLETED.getStatus());
			loadCustomerDetails(response1, employeeFinancialServiceInfo, customerPropertyDetailsInfo);
			response1.setFlatsResponse(new ArrayList<CustomerPropertyDetailsInfo>(Arrays.asList(customerPropertyDetailsInfo)));
			customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
			 
			//for milestone receipt
			List<FinancialProjectMileStoneResponse> financialProjectMileStoneResponseList = new ArrayList<>();
			/* for Modification Cost Receipt */
			List<FinancialProjectMileStoneResponse> modificationCostResponseList = new ArrayList<>();
			/* for Legal Cost Receipt */
			List<FinancialProjectMileStoneResponse> legalCostResponseList = new ArrayList<>();
			List<FinancialProjectMileStoneResponse> maintenanceCostResponseList = new ArrayList<>();
			List<FinancialProjectMileStoneResponse> flatKhataResponseList = new ArrayList<>();
			List<FinancialProjectMileStoneResponse> corpusFundsResponseList = new ArrayList<>();
			
			/* Malladi Changes */
			/* for Interest Cost Receipt */
			List<FinancialProjectMileStoneResponse> interestCostResponseList = new ArrayList<>();
			
			List<FinSchemeTaxMappingPojo> schemeTaxDetails = null;
			Map<String, Object> mileStoneGstDetails = null;
			FinancialProjectMileStonePojo mileStonePojo = null;
			FinancialProjectMileStoneInfo finProjDemandNoteInfo12 = null;
			FinancialProjectMileStoneResponse mileStoneInfo = null;
			StringBuffer demandNotePdfName = new StringBuffer("");
			double principalCGST = 0.0;
			double principalSGST = 0.0;
			double principalGstAmount = 0.0;
			//here calculating gst amount on paid amount
			for (int index = 0; index < listOfNonPaidMileStoneDetailsList.size(); index++) {
				mileStonePojo = listOfNonPaidMileStoneDetailsList.get(index);
				finProjDemandNoteInfo12 = new FinancialProjectMileStoneInfo();
				if(mileStonePojo.getMilestoneDate()==null) {
					mileStonePojo.setMilestoneDate(customerPropertyDetailsInfo.getBookingDate());
				}
				finProjDemandNoteInfo12.setMilestoneDate(mileStonePojo.getMilestoneDate());
				Long typeId = mileStonePojo.getTypeId();
				if(typeId != null && typeId != 0) {
					//if typeId is has value then load scheme details using typeId 
					customerPropertyDetailsInfo.setCondition("GetGSTPercentage");	
				}
				
				customerPropertyDetailsInfo.setType(MetadataId.GST.getId());
				customerPropertyDetailsInfo.setTypeId(typeId);
				
				mileStoneGstDetails = getGSTAmount(customerPropertyDetailsInfo,mileStonePojo);
				
				principalCGST = Double.valueOf(mileStoneGstDetails.get("CGST").toString());
				principalSGST = Double.valueOf(mileStoneGstDetails.get("SGST").toString());
				principalGstAmount = Double.valueOf(mileStoneGstDetails.get("GST").toString());;
				
				sumOfPrincipalCGST += Double.valueOf(mileStoneGstDetails.get("CGST").toString());
				sumOfPrincipalSGST += Double.valueOf(mileStoneGstDetails.get("SGST").toString());
				sumOfPrincipalGstAmount += Double.valueOf(mileStoneGstDetails.get("GST").toString());
				
				//if(Util.isEmptyObject(schemeTaxDetails)) 
					schemeTaxDetails = employeeFinancialServiceDao.getFlatBookDetailsSchemeTaxDetails(customerPropertyDetailsInfo,finProjDemandNoteInfo12);
					
				if(Util.isNotEmptyObject(schemeTaxDetails)) {
					 //setting scheme name in customer info, for generating demand note formats for different schemes
					customerPropertyDetailsInfo.setFinSchemeName(schemeTaxDetails.get(0).getFinSchemeName());
					customerPropertyDetailsInfo.setFinSchemeId(schemeTaxDetails.get(0).getFinSchemeId());
					customerPropertyDetailsInfo.setFinSchemeType(schemeTaxDetails.get(0).getFinSchemeType());
				}
				
				//updating paid gst amount
				if(isTransactionForIsEmpty) {
					employeeFinancialServiceDao.revertBookingFormAccountTaxAmountPaid(mileStonePojo);
				} else {
					employeeFinancialServiceDao.updateBookingFormAccountTaxAmountPaid(mileStonePojo);
				}
				if(Util.isNotEmptyObject(mileStonePojo.getMilestoneName())) {
					 demandNotePdfName = new StringBuffer(" "+mileStonePojo.getMilestoneName());
				}
				totalReceiptPaidAmount += mileStonePojo.getSetOffAmount();
				//processSchemeDetails(schemeTaxDetails, mileStonePojo.getSetOffAmount(), finProjDemandNoteInfo, bokFrmDemNteSchTaxMapInfos, customerPropertyDetailsInfo);
				mileStoneInfo = (FinancialProjectMileStoneResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinancialProjectMileStoneResponse.class);
				mileStoneInfo.setPaidAmount(mileStonePojo.getSetOffAmount());
				mileStoneInfo.setCgstAmount(principalCGST);
				mileStoneInfo.setSgstAmount(principalSGST);
				mileStoneInfo.setGstAmount(principalGstAmount);
				financialProjectMileStoneResponseList.add(mileStoneInfo);
			}
			/* for Modification Cost Receipt */
			StringBuffer receiptPerticulers = new StringBuffer("");
			List<FinBookingFormModiCostDtlsPojo> bookingFormModiCostDtlsPojos = null;
			for (int index = 0; index < listOfPaidModificationCostList.size(); index++) {
				mileStonePojo = listOfPaidModificationCostList.get(index);
				bookingFormModiCostDtlsPojos = mileStonePojo.getBookingFormModiCostDtlsPojos();
				for (FinBookingFormModiCostDtlsPojo finBookingFormModiCostDtlsPojo : bookingFormModiCostDtlsPojos) {//modification description IMP
					if(Util.isNotEmptyObject(finBookingFormModiCostDtlsPojo.getModificationChargeDesc())) {
						receiptPerticulers.append(finBookingFormModiCostDtlsPojo.getModificationChargeDesc()+"<br/>");
					}
				}
				mileStonePojo.setMilestoneName(receiptPerticulers.toString());
				mileStoneInfo = (FinancialProjectMileStoneResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinancialProjectMileStoneResponse.class);
				mileStoneInfo.setPaidAmount(mileStonePojo.getSetOffAmount());
				mileStoneInfo.setDocumentLocation(bookingFormModiCostDtlsPojos.get(0).getDocumentLocation());
				modificationCostResponseList.add(mileStoneInfo);
			}
			
			/* for Legal Cost Receipt */
			receiptPerticulers = new StringBuffer("");
			List<FinBookingFormLglCostDtlsPojo> bookingFormLglCostDtlsPojos = null;
			for (int index = 0; index < listOfPaidLegalCostList.size(); index++) {
				mileStonePojo = listOfPaidLegalCostList.get(index);
				bookingFormLglCostDtlsPojos = mileStonePojo.getBookingFormLglCostDtlsPojos();
				for (FinBookingFormLglCostDtlsPojo finBookingFormLglCostDtlsPojo : bookingFormLglCostDtlsPojos) {
					if(Util.isNotEmptyObject(finBookingFormLglCostDtlsPojo.getDescription())) {
						receiptPerticulers.append(finBookingFormLglCostDtlsPojo.getDescription());
					}
				}
				mileStonePojo.setMilestoneName(Util.isEmptyObject(receiptPerticulers.toString())?"Flat Legal and Documentation Charges":receiptPerticulers.toString());
				mileStoneInfo = (FinancialProjectMileStoneResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinancialProjectMileStoneResponse.class);
				mileStoneInfo.setPaidAmount(mileStonePojo.getSetOffAmount());
				mileStoneInfo.setDocumentLocation(bookingFormLglCostDtlsPojos.get(0).getDocumentLocation());
				legalCostResponseList.add(mileStoneInfo);
			}

			receiptPerticulers = new StringBuffer("");
			List<FinBookingFormMaintenanceDtlsPojo> bookingFormMaintenanceCostPojos = null;
			for (int index = 0; index < listOfPaidMaintenanceCost.size(); index++) {
				mileStonePojo = listOfPaidMaintenanceCost.get(index);
				bookingFormMaintenanceCostPojos = mileStonePojo.getMaintenanceChargesDtlsPojos();
				for (FinBookingFormMaintenanceDtlsPojo maintenanceDtlsPojo : bookingFormMaintenanceCostPojos) {
					if(Util.isNotEmptyObject(maintenanceDtlsPojo.getDescription())) {
						receiptPerticulers.append(maintenanceDtlsPojo.getDescription());
					}
				}
				mileStonePojo.setMilestoneName(Util.isEmptyObject(receiptPerticulers.toString())?"Maintenance Charges":receiptPerticulers.toString());
				mileStoneInfo = (FinancialProjectMileStoneResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinancialProjectMileStoneResponse.class);
				mileStoneInfo.setPaidAmount(mileStonePojo.getSetOffAmount());
				//mileStoneInfo.setDocumentLocation(bookingFormMaintenanceCostPojos.get(0).getDocumentLocation());
				maintenanceCostResponseList.add(mileStoneInfo);
			}

			receiptPerticulers = new StringBuffer("");
			//List<FinBookingFormMaintenanceDtlsPojo> bookingFormMaintenanceCostPojos = null;
			for (int index = 0; index < listOfPaidCorpusFunds.size(); index++) {
				mileStonePojo = listOfPaidCorpusFunds.get(index);
				/*bookingFormMaintenanceCostPojos = mileStonePojo.getMaintenanceChargesDtlsPojos();
				for (FinBookingFormMaintenanceDtlsPojo maintenanceDtlsPojo : bookingFormMaintenanceCostPojos) {
					if(Util.isNotEmptyObject(maintenanceDtlsPojo.getDescription())) {
						receiptPerticulers.append(maintenanceDtlsPojo.getDescription());
					}
				}*/mileStonePojo.getMilestoneName();
				if("Excess Amount".equals(mileStonePojo.getMilestoneName())) {
					receiptPerticulers.append(mileStonePojo.getMilestoneName());
				} else {
					//receiptPerticulers.append("Corpus Fund ");
				}
				mileStonePojo.setMilestoneName(Util.isEmptyObject(receiptPerticulers.toString())?"Corpus Fund ":receiptPerticulers.toString());
				mileStoneInfo = (FinancialProjectMileStoneResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinancialProjectMileStoneResponse.class);
				mileStoneInfo.setPaidAmount(mileStonePojo.getSetOffAmount());
				//mileStoneInfo.setDocumentLocation(bookingFormMaintenanceCostPojos.get(0).getDocumentLocation());
				corpusFundsResponseList.add(mileStoneInfo);
			}
			
			receiptPerticulers = new StringBuffer("");
			List<FinBookingFormFlatKhataDtlsPojo> flatKhataChargesList = null;
			for (int index = 0; index < listOfPaidFlatKhata.size(); index++) {
				mileStonePojo = listOfPaidFlatKhata.get(index);
				flatKhataChargesList = mileStonePojo.getFlatKhataChargesDtlsPojos();
				for (FinBookingFormFlatKhataDtlsPojo flatKhataDtlsPojo : flatKhataChargesList) {
					if(Util.isNotEmptyObject(flatKhataDtlsPojo.getDescription())) {
						receiptPerticulers.append(flatKhataDtlsPojo.getDescription());
					}
				}
				if("Excess Amount".equals(mileStonePojo.getMilestoneName())) {
					
				} else {
					mileStonePojo.setMilestoneName(Util.isEmptyObject(receiptPerticulers.toString())?"Flat Khata bifurcation and other charges":receiptPerticulers.toString());
				}
				mileStoneInfo = (FinancialProjectMileStoneResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinancialProjectMileStoneResponse.class);
				mileStoneInfo.setPaidAmount(mileStonePojo.getSetOffAmount());
				//mileStoneInfo.setDocumentLocation(flatKhataChargesList.get(0).getDocumentLocation());
				flatKhataResponseList.add(mileStoneInfo);
			}
			
			/* Malladi Changes */
			/* for Interest Cost Receipt */
			for (int index = 0; index < listOfPaidInterestCostList.size(); index++) {
				mileStonePojo = listOfPaidInterestCostList.get(index);System.out.println(mileStonePojo.getMilestoneName());
				if("Excess Amount".equals(mileStonePojo.getMilestoneName())) {
					
				} else {
					mileStonePojo.setMilestoneName("Interest Charges");
				}
				mileStoneInfo = (FinancialProjectMileStoneResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinancialProjectMileStoneResponse.class);
				mileStoneInfo.setPaidAmount(mileStonePojo.getSetOffAmount());
				//mileStoneInfo.setDocumentLocation(bookingFormLglCostDtlsPojos.get(0).getDocumentLocation());
				interestCostResponseList.add(mileStoneInfo);
			}

			FinBookingFormAccountsInfo bookingFormAccountsInfoForTax = new FinBookingFormAccountsInfo();
			bookingFormAccountsInfoForTax.setPaidAmount(sumOfPrincipalCGST+sumOfPrincipalSGST);
			bookingFormAccountsInfoForTax.setType(MetadataId.FIN_BOOKING_FORM_MILESTONE_TAX.getId());
			bookingFormAccountsInfoForTax.setBookingFormId(transactionServiceInfo.getBookingFormId());
			bookingFormAccountsInfoForTax.setModifiedBy(transactionServiceInfo.getEmployeeId());
			//updating paid amount
			if(!bookingFormAccountsInfoForTax.getPaidAmount().equals(0d) && !isTransactionForIsEmpty) {
				//if this is receipt entry
				employeeFinancialServiceDao.updatePaidAmountBookingFormAccountSummary((FinBookingFormAccountSummaryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfoForTax,FinBookingFormAccountSummaryPojo.class));
			}else {
				//if this is payment entry
				bookingFormAccountsInfoForTax.setRefundAmount(sumOfPrincipalCGST+sumOfPrincipalSGST);
				if(!bookingFormAccountsInfoForTax.getRefundAmount().equals(0d)) {
					result = employeeFinancialServiceDao.updateBookingFormAccountSummaryRefundAmount((FinBookingFormAccountSummaryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfoForTax,FinBookingFormAccountSummaryPojo.class));
				}
			}

			String demandNotePDFname = Util.isEmptyObject(demandNotePdfName.toString())?"Receipt no "+transactionServiceInfo.getTransactionEntryId():demandNotePdfName.toString();

			String siteName = customerPropertyDetailsInfo.getSiteName();
			if (customerPropertyDetailsInfo.getSiteId() != null && customerPropertyDetailsInfo.getSiteId().equals(131l)) {
				siteName = "Aspire Aurum";
			}
			
			response1.setTransactionPdfFileName(customerPropertyDetailsInfo.getFlatNo()+"-"+siteName+"-"+demandNotePDFname+".pdf");
			response1.setFinancialProjectMileStoneResponse(financialProjectMileStoneResponseList);
			response1.setModificationCostResponseList(modificationCostResponseList);
			response1.setLegalCostResponseList(legalCostResponseList);
			response1.setInterestCostResponseList(interestCostResponseList);
			response1.setMaintenanceCostResponseList(maintenanceCostResponseList);
			response1.setFlatKhataResponseList(flatKhataResponseList);
			response1.setCorpusFundsResponseList(corpusFundsResponseList);

			response1.setTotalReceiptAmount(transactionServiceInfo.getTransactionAmount());
			response1.setTotalReceiptPaidAmount(totalReceiptPaidAmount);
			response1.setTransactionReceiveDate(transactionServiceInfo.getTransactionReceiveDate());
			response1.setTotalCgstAmount(sumOfPrincipalCGST);
			response1.setTotalSgstAmount(sumOfPrincipalSGST);
			response1.setTotalGSTAmount(sumOfPrincipalGstAmount);
			
			//List<EmployeeFinancialTransactionServiceInfo> holdFilePath = new ArrayList<>(); 
			fileInfo = new FileInfo();
			fileInfoList =  new ArrayList<>();
			transactionReceiptNo = "";
			
			sendEmailAndNotification = Util.isEmptyObject(prop.getProperty("SEND_NOTIFICATION_AND_EMAIL"))?true:prop.getProperty("SEND_NOTIFICATION_AND_EMAIL").equals("yes");
			//if value is true then sending pushnotificaton and email to customer, else not sending
			if (sendEmailAndNotification == false) {
				//based on condition stopping notification and email to send
				transactionServiceInfo.setSendNotification(sendEmailAndNotification);
			}
			if(isTransactionForIsEmpty) {
				//if this payment entry
				updateTransactionRefundGSTPaidAmount(transactionServiceInfo,response1);
			}

			if(!isTransactionForIsEmpty) {
				//if This is receipt entry Transaction
				if (Util.isEmptyObject(transactionServiceInfo.getTransactionReceiptNo())) {
					transactionReceiptNo = generateTransactionReceiptNo(transactionServiceInfo);
				} else {
					transactionReceiptNo = transactionServiceInfo.getTransactionReceiptNo();
				}
				response1.setTransactionReceiptNo(transactionReceiptNo);
				FinTransactionEntryDocPojo pojo = null;
				
				//if(!financialProjectMileStoneResponseList.isEmpty()) {
				if(Util.isNotEmptyObject(response1.getFinancialProjectMileStoneResponse())) {
					//For Principal amount Receipt
					employeeFinancialHelper.receiptGenaratorHelper(response1,fileInfo,transactionServiceInfo);
					
					fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
					pojo = (FinTransactionEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(fileInfo, FinTransactionEntryDocPojo.class);
					pojo.setTransactionEntryId(transactionEntryId);
					pojo.setDocumentType(MetadataId.GENERATED.getId());//type of document, uploaded file or generated file
					pojo.setReceiptType(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId());// ReceiptType can be princial, legal, modification
					pojo.setStatusId(Status.ACTIVE.getStatus());
					employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
					FinTransactionSetOffPojo setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfPrincipalGstAmount,transactionServiceInfo,MetadataId.FIN_BOOKING_FORM_MILESTONES, FinTransactionSetOffPojo.class);
					employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);

					response1.setFileResponse(fileInfo);
					fileInfoList.add(fileInfo);
				}
				// For Modification Cost Receipt 
				if(Util.isNotEmptyObject(response1.getModificationCostResponseList())) {
					double sumOfModificationGstAmount = 0d;
					//double sumOfSGSTForModification = 0d;
					double totalModificationCostPaidAmount = 0d;
						for(FinancialProjectMileStoneResponse modificationCostResponse : response1.getModificationCostResponseList()){
							totalModificationCostPaidAmount += modificationCostResponse.getPaidAmount();
							List<FinBookingFormModiCostDtlsResponse> bookingFormModiCostDtlsResponses = modificationCostResponse.getBookingFormModiCostDtlsResponses();
							double percentageValue = 0d;
							if(Util.isNotEmptyObject(bookingFormModiCostDtlsResponses)) {
								percentageValue = Util.isEmptyObject(bookingFormModiCostDtlsResponses.get(0).getPercentageValue())?0d:Double.valueOf(bookingFormModiCostDtlsResponses.get(0).getPercentageValue());
							}
							double gstAmount = ((percentageValue/(percentageValue+100))*(modificationCostResponse.getSetOffAmount()));
							sumOfModificationGstAmount += gstAmount;
							 
							modificationCostResponse.setCgstAmount(gstAmount/2);
							modificationCostResponse.setSgstAmount(gstAmount/2);
							modificationCostResponse.setGstAmount(gstAmount);
						}	
						FileInfo fileInfoForModification = new FileInfo();
						response1.setTotalCgstAmount(sumOfModificationGstAmount/2);
						response1.setTotalSgstAmount(sumOfModificationGstAmount/2);
						response1.setTotalReceiptPaidAmount(totalModificationCostPaidAmount);
						response1.setTotalGSTAmount(sumOfModificationGstAmount);
						response1.setTransactionPdfFileName(customerPropertyDetailsInfo.getFlatNo()+" - Modification Receipt.pdf");
						employeeFinancialHelper.receiptGenaratorHelperForModificationLegalCost(response1,fileInfoForModification,transactionServiceInfo, MetadataId.MODIFICATION_COST.getName());
						fileInfoForModification.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						pojo = (FinTransactionEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToModificationPojoBean(fileInfoForModification,transactionServiceInfo, FinTransactionEntryDocPojo.class);
						employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						FinTransactionSetOffPojo setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfModificationGstAmount,transactionServiceInfo, MetadataId.MODIFICATION_COST, FinTransactionSetOffPojo.class);
						employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);
						fileInfoList.add(fileInfoForModification);
						
						// sending mail to customers
						if(transactionServiceInfo.isSendNotification() && !transactionServiceInfo.isThisUplaodedData() && !transactionServiceInfo.isThisEditTransaction() && !transactionServiceInfo.isThisShiftTransaction() ) {
							//MetadataId.MODIFICATION_COST.getId()
							// in use employeeFinancialHelper.sendFinancialMailToCustomers123(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(response1)), new ArrayList<FileInfo>(Arrays.asList(fileInfoForModification)), Status.PAID.getDescription());
						}
					}
					
					// For Legal Cost Receipt 
					if(Util.isNotEmptyObject(response1.getLegalCostResponseList())) {
						double sumOfLegalGstAmount = 0d;
						//double sumOfSGSTForLegal = 0d;
						double totalLegalCostPaidAmount = 0d;
						for(FinancialProjectMileStoneResponse legalCostResponse : response1.getLegalCostResponseList()){
							totalLegalCostPaidAmount += legalCostResponse.getPaidAmount();
							List<FinBookingFormLglCostDtlsResponse> bookingFormLglCostDtlsResponses = legalCostResponse.getBookingFormLglCostDtlsResponses();
							double percentageValue = 0d;
							if(Util.isNotEmptyObject(bookingFormLglCostDtlsResponses)) {
								percentageValue = Util.isEmptyObject(bookingFormLglCostDtlsResponses.get(0).getPercentageValue())?0d:Double.valueOf(bookingFormLglCostDtlsResponses.get(0).getPercentageValue());
							}
							double gstAmount = ((percentageValue/(percentageValue+100))*(legalCostResponse.getSetOffAmount()));
							sumOfLegalGstAmount += gstAmount;
							 
							legalCostResponse.setCgstAmount(gstAmount/2);
							legalCostResponse.setSgstAmount(gstAmount/2);
							legalCostResponse.setGstAmount(gstAmount);
						}
						FileInfo fileInfoForLegal = new FileInfo();
						response1.setTotalCgstAmount(sumOfLegalGstAmount/2);
						response1.setTotalSgstAmount(sumOfLegalGstAmount/2);
						response1.setTotalReceiptPaidAmount(totalLegalCostPaidAmount);
						response1.setTotalGSTAmount(sumOfLegalGstAmount);
						response1.setTransactionPdfFileName(customerPropertyDetailsInfo.getFlatNo()+" - Legal Receipt.pdf");
						employeeFinancialHelper.receiptGenaratorHelperForModificationLegalCost(response1,fileInfoForLegal,transactionServiceInfo, MetadataId.LEGAL_COST.getName());
						fileInfoForLegal.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						pojo = (FinTransactionEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToLegalPojoBean(fileInfoForLegal,transactionServiceInfo, FinTransactionEntryDocPojo.class);
						
						employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						FinTransactionSetOffPojo setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfLegalGstAmount,transactionServiceInfo, MetadataId.LEGAL_COST, FinTransactionSetOffPojo.class);
						employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);

						fileInfoList.add(fileInfoForLegal);
						// sending mail to customers
						if(transactionServiceInfo.isSendNotification() && !transactionServiceInfo.isThisUplaodedData()  && !transactionServiceInfo.isThisEditTransaction() && !transactionServiceInfo.isThisShiftTransaction() ) {
							//MetadataId.LEGAL_COST.getId()
							// in use employeeFinancialHelper.sendFinancialMailToCustomers123(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(response1)), new ArrayList<FileInfo>(Arrays.asList(fileInfoForLegal)), Status.PAID.getDescription());
						}
					}

					if(Util.isNotEmptyObject(response1.getMaintenanceCostResponseList())) {
						double sumOfMaintenanceGstAmount = 0d;
						double totalMeintenancePaidAmount = 0d;
						double percentageValue = 0d;
						for(FinancialProjectMileStoneResponse maintenanceCost : response1.getMaintenanceCostResponseList()){
							totalMeintenancePaidAmount += maintenanceCost.getPaidAmount();
							List<FinBookingFormMaintenanceDtlsPojo> bookingFormMaintenanceDtlsResponses = maintenanceCost.getMaintenanceChargesDtlsResponse();
							
							if(Util.isNotEmptyObject(bookingFormMaintenanceDtlsResponses)) {
								for(FinBokFrmMaintenanceTaxPojo maintenanceTaxInfo : bookingFormMaintenanceDtlsResponses.get(0).getMaintenanceTaxPojos()){
									percentageValue = Util.isEmptyObject(maintenanceTaxInfo.getPercentageValue()) ? 0d : Double.valueOf(maintenanceTaxInfo.getPercentageValue());	
								}
							}
							double gstAmount = ((percentageValue/(percentageValue+100))*(maintenanceCost.getSetOffAmount()));
							sumOfMaintenanceGstAmount += gstAmount;
							 
							maintenanceCost.setCgstAmount(gstAmount/2);
							maintenanceCost.setSgstAmount(gstAmount/2);
							maintenanceCost.setGstAmount(gstAmount);
						}
						FileInfo fileInfoForMaintenance = new FileInfo();
						response1.setTotalCgstAmount(sumOfMaintenanceGstAmount/2);
						response1.setTotalSgstAmount(sumOfMaintenanceGstAmount/2);
						response1.setTotalReceiptPaidAmount(totalMeintenancePaidAmount);
						response1.setTotalGSTAmount(sumOfMaintenanceGstAmount);
						response1.setTransactionPdfFileName(customerPropertyDetailsInfo.getFlatNo()+" - Maintenance Receipt.pdf");
						employeeFinancialHelper.receiptGenaratorHelperForModificationLegalCost(response1,fileInfoForMaintenance,transactionServiceInfo, MetadataId.MAINTENANCE_CHARGE.getName());
						
						fileInfoForMaintenance.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						pojo = (FinTransactionEntryDocPojo) financialMapper.constructTransactionDocumentPojo(fileInfoForMaintenance,transactionServiceInfo,MetadataId.MAINTENANCE_CHARGE.getId(), FinTransactionEntryDocPojo.class);
						
						employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						FinTransactionSetOffPojo setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfMaintenanceGstAmount,transactionServiceInfo, MetadataId.MAINTENANCE_CHARGE, FinTransactionSetOffPojo.class);
						employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);

						//fileInfoList.add(fileInfoForMaintenance);
						// sending mail to customers
						if(transactionServiceInfo.isSendNotification() && !transactionServiceInfo.isThisUplaodedData()  && !transactionServiceInfo.isThisEditTransaction() && !transactionServiceInfo.isThisShiftTransaction() ) {
							//MetadataId.MAINTENANCE_CHARGE.getId()
							// in use employeeFinancialHelper.sendFinancialMailToCustomers123(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(response1)), new ArrayList<FileInfo>(Arrays.asList(fileInfoForLegal)), Status.PAID.getDescription());
						}
					}

					if(Util.isNotEmptyObject(response1.getFlatKhataResponseList())) {
						double sumOfFlatKhataGstAmount = 0d;
						double totalFlatKhataPaidAmount = 0d;
						double percentageValue = 0d;
						for(FinancialProjectMileStoneResponse flatKhataCost : response1.getFlatKhataResponseList()){
							totalFlatKhataPaidAmount += flatKhataCost.getPaidAmount();
							List<FinBookingFormFlatKhataDtlsPojo> bookingFormFlatKhataDtlsResponses = flatKhataCost.getFlatKhataChargesDtlsResponse();
							
							if(Util.isNotEmptyObject(bookingFormFlatKhataDtlsResponses)) {
								for(FinBokFrmFlatKhataTaxPojo maintenanceTaxInfo : bookingFormFlatKhataDtlsResponses.get(0).getFlatKhataTAXDetailsPojo()){
									percentageValue = Util.isEmptyObject(maintenanceTaxInfo.getPercentageValue()) ? 0d : Double.valueOf(maintenanceTaxInfo.getPercentageValue());	
								}
							}
							double gstAmount = ((percentageValue/(percentageValue+100))*(flatKhataCost.getSetOffAmount()));
							sumOfFlatKhataGstAmount += gstAmount;
							 
							flatKhataCost.setCgstAmount(gstAmount/2);
							flatKhataCost.setSgstAmount(gstAmount/2);
							flatKhataCost.setGstAmount(gstAmount);
						}
						FileInfo fileInfoForFlatKhata = new FileInfo();
						response1.setTotalCgstAmount(sumOfFlatKhataGstAmount/2);
						response1.setTotalSgstAmount(sumOfFlatKhataGstAmount/2);
						response1.setTotalReceiptPaidAmount(totalFlatKhataPaidAmount);
						response1.setTotalGSTAmount(sumOfFlatKhataGstAmount);
						response1.setTransactionPdfFileName(customerPropertyDetailsInfo.getFlatNo()+" - Flat Khata Receipt.pdf");
						employeeFinancialHelper.receiptGenaratorHelperForModificationLegalCost(response1,fileInfoForFlatKhata,transactionServiceInfo, MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getName());
						fileInfoForFlatKhata.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						pojo = (FinTransactionEntryDocPojo) financialMapper.constructTransactionDocumentPojo(fileInfoForFlatKhata,transactionServiceInfo,MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId(), FinTransactionEntryDocPojo.class);
						
						employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						FinTransactionSetOffPojo setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfFlatKhataGstAmount,transactionServiceInfo, MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES, FinTransactionSetOffPojo.class);
						employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);

						//fileInfoList.add(fileInfoForFlatKhata);
						// sending mail to customers
						if(transactionServiceInfo.isSendNotification() && !transactionServiceInfo.isThisUplaodedData()  && !transactionServiceInfo.isThisEditTransaction() && !transactionServiceInfo.isThisShiftTransaction() ) {
							//MetadataId.MAINTENANCE_CHARGE.getId()
							// in use employeeFinancialHelper.sendFinancialMailToCustomers123(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(response1)), new ArrayList<FileInfo>(Arrays.asList(fileInfoForLegal)), Status.PAID.getDescription());
						}
					}
					
					if(Util.isNotEmptyObject(response1.getCorpusFundsResponseList())) {
						//for corpus fund we don't have any GST
						double sumOfCorpusGstAmount = 0d;
						double totalFlatKhataPaidAmount = 0d;
						//double percentageValue = 0d;
						for(FinancialProjectMileStoneResponse corpusFund : response1.getCorpusFundsResponseList()){
							totalFlatKhataPaidAmount += corpusFund.getPaidAmount();
							//List<FinBookingFormCorpusFundPojo> finBookingFormCorpusFundPojo = corpusFund.getFlatKhataChargesDtlsResponse();
							
							double gstAmount = 0.0;//((percentageValue/(percentageValue+100))*(corpusFund.getSetOffAmount()));
							sumOfCorpusGstAmount += gstAmount;
							 
							corpusFund.setCgstAmount(gstAmount/2);
							corpusFund.setSgstAmount(gstAmount/2);
							corpusFund.setGstAmount(gstAmount);
						}
						FileInfo fileInfoForCorpusFund = new FileInfo();
						response1.setTotalCgstAmount(sumOfCorpusGstAmount/2);
						response1.setTotalSgstAmount(sumOfCorpusGstAmount/2);
						response1.setTotalReceiptPaidAmount(totalFlatKhataPaidAmount);
						response1.setTotalGSTAmount(sumOfCorpusGstAmount);
						response1.setTransactionPdfFileName(customerPropertyDetailsInfo.getFlatNo()+" - Corpus Fund Receipt.pdf");
						employeeFinancialHelper.receiptGenaratorHelperForModificationLegalCost(response1,fileInfoForCorpusFund,transactionServiceInfo, MetadataId.CORPUS_FUND.getName());
						fileInfoForCorpusFund.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						pojo = (FinTransactionEntryDocPojo) financialMapper.constructTransactionDocumentPojo(fileInfoForCorpusFund,transactionServiceInfo,MetadataId.CORPUS_FUND.getId(), FinTransactionEntryDocPojo.class);
						
						employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						FinTransactionSetOffPojo setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfCorpusGstAmount,transactionServiceInfo, MetadataId.CORPUS_FUND, FinTransactionSetOffPojo.class);
						employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);

						//fileInfoList.add(fileInfoForCorpusFund);
						// sending mail to customers
						if(transactionServiceInfo.isSendNotification() && !transactionServiceInfo.isThisUplaodedData()  && !transactionServiceInfo.isThisEditTransaction() && !transactionServiceInfo.isThisShiftTransaction() ) {
							//MetadataId.MAINTENANCE_CHARGE.getId()
							// in use employeeFinancialHelper.sendFinancialMailToCustomers123(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(response1)), new ArrayList<FileInfo>(Arrays.asList(fileInfoForLegal)), Status.PAID.getDescription());
						}
					}
					
					/* Malladi Changes */
					// For Interest Cost Receipt 
					if(Util.isNotEmptyObject(response1.getInterestCostResponseList())) {
						double sumOfInterestGstAmount = 0d;
						//double sumOfSGSTForLegal = 0d;
						double totalInterestCostPaidAmount = 0d;FinancialProjectMileStoneResponse excessAmt = null;
						double InterestGstAmount = 0d;double InterestCostPaidAmount = 0d;
						//double percentageValue = 0d;
						List<FinancialProjectMileStoneResponse> interestCostSingleResponseList = new ArrayList<>();
						FinancialProjectMileStoneResponse interestCostSingleResponse = new FinancialProjectMileStoneResponse(); 
						for(FinancialProjectMileStoneResponse interestCostResponse : response1.getInterestCostResponseList()){
							totalInterestCostPaidAmount += interestCostResponse.getPaidAmount();
							/*percentageValue = 18d;
							double gstAmount = ((percentageValue/(percentageValue+100))*(interestCostResponse.getSetOffAmount()));*/
							sumOfInterestGstAmount += interestCostResponse.getGstAmount();//sumOfInterestGstAmount += gstAmount;
							if("Excess Amount".equals(interestCostResponse.getMilestoneName())) {
								excessAmt = interestCostResponse;
							} else {
								InterestCostPaidAmount += interestCostResponse.getPaidAmount();
								InterestGstAmount += interestCostResponse.getGstAmount();//sumOfInterestGstAmount += gstAmount;
							}
						}
						interestCostSingleResponse = response1.getInterestCostResponseList().get(0);
						if(InterestCostPaidAmount!=0) {
							interestCostSingleResponse.setPaidAmount(InterestCostPaidAmount);
							interestCostSingleResponse.setCgstAmount(InterestGstAmount/cgstDividedBy);
							interestCostSingleResponse.setSgstAmount(InterestGstAmount/sgstDividedBy);
							interestCostSingleResponse.setGstAmount(InterestGstAmount);
							interestCostSingleResponseList.add(interestCostSingleResponse);//ading single record
						}
						if(Util.isNotEmptyObject(excessAmt)) {
							interestCostSingleResponseList.add(excessAmt);	//adding excess amount record
						}
						response1.setInterestCostResponseList(interestCostSingleResponseList);
						FileInfo fileInfoForInterests = new FileInfo();
						response1.setTotalCgstAmount(sumOfInterestGstAmount/2);
						response1.setTotalSgstAmount(sumOfInterestGstAmount/2);
						response1.setTotalReceiptPaidAmount(totalInterestCostPaidAmount);
						response1.setTotalGSTAmount(sumOfInterestGstAmount);
						response1.setTransactionPdfFileName(customerPropertyDetailsInfo.getFlatNo()+" - Interest Receipt.pdf");
						employeeFinancialHelper.receiptGenaratorHelperForModificationLegalCost(response1,fileInfoForInterests,transactionServiceInfo, MetadataId.FIN_PENALTY.getName());
						fileInfoForInterests.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						fileInfo.setCreatedBy(String.valueOf(transactionServiceInfo.getEmployeeId()));
						pojo = (FinTransactionEntryDocPojo) financialMapper.copyPropertiesFromInfoBeanToInterestPojoBean(fileInfoForInterests,transactionServiceInfo, FinTransactionEntryDocPojo.class);
						
						employeeFinancialServiceDao.saveTransactionEntryDocuments(pojo);
						FinTransactionSetOffPojo setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfInterestGstAmount,transactionServiceInfo, MetadataId.FIN_PENALTY, FinTransactionSetOffPojo.class);
						employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);

						fileInfoList.add(fileInfoForInterests);
						// sending mail to customers
						if(transactionServiceInfo.isSendNotification() && !transactionServiceInfo.isThisUplaodedData()  && !transactionServiceInfo.isThisEditTransaction() && !transactionServiceInfo.isThisShiftTransaction() ) {
							//MetadataId.LEGAL_COST.getId()
							// in use employeeFinancialHelper.sendFinancialMailToCustomers123(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(response1)), new ArrayList<FileInfo>(Arrays.asList(fileInfoForLegal)), Status.PAID.getDescription());
						}
					}
					
					if(Util.isEmptyObject(response1.getFileResponse())) {
						if(Util.isNotEmptyObject(fileInfoList)) {
							response1.setFileResponse(fileInfoList.get(0));
						}
					}
					
					/* adding all fineInfos to response */
					response1.setFileInfoList(fileInfoList);
					/* sending push notifications alter to Customer */
					
					try {
						if(Util.isNotEmptyObject(response1.getFinancialProjectMileStoneResponse()) && transactionServiceInfo.isSendNotification()  && !transactionServiceInfo.isThisEditTransaction() && !transactionServiceInfo.isThisShiftTransaction()) {
							//this code is only for receipt entry, Principal amount setoff
							String invoiceDocument = response1.getFinancialProjectMileStoneResponse().get(0).getDocumentLocation();
							
							EmployeeFinancialPushNotificationInfo  financialPushNotification = new EmployeeFinancialPushNotificationInfo();
							financialPushNotification.setBookingFormId(transactionServiceInfo.getBookingFormId());
							
							financialPushNotification.setNotificationTitle("Thank you! We Received your Payment.");
							financialPushNotification.setNotificationBody("We Thank you for the Payment. The payment receipt is uploaded in the receipts tab in your App for your kind perusal.");
							if(transactionServiceInfo.getSiteId()!=null && transactionServiceInfo.getSiteId().equals(131l)) {
								//financialPushNotification.setNotificationTitle("Aspire Aurum Receipt");
								//financialPushNotification.setNotificationBody("Dear Customer your receipt has been generated!.");
								financialPushNotification.setNotificationDescription("");
								financialPushNotification.setTypeMsg("Sumadhura Receipt");
								financialPushNotification.setTypeOfPushNotificationMsg("Sumadhura Receipt");
							} else {
								//financialPushNotification.setNotificationTitle("Sumadhura Receipt");
								//financialPushNotification.setNotificationBody("Dear Customer your receipt has been generated!.");
								financialPushNotification.setNotificationDescription("");
								financialPushNotification.setTypeMsg("Sumadhura Receipt");	
								financialPushNotification.setTypeOfPushNotificationMsg("Sumadhura Receipt");
							}
							
							financialPushNotification.setStatus("Transaction Completed");
							financialPushNotification.setPaymentMode(response1.getTransactionModeName());
							financialPushNotification.setBankName(transactionServiceInfo.getBankName());
							financialPushNotification.setAmount(Util.isEmptyObject(transactionServiceInfo.getTransactionAmount())?"0.00":currencyUtil.getTheAmountWithCommas(transactionServiceInfo.getTransactionAmount(), roundingModeSize, roundingMode));
							financialPushNotification.setReceiptNumber(response1.getTransactionReceiptNo());
							financialPushNotification.setReferenceNumber(Util.isEmptyObject(transactionServiceInfo.getReferenceNo())?transactionServiceInfo.getChequeNumber():transactionServiceInfo.getReferenceNo().toString());
							financialPushNotification.setClearenceDate(transactionServiceInfo.getChequeClearanceDate()==null?transactionServiceInfo.getTransactionReceiveDate():transactionServiceInfo.getChequeClearanceDate());
							financialPushNotification.setCreatedDate(new Timestamp(new Date().getTime()));
							financialPushNotification.setSiteId(transactionServiceInfo.getSiteId());
							if(Util.isNotEmptyObject(response1.getFileResponse())) {
								financialPushNotification.setUploadedDocs(response1.getFileResponse().getUrl());
								financialPushNotification.setMileStoneName(response1.getFileResponse().getName());
								financialPushNotification.setInvoiceDocument(invoiceDocument);
							}
							//milestone push notification
							pushNotificationHelper.sendFinancialStatusNotification(financialPushNotification,response1);	
						}
					} catch (Exception e) {
						log.info(e.getMessage());
					}
					
				/* sending mail to customers */
				if(transactionServiceInfo.isSendNotification() && !transactionServiceInfo.isThisUplaodedData()
						&& !transactionServiceInfo.isThisEditTransaction() && !transactionServiceInfo.isThisShiftTransaction() 
						&& Util.isNotEmptyObject(response1.getFinancialProjectMileStoneResponse()) ) {
					//milestone email notification
					employeeFinancialHelper.sendFinancialMailToCustomers(new ArrayList<EmployeeFinancialTransactionResponse>(Arrays.asList(response1)), new ArrayList<FileInfo>(Arrays.asList(fileInfo)), Status.PAID.getDescription(),null);
				}
			}
			
			EmployeeFinancialTransactionResponse response2 = new EmployeeFinancialTransactionResponse();	
			response2.setFileInfoList(response1.getFileInfoList());
			response2.setFileResponse(response1.getFileResponse());
			return response2;
	}

		EmployeeFinancialTransactionResponse response2 = new EmployeeFinancialTransactionResponse();

		return response2;
	}
	
	private void putCorpusFundExcessAmountInReceipt(double setOffAmount, List<FinancialProjectMileStonePojo> listOfPaidCorpusFunds,
			List<FinPenaltyTaxPojo> taxDetailsList, Long paymentTypeId)  throws Exception {
		//FinPenaltyTaxPojo finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,paymentTypeId);
		FinancialProjectMileStonePojo pojo = new FinancialProjectMileStonePojo();
		pojo.setMilestoneName("Excess Amount");

/*		if (finTaxPojo == null) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add maintenance GST percentage..."));
		}
*/
		//we don't have gst for corpus
		double gstAmount = 0.0;
		
		pojo.setGstAmount(gstAmount);
		pojo.setCgstAmount(gstAmount/cgstDividedBy);
		pojo.setSgstAmount(gstAmount/sgstDividedBy);
		pojo.setSetOffAmount(setOffAmount);
		listOfPaidCorpusFunds.add(pojo);		
	}

	private void putFlatKhataExcessAmountInReceipt(double setOffAmount, List<FinancialProjectMileStonePojo> listOfPaidFlatKhata,
			List<FinPenaltyTaxPojo> taxDetailsList, Long paymentTypeId)  throws Exception {
		FinPenaltyTaxPojo finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,paymentTypeId);
		FinancialProjectMileStonePojo pojo = new FinancialProjectMileStonePojo();
		pojo.setMilestoneName("Excess Amount");

		List<FinBookingFormFlatKhataDtlsPojo> flatKhataChargesDtlsPojos = new ArrayList<>();
		List<FinBokFrmFlatKhataTaxPojo> flatKhataTAXDetailsPojos = new ArrayList<>();
		
		FinBookingFormFlatKhataDtlsPojo bookingFormFlatKhataDtlsPojo = new FinBookingFormFlatKhataDtlsPojo();
		bookingFormFlatKhataDtlsPojo.setDescription("Excess Amount");
		FinBokFrmFlatKhataTaxPojo flatKhataTaxPojo = new FinBokFrmFlatKhataTaxPojo();
		if (finTaxPojo == null) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add flat khata GST percentage..."));
		}

		bookingFormFlatKhataDtlsPojo.setPercentageId(finTaxPojo.getPercentageId());
		bookingFormFlatKhataDtlsPojo.setPercentageValue(finTaxPojo.getPercentageValue());
		
		flatKhataTaxPojo.setPercentageId(finTaxPojo.getPercentageId());
		flatKhataTaxPojo.setPercentageValue(finTaxPojo.getPercentageValue());
		flatKhataTAXDetailsPojos.add(flatKhataTaxPojo);
		flatKhataChargesDtlsPojos.add(bookingFormFlatKhataDtlsPojo);
		bookingFormFlatKhataDtlsPojo.setFlatKhataTAXDetailsPojo(flatKhataTAXDetailsPojos);
		
		double gstAmount = ((finTaxPojo.getPercentageValue()/(finTaxPojo.getPercentageValue()+100))*(setOffAmount));
		
		pojo.setGstAmount(gstAmount);
		pojo.setCgstAmount(gstAmount/cgstDividedBy);
		pojo.setSgstAmount(gstAmount/sgstDividedBy);
		pojo.setSetOffAmount(setOffAmount);
		pojo.setFlatKhataChargesDtlsPojos(flatKhataChargesDtlsPojos);
		listOfPaidFlatKhata.add(pojo);		
	}

	private void putMaintenanceExcessAmountInReceipt(double setOffAmount, List<FinancialProjectMileStonePojo> listOfPaidMaintenanceCost,
			List<FinPenaltyTaxPojo> taxDetailsList, Long paymentTypeId)  throws Exception {
		FinPenaltyTaxPojo finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,paymentTypeId);
		FinancialProjectMileStonePojo pojo = new FinancialProjectMileStonePojo();
		pojo.setMilestoneName("Excess Amount");
		List<FinBookingFormMaintenanceDtlsPojo> maintenanceChargesDtlsPojos = new ArrayList<>();
		List<FinBokFrmMaintenanceTaxPojo> maintenanceTaxPojos = new ArrayList<>();
		FinBookingFormMaintenanceDtlsPojo maintenanceDtlsPojo = new FinBookingFormMaintenanceDtlsPojo();
		FinBokFrmMaintenanceTaxPojo maintenanceTaxPojo = new FinBokFrmMaintenanceTaxPojo();
		maintenanceDtlsPojo.setDescription("Excess Amount");
		
		if (finTaxPojo == null) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add maintenance GST percentage..."));
		}
		maintenanceDtlsPojo.setPercentageId(finTaxPojo.getPercentageId());
		maintenanceDtlsPojo.setPercentageValue(finTaxPojo.getPercentageValue());
		
		maintenanceTaxPojo.setPercentageId(finTaxPojo.getPercentageId());
		maintenanceTaxPojo.setPercentageValue(finTaxPojo.getPercentageValue());
		maintenanceDtlsPojo.setMaintenanceTaxPojos(maintenanceTaxPojos);
		
		maintenanceChargesDtlsPojos.add(maintenanceDtlsPojo);
		
		double gstAmount = ((finTaxPojo.getPercentageValue()/(finTaxPojo.getPercentageValue()+100))*(setOffAmount));
		
		pojo.setGstAmount(gstAmount);
		pojo.setCgstAmount(gstAmount/cgstDividedBy);
		pojo.setSgstAmount(gstAmount/sgstDividedBy);
		pojo.setSetOffAmount(setOffAmount);
		pojo.setMaintenanceChargesDtlsPojos(maintenanceChargesDtlsPojos);
		listOfPaidMaintenanceCost.add(pojo);
	}

	private void putPenaltyExcessAmountInReceipt(double setOffAmount, List<FinancialProjectMileStonePojo> listOfPaidInterestCostList,
			List<FinPenaltyTaxPojo> taxDetailsList, Long paymentTypeId) throws Exception {
		FinPenaltyTaxPojo finTaxPojo = getTaxPercentageDetailsObject(taxDetailsList,paymentTypeId);
		FinancialProjectMileStonePojo pojo = new FinancialProjectMileStonePojo();
		pojo.setMilestoneName("Excess Amount");

		if (finTaxPojo == null) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add interest rates GST percentage..."));
		}
		
		double gstAmount = ((finTaxPojo.getPercentageValue()/(finTaxPojo.getPercentageValue()+100))*(setOffAmount));

		pojo.setGstAmount(gstAmount);
		pojo.setCgstAmount(gstAmount/cgstDividedBy);
		pojo.setSgstAmount(gstAmount/sgstDividedBy);
		pojo.setSetOffAmount(setOffAmount);
		listOfPaidInterestCostList.add(pojo);
	}
	
	private FinPenaltyTaxPojo getTaxPercentageDetailsObject(List<FinPenaltyTaxPojo> taxDetailsList, Long type) {
		for (FinPenaltyTaxPojo finTaxPojo : taxDetailsList) {
			if (type.equals(finTaxPojo.getTaxType())) {
				return finTaxPojo;
			}
		}
		return null;
	}

	private void updateInterestWaiverTrnGstAmount(List<FinancialProjectMileStonePojo> listOfPaidInterestCostList, List<FinancialProjectMileStoneResponse> interestCostResponseList,
			EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		FinancialProjectMileStonePojo mileStonePojo = null;
		FinancialProjectMileStoneResponse mileStoneInfo = null;
		for (int index = 0; index < listOfPaidInterestCostList.size(); index++) {
			mileStonePojo = listOfPaidInterestCostList.get(index);
			mileStonePojo.setMilestoneName("Interest Charges");
			mileStoneInfo = (FinancialProjectMileStoneResponse) financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(mileStonePojo, FinancialProjectMileStoneResponse.class);
			mileStoneInfo.setPaidAmount(mileStonePojo.getSetOffAmount());
			//mileStoneInfo.setDocumentLocation(bookingFormLglCostDtlsPojos.get(0).getDocumentLocation());
			interestCostResponseList.add(mileStoneInfo);
		}
		
		if(Util.isNotEmptyObject(interestCostResponseList)) {
			double sumOfInterestGstAmount = 0d;//updating interest refund gst amount
			for(FinancialProjectMileStoneResponse interestCostResponse : interestCostResponseList){
				sumOfInterestGstAmount += interestCostResponse.getGstAmount();
			}
			//INTEREST_WAIVER set off type 
			FinTransactionSetOffPojo setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfInterestGstAmount,transactionServiceInfo
					, MetadataId.INTEREST_WAIVER, FinTransactionSetOffPojo.class);
			employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);
		}//response1.getInterestCostResponseList()
	}

	private void updateTransactionRefundGSTPaidAmount(EmployeeFinancialTransactionServiceInfo transactionServiceInfo, EmployeeFinancialTransactionResponse response1) {
		//updating refund gst amount all types of payment's
		FinTransactionSetOffPojo setOffPojo =  null;
		if(Util.isNotEmptyObject(response1.getFinancialProjectMileStoneResponse())) {
			double sumOfMilestoneGstAmount = 0d;//updating milestone refund gst amount
			for(FinancialProjectMileStoneResponse milestoneResponse : response1.getFinancialProjectMileStoneResponse()){
				sumOfMilestoneGstAmount += milestoneResponse.getGstAmount();
			}
			setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfMilestoneGstAmount,transactionServiceInfo,MetadataId.FIN_BOOKING_FORM_MILESTONES, FinTransactionSetOffPojo.class);
			employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);
		}
		
		// For Modification Cost Receipt 
		if(Util.isNotEmptyObject(response1.getModificationCostResponseList())) {
			double sumOfModificationGstAmount = 0d;
			for (FinancialProjectMileStoneResponse modificationCostResponse : response1.getModificationCostResponseList()) {
				List<FinBookingFormModiCostDtlsResponse> bookingFormModiCostDtlsResponses = modificationCostResponse.getBookingFormModiCostDtlsResponses();
				double percentageValue = 0d;
				if (Util.isNotEmptyObject(bookingFormModiCostDtlsResponses)) {
					percentageValue = Util.isEmptyObject(bookingFormModiCostDtlsResponses.get(0).getPercentageValue()) ? 0d : Double.valueOf(bookingFormModiCostDtlsResponses.get(0).getPercentageValue());
				}
				double gstAmount = ((percentageValue / (percentageValue + 100)) * (modificationCostResponse.getSetOffAmount()));
				sumOfModificationGstAmount += gstAmount;
			}
			setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfModificationGstAmount,transactionServiceInfo, MetadataId.MODIFICATION_COST, FinTransactionSetOffPojo.class);
			employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);
		}

		// For Legal Cost Receipt
		if(Util.isNotEmptyObject(response1.getLegalCostResponseList())) {
			double sumOfLegalGstAmount = 0d;
			for(FinancialProjectMileStoneResponse legalCostResponse : response1.getLegalCostResponseList()){
				List<FinBookingFormLglCostDtlsResponse> bookingFormLglCostDtlsResponses = legalCostResponse.getBookingFormLglCostDtlsResponses();
				double percentageValue = 0d;
				if(Util.isNotEmptyObject(bookingFormLglCostDtlsResponses)) {
					percentageValue = Util.isEmptyObject(bookingFormLglCostDtlsResponses.get(0).getPercentageValue())?0d:Double.valueOf(bookingFormLglCostDtlsResponses.get(0).getPercentageValue());
				}
				double gstAmount = ((percentageValue/(percentageValue+100))*(legalCostResponse.getSetOffAmount()));
				sumOfLegalGstAmount += gstAmount;
			}
			setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfLegalGstAmount,transactionServiceInfo, MetadataId.LEGAL_COST, FinTransactionSetOffPojo.class);
			employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);
		}
		
		if(Util.isNotEmptyObject(response1.getMaintenanceCostResponseList())) {
			double sumOfMaintenanceGstAmount = 0d;
			double percentageValue = 0d;
			for (FinancialProjectMileStoneResponse maintenanceCost : response1.getMaintenanceCostResponseList()) {
				List<FinBookingFormMaintenanceDtlsPojo> bookingFormMaintenanceDtlsResponses = maintenanceCost.getMaintenanceChargesDtlsResponse();
				
				if(Util.isNotEmptyObject(bookingFormMaintenanceDtlsResponses)) {
					for(FinBokFrmMaintenanceTaxPojo maintenanceTaxInfo : bookingFormMaintenanceDtlsResponses.get(0).getMaintenanceTaxPojos()){
						percentageValue = Util.isEmptyObject(maintenanceTaxInfo.getPercentageValue()) ? 0d : Double.valueOf(maintenanceTaxInfo.getPercentageValue());	
					}
				}
				double gstAmount = ((percentageValue/(percentageValue+100))*(maintenanceCost.getSetOffAmount()));
				sumOfMaintenanceGstAmount += gstAmount;
			}
			setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfMaintenanceGstAmount,transactionServiceInfo, MetadataId.MAINTENANCE_CHARGE, FinTransactionSetOffPojo.class);
			employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);
		}

		if(Util.isNotEmptyObject(response1.getFlatKhataResponseList())) {
			double sumOfFlatKhataGstAmount = 0d;
			double percentageValue = 0d;
			for(FinancialProjectMileStoneResponse flatKhataCost : response1.getFlatKhataResponseList()){
				List<FinBookingFormFlatKhataDtlsPojo> bookingFormFlatKhataDtlsResponses = flatKhataCost.getFlatKhataChargesDtlsResponse();
				
				if(Util.isNotEmptyObject(bookingFormFlatKhataDtlsResponses)) {
					for(FinBokFrmFlatKhataTaxPojo maintenanceTaxInfo : bookingFormFlatKhataDtlsResponses.get(0).getFlatKhataTAXDetailsPojo()){
						percentageValue = Util.isEmptyObject(maintenanceTaxInfo.getPercentageValue()) ? 0d : Double.valueOf(maintenanceTaxInfo.getPercentageValue());	
					}
				}
				double gstAmount = ((percentageValue/(percentageValue+100))*(flatKhataCost.getSetOffAmount()));
				sumOfFlatKhataGstAmount += gstAmount;
			}
			setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfFlatKhataGstAmount,transactionServiceInfo, MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES, FinTransactionSetOffPojo.class);
			employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);
		}
		
		if(Util.isNotEmptyObject(response1.getInterestCostResponseList())) {
			double sumOfInterestGstAmount = 0d;//updating interest refund gst amount
			for(FinancialProjectMileStoneResponse interestCostResponse : response1.getInterestCostResponseList()){
				sumOfInterestGstAmount += interestCostResponse.getGstAmount();//sumOfInterestGstAmount += gstAmount;
			}
			setOffPojo =  financialMapper.copyPropertiesFromInfoBeanToTransactionSetOffPojoBean(sumOfInterestGstAmount,transactionServiceInfo, MetadataId.FIN_PENALTY, FinTransactionSetOffPojo.class);
			employeeFinancialServiceDao.updateTransactionSetOffGSTDetails(setOffPojo);
		}//response1.getInterestCostResponseList()
	}
	
	@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
	@Override
	public void updatePenaltyOldGstAmountRecordsAndAdjustAmount(EmployeeFinancialTransactionServiceInfo serviceInfo) {
		boolean isThisRefundTransaction = false;
		FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
		bookingFormAccountsInfo.setBookingFormId(null);
		bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
		bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.FIN_PENALTY.getId()));
		bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
		bookingFormAccountsInfo.setCondition("UpdateOldPenaltyRecords");
		//here loading all the Milestone Payment Details using customer FlatBookingId
		List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
		List<FinPenaltyStatisticsPojo> penaltyStatisticsPojos = null;
		FinancialProjectMileStonePojo penaltyaccPojo = null;
		FinPenaltyStatisticsPojo paidpenaltyStatisticsPojo = null;
		List<FinPenaltyTaxMappingPojo> taxMappingPojoList = null;
		for (FinBookingFormAccountsPojo bookingFormAccountsPojo : bookingFormAccountsPojoLists) {
			//double payAmount = bookingFormAccountsPojo.getPayAmount();
			double paidAmount = bookingFormAccountsPojo.getPaidAmount();
			double interestWaiverAdjAmount = bookingFormAccountsPojo.getInterestWaiverAdjAmount();
			double setOffAmount = roundOffAmount(paidAmount+interestWaiverAdjAmount);
			if(setOffAmount == 0 || setOffAmount <=0) {
				continue;
			}
			System.out.println("setOffAmount : "+setOffAmount+" getTypeId : "+bookingFormAccountsPojo.getTypeId()+", getType : "+bookingFormAccountsPojo.getType()+", getBookingFormId : "+bookingFormAccountsPojo.getBookingFormId());
			paidpenaltyStatisticsPojo = null;
			penaltyaccPojo = new FinancialProjectMileStonePojo();
			BeanUtils.copyProperties(bookingFormAccountsPojo, penaltyaccPojo);
			penaltyStatisticsPojos = employeeFinancialServiceDao.loadPenaltyStatisticsData(penaltyaccPojo);
			penaltyaccPojo.setPenaltyStatisticsPojos(penaltyStatisticsPojos);
			
			for (FinPenaltyStatisticsPojo penaltyStatisticsPojo : penaltyStatisticsPojos) {
				//isCompleteAmountPaid = false;
				taxMappingPojoList = null;
				paidpenaltyStatisticsPojo = new FinPenaltyStatisticsPojo();
				BeanUtils.copyProperties(penaltyStatisticsPojo, paidpenaltyStatisticsPojo);
				
				employeeFinancialServiceDao.resetPenaltyStasticsPaidAmount(paidpenaltyStatisticsPojo);
				
				taxMappingPojoList = employeeFinancialServiceDao.loadPenaltyTaxMappigData(paidpenaltyStatisticsPojo);

				//if tax on interest has multiple gst then need to use these methods to update old records, first need to delete all the penalty tax mapping records
				//double taxAmount = getGstAmountOnInterestAmount(finPenalityInfo,finPenaltyTaxDetailsList,pojoGstTaxMapping);
				
				FinPenaltyTaxMappingPojo paidtaxMappingPojo = null;
				for (FinPenaltyTaxMappingPojo taxMappingPojo : taxMappingPojoList) {
					paidtaxMappingPojo = new FinPenaltyTaxMappingPojo();
					BeanUtils.copyProperties(taxMappingPojo, paidtaxMappingPojo);
					
					employeeFinancialServiceDao.resetPenaltyTaxPaidAmount(paidtaxMappingPojo);
					
					//paidpenaltyStatisticsPojo.setPenaltyTaxAmount(taxMappingPojo.getAmount());
					//paidpenaltyStatisticsPojo.setStatTotalAmount(roundOffAmount(penaltyStatisticsPojo.getPenaltyAmount()+taxMappingPojo.getAmount()));
					
					paidtaxMappingPojo.setGstStartDate(paidpenaltyStatisticsPojo.getStartDate());
					paidtaxMappingPojo.setGstEndDate(paidpenaltyStatisticsPojo.getEndDate());
					paidtaxMappingPojo.setDaysDifference(paidpenaltyStatisticsPojo.getDaysDifference());
					paidtaxMappingPojo.setGstCalculationOnAmount(roundOffAmount(penaltyStatisticsPojo.getPenaltyAmount()));
					paidtaxMappingPojo.setTotalInterestAmount(roundOffAmount(penaltyStatisticsPojo.getPenaltyAmount()+taxMappingPojo.getAmount()));
					
					employeeFinancialServiceDao.updateOldPenaltyTaxTotalAmt(paidtaxMappingPojo);
					/** Statistics data updated using the query's, so not calling updateOldPenaltyStasticsTotalAmt
					  update FIN_PENALTY_STATISTICS FPS  set TAX_AMOUNT = 
						(select sum(FPTM.AMOUNT) from FIN_PENALTY_TAX_MAPPING FPTM 
						WHERE FPS.FIN_PNT_STAT_ID = FPTM.FIN_PNT_STAT_ID);
						
						update FIN_PENALTY_STATISTICS FPS  set STAT_TOTAL_AMOUNT = TAX_AMOUNT+AMOUNT;

					 */
					//employeeFinancialServiceDao.updateOldPenaltyStasticsTotalAmt(paidpenaltyStatisticsPojo);
				}
			}
			
			penaltyaccPojo.setSetOffAmount(setOffAmount);
			penaltyGstAmountAndAdjustAmount(penaltyaccPojo,isThisRefundTransaction);
		}
	}
	
	public void penaltyGstAmountAndAdjustAmount(FinancialProjectMileStonePojo penaltyaccPojo, boolean isThisRefundTransaction) {
		List<FinPenaltyStatisticsPojo> penaltyStatisticsPojos = penaltyaccPojo.getPenaltyStatisticsPojos();
		double setOffAmount = penaltyaccPojo.getSetOffAmount();
		double settleAmount = 0.0;
		/*double basicPenaltyAmount = 0.0;
		double taxPenaltyAmount = 0.0;*/
		double totalPenaltyAmount = 0.0;
		double sumOfAdjustedGSTAmount = 0.0;
		/*Timestamp startDate = null;
		Timestamp endDate = null;
		Integer daysDiff = null;*/
		//boolean isCompleteAmountPaid = false;
		List<FinPenaltyTaxMappingPojo> taxMappingPojoList = null;
		FinPenaltyStatisticsPojo paidpenaltyStatisticsPojo = null;		
		int sizeOfList = penaltyStatisticsPojos.size(); 
		
		/*for (int index = 0,reverseIndex = sizeOfList-1; index < sizeOfList; index++,reverseIndex--) {
			if(isThisRefundTransaction) {
				penaltyStatisticsPojo = penaltyStatisticsPojos.get(reverseIndex);
			} else {
				penaltyStatisticsPojo = penaltyStatisticsPojos.get(index);	
			}
		}*/

		if(isThisRefundTransaction) {// if this is refund transaction request
			FinPenaltyStatisticsPojo penaltyStatisticsPojo = null;
			//if this is refund transaction then iteresting objects in reverse
			for (int index = 0,reverseIndex = sizeOfList-1; index < sizeOfList; index++,reverseIndex--) {
				if(isThisRefundTransaction) {
					penaltyStatisticsPojo = penaltyStatisticsPojos.get(reverseIndex);
				} else {
					penaltyStatisticsPojo = penaltyStatisticsPojos.get(index);	
				}
				paidpenaltyStatisticsPojo = new FinPenaltyStatisticsPojo();
				BeanUtils.copyProperties(penaltyStatisticsPojo, paidpenaltyStatisticsPojo);
				
				double accPaidAmount = Util.isEmptyObject(penaltyStatisticsPojo.getPaidPenaltyAmount()) ? 0d : penaltyStatisticsPojo.getPaidPenaltyAmount();
				double amountToSetOff = accPaidAmount;
				//Long paymentStatusId = accPojo.getPaymentStatus();//
				if (setOffAmount > 0) {
					if (amountToSetOff > 0) {

						if (setOffAmount >= amountToSetOff) {
							 setOffAmount = setOffAmount - amountToSetOff;
							 settleAmount = amountToSetOff;
						} else {
							settleAmount = setOffAmount;
							setOffAmount = setOffAmount - amountToSetOff;
						}
						
						taxMappingPojoList = employeeFinancialServiceDao.loadPenaltyTaxMappigData(paidpenaltyStatisticsPojo);
						
						paidpenaltyStatisticsPojo.setPaidPenaltyAmount(settleAmount);
						//calculating tax amount on paid amount
						double taxAdjusted = adjustPenaltyGstAmountAndAdjustAmount(paidpenaltyStatisticsPojo,taxMappingPojoList,isThisRefundTransaction);
						paidpenaltyStatisticsPojo.setPaidPenaltyTaxAmount(taxAdjusted);
						sumOfAdjustedGSTAmount +=taxAdjusted;
						employeeFinancialServiceDao.decreasePenaltyStasticsPaidAmount(paidpenaltyStatisticsPojo);

				
					}//amountToSetOff
				}//Set off Amount condition				
			}
		} else {
			for (FinPenaltyStatisticsPojo penaltyStatisticsPojo : penaltyStatisticsPojos) {
				//isCompleteAmountPaid = false;
				paidpenaltyStatisticsPojo = new FinPenaltyStatisticsPojo();
				//paidpenaltyStatisticsPojo.setFinPenaltyStatisticsId(penaltyStatisticsPojo.getFinPenaltyStatisticsId());
				BeanUtils.copyProperties(penaltyStatisticsPojo, paidpenaltyStatisticsPojo);
				//basicPenaltyAmount = penaltyStatisticsPojo.getPenaltyAmount();
				//taxPenaltyAmount =  penaltyStatisticsPojo.getPenaltyTaxAmount();
				totalPenaltyAmount =  penaltyStatisticsPojo.getStatTotalAmount();//Amount including Gst
				//totalPenaltyAmount = penaltyStatisticsPojo.getPenaltyAmount();//amount exclusing gst
				
				//taxPenaltyAmount = penaltyStatisticsPojo.getPenaltyTaxAmount();
				
				double accPayAmount = totalPenaltyAmount;
				double accPaidAmount = penaltyStatisticsPojo.getPaidPenaltyAmount();//this paid amount is including GST
				double amountToSetOff = accPayAmount - accPaidAmount;
				System.out.println("accPayAmount : "+accPayAmount+" accPaidAmount : "+accPaidAmount);
				amountToSetOff = roundOffAmount(amountToSetOff);
				
				if (setOffAmount > 0) {
					if (amountToSetOff > 0) {
						if (setOffAmount >= amountToSetOff) {
							System.out.println("Status.PAID.getStatus() "+Status.PAID.getStatus());
						} else {
							System.out.println("Status.INPROGRESS.getStatus() "+Status.INPROGRESS.getStatus());
						}
						if (amountToSetOff > setOffAmount) {
							amountToSetOff = setOffAmount;
							settleAmount = amountToSetOff;
							setOffAmount = setOffAmount - amountToSetOff;
							System.out.println("Status.INPROGRESS.getStatus() "+Status.INPROGRESS.getStatus()); 
							//isCompleteAmountPaid = false;
						} else {
							System.out.println("Status.PAID.getStatus() "+Status.PAID.getStatus()); 
							//isCompleteAmountPaid = true;
							settleAmount = amountToSetOff;
							setOffAmount = setOffAmount - amountToSetOff;
						}
						
						if (settleAmount != amountToSetOff) {
							log.info("Amount not matching in ");
							throw new RuntimeException("Amount not matching in Interest Gst");
						}
						
						taxMappingPojoList = employeeFinancialServiceDao.loadPenaltyTaxMappigData(paidpenaltyStatisticsPojo);
						
						paidpenaltyStatisticsPojo.setPaidPenaltyAmount(settleAmount);
						//calculating tax amount on paid amount
						double taxAdjusted = adjustPenaltyGstAmountAndAdjustAmount(paidpenaltyStatisticsPojo,taxMappingPojoList,isThisRefundTransaction);
						paidpenaltyStatisticsPojo.setPaidPenaltyTaxAmount(taxAdjusted);
						sumOfAdjustedGSTAmount +=taxAdjusted;
						employeeFinancialServiceDao.updatePenaltyStasticsPaidAmount(paidpenaltyStatisticsPojo);
						
					}
				}//setOffAmount
				
			}//For Loop
		}
		sumOfAdjustedGSTAmount = roundOffAmount(sumOfAdjustedGSTAmount);
		System.out.println(penaltyaccPojo.getGstAmount()+" "+penaltyaccPojo.getCgstAmount()+" "+penaltyaccPojo.getSgstAmount());
		penaltyaccPojo.setGstAmount(sumOfAdjustedGSTAmount);
		penaltyaccPojo.setCgstAmount(sumOfAdjustedGSTAmount/cgstDividedBy);
		penaltyaccPojo.setSgstAmount(sumOfAdjustedGSTAmount/sgstDividedBy);
		System.out.println(penaltyaccPojo.getGstAmount()+" "+penaltyaccPojo.getCgstAmount()+" "+penaltyaccPojo.getSgstAmount());
	}

	@SuppressWarnings("unused")
	private double adjustPenaltyGstAmountAndAdjustAmount(FinPenaltyStatisticsPojo paidpenaltyStatisticsPojo, List<FinPenaltyTaxMappingPojo> taxMappingPojoList,
			boolean isThisRefundTransaction) {
		double taxAdjusted = 0.0;
		double settleAmount = 0.0;
		double setOffAmount = 0.0;
		setOffAmount = paidpenaltyStatisticsPojo.getPaidPenaltyAmount();
		double taxAmount = 0.0;
		double gstAmount = 0.0;
		double finPenaltyTaxPercentage = 0.0;

		int sizeOfList = taxMappingPojoList.size(); 

		/*for (int index = 0,reverseIndex = sizeOfList-1; index < sizeOfList; index++,reverseIndex--) {
			if(isThisRefundTransaction) {
				penaltyStatisticsPojo = penaltyStatisticsPojos.get(reverseIndex);
			} else {
				penaltyStatisticsPojo = penaltyStatisticsPojos.get(index);	
			}
		}*/

		if(isThisRefundTransaction) {// if this is refund transaction request
			FinPenaltyTaxMappingPojo taxMappingPojo = null;
			FinPenaltyTaxMappingPojo paidtaxMappingPojo = null;
			//if this is refund transaction then iteresting objects in reverse
			for (int index = 0,reverseIndex = sizeOfList-1; index < sizeOfList; index++,reverseIndex--) {
				if(isThisRefundTransaction) {
					taxMappingPojo = taxMappingPojoList.get(reverseIndex);
				} else {
					taxMappingPojo = taxMappingPojoList.get(index);	
				}

				paidtaxMappingPojo = new FinPenaltyTaxMappingPojo();
				BeanUtils.copyProperties(taxMappingPojo, paidtaxMappingPojo);
				finPenaltyTaxPercentage = taxMappingPojo.getGstInterestPercentage();

				double accPaidAmount = Util.isEmptyObject(taxMappingPojo.getPaidTotalInterestAmount()) ? 0d : taxMappingPojo.getPaidTotalInterestAmount();
				double amountToSetOff = accPaidAmount;

				if (setOffAmount > 0) {
					if (amountToSetOff > 0) {
						if (setOffAmount >= amountToSetOff) {
							 setOffAmount = setOffAmount - amountToSetOff;
							 settleAmount = amountToSetOff;
						} else {
							settleAmount = setOffAmount;
							setOffAmount = setOffAmount - amountToSetOff;
						}
						
						gstAmount = ((finPenaltyTaxPercentage/(finPenaltyTaxPercentage+100))*(settleAmount));//calculating gst amount on settle amount
						taxAdjusted +=gstAmount;
						
						gstAmount = roundOffAmount(gstAmount);
						paidtaxMappingPojo.setPaidTotalInterestAmount(settleAmount);
						paidtaxMappingPojo.setTaxPaidPmount(gstAmount);
						
						employeeFinancialServiceDao.decreasePenaltyTaxPaidAmount(paidtaxMappingPojo);						
						
					}//amountToSetOff
				}//Set off Amount condition				
			}
		} else {
			FinPenaltyTaxMappingPojo paidtaxMappingPojo = null;
			for (FinPenaltyTaxMappingPojo taxMappingPojo : taxMappingPojoList) {
				paidtaxMappingPojo = new FinPenaltyTaxMappingPojo();
				BeanUtils.copyProperties(taxMappingPojo, paidtaxMappingPojo);
				finPenaltyTaxPercentage = taxMappingPojo.getGstInterestPercentage();
				double taxCalcOnAmount = taxMappingPojo.getTotalInterestAmount();// this amount is equal to taxMappingPojo.getGstCalculationOnAmount()+taxMappingPojo.getAmount();
				
				double accPayAmount = taxCalcOnAmount;
				double accPaidAmount = taxMappingPojo.getPaidTotalInterestAmount();
				double amountToSetOff = accPayAmount - accPaidAmount;
				amountToSetOff = roundOffAmount(amountToSetOff);
				System.out.println("accPayAmount : "+accPayAmount+" accPaidAmount : "+accPaidAmount);

				if (setOffAmount > 0) {
					if (amountToSetOff > 0) {
						
						if (amountToSetOff > setOffAmount) {
							amountToSetOff = setOffAmount;
							settleAmount = amountToSetOff;
							setOffAmount = setOffAmount - amountToSetOff;
						} else {
							settleAmount = amountToSetOff;
							setOffAmount = setOffAmount - amountToSetOff;
						}
						if (settleAmount != amountToSetOff) {
							log.info("Amount not matching in Interest GST");
							throw new RuntimeException("Amount not matching");
						}
						
						gstAmount = ((finPenaltyTaxPercentage/(finPenaltyTaxPercentage+100))*(settleAmount));//calculating gst amount on settle amount
						taxAdjusted +=gstAmount;
						
						gstAmount = roundOffAmount(gstAmount);
						paidtaxMappingPojo.setPaidTotalInterestAmount(settleAmount);
						paidtaxMappingPojo.setTaxPaidPmount(gstAmount);
						
						employeeFinancialServiceDao.updatePenaltyTaxPaidAmount(paidtaxMappingPojo);
					}//amountToSetOff
				}//setOffAmount
			}//For Loop
		}
		
		//taxAdjusted = roundOffAmount(taxAdjusted);
		return taxAdjusted;
	}

	/**
	 * if milestone is not generated, and receipt entry has done then this method will generate the milestone record
	 * , but the milestone status will be explicit generated EXPLICIT_GENERATED_RECORD record(means system generated record)
	 * and demand note is generated then this mile stone status will change from EXPLICIT_GENERATED_RECORD to active, can check in generateDemandNoteService
	 */
	private void putExcessAmountInReceipt(double setOffAmount, Long typeId, EmployeeFinancialTransactionServiceInfo transactionServiceInfo,
			CustomerPropertyDetailsInfo customerPropertyDetailsInfo, List<FinancialProjectMileStonePojo> listOfNonPaidMileStoneDetailsList
			, Map<String, Double> setOffAmountListObject, String requestFrom) throws Exception {
		setOffAmount = setOffAmountListObject.get("setOffAmount");
		List<FinancialProjectMileStonePojo> nextMileStonePojoList = null;
		FinancialProjectMileStonePojo objectDetailsForExcessAmount = new FinancialProjectMileStonePojo(); 
		List<Long> holdProjectMilestoneIds = new ArrayList<>();
		FinancialProjectMileStonePojo accPojo = new FinancialProjectMileStonePojo();
		accPojo.setMilestoneName("Excess Amount");
		accPojo.setSetOffAmount(setOffAmount);
		accPojo.setType(typeId);
		
		//double totalAmount =  transactionServiceInfo.getFlatPayableAmount();
		
		//double basicMileStoneAmount = 0d;
		EmployeeFinancialServiceInfo employeeFinancialInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialInfo.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
		employeeFinancialInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
		employeeFinancialInfo.setSiteId(transactionServiceInfo.getSiteId());
		List<FinancialProjectMileStonePojo> generatedMileStonePojoList = employeeFinancialServiceDao.getGeneratedMilestoneDetailsOfFlat(employeeFinancialInfo,FinEnum.LOAD_BY_MILESTONE.getId());
		if(!generatedMileStonePojoList.isEmpty()) {
			for (int index1 = 0; index1 < generatedMileStonePojoList.size(); index1++) {
				FinancialProjectMileStonePojo object = generatedMileStonePojoList.get(index1);
					//not required Status.EXPLICIT_GENERATED_RECORD.getStatus()
					if(object.getMsStatusId()!=null && object.getMsStatusId().equals(Status.ACTIVE.getStatus())) {
						objectDetailsForExcessAmount = object;
					}
					if(object.getMsStatusId()!=null && (object.getMsStatusId().equals(Status.ACTIVE.getStatus()) || object.getMsStatusId().equals(Status.EXPLICIT_GENERATED_RECORD.getStatus()) )) {
						 if(holdProjectMilestoneIds.contains(object.getProjectMilestoneId()) || object.getProjectMilestoneId()==null) {
							 log.info("***** Control inside the EmployeeFinancialServiceImpl.putExcessAmountInReceipt()1 *****Flat No : "+customerPropertyDetailsInfo.getFlatNo());
							 throw new EmployeeFinancialServiceException("Duplicate milestone details found for Flat No : "+customerPropertyDetailsInfo.getFlatNo());
						 }
						 holdProjectMilestoneIds.add(object.getProjectMilestoneId());	
					 }
				 }
			
			nextMileStonePojoList = employeeFinancialServiceDao.getNextMilestoneDetails(generatedMileStonePojoList.get(generatedMileStonePojoList.size()-1));
		}else {//if milestone is not generated
			employeeFinancialInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
			FinancialProjectMileStoneInfo financialProjectMileStoneInfo = new FinancialProjectMileStoneInfo();
			financialProjectMileStoneInfo.setMileStoneNo(1l);
			employeeFinancialInfo.setSiteId(transactionServiceInfo.getSiteId());
			employeeFinancialInfo.setFinancialProjectMileStoneRequests(Arrays.asList(financialProjectMileStoneInfo));
			employeeFinancialInfo.setCondition(FinEnum.LOAD_BY_MILESTONE.getName());
			employeeFinancialInfo.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
			//loading all the milestone
			List<FinancialProjectMileStonePojo>  listOfFinancialServicePojo = employeeFinancialServiceDao.getMilestoneDetails(employeeFinancialInfo);
			if(Util.isEmptyObject(listOfFinancialServicePojo) && generatedMileStonePojoList.isEmpty()) {
				 log.info("Milestone master details not found, Please check milestone data."+customerPropertyDetailsInfo.getFlatNo());
				 throw new EmployeeFinancialServiceException("Milestone master details not found, Please check master data.");	
			}
			if(Util.isNotEmptyObject(listOfFinancialServicePojo)) {
				//taking last milestone object
				FinancialProjectMileStonePojo pojo1 = listOfFinancialServicePojo.get(listOfFinancialServicePojo.size()-1);
				pojo1.setMileStoneNo(0l);
				nextMileStonePojoList = employeeFinancialServiceDao.getNextMilestoneDetails(pojo1);
			}
		}
			if(Util.isNotEmptyObject(nextMileStonePojoList)) {
				//boolean isThisUploadedData = transactionServiceInfo.isThisUplaodedData();
				for (int index = 0; index < nextMileStonePojoList.size(); index++) {
					FinancialProjectMileStonePojo mileStonePojo = nextMileStonePojoList.get(index);
					if(Util.isEmptyObject(objectDetailsForExcessAmount)) {
						//objectDetailsForExcessAmount this object used for, if milestone has excess amount
						objectDetailsForExcessAmount = mileStonePojo;
					}
					 accPojo = mileStonePojo;
					 accPojo.setMilestoneName(mileStonePojo.getMilestoneName());
					 accPojo.setMileStoneNo(mileStonePojo.getMileStoneNo());
					 if (setOffAmount > 0) { //user entered amount in front end for Payment set off
						 FinancialProjectMileStoneInfo financialProjectMileStoneInfo = (FinancialProjectMileStoneInfo) financialMapper.copyPropertiesFromInfoBeanToInfoBean(mileStonePojo, FinancialProjectMileStoneInfo.class);
						 CustomerPropertyDetailsInfo info = (CustomerPropertyDetailsInfo) customerPropertyDetailsInfo.clone();
						 info.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
						 info.setStatusId(Status.ACTIVE.getStatus());
						 
						 if(Util.isEmptyObject(financialProjectMileStoneInfo.getMilestoneDate()) && Util.isNotEmptyObject(generatedMileStonePojoList)) {
							 //if the current milestone don't have milestone date, then taking previous milestone date
							 financialProjectMileStoneInfo.setMilestoneDate(generatedMileStonePojoList.get(generatedMileStonePojoList.size()-1).getMilestoneDate());
							 //using milestone date we are fetching customer scheme details
						 }
						 
						 if(Util.isEmptyObject(financialProjectMileStoneInfo.getMilestoneDate())) {
							 //if still milestone date is empty, then booking date passing as milestone date
							 financialProjectMileStoneInfo.setMilestoneDate(info.getBookingDate());
						 }
						 accPojo.setMilestoneDate(financialProjectMileStoneInfo.getMilestoneDate());
						 accPojo.setIsThisRecordExistsInDB("NotExists");
						 financialProjectMileStoneInfo.setThisExplicitGeneratedRecord(true);
						 //calculating milestone amount
						 getBasicAmountAndTaxAmountForEmployeeRaisedMilestone(financialProjectMileStoneInfo,info);
						 
						 //setting scheme name in customer info, for generating demand note formats for different schemes
						 customerPropertyDetailsInfo.setFinSchemeName(info.getFinSchemeName());
						 customerPropertyDetailsInfo.setFinSchemeId(info.getFinSchemeId());
						 customerPropertyDetailsInfo.setFinSchemeType(info.getFinSchemeType());
						 
						 double amountToSetOff = financialProjectMileStoneInfo.getMileStoneTotalAmount();//from these method amount calculated getBasicAmountAndTaxAmountForEmployeeRaisedMilestone() 
						 double settleAmount = 0d;
						 FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
						if (amountToSetOff > 0) {

							/*if (setOffAmount >= amountToSetOff) {accPojo.setPaymentStatus(Status.PAID.getStatus());bookingFormAccountsInfo.setPaymentStatus(Status.PAID.getStatus());
							} else {bookingFormAccountsInfo.setPaymentStatus(Status.INPROGRESS.getStatus());accPojo.setPaymentStatus(Status.INPROGRESS.getStatus());
							}*/

							bookingFormAccountsInfo.setPaymentStatus(Status.INPROGRESS.getStatus());
							accPojo.setPaymentStatus(Status.INPROGRESS.getStatus());
							//amountToSetOff = 5,00,000 and setOffAmount = 10,00,000
							if (amountToSetOff > setOffAmount) {
								amountToSetOff = setOffAmount;
								settleAmount = amountToSetOff;//complete amount adjusted for milestone
								setOffAmount = setOffAmount - amountToSetOff;
							} else {
								settleAmount = amountToSetOff;//complete amount adjusted for milestone
								setOffAmount = setOffAmount - amountToSetOff;
							}
							accPojo.setBokFrmDemNteSchTaxMapInfos( financialProjectMileStoneInfo.getBokFrmDemNteSchTaxMapInfos());

							accPojo.setSetOffAmount(settleAmount);
							accPojo.setType(typeId);
							
							FinBookingFormMilestonesPojo bookingMileStonePojo = (FinBookingFormMilestonesPojo) 
									financialMapper.copyPropertiesToFinBookingFormMileStonePojo(financialProjectMileStoneInfo, customerPropertyDetailsInfo, FinBookingFormMilestonesPojo.class);
							long finBookingFormMilestonesId = employeeFinancialServiceDao.insertDataIntoFinBookingFormMilestones(bookingMileStonePojo);
							financialProjectMileStoneInfo.setFinBookingFormMilestonesId(finBookingFormMilestonesId);

							financialProjectMileStoneInfo.setFinBookingFormMilestonesId(finBookingFormMilestonesId);
							
							/*FinBookingFormMilestoneTaxPojo bookingFormMilestoneTaxPojo = (FinBookingFormMilestoneTaxPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(financialProjectMileStoneInfo, FinBookingFormMilestoneTaxPojo.class);
							Long bookingFormMileStoneTaxId = employeeFinancialServiceDao.saveDataIntoBookingFormMilestoneTax(bookingFormMilestoneTaxPojo);
							financialProjectMileStoneInfo.setFinBookingFormMileStoneTaxId(bookingFormMileStoneTaxId);

							List<FinBookingFormMstSchTaxMapInfo> bokFrmDemNteSchTaxMapInfos = financialProjectMileStoneInfo.getBokFrmDemNteSchTaxMapInfos();

							for (FinBookingFormMstSchTaxMapInfo finBokFrmDemNteSchTaxMapInfo : bokFrmDemNteSchTaxMapInfos) {
								finBokFrmDemNteSchTaxMapInfo.setFinBookingFormMileStoneTaxId(bookingFormMileStoneTaxId);
								FinBokFrmDemNteSchTaxMapPojo finBokFrmDemNteSchTaxMapPojo = financialMapper.finBokFrmDemNteIdAndfinSchTaxMapIdToFinBokFrmDemNteSchTaxMapPojo(finBokFrmDemNteSchTaxMapInfo);
								Long finBokFrmDemNteSchTaxMapId = employeeFinancialServiceDao.saveFinBokFrmDemNteSchTaxMap(finBokFrmDemNteSchTaxMapPojo);
								finBokFrmDemNteSchTaxMapInfo.setFinBokFrmMstSchTaxMapId(finBokFrmDemNteSchTaxMapId);
							}*/							
							
							FinBookingFormAccountsPojo finBookingFormAccountsPojo = 
									financialMapper.copyPropertiesToFinBookingFormAccountsPojo1(financialProjectMileStoneInfo,accPojo,transactionServiceInfo,
											new FinPenalityInfo(), FinBookingFormAccountsPojo.class, "MileStoneBasicAmt",requestFrom);
							finBookingFormAccountsPojo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
							long bookingFromAccountId = employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
							accPojo.setFinBookingFormAccountsId(bookingFromAccountId);
							
						 	bookingFormAccountsInfo.setPaidAmount(amountToSetOff);
							bookingFormAccountsInfo.setActualPaidAmount(amountToSetOff);
							bookingFormAccountsInfo.setPaidDate(transactionServiceInfo.getTransactionReceiveDate());
							bookingFormAccountsInfo.setFinBookingFormAccountsId(accPojo.getFinBookingFormAccountsId());
							bookingFormAccountsInfo.setFinBookingFormReceiptsId(transactionServiceInfo.getBookingFormReceiptId());
							bookingFormAccountsInfo.setCreatedBy(transactionServiceInfo.getEmployeeId());
							bookingFormAccountsInfo.setModifiedBy(transactionServiceInfo.getEmployeeId());
							bookingFormAccountsInfo.setType(typeId);
							bookingFormAccountsInfo.setBookingFormId(transactionServiceInfo.getBookingFormId());
						    bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
							employeeFinancialServiceDao.saveFinBookingFormAccountsStatement((FinBookingFormAccountsStatementPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfo,FinBookingFormAccountsStatementPojo.class));
							bookingFormAccountsInfo.setType(MetadataId.PRINCIPAL_AMOUNT.getId());					
							//update booking form account details
							employeeFinancialServiceDao.updatePaidAmountBookingFormAccountSummary((FinBookingFormAccountSummaryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfo,FinBookingFormAccountSummaryPojo.class));
	
							listOfNonPaidMileStoneDetailsList.add(accPojo);	
						}
					}else {
						break;
					}
					 //nextMileStonePojoList this object is holding all the milestone of project
					 if (setOffAmount > 0 && index == nextMileStonePojoList.size()-1) {
						 //if all the milestones amount is paid amount still setOffAmount amount is greater than zero means , it is excess amount
						 accPojo = new FinancialProjectMileStonePojo();
						 accPojo.setSetOffAmount(setOffAmount);
						 accPojo.setMilestoneName("Excess Amount");
						 accPojo.setMileStoneNo(0l);
							
						 accPojo.setMilestoneDate(objectDetailsForExcessAmount.getMilestoneDate()==null?objectDetailsForExcessAmount.getMilestoneDemandNoteDate():objectDetailsForExcessAmount.getMilestoneDate());
						 accPojo.setMileStonePercentage(objectDetailsForExcessAmount.getMileStonePercentage());
						 
						 //if this is excess amount taking last milestone date for loading GST percentage for GST calculation in receipt 
						 /*if(Util.isNotEmptyObject(generatedMileStonePojoList)) {
							 for (int index1 = 0; index1 < generatedMileStonePojoList.size(); index1++) {
								 FinancialProjectMileStonePojo object = generatedMileStonePojoList.get(index1);
								 if(object.getMsStatusId()!=null && !object.getMsStatusId().equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
									 accPojo.setMilestoneDate(object.getMilestoneDate());
									 accPojo.setMileStonePercentage(object.getMileStonePercentage());
								 }
							 }
						  }*/
						 
						  if(Util.isEmptyObject(accPojo.getMilestoneDate())) {
							 accPojo.setMilestoneDate(customerPropertyDetailsInfo.getBookingDate());
						  }
						 listOfNonPaidMileStoneDetailsList.add(accPojo);
					 }
				}
			} else {
				accPojo = new FinancialProjectMileStonePojo();
				accPojo.setSetOffAmount(setOffAmount);
				accPojo.setMilestoneName("Excess Amount");
				accPojo.setMileStoneNo(0l);
				
				accPojo.setMilestoneDate(objectDetailsForExcessAmount.getMilestoneDate()==null?objectDetailsForExcessAmount.getMilestoneDemandNoteDate():objectDetailsForExcessAmount.getMilestoneDate());
				accPojo.setMileStonePercentage(objectDetailsForExcessAmount.getMileStonePercentage());
				
				 //if this is excess amount taking last milestone date for loading GST percentage for GST calculation in receipt
				/* if(Util.isNotEmptyObject(generatedMileStonePojoList)) {
					 for (int index1 = 0; index1 < generatedMileStonePojoList.size(); index1++) {
						 FinancialProjectMileStonePojo object = generatedMileStonePojoList.get(index1);
						 if(object.getMsStatusId()!=null && !object.getMsStatusId().equals(Status.EXPLICIT_GENERATED_RECORD.getStatus())) {
							 accPojo.setMilestoneDate(object.getMilestoneDate());
							 accPojo.setMileStonePercentage(object.getMileStonePercentage());
						 }
					 }
				  }*/
				 
				if(Util.isEmptyObject(accPojo.getMilestoneDate())) {
				 accPojo.setMilestoneDate(customerPropertyDetailsInfo.getBookingDate());
				}
				listOfNonPaidMileStoneDetailsList.add(accPojo);
			}
		setOffAmountListObject.put("setOffAmount",setOffAmount);
	}

	//@SuppressWarnings("unused")
	private Map<String, Object> getGSTAmount(CustomerPropertyDetailsInfo customerPropertyDetailsInfo, FinancialProjectMileStonePojo mileStonePojo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getGSTAmount()");
		
/*		In order to add GST to base amount,

		Add GST
		GST Amount = ( Original Cost * GST% ) / 100
		Net Price = Original Cost + GST Amount

		In order to remove GST from base amount,

		Remove GST
		GST Amount = Original Cost  (Original Cost * (100 / (100 + GST% ) ) )
		Net Price = Original Cost  GST Amount*/
		
		double sumOfCGST = 0d;
		double sumOfSGST = 0d;
		double sumOfPrincipalGstAmount = 0d;
		//double cgstAmount = 0;
 		//double sgstAmount = 0;
 		double gstPercentage = 0;
 		double otherThanGstAmount = 0;
 		List<FinBookingFormMstSchTaxMapInfo> listOfSchemeDetails = mileStonePojo.getBokFrmDemNteSchTaxMapInfos();
 		
 		if((Util.isEmptyObject(listOfSchemeDetails) && mileStonePojo.getIsThisRecordExistsInDB()==null && mileStonePojo.getTypeId()!=null) 
 				|| (Util.isEmptyObject(listOfSchemeDetails) && mileStonePojo.getMilestoneName()!=null && mileStonePojo.getMilestoneName().equals("Excess Amount"))
 				) {
 			FinancialProjectMileStoneInfo financialProjectMileStoneInfo = new FinancialProjectMileStoneInfo();//this condition will execute rearly
 			//if this condition executes means, user did not created this milestone from front end, this created from back end bcoz user paid some extra amount  
			try { 
				financialProjectMileStoneInfo = (FinancialProjectMileStoneInfo) financialMapper.copyPropertiesFromInfoBeanToInfoBean(mileStonePojo, FinancialProjectMileStoneInfo.class);
			} catch(Exception e) { 
				financialProjectMileStoneInfo = new FinancialProjectMileStoneInfo();
				e.printStackTrace();
			}
 			 BeanUtils.copyProperties(mileStonePojo, financialProjectMileStoneInfo);
			 CustomerPropertyDetailsInfo info = (CustomerPropertyDetailsInfo) customerPropertyDetailsInfo.clone();
			 info.setType(MetadataId.PRINCIPAL_AMOUNT.getId());
			 info.setStatusId(Status.ACTIVE.getStatus());
			 info.setCondition("");
			 if(Util.isEmptyObject(financialProjectMileStoneInfo.getMilestoneDate())) {
				 financialProjectMileStoneInfo.setMilestoneDate(info.getBookingDate());
			 }
			getBasicAmountAndTaxAmountForEmployeeRaisedMilestone(financialProjectMileStoneInfo,info);
			listOfSchemeDetails= financialProjectMileStoneInfo.getBokFrmDemNteSchTaxMapInfos();
			customerPropertyDetailsInfo.setFinSchemeName(info.getFinSchemeName());
			customerPropertyDetailsInfo.setFinSchemeId(info.getFinSchemeId());
			customerPropertyDetailsInfo.setFinSchemeType(info.getFinSchemeType());
 		}
 		
 		if(Util.isNotEmptyObject(listOfSchemeDetails)) {
 			for (FinBookingFormMstSchTaxMapInfo bokFrmDemNteSchTaxMapInfo : listOfSchemeDetails) {
 				if(Util.isNotEmptyObject(bokFrmDemNteSchTaxMapInfo.getTaxTypeId()) && bokFrmDemNteSchTaxMapInfo.getTaxTypeId().equals(MetadataId.GST.getId())) {
 					//cgstAmount = bokFrmDemNteSchTaxMapInfo.getBasicAmount()/2;
 					//sgstAmount = bokFrmDemNteSchTaxMapInfo.getBasicAmount()/2;
 					gstPercentage = bokFrmDemNteSchTaxMapInfo.getPercentageValue();
 				} else {
 					otherThanGstAmount = bokFrmDemNteSchTaxMapInfo.getBasicAmount();
 				}
			}
 		}
 		
		Map<String, Object> mileStoneGstDetails = new HashMap<>();
		//@SuppressWarnings("unused")
		/*List<FinSchemeTaxMappingPojo> schemeTaxDetails = employeeFinancialServiceDao.getFlatBookDetailsSchemeTaxDetails(customerPropertyDetailsInfo,null);
		if(Util.isNotEmptyObject(schemeTaxDetails)) {
			 //setting scheme name in customer info, for generating demand note formats for different schemes
			customerPropertyDetailsInfo.setFinSchemeName(schemeTaxDetails.get(0).getFinSchemeName());
			customerPropertyDetailsInfo.setFinSchemeId(schemeTaxDetails.get(0).getFinSchemeId());
			customerPropertyDetailsInfo.setFinSchemeType(schemeTaxDetails.get(0).getFinSchemeType());
		}*/
		//double sumOfMileStoneTaxAmt =0d;
		if(Util.isNotEmptyObject(listOfSchemeDetails)) {
			for (FinBookingFormMstSchTaxMapInfo schemeDetails : listOfSchemeDetails) {

				if(Util.isNotEmptyObject(schemeDetails.getTaxTypeId()) && schemeDetails.getTaxTypeId().equals(MetadataId.GST.getId())) {
					double gstAmount = ((schemeDetails.getPercentageValue()/(schemeDetails.getPercentageValue()+100))*(mileStonePojo.getSetOffAmount()-otherThanGstAmount));
					//here sumOfMileStoneTaxAmt this value should be other than GST amount
					gstAmount = roundOffAmount(gstAmount);
					mileStonePojo.setSgstAmount(gstAmount/2);
					mileStonePojo.setCgstAmount(gstAmount/2);
					mileStonePojo.setGstAmount(gstAmount);
					mileStonePojo.setPaidTaxAmount(gstAmount);
					sumOfCGST += gstAmount/2;
					sumOfSGST += gstAmount/2;
					sumOfPrincipalGstAmount +=gstAmount;
				}
			}
		} else {
			if(mileStonePojo.getTypeId()==null && mileStonePojo.getIsThisRecordExistsInDB()!=null &&
					mileStonePojo.getIsThisRecordExistsInDB().equals("NotExists")) {
				//this condition will execute, when milestone is not generated and he paid exess amount
				double gstAmount = ((gstPercentage/(gstPercentage+100))*(mileStonePojo.getSetOffAmount()-otherThanGstAmount));//(mileStonePojo.getSetOffAmount()-otherThanGstAmount)
				//here sumOfMileStoneTaxAmt this value should be other than GST amount
				gstAmount = roundOffAmount(gstAmount);
				mileStonePojo.setSgstAmount(gstAmount/2);
				mileStonePojo.setCgstAmount(gstAmount/2);
				mileStonePojo.setGstAmount(gstAmount);
				mileStonePojo.setPaidTaxAmount(gstAmount);
				sumOfCGST += gstAmount/2;
				sumOfSGST += gstAmount/2;
				sumOfPrincipalGstAmount +=gstAmount;
			}
			mileStonePojo.setSgstAmount(sumOfSGST);
			mileStonePojo.setCgstAmount(sumOfCGST);
			mileStonePojo.setGstAmount(sumOfCGST + sumOfSGST);
		}
		mileStoneGstDetails.put("CGST", sumOfCGST);
		mileStoneGstDetails.put("SGST", sumOfSGST);
		mileStoneGstDetails.put("GST", sumOfPrincipalGstAmount);
		if(Util.isEmptyObject(listOfSchemeDetails) && mileStonePojo.getMilestoneName()!=null && !mileStonePojo.getMilestoneName().equals("Excess Amount")){
			throw new EmployeeFinancialServiceException("GST details not found for receipt, Flat No : "+customerPropertyDetailsInfo.getFlatNo());	
		}
		return mileStoneGstDetails;
	}

	private void constructExcessAmountPojos(double setOffAmount, Long typeId, long bookingFormReceiptId, EmployeeFinancialTransactionServiceInfo transactionServiceInfo, String finBokAccInvoiceNo) throws InstantiationException, IllegalAccessException {
		log.info(" ***** control inside EmployeeFinancialServiceImpl.constructExcessAmountPojos() ***** "+setOffAmount+" "+typeId);
		FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
		bookingFormAccountsInfo.setExcessAmount(setOffAmount);
		bookingFormAccountsInfo.setBalanceAmount(setOffAmount);
		bookingFormAccountsInfo.setModifiedBy(transactionServiceInfo.getEmployeeId());
		bookingFormAccountsInfo.setCreatedBy(transactionServiceInfo.getEmployeeId());
		bookingFormAccountsInfo.setType(typeId);
		bookingFormAccountsInfo.setFinBookingFormReceiptsId(bookingFormReceiptId);
		bookingFormAccountsInfo.setFinBokAccInvoiceNo(finBokAccInvoiceNo);
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo.setFlatBookingId(transactionServiceInfo.getBookingFormId());
		
		//List<FinBookingFormExcessAmountPojo> listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo,typeId);
		//if(listOfExcessAmount.isEmpty()) {
			employeeFinancialServiceDao.saveBookingFormExcessAmount((FinBookingFormExcessAmountPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfo,FinBookingFormExcessAmountPojo.class));
		//}else {
		//	bookingFormAccountsInfo.setFinBookingFormExcessAmountId(listOfExcessAmount.get(0).getFinBookingFormExcessAmountId());
		//	employeeFinancialServiceDao.updateAndIncreaseExcessAmount((FinBookingFormExcessAmountPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(bookingFormAccountsInfo,FinBookingFormExcessAmountPojo.class));
		//}
	}	
	
	@Override
	public EmployeeFinancialTransactionResponse getAnonymousEntriesData(EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionServiceInfo) {
		//log.info("***** Control inside the EmployeeFinancialServiceImpl.getAnonymousEntriesData() *****");
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		List<FinAnonymousEntryResponse> finAnonymousEntryResponseList = new ArrayList<>();
		List<FinAnonymousEntryPojo> finAnonymousEntryPojoList = employeeFinancialServiceDao.getAnonymousEntriesData(employeeFinancialTransactionServiceInfo, Status.ACTIVE.getStatus());
		for(FinAnonymousEntryPojo finAnonymousEntryPojo : finAnonymousEntryPojoList) {
			//getting days by transaction Recieved Date
			int suspenseAging =TimeUtil.getDaysFromTwoDates(finAnonymousEntryPojo.getTransactionReceiveDate(),new Timestamp(System.currentTimeMillis()));
			log.info(suspenseAging);
			/* mapping FinAnonymousEntryPojo To FinAnonymousEntryInfo */
			FinAnonymousEntryInfo finAnonymousEntryInfo = financialMapper.finAnonymousEntryPojoToFinAnonymousEntryInfo(finAnonymousEntryPojo);
			//setting daysByTransactionRecievedDate 
			finAnonymousEntryInfo.setSuspenseAging(Long.valueOf(suspenseAging));
			/* getting all Anonymous Entry Comments */
			employeeFinancialTransactionServiceInfo.setTypeId(finAnonymousEntryInfo.getAnonymousEntryId());
			employeeFinancialTransactionServiceInfo.setAnonymousEntryId(finAnonymousEntryInfo.getAnonymousEntryId());
			List<FinAnnyEntryCommentsPojo> finAnnyEntryCommentsPojoList = employeeFinancialServiceDao.getFinAnnyEntryCommentsData(employeeFinancialTransactionServiceInfo);
			List<FinAnnyEntryCommentsResponse> finAnnyEntryCommentsResponseList = financialMapper.finAnnyEntryCommentsPojoListToFinAnnyEntryCommentsResponseList(finAnnyEntryCommentsPojoList,employeeFinancialTransactionServiceInfo);
			/* getting FinAnonymousEntryDocs */
			List<FinAnnyEntryDocPojo> finAnnyEntryDocPojoList = employeeFinancialServiceDao.getFinAnnyEntryDocData(finAnonymousEntryInfo);
			List<FinAnnyEntryDocResponse> finAnnyEntryDocResponseList = financialMapper.finAnnyEntryDocPojoListToFinAnnyEntryDocResponseList(finAnnyEntryDocPojoList);
			
			/*getting approve reject details*/
			List<FinAnnyApproveStatPojo> finTransactionApprStatPojoList = employeeFinancialServiceDao.getAnonymousApprStatData(employeeFinancialTransactionServiceInfo);
			List<FinAnnyApproveStatResponse> finAnnyApproveStatResponseList = financialMapper.finAnonymousApprStatPojoListToFinAnonymousApprStatResponseList(finTransactionApprStatPojoList,finAnnyEntryCommentsResponseList,employeeFinancialTransactionServiceInfo);

			/* setting all Responses List into FinAnonymousEntryResponse */
			FinAnonymousEntryResponse finAnonymousEntryResponse = financialMapper.finAnonymousEntryInfoTofinAnonymousEntryResponse(finAnonymousEntryInfo);
			finAnonymousEntryResponse.setFinAnnyEntryCommentsResponseList(finAnnyEntryCommentsResponseList);
			finAnonymousEntryResponse.setFinAnnyEntryDocResponseList(finAnnyEntryDocResponseList);
			finAnonymousEntryResponse.setFinAnnyApproveStatResponseList(finAnnyApproveStatResponseList);
			finAnonymousEntryResponseList.add(finAnonymousEntryResponse);
		}
		/* setting finAnonymousEntryResponseList to EmployeeFinancialTransactionResponse Object */
		employeeFinancialTransactionResponse.setFinAnonymousEntryResponseList(finAnonymousEntryResponseList);
		return employeeFinancialTransactionResponse;
	}

	@Override
	public EmployeeFinancialTransactionResponse getTaxPercentageData(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) {
		//log.info("*** The control is inside the getGstPercentageData in EmployeeFinancialServiceImpl ***");
		EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
		FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
		if(Util.isNotEmptyObject(transactionServiceInfo.getSiteIds())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
		} else if(Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
		}
		List<FinPenaltyTaxPojo> finPenaltyTaxPojoList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(getMetaDataId(transactionServiceInfo.getTypeName())));
		List<FinPenaltyTaxResponse> finPenaltyTaxResponseList = financialMapper.finPenaltyTaxPojoListToFinPenaltyTaxResponseList(finPenaltyTaxPojoList);
		employeeFinancialTransactionResponse.setFinPenaltyTaxResponseList(finPenaltyTaxResponseList);
		return employeeFinancialTransactionResponse;
	}
	
	@Override
	@Transactional(propagation=Propagation.REQUIRES_NEW, rollbackFor=Exception.class)
	public List<FileInfo> saveLegalCharges(EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionServiceInfo) throws Exception {
		log.info("*** The control is inside the saveLegalCharges in EmployeeFinancialServiceImpl ***");
		boolean isThisUploadedData = employeeFinancialTransactionServiceInfo.isThisUplaodedData();
		List<EmployeeFinancialTransactionResponse> employeeFinancialTransactionResponseList = new ArrayList<>();
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setThisUplaodedData(employeeFinancialTransactionServiceInfo.isThisUplaodedData());
		employeeFinancialServiceInfo.setCustomerAddressInfoList(employeeFinancialTransactionServiceInfo.getCustomerAddressInfoList());
		employeeFinancialServiceInfo.setSiteAddressInfoList(employeeFinancialTransactionServiceInfo.getSiteAddressInfoList());
		employeeFinancialServiceInfo.setFinProjectAccountResponseList(employeeFinancialTransactionServiceInfo.getFinProjectAccountResponseList());
		employeeFinancialServiceInfo.setOfficeDetailsList(employeeFinancialTransactionServiceInfo.getOfficeDetailsList());
		employeeFinancialServiceInfo.setFlatsResponse(employeeFinancialTransactionServiceInfo.getFlatsResponse());
		
		employeeFinancialServiceInfo.setSiteIds(employeeFinancialTransactionServiceInfo.getSiteIds());
		//employeeFinancialServiceInfo.setBlockIds(employeeFinancialTransactionServiceInfo.getBlockIds());
		//employeeFinancialServiceInfo.setFloorIds(employeeFinancialTransactionServiceInfo.getFloorIds());
		employeeFinancialServiceInfo.setFlatIds(employeeFinancialTransactionServiceInfo.getFlatIds());
		employeeFinancialServiceInfo.setBookingFormIds(employeeFinancialTransactionServiceInfo.getBookingFormIds());
		employeeFinancialServiceInfo.setSiteId(employeeFinancialTransactionServiceInfo.getSiteIds().get(0));
		List<FinProjectAccountResponse> finProjectAccountResponseList = null;
		/* getting Customer Details */
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojoList){
			if(Util.isNotEmptyObject(customerPropertyDetailsPojo.getFlatBookingId())) {
				
				EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse = new EmployeeFinancialTransactionResponse();
				CustomerPropertyDetailsInfo customerPropertyDetailsInfo =  financialMapper.copyPropertiesFromCustomerPropertyDetailsPojoToCustomerPropertyDetailsInfo(customerPropertyDetailsPojo);
				/* Checking Legal Charges Already inserted or not */
				employeeFinancialTransactionServiceInfo.setTypeId(MetadataId.LEGAL_COST.getId());
				employeeFinancialTransactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
				//@SuppressWarnings("unused")
				//boolean flag = employeeFinancialServiceDao.isTypeExistedInFinBookingFormAccounts(customerPropertyDetailsInfo, employeeFinancialTransactionServiceInfo);
				if(true) {
					/* inserting into FIN_BOOKING_FORM_LEGAL_COST Table */
					FinBookingFormLegalCostInfo finBookingFormLegalCostInfo = employeeFinancialTransactionServiceInfo.getFinBookingFormLegalCostList().get(0);
					FinBookingFormLegalCostPojo finBookingFormLegalCostPojo = (FinBookingFormLegalCostPojo) financialMapper.finBookingFormLegalCostInfoToFinBookingFormLegalCostPojo(finBookingFormLegalCostInfo, 
							employeeFinancialTransactionServiceInfo,customerPropertyDetailsInfo);
					finBookingFormLegalCostPojo = employeeFinancialServiceDao.saveFinBookingFormLegalCostData(finBookingFormLegalCostPojo);
					/* inserting into FIN_BOOKING_FORM_LGL_COST_DTLS */
					List<FinBookingFormLglCostDtlsInfo> finBookingFormLglCostDtlsInfoList = finBookingFormLegalCostInfo.getFinBookingFormLglCostDtlsList();
					List<FinBookingFormLglCostDtlsPojo> finBookingFormLglCostDtlsPojoList = financialMapper.finBookingFormLglCostDtlsInfoListToFinBookingFormLglCostDtlsPojoList(finBookingFormLglCostDtlsInfoList,
							employeeFinancialTransactionServiceInfo,finBookingFormLegalCostPojo);
					finBookingFormLglCostDtlsPojoList = employeeFinancialServiceDao.saveFinBookingFormLglCostDtlsData(finBookingFormLglCostDtlsPojoList);
					/* inserting into FIN_BOOKING_FORM_ACCOUNTS */
					FinBookingFormAccountsPojo finBookingFormAccountsPojo = financialMapper.copyPropertiesToFinBookingFormAccountsPojo(new FinancialProjectMileStoneInfo(),finBookingFormLegalCostPojo, FinBookingFormAccountsPojo.class, MetadataId.LEGAL_COST.getName());
					if(employeeFinancialTransactionServiceInfo.isThisUplaodedData()) {
						finBookingFormAccountsPojo.setIsRecordUploaded(Status.YES.getStatus());	
					}
					Long finBookingFormAccountsId = employeeFinancialServiceDao.saveFinBookingFormAccounts(finBookingFormAccountsPojo);
					String invoiceNo = "";
					FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
					bookingFormAccountsInfo.setFinBookingFormAccountsId(finBookingFormAccountsId);
					bookingFormAccountsInfo.setType(MetadataId.LEGAL_COST.getId());
					bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());
					List<Map<String, Object>> bookingFormAcclist = employeeFinancialServiceDao.getFinBookingFormAccountByTypeAndID(bookingFormAccountsInfo);
					if(Util.isNotEmptyObject(bookingFormAcclist)) {
						invoiceNo = bookingFormAcclist.get(0).get("FIN_BOK_ACC_INVOICE_NO").toString();
					} else {
						throw new EmployeeFinancialServiceException("Failed to generate legal invoice"); 
					}
					finBookingFormAccountsPojo.setFinBookingFormAccountsId(finBookingFormAccountsId);
					String num = String.format("%04d",finBookingFormLegalCostPojo.getFinBokFrmLegalCostId());
					System.out.println("INV"+num+"\t"+invoiceNo);
					finBookingFormAccountsPojo.setFinBokAccInvoiceNo(invoiceNo);
					employeeFinancialTransactionServiceInfo.setFinBokAccInvoiceNo(invoiceNo);
					/* inserting into FIN_BOK_FRM_LGL_COST_TAX */
					FinBokFrmLglCostTaxPojo finBokFrmLglCostTaxPojo = financialMapper.finBookingFormLegalCostPojoTofinBokFrmLglCostTaxPojo(finBookingFormLegalCostPojo, employeeFinancialTransactionServiceInfo);
					finBokFrmLglCostTaxPojo = employeeFinancialServiceDao.saveFinBokFrmLglCostTaxData(finBokFrmLglCostTaxPojo);
					
					CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
					customerPropertyDetailsInfo2.setType(MetadataId.LEGAL_COST.getId());
					customerPropertyDetailsInfo2.setFlatBookingId(customerPropertyDetailsPojo.getFlatBookingId());
					//customerPropertyDetailsInfo2.setCondition(MetadataId.MODIFICATION_COST.getName());
					List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);

					FinBookingFormAccountSummaryPojo accSummaryPojo = (FinBookingFormAccountSummaryPojo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(finBookingFormLegalCostInfo,FinBookingFormAccountSummaryPojo.class);
					accSummaryPojo.setType(MetadataId.LEGAL_COST.getId());
					accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
					accSummaryPojo.setPayableAmount(finBookingFormLegalCostPojo.getTotalAmount());
					accSummaryPojo.setBalanceAmount(finBookingFormLegalCostPojo.getTotalAmount());
					accSummaryPojo.setBookingFormId(finBookingFormLegalCostPojo.getBookingFormId());
					accSummaryPojo.setCreatedBy(finBookingFormLegalCostPojo.getCreatedBy());
					if(!listOfBookingAccountSummaryDetails.isEmpty()) {
							employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
					} else {
							employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
					}
					
					/* All Responses for creating PDF File */
					FinBookingFormAccountsResponse finBookingFormAccountsResponse = (FinBookingFormAccountsResponse) financialMapper.copyPropertiesFromRequestBeanToInfoBean(finBookingFormAccountsPojo, FinBookingFormAccountsResponse.class);
					FinBookingFormLegalCostResponse finBookingFormLegalCostResponse = (FinBookingFormLegalCostResponse) financialMapper.copyPropertiesFromRequestBeanToInfoBean(finBookingFormLegalCostPojo, FinBookingFormLegalCostResponse.class);
					List<FinBookingFormLglCostDtlsResponse> finBookingFormLglCostDtlsResponseList = financialMapper.finBookingFormLglCostDtlsPojoListTofinBookingFormLglCostDtlsResponseList(finBookingFormLglCostDtlsPojoList);
					employeeFinancialTransactionResponse.setFlatsResponse(new ArrayList<CustomerPropertyDetailsInfo>(Arrays.asList(customerPropertyDetailsInfo)));
					employeeFinancialServiceInfo.setCondition("LEGAL_COST");
					loadCustomerDetails(employeeFinancialTransactionResponse, employeeFinancialServiceInfo, customerPropertyDetailsInfo);
					
					//loading account details for legal based on selected account number in front end
					EmployeeFinancialTransactionServiceInfo loadAccDetails = new EmployeeFinancialTransactionServiceInfo();
					loadAccDetails.setSiteIds(employeeFinancialServiceInfo.getSiteIds());
					loadAccDetails.setCondition(null);//employeeFinancialServiceInfo.getCondition()
					loadAccDetails.setSiteAccountId(employeeFinancialTransactionServiceInfo.getSiteAccountId());
					List<FinProjectAccountPojo> finProjectAccountPojoList = employeeFinancialServiceDao.getFinProjectAccountData(loadAccDetails,null);
					
					finProjectAccountResponseList = financialMapper.finProjectAccountPojoListToFinProjectAccountResponseList(finProjectAccountPojoList);
					if(finProjectAccountResponseList.isEmpty()) {
						finProjectAccountResponseList.add(new FinProjectAccountResponse());
					}
					
					if(Util.isNotEmptyObject(finProjectAccountPojoList) && Util.isNotEmptyObject(finProjectAccountPojoList.get(0).getSiteBankAccountNumber())) {
						finProjectAccountResponseList.get(0).setSiteBankAccountNumber(finProjectAccountPojoList.get(0).getSiteBankAccountNumber());
					}
					
					employeeFinancialTransactionResponse.setFinProjectAccountResponseList(finProjectAccountResponseList);

					employeeFinancialServiceInfo.setCondition("");
					if(Util.isEmptyObject(employeeFinancialTransactionResponse.getFinProjectAccountResponseList().get(0).getSiteBankAccountNumber())) {
						throw new EmployeeFinancialServiceException("Please add Account number for Legal Invoice, Account number not found.");
					}
					if(Util.isEmptyObject(finProjectAccountResponseList.get(0).getFlatSaleOwnerId())) {
						throw new EmployeeFinancialServiceException("Sale owner found empty for the selected account number.");
					}
					//account number mapped sale owner id mapping
					customerPropertyDetailsInfo.setFlatSaleOwnerIdBasedOnAccountId(finProjectAccountResponseList.get(0).getFlatSaleOwnerId());
					customerPropertyDetailsInfo.setFlatSaleOwnerNameBasedOnAccountId(finProjectAccountResponseList.get(0).getFlatSaleOwner());
					//selected account number sale owner mapping to the flat
					customerPropertyDetailsInfo.setFlatSaleOwnerId(String.valueOf(finProjectAccountResponseList.get(0).getFlatSaleOwnerId()));
					customerPropertyDetailsInfo.setFlatSaleOwner(finProjectAccountResponseList.get(0).getFlatSaleOwner());
					
					setFlatNoAndMileStoneName(employeeFinancialTransactionResponse, new FinancialProjectMileStoneInfo(), customerPropertyDetailsInfo, MetadataId.LEGAL_COST.getName(),null);
					FinBookingFormLegalCostPdfResponse finBookingFormLegalCostPdfResponse = new FinBookingFormLegalCostPdfResponse();
					finBookingFormLegalCostResponse.setFinBookingFormLglCostDtlsList(finBookingFormLglCostDtlsResponseList);
					finBookingFormLegalCostPdfResponse.setFinBookingFormAccountsResponse(finBookingFormAccountsResponse);
					finBookingFormLegalCostPdfResponse.setFinBookingFormLegalCostResponse(finBookingFormLegalCostResponse);
					employeeFinancialTransactionResponse.setFinBookingFormLegalCostPdfResponse(finBookingFormLegalCostPdfResponse);
					employeeFinancialTransactionResponse.setPercentageValue(employeeFinancialTransactionServiceInfo.getPercentageValue());
					employeeFinancialTransactionResponse.setEmployeeId(employeeFinancialTransactionServiceInfo.getEmployeeId());
					employeeFinancialTransactionResponseList.add(employeeFinancialTransactionResponse);
				}
			}
		}
		List<FileInfo> fileInfoList = employeeFinancialHelper.legalChargesInvoiceGeneratorHelper(employeeFinancialTransactionResponseList,employeeFinancialTransactionServiceInfo);
		/* preparing invoice document location pojo and inserting into table */
		List<InvoiceDocumentLocationPojo> invoiceDocumentLocationPojoList = getInvoiceDocumentLocationPojoList(fileInfoList, employeeFinancialTransactionResponseList, MetadataId.LEGAL_COST);
		employeeFinancialServiceDao.saveInvoiceDocumentLocationForCharges(invoiceDocumentLocationPojoList);
		/* sending mail to customers */
		if(!isThisUploadedData) {
			//in use employeeFinancialHelper.sendFinancialMailToCustomers123(employeeFinancialTransactionResponseList, fileInfoList, MetadataId.LEGAL_COST.getName());
		}
		return fileInfoList;
	}

	/**
	 * Receipt Entry
	 */
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public List<Object> saveMaintenance_Charges(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		log.info("EmployeeFinancialServiceImpl.saveMaintenance_Charges()");
		List<FinPenaltyTaxPojo> taxDetailsList = null;
		Double maintenancePercentage = null;
		Long maintenanceTaxId = null;
		Double maintenanceAmount = null;
		List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		FinBookingFormMaintenancePojo bookingFormMaintenancePojo = null;
		FinBookingFormMaintenanceDtlsPojo bookingFormMaintenanceDtlsPojo = null;
		FinBokFrmMaintenanceTaxPojo bokFrmMaintenanceTaxPojo =null;// new FinBokFrmMaintenanceTaxPojo();

		Properties prop = responceCodesUtil.getApplicationProperties();
		SimpleDateFormat format = new SimpleDateFormat("dd-MM-yyyy");
		
		Timestamp startDate = null;
		Timestamp endDateForMaintencenDate = null;
		
		FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
		if(Util.isNotEmptyObject(transactionServiceInfo.getSiteIds())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
		} else if(Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
		}
		
		if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
				transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
			} else {
				 throw new EmployeeFinancialServiceException("Customer details not found, Failed to generate modification invoice.");
			}
		}
		
		if(customerPropertyDetailsInfo.getSiteId().equals(107l)) {
			if(isEmptyObject(customerPropertyDetailsInfo.getSaleDeedDate()) && !"1".equals(customerPropertyDetailsInfo.getFlatSaleOwnerId()) ) {
				throw new EmployeeFinancialServiceException("Maintenance charges entry failed, Please update sale deed date for calculation.");
			}
		}
		
		FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
		bookingFormAccountsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());//adding type of payment
		bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.MAINTENANCE_CHARGE.getId()));
		bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
		//bookingFormAccountsInfo.setCondition("NOC Validation");
		
		//here loading all the maintenace Payment Details using customer FlatBookingId
		List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
		if(Util.isNotEmptyObject(bookingFormAccountsPojoLists)) {
			return null;// if already record exists, no need to generate records' again
		}
		
		//taking maintainence percentage
		taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.MAINTENANCE_CHARGE.getId()));
		
		if(Util.isEmptyObject(taxDetailsList)) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add maintenance charges GST percentage..."));
		}
		BookingFormRequest bookingFormRequest = new BookingFormRequest();
		bookingFormRequest.setSiteId(customerPropertyDetailsInfo.getSiteId());
		bookingFormRequest.setFlatId(customerPropertyDetailsInfo.getFlatId());
		bookingFormRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormRequest.setCustomerId(customerPropertyDetailsInfo.getCustomerId());
		//loading maintenance master details
		siteOtherChargesDetailsList = bookingFormServiceDaoImpl.getTheSiteOtherChargesDetails(bookingFormRequest);
		//loading flat details, like sbua, carpet are
		List<FlatDetailsPojo> flatDetailsPojos = bookingFormServiceDaoImpl.getFlatDetails(bookingFormRequest);
		
		if(Util.isEmptyObject(flatDetailsPojos)) {
			throw new EmployeeFinancialServiceException("Failed to load flat details, Cananot generate transaction.");
		}
		FinPenaltyTaxPojo finTaxPojo1 = null;
		//taking maintenance percentage
		for (FinPenaltyTaxPojo finTaxPojo : taxDetailsList) {
			if (MetadataId.MAINTENANCE_CHARGE.getId().equals(finTaxPojo.getTaxType())) {
				maintenancePercentage = finTaxPojo.getPercentageValue();
				maintenanceTaxId = finTaxPojo.getPercentageId();
				finTaxPojo1 = finTaxPojo;
			}
		}
		
		SiteOtherChargesDetailsPojo siteOtherChargesDetailsPojo = null;
		//taking maintenance amount using sbua * maintenance amount
		for (SiteOtherChargesDetailsPojo otherDetailsDraft : siteOtherChargesDetailsList) {
			if (otherDetailsDraft.getAmount() != null) {
				if (MetadataId.MAINTENANCE_CHARGE.getId().equals(otherDetailsDraft.getMeteDataTypeId())) {
					maintenanceAmount = flatDetailsPojos.get(0).getSbua() * otherDetailsDraft.getAmount();
					siteOtherChargesDetailsPojo = otherDetailsDraft;
					break;
				}				
			}
		}
		
		double maintenanceGstAmount = (maintenanceAmount * maintenancePercentage) / 100;
		double maintenanceAmtWithGstAmount =  maintenanceAmount+maintenanceGstAmount;
		
		/*if(customerPropertyDetailsInfo.getSiteId().equals(111l)) {
			startDate = new Timestamp(format.parse("01-02-2022").getTime());
			endDateForMaintencenDate = new Timestamp(format.parse("31-01-2023").getTime());			
			startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
			endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());
		} else if(customerPropertyDetailsInfo.getSiteId().equals(107l)) {
			startDate = new Timestamp(format.parse("01-03-2022").getTime());
			endDateForMaintencenDate = new Timestamp(format.parse("28-02-2023").getTime());
			startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
			endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());
		}*/
		if(Util.isNotEmptyObject(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE"))) {
			startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
		}
		if(Util.isNotEmptyObject(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE"))) {
			endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());
		}

		Timestamp bookingDate = customerPropertyDetailsInfo.getBookingDate();
		//
		if(bookingDate!=null && startDate !=null && endDateForMaintencenDate!=null) {
			if(bookingDate.after(startDate) || bookingDate.equals(startDate)) {//if booking date is after the start date then only enter to condition
				if(customerPropertyDetailsInfo.getSiteId().equals(111l) || customerPropertyDetailsInfo.getSiteId().equals(107l)|| customerPropertyDetailsInfo.getSiteId().equals(124l)) {
					Map<String,Double> map = bookingFormServiceImpl.getTotalMaintainanceCostToPay(startDate,endDateForMaintencenDate,customerPropertyDetailsInfo,flatDetailsPojos,finTaxPojo1,siteOtherChargesDetailsPojo);
					maintenanceAmtWithGstAmount = map.get("totalMaintainanceCostToPay");
					maintenanceGstAmount =  map.get("totalGstAmount");
					maintenanceAmount =  map.get("totalBasicMaintainanceAmt");
				}
			}
		}
		
		bookingFormMaintenancePojo = new FinBookingFormMaintenancePojo();
		bookingFormMaintenancePojo.setBasicAmount(maintenanceAmount);
		bookingFormMaintenancePojo.setTaxAmount(maintenanceGstAmount);
		bookingFormMaintenancePojo.setTotalAmount(maintenanceAmtWithGstAmount);
		bookingFormMaintenancePojo.setCreatedBy(transactionServiceInfo.getEmployeeId());
		bookingFormMaintenancePojo.setStatusId(Status.ACTIVE.getStatus());
		bookingFormMaintenancePojo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormMaintenancePojo = employeeFinancialServiceDao.saveMaintenanceCharges(bookingFormMaintenancePojo);
		
		bookingFormMaintenanceDtlsPojo = financialMapper.constructMaintenanceDetailsPojo(bookingFormMaintenancePojo,transactionServiceInfo);
		bookingFormMaintenanceDtlsPojo = employeeFinancialServiceDao.saveMaintenanceChargesDetails(bookingFormMaintenanceDtlsPojo);		

		bokFrmMaintenanceTaxPojo = financialMapper.constructMaintenanceTaxPojo(bookingFormMaintenanceDtlsPojo,maintenanceTaxId);
		bokFrmMaintenanceTaxPojo = employeeFinancialServiceDao.saveMaintenanceChargesTaxData(bokFrmMaintenanceTaxPojo);
		
		FinBookingFormAccountsPojo accountsPojo = financialMapper.constructMaintenanceChargesAccoutsRecord(bookingFormMaintenancePojo);
		employeeFinancialServiceDao.saveFinBookingFormAccounts(accountsPojo);
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo2.setType(MetadataId.MAINTENANCE_CHARGE.getId());
		customerPropertyDetailsInfo2.setFlatBookingId(bookingFormMaintenancePojo.getBookingFormId());
		List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);

		FinBookingFormAccountSummaryPojo accSummaryPojo = new FinBookingFormAccountSummaryPojo();
		accSummaryPojo.setType(MetadataId.MAINTENANCE_CHARGE.getId());
		accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
		accSummaryPojo.setPayableAmount(bookingFormMaintenancePojo.getTotalAmount());
		accSummaryPojo.setBalanceAmount(bookingFormMaintenancePojo.getTotalAmount());
		accSummaryPojo.setBookingFormId(bookingFormMaintenancePojo.getBookingFormId());
		accSummaryPojo.setCreatedBy(bookingFormMaintenancePojo.getCreatedBy());
		if(!listOfBookingAccountSummaryDetails.isEmpty()) {
			employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
		} else {
			employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
		}
		return null;
	}
	
	@Override
	//@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public List<Object> updateMaintenance_ChargesPayAmount(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		log.info("EmployeeFinancialServiceImpl.updateMaintenance_ChargesPayAmount()");
		List<FinPenaltyTaxPojo> taxDetailsList = null;
		Double maintenancePercentage = null;
		Long maintenanceTaxId = null;
		Double maintenanceAmount = null;
		List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		FinBookingFormMaintenancePojo bookingFormMaintenancePojo = null;
		FinBookingFormAccountsInfo bookingFormAccountsInfo = null;
		/*FinBookingFormMaintenanceDtlsPojo bookingFormMaintenanceDtlsPojo = null;
		FinBokFrmMaintenanceTaxPojo bokFrmMaintenanceTaxPojo =null;// new FinBokFrmMaintenanceTaxPojo();
*/
		Properties prop = responceCodesUtil.getApplicationProperties();
		SimpleDateFormat format = new SimpleDateFormat("dd-MM-yyyy");
		
		Timestamp startDate = null;
		Timestamp endDateForMaintencenDate = null;
		
		FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
		if(Util.isNotEmptyObject(transactionServiceInfo.getSiteIds())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
		} else if(Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
		}
		
		/*if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {*/
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setSiteId(finProjDemandNoteInfo.getSiteId());
			if(transactionServiceInfo.getBookingFormId()!=null) {
				employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			}
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
				for(CustomerPropertyDetailsPojo customerPropertyDetailsPojo : customerPropertyDetailsPojos) {
					
					try {

						if(!customerPropertyDetailsPojo.getSiteId().equals(107l)) {
							continue;
						}
						//updating only landlord flats amout and only eden garden site
						if("1".equals(customerPropertyDetailsPojo.getFlatSaleOwnerId())) {
							continue;
						}
						
						customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojo, CustomerPropertyDetailsInfo.class);
						transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
					
						bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
						bookingFormAccountsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
						bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());//adding type of payment
						bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.MAINTENANCE_CHARGE.getId()));
						bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
						//bookingFormAccountsInfo.setCondition("NOC Validation");
						
						//here loading all the Milestone Payment Details using customer FlatBookingId
						List<FinBookingFormAccountsPojo> bookingFormAccountsDBPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
						if(Util.isEmptyObject(bookingFormAccountsDBPojoLists)) {
							// if already record exists, no need to generate records' again
							continue;
						}
						
						//taking maintainence percentage
						taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.MAINTENANCE_CHARGE.getId()));
						
						if(Util.isEmptyObject(taxDetailsList)) {
							throw new EmployeeFinancialServiceException(Arrays.asList("Please add maintenance charges GST percentage..."));
						}
						BookingFormRequest bookingFormRequest = new BookingFormRequest();
						bookingFormRequest.setSiteId(customerPropertyDetailsInfo.getSiteId());
						bookingFormRequest.setFlatId(customerPropertyDetailsInfo.getFlatId());
						bookingFormRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
						bookingFormRequest.setCustomerId(customerPropertyDetailsInfo.getCustomerId());
						//loading maintenance master details
						siteOtherChargesDetailsList = bookingFormServiceDaoImpl.getTheSiteOtherChargesDetails(bookingFormRequest);
						//loading flat details, like sbua, carpet are
						List<FlatDetailsPojo> flatDetailsPojos = bookingFormServiceDaoImpl.getFlatDetails(bookingFormRequest);
						
						if(Util.isEmptyObject(flatDetailsPojos)) {
							throw new EmployeeFinancialServiceException("Failed to load flat details, Cananot generate transaction.");
						}
						FinPenaltyTaxPojo finTaxPojo1 = null;
						//taking maintenance percentage
						for (FinPenaltyTaxPojo finTaxPojo : taxDetailsList) {
							if (MetadataId.MAINTENANCE_CHARGE.getId().equals(finTaxPojo.getTaxType())) {
								maintenancePercentage = finTaxPojo.getPercentageValue();
								maintenanceTaxId = finTaxPojo.getPercentageId();
								finTaxPojo1 = finTaxPojo;
							}
						}
						
						SiteOtherChargesDetailsPojo siteOtherChargesDetailsPojo = null;
						//taking maintenance amount using sbua * maintenance amount
						for (SiteOtherChargesDetailsPojo otherDetailsDraft : siteOtherChargesDetailsList) {
							if (otherDetailsDraft.getAmount() != null) {
								if (MetadataId.MAINTENANCE_CHARGE.getId().equals(otherDetailsDraft.getMeteDataTypeId())) {
									maintenanceAmount = flatDetailsPojos.get(0).getSbua() * otherDetailsDraft.getAmount();
									siteOtherChargesDetailsPojo = otherDetailsDraft;
									break;
								}				
							}
						}
						
						double maintenanceGstAmount = (maintenanceAmount * maintenancePercentage) / 100;
						double maintenanceAmtWithGstAmount =  maintenanceAmount+maintenanceGstAmount;
						
						/*if(customerPropertyDetailsInfo.getSiteId().equals(111l)) {
							startDate = new Timestamp(format.parse("01-02-2022").getTime());
							endDateForMaintencenDate = new Timestamp(format.parse("31-01-2023").getTime());			
							startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
							endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());
						} else if(customerPropertyDetailsInfo.getSiteId().equals(107l)) {
							startDate = new Timestamp(format.parse("01-03-2022").getTime());
							endDateForMaintencenDate = new Timestamp(format.parse("28-02-2023").getTime());
							startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
							endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());
						}*/
						if(Util.isNotEmptyObject(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE"))) {
							startDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_START_DATE")).getTime());
						}
						if(Util.isNotEmptyObject(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE"))) {
							endDateForMaintencenDate = new Timestamp(format.parse(prop.getProperty(customerPropertyDetailsInfo.getSiteId()+"_MAINTENANCE_CHARGES_END_DATE")).getTime());
						}

						Timestamp bookingDate = customerPropertyDetailsInfo.getBookingDate();
						//
						if(bookingDate!=null && startDate !=null && endDateForMaintencenDate!=null) {
							if(bookingDate.after(startDate) || bookingDate.equals(startDate)) {//if booking date is after the start date then only enter to condition
								if(customerPropertyDetailsInfo.getSiteId().equals(111l) || customerPropertyDetailsInfo.getSiteId().equals(107l)) {
									Map<String,Double> map = bookingFormServiceImpl.getTotalMaintainanceCostToPay(startDate,endDateForMaintencenDate,customerPropertyDetailsInfo,flatDetailsPojos,finTaxPojo1,siteOtherChargesDetailsPojo);
									maintenanceAmtWithGstAmount = map.get("totalMaintainanceCostToPay");
									maintenanceGstAmount =  map.get("totalGstAmount");
									maintenanceAmount =  map.get("totalBasicMaintainanceAmt");
								}
							}
						}
						if(maintenanceAmtWithGstAmount==0) {
							continue;
						}
						double paidAmount = bookingFormAccountsDBPojoLists.get(0).getPaidAmount();
						log.info("id "+customerPropertyDetailsInfo.getFlatBookingId()+", flat "+customerPropertyDetailsInfo.getFlatNo());
						bookingFormMaintenancePojo = new FinBookingFormMaintenancePojo();
						bookingFormMaintenancePojo.setBasicAmount(maintenanceAmount);
						bookingFormMaintenancePojo.setTaxAmount(maintenanceGstAmount);
						bookingFormMaintenancePojo.setTotalAmount(maintenanceAmtWithGstAmount);
						bookingFormMaintenancePojo.setCreatedBy(transactionServiceInfo.getEmployeeId());
						bookingFormMaintenancePojo.setStatusId(Status.ACTIVE.getStatus());
						bookingFormMaintenancePojo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
												
						/*bookingFormMaintenancePojo = employeeFinancialServiceDao.saveMaintenanceCharges(bookingFormMaintenancePojo);
						bookingFormMaintenanceDtlsPojo = financialMapper.constructMaintenanceDetailsPojo(bookingFormMaintenancePojo,transactionServiceInfo);
						bookingFormMaintenanceDtlsPojo = employeeFinancialServiceDao.saveMaintenanceChargesDetails(bookingFormMaintenanceDtlsPojo);		
						bokFrmMaintenanceTaxPojo = financialMapper.constructMaintenanceTaxPojo(bookingFormMaintenanceDtlsPojo,maintenanceTaxId);
						bokFrmMaintenanceTaxPojo = employeeFinancialServiceDao.saveMaintenanceChargesTaxData(bokFrmMaintenanceTaxPojo);*/
						
						FinBookingFormAccountsPojo accountsPojo = financialMapper.constructMaintenanceChargesAccoutsRecord(bookingFormMaintenancePojo);
						accountsPojo.setFinBookingFormAccountsId(bookingFormAccountsDBPojoLists.get(0).getFinBookingFormAccountsId());
						if (paidAmount == maintenanceAmtWithGstAmount) {
							accountsPojo.setPaymentStatus(Status.PAID.getStatus());
						} else if (paidAmount > maintenanceAmtWithGstAmount) {
							accountsPojo.setPaymentStatus(Status.PAID.getStatus());
						} else if (paidAmount < maintenanceAmtWithGstAmount) {
							accountsPojo.setPaymentStatus(Status.INPROGRESS.getStatus());
						} else {
							accountsPojo.setPaymentStatus(Status.INPROGRESS.getStatus());
						}
						accountsPojo.setBalanceAmount(maintenanceAmtWithGstAmount-paidAmount);
						employeeFinancialServiceDao.updateFinBookingFormAccountsPayAmount(accountsPojo);
						
						FinBookingFormAccountSummaryPojo accSummaryPojo = new FinBookingFormAccountSummaryPojo();
						accSummaryPojo.setType(MetadataId.MAINTENANCE_CHARGE.getId());
						accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
						accSummaryPojo.setPayableAmount(bookingFormMaintenancePojo.getTotalAmount());
						accSummaryPojo.setBalanceAmount(bookingFormMaintenancePojo.getTotalAmount());
						accSummaryPojo.setBookingFormId(bookingFormMaintenancePojo.getBookingFormId());
						accSummaryPojo.setCreatedBy(bookingFormMaintenancePojo.getCreatedBy());
						
						employeeFinancialServiceDao.updateBookingFormAccountSummaryOnlyPayAmount(accSummaryPojo);
						
						/*if(!listOfBookingAccountSummaryDetails.isEmpty()) {
							employeeFinancialServiceDao.updateBookingFormAccountSummaryOnlyPayAmount(accSummaryPojo);
						} else {
							employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
						}*/

					} catch(Exception exx) {
						exx.printStackTrace();
					}
					
				}
			}
		//}
		
		
		return null;
	}
	
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public List<Object> saveFlatKhataBifurcationAndOtherCharges(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		log.info("EmployeeFinancialServiceImpl.saveFlatKhataBifurcationAndOtherCharges()");
		List<FinPenaltyTaxPojo> taxDetailsList = null;
		Double FlatKhataPercentage = null;
		Long FlatKhataTaxId = null;
		Double FlatKhataAmount = null;
		List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		FinBookingFormFlatKhataPojo bookingFormMaintenancePojo = null;
		FinBookingFormFlatKhataDtlsPojo bookingFormMaintenanceDtlsPojo = null;
		FinBokFrmFlatKhataTaxPojo bokFrmMaintenanceTaxPojo =null;// new FinBokFrmMaintenanceTaxPojo();

		FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
		if(Util.isNotEmptyObject(transactionServiceInfo.getSiteIds())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
		} else if(Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
		}
		
		if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
				transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
			}
		}
		
		
		FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
		bookingFormAccountsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());//adding type of payment
		bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId()));
		bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
		//bookingFormAccountsInfo.setCondition("NOC Validation");
		
		//here loading all the flat khata Payment Details using customer FlatBookingId
		List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
		if(Util.isNotEmptyObject(bookingFormAccountsPojoLists)) {
			return null;// if already record exists, no need to insert record again
		}
		
		//taking flat khata percentage
		taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId()));
		
		if(Util.isEmptyObject(taxDetailsList)) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add Flat Khata charges GST percentage..."));
		}
		BookingFormRequest bookingFormRequest = new BookingFormRequest();
		bookingFormRequest.setSiteId(customerPropertyDetailsInfo.getSiteId());
		bookingFormRequest.setFlatId(customerPropertyDetailsInfo.getFlatId());
		bookingFormRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormRequest.setCustomerId(customerPropertyDetailsInfo.getCustomerId());
		//loading FlatKhata master details
		siteOtherChargesDetailsList = bookingFormServiceDaoImpl.getTheSiteOtherChargesDetails(bookingFormRequest);
		//loading flat details, like sbua, carpet are
		//List<FlatDetailsPojo> flatDetailsPojos = bookingFormServiceDaoImpl.getFlatDetails(bookingFormRequest);
		
		/*if(Util.isEmptyObject(flatDetailsPojos)) {
			throw new EmployeeFinancialServiceException("Failed to load flat details, Cananot generate transaction.");
		}*/
		//taking FlatKhata percentage
		for (FinPenaltyTaxPojo finTaxPojo : taxDetailsList) {
			if (MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(finTaxPojo.getTaxType())) {
				FlatKhataPercentage = finTaxPojo.getPercentageValue();
				FlatKhataTaxId = finTaxPojo.getPercentageId();
			}
		}
		
		//taking maintaince amount using sbua * FlatKhata amount
		SiteOtherChargesDetailsPojo flatKhataMasterDetails = null;
		for (SiteOtherChargesDetailsPojo otherDetailsDraft : siteOtherChargesDetailsList) {
			if (otherDetailsDraft.getAmount() != null) {
				if (MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId().equals(otherDetailsDraft.getMeteDataTypeId())) {
					FlatKhataAmount = otherDetailsDraft.getAmount();
					flatKhataMasterDetails = otherDetailsDraft;
					break;
				}				
			}
		}
		
		if(Util.isEmptyObject(flatKhataMasterDetails)) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Could not found any Flat Khata charges for site - "+customerPropertyDetailsInfo.getSiteName()));
		}
		
		double FlatKhataGstAmount = (FlatKhataAmount * FlatKhataPercentage) / 100;
		double FlatKhataAmtWithGstAmount =  FlatKhataAmount+FlatKhataGstAmount;
		
		bookingFormMaintenancePojo = new FinBookingFormFlatKhataPojo();
		bookingFormMaintenancePojo.setBasicAmount(FlatKhataAmount);
		bookingFormMaintenancePojo.setTaxAmount(FlatKhataGstAmount);
		bookingFormMaintenancePojo.setTotalAmount(FlatKhataAmtWithGstAmount);
		bookingFormMaintenancePojo.setCreatedBy(transactionServiceInfo.getEmployeeId());
		bookingFormMaintenancePojo.setStatusId(Status.ACTIVE.getStatus());
		bookingFormMaintenancePojo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormMaintenancePojo = employeeFinancialServiceDao.saveFlatKhata(bookingFormMaintenancePojo);
		
		bookingFormMaintenanceDtlsPojo = financialMapper.constructFlatKhataDetailsPojo(bookingFormMaintenancePojo,transactionServiceInfo);
		bookingFormMaintenanceDtlsPojo = employeeFinancialServiceDao.saveFlatKhataDetails(bookingFormMaintenanceDtlsPojo);		

		bokFrmMaintenanceTaxPojo = financialMapper.constructFlatKhataTaxPojo(bookingFormMaintenanceDtlsPojo,FlatKhataTaxId);
		bokFrmMaintenanceTaxPojo = employeeFinancialServiceDao.saveFlatKhataTaxData(bokFrmMaintenanceTaxPojo);
		
		FinBookingFormAccountsPojo accountsPojo = financialMapper.constructFlatKhataAccoutsRecord(bookingFormMaintenancePojo);
		employeeFinancialServiceDao.saveFinBookingFormAccounts(accountsPojo);
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo2.setType(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId());
		customerPropertyDetailsInfo2.setFlatBookingId(bookingFormMaintenancePojo.getBookingFormId());
		List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);

		FinBookingFormAccountSummaryPojo accSummaryPojo = new FinBookingFormAccountSummaryPojo();
		accSummaryPojo.setType(MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId());
		accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
		accSummaryPojo.setPayableAmount(bookingFormMaintenancePojo.getTotalAmount());
		accSummaryPojo.setBalanceAmount(bookingFormMaintenancePojo.getTotalAmount());
		accSummaryPojo.setBookingFormId(bookingFormMaintenancePojo.getBookingFormId());
		accSummaryPojo.setCreatedBy(bookingFormMaintenancePojo.getCreatedBy());
		if(!listOfBookingAccountSummaryDetails.isEmpty()) {
			employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
		} else {
			employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
		}
		return null;
	}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public List<Object> saveCorpusFund(EmployeeFinancialTransactionServiceInfo transactionServiceInfo) throws Exception {
		//List<FinPenaltyTaxPojo> taxDetailsList = null;
		Double CorpusFundPercentage = 0.0;
		//Long CorpusFundTaxId = 0l;
		Double CorpusFundAmount = 0.0;
		List<SiteOtherChargesDetailsPojo> siteOtherChargesDetailsList = null;
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		FinBookingFormCorpusFundPojo bookingFormMaintenancePojo = null;
		/*FinBookingFormCorpusFundDtlsPojo bookingFormMaintenanceDtlsPojo = null;
		FinBokFrmCorpusFundTaxPojo bokFrmMaintenanceTaxPojo =null;*/

		FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
		if(Util.isNotEmptyObject(transactionServiceInfo.getSiteIds())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
		} else if(Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
			finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
		}
		
		if(isNotEmptyObject(transactionServiceInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = transactionServiceInfo.getCustomerPropertyDetailsInfo();
		} else {
			EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
			employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojos = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
			if(Util.isNotEmptyObject(customerPropertyDetailsPojos)) {
				customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojos.get(0), CustomerPropertyDetailsInfo.class);
				transactionServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
			}
		}
		
		FinBookingFormAccountsInfo bookingFormAccountsInfo = new FinBookingFormAccountsInfo();
		bookingFormAccountsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormAccountsInfo.setStatusId(Status.ACTIVE.getStatus());//adding type of payment
		bookingFormAccountsInfo.setTypes(Arrays.asList(MetadataId.CORPUS_FUND.getId()));
		bookingFormAccountsInfo.setPaymentStatusList(Arrays.asList(Status.PENDING.getStatus(), Status.INPROGRESS.getStatus(), Status.PAID.getStatus()));
		//bookingFormAccountsInfo.setCondition("NOC Validation");
		
		//here loading the corpus fund Payment Details using customer FlatBookingId
		List<FinBookingFormAccountsPojo> bookingFormAccountsPojoLists = employeeFinancialServiceDao.getFinBookingFormAccountsData(bookingFormAccountsInfo);
		if(Util.isNotEmptyObject(bookingFormAccountsPojoLists)) {
			return null;// if already record exists, no need to generate records' again
		}
		
		/*  //taking maintainence percentage
			//taxDetailsList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.CORPUS_FUND.getId()));
		
		if(Util.isEmptyObject(taxDetailsList)) {
			throw new EmployeeFinancialServiceException(Arrays.asList("Please add Corpus Fund charges GST percentage..."));
		}*/
		BookingFormRequest bookingFormRequest = new BookingFormRequest();
		bookingFormRequest.setSiteId(customerPropertyDetailsInfo.getSiteId());
		bookingFormRequest.setFlatId(customerPropertyDetailsInfo.getFlatId());
		bookingFormRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormRequest.setCustomerId(customerPropertyDetailsInfo.getCustomerId());
		//loading CorpusFund master details
		siteOtherChargesDetailsList = bookingFormServiceDaoImpl.getTheSiteOtherChargesDetails(bookingFormRequest);
		//loading flat details, like sbua, carpet are
		List<FlatDetailsPojo> flatDetailsPojos = bookingFormServiceDaoImpl.getFlatDetails(bookingFormRequest);
		
		if(Util.isEmptyObject(flatDetailsPojos)) {
			throw new EmployeeFinancialServiceException("Failed to load flat details, Cananot generate transaction.");
		}
		/*//taking CorpusFund percentage
		for (FinPenaltyTaxPojo finTaxPojo : taxDetailsList) {
			if (MetadataId.CORPUS_FUND.getId().equals(finTaxPojo.getTaxType())) {
				CorpusFundPercentage = finTaxPojo.getPercentageValue();
				CorpusFundTaxId = finTaxPojo.getPercentageId();
			}
		}*/
		
		//taking maintaince amount using sbua * CorpusFund amount
		for (SiteOtherChargesDetailsPojo otherDetailsDraft : siteOtherChargesDetailsList) {
			if (otherDetailsDraft.getAmount() != null) {
				if (MetadataId.CORPUS_FUND.getId().equals(otherDetailsDraft.getMeteDataTypeId())) {
					//CorpusFundAmount =  (flatDetailsPojos.get(0).getSbua() * otherDetailsDraft.getAmtForYears()) * otherDetailsDraft.getAmount();
					if(customerPropertyDetailsInfo.getSiteId().equals(131l)) {
						CorpusFundAmount = otherDetailsDraft.getAmount();
					} else {
						CorpusFundAmount = (flatDetailsPojos.get(0).getSbua()) * otherDetailsDraft.getAmount();
					}
					break;
				}				
			}
		}
		
		double CorpusFundGstAmount = (CorpusFundAmount * CorpusFundPercentage) / 100;
		double CorpusFundAmtWithGstAmount =  CorpusFundAmount+CorpusFundGstAmount;
		
		bookingFormMaintenancePojo = new FinBookingFormCorpusFundPojo();
		bookingFormMaintenancePojo.setBasicAmount(CorpusFundAmount);
		bookingFormMaintenancePojo.setTaxAmount(CorpusFundGstAmount);
		bookingFormMaintenancePojo.setTotalAmount(CorpusFundAmtWithGstAmount);
		bookingFormMaintenancePojo.setCreatedBy(transactionServiceInfo.getEmployeeId());
		bookingFormMaintenancePojo.setStatusId(Status.ACTIVE.getStatus());
		bookingFormMaintenancePojo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
		bookingFormMaintenancePojo = employeeFinancialServiceDao.saveCorpusFund(bookingFormMaintenancePojo);
		
		/*bookingFormMaintenanceDtlsPojo = financialMapper.constructCorpusFundDetailsPojo(bookingFormMaintenancePojo,transactionServiceInfo);
		bookingFormMaintenanceDtlsPojo = employeeFinancialServiceDao.saveCorpusFundDetails(bookingFormMaintenanceDtlsPojo);*/		

		/*bokFrmMaintenanceTaxPojo = financialMapper.constructCorpusFundTaxPojo(bookingFormMaintenanceDtlsPojo,CorpusFundTaxId);
		bokFrmMaintenanceTaxPojo = employeeFinancialServiceDao.saveCorpusFundTaxData(bokFrmMaintenanceTaxPojo);*/
		
		FinBookingFormAccountsPojo accountsPojo = financialMapper.constructCorpusFundAccoutsRecord(bookingFormMaintenancePojo);
		employeeFinancialServiceDao.saveFinBookingFormAccounts(accountsPojo);
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo2.setType(MetadataId.CORPUS_FUND.getId());
		customerPropertyDetailsInfo2.setFlatBookingId(bookingFormMaintenancePojo.getBookingFormId());
		List<FinBookingFormAccountSummaryPojo> listOfBookingAccountSummaryDetails = employeeFinancialServiceDao.getFlatBookingDetails(customerPropertyDetailsInfo2);

		FinBookingFormAccountSummaryPojo accSummaryPojo = new FinBookingFormAccountSummaryPojo();
		accSummaryPojo.setType(MetadataId.CORPUS_FUND.getId());
		accSummaryPojo.setStatusId(Status.ACTIVE.getStatus());
		accSummaryPojo.setPayableAmount(bookingFormMaintenancePojo.getTotalAmount());
		accSummaryPojo.setBalanceAmount(bookingFormMaintenancePojo.getTotalAmount());
		accSummaryPojo.setBookingFormId(bookingFormMaintenancePojo.getBookingFormId());
		accSummaryPojo.setCreatedBy(bookingFormMaintenancePojo.getCreatedBy());
		if(!listOfBookingAccountSummaryDetails.isEmpty()) {
			employeeFinancialServiceDao.updateBookingFormAccountSummary(accSummaryPojo);
		} else {
			employeeFinancialServiceDao.saveBookingFormAccountSummary(accSummaryPojo);
		}
		return null;
	}

	
	public List<InvoiceDocumentLocationPojo> getInvoiceDocumentLocationPojoList(List<FileInfo> fileInfoList, 
		List<EmployeeFinancialTransactionResponse> employeeFinancialTransactionResponseList, MetadataId metaData) {
		log.info("*** The control is inside the getInvoiceDocumentLocationPojoList in EmployeeFinancialServiceImpl ***");
		List<InvoiceDocumentLocationPojo> invoiceDocumentLocationPojoList = new ArrayList<>();
		int count=0;
		for(EmployeeFinancialTransactionResponse employeeFinancialTransactionResponse : employeeFinancialTransactionResponseList) {
			FileInfo fileInfo = fileInfoList.get(count);
			InvoiceDocumentLocationPojo invoiceDocumentLocationPojo = new InvoiceDocumentLocationPojo();
			invoiceDocumentLocationPojo.setCreatedBy(employeeFinancialTransactionResponse.getEmployeeId());
			invoiceDocumentLocationPojo.setDocName(fileInfo.getName());
			invoiceDocumentLocationPojo.setDocLocation(fileInfo.getFilePath());
			invoiceDocumentLocationPojo.setDocPath(fileInfo.getUrl());
			invoiceDocumentLocationPojo.setType(metaData.getId());
			if(metaData.getName().equalsIgnoreCase(MetadataId.LEGAL_COST.getName())) {
				FinBookingFormLegalCostResponse	finBookingFormLegalCostResponse = employeeFinancialTransactionResponse.getFinBookingFormLegalCostPdfResponse().getFinBookingFormLegalCostResponse();
				invoiceDocumentLocationPojo.setTypeId(finBookingFormLegalCostResponse.getFinBokFrmLegalCostId());
			}else if(metaData.getName().equalsIgnoreCase(MetadataId.MODIFICATION_COST.getName())) {
				FinBookingFormModiCostResponse finBookingFormModiCostResponse = employeeFinancialTransactionResponse.getFinBookingFormModiCostResponse();
				invoiceDocumentLocationPojo.setTypeId(finBookingFormModiCostResponse.getFinBookingFormModiCostId());
			}else {
				invoiceDocumentLocationPojo.setTypeId(0l);
			}
			invoiceDocumentLocationPojoList.add(invoiceDocumentLocationPojo);
		}
		return invoiceDocumentLocationPojoList;
	}

	@Override
	public List<FlatBookingInfo> getCustomerDetailsAndPendingAmounts(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) {
		//log.info("*** The control is inside the getCustomerDetailsAndPendingAmounts in EmployeeFinancialServiceImpl ***");
		List<FlatBookingPojo> flatBookingPojoList = employeeFinancialServiceDao.getCustomerDetailsAndPendingAmounts(employeeFinancialServiceInfo);
		List<FlatBookingInfo> flatBookingInfoList = financialMapper.flatBookingPojoListToFlatBookingInfoList(flatBookingPojoList);
		/* arranging flat No, customer Name and pending Amount in form */
		for(FlatBookingInfo flatBookingInfo : flatBookingInfoList) {
			flatBookingInfo.setPendingAmountDetails(flatBookingInfo.getFlatNo()+"/"+flatBookingInfo.getCustName()+"/Rs."+flatBookingInfo.getPendingAmount());
		}
		return flatBookingInfoList;
	}

	@Override
	public List<FinBookingFormExcessAmountResponse> getExcessAmountDetailsForRefund(EmployeeFinancialTransactionServiceInfo employeeFinancialTransactionServiceInfo) {
		//log.info("*** The control is inside the getExcessAmountDetailsForRefund in EmployeeFinancialServiceImpl ***");
		List<FinBookingFormExcessAmountPojo> finBookingFormExcessAmountPojoList = employeeFinancialServiceDao.getExcessAmountDetailsForRefund(employeeFinancialTransactionServiceInfo);
		List<FinBookingFormExcessAmountResponse> finBookingFormExcessAmountResponseList = financialMapper.finBookingFormExcessAmountPojoListToFinBookingFormExcessAmountResponseList(finBookingFormExcessAmountPojoList);
		return finBookingFormExcessAmountResponseList;
	}

	@Override
	public List<Map<String, Object>> getNonRefundFlats(EmployeeFinancialRequest employeeFinancialRequest) {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getNonRefundFlats() *****");
		List<Map<String, Object>> list = employeeFinancialServiceDao.getNonRefundFlats(employeeFinancialRequest);
		return list;
	}

	@Override
	public List<FileInfo> getTempInterestCalculation(
			EmployeeFinancialServiceInfo employeeFinancialRequestToemployeeFinancialInfo, HashMap<Long, Long> hashMap,
			String string, HashMap<Long, List<FinancialProjectMileStonePojo>> hashMap2) {
		 
		return null;
	}

	@Override
	public EmployeeFinancialResponse generateConsolidatedReceipt(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) throws Exception {
		log.info("***** Control is inside the generateConsolidatedReceipt in EmployeeFinancialServiceImpl *****");
		EmployeeFinancialResponse employeeFinancialResponse = new EmployeeFinancialResponse();
		/* Getting Customer Details based on Flat Book Id */
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerDetails(employeeFinancialServiceInfo);
		/* Getting Co-applicant Details based on Flat Book Id */
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo.setFlatBookingId(employeeFinancialServiceInfo.getBookingFormId());
		customerPropertyDetailsInfo.setActionUrl("All");
		List<CoApplicantPojo> coApplicantPojoList = employeeFinancialServiceDao.getCoApplicantDetails(customerPropertyDetailsInfo);
		/* Getting Site Address Details */
		if(Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0)) 
				&& Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0).getSiteId())) {
			employeeFinancialServiceInfo.setSiteIds(Arrays.asList(customerPropertyDetailsPojoList.get(0).getSiteId()));
			employeeFinancialServiceInfo.setSiteId(customerPropertyDetailsPojoList.get(0).getSiteId());
			customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
			employeeFinancialServiceInfo.setCustomerPropertyDetailsInfo(customerPropertyDetailsInfo);
		} else {
			employeeFinancialServiceInfo.setSiteIds(Arrays.asList(0l));
		}
		//List<AddressPojo> siteAddressPojoList = employeeFinancialServiceDao.getSiteAddressDetails(employeeFinancialServiceInfo);
		
		/* getting Office_Details *///List<OfficeDtlsResponse> 
		List<OfficeDtlsPojo> officeDetailsPojoList = employeeFinancialServiceDao.getOfficeDetailsBySite(employeeFinancialServiceInfo);
		List<OfficeDtlsResponse> officeDetailsResponseList = financialMapper.officeDetailsPojoListToOfficeDetailsResponseList(officeDetailsPojoList);
		
		Set<FinConsolidatedReceiptInfo> ledgerInfos = new HashSet<FinConsolidatedReceiptInfo>();
		List<FinConsolidatedReceiptInfo> creditCustomerLedgerInfos = new ArrayList<FinConsolidatedReceiptInfo>();
		
		FinTransactionEntryDetailsInfo transactionEntryDetailsInfo = new FinTransactionEntryDetailsInfo();
		transactionEntryDetailsInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());

		//List<FinConsolidatedReceiptInfo> receiptTransactionDetailsInfos = getReceiptTransactionDetails();
		
		//loading all the Milestone receipt Data
		transactionEntryDetailsInfo.setCondition(MetadataId.CUSTOMER_LEDGER.getName());//here loading all the completed transactions
		List<FinTransactionEntryDetailsPojo> receiptDetailsList = employeeFinancialServiceDao.getTransactionDetailsConsolidatedReceipt(transactionEntryDetailsInfo);
		
		transactionEntryDetailsInfo.setCondition("LoadNonCompletedTransactions");//here loading non completed transactions
		List<FinTransactionEntryDetailsPojo> inCompleteReceiptDetailsList = employeeFinancialServiceDao.getTransactionDetailsConsolidatedReceipt(transactionEntryDetailsInfo);

		transactionEntryDetailsInfo.setCondition("loadExcessAmountReceiptDetailsList");//here loading all the excess amount against flat
		List<FinTransactionEntryDetailsPojo> loadExcessAmountReceiptDetailsList = employeeFinancialServiceDao.getTransactionDetailsConsolidatedReceipt(transactionEntryDetailsInfo);
		
		//loading all the Milestone payment Data
		transactionEntryDetailsInfo.setCondition("LoadPaymentTrn");//here loading payment refund flats
		List<FinTransactionEntryDetailsPojo> paymentDetailsList = employeeFinancialServiceDao.getTransactionDetailsConsolidatedReceipt(transactionEntryDetailsInfo);

		List<Long> receiptExcessAmountLoaded = new ArrayList<>();
		//holding transaction gst amount using transaction id
		//bcoz same transaction can be adjusted to multiple milestones, so every milestone has GST percentage
		Map<Long,Double> holdGSTAmount = new HashMap<>();
		Map<Long,Double> holdSetOffAmount = new HashMap<>();
		
		double gstAmount = 0.0;
		double prevGstAmount  = 0.0;
		double prevSetOffAmt = 0.0;
		double cgstAmount = 0.0;
		double sgstAmount = 0.0;
		//List<FinConsolidatedReceiptInfo> debitCustomerLedgerInfos = new ArrayList<FinConsolidatedReceiptInfo>();

		if(receiptDetailsList!=null) {
			for (int index = 0; index < receiptDetailsList.size(); index++) {
				FinTransactionEntryDetailsPojo trnEntryDetailsPojo = receiptDetailsList.get(index);
				double excessAmount = 0d;
				Double setOffAmount = Util.isEmptyObject(trnEntryDetailsPojo.getActualPaidAmount())?0.0:trnEntryDetailsPojo.getActualPaidAmount();
				FinConsolidatedReceiptInfo customerLedgerInfo = new FinConsolidatedReceiptInfo();
				if(trnEntryDetailsPojo.getTransactionSetOffEntryId().equals(13721l)) {
					customerPropertyDetailsInfo.setCondition("PaymentRefund");
				}
				if(!receiptExcessAmountLoaded.contains(trnEntryDetailsPojo.getTransactionSetOffEntryId())) {
					//loading exess amount if exists
					customerPropertyDetailsInfo.setCondition("PaymentRefund");
					customerPropertyDetailsInfo.setTypeId(null);
					customerPropertyDetailsInfo.setTransactionSetOffEntryId(trnEntryDetailsPojo.getTransactionSetOffEntryId());
					List<FinBookingFormExcessAmountPojo> listOfExcessAmount = employeeFinancialServiceDao.getExcessAmountDetails(customerPropertyDetailsInfo,Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId()));
					if(Util.isNotEmptyObject(listOfExcessAmount)) {
						if(Util.isNotEmptyObject(listOfExcessAmount.get(0).getExcessAmount())) {
							excessAmount += listOfExcessAmount.get(0).getExcessAmount();
						}
					}	
				}
				receiptExcessAmountLoaded.add(trnEntryDetailsPojo.getTransactionSetOffEntryId());
				
				customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
				customerPropertyDetailsInfo.setTypeId(trnEntryDetailsPojo.getTypeId());
				//loading scheme percentages
				List<FinBokFrmDemNteSchTaxMapPojo> demandNoteSchemeTaxDetailsList = employeeFinancialServiceDao.getMileStoneTaxDetails1(customerPropertyDetailsInfo);
				
				setOffAmount = BigDecimal.valueOf(Double.valueOf(setOffAmount)+excessAmount).setScale(roundingModeSize, roundingMode).doubleValue();

				gstAmount = getGSTAmountForConsolidatedRecipt(demandNoteSchemeTaxDetailsList,customerPropertyDetailsInfo,setOffAmount);
				
				customerLedgerInfo.setTransactionEntryId(trnEntryDetailsPojo.getTransactionEntryId());
				customerLedgerInfo.setTransactionTypeId(trnEntryDetailsPojo.getTransactionTypeId());
				customerLedgerInfo.setTransactionStatusId(trnEntryDetailsPojo.getTransactionStatusId());
				customerLedgerInfo.setChequeOrReferenceNo(trnEntryDetailsPojo.getChequeOrReferenceNo());
				customerLedgerInfo.setTransactionDate(trnEntryDetailsPojo.getTransactionDate());
				customerLedgerInfo.setTransactionReceiveDate(trnEntryDetailsPojo.getTransactionReceiveDate());
				
				customerLedgerInfo.setDate(trnEntryDetailsPojo.getTransactionReceiveDate());
				customerLedgerInfo.setCreatedDate(trnEntryDetailsPojo.getTrnCreationDate());
				customerLedgerInfo.setTransactionTypeName(trnEntryDetailsPojo.getTransactionTypeName());
				customerLedgerInfo.setTransactionReceiptNo(trnEntryDetailsPojo.getTransactionReceiptNo());
				customerLedgerInfo.setSetOffAmount(setOffAmount);
				customerLedgerInfo.setPrincipalAmount(setOffAmount-gstAmount);
				customerLedgerInfo.setGstAmount(gstAmount);
				
				prevGstAmount = holdGSTAmount.get(trnEntryDetailsPojo.getTransactionEntryId())==null?0d:holdGSTAmount.get(trnEntryDetailsPojo.getTransactionEntryId());
				holdGSTAmount.put(trnEntryDetailsPojo.getTransactionEntryId(), prevGstAmount+gstAmount);
				
				prevSetOffAmt = holdSetOffAmount.get(trnEntryDetailsPojo.getTransactionEntryId())==null?0d:holdSetOffAmount.get(trnEntryDetailsPojo.getTransactionEntryId());
				holdSetOffAmount.put(trnEntryDetailsPojo.getTransactionEntryId(), setOffAmount+prevSetOffAmt);
				
				creditCustomerLedgerInfos.add(customerLedgerInfo);
			}
		}

		List<Long> inCompleteReceiptIds = new ArrayList<>();
		inCompleteReceiptDetailsList.addAll(loadExcessAmountReceiptDetailsList);
		if(inCompleteReceiptDetailsList!=null) {
			for (int index = 0; index < inCompleteReceiptDetailsList.size(); index++) {
				FinTransactionEntryDetailsPojo trnEntryDetailsPojo = inCompleteReceiptDetailsList.get(index);
				double excessAmount = 0d;
				if(inCompleteReceiptIds.contains(trnEntryDetailsPojo.getTransactionEntryId())) {
					continue;
				}
				inCompleteReceiptIds.add(trnEntryDetailsPojo.getTransactionEntryId());
				
				Double setOffAmount = Util.isEmptyObject(trnEntryDetailsPojo.getSetOffAmount())?0.0:trnEntryDetailsPojo.getSetOffAmount();
				FinConsolidatedReceiptInfo customerLedgerInfo = new FinConsolidatedReceiptInfo();
				
				customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
				customerPropertyDetailsInfo.setTypeId(trnEntryDetailsPojo.getTypeId());
				//loading scheme percentages
				List<FinBokFrmDemNteSchTaxMapPojo> demandNoteSchemeTaxDetailsList = employeeFinancialServiceDao.getMileStoneTaxDetails1(customerPropertyDetailsInfo);
				gstAmount = getGSTAmountForConsolidatedRecipt(demandNoteSchemeTaxDetailsList,customerPropertyDetailsInfo,setOffAmount);

				setOffAmount = BigDecimal.valueOf(Double.valueOf(setOffAmount)+excessAmount).setScale(roundingModeSize, roundingMode).doubleValue();
				customerLedgerInfo.setTransactionEntryId(trnEntryDetailsPojo.getTransactionEntryId());
				customerLedgerInfo.setTransactionTypeId(trnEntryDetailsPojo.getTransactionTypeId());
				customerLedgerInfo.setTransactionStatusId(trnEntryDetailsPojo.getTransactionStatusId());
				customerLedgerInfo.setChequeOrReferenceNo(trnEntryDetailsPojo.getChequeOrReferenceNo());
				customerLedgerInfo.setTransactionDate(trnEntryDetailsPojo.getTransactionDate());
				customerLedgerInfo.setTransactionReceiveDate(trnEntryDetailsPojo.getTransactionReceiveDate());

				customerLedgerInfo.setDate(trnEntryDetailsPojo.getTransactionReceiveDate());
				customerLedgerInfo.setCreatedDate(trnEntryDetailsPojo.getTrnCreationDate());
				customerLedgerInfo.setTransactionTypeName(trnEntryDetailsPojo.getTransactionTypeName());
				customerLedgerInfo.setTransactionReceiptNo(trnEntryDetailsPojo.getTransactionReceiptNo());
				customerLedgerInfo.setSetOffAmount(setOffAmount);
				customerLedgerInfo.setPrincipalAmount(setOffAmount-gstAmount);
				customerLedgerInfo.setGstAmount(gstAmount);
				prevGstAmount = holdGSTAmount.get(trnEntryDetailsPojo.getTransactionEntryId())==null?0d:holdGSTAmount.get(trnEntryDetailsPojo.getTransactionEntryId());
				holdGSTAmount.put(trnEntryDetailsPojo.getTransactionEntryId(), prevGstAmount+gstAmount);
				
				prevSetOffAmt = holdSetOffAmount.get(trnEntryDetailsPojo.getTransactionEntryId())==null?0d:holdSetOffAmount.get(trnEntryDetailsPojo.getTransactionEntryId());
				holdSetOffAmount.put(trnEntryDetailsPojo.getTransactionEntryId(), setOffAmount+prevSetOffAmt);

				creditCustomerLedgerInfos.add(customerLedgerInfo);
			}
		}
		
		
		if(paymentDetailsList!=null) {
			for (int index = 0; index < paymentDetailsList.size(); index++) {
				FinTransactionEntryDetailsPojo trnEntryDetailsPojo = paymentDetailsList.get(index);
				Double refundAmount = Util.isEmptyObject(trnEntryDetailsPojo.getRefundAmount())?0.0:trnEntryDetailsPojo.getRefundAmount();
				double excessAmount = 0d;
				FinConsolidatedReceiptInfo customerLedgerInfo = new FinConsolidatedReceiptInfo();
				
				customerPropertyDetailsInfo.setStatusId(Status.ACTIVE.getStatus());
				customerPropertyDetailsInfo.setTypeId(trnEntryDetailsPojo.getTypeId());
				//loading scheme percentages
				List<FinBokFrmDemNteSchTaxMapPojo> demandNoteSchemeTaxDetailsList = employeeFinancialServiceDao.getMileStoneTaxDetails1(customerPropertyDetailsInfo);
				
				gstAmount = getGSTAmountForConsolidatedRecipt(demandNoteSchemeTaxDetailsList,customerPropertyDetailsInfo,refundAmount);

				refundAmount = BigDecimal.valueOf(Double.valueOf(refundAmount)+excessAmount).setScale(roundingModeSize, roundingMode).doubleValue();
				customerLedgerInfo.setTransactionEntryId(trnEntryDetailsPojo.getTransactionEntryId());
				customerLedgerInfo.setTransactionTypeId(trnEntryDetailsPojo.getTransactionTypeId());
				customerLedgerInfo.setTransactionStatusId(trnEntryDetailsPojo.getTransactionStatusId());
				customerLedgerInfo.setChequeOrReferenceNo(trnEntryDetailsPojo.getChequeOrReferenceNo());
				customerLedgerInfo.setTransactionDate(trnEntryDetailsPojo.getPaymentDate());
				customerLedgerInfo.setTransactionReceiveDate(trnEntryDetailsPojo.getPaymentDate());

				customerLedgerInfo.setDate(trnEntryDetailsPojo.getPaymentDate());//this is payment transaction for loop
				customerLedgerInfo.setCreatedDate(trnEntryDetailsPojo.getTrnCreationDate());
				customerLedgerInfo.setTransactionTypeName(trnEntryDetailsPojo.getTransactionTypeName());
				customerLedgerInfo.setTransactionReceiptNo(trnEntryDetailsPojo.getTransactionReceiptNo());
				customerLedgerInfo.setSetOffAmount(refundAmount);

				customerLedgerInfo.setPrincipalAmount(refundAmount-gstAmount);
				customerLedgerInfo.setGstAmount(gstAmount);

				prevGstAmount = holdGSTAmount.get(trnEntryDetailsPojo.getTransactionEntryId())==null?0d:holdGSTAmount.get(trnEntryDetailsPojo.getTransactionEntryId());
				holdGSTAmount.put(trnEntryDetailsPojo.getTransactionEntryId(), prevGstAmount+gstAmount);
				
				prevSetOffAmt = holdSetOffAmount.get(trnEntryDetailsPojo.getTransactionEntryId())==null?0d:holdSetOffAmount.get(trnEntryDetailsPojo.getTransactionEntryId());
				holdSetOffAmount.put(trnEntryDetailsPojo.getTransactionEntryId(), refundAmount+prevSetOffAmt);

				creditCustomerLedgerInfos.add(customerLedgerInfo);
			}
		}		
		
		//System.out.println(creditCustomerLedgerInfos);
	    ledgerInfos = new HashSet<>(creditCustomerLedgerInfos);
	    creditCustomerLedgerInfos = new ArrayList<>(ledgerInfos);
	    
		Collections.sort(creditCustomerLedgerInfos, new Comparator<FinConsolidatedReceiptInfo>() {
			@Override
			public int compare(FinConsolidatedReceiptInfo o1, FinConsolidatedReceiptInfo o2) {

				if (o1 == null || o2 == null) {
					return 0;
				}

				if (o1.getDate() == null) {
					return 0;
				}

				if (o2.getDate() == null) {
					return 1;
				}

				try {
					//log.info("O1 "+o1.getDate()+"  O2 "+(o2.getDate()) +" "+o1.getCreatedDate()+" "+o2.getCreatedDate());
					if (TimeUtil.removeTimePartFromTimeStamp1(o1.getDate()).equals(TimeUtil.removeTimePartFromTimeStamp1(o2.getDate()))) {
						 
						return o1.getTransactionEntryId().compareTo(o2.getTransactionEntryId());
					} else if (TimeUtil.removeTimePartFromTimeStamp1(o1.getDate()).after(TimeUtil.removeTimePartFromTimeStamp1(o2.getDate()))) {
						return 1;
					} else {
						return -1;
					}
				} catch (Exception e) {
					return 0;
				}
			}	
		});
		
		for (FinConsolidatedReceiptInfo finConsolidatedReceiptInfo : creditCustomerLedgerInfos) {
			finConsolidatedReceiptInfo.getTransactionEntryId();
			double setOffAmount = holdSetOffAmount.get(finConsolidatedReceiptInfo.getTransactionEntryId())==null?0d:holdSetOffAmount.get(finConsolidatedReceiptInfo.getTransactionEntryId());

			gstAmount = holdGSTAmount.get(finConsolidatedReceiptInfo.getTransactionEntryId())==null?0d:holdGSTAmount.get(finConsolidatedReceiptInfo.getTransactionEntryId());
			cgstAmount = roundOffAmount(gstAmount/2);
			sgstAmount = roundOffAmount(gstAmount/2);
			
			finConsolidatedReceiptInfo.setSetOffAmount(setOffAmount);
			finConsolidatedReceiptInfo.setPrincipalAmount(setOffAmount-gstAmount);
			finConsolidatedReceiptInfo.setGstAmount(gstAmount);
			finConsolidatedReceiptInfo.setCgstAmount(cgstAmount);
			finConsolidatedReceiptInfo.setSgstAmount(sgstAmount);	
		}
		
		//System.out.println();
		/*for (FinConsolidatedReceiptInfo finConsolidatedReceiptInfo : creditCustomerLedgerInfos) {
			//System.out.println(finConsolidatedReceiptInfo);	
		}*/
		
		/* Getting Transaction Details Received, Payment and Check Bounce */
		//List<FinTransactionEntryDetailsPojo> finTransactionEntryDetailsPojoList = employeeFinancialServiceDao.getTransactionDetailsConsolidatedReceipt(employeeFinancialServiceInfo);
		
		/* Setting all Pojos to FinancialConsolidatedReceiptInfo */
		FinancialConsolidatedReceiptInfo financialConsolidatedReceiptInfo = new FinancialConsolidatedReceiptInfo();
		financialConsolidatedReceiptInfo.setCustomerPropertyDetailsPojoList(customerPropertyDetailsPojoList);
		financialConsolidatedReceiptInfo.setCoApplicantPojoList(coApplicantPojoList);
		//financialConsolidatedReceiptInfo.setSiteAddressPojoList(siteAddressPojoList);
		financialConsolidatedReceiptInfo.setOfficeDetailsList(officeDetailsResponseList);
		
		//loadCustomerDetails(response1, employeeFinancialServiceInfo, customerPropertyDetailsInfo);
		
		//getTotalAmountsForConsolidatedReceipt(financialConsolidatedReceiptInfo,receiptDetailsList,customerPropertyDetailsPojoList);
		
		getTotalAmountsForConsolidatedReceipt(creditCustomerLedgerInfos,financialConsolidatedReceiptInfo,customerPropertyDetailsPojoList);
		
		List<FileInfo> fileInfoList = employeeFinancialHelper.generateConsolidatedReceipt(financialConsolidatedReceiptInfo, employeeFinancialServiceInfo);
		employeeFinancialResponse.setFileInfoList(fileInfoList);
		return employeeFinancialResponse;
	}

	private void getTotalAmountsForConsolidatedReceipt(List<FinConsolidatedReceiptInfo> creditCustomerLedgerInfos,
			FinancialConsolidatedReceiptInfo financialConsolidatedReceiptInfo, List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList) {
		log.info("***** Control is inside the getTotalAmountsForConsolidatedReceipt in EmployeeFinancialServiceImpl *****");
		Double totalPaidAmount = 0.0;
		Double totalFlatCost = 0.0;
		
		Double totalPrincipalAmount = 0.0;
		Double totalCgstAmount = 0.0;
		Double totalSgstAmount = 0.0;
		Double totalAmount = 0.0;
		
		Double totalBouncePrincipalAmount = 0.0;
		Double totalBounceCgstAmount = 0.0;
		Double totalBounceSgstAmount = 0.0;
		Double totalBounceAmount = 0.0;
		
		List<FinConsolidatedReceiptInfo> finCompletedTransactionsList = new ArrayList<>();
		List<FinConsolidatedReceiptInfo> finBouncedTransactionsList = new ArrayList<>();
		for(FinConsolidatedReceiptInfo transactionEntryDetails : creditCustomerLedgerInfos) {
			if(Util.isNotEmptyObject(transactionEntryDetails) && Util.isNotEmptyObject(transactionEntryDetails.getSetOffAmount())
				&& Util.isNotEmptyObject(transactionEntryDetails.getTransactionStatusId()) && Util.isNotEmptyObject(transactionEntryDetails.getTransactionTypeId())) {
				/* For Received and Refund Amounts */
				if(transactionEntryDetails.getTransactionStatusId().equals(Status.TRANSACTION_COMPLETED.getStatus())) {
					/* Receipt */
					if(transactionEntryDetails.getTransactionTypeId() == 1) {
						transactionEntryDetails.setTransactionStatusName("Received");
						totalPaidAmount += transactionEntryDetails.getSetOffAmount();
						
						totalPrincipalAmount += transactionEntryDetails.getPrincipalAmount();
						totalCgstAmount += transactionEntryDetails.getCgstAmount();
						totalSgstAmount += transactionEntryDetails.getSgstAmount();
						totalAmount += transactionEntryDetails.getSetOffAmount();
					/* Payment */
					} else if(transactionEntryDetails.getTransactionTypeId() == 2) {
						transactionEntryDetails.setTransactionStatusName("Refund");
						
						totalPaidAmount -= transactionEntryDetails.getSetOffAmount();
						
						totalPrincipalAmount -= transactionEntryDetails.getPrincipalAmount();
						totalCgstAmount -= transactionEntryDetails.getCgstAmount();
						totalSgstAmount -= transactionEntryDetails.getSgstAmount();
						totalAmount -= transactionEntryDetails.getSetOffAmount();
						
					}
					finCompletedTransactionsList.add(transactionEntryDetails);
				}else if(transactionEntryDetails.getTransactionStatusId().equals(Status.CHEQUE_BOUNCED.getStatus())) {
					transactionEntryDetails.setTransactionStatusName("Bounce");
					finBouncedTransactionsList.add(transactionEntryDetails);
					
					totalBouncePrincipalAmount += transactionEntryDetails.getPrincipalAmount();
					totalBounceCgstAmount += transactionEntryDetails.getCgstAmount();
					totalBounceSgstAmount += transactionEntryDetails.getSgstAmount();
					totalBounceAmount += transactionEntryDetails.getSetOffAmount();
					
				}
			}
		}
		if(Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0)) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0).getFlatCost())) {
			totalFlatCost = customerPropertyDetailsPojoList.get(0).getFlatCost();
		}
		financialConsolidatedReceiptInfo.setTotalFlatCost(totalFlatCost);
		financialConsolidatedReceiptInfo.setBalanceOnTotalCost(totalFlatCost-totalPaidAmount);
		financialConsolidatedReceiptInfo.setTotalPaidAmount(totalPaidAmount);
		
		financialConsolidatedReceiptInfo.setTotalPrincipalAmount(totalPrincipalAmount);
		financialConsolidatedReceiptInfo.setTotalCgstAmount(totalCgstAmount);
		financialConsolidatedReceiptInfo.setTotalSgstAmount(totalSgstAmount);
		financialConsolidatedReceiptInfo.setTotalAmount(totalAmount);
		
		
		financialConsolidatedReceiptInfo.setTotalBouncePrincipalAmount(totalBouncePrincipalAmount);
		financialConsolidatedReceiptInfo.setTotalBounceCgstAmount(totalBounceCgstAmount);
		financialConsolidatedReceiptInfo.setTotalBounceSgstAmount(totalBounceSgstAmount);
		financialConsolidatedReceiptInfo.setTotalBounceAmount(totalBounceAmount);
		
		
		financialConsolidatedReceiptInfo.setFinCompletedTransactionsList(finCompletedTransactionsList);
		financialConsolidatedReceiptInfo.setFinBouncedTransactionsList(finBouncedTransactionsList);
		
		//System.out.println(finCompletedTransactionsList);
		//System.out.println(finBouncedTransactionsList);
	}

	private double getGSTAmountForConsolidatedRecipt(List<FinBokFrmDemNteSchTaxMapPojo> demandNoteSchemeTaxDetailsList
			,CustomerPropertyDetailsInfo customerPropertyDetailsInfo,Double setOffAmount) throws Exception {
		double gstAmount = 0.0;
		double gstPercentage = 0.0;
		double otherThanGstAmount = 0.0;
		List<FinBookingFormMstSchTaxMapInfo> bookingFormMstSchTaxMapInfos = new EmployeeFinancialMapper().copyFinBokFrmDemNteSchTaxMapPojoTOFinBookingFormMstSchTaxMapInfo(demandNoteSchemeTaxDetailsList);
		
 		if(Util.isNotEmptyObject(bookingFormMstSchTaxMapInfos)) {
 			for (FinBookingFormMstSchTaxMapInfo bokFrmDemNteSchTaxMapInfo : bookingFormMstSchTaxMapInfos) {
 				if(Util.isNotEmptyObject(bokFrmDemNteSchTaxMapInfo.getTaxTypeId()) && bokFrmDemNteSchTaxMapInfo.getTaxTypeId().equals(MetadataId.GST.getId())) {
 					gstPercentage = bokFrmDemNteSchTaxMapInfo.getPercentageValue();
 				} else {
 					otherThanGstAmount = bokFrmDemNteSchTaxMapInfo.getBasicAmount();
 				}
			}
 		} else {
 			EmployeeFinancialServiceInfo employeeFinancialInfo = new EmployeeFinancialServiceInfo();
 			employeeFinancialInfo.setBlockIds(Arrays.asList(customerPropertyDetailsInfo.getBlockId()));
 			employeeFinancialInfo.setBookingFormId(customerPropertyDetailsInfo.getFlatBookingId());
 			employeeFinancialInfo.setSiteId(customerPropertyDetailsInfo.getSiteId());
 			List<FinancialProjectMileStonePojo> generatedMileStonePojoList = employeeFinancialServiceDao.getGeneratedMilestoneDetailsOfFlat(employeeFinancialInfo,FinEnum.LOAD_BY_MILESTONE.getId());
 			customerPropertyDetailsInfo.setCondition("");
 			FinancialProjectMileStonePojo objectDetailsForExcessAmount = new FinancialProjectMileStonePojo(); 
 			FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
 			if(Util.isNotEmptyObject(generatedMileStonePojoList)) {
 				for (int index1 = 0; index1 < generatedMileStonePojoList.size(); index1++) {
 					FinancialProjectMileStonePojo object = generatedMileStonePojoList.get(index1);
 						if(object.getMsStatusId()!=null && object.getMsStatusId().equals(Status.ACTIVE.getStatus())) {
 							objectDetailsForExcessAmount = object;
 						}
 					 }
 				finProjDemandNoteInfo.setMilestoneDate(objectDetailsForExcessAmount.getMilestoneDate()==null?objectDetailsForExcessAmount.getMilestoneDemandNoteDate():objectDetailsForExcessAmount.getMilestoneDate());
 			}
 			if(Util.isEmptyObject(finProjDemandNoteInfo.getMilestoneDate())) {//if milestone found empty then take booking date  
 				finProjDemandNoteInfo.setMilestoneDate(customerPropertyDetailsInfo.getBookingDate());
			 }
 			List<FinSchemeTaxMappingPojo> schemeTaxDetails = null;
 			//loading scheme details if not exists
 			schemeTaxDetails = employeeFinancialServiceDao.getFlatBookDetailsSchemeTaxDetails(customerPropertyDetailsInfo,finProjDemandNoteInfo);

 			for (FinSchemeTaxMappingPojo schemeDetails : schemeTaxDetails) {
 				if(Util.isNotEmptyObject(schemeDetails.getTaxTypeId()) && schemeDetails.getTaxTypeId().equals(MetadataId.GST.getId())) {
 					gstPercentage = schemeDetails.getPercentageValue();
 				}
			}
 		}

 		//calculating GST amount on set off amount
		gstAmount = (( gstPercentage/(gstPercentage+100))*(setOffAmount-otherThanGstAmount));//(mileStonePojo.getSetOffAmount()-otherThanGstAmount)
		return gstAmount;
	}

	@Override
	public Map<String, List<Map<String, Object>>> generateClosingBalance(EmployeeFinancialServiceInfo employeeFinancialServiceInfo) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.generateClosingBalance() *****");
		//EmployeeFinancialResponse employeeFinancialResponse = new EmployeeFinancialResponse();

		//@SuppressWarnings("unused")
		List<FinClosingBalanceReportPojo> balanceReportPojos = null;
		balanceReportPojos = employeeFinancialServiceDao.getClosingBalanceReportDetails(employeeFinancialServiceInfo);
		for (FinClosingBalanceReportPojo finClosingBalanceReportPojo : balanceReportPojos) {
			double totalAmountPaid = finClosingBalanceReportPojo.getTotalAmountPaid()==null?0d:finClosingBalanceReportPojo.getTotalAmountPaid();
			double totalExcessAmount = finClosingBalanceReportPojo.getExcessAmount()==null?0d:finClosingBalanceReportPojo.getExcessAmount();
			double totalPendingAmountAsPerWorkCompletion = finClosingBalanceReportPojo.getTotalPendingAmountAsPerWorkCompletion()==null?0d:finClosingBalanceReportPojo.getTotalPendingAmountAsPerWorkCompletion();
			finClosingBalanceReportPojo.setTotalAmountPaid(totalAmountPaid+totalExcessAmount);
			finClosingBalanceReportPojo.setTotalPendingAmountAsPerWorkCompletion(totalPendingAmountAsPerWorkCompletion);
		}
		
		Map<String, List<Map<String, Object>>> closingBalanceData = employeeFinancialHelper.generateClosingBalanceReport(balanceReportPojos, employeeFinancialServiceInfo);
		//employeeFinancialResponse.setFileInfoList(fileInfoList);
		return closingBalanceData;
	}
	
	@SuppressWarnings("unused")
	private void getTotalAmountsForConsolidatedReceipt132(FinancialConsolidatedReceiptInfo financialConsolidatedReceiptInfo,List<FinTransactionEntryDetailsPojo> finTransactionEntryDetailsPojoList,
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList) {/*
		log.info("***** Control is inside the getTotalAmountsForConsolidatedReceipt in EmployeeFinancialServiceImpl *****");
		Double totalPaidAmount = 0.0;
		Double totalFlatCost = 0.0;
		Double totalPrincipalAmount = 0.0;
		Double totalCgstAmount = 0.0;
		Double totalSgstAmount = 0.0;
		Double totalAmount = 0.0;
		Double totalBouncePrincipalAmount = 0.0;
		Double totalBounceCgstAmount = 0.0;
		Double totalBounceSgstAmount = 0.0;
		Double totalBounceAmount = 0.0;
		List<FinTransactionEntryDetailsPojo> finCompletedTransactionsList = new ArrayList<>();
		List<FinTransactionEntryDetailsPojo> finBouncedTransactionsList = new ArrayList<>();
		for(FinTransactionEntryDetailsPojo finTransactionEntryDetailsPojo : finTransactionEntryDetailsPojoList) {
			if(Util.isNotEmptyObject(finTransactionEntryDetailsPojo) && Util.isNotEmptyObject(finTransactionEntryDetailsPojo.getSetOffAmount())
				&& Util.isNotEmptyObject(finTransactionEntryDetailsPojo.getTransactionStatusId()) && Util.isNotEmptyObject(finTransactionEntryDetailsPojo.getTransactionTypeId())) {
				 For Received and Refund Amounts 
				if(finTransactionEntryDetailsPojo.getTransactionStatusId() == Status.TRANSACTION_COMPLETED.getStatus()) {
					 Receipt 
					if(finTransactionEntryDetailsPojo.getTransactionTypeId() == 1) {
						finTransactionEntryDetailsPojo.setTransactionStatusName("Received");
						totalPaidAmount += finTransactionEntryDetailsPojo.getSetOffAmount();
					 Payment 
					}else if(finTransactionEntryDetailsPojo.getTransactionTypeId() == 2) {
						finTransactionEntryDetailsPojo.setTransactionStatusName("Refund");
					}
					finCompletedTransactionsList.add(finTransactionEntryDetailsPojo);
				}else if(finTransactionEntryDetailsPojo.getTransactionStatusId() == Status.CHEQUE_BOUNCED.getStatus()) {
					finTransactionEntryDetailsPojo.setTransactionStatusName("Bounce");
					finBouncedTransactionsList.add(finTransactionEntryDetailsPojo);
					totalBounceAmount += finTransactionEntryDetailsPojo.getSetOffAmount();
				}
			}
		}
		if(Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0)) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0).getFlatCost())) {
			totalFlatCost = customerPropertyDetailsPojoList.get(0).getFlatCost();
		}
		financialConsolidatedReceiptInfo.setTotalFlatCost(totalFlatCost);
		financialConsolidatedReceiptInfo.setBalanceOnTotalCost(totalFlatCost-totalPaidAmount);
		financialConsolidatedReceiptInfo.setFinCompletedTransactionsList(finCompletedTransactionsList);
		financialConsolidatedReceiptInfo.setFinBouncedTransactionsList(finBouncedTransactionsList);
	*/}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public List<Map<String, Object>> deleteUploadedAttachments(EmployeeFinancialRequest employeeFinancialRequest) {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.deleteUploadedAttachments() *****");
		if (Util.isNotEmptyObject(employeeFinancialRequest.getFileInfos())) {
			for (FileInfo fileInfo : employeeFinancialRequest.getFileInfos()) {
				if (fileInfo.getFilePath()!=null && fileInfo.getId()!=null) {
					int result = employeeFinancialServiceDao.inActiveUploadedAttachmetns(fileInfo);
					System.out.println(result);
					//String filePathToDelete = fileInfo.getFilePath();
					//File file = new File(filePathToDelete);
					//file.delete();
				}
			}
		}
		
		return null;
	}
	
    @Override	
    public List<FinModificationInvoicePojo> getPendingModificationInvoices( EmployeeFinancialRequest employeeFinancialRequest) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getPendingModificationInvoices() *****");
		List<Long> listOfApprovalId = employeeFinancialServiceDao.getNextApprovalLevelId(employeeFinancialRequest);
		if (Util.isEmptyObject(listOfApprovalId)) {
			throw new EmployeeFinancialServiceException("approvalLevelIdFoundNull");
		}
			
	    employeeFinancialRequest.setFinsetOffAppLevelId(null);
		List<FinModificationInvoicePojo> list= employeeFinancialServiceDao.getPendingModificationInvoices(employeeFinancialRequest,listOfApprovalId);
		List<FinModificationInvoicePojo> objects=financialMapper.EmployeeFinancialRequestToEmployeeFinancialRequest(list) ;
		return objects;
	}

	@Override
	public void sendFinancialInterestUpdateEmail(EmployeeFinancialRequest employeeFinancialRequest) throws Exception {
		//financialScheduler.scheduleFixedRateTaskAsync();
		excelTransactionScheduler.generateTransactionExcelSendEmail();
	}
	
	/**
	 * Using the method for agreement draft and cost break-up letter
	 */
	@Override
	public List<MileStoneInfo> getFinancialMilestoneDetails(EmployeeFinancialServiceInfo employeeFinancialDemandNoteInfo) throws Exception {
	//	Double previousgst = 0.0;
		Double totalAmount = 0.0;
		Double totalAmountExludGST = 0.0;
		boolean isSchemeFound = false;
		List<MileStoneInfo> mileStones = new ArrayList<>();
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo = null;
		BookingFormRequest bookingFormRequest= new BookingFormRequest();
		FlatCostPojo flatCostPojo = null;
		if (Util.isNotEmptyObject(employeeFinancialDemandNoteInfo.getCustomerPropertyDetailsInfo())) {
			customerPropertyDetailsInfo = employeeFinancialDemandNoteInfo.getCustomerPropertyDetailsInfo();
		} else {
			List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialDemandNoteInfo);
			customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
		}
		bookingFormRequest.setFlatBookingId(customerPropertyDetailsInfo.getFlatBookingId());
		List<FinancialProjectMileStonePojo>  listOfMilestones = employeeFinancialServiceDao.getFinancialDetails(employeeFinancialDemandNoteInfo, Status.ACTIVE);
		List<FlatCostPojo> flatCostPojoList =employeeFinancialServiceDao.getFlatCost(bookingFormRequest);
		if (Util.isEmptyObject(flatCostPojoList)) {
			throw new EmployeeFinancialServiceException("FlatCost Details not found.");
		} else {
			flatCostPojo = flatCostPojoList.get(0);
		}
		for (FinancialProjectMileStonePojo mileStonePojo : listOfMilestones) {
			Double gstAmount = 0.0;
//			Double totalgst = 0.0;
//			List<FinSchemeTaxMappingPojo> schemeTaxDetails = null;
			FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
			finProjDemandNoteInfo.setMilestoneDate(mileStonePojo.getMilestoneDate());
			if (finProjDemandNoteInfo.getMilestoneDate() == null) {
				if(mileStonePojo.getMileStoneNo() == 1 || mileStonePojo.getMileStoneNo() == 2 ) {
					finProjDemandNoteInfo.setMilestoneDate(mileStonePojo.getMilestoneDate()==null?customerPropertyDetailsInfo.getBookingDate():mileStonePojo.getMilestoneDate());		
				}
			}
			
			
			/*old code*/
			
//			if (finProjDemandNoteInfo.getMilestoneDate() != null) {
//				schemeTaxDetails = employeeFinancialServiceDao.getFlatBookDetailsSchemeTaxDetails(customerPropertyDetailsInfo,finProjDemandNoteInfo);
//			}
//			if (Util.isEmptyObject(schemeTaxDetails)) {
//				log.info("Scheme details not found.");
//				//throw new EmployeeFinancialServiceException("Scheme details not found.");
//			}
//			/* Setting TotalAmount */
//			if (Util.isNotEmptyObject(mileStonePojo.getTotalPayableAmount())) {
//				totalAmount = mileStonePojo.getTotalPayableAmount();
//			}
//			/* milestone  Amount */
//			Double percentage = mileStonePojo.getMileStonePercentage()==null?0d:mileStonePojo.getMileStonePercentage();
//			Double milestoneAmount = (totalAmount*percentage/100);
//			//System.out.println("mileStonePojo.getMileStoneNo()\t"+mileStonePojo.getMileStoneNo());
//			/* if corresponding milestone have GST percentage */
//			if (Util.isNotEmptyObject(schemeTaxDetails)) {
//				// isSchemeFound = true;
//				for (FinSchemeTaxMappingPojo taxMappingpojo : schemeTaxDetails) {
//					Double gst = Util.isNotEmptyObject(taxMappingpojo.getPercentageValue()) ? taxMappingpojo.getPercentageValue() : 0.0;
//					gstAmount += (milestoneAmount / 100) * gst;
//					totalgst += gst;
//					gstAmount = roundOffAmount(gstAmount);
//					previousgst = gst;
//				}
//				//if corresponding milestone don't have GST percentage take previous GST percentage.
//			} else {
//				Double gst = previousgst;
//				gstAmount += (milestoneAmount / 100) * gst;
//				totalgst += gst;
//				gstAmount = roundOffAmount(gstAmount);
//			}
//			
//			Double mileStoneAmountWithGst = roundOffAmount(milestoneAmount+gstAmount);
//			MileStoneInfo milestone = new MileStoneInfo();
//			milestone.setMilStoneNo(mileStonePojo.getMileStoneNo());
//			milestone.setMilestoneName(mileStonePojo.getMilestoneName());milestone.setProjectMilestoneId(mileStonePojo.getProjectMilestoneId().toString());
//			milestone.setDue(percentage.toString());
//			milestone.setDueAmountExcludeGST(milestoneAmount.toString());
//			milestone.setGstAmount(gstAmount.toString());
//			milestone.setTotalDueAmount(mileStoneAmountWithGst.toString());
//			mileStones.add(milestone);
//			
//			
			/*old code*/
			
			
			/* Setting TotalAmount */
			if (Util.isNotEmptyObject(flatCostPojo.getTotalCostExcludeGst())) {
				totalAmountExludGST =flatCostPojo.getTotalCostExcludeGst();
			}else
			{
				throw new EmployeeFinancialServiceException("Total Cost (Excl GST) not found.");
			}
			/* Setting TotalAmount */
			if (Util.isNotEmptyObject(flatCostPojo.getTotalCost())) {
				totalAmount =flatCostPojo.getTotalCost();
			}else
			{
				throw new EmployeeFinancialServiceException("Total Agreement Cost not found.");
			}
			
			gstAmount=flatCostPojo.getGstCost();
			/* milestone  Amount */
			Double percentage = mileStonePojo.getMileStonePercentage()==null?0d:mileStonePojo.getMileStonePercentage();
			Double milestoneAmount = (totalAmount*percentage/100);
			Double milestoneAmountExludGST = (totalAmountExludGST*percentage/100);
			 
			
			Double mileStoneAmountWithGst = roundOffAmount(milestoneAmount);
			MileStoneInfo milestone = new MileStoneInfo();
			milestone.setMilStoneNo(mileStonePojo.getMileStoneNo());
			milestone.setMilestoneName(mileStonePojo.getMilestoneName());
			milestone.setProjectMilestoneId(mileStonePojo.getProjectMilestoneId().toString());
			milestone.setDue(percentage.toString());
			milestone.setDueAmountExcludeGST(milestoneAmountExludGST.toString());
			milestone.setGstAmount(gstAmount.toString());
			milestone.setTotalDueAmount(mileStoneAmountWithGst.toString());
			mileStones.add(milestone);
		}//listOfMilestones
		
		if(!isSchemeFound){
			
		}
		
		return mileStones;
	}	

	@Override
	public List<FinBookingFormModiCostResponse> getModificationInvoiceDetails(EmployeeFinancialRequest employeeFinancialRequest) throws Exception {
		log.info("***** Control inside the EmployeeFinancialServiceImpl.getModificationInvoiceDetails() *****");
		EmployeeFinancialTransactionServiceInfo transactionServiceInfo = new EmployeeFinancialTransactionServiceInfo();
		FinancialProjectMileStonePojo pojo = new FinancialProjectMileStonePojo(); 
		pojo.setTypeId(employeeFinancialRequest.getFinBookingFormModiCostId());
		transactionServiceInfo.setFinBookingFormModiCostId(employeeFinancialRequest.getFinBookingFormModiCostId());
		
		EmployeeFinancialServiceInfo employeeFinancialServiceInfo = new EmployeeFinancialServiceInfo();
		employeeFinancialServiceInfo.setBookingFormIds(Arrays.asList(employeeFinancialRequest.getBookingFormId()));
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo;
		List<CustomerPropertyDetailsPojo> customerPropertyDetailsPojoList = employeeFinancialServiceDao.getCustomerPropertyDetails(employeeFinancialServiceInfo);
		if(Util.isNotEmptyObject(customerPropertyDetailsPojoList) && Util.isNotEmptyObject(customerPropertyDetailsPojoList.get(0))) {
			customerPropertyDetailsInfo = (CustomerPropertyDetailsInfo) financialMapper.copyPropertiesFromInfoBeanToPojoBean(customerPropertyDetailsPojoList.get(0), CustomerPropertyDetailsInfo.class);
		} else {
			 throw new EmployeeFinancialServiceException("Customer details not found, Failed to generate modification invoice.");
		}

		List<FinBookingFormModiCostPojo> modificationPojos = employeeFinancialServiceDao.getModificationCost(pojo);
		List<FinBookingFormModiCostDtlsPojo> modificationDetailsPojos = employeeFinancialServiceDao.getModificationCostDetails(pojo);
		List<ModicationInvoiceAppRej> listOfApprRejectDetailsList = employeeFinancialServiceDao.getModificationApprRejectDetails(transactionServiceInfo);
		
		List<FinBookingFormModiCostResponse> response = financialMapper.copyModificationPojosToResponse(modificationPojos,modificationDetailsPojos,customerPropertyDetailsInfo,listOfApprRejectDetailsList);
		//List<FinModificationInvocieDetailsPojo> list = employeeFinancialServiceDao.getPendingModificationInvoiceDetails(employeeFinancialRequest);
		return response;
	}

	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialTransactionResponse checkPushNotification(EmployeeFinancialTransactionRequest financialTransactionRequest) throws Exception {
		employeeFinancialHelper.checkPushNotification(financialTransactionRequest);
		return null;
	}
	
	public Map<Long, FinancialDemandNoteMS_TRN_Pojo> loadOldBookingTransaction(FlatBookingPojo oldFlatBookingPojo,FlatBookingPojo newFlatBookingPojo) throws Exception{
		List<FinancialDemandNoteMS_TRN_Pojo> finTransactionEntryPojoLists = employeeFinancialServiceDao.loadOldBookingTransaction(oldFlatBookingPojo);
		List<EmployeeFinTranPaymentSetOffRequest> oldPaymentSetOffDetailsList = null;
		//List<EmployeeFinTranPaymentSetOffRequest> newPaymentSetOffDetailsList = null;
		EmployeeFinTranPaymentSetOffRequest paymentSetOffRequest = null;
		List<FinancialDemandNoteMS_TRN_Pojo> oldfinalTransactionEntryPojoLists = new ArrayList<>();
		//List<FinancialDemandNoteMS_TRN_Pojo> newfinalTransactionEntryPojoLists = new ArrayList<>();
		Map<Long, FinancialDemandNoteMS_TRN_Pojo> oldBookingRefundEntryTransaction = new LinkedHashMap<>();
		//Map<Long, FinancialDemandNoteMS_TRN_Pojo> newBookingEntryTransaction = new HashMap<>();
		//double sumOfSetOff = 0.0;
		//Long transactionEntryId = 0l;
		for (FinancialDemandNoteMS_TRN_Pojo financialDemandNoteMS_TRN_Pojo : finTransactionEntryPojoLists) {
			//int count = 0;
			FinancialDemandNoteMS_TRN_Pojo oldFinancialDemandNoteMS_TRN_Pojo = null;
			//FinancialDemandNoteMS_TRN_Pojo newFinancialDemandNoteMS_TRN_Pojo = null;
			//sumOfSetOff = 0.0;
			oldPaymentSetOffDetailsList = new ArrayList<>();
			paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();
			
			if(oldBookingRefundEntryTransaction.containsKey(financialDemandNoteMS_TRN_Pojo.getTransactionEntryId())) {
				oldFinancialDemandNoteMS_TRN_Pojo = oldBookingRefundEntryTransaction.get(financialDemandNoteMS_TRN_Pojo.getTransactionEntryId());
			} else {
				oldBookingRefundEntryTransaction.put(financialDemandNoteMS_TRN_Pojo.getTransactionEntryId(),financialDemandNoteMS_TRN_Pojo);
			}
			
			if(financialDemandNoteMS_TRN_Pojo.getTransactionFor()==null) {
				throw new EmployeeFinancialServiceException("Payment set off type missing, cannot shift the transaction...");	
			}
			
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getPrincipal_amount()) && financialDemandNoteMS_TRN_Pojo.getPrincipal_amount()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();
				paymentSetOffRequest.setSetOffTypeName("Fin_Booking_Form_Milestones");
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getPrincipal_amount());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getPrincipal_amount()); 
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);
				//newPaymentSetOffDetailsList.add(paymentSetOffRequest);
				//count++;
			}
			
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getPenalty_amount()) && financialDemandNoteMS_TRN_Pojo.getPenalty_amount()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();	
				paymentSetOffRequest.setSetOffTypeName("Fin_Penalty");
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getPenalty_amount());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getPenalty_amount());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);	
				//newPaymentSetOffDetailsList.add(paymentSetOffRequest);
				//count++;
			}
			
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getLegal_cost()) && financialDemandNoteMS_TRN_Pojo.getLegal_cost()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();	
				paymentSetOffRequest.setSetOffTypeName("Legal_Cost");
				paymentSetOffRequest.setInvoiceNo(financialDemandNoteMS_TRN_Pojo.getFinBokAccInvoiceNo());
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getLegal_cost());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getLegal_cost());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);
				//newPaymentSetOffDetailsList.add(paymentSetOffRequest);
				//count++;
			}
			
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getModification_cost()) && financialDemandNoteMS_TRN_Pojo.getModification_cost()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();	
				paymentSetOffRequest.setSetOffTypeName("Modification_Cost");
				paymentSetOffRequest.setInvoiceNo(financialDemandNoteMS_TRN_Pojo.getFinBokAccInvoiceNo());
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getModification_cost());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getModification_cost());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);							
			}
						
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getTds_amount()) && financialDemandNoteMS_TRN_Pojo.getTds_amount()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();	
				paymentSetOffRequest.setSetOffTypeName("TDS");
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getTds_amount());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getTds_amount());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);															
			}
			
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getFlat_khata_amount()) && financialDemandNoteMS_TRN_Pojo.getFlat_khata_amount()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();	
				paymentSetOffRequest.setSetOffTypeName("Individual_Flat_Khata_bifurcation_and_other_charges");
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getFlat_khata_amount());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getFlat_khata_amount());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);																			
			}
			
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getMaintenance_amount()) && financialDemandNoteMS_TRN_Pojo.getMaintenance_amount()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();	
				paymentSetOffRequest.setSetOffTypeName("Maintenance_Charge");
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getMaintenance_amount());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getMaintenance_amount());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);																							
			}
			
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getCorpus_amount()) && financialDemandNoteMS_TRN_Pojo.getCorpus_amount()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();	
				paymentSetOffRequest.setSetOffTypeName("Corpus_Fund");
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getCorpus_amount());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getCorpus_amount());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);																											
			}
			
			if(Util.isNotEmptyObject(financialDemandNoteMS_TRN_Pojo.getRefundable_Advance()) && financialDemandNoteMS_TRN_Pojo.getRefundable_Advance()!=0) {
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();	
				paymentSetOffRequest.setSetOffTypeName("Refundable_Advance");
				paymentSetOffRequest.setAmount(financialDemandNoteMS_TRN_Pojo.getRefundable_Advance());
				//sumOfSetOff += roundOffAmount(financialDemandNoteMS_TRN_Pojo.getRefundable_Advance());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);																											
			}
			
			if(Util.isEmptyObject(oldPaymentSetOffDetailsList)) {
				throw new EmployeeFinancialServiceException("Transaction payment set off found empty...");//continue;
			}
			
			if(Util.isEmptyObject(financialDemandNoteMS_TRN_Pojo.getTransactionAmount())){
				throw new EmployeeFinancialServiceException("Amount found empty...");
				//continue;
			}
		
			/*if(financialDemandNoteMS_TRN_Pojo.getTransactionAmount()!=sumOfSetOff) {
				throw new EmployeeFinancialServiceException("Amount not matching...");
			}*/
			/*if(count>0) {
				newFinancialDemandNoteMS_TRN_Pojo = financialDemandNoteMS_TRN_Pojo;
			}*/
			/*if(newFinancialDemandNoteMS_TRN_Pojo!=null) {
				if(newBookingEntryTransaction.containsKey(financialDemandNoteMS_TRN_Pojo.getTransactionEntryId())) {
					newFinancialDemandNoteMS_TRN_Pojo = newBookingEntryTransaction.get(financialDemandNoteMS_TRN_Pojo.getTransactionEntryId());
				} else {
					newBookingEntryTransaction.put(financialDemandNoteMS_TRN_Pojo.getTransactionEntryId(),newFinancialDemandNoteMS_TRN_Pojo);
				}
			}*/
			
			if(oldFinancialDemandNoteMS_TRN_Pojo!=null && Util.isNotEmptyObject(oldFinancialDemandNoteMS_TRN_Pojo.getPaymentSetOffDetails())) {
				//if this object is not empty then add current list to these previous object
				oldFinancialDemandNoteMS_TRN_Pojo.getPaymentSetOffDetails().addAll(oldPaymentSetOffDetailsList);
				/*if(newFinancialDemandNoteMS_TRN_Pojo!=null) {
					newFinancialDemandNoteMS_TRN_Pojo.getPaymentSetOffDetails().addAll(oldPaymentSetOffDetailsList);	
				}*/
			} else {
				financialDemandNoteMS_TRN_Pojo.setPaymentSetOffDetails(oldPaymentSetOffDetailsList);	
			}
			
			oldfinalTransactionEntryPojoLists.add(financialDemandNoteMS_TRN_Pojo);
		}
		System.out.println(oldBookingRefundEntryTransaction.size());
		//System.out.println(newBookingEntryTransaction.size());
		/*Map<String, Map<Long, FinancialDemandNoteMS_TRN_Pojo>> oldNewBookingData = new HashMap<>();
		oldNewBookingData.put("oldData",oldBookingRefundEntryTransaction);
		oldNewBookingData.put("newData",newBookingEntryTransaction);*/
		return oldBookingRefundEntryTransaction;
	}
	
	private void insertOldBookingTransactionToNewBooking(Map<Long, FinancialDemandNoteMS_TRN_Pojo> transactionList,FlatBookingPojo newFlatBookingPojo,BookingFormRequest bookingRequest) 
			throws Exception {
			boolean insertTransaction = false;//only these four types transaction to be shifted
			List<Long> paymentSetOffListToAccept = Arrays.asList(MetadataId.PRINCIPAL_AMOUNT.getId(),MetadataId.FIN_BOOKING_FORM_MILESTONES.getId(),MetadataId.FIN_PENALTY.getId(),MetadataId.LEGAL_COST.getId());
			List<FinancialDemandNoteMS_TRN_Pojo> insertTransactionList = new ArrayList<>();
		for (Entry<Long, FinancialDemandNoteMS_TRN_Pojo> transaction : transactionList.entrySet()) {
			List<Long> paymentSetOffTypes = new ArrayList<>();
			insertTransaction = false;
			double transactionAmount = 0.0;
			if(transaction.getValue()!=null && Util.isNotEmptyObject(transaction.getValue().getPaymentSetOffDetails())) {
				for (EmployeeFinTranPaymentSetOffRequest paymentSetOffDetails : transaction.getValue().getPaymentSetOffDetails()) {
					if (Util.isEmptyObject(paymentSetOffDetails.getAmount()) || Util.isEmptyObject(paymentSetOffDetails.getSetOffTypeName()) || paymentSetOffDetails.getAmount()==0) {
						continue;
					}
					
					if(paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("PRINCIPAL_AMOUNT") || paymentSetOffDetails.getSetOffTypeName().equalsIgnoreCase("Fin_Booking_Form_Milestones") ) {
						paymentSetOffTypes.add(MetadataId.PRINCIPAL_AMOUNT.getId());
						transactionAmount = roundOffAmount(paymentSetOffDetails.getAmount()+transactionAmount);
					} else {
						long id = getMetaDataId(paymentSetOffDetails.getSetOffTypeName());
						if(paymentSetOffTypes.contains(id)) {
							continue;
						}
						if(paymentSetOffListToAccept.contains(id)) {
							transactionAmount = roundOffAmount(paymentSetOffDetails.getAmount()+transactionAmount);
						} else {
							//removing other set off which is not required
							paymentSetOffDetails.setAmount(0d);
						}
						paymentSetOffTypes.add(id);
					}
					
					//String setOffAmountType = getConvenienceNameFromMetaData(paymentSetOffDetails.getSetOffTypeName());
					//transactionTowards.add(setOffAmountType);
					if (getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.MODIFICATION_COST.getId()) && Util.isEmptyObject(paymentSetOffDetails.getInvoiceNo())) {
						throw new EmployeeFinancialServiceException("Please select invoice number for Modification Charges.");
					}/*else if (getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.LEGAL_COST.getId()) && Util.isEmptyObject(paymentSetOffDetails.getInvoiceNo())) {
						throw new EmployeeFinancialServiceException("Please select invoice number for Legal Charges.");
					}*/
				}
				
				if(Util.isEmptyObject(paymentSetOffTypes)) {
					log.info("Payment set off details not found could not proceed transaction."+transaction.getValue().getBookingFormId());
					throw new EmployeeFinancialServiceException("Payment set off details not found could not proceed transaction.");
				}
	
			}			
			
			for (Long setOff : paymentSetOffTypes) {
				if(paymentSetOffListToAccept.contains(setOff)) {
					 insertTransaction = true;
				}
			}
			transaction.getValue().setTransactionAmount(transactionAmount);
			if(insertTransaction) {
				insertTransactionList.add(transaction.getValue());
			}
		}//1st for
		
		for (FinancialDemandNoteMS_TRN_Pojo transactionPojo : insertTransactionList) {
			transactionPojo.setBookingFormId(null);//setting bookingFormId null so, data will be loaded based on Fl
			transactionPojo.setFlatBookingId(null);
			int isLegal = 0;
			for (EmployeeFinTranPaymentSetOffRequest paymentSetOffDetails : transactionPojo.getPaymentSetOffDetails()) {
				System.out.println("Type "+paymentSetOffDetails.getSetOffTypeName());
				if (getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.LEGAL_COST.getId())) {
					isLegal = 1;
				}
			}

			FinancialDemandNoteMS_TRN_Info trn_MilestoneRequest = financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(transactionPojo, FinancialDemandNoteMS_TRN_Info.class);

			if (trn_MilestoneRequest.getTransactionTypeName() != null && trn_MilestoneRequest.getTransactionTypeName().length() != 0
					&& trn_MilestoneRequest.getTransactionModeName().equals(MetadataId.CHEQUE.getName())) {
				trn_MilestoneRequest.setTransactionDate(trn_MilestoneRequest.getChequeDate());
				trn_MilestoneRequest.setTransactionReceiveDate(trn_MilestoneRequest.getChequeReceiveDate());
				trn_MilestoneRequest.setDN_or_TRN_date(trn_MilestoneRequest.getChequeReceiveDate());
				
				if(trn_MilestoneRequest.getTransactionTypeName().equals(MetadataId.PAYMENT.getName()) && trn_MilestoneRequest.getTransactionFor()!=null) {
					trn_MilestoneRequest.setDN_or_TRN_date(trn_MilestoneRequest.getChequeDate());
					//trn_MilestoneRequest.setTransactionReceiveDate(trn_MilestoneRequest.getChequeDate());
					trn_MilestoneRequest.setTransactionDate(trn_MilestoneRequest.getChequeDate());
					trn_MilestoneRequest.setTransactionReceiveDate(null);
				}
			} else {
				trn_MilestoneRequest.setTransactionReceiveDate(trn_MilestoneRequest.getOnlineReceiveDate());
				trn_MilestoneRequest.setDN_or_TRN_date(trn_MilestoneRequest.getOnlineReceiveDate());
				if(trn_MilestoneRequest.getTransactionTypeName().equals(MetadataId.PAYMENT.getName()) && trn_MilestoneRequest.getTransactionFor()!=null) {
					trn_MilestoneRequest.setTransactionDate(trn_MilestoneRequest.getChequeDate());
					trn_MilestoneRequest.setTransactionReceiveDate(null);
				}
			}
			
			EmployeeFinancialServiceInfo financialServiceInfo = new EmployeeFinancialServiceInfo();
			financialServiceInfo.setPortNumber(bookingRequest.getPortNumber());
			financialServiceInfo.setEmpId(127l);

			EmployeeFinancialTransactionServiceInfo transactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) 
			financialMapper.copyFinancialDemandNoteMS_TRN_InfoToEmployeeFinancialTransactionServiceInfo(financialServiceInfo,trn_MilestoneRequest, EmployeeFinancialTransactionServiceInfo.class);
			System.out.println(transactionServiceInfo.getTransactionTypeId()+" "+transactionServiceInfo.getTransactionModeId()+" "+transactionServiceInfo.getTransactionDate()+" "+transactionServiceInfo.getTransactionReceiveDate());
			if(transactionServiceInfo.getSiteId()!=null) {
				transactionServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
			}
			if(transactionPojo.getFlatId()!=null) {
				transactionServiceInfo.setFlatIds(Arrays.asList(newFlatBookingPojo.getFlatId()));
			}
			
			transactionServiceInfo.setBookingFormId(newFlatBookingPojo.getFlatBookingId());//setting bookingFormId null so, data will be loaded based on Fl
			if(transactionServiceInfo.getTransactionFor()!=null && (transactionServiceInfo.getTransactionFor().equals("Legal Charges") || isLegal == 1)) {
				FinancialProjectMileStoneInfo finProjDemandNoteInfo = new FinancialProjectMileStoneInfo();
				if (Util.isNotEmptyObject(transactionServiceInfo.getSiteIds())) {
					finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteIds().get(0));
				} else if (Util.isNotEmptyObject(transactionServiceInfo.getSiteId())) {
					finProjDemandNoteInfo.setSiteId(transactionServiceInfo.getSiteId());
				}
				List<FinPenaltyTaxPojo> finPenaltyTaxPojoList = employeeFinancialServiceDao.getTaxOnInterestAmountData(finProjDemandNoteInfo,Arrays.asList(MetadataId.LEGAL_COST.getId()));
				if (Util.isNotEmptyObject(finPenaltyTaxPojoList)) {
					double percentageValue = 0d;
					percentageValue = finPenaltyTaxPojoList.get(0).getPercentageValue();
					transactionServiceInfo.setFinTaxMappingId(finPenaltyTaxPojoList.get(0).getFinTaxMappingId());
					transactionServiceInfo.setPercentageValue(percentageValue);
					
					double gstAmount = ((percentageValue/(percentageValue+100))*(transactionServiceInfo.getTransactionAmount()));
					 
					List<FinBookingFormLegalCostInfo> finBookingFormLegalCostList = new ArrayList<>();
					FinBookingFormLegalCostInfo bookingFormLegalCostRequest = new FinBookingFormLegalCostInfo(); 
					bookingFormLegalCostRequest.setLegalAmount(transactionServiceInfo.getTransactionAmount()-gstAmount);
					bookingFormLegalCostRequest.setTaxAmount(gstAmount);
					bookingFormLegalCostRequest.setTotalAmount(transactionServiceInfo.getTransactionAmount());
					
					List<FinBookingFormLglCostDtlsInfo> finBookingFormLglCostDtlsList = new ArrayList<>();
					FinBookingFormLglCostDtlsInfo bookingFormLglCostDtlsRequest = new FinBookingFormLglCostDtlsInfo();
					bookingFormLglCostDtlsRequest.setLegalAmount(transactionServiceInfo.getTransactionAmount()-gstAmount);
					bookingFormLglCostDtlsRequest.setDescription("Flat Legal and Documentation charges");
					finBookingFormLglCostDtlsList.add(bookingFormLglCostDtlsRequest);
					
					bookingFormLegalCostRequest.setFinBookingFormLglCostDtlsList(finBookingFormLglCostDtlsList);
					finBookingFormLegalCostList.add(bookingFormLegalCostRequest);
					transactionServiceInfo.setBookingFormIds(Arrays.asList(transactionServiceInfo.getBookingFormId()));
					transactionServiceInfo.setFinBookingFormLegalCostList(finBookingFormLegalCostList);
					
					saveLegalCharges(transactionServiceInfo);
					List<EmployeeFinTranPaymentSetOffInfo> paymentSetOffInfos = transactionServiceInfo.getPaymentSetOffDetails();
					for (EmployeeFinTranPaymentSetOffInfo paymentSetOffDetails : paymentSetOffInfos) {
						if(Util.isEmptyObject(paymentSetOffDetails.getAmount()) || Util.isEmptyObject(paymentSetOffDetails.getSetOffTypeName())) {
							continue;
						}
						
						if (getMetaDataId(paymentSetOffDetails.getSetOffTypeName()).equals(MetadataId.LEGAL_COST.getId())) {
							//throw new EmployeeFinancialServiceException("Please select invoice number for Legal Charges.");
							 paymentSetOffDetails.setInvoiceNo(transactionServiceInfo.getFinBokAccInvoiceNo());
						}
					}
				} else {
					log.info("Penalty Tax Pojo is empty...");
					throw new EmployeeFinancialServiceException("Please update Legal Charges GST.");
				}
			}
			/*if(transactionServiceInfo.getTransactionTypeName().equals(MetadataId.PAYMENT.getName())){
				try {
					transactionServiceInfo.setTransferModeId(FinTransferMode.valueOf(transactionServiceInfo.getTransferModeName().toUpperCase()).getId());
				} catch (Exception ex) {
					transactionServiceInfo.setTransferModeId(FinTransferMode.valueOf(transactionServiceInfo.getTransactionModeName().toUpperCase()).getId());
				}
			}*/
			
			transactionServiceInfo.setPrevTransactionEntryId(transactionServiceInfo.getTransactionEntryId());
			transactionServiceInfo.setPrevTransactionSetOffEntryId(transactionServiceInfo.getTransactionSetOffEntryId());
			
			Long empId = employeeFinancialServiceDao.getTransactionFirstLevelEmpId(transactionServiceInfo);
			financialServiceInfo.setPortNumber(bookingRequest.getPortNumber());
			financialServiceInfo.setEmpId(empId);
			transactionServiceInfo.setRequestUrl("saveBookingDetails");
			transactionServiceInfo.setEmployeeId(empId);
			transactionServiceInfo.setPortNumber(bookingRequest.getPortNumber());
			transactionServiceInfo.setBookingRequest(bookingRequest);
			//transactionServiceInfo.setSalesFrTransactionReceiptNo1(transactionServiceInfo.getExcelRecordNo());
			//transactionServiceInfo.setOperationType(FinEnum.SHIFT_TRANSACTION.getName());
			//transactionServiceInfo.setInsertOldApprToNewTrn(true);
			
			List<FinTransactionApprStatPojo> finTransactionApprStatPojoList = employeeFinancialServiceDao.getFinTransactionApprStatData(transactionServiceInfo);
			
			if(transactionServiceInfo.getTransactionClosedDate()==null) {
				//throw new EmployeeFinancialServiceException("Transaction closed date found empty...");
			}
			System.out.println("saveBookingDetails transactionServiceInfo.getTransactionClosedDate() "+transactionServiceInfo.getTransactionClosedDate());

			saveFinancialTransactionRequest(transactionServiceInfo);
			
			if(Util.isNotEmptyObject(finTransactionApprStatPojoList)) {
				for (FinTransactionApprStatPojo apprStatPojo : finTransactionApprStatPojoList) {
					apprStatPojo.setTransactionSetOffEntryId(transactionServiceInfo.getTransactionSetOffEntryId());
					apprStatPojo.setComment(apprStatPojo.getComments());
					employeeFinancialServiceDao.copyTransactionApproveRejectDetails(apprStatPojo,null);
					//employeeFinancialServiceDao.copyTransactionChangedDetails(apprStatPojo);
				}
			}
			
			//inserting old transaction approve reject details
			//employeeFinancialServiceDao.copyTransactionSetOffApprovaldetailsFrmUpload(transactionServiceInfo);
		}
	}
	
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public void insertOldBookingTransactionToNewBooking(BookingFormRequest bookingRequest) throws Exception {
		FlatBookingPojo oldFlatBookingPojo = new FlatBookingPojo();
		
		//oldFlatBookingPojo.setSalesforceOldBookingId("A505-106");
		oldFlatBookingPojo.setFlatNo(bookingRequest.getOldBookingRequest().getFlatNo());
		oldFlatBookingPojo.setFlatBookingId(bookingRequest.getOldBookingRequest().getFlatBookingId());
		oldFlatBookingPojo.setStatusId(bookingRequest.getOldBookingRequest().getStatusId());
		oldFlatBookingPojo.setSiteId(bookingRequest.getOldBookingRequest().getSiteId());
		
		FlatBookingPojo newFlatBookingPojo = new FlatBookingPojo();
		//newFlatBookingPojo.setSalesforceOldBookingId("");
		newFlatBookingPojo.setFlatBookingId(bookingRequest.getNewBookingRequest().getFlatBookingId());
		newFlatBookingPojo.setFlatId(bookingRequest.getNewBookingRequest().getFlatId());
		newFlatBookingPojo.setSiteId(bookingRequest.getNewBookingRequest().getSiteId());
		
		/*here we are shifting Transaction to Old Booking To new Booking */
		/*here we are updating FIN_TRANSACTION_ENTRY BOOKING_ID COLUMN .*/
		updateOldBookingPendingTransactionToNewBooking(bookingRequest);
	
	
		Map<Long, FinancialDemandNoteMS_TRN_Pojo> listOfTrn = loadOldBookingTransaction(oldFlatBookingPojo,null);
		employeeFinancialServiceDao.activeSuspenseEntryData(oldFlatBookingPojo);
		
		//insertOldBookingTransactionToNewBooking(listOfTrn,newFlatBookingPojo,bookingRequest);//new object

		try {
			refundOLD_BookingTransaction(listOfTrn,oldFlatBookingPojo,bookingRequest);//old object
		} catch(Exception ex) {
			ex.printStackTrace();
			try {
				CustomerPropertyDetailsInfo customerPropertyDetailsPojo = new CustomerPropertyDetailsInfo();
				customerPropertyDetailsPojo.setFlatBookingId(bookingRequest.getOldBookingRequest().getFlatBookingId());
				customerPropertyDetailsPojo.setSiteId(bookingRequest.getOldBookingRequest().getSiteId());
				sendBookingErrorMail(ex,customerPropertyDetailsPojo,"refundEntry");
			} catch(Exception exx) {
				log.info(exx.getMessage(),exx);
			}
		}
		
		//employeeFinancialServiceDao.inActiveOldBookingTransaction(oldFlatBookingPojo);
	}
	
	private void refundOLD_BookingTransaction(Map<Long, FinancialDemandNoteMS_TRN_Pojo> transactionList, FlatBookingPojo newFlatBookingPojo
			,BookingFormRequest bookingRequest) throws Exception {

		List<Long> paymentTypes = Arrays.asList(MetadataId.FIN_BOOKING_FORM_MILESTONES.getId(),MetadataId.PRINCIPAL_AMOUNT.getId() 
				//,MetadataId.MODIFICATION_COST.getId(), MetadataId.LEGAL_COST.getId()
				,MetadataId.FIN_PENALTY.getId()
				,MetadataId.MAINTENANCE_CHARGE.getId(),MetadataId.INDIVIDUAL_FLAT_KHATA_BIFURCATION_AND_OTHER_CHARGES.getId(),MetadataId.CORPUS_FUND.getId()
				,MetadataId.TDS.getId(),MetadataId.REFUNDABLE_ADVANCE.getId()
				);
		
		CustomerPropertyDetailsInfo customerPropertyDetailsInfo2 = new CustomerPropertyDetailsInfo();
		customerPropertyDetailsInfo2.setFlatBookingId(newFlatBookingPojo.getFlatBookingId());
		customerPropertyDetailsInfo2.setStatusId(Status.ACTIVE.getStatus());
		/*double excessMilestoneBalanceAmount = 0,excessModificationBalanceAmount=0,excessLegalBalanceAmount=0,excessFlatKhataBalanceAmount=0,excessMaintenanceChargeBalanceAmount=0,excessCorpusBalanceAmount=0;
		double excessInterestBalanceAmount = 0;*/

		FinancialDemandNoteMS_TRN_Pojo commonTemplate = new FinancialDemandNoteMS_TRN_Pojo();
		//taking one pojo object for refund
		for (Entry<Long, FinancialDemandNoteMS_TRN_Pojo> transaction : transactionList.entrySet()) {
			commonTemplate = transaction.getValue();
			break;
		}
		
		Map<String,Double> paidAmountInvoiceNoList = new LinkedHashMap<>();
		//only loading modification and legal invoice as this two has invoice no for intitiating receipt, and same doing the refund
		List<FinBookingFormAccountsPojo> milestonePaidList1 = employeeFinancialServiceDao.getSumOfFlatPaidAmountDetailsByInvoiveNo(customerPropertyDetailsInfo2, Arrays.asList(MetadataId.MODIFICATION_COST.getId(), MetadataId.LEGAL_COST.getId()));
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount1 = employeeFinancialServiceDao.getSumOfFlatPaidExcessAmountByInvoiveNo(customerPropertyDetailsInfo2, Arrays.asList(MetadataId.MODIFICATION_COST.getId(), MetadataId.LEGAL_COST.getId()));
		
		if(Util.isNotEmptyObject(listOfExcessAmount1)) {
			//listOfExcessAmount.addAll(listOfExcessAmount1);
			for (FinBookingFormExcessAmountPojo excessAmountPojoInvoice : listOfExcessAmount1) {
				double balAmount = excessAmountPojoInvoice.getBalanceAmount() ==null? 0d :excessAmountPojoInvoice.getBalanceAmount();
				//holding type and invoice no as key, and amount as value
				if (paidAmountInvoiceNoList.containsKey(excessAmountPojoInvoice.getMetadataName()+"##"+excessAmountPojoInvoice.getFinBokAccInvoiceNo())) {//if already value is present then add the current value to previous amount
					double amount = paidAmountInvoiceNoList.get(excessAmountPojoInvoice.getMetadataName()+"##"+excessAmountPojoInvoice.getFinBokAccInvoiceNo());
					paidAmountInvoiceNoList.put(excessAmountPojoInvoice.getMetadataName()+"##"+excessAmountPojoInvoice.getFinBokAccInvoiceNo(), roundOffAmount(amount + balAmount));
				} else {
					if(roundOffAmount(balAmount)>0) {
						paidAmountInvoiceNoList.put(excessAmountPojoInvoice.getMetadataName()+"##"+excessAmountPojoInvoice.getFinBokAccInvoiceNo(), roundOffAmount(balAmount));
					}
				}
			}
		}

		if (Util.isNotEmptyObject(milestonePaidList1)) {
			//milestonePaidList.addAll(milestonePaidList1);
			for (FinBookingFormAccountsPojo pojoInvoice : milestonePaidList1) {
				double paidAmount = pojoInvoice.getPaidAmount() == null ? 0 : pojoInvoice.getPaidAmount();
				//holding type and invoice no as key, and amount as value
				if (paidAmountInvoiceNoList.containsKey(pojoInvoice.getMetadataName()+"##"+pojoInvoice.getFinBokAccInvoiceNo())) {
					double amount = paidAmountInvoiceNoList.get(pojoInvoice.getMetadataName()+"##"+pojoInvoice.getFinBokAccInvoiceNo());
					paidAmountInvoiceNoList.put(pojoInvoice.getMetadataName()+"##"+pojoInvoice.getFinBokAccInvoiceNo(), roundOffAmount(amount + paidAmount));
				} else {
					if(roundOffAmount(paidAmount)>0) {//if amount paid is more than zero
						paidAmountInvoiceNoList.put(pojoInvoice.getMetadataName()+"##"+pojoInvoice.getFinBokAccInvoiceNo(), roundOffAmount(paidAmount));
					}
				}
			}
		}
		
		//all types of payment excess amount and paid amount loading, except modification and legal invoice as this two has invoice no for intitiating receipt
		List<FinBookingFormAccountsPojo> milestonePaidList = employeeFinancialServiceDao.getSumOfFlatPaidAmountDetails(customerPropertyDetailsInfo2, paymentTypes);
		customerPropertyDetailsInfo2.setCondition("PaymentRefund");
		//loading excess amount if any
		List<FinBookingFormExcessAmountPojo> listOfExcessAmount = employeeFinancialServiceDao.getSumOfFlatPaidExcessAmount(customerPropertyDetailsInfo2, paymentTypes);

		Map<String,Double> paidAmountList = new LinkedHashMap<>();
		if(Util.isNotEmptyObject(listOfExcessAmount)) {
			//listOfExcessAmount.addAll(listOfExcessAmount1);
			for (FinBookingFormExcessAmountPojo excessAmountPojo : listOfExcessAmount) {
				double balAmount = excessAmountPojo.getBalanceAmount() ==null? 0d :excessAmountPojo.getBalanceAmount();
				if (paidAmountList.containsKey(excessAmountPojo.getMetadataName())) {//if already value is present then add the current value to previous amount
					double amount = paidAmountList.get(excessAmountPojo.getMetadataName());
					paidAmountList.put(excessAmountPojo.getMetadataName(), roundOffAmount(amount + balAmount));
				} else {
					if(roundOffAmount(balAmount)>0) {//if amount paid is more than zero
						paidAmountList.put(excessAmountPojo.getMetadataName(), roundOffAmount(balAmount));
					}
				}
			}
		}

		if (Util.isNotEmptyObject(milestonePaidList)) {
			//milestonePaidList.addAll(milestonePaidList1);
			for (FinBookingFormAccountsPojo pojo : milestonePaidList) {
				double paidAmount = pojo.getPaidAmount() == null ? 0 : pojo.getPaidAmount();
				/*if (paidAmount == 0) {
					continue;//after testing this condition can open, as we don't have to process 0 amount paid payment set off
				}*/
				if (paidAmountList.containsKey(pojo.getMetadataName())) {
					double amount = paidAmountList.get(pojo.getMetadataName());
					paidAmountList.put(pojo.getMetadataName(), roundOffAmount(amount + paidAmount));
				} else {
					if(roundOffAmount(paidAmount)>0) {//if amount paid is more than zero
						paidAmountList.put(pojo.getMetadataName(), roundOffAmount(paidAmount));
					}
				}
			}
		}
		System.out.println(paidAmountList);
		//String legalCostInvoice  = "";
		//String modificationCostInvoice  = "";
		
		List<FinancialDemandNoteMS_TRN_Pojo> insertTransactionList = new ArrayList<>();
		List<EmployeeFinTranPaymentSetOffRequest> oldPaymentSetOffDetailsList = null;
		EmployeeFinTranPaymentSetOffRequest paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();
		//double sumOfSetOff = 0.0;
		for (Entry<String, Double> paidAmount : paidAmountList.entrySet()) {
			try {//creating all types of payment refund
				FinancialDemandNoteMS_TRN_Pojo paymentTrn = (FinancialDemandNoteMS_TRN_Pojo) commonTemplate.clone();
				paymentTrn.setComment("System Refund");
				//paymentTrn.setComments(new HashMap<>().put("CANCEL_REASON", ""System Refund""));
				oldPaymentSetOffDetailsList = new ArrayList<>();
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();
				paymentSetOffRequest.setSetOffTypeName(MetadataId.valueOf(paidAmount.getKey().toUpperCase()).getName().trim().replace(" ", "_"));
				paymentSetOffRequest.setAmount(paidAmount.getValue());
				paymentSetOffRequest.setInvoiceNo("");
				if(paymentSetOffRequest.getSetOffTypeName().equalsIgnoreCase("legal_cost")) {
					for (Entry<Long, FinancialDemandNoteMS_TRN_Pojo> transaction : transactionList.entrySet()) {
						for (EmployeeFinTranPaymentSetOffRequest paymentSetOffDetails : transaction.getValue().getPaymentSetOffDetails()) {
							if(paymentSetOffRequest.getSetOffTypeName().equalsIgnoreCase(paymentSetOffDetails.getSetOffTypeName())) {
								paymentSetOffRequest.setInvoiceNo(paymentSetOffDetails.getInvoiceNo());
							}
						}
					}
				} else if(paymentSetOffRequest.getSetOffTypeName().equalsIgnoreCase("Modification_Cost")) {
					for (Entry<Long, FinancialDemandNoteMS_TRN_Pojo> transaction : transactionList.entrySet()) {
						for (EmployeeFinTranPaymentSetOffRequest paymentSetOffDetails : transaction.getValue().getPaymentSetOffDetails()) {
							if(paymentSetOffRequest.getSetOffTypeName().equalsIgnoreCase(paymentSetOffDetails.getSetOffTypeName())) {
								paymentSetOffRequest.setInvoiceNo(paymentSetOffDetails.getInvoiceNo());
							}
						}
					}
				}
				//sumOfSetOff = roundOffAmount(paidAmount.getValue());
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);
	
				paymentTrn.setTransactionAmount(paidAmount.getValue());
				paymentTrn.setPaymentSetOffDetails(oldPaymentSetOffDetailsList);
	
				insertTransactionList.add(paymentTrn);
			} catch(Exception exx) {
				exx.printStackTrace();
			}
		}
		String invoiceNo="";
		String metadataTypeId="";
		//invoice wise inserting seperate transaction
		for (Entry<String, Double> paidAmountInvoice : paidAmountInvoiceNoList.entrySet()) {
			try {//creating all types of payment refund
				metadataTypeId = paidAmountInvoice.getKey().split("##")[0];
				invoiceNo = paidAmountInvoice.getKey().split("##")[1];
				FinancialDemandNoteMS_TRN_Pojo paymentTrn = (FinancialDemandNoteMS_TRN_Pojo) commonTemplate.clone();
				paymentTrn.setComment("System Refund");
				//paymentTrn.setComments(new HashMap<>().put("CANCEL_REASON", ""System Refund""));
				oldPaymentSetOffDetailsList = new ArrayList<>();
				paymentSetOffRequest = new EmployeeFinTranPaymentSetOffRequest();
				paymentSetOffRequest.setSetOffTypeName(MetadataId.valueOf(metadataTypeId.toUpperCase()).getName().trim().replace(" ", "_"));
				paymentSetOffRequest.setAmount(paidAmountInvoice.getValue());
				paymentSetOffRequest.setInvoiceNo(invoiceNo);
				
				oldPaymentSetOffDetailsList.add(paymentSetOffRequest);
	
				paymentTrn.setTransactionAmount(paidAmountInvoice.getValue());
				paymentTrn.setPaymentSetOffDetails(oldPaymentSetOffDetailsList);
	
				insertTransactionList.add(paymentTrn);
			} catch(Exception exx) {
				exx.printStackTrace();
			}
		}

/*		List<FinancialDemandNoteMS_TRN_Pojo> oldfinalTransactionEntryPojoLists = new ArrayList<>();
		FinancialDemandNoteMS_TRN_Pojo trnPojo = new FinancialDemandNoteMS_TRN_Pojo();
		
		for (Entry<Long, FinancialDemandNoteMS_TRN_Pojo> transaction : transactionList.entrySet()) {
			if(transaction.getValue()!=null && Util.isNotEmptyObject(transaction.getValue().getPaymentSetOffDetails())) {
				
			} else if(Util.isEmptyObject(transaction.getValue().getPaymentSetOffDetails())) {
				log.info("Payment set off details not found could not proceed transaction."+transaction.getValue().getBookingFormId());
				throw new EmployeeFinancialServiceException("Payment set off details not found could not proceed transaction.");
			}
			
			if(true) {
				insertTransactionList.add(transaction.getValue());
			}
		}//1st for
*/		
		//Map<String,Double> refundAMount = new HashMap<>();
		//reverting only already refund amount
		
		for (int index = 0,reverseIndex = insertTransactionList.size()-1; index < insertTransactionList.size(); index++,reverseIndex--) {
			FinancialDemandNoteMS_TRN_Pojo transactionPojo = insertTransactionList.get(reverseIndex);
			transactionPojo.setBookingFormId(null);//setting bookingFormId null so, data will be loaded based on Fl
			transactionPojo.setFlatBookingId(null);
			System.out.println(transactionPojo.getTransactionAmount()+" "+transactionPojo.getPaymentSetOffDetails());
			if(FinTransactionType.PAYMENT.getName().equals(transactionPojo.getTransactionTypeName())) {
				System.out.println(transactionPojo.getPaymentSetOffDetails());
				/*for (EmployeeFinTranPaymentSetOffRequest paymentSetOffDetails : transactionPojo.getPaymentSetOffDetails()) {
					if (Util.isEmptyObject(paymentSetOffDetails.getAmount()) || Util.isEmptyObject(paymentSetOffDetails.getSetOffTypeName()) || paymentSetOffDetails.getAmount()==0) {
						continue;
					}
					//here all Receipt transaction is reverting, except payment, so holding payemnt refund amount
					if(refundAMount.containsKey(paymentSetOffDetails.getSetOffTypeName())) {
						double amount = refundAMount.get(paymentSetOffDetails.getSetOffTypeName());
						refundAMount.put(paymentSetOffDetails.getSetOffTypeName(),roundOffAmount(amount+paymentSetOffDetails.getAmount()));
					} else {
						refundAMount.put(paymentSetOffDetails.getSetOffTypeName(),roundOffAmount(paymentSetOffDetails.getAmount()));
					}
				}*/
				continue;
			}
			
			/*for (EmployeeFinTranPaymentSetOffRequest paymentSetOffDetails : transactionPojo.getPaymentSetOffDetails()) {
				if (Util.isEmptyObject(paymentSetOffDetails.getAmount()) || Util.isEmptyObject(paymentSetOffDetails.getSetOffTypeName()) || paymentSetOffDetails.getAmount()==0) {
					continue;
				}
				if(refundAMount.containsKey(paymentSetOffDetails.getSetOffTypeName())) {
					double amount = refundAMount.get(paymentSetOffDetails.getSetOffTypeName());
					double setOffAmount = amount;
					double settleAmount = 0.0;
					
					double amountToSetOff = paymentSetOffDetails.getAmount();;
					//Long paymentStatusId = accPojo.getPaymentStatus();//
					if (setOffAmount > 0) {
						if (amountToSetOff > 0) {
							//log.info(" setOffAmount : " + setOffAmount + " -> amountToSetOff :  " + amountToSetOff + " Booking Form Id -> " + accPojo.getFinBookingFormAccountsId());
							if (setOffAmount >= amountToSetOff) {
								 setOffAmount = setOffAmount - amountToSetOff;
								 settleAmount = amountToSetOff;
							} else {
								settleAmount = setOffAmount;
								setOffAmount = setOffAmount - amountToSetOff;
							}
						}
					}
					paymentSetOffDetails.setAmount(paymentSetOffDetails.getAmount()-settleAmount);
					transactionPojo.setTransactionAmount(transactionPojo.getTransactionAmount()-settleAmount);
					refundAMount.put(paymentSetOffDetails.getSetOffTypeName(),roundOffAmount(amount-settleAmount));
				}
			}*/
			transactionPojo.setTransactionTypeId(FinTransactionType.PAYMENT.getId());
			transactionPojo.setTransactionModeId(FinTransactionMode.CHEQUE.getId());
			
			transactionPojo.setTransactionTypeName(FinTransactionType.PAYMENT.getName());
			transactionPojo.setTransactionModeName(FinTransactionMode.CHEQUE.getName());
			
			/*transactionPojo.setTransferModeId(FinTransferMode.CHEQUE.getId());
			transactionPojo.setTransferModeName(FinTransferMode.CHEQUE.getName());*/
			
			transactionPojo.setTransactionForId(FinTransactionFor.FLAT_CANCELLATION.getId());
			transactionPojo.setTransactionFor(FinTransactionFor.FLAT_CANCELLATION.getName());
			
			FinancialDemandNoteMS_TRN_Info trn_MilestoneRequest = financialMapper.copyPropertiesFromPojoBeanToPojoBeanInfoBean(transactionPojo, FinancialDemandNoteMS_TRN_Info.class);
	
			if (trn_MilestoneRequest.getTransactionTypeName() != null && trn_MilestoneRequest.getTransactionTypeName().length() != 0
					&& trn_MilestoneRequest.getTransactionModeName().equals(MetadataId.CHEQUE.getName())) {
				//trn_MilestoneRequest.setTransactionDate(trn_MilestoneRequest.getChequeDate());
				trn_MilestoneRequest.setTransactionDate(new Timestamp(new Date().getTime()));
				//trn_MilestoneRequest.setTransactionReceiveDate(trn_MilestoneRequest.getChequeReceiveDate());
				trn_MilestoneRequest.setDN_or_TRN_date(new Timestamp(new Date().getTime()));
				
				if(trn_MilestoneRequest.getTransactionTypeName().equals(MetadataId.PAYMENT.getName()) && trn_MilestoneRequest.getTransactionFor()!=null) {
					//trn_MilestoneRequest.setDN_or_TRN_date(trn_MilestoneRequest.getChequeDate());
					//trn_MilestoneRequest.setTransactionDate(trn_MilestoneRequest.getChequeDate());
					trn_MilestoneRequest.setTransactionDate(new Timestamp(new Date().getTime()));
				}
			} else {
				trn_MilestoneRequest.setTransactionDate(new Timestamp(new Date().getTime()));
				//trn_MilestoneRequest.setTransactionReceiveDate(trn_MilestoneRequest.getOnlineReceiveDate());
				trn_MilestoneRequest.setDN_or_TRN_date(new Timestamp(new Date().getTime()));
			}
			
			EmployeeFinancialServiceInfo financialServiceInfo = new EmployeeFinancialServiceInfo();
			
			EmployeeFinancialTransactionServiceInfo transactionServiceInfo = (EmployeeFinancialTransactionServiceInfo) 
			financialMapper.copyFinancialDemandNoteMS_TRN_InfoToEmployeeFinancialTransactionServiceInfo(financialServiceInfo,trn_MilestoneRequest, EmployeeFinancialTransactionServiceInfo.class);
			System.out.println(transactionServiceInfo.getTransactionTypeId()+" "+transactionServiceInfo.getTransactionModeId()+" "+transactionServiceInfo.getTransactionDate()+" "+transactionServiceInfo.getTransactionReceiveDate());
			if(transactionServiceInfo.getSiteId()!=null) {
				transactionServiceInfo.setSiteIds(Arrays.asList(transactionServiceInfo.getSiteId()));
			}
			if(transactionPojo.getFlatId()!=null) {
				transactionServiceInfo.setFlatIds(Arrays.asList(newFlatBookingPojo.getFlatId()));
			}
			transactionServiceInfo.setFlatIds(null);//not using flat id
			transactionServiceInfo.setBookingFormId(newFlatBookingPojo.getFlatBookingId());//setting bookingFormId null so, data will be loaded based on Fl
			transactionServiceInfo.setChequeNumber("System Refund Entry - "+newFlatBookingPojo.getFlatBookingId());
			transactionServiceInfo.setReferenceNo("System Refund Entry - "+newFlatBookingPojo.getFlatBookingId());
			transactionServiceInfo.setTransactionTypeId(FinTransactionType.PAYMENT.getId());
			transactionServiceInfo.setTransactionModeId(FinTransactionMode.CHEQUE.getId());
			
			transactionServiceInfo.setTransactionTypeName(FinTransactionType.PAYMENT.getName());
			transactionServiceInfo.setTransactionModeName(FinTransactionMode.CHEQUE.getName());
			
			transactionServiceInfo.setTransactionForId(FinTransactionFor.FLAT_CANCELLATION.getId());
			transactionServiceInfo.setTransactionFor(FinTransactionFor.FLAT_CANCELLATION.getName());
			//transactionServiceInfo.setSalesFrTransactionReceiptNo1(transactionServiceInfo.getExcelRecordNo());
			//FinTransactionFor.SYSTEM_REFUND.getId();
			Map<String,String> map = new HashMap<>();
			map.put("CANCEL_REASON", "System Refund Entry");
			transactionServiceInfo.setComments(Arrays.asList(map));
			Long empId = employeeFinancialServiceDao.getTransactionFirstLevelEmpId(transactionServiceInfo);
			financialServiceInfo.setPortNumber(bookingRequest.getPortNumber());
			financialServiceInfo.setEmpId(empId);
			transactionServiceInfo.setRequestUrl("saveBookingDetails");
			transactionServiceInfo.setEmployeeId(empId);
			transactionServiceInfo.setPortNumber(bookingRequest.getPortNumber());
			saveFinancialTransactionRequest(transactionServiceInfo);
		}
		
	}
	
	@Override
	public void sendBookingErrorMail(Exception exception, CustomerPropertyDetailsInfo customerPropertyDetailsPojo, String condition) {
		String errorMsg = "";
		Properties prop = responceCodesUtil.getApplicationProperties();
		Email email = new Email();
		StringBuilder msg = new StringBuilder("");
		String internalEmpMail = prop.getProperty("DEFAULT_PRODUCTION_ERROR_INTERNAL_EMP_EMAIL");//taking due days from prop file
		errorMsg = prop.getProperty("DEFAULT_BOOKING_ERROR_MSG");//taking due days from prop file
		//based on condtion matching only send email
		if("refundEntry".equals(condition)) {
			email.setSubject("Financial data payment refund entry failed...");	
		} else if("TransactionScheduler".equals(condition)){
			email.setSubject("Financial data Transaction scheduler failed to send email...");
		} else {
			//don't change this code as any if else condition is not matching
			return;
		}
		
		msg.append(exception+"<br>");
		
		if(exception instanceof RefundAmountException) {
			RefundAmountException exx = (RefundAmountException)exception;
			if (Util.isNotEmptyObject(exx.getMessages())) {
				msg.append(exx.getMessages());
			} else if (Util.isNotEmptyObject(exx.getMessage())) {
				msg.append(Arrays.asList(exx.getMessage()));
			}
		} else if(exception instanceof EmployeeFinancialServiceException) {
			EmployeeFinancialServiceException exx = (EmployeeFinancialServiceException)exception;
			if (Util.isNotEmptyObject(exx.getMessages())) {
				msg.append(exx.getMessages());
			} else if (Util.isNotEmptyObject(exx.getMessage())) {
				msg.append(Arrays.asList(exx.getMessage()));
			}
		} else if (exception instanceof InSufficeientInputException) {
			InSufficeientInputException e = (InSufficeientInputException) exception;
			if(Util.isNotEmptyObject(e.getMessages())) {
				msg.append(e.getMessages());
			}
		} else if(exception!=null && exception.getMessage()!=null) {
			msg.append(exception.getMessage()+"<br>");
		}

		for(StackTraceElement element : exception.getStackTrace()) {
			msg.append(element+"<br>");
		}
		if("refundEntry".equals(condition)) {
			errorMsg = errorMsg.replace("#error_Msg","<br>"+ msg+"<br> Project "+customerPropertyDetailsPojo.getSiteId()+" Flat Book Id "+customerPropertyDetailsPojo.getFlatBookingId()+", Time "+ TimeUtil.getTimeInSpecificFormat(new Timestamp(new Date().getTime()), "dd-MM-yyyy hh-mm-ss"));
		} else if("TransactionScheduler".equals(condition)){
			errorMsg = errorMsg.replace("#error_Msg","<br>"+ msg+"<br> "+ TimeUtil.getTimeInSpecificFormat(new Timestamp(new Date().getTime()), "dd-MM-yyyy hh-mm-ss"));
		}
		
		email.setEmailBodyText(errorMsg);
		
		if(Util.isNotEmptyObject(internalEmpMail)) {
			email.setToMails(internalEmpMail.split(","));//cc in internal team, for default banker error
			mailServiceImpl.sendDefaultBankerErrorMail(email);
		}
	}
	
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	@Override
	public EmployeeFinancialTransactionResponse checkTemplates(EmployeeFinancialTransactionRequest financialTransactionRequest) throws Exception {
		List<Map<String,String>> mapData = new ArrayList<>();
		Map<String,String> data = null;
		for (MetadataId metadaId : MetadataId.values()) {
			if(ALL_TYPES_OF_PAYMENTS.contains(metadaId.getId()) && !MetadataId.PRINCIPAL_AMOUNT.getId().equals(metadaId.getId())) {
				data = new HashMap<String,String>();
				data.put(getConvenienceNameFromMetaDataSalesForce(metadaId.getName().replace(" ", "_"), null), metadaId.getId().toString());
				mapData.add(data);
			}
		}
		System.out.println(mapData);
		
		if(financialTransactionRequest!=null && financialTransactionRequest.getActionUrl()!=null && financialTransactionRequest.getActionUrl().equals("loadTransaction")) {
			FlatBookingPojo oldFlatBookingPojo = new FlatBookingPojo();
			oldFlatBookingPojo.setSalesforceOldBookingId("A505-106");
			oldFlatBookingPojo.setFlatNo("A505");
			oldFlatBookingPojo.setFlatBookingId(1296l);
			oldFlatBookingPojo.setStatusId(Status.CANCEL.getStatus());
			FlatBookingPojo newFlatBookingPojo = new FlatBookingPojo();
			newFlatBookingPojo.setSalesforceOldBookingId("");
			
			Map<Long, FinancialDemandNoteMS_TRN_Pojo> listOfTrn = loadOldBookingTransaction(oldFlatBookingPojo,null);
			insertOldBookingTransactionToNewBooking(listOfTrn,newFlatBookingPojo,null);
			
			return null;
		}

		if(financialTransactionRequest!=null && financialTransactionRequest.getActionUrl()!=null && financialTransactionRequest.getActionUrl().equals("ApprovalMapping")) {
			employeeFinancialServiceDao.insertMappingAccess();
			return null;
		} else if(financialTransactionRequest!=null && financialTransactionRequest.getActionUrl()!=null && financialTransactionRequest.getActionUrl().equals("CheckApprovalMapping")) {
			//employeeFinancialServiceDao.checkDuplicateApprovalMappingAccess();
			return null;
		} else if(financialTransactionRequest!=null && financialTransactionRequest.getActionUrl()!=null && financialTransactionRequest.getActionUrl().equals("CheckEmployeeMapping")) {
			//employeeFinancialServiceDao.checkEmployeeApprovalMappingAccess();
			return null;
		}
		
		Email email = new Email();
		email.setTemplateName("");
		employeeFinancialHelper.checkTemplates(email, new FileInfo());
		/*if(true) {
			return null;
		}*/
		
		
		return null;
	}
	
	@Override
	public List<Map<String, Object>> loadDemandNoteFormats(EmployeeFinancialServiceInfo info) {
		
		List<Map<String, Object>>  listOfFormats = employeeFinancialServiceDao.loadDemandNoteFormats(info);
		
		return listOfFormats;
	}

	@Override
	public EmployeeFinancialTransactionResponse getInterestWaivedAndPaidDetails(EmployeeFinancialServiceInfo empFinSerInfo) {
		log.info("*** The Control is inside the getInterestWaivedAndPaidDetails in EmployeeFinancialServiceImpl ***"+empFinSerInfo);
		EmployeeFinancialTransactionResponse empFinTransResponse = new EmployeeFinancialTransactionResponse();
		List<FinTransactionSetOffPojo> finTranSetOffPojoList = employeeFinancialServiceDao.getInterestWaivedAndPaidDetails(empFinSerInfo);
		List<FinTransactionSetOffResponse> FinTranSetOffResponseList = financialMapper.finTransactionSetOffPojoListToFinTransactionSetOffResponseList(finTranSetOffPojoList);
		empFinTransResponse.setFinTransactionSetOffResponseList(FinTranSetOffResponseList);
		return empFinTransResponse;
	}

	@Override
	public FinancialProjectMileStoneResponse getAllCustomersInvoices(EmployeeFinancialTransactionServiceInfo empFinTranSerInfo) {
		log.info("*** The Control is inside the getAllCustomersInvoices in EmployeeFinancialServiceImpl ***"+empFinTranSerInfo);
		FinancialProjectMileStoneResponse finProjMilestoneResp = new FinancialProjectMileStoneResponse();
		List<FinBookingFormAccountsPojo> finBookingFormAccountsPojoList = employeeFinancialServiceDao.getAllCustomersInvoices(empFinTranSerInfo);
		//finBookingFormAccountsPojoList = employeeFinancialServiceDao.getFinBookingFormAccountsInvoices(customerPropertyDetailsInfo);
		List<FinBookingFormAccountsResponse> finBookingFormAccountsRespList = financialMapper.finBookingFormAccountsPojoListToFinBookingFormAccountsResponseList(finBookingFormAccountsPojoList);
		getTotalInvoicesAmounts(finBookingFormAccountsRespList,finProjMilestoneResp);
		finProjMilestoneResp.setFinBookingFormAccountsResponseList(finBookingFormAccountsRespList);
		return finProjMilestoneResp;
	}

	private void getTotalInvoicesAmounts(List<FinBookingFormAccountsResponse> finBookingFormAccountsRespList,FinancialProjectMileStoneResponse finProjMilestoneResp) {
		log.info("*** The Control is inside the getTotalInvoicesAmounts in EmployeeFinancialServiceImpl ***");
		Double totalPayAmount = 0d;
		Double totalPaidAmount = 0d;
		Double totalDueAmount = 0d;
		if(Util.isNotEmptyObject(finBookingFormAccountsRespList) && Util.isNotEmptyObject(finProjMilestoneResp)) {
			for(FinBookingFormAccountsResponse finBookingFormAccountsResp : finBookingFormAccountsRespList) {
				/* Total Pay Amount i.e invoice Amount */
				if(Util.isNotEmptyObject(finBookingFormAccountsResp.getPayAmount()) && !finBookingFormAccountsResp.getPayAmount().isNaN()) {
					totalPayAmount+=finBookingFormAccountsResp.getPayAmount();
				}
				/* Total Paid Amount i.e paid invoice amount */
				if(Util.isNotEmptyObject(finBookingFormAccountsResp.getPaidAmount()) && !finBookingFormAccountsResp.getPaidAmount().isNaN()) {
					totalPaidAmount+=finBookingFormAccountsResp.getPaidAmount();
				}
				/* Total Due Amount i.e pending invoice amount */
				if(Util.isNotEmptyObject(finBookingFormAccountsResp.getBalanceAmount()) && !finBookingFormAccountsResp.getBalanceAmount().isNaN()) {
					totalDueAmount+=finBookingFormAccountsResp.getBalanceAmount();
				}
				finProjMilestoneResp.setPayAmount(totalPayAmount);
				finProjMilestoneResp.setPaidAmount(totalPaidAmount);
				finProjMilestoneResp.setTotalDueAmount(totalDueAmount);
			}
		}
	}

	@Override
	public List<Map<String, Object>> getSuspenseEntryReport(EmployeeFinancialTransactionServiceInfo empFinTranSerInfo) {
		
		List<Map<String, Object>> finAnonymousEntryPojoList = employeeFinancialServiceDao.getAnonymousEntriesDataForReport(null, Status.ACTIVE.getStatus());
		System.out.println(finAnonymousEntryPojoList);
		/*Double zero_to_thirty = 0.0;
		Double thirty_to_foutyfive = 0.0;
		Double foutyfive_to_sixty = 0.0;
		Double sixty_to_ninty = 0.0;
		Double ninty_to_above = 0.0;
		Double sum_of_all = 0.0;*/
		
		for(Map<String, Object> finAnonymousEntryPojo : finAnonymousEntryPojoList) {
			finAnonymousEntryPojo.put("ZERO_TO_THIRTY",Util.isNotEmptyObject(finAnonymousEntryPojo.get("ZERO_TO_THIRTY"))?currencyUtil.getTheAmountWithCommas(Double.valueOf(finAnonymousEntryPojo.get("ZERO_TO_THIRTY").toString()),roundingModeSize,roundingMode):0);
			finAnonymousEntryPojo.put("THIRTY_TO_FOUTYFIVE",Util.isNotEmptyObject(finAnonymousEntryPojo.get("THIRTY_TO_FOUTYFIVE"))?currencyUtil.getTheAmountWithCommas(Double.valueOf(finAnonymousEntryPojo.get("THIRTY_TO_FOUTYFIVE").toString()),roundingModeSize,roundingMode):0);
			finAnonymousEntryPojo.put("FOUTYFIVE_TO_SIXTY",Util.isNotEmptyObject(finAnonymousEntryPojo.get("FOUTYFIVE_TO_SIXTY"))?currencyUtil.getTheAmountWithCommas(Double.valueOf(finAnonymousEntryPojo.get("FOUTYFIVE_TO_SIXTY").toString()),roundingModeSize,roundingMode):0);
			finAnonymousEntryPojo.put("SIXTY_TO_NINTY",Util.isNotEmptyObject(finAnonymousEntryPojo.get("SIXTY_TO_NINTY"))?currencyUtil.getTheAmountWithCommas(Double.valueOf(finAnonymousEntryPojo.get("SIXTY_TO_NINTY").toString()),roundingModeSize,roundingMode):0);
			finAnonymousEntryPojo.put("NINTY_TO_ABOVE",Util.isNotEmptyObject(finAnonymousEntryPojo.get("NINTY_TO_ABOVE"))?currencyUtil.getTheAmountWithCommas(Double.valueOf(finAnonymousEntryPojo.get("NINTY_TO_ABOVE").toString()),roundingModeSize,roundingMode):0);
			finAnonymousEntryPojo.put("SUM_OF_ALL",Util.isNotEmptyObject(finAnonymousEntryPojo.get("SUM_OF_ALL"))?currencyUtil.getTheAmountWithCommas(Double.valueOf(finAnonymousEntryPojo.get("SUM_OF_ALL").toString()),roundingModeSize,roundingMode):0);
			System.out.println(finAnonymousEntryPojo);
		}
		
		return finAnonymousEntryPojoList;	
	}

	@Override
	public Map<String, Object> loadTransactionStatusModuleData(EmployeeFinancialTransactionRequest empTransReq) throws Exception {
		Map<String,Object> allStatusModuleRequiredData = new HashMap<>();
		List<Map<String, Object>> employeeApprovalList =  employeeFinancialServiceDao.getNextLevelEmployeeForStatusModule(empTransReq);
		/*List<Long> empIdList = new ArrayList<>();
		for (Map<String, Object> map : employeeApprovalList) {
			if(!empIdList.contains(map.get("EMP_ID"))) {
				
			}
		}*/
		
		List<Map<String,String>> paymentSetOffData = new ArrayList<>();
		Map<String,String> data = null;
		for (MetadataId metadaId : MetadataId.values()) {
			if(ALL_TYPES_OF_PAYMENTS.contains(metadaId.getId()) && !MetadataId.PRINCIPAL_AMOUNT.getId().equals(metadaId.getId())) {
				data = new HashMap<String,String>();
				//data.put(getConvenienceNameFromMetaDataSalesForce(metadaId.getName().replace(" ", "_"), null), metadaId.getId().toString());
				
				data.put("key", getConvenienceNameFromMetaDataSalesForce(metadaId.getName().replace(" ", "_"), null));
				data.put("value", metadaId.getId().toString());
				
				paymentSetOffData.add(data);
			}
		}
		
		System.out.println(paymentSetOffData);
		allStatusModuleRequiredData.put("pendingLevelEmpDetails", employeeApprovalList);
		allStatusModuleRequiredData.put("paymentSetOffData", paymentSetOffData);
		return allStatusModuleRequiredData;
	}
	
	@Override
	public Map<String,List<FinTransactionClearedInfo>> getClearedTransactionReport(EmployeeFinancialTransactionRequest empTransReq) {
		Map<String,List<FinTransactionClearedInfo>> finList = new HashMap<>();
		List<FinTransactionClearedInfo> infoListRecipet = new ArrayList<FinTransactionClearedInfo>();
		List<FinTransactionClearedInfo> infoListPayment = new ArrayList<FinTransactionClearedInfo>();
		//recipet
		empTransReq.setOperationType("reciept");
		List<Map<String, Object>> clearedTansactionListRecipet = employeeFinancialServiceDao.getClearedTransactionReport(empTransReq);
		System.out.println(clearedTansactionListRecipet.size());
		for (Map<String, Object> clearedData : clearedTansactionListRecipet) {
			System.out.println(clearedData);
			FinTransactionClearedInfo clearedInfo = new FinTransactionClearedInfo();
			clearedInfo.setSiteName(clearedData.get("SALES_FORCE_SITE_NAME").toString());
			clearedInfo.setSiteId(Long.valueOf(clearedData.get("SITE_ID").toString()));
			clearedInfo.setTransactionTypeId(Long.valueOf(clearedData.get("FIN_TRANSACTION_TYPE_ID").toString()));
			clearedInfo.setAmount(clearedData.get("TRANSACTION_AMOUNT").toString());
			clearedInfo.setFlatSaleOwner(clearedData.get("FLAT_SALE_OWNER").toString().replace("LANDLORD_",""));
			clearedInfo.setFlatSaleOwnerId(Long.valueOf(clearedData.get("FLATS_SALE_OWNERS_ID").toString()));
			clearedInfo.setClearanceFromDate(empTransReq.getClearanceFromDate());
			clearedInfo.setClearanceToDate(empTransReq.getClearanceToDate());
			clearedInfo.setOperationType("reciept");
		//	if(!infoList.contains(clearedInfo) && clearedInfo.getTransactionTypeId().equals(FinTransactionType.RECEIPT.getId())) {
			infoListRecipet.add(clearedInfo);//only adding receipt object
//			} else {
//				for (FinTransactionClearedInfo finTransactionClearedInfo : infoList) {
//					if(finTransactionClearedInfo.getFlatSaleOwner().equals(clearedInfo.getFlatSaleOwner()) && clearedInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId())
//							&& finTransactionClearedInfo.getSiteId().equals(clearedInfo.getSiteId())
//							) {
//						//if(clearedInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId())) {
//							Double actualValue = Double.valueOf(finTransactionClearedInfo.getAmount());
//							Double currentValue = Double.valueOf(clearedInfo.getAmount());
//							//if found any refund entry object then doing minus in receipt object
//							finTransactionClearedInfo.setAmount(new BigDecimal(actualValue-currentValue).setScale(roundingModeSize, roundingMode).toString());
//						//}
//					}
//				}
//			}
		}
		//sorting data using sale owner id
		sortClearedList(infoListRecipet);
		//EmployeeFinancialHelper finHelper = new EmployeeFinancialHelper();
		Long flatSaleOwner = 0l;
		for (FinTransactionClearedInfo finTransactionClearedInfo : infoListRecipet) {
			finTransactionClearedInfo.setAmount(currencyUtil.convertUstoInFormat(BigDecimal.valueOf( Double.valueOf(finTransactionClearedInfo.getAmount())).setScale(roundingModeSize, roundingMode).toString()));
			String amount=finTransactionClearedInfo.getAmount().replaceAll("\u00A0", "");
			finTransactionClearedInfo.setAmount(amount.trim());
			if(flatSaleOwner.equals(finTransactionClearedInfo.getFlatSaleOwnerId())) {
				finTransactionClearedInfo.setFlatSaleOwner("");//if previous and current sale owner matching, then making current sale owner empty
			}
			flatSaleOwner = finTransactionClearedInfo.getFlatSaleOwnerId();
			
		}
		System.out.println(infoListRecipet);
		finList.put("recieptList",infoListRecipet);
		
		//payment
		empTransReq.setOperationType("payment");
		List<Map<String, Object>> clearedTansactionListPayment = employeeFinancialServiceDao.getClearedTransactionReport(empTransReq);
		System.out.println(clearedTansactionListPayment.size());
		for (Map<String, Object> clearedData : clearedTansactionListPayment) {
			System.out.println(clearedData);
			FinTransactionClearedInfo clearedInfo = new FinTransactionClearedInfo();
			clearedInfo.setSiteName(clearedData.get("SALES_FORCE_SITE_NAME").toString());
			clearedInfo.setSiteId(Long.valueOf(clearedData.get("SITE_ID").toString()));
			clearedInfo.setTransactionTypeId(Long.valueOf(clearedData.get("FIN_TRANSACTION_TYPE_ID").toString()));
			clearedInfo.setAmount(clearedData.get("TRANSACTION_AMOUNT").toString());
			clearedInfo.setFlatSaleOwner(clearedData.get("FLAT_SALE_OWNER").toString().replace("LANDLORD_",""));
			clearedInfo.setFlatSaleOwnerId(Long.valueOf(clearedData.get("FLATS_SALE_OWNERS_ID").toString()));
			clearedInfo.setClearanceFromDate(empTransReq.getClearanceFromDate());
			clearedInfo.setClearanceToDate(empTransReq.getClearanceToDate());
			clearedInfo.setOperationType("payment");
			infoListPayment.add(clearedInfo);//only adding receipt objec
		}
		//sorting data using sale owner id
		sortClearedList(infoListPayment);
		 flatSaleOwner = 0l;
		for (FinTransactionClearedInfo finTransactionClearedInfo : infoListPayment) {
			finTransactionClearedInfo.setAmount(currencyUtil.convertUstoInFormat(BigDecimal.valueOf( Double.valueOf(finTransactionClearedInfo.getAmount())).setScale(roundingModeSize, roundingMode).toString()));
			String amount=finTransactionClearedInfo.getAmount().replaceAll("\u00A0", "");
			finTransactionClearedInfo.setAmount(amount.trim());
			if(flatSaleOwner.equals(finTransactionClearedInfo.getFlatSaleOwnerId())) {
				finTransactionClearedInfo.setFlatSaleOwner("");//if previous and current sale owner matching, then making current sale owner empty
			}
			flatSaleOwner = finTransactionClearedInfo.getFlatSaleOwnerId();
			
		}
		System.out.println(infoListPayment);
		finList.put("paymentList",infoListPayment);
		return finList;
	}

	private void sortClearedList(List<FinTransactionClearedInfo> infoList) {
	
		Collections.sort(infoList, new Comparator<FinTransactionClearedInfo>() {
			@Override
			public int compare(FinTransactionClearedInfo o1, FinTransactionClearedInfo o2) {

				if (o1 == null || o2 == null) {
					return 0;
				}

				if (o1.getFlatSaleOwner() == null) {
					return 0;
				}

				if (o2.getFlatSaleOwner() == null) {
					return 1;
				}
				
				//return 1 means it will shift object to right else left side 
			
				 if (o1.getFlatSaleOwnerId() > o2.getFlatSaleOwnerId()) {
					   return 1;
				  } else if (o1.getFlatSaleOwnerId() < o2.getFlatSaleOwnerId()) {
					   return -1;
				  }
				
				 return 0;
			}	
		});
	}
	@Override
	public Map<String,List<FinTransactionClearedInfo>> getPendingTransactionReport(EmployeeFinancialTransactionRequest empTransReq) {
		
		Map<String,List<FinTransactionClearedInfo>> finList = new HashMap<>();
		List<FinTransactionClearedInfo> infoListRecipet = new ArrayList<FinTransactionClearedInfo>();
		List<FinTransactionClearedInfo> infoListPayment = new ArrayList<FinTransactionClearedInfo>();
		//recipet
		empTransReq.setOperationType("reciept");
		List<Map<String, Object>> clearedTansactionListRecipet = employeeFinancialServiceDao.getPendingTransactionReport(empTransReq);
		System.out.println(clearedTansactionListRecipet.size());
		for (Map<String, Object> clearedData : clearedTansactionListRecipet) {
			System.out.println(clearedData);
			FinTransactionClearedInfo clearedInfo = new FinTransactionClearedInfo();
			clearedInfo.setSiteName(clearedData.get("SALES_FORCE_SITE_NAME").toString());
			clearedInfo.setSiteId(Long.valueOf(clearedData.get("SITE_ID").toString()));
			clearedInfo.setTransactionTypeId(Long.valueOf(clearedData.get("FIN_TRANSACTION_TYPE_ID").toString()));
			clearedInfo.setAmount(clearedData.get("TRANSACTION_AMOUNT").toString());
			clearedInfo.setFlatSaleOwner(clearedData.get("FLAT_SALE_OWNER").toString().replace("LANDLORD_",""));
			clearedInfo.setFlatSaleOwnerId(Long.valueOf(clearedData.get("FLATS_SALE_OWNERS_ID").toString()));
			clearedInfo.setReceivedFromDate(empTransReq.getReceivedFromDate());
			clearedInfo.setReceivedToDate(empTransReq.getReceivedToDate());
			clearedInfo.setOperationType("reciept");
		//	if(!infoList.contains(clearedInfo) && clearedInfo.getTransactionTypeId().equals(FinTransactionType.RECEIPT.getId())) {
			infoListRecipet.add(clearedInfo);//only adding receipt object
//			} else {
//				for (FinTransactionClearedInfo finTransactionClearedInfo : infoList) {
//					if(finTransactionClearedInfo.getFlatSaleOwner().equals(clearedInfo.getFlatSaleOwner()) && clearedInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId())
//							&& finTransactionClearedInfo.getSiteId().equals(clearedInfo.getSiteId())
//							) {
//						//if(clearedInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId())) {
//							Double actualValue = Double.valueOf(finTransactionClearedInfo.getAmount());
//							Double currentValue = Double.valueOf(clearedInfo.getAmount());
//							//if found any refund entry object then doing minus in receipt object
//							finTransactionClearedInfo.setAmount(new BigDecimal(actualValue-currentValue).setScale(roundingModeSize, roundingMode).toString());
//						//}
//					}
//				}
//			}
		}
		//sorting data using sale owner id
		sortClearedList(infoListRecipet);
		//EmployeeFinancialHelper finHelper = new EmployeeFinancialHelper();
		Long flatSaleOwner = 0l;
		for (FinTransactionClearedInfo finTransactionClearedInfo : infoListRecipet) {
			finTransactionClearedInfo.setAmount(currencyUtil.convertUstoInFormat(BigDecimal.valueOf( Double.valueOf(finTransactionClearedInfo.getAmount())).setScale(roundingModeSize, roundingMode).toString()));
			String amount=finTransactionClearedInfo.getAmount().replaceAll("\u00A0", "");
			finTransactionClearedInfo.setAmount(amount.trim());
			if(flatSaleOwner.equals(finTransactionClearedInfo.getFlatSaleOwnerId())) {
				finTransactionClearedInfo.setFlatSaleOwner("");//if previous and current sale owner matching, then making current sale owner empty
			}
			flatSaleOwner = finTransactionClearedInfo.getFlatSaleOwnerId();
			
		}
		System.out.println(infoListRecipet);
		finList.put("recieptList",infoListRecipet);
		
		//payment
		empTransReq.setOperationType("payment");
		List<Map<String, Object>> clearedTansactionListPayment = employeeFinancialServiceDao.getPendingTransactionReport(empTransReq);
		System.out.println(clearedTansactionListPayment.size());
		for (Map<String, Object> clearedData : clearedTansactionListPayment) {
			System.out.println(clearedData);
			FinTransactionClearedInfo clearedInfo = new FinTransactionClearedInfo();
			clearedInfo.setSiteName(clearedData.get("SALES_FORCE_SITE_NAME").toString());
			clearedInfo.setSiteId(Long.valueOf(clearedData.get("SITE_ID").toString()));
			clearedInfo.setTransactionTypeId(Long.valueOf(clearedData.get("FIN_TRANSACTION_TYPE_ID").toString()));
			clearedInfo.setAmount(clearedData.get("TRANSACTION_AMOUNT").toString());
			clearedInfo.setFlatSaleOwner(clearedData.get("FLAT_SALE_OWNER").toString().replace("LANDLORD_",""));
			clearedInfo.setFlatSaleOwnerId(Long.valueOf(clearedData.get("FLATS_SALE_OWNERS_ID").toString()));
			clearedInfo.setReceivedFromDate(empTransReq.getReceivedFromDate());
			clearedInfo.setReceivedToDate(empTransReq.getReceivedToDate());
			clearedInfo.setOperationType("payment");
			infoListPayment.add(clearedInfo);//only adding receipt objec
		}
		//sorting data using sale owner id
		sortClearedList(infoListPayment);
		 flatSaleOwner = 0l;
		for (FinTransactionClearedInfo finTransactionClearedInfo : infoListPayment) {
			finTransactionClearedInfo.setAmount(currencyUtil.convertUstoInFormat(BigDecimal.valueOf( Double.valueOf(finTransactionClearedInfo.getAmount())).setScale(roundingModeSize, roundingMode).toString()));
			String amount=finTransactionClearedInfo.getAmount().replaceAll("\u00A0", "");
			finTransactionClearedInfo.setAmount(amount.trim());
			if(flatSaleOwner.equals(finTransactionClearedInfo.getFlatSaleOwnerId())) {
				finTransactionClearedInfo.setFlatSaleOwner("");//if previous and current sale owner matching, then making current sale owner empty
			}
			flatSaleOwner = finTransactionClearedInfo.getFlatSaleOwnerId();
			
		}
		System.out.println(infoListPayment);
		finList.put("paymentList",infoListPayment);
		return finList;
	}
	
	@Override
	public List<FinTransactionClearedInfo> getSuspnesEntryTransactionReport(EmployeeFinancialTransactionRequest empTransReq) {
		List<Map<String, Object>> clearedTansactionList = employeeFinancialServiceDao.getSuspnesEntryTransactionReport(empTransReq);
		System.out.println(clearedTansactionList.size());
		List<FinTransactionClearedInfo> infoList = new ArrayList<FinTransactionClearedInfo>();
		
		for (Map<String, Object> clearedData : clearedTansactionList) {
			System.out.println(clearedData);
			FinTransactionClearedInfo clearedInfo = new FinTransactionClearedInfo();
			clearedInfo.setSiteName(clearedData.get("SALES_FORCE_SITE_NAME").toString());
			clearedInfo.setSiteId(Long.valueOf(clearedData.get("SITE_ID").toString()));
		//	clearedInfo.setTransactionTypeId(Long.valueOf(clearedData.get("FIN_TRANSACTION_TYPE_ID").toString()));
			clearedInfo.setAmount(clearedData.get("TRANSACTION_AMOUNT").toString());
			clearedInfo.setFlatSaleOwner(clearedData.get("FLAT_SALE_OWNER").toString().replace("LANDLORD_",""));
			clearedInfo.setFlatSaleOwnerId(Long.valueOf(clearedData.get("FLATS_SALE_OWNERS_ID").toString()));
			clearedInfo.setReceivedFromDate(empTransReq.getReceivedFromDate());
			clearedInfo.setReceivedToDate(empTransReq.getReceivedToDate());
//			if(!infoList.contains(clearedInfo) && clearedInfo.getTransactionTypeId().equals(FinTransactionType.RECEIPT.getId())) {
				infoList.add(clearedInfo);//only adding receipt object
//			} else {
//				for (FinTransactionClearedInfo finTransactionClearedInfo : infoList) {
//					if(finTransactionClearedInfo.getFlatSaleOwner().equals(clearedInfo.getFlatSaleOwner()) && clearedInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId())) {
//						//if(clearedInfo.getTransactionTypeId().equals(FinTransactionType.PAYMENT.getId())) {
//							Double actualValue = Double.valueOf(finTransactionClearedInfo.getAmount());
//							Double currentValue = Double.valueOf(clearedInfo.getAmount());
//							//if found any refund entry object then doing minus in receipt object
//							finTransactionClearedInfo.setAmount(new BigDecimal(actualValue-currentValue).setScale(roundingModeSize, roundingMode).toString());
//						//}
//					}
//				}
//			}
		}
		//sorting data using sale owner id
		sortClearedList(infoList);
		//EmployeeFinancialHelper finHelper = new EmployeeFinancialHelper();
		Long flatSaleOwner = 0l;
		for (FinTransactionClearedInfo finTransactionClearedInfo : infoList) {
			finTransactionClearedInfo.setAmount(currencyUtil.convertUstoInFormat(BigDecimal.valueOf( Double.valueOf(finTransactionClearedInfo.getAmount())).setScale(roundingModeSize, roundingMode).toString()));
			String amount=finTransactionClearedInfo.getAmount().replaceAll("\u00A0", "");
			finTransactionClearedInfo.setAmount(amount.trim());
			if(flatSaleOwner.equals(finTransactionClearedInfo.getFlatSaleOwnerId())) {
				finTransactionClearedInfo.setFlatSaleOwner("");//if previous and current sale owner matching, then making current sale owner empty
			}
			flatSaleOwner = finTransactionClearedInfo.getFlatSaleOwnerId();
			
		}
		System.out.println(infoList);
		return infoList;
	}
	
	
	@Override
	public Map<String,List<FinClearedUncleareTXPojo>> getClearedUnclearedTxReport(EmployeeFinancialTransactionRequest empTransReq) {
		
		Map<String,List<FinClearedUncleareTXPojo>> finList = new HashMap<>();
		List<FinClearedUncleareTXPojo> clearedTx = new ArrayList<FinClearedUncleareTXPojo>();
		List<FinClearedUncleareTXPojo> unClearedTx = new ArrayList<FinClearedUncleareTXPojo>();

		if ("cleared".equalsIgnoreCase(empTransReq.getRequestUrl()) || "showAll".equalsIgnoreCase(empTransReq.getRequestUrl())  || Util.isEmptyObject(empTransReq.getRequestUrl())) {
			List<FinClearedUncleareTXPojo> clearedTansactionList = employeeFinancialServiceDao.getClearedTransactionReportByAccountNo(empTransReq);
			System.out.println(clearedTansactionList.size());
			for (FinClearedUncleareTXPojo clearedData : clearedTansactionList) {
				System.out.println(clearedData);
				FinClearedUncleareTXPojo clearedInfo = new FinClearedUncleareTXPojo();
				BeanUtils.copyProperties(clearedData, clearedInfo);
				clearedInfo.setAmount(currencyUtil.convertUstoInFormat(BigDecimal.valueOf( Double.valueOf(clearedData.getAmount())).setScale(roundingModeSize, roundingMode).toString()));
				String amount=clearedInfo.getAmount().replaceAll("\u00A0", "");
				clearedInfo.setAmount(amount.trim());
				clearedInfo.setChequeOrReferenceNo(clearedData.getChequeOrReferenceNo()==null?"-":clearedData.getChequeOrReferenceNo());
				if ("Transaction Cleared-Receipt Generated".equalsIgnoreCase(clearedData.getPendingModuleName())) {
					clearedInfo.setPendingByLevelWithModule(clearedData.getPendingModuleName());
				} else {
					clearedInfo.setPendingByLevelWithModule(clearedData.getPendingModuleName() + "/" +clearedData.getPendingByLevel() );
				}
				clearedTx.add(clearedInfo);
			}

			List<FinClearedUncleareTXPojo> AnonymousTXList = employeeFinancialServiceDao
					.getSuspnseEntriesTransactionReportByAccountNo(empTransReq);
			System.out.println(AnonymousTXList.size());
			for (FinClearedUncleareTXPojo clearedData : AnonymousTXList) {
				System.out.println(clearedData);
				FinClearedUncleareTXPojo clearedInfo = new FinClearedUncleareTXPojo();
				BeanUtils.copyProperties(clearedData, clearedInfo);
				clearedInfo.setAmount(currencyUtil.convertUstoInFormat(BigDecimal.valueOf( Double.valueOf(clearedData.getAmount())).setScale(roundingModeSize, roundingMode).toString()));
				String amount=clearedInfo.getAmount().replaceAll("\u00A0", "");
				clearedInfo.setAmount(amount.trim());
				clearedInfo.setChequeOrReferenceNo(clearedData.getChequeOrReferenceNo()==null?"-":clearedData.getChequeOrReferenceNo());
				if ("Modify Suspense Entry".equalsIgnoreCase(clearedData.getPendingModuleName())) {
					clearedInfo.setPendingByLevelWithModule(clearedData.getPendingModuleName()+"/MIS");
				} else {
					clearedInfo.setPendingByLevelWithModule(clearedData.getPendingModuleName() + "/" +clearedData.getPendingByLevel() );
				}
				clearedTx.add(clearedInfo);
			}

			Collections.sort(clearedTx, new Comparator<FinClearedUncleareTXPojo>() {
			    public int compare(FinClearedUncleareTXPojo m1, FinClearedUncleareTXPojo m2) {
			        return m1.getTxClearanceDate().compareTo(m2.getTxClearanceDate());
			    }
			});
			Collections.reverse(clearedTx);
		finList.put("clearedTXList",clearedTx);
		}

		if ("Uncleared".equalsIgnoreCase(empTransReq.getRequestUrl()) || "showAll".equalsIgnoreCase(empTransReq.getRequestUrl()) || Util.isEmptyObject(empTransReq.getRequestUrl())) {
		 List<FinClearedUncleareTXPojo> pendingTansactionList = employeeFinancialServiceDao.getPendingTransactionReportByAccountNo(empTransReq);
		 System.out.println(pendingTansactionList.size());
		 for (FinClearedUncleareTXPojo UnclearedData : pendingTansactionList) {
			 System.out.println(UnclearedData);
			 FinClearedUncleareTXPojo clearedInfo = new FinClearedUncleareTXPojo();
			 BeanUtils.copyProperties(UnclearedData, clearedInfo);
			 clearedInfo.setAmount(currencyUtil.convertUstoInFormat(BigDecimal.valueOf( Double.valueOf(UnclearedData.getAmount())).setScale(roundingModeSize, roundingMode).toString()));
			 String amount=clearedInfo.getAmount().replaceAll("\u00A0", "");
			 clearedInfo.setAmount(amount.trim());
			 clearedInfo.setChequeOrReferenceNo(UnclearedData.getChequeOrReferenceNo()==null?"-":UnclearedData.getChequeOrReferenceNo());
			 if ("Transaction Cleared-Receipt Generated".equalsIgnoreCase(UnclearedData.getPendingModuleName())) {
				clearedInfo.setPendingByLevelWithModule(UnclearedData.getPendingModuleName());
			 } else {
				clearedInfo.setPendingByLevelWithModule(UnclearedData.getPendingModuleName() + "/" +UnclearedData.getPendingByLevel() );
			 }
			 unClearedTx.add(clearedInfo);
		 }
	
		 finList.put("unclearedTXList",unClearedTx);
		}
		
		return finList;
	}
	
	@Override
	public List<FinProjectAccountPojo> getAccountNumbers(EmployeeFinancialTransactionRequest tansactionServiceInfo) {
		 List<FinProjectAccountPojo> list= employeeFinancialServiceDao.getAccountNumbers(tansactionServiceInfo);
		 return list;
	}
	
	
	 @Override
	   public EmployeeFinancialTransactionRequest dateWiseSearchFunctionalityUtil(EmployeeFinancialTransactionRequest request) {
		   /*  date filter   */
				if(Util.isNotEmptyObject(request.getClearanceFromDate()) && Util.isEmptyObject(request.getClearanceToDate())){
					  if(Util.isNotEmptyObject(request.getClearanceFromDate())) {
					      request.setClearanceFromDate(TimeUtil.removeTimePartFromTimeStamp(request.getClearanceFromDate()));
				      }if(Util.isEmptyObject(request.getClearanceToDate())) {
					    // request.setEndDate(TimeUtil.endOfTheDayTimestamp(request.getStartDate()));
				    	  request.setClearanceToDate(TimeUtil.endOfTheDayTimestamp(new Timestamp(System.currentTimeMillis())));
			          }
				 }
				 else if(Util.isEmptyObject(request.getClearanceFromDate()) && Util.isNotEmptyObject(request.getEndDate())){
					  if(Util.isEmptyObject(request.getClearanceFromDate())) {
					      GregorianCalendar mortgage = new GregorianCalendar(1971, Calendar.JANUARY, 1);
					      request.setClearanceFromDate(new Timestamp(mortgage.getTimeInMillis()));
				      }if(Util.isNotEmptyObject(request.getClearanceToDate())) {
					     request.setClearanceToDate(TimeUtil.endOfTheDayTimestamp(request.getClearanceToDate()));
			          }
				 }
				else if(Util.isEmptyObject(request.getClearanceFromDate()) && Util.isEmptyObject(request.getClearanceToDate())){ 
					 if(Util.isEmptyObject(request.getClearanceFromDate())) {
						 GregorianCalendar mortgage = new GregorianCalendar(1971, Calendar.JANUARY, 1);
					      request.setClearanceFromDate(new Timestamp(mortgage.getTimeInMillis()));
				     }
					 if(Util.isEmptyObject(request.getClearanceToDate())) {
						 request.setClearanceToDate(TimeUtil.endOfTheDayTimestamp(new Timestamp(System.currentTimeMillis())));
					 }
				 }
				else if(Util.isNotEmptyObject(request.getClearanceFromDate()) && Util.isNotEmptyObject(request.getClearanceToDate())){
					 if(Util.isNotEmptyObject(request.getClearanceFromDate())) {
					      request.setClearanceFromDate(TimeUtil.removeTimePartFromTimeStamp(request.getClearanceFromDate()));
				     }if(Util.isNotEmptyObject(request.getClearanceToDate())) {
					     request.setClearanceToDate(TimeUtil.endOfTheDayTimestamp(request.getClearanceToDate()));
			         } 
				 }
		   return request; 
	   }
	 
	 
	    @Override
		public List<StatusPojo> getBookingStatuses(EmployeeFinancialTransactionRequest tansactionServiceInfo) {
			 List<StatusPojo> list= employeeFinancialServiceDao.getBookingStatuses(tansactionServiceInfo);
			 return list;
		}
	 
	    @Override
		public List<StatePojo> getStates(EmployeeFinancialTransactionRequest tansactionServiceInfo) {
			 List<StatePojo> list= employeeFinancialServiceDao.getStates(tansactionServiceInfo);
			 return list;
		}
	    
	    
	public void shiftPendingTransactionsOldBookingToNewBooking(FlatBookingPojo newFlatBookingPojo,FlatBookingPojo oldFlatBookingPojo) {
		/*getting all the pending transaction of Old Booking*/
		List<FinancialDemandNoteMS_TRN_Pojo> list = employeeFinancialServiceDao.loadPendingOldBookingTransaction(oldFlatBookingPojo);
		for (FinancialDemandNoteMS_TRN_Pojo finTansaction : list) {
			/*UPDATING  FIN_TRANSACTION_ENTRY TABLE BOOKING_ID COULUMN OLD TO NEW BOOKING*/
			int response = employeeFinancialServiceDao.updateFinTransactionBookingId(oldFlatBookingPojo,newFlatBookingPojo, finTansaction);
			if (response == 1) {
				log.info("Succsessfully shifted old booking new to new booking . new Booking data: "+ newFlatBookingPojo + " old booking data :" + oldFlatBookingPojo);
			} else {
				log.info("Failed to shift old booking new to new booking . new Booking data: " + newFlatBookingPojo+ " old booking data :" + oldFlatBookingPojo);
			}
		}
	}
	 
	
	 @Override
	public void updateOldBookingPendingTransactionToNewBooking(BookingFormRequest bookingRequest) throws Exception {
		FlatBookingPojo oldFlatBookingPojo = new FlatBookingPojo();
		
		//oldFlatBookingPojo.setSalesforceOldBookingId("A505-106");
		oldFlatBookingPojo.setFlatNo(bookingRequest.getOldBookingRequest().getFlatNo());
		oldFlatBookingPojo.setFlatBookingId(bookingRequest.getOldBookingRequest().getFlatBookingId());
		oldFlatBookingPojo.setStatusId(bookingRequest.getOldBookingRequest().getStatusId());
		oldFlatBookingPojo.setSiteId(bookingRequest.getOldBookingRequest().getSiteId());
		
		FlatBookingPojo newFlatBookingPojo = new FlatBookingPojo();
		//newFlatBookingPojo.setSalesforceOldBookingId("");
		newFlatBookingPojo.setFlatBookingId(bookingRequest.getNewBookingRequest().getFlatBookingId());
		newFlatBookingPojo.setFlatId(bookingRequest.getNewBookingRequest().getFlatId());
		newFlatBookingPojo.setSiteId(bookingRequest.getNewBookingRequest().getSiteId());
		
		/*here we are shifting Transaction to Old Booking To new Booking */
		try {
			/*here we are updating FIN_TRANSACTION_ENTRY BOOKING_ID COLUMN .*/
			shiftPendingTransactionsOldBookingToNewBooking(newFlatBookingPojo, oldFlatBookingPojo);
		} catch (Exception e) {
			log.info(e.getMessage(),e);
		}
	}

	@Override
	public int checkDuplicateTransactionOrNot(EmployeeFinancialTransactionRequest tansactionServiceInfo) {
		int count = employeeFinancialServiceDao.checkDuplicateTransactionOrNot(tansactionServiceInfo);
		return count;
	}
	
}
